# 数据保护与升级指南

## 🛡️ 数据安全保证

### 数据存储位置

系统采用**双重存储机制**，确保数据安全：

1. **后端数据存储**（主要）
   - 位置：`/data` 目录下的JSON文件
   - 文件：`user_data.json`, `users.json`, `training.json` 等
   - **重要**：这些文件**不会**被Git提交（已在`.gitignore`中排除）

2. **云端数据存储**（备份）
   - 使用Supabase作为云存储
   - 自动同步本地数据到云端
   - 每次数据更新都会自动同步

### 数据存储机制

```
用户操作 → 前端HTML → 后端API → 数据存储服务
                                    ↓
                            ┌───────┴───────┐
                            ↓               ↓
                    本地JSON文件      云端Supabase
                    (data/*.json)     (自动同步)
```

## ✅ 升级网站时数据不会丢失的原因

### 1. 数据与前端文件分离

- ✅ **前端HTML文件**：只包含界面代码，不包含数据
- ✅ **数据文件**：存储在独立的`/data`目录，不会被Git提交
- ✅ **后端服务**：负责数据读写，与前端文件独立

### 2. 数据存储位置

```
智鸽系统_副本/
├── index.html          ← 前端文件（可以安全升级）
├── admin.html          ← 前端文件（可以安全升级）
├── backend/            ← 后端代码（可以安全升级）
│   └── services/
│       └── storageService.js  ← 数据服务（保持不变）
└── data/              ← 数据文件（不会被Git提交）
    ├── user_data.json ← 用户数据（不会丢失）
    ├── users.json     ← 用户账户（不会丢失）
    ├── training.json  ← 训练记录（不会丢失）
    └── ...            ← 其他数据（不会丢失）
```

### 3. Git配置保护

`.gitignore`文件已配置排除数据目录：

```gitignore
# 数据文件
data/
*.json
!package.json
!package-lock.json
```

**这意味着**：
- ✅ 数据文件不会被提交到Git仓库
- ✅ 升级HTML文件时，数据文件不会被覆盖
- ✅ 数据始终保留在服务器上

## 🚀 升级网站的标准流程

### 步骤1：备份数据（可选，系统已自动备份）

系统每天凌晨3点自动备份数据，但升级前建议手动备份：

```bash
# 在Vercel部署前，可以通过API备份
curl -X POST https://你的域名/api/admin/backup \
  -H "Authorization: Bearer 你的管理员token"
```

### 步骤2：修改本地HTML文件

在本地修改`index.html`或其他前端文件，**不要修改**：
- ❌ `data/` 目录下的任何文件
- ❌ `backend/services/storageService.js`（数据服务）
- ❌ `backend/routes/api.js`（数据API）

### 步骤3：提交到Git仓库

```bash
git add index.html  # 只提交修改的前端文件
git commit -m "升级网站界面"
git push origin main
```

### 步骤4：Vercel自动部署

Vercel会自动：
1. 从GitHub拉取新代码
2. 部署新的前端文件
3. **数据文件保持不变**（因为不在Git仓库中）

### 步骤5：验证数据

部署完成后，访问网站验证：
- ✅ 用户数据是否还在
- ✅ 鸽子信息是否还在
- ✅ 训练记录是否还在

## 🔄 Vercel部署时的数据恢复机制

### 问题：Vercel的文件系统是临时的

在Vercel上，每次部署都会重置文件系统，`/data`目录会被清空。

### 解决方案：自动从云端恢复数据

系统已实现自动数据恢复机制：

1. **启动时自动恢复**
   ```javascript
   // backend/server.js 启动时会：
   // 1. 检查本地数据是否存在
   // 2. 如果不存在，从Supabase云端恢复
   // 3. 如果云端也没有，创建空数据
   ```

2. **数据同步机制**
   - 每次数据更新都会自动同步到Supabase
   - 部署后自动从Supabase恢复数据
   - 确保数据不丢失

### 配置Supabase（重要！）

在Vercel环境变量中添加：

```
SUPABASE_URL=https://你的项目.supabase.co
SUPABASE_ANON_KEY=你的anon_key
```

**如果没有配置Supabase**：
- 数据会存储在Vercel的临时文件系统中
- 每次部署可能会丢失数据
- **强烈建议配置Supabase**

## 📋 升级检查清单

升级网站前，请确认：

- [ ] **数据已备份**（系统自动备份，或手动备份）
- [ ] **Supabase已配置**（在Vercel环境变量中）
- [ ] **只修改前端文件**（index.html, admin.html等）
- [ ] **不修改数据文件**（data/目录下的文件）
- [ ] **不修改数据服务**（storageService.js等）
- [ ] **测试本地修改**（确保功能正常）
- [ ] **提交到Git**（只提交修改的文件）
- [ ] **等待Vercel部署完成**
- [ ] **验证数据完整性**（登录检查数据是否还在）

## 🔍 数据恢复验证

部署后，检查以下内容：

### 1. 检查用户数据

```bash
# 通过API检查
curl https://你的域名/api/user/data/pigeons \
  -H "Authorization: Bearer 你的token"
```

### 2. 检查数据统计

```bash
# 检查数据统计
curl https://你的域名/api/stats
```

### 3. 登录验证

- 使用现有账户登录
- 检查鸽子列表
- 检查训练记录
- 检查历史数据

## ⚠️ 重要注意事项

### 1. 不要提交数据文件

**永远不要**将以下文件提交到Git：
- ❌ `data/*.json`
- ❌ `backend/.env`
- ❌ `*.log`

### 2. 不要修改数据服务

**不要修改**以下文件（除非明确知道在做什么）：
- ❌ `backend/services/storageService.js`
- ❌ `backend/services/cloudStorageService.js`
- ❌ `backend/routes/api.js`（数据相关API）

### 3. 确保Supabase配置

**必须配置**Supabase才能保证数据持久化：
- ✅ 在Vercel环境变量中添加`SUPABASE_URL`
- ✅ 在Vercel环境变量中添加`SUPABASE_ANON_KEY`

### 4. 测试升级

**升级前先测试**：
- 在本地测试修改后的HTML
- 确保功能正常
- 确保数据读取正常

## 🛠️ 数据迁移工具

如果需要手动迁移数据，可以使用以下API：

### 导出数据

```bash
# 导出所有用户数据
curl https://你的域名/api/admin/users/data \
  -H "Authorization: Bearer 管理员token"
```

### 导入数据

```bash
# 导入用户数据
curl -X POST https://你的域名/api/user/data/pigeons \
  -H "Authorization: Bearer 你的token" \
  -H "Content-Type: application/json" \
  -d '{"pigeons": [...]}'
```

## 📊 数据存储位置总结

| 数据类型 | 存储位置 | 是否会被Git提交 | 升级时是否丢失 |
|---------|---------|---------------|--------------|
| 用户账户 | `data/users.json` | ❌ 否 | ✅ 不会 |
| 用户数据 | `data/user_data.json` | ❌ 否 | ✅ 不会 |
| 训练记录 | `data/training.json` | ❌ 否 | ✅ 不会 |
| 比赛记录 | `data/races.json` | ❌ 否 | ✅ 不会 |
| 后台日志 | `data/admin_logs.json` | ❌ 否 | ✅ 不会 |
| 前端代码 | `index.html` | ✅ 是 | ✅ 可以升级 |
| 后端代码 | `backend/` | ✅ 是 | ✅ 可以升级 |

## 🎯 总结

### 数据安全保证

1. ✅ **数据与代码分离**：数据存储在独立目录，不会被Git提交
2. ✅ **自动云端备份**：数据自动同步到Supabase
3. ✅ **自动恢复机制**：部署后自动从云端恢复数据
4. ✅ **升级不影响数据**：升级HTML文件不会影响数据文件

### 升级流程

1. 修改本地HTML文件
2. 提交到Git（只提交修改的文件）
3. Vercel自动部署
4. 系统自动恢复数据
5. 验证数据完整性

### 关键点

- ✅ **数据文件不会被Git提交**（已在`.gitignore`中排除）
- ✅ **升级HTML文件不会影响数据**（数据存储在独立目录）
- ✅ **配置Supabase确保数据持久化**（Vercel文件系统是临时的）
- ✅ **系统自动备份和恢复**（每天自动备份，部署时自动恢复）

---

**结论**：您可以安全地升级HTML文件，数据不会丢失！系统已实现完整的数据保护机制。

































