/**
 * è‡ªåŠ¨è´¦å·æ³¨å†Œå’Œæ•°æ®ç®¡ç†è„šæœ¬
 * åŠŸèƒ½ï¼š
 * 1. è‡ªåŠ¨è¯†åˆ«è®¾å¤‡ä¿¡æ¯å¹¶ç”Ÿæˆè´¦å·
 * 2. è‡ªåŠ¨ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å’Œäº‘ç«¯
 * 3. é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è°ƒå–æœ¬åœ°å’Œäº‘ç«¯æ•°æ®
 * 4. ç½‘ç«™æ›´æ–°åè‡ªåŠ¨æ¢å¤æ•°æ®
 */

(function() {
  'use strict';
  
  console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] å¼€å§‹åˆå§‹åŒ–è‡ªåŠ¨è´¦å·æ³¨å†Œç³»ç»Ÿ...');
  
  // ==================== 1. è®¾å¤‡ä¿¡æ¯è¯†åˆ« ====================
  
  const DEVICE_ID_KEY = 'pigeon_device_id';
  const DEVICE_INFO_KEY = 'pigeon_device_info';
  const AUTO_ACCOUNT_KEY = 'pigeon_auto_account';
  
  /**
   * è·å–æˆ–åˆ›å»ºè®¾å¤‡ID
   */
  function getOrCreateDeviceId() {
    try {
      let deviceId = localStorage.getItem(DEVICE_ID_KEY);
      if (!deviceId) {
        // ç”Ÿæˆå”¯ä¸€è®¾å¤‡ID
        if (window.crypto && window.crypto.randomUUID) {
          deviceId = window.crypto.randomUUID();
        } else {
          deviceId = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        localStorage.setItem(DEVICE_ID_KEY, deviceId);
        console.log('âœ… [è‡ªåŠ¨è´¦å·] å·²åˆ›å»ºæ–°è®¾å¤‡ID:', deviceId);
      }
      return deviceId;
    } catch (e) {
      console.warn('âš ï¸ [è‡ªåŠ¨è´¦å·] ç”Ÿæˆè®¾å¤‡IDå¤±è´¥:', e);
      return null;
    }
  }
  
  /**
   * è·å–è®¾å¤‡ä¿¡æ¯
   */
  function getDeviceInfo() {
    try {
      let deviceInfo = localStorage.getItem(DEVICE_INFO_KEY);
      if (deviceInfo) {
        return JSON.parse(deviceInfo);
      }
      
      // æ”¶é›†è®¾å¤‡ä¿¡æ¯
      deviceInfo = {
        userAgent: navigator.userAgent || '',
        platform: navigator.platform || '',
        language: navigator.language || '',
        screenWidth: window.screen.width || 0,
        screenHeight: window.screen.height || 0,
        deviceType: /Mobile|Android|iPhone|iPad/i.test(navigator.userAgent) ? 'mobile' : 'desktop',
        timestamp: new Date().toISOString()
      };
      
      localStorage.setItem(DEVICE_INFO_KEY, JSON.stringify(deviceInfo));
      return deviceInfo;
    } catch (e) {
      console.warn('âš ï¸ [è‡ªåŠ¨è´¦å·] è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥:', e);
      return {
        userAgent: navigator.userAgent || '',
        platform: navigator.platform || '',
        deviceType: 'unknown'
      };
    }
  }
  
  // ==================== 2. è‡ªåŠ¨è´¦å·æ³¨å†Œ ====================
  
  /**
   * è‡ªåŠ¨æ³¨å†Œè´¦å·ï¼ˆåŸºäºè®¾å¤‡IDï¼‰
   */
  async function autoRegisterAccount() {
    try {
      // æ£€æŸ¥æ˜¯å¦å·²æœ‰è´¦å·
      const existingAccount = localStorage.getItem(AUTO_ACCOUNT_KEY);
      if (existingAccount) {
        const account = JSON.parse(existingAccount);
        console.log('âœ… [è‡ªåŠ¨è´¦å·] ä½¿ç”¨å·²æœ‰è´¦å·:', account.username);
        return account;
      }
      
      const deviceId = getOrCreateDeviceId();
      if (!deviceId) {
        console.warn('âš ï¸ [è‡ªåŠ¨è´¦å·] æ— æ³•ç”Ÿæˆè®¾å¤‡IDï¼Œè·³è¿‡è‡ªåŠ¨æ³¨å†Œ');
        return null;
      }
      
      const deviceInfo = getDeviceInfo();
      const apiUrl = getBackendApiUrl();
      
      // ç”Ÿæˆç”¨æˆ·åï¼ˆåŸºäºè®¾å¤‡IDï¼‰
      const username = 'user_' + deviceId.substring(0, 8);
      const email = username + '@auto.local';
      const password = deviceId; // ä½¿ç”¨è®¾å¤‡IDä½œä¸ºå¯†ç 
      
      console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] æ­£åœ¨è‡ªåŠ¨æ³¨å†Œè´¦å·...');
      console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] API URL:', apiUrl);
      console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] è®¾å¤‡ä¿¡æ¯:', {
        deviceId: deviceId.substring(0, 8) + '...',
        deviceType: deviceInfo.deviceType,
        platform: deviceInfo.platform
      });
      
      // ç¡®ä¿API URLæ ¼å¼æ­£ç¡®ï¼ˆå¦‚æœå·²ç»åŒ…å«/apiï¼Œä¸å†é‡å¤æ·»åŠ ï¼‰
      let registerUrl = apiUrl.trim();
      // å»æ‰å°¾éƒ¨æ–œæ ï¼Œç»Ÿä¸€å¤„ç†
      if (registerUrl.endsWith('/')) {
        registerUrl = registerUrl.slice(0, -1);
      }
      // å¦‚æœURLå·²ç»åŒ…å«ç›®æ ‡è·¯å¾„ï¼Œç›´æ¥ä½¿ç”¨
      if (registerUrl.endsWith('/api/auth/register')) {
        // å·²ç»æ˜¯å®Œæ•´è·¯å¾„
      } else if (registerUrl.endsWith('/api')) {
        // å¦‚æœä»¥/apiç»“å°¾ï¼Œç›´æ¥æ‹¼æ¥
        registerUrl = registerUrl + '/auth/register';
      } else {
        // å¦åˆ™æ·»åŠ /apiå‰ç¼€
        registerUrl = registerUrl + '/api/auth/register';
      }
      
      console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] æ³¨å†ŒURL:', registerUrl);
      
      // å°è¯•æ³¨å†Œ
      const registerResponse = await fetch(registerUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          username: username,
          email: email,
          password: password
        })
      });
      
      let account = null;
      
      if (registerResponse.ok) {
        const result = await registerResponse.json();
        if (result.success) {
          account = {
            username: username,
            email: email,
            deviceId: deviceId,
            deviceInfo: deviceInfo,
            createdAt: new Date().toISOString(),
            autoGenerated: true
          };
          localStorage.setItem(AUTO_ACCOUNT_KEY, JSON.stringify(account));
          console.log('âœ… [è‡ªåŠ¨è´¦å·] è´¦å·æ³¨å†ŒæˆåŠŸ:', username);
        }
      } else {
        // å¦‚æœæ³¨å†Œå¤±è´¥ï¼ˆå¯èƒ½ç”¨æˆ·åå·²å­˜åœ¨ï¼‰ï¼Œå°è¯•ç™»å½•
        const errorText = await registerResponse.text();
        console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] æ³¨å†Œå¤±è´¥ï¼ŒçŠ¶æ€ç :', registerResponse.status);
        console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] æ³¨å†Œå¤±è´¥ï¼Œå“åº”:', errorText);
        console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] å°è¯•ç™»å½•...');
        
        // ç¡®ä¿ç™»å½•URLæ ¼å¼æ­£ç¡®
        let loginUrl = apiUrl.trim();
        // å»æ‰å°¾éƒ¨æ–œæ ï¼Œç»Ÿä¸€å¤„ç†
        if (loginUrl.endsWith('/')) {
          loginUrl = loginUrl.slice(0, -1);
        }
        // å¦‚æœURLå·²ç»åŒ…å«ç›®æ ‡è·¯å¾„ï¼Œç›´æ¥ä½¿ç”¨
        if (loginUrl.endsWith('/api/auth/login')) {
          // å·²ç»æ˜¯å®Œæ•´è·¯å¾„
        } else if (loginUrl.endsWith('/api')) {
          // å¦‚æœä»¥/apiç»“å°¾ï¼Œç›´æ¥æ‹¼æ¥
          loginUrl = loginUrl + '/auth/login';
        } else {
          // å¦åˆ™æ·»åŠ /apiå‰ç¼€
          loginUrl = loginUrl + '/api/auth/login';
        }
        
        console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] ç™»å½•URL:', loginUrl);
        const loginResponse = await fetch(loginUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: username,
            password: password
          })
        });
        
        if (loginResponse.ok) {
          const result = await loginResponse.json();
          if (result.success && result.token) {
            account = {
              username: username,
              email: email,
              deviceId: deviceId,
              deviceInfo: deviceInfo,
              createdAt: new Date().toISOString(),
              autoGenerated: true
            };
            localStorage.setItem(AUTO_ACCOUNT_KEY, JSON.stringify(account));
            // ä¿å­˜tokenï¼ˆåŒæ—¶ä¿å­˜åˆ°ä¸¤ä¸ªé”®ï¼Œå…¼å®¹ä¸åŒé¡µé¢ï¼‰
            const token = result.token;
            localStorage.setItem('auth_token', token);
            localStorage.setItem('token', token);
            if (typeof setAuthToken === 'function') {
              setAuthToken(token);
            }
            
            // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
            if (result.data && result.data.user) {
              localStorage.setItem('userInfo', JSON.stringify(result.data.user));
            } else {
              localStorage.setItem('userInfo', JSON.stringify({
                username: username,
                email: email,
                name: username
              }));
            }
            
            console.log('âœ… [è‡ªåŠ¨è´¦å·] ç™»å½•æˆåŠŸ:', username);
            
            // æ›´æ–°ç§»åŠ¨ç«¯ç”¨æˆ·æŒ‰é’®æ˜¾ç¤º
            if (typeof window.updateMobileUserButton === 'function') {
              setTimeout(() => {
                window.updateMobileUserButton();
              }, 100);
            }
          }
        }
      }
      
      if (!account) {
        console.warn('âš ï¸ [è‡ªåŠ¨è´¦å·] æœªèƒ½åˆ›å»ºæˆ–ç™»å½•è´¦æˆ·ï¼Œå¯èƒ½çš„åŸå› ï¼š');
        console.warn('  1. ç½‘ç»œè¿æ¥é—®é¢˜');
        console.warn('  2. åç«¯æœåŠ¡æœªå¯åŠ¨');
        console.warn('  3. APIåœ°å€é…ç½®é”™è¯¯');
        console.warn('  4. æ³¨å†Œæ¥å£è¿”å›é”™è¯¯');
      }
      
      return account;
    } catch (error) {
      console.error('âŒ [è‡ªåŠ¨è´¦å·] è‡ªåŠ¨æ³¨å†Œå¤±è´¥:', error);
      console.error('âŒ [è‡ªåŠ¨è´¦å·] é”™è¯¯è¯¦æƒ…:', {
        message: error.message,
        stack: error.stack,
        apiUrl: apiUrl
      });
      return null;
    }
  }
  
  /**
   * è·å–åç«¯API URL
   */
  function getBackendApiUrl() {
    // å°è¯•ä»å…¨å±€å˜é‡è·å–
    if (typeof window !== 'undefined' && window.BACKEND_API_URL) {
      return window.BACKEND_API_URL;
    }
    
    // å°è¯•ä»é¡µé¢çš„getBackendApiUrlå‡½æ•°è·å–ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (typeof window !== 'undefined' && typeof window.getBackendApiUrl === 'function') {
      try {
        const apiUrl = window.getBackendApiUrl();
        if (apiUrl) {
          console.log('âœ… [è‡ªåŠ¨è´¦å·] ä»é¡µé¢å‡½æ•°è·å–API URL:', apiUrl);
          return apiUrl;
        }
      } catch (e) {
        console.warn('âš ï¸ [è‡ªåŠ¨è´¦å·] è°ƒç”¨é¡µé¢getBackendApiUrlå¤±è´¥:', e);
      }
    }
    
    // ä»å½“å‰é¡µé¢URLæ¨æ–­
    const hostname = window.location.hostname;
    if (hostname.includes('localhost') || hostname.includes('127.0.0.1')) {
      return 'http://localhost:3000';
    }
    
    // ä½¿ç”¨å½“å‰åŸŸåï¼ˆè‡ªåŠ¨æ·»åŠ /apiè·¯å¾„ï¼‰
    const origin = window.location.origin;
    const apiUrl = origin + '/api';
    console.log('âœ… [è‡ªåŠ¨è´¦å·] ä½¿ç”¨å½“å‰åŸŸåä½œä¸ºAPI URL:', apiUrl);
    return apiUrl;
  }
  
  // ==================== 3. æ•°æ®è‡ªåŠ¨ä¿å­˜å’Œè°ƒå– ====================
  
  /**
   * è‡ªåŠ¨ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å’Œäº‘ç«¯
   * @returns {Promise<{local: boolean, cloud: boolean}>} è¿”å›ä¿å­˜ç»“æœ
   */
  async function autoSaveData(dataType, data) {
    const result = { local: false, cloud: false };
    
    try {
      // 1. ä¿å­˜åˆ°æœ¬åœ°ï¼ˆä½¿ç”¨ä¸é¡µé¢ä¸€è‡´çš„å­˜å‚¨é”®åï¼‰
      let storageKey;
      if (dataType === 'pigeons') {
        storageKey = 'pigeon_manager_data_v1'; // ä¸PCç«¯å’Œç§»åŠ¨ç«¯ä¿æŒä¸€è‡´
      } else if (dataType === 'races') {
        storageKey = 'pigeon_races_v1'; // ä¸PCç«¯å’Œç§»åŠ¨ç«¯ä¿æŒä¸€è‡´
      } else {
        storageKey = `pigeon_${dataType}_v1`;
      }
      
      try {
        localStorage.setItem(storageKey, JSON.stringify(data));
        result.local = true;
        console.log(`âœ… [è‡ªåŠ¨ä¿å­˜] ${dataType}å·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œé”®å: ${storageKey}ï¼Œæ•°é‡: ${Array.isArray(data) ? data.length : 'N/A'}`);
      } catch (e) {
        console.error(`âŒ [è‡ªåŠ¨ä¿å­˜] ${dataType}æœ¬åœ°ä¿å­˜å¤±è´¥:`, e);
      }
      
      // 2. ä¿å­˜åˆ°äº‘ç«¯
      const account = JSON.parse(localStorage.getItem(AUTO_ACCOUNT_KEY) || 'null');
      if (!account) {
        // å¦‚æœæ²¡æœ‰è´¦å·ï¼Œå…ˆè‡ªåŠ¨æ³¨å†Œ
        await autoRegisterAccount();
      }
      
      const token = localStorage.getItem('auth_token') || localStorage.getItem('token');
      if (token) {
        const apiUrl = getBackendApiUrl();
        
        // ç¡®ä¿API URLæ ¼å¼æ­£ç¡®
        let saveUrl = apiUrl.trim();
        if (saveUrl.endsWith('/')) {
          saveUrl = saveUrl.slice(0, -1);
        }
        if (!saveUrl.endsWith('/api/user/data/' + dataType)) {
          if (saveUrl.endsWith('/api')) {
            saveUrl = saveUrl + '/user/data/' + dataType;
          } else {
            saveUrl = saveUrl + '/api/user/data/' + dataType;
          }
        }
        
        try {
          const response = await fetch(saveUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
              [dataType]: data
            })
          });
          
          if (response.ok) {
            const responseData = await response.json();
            if (responseData.success) {
              result.cloud = true;
              console.log(`âœ… [è‡ªåŠ¨ä¿å­˜] ${dataType}å·²ä¿å­˜åˆ°äº‘ç«¯ï¼Œæ•°é‡: ${Array.isArray(data) ? data.length : 'N/A'}`);
            } else {
              console.warn(`âš ï¸ [è‡ªåŠ¨ä¿å­˜] ${dataType}äº‘ç«¯ä¿å­˜å¤±è´¥:`, responseData.error || 'æœªçŸ¥é”™è¯¯');
            }
          } else {
            console.warn(`âš ï¸ [è‡ªåŠ¨ä¿å­˜] ${dataType}äº‘ç«¯ä¿å­˜å¤±è´¥ï¼ŒçŠ¶æ€ç :`, response.status);
          }
        } catch (error) {
          console.warn(`âš ï¸ [è‡ªåŠ¨ä¿å­˜] ${dataType}äº‘ç«¯ä¿å­˜å¼‚å¸¸:`, error.message);
        }
      } else {
        console.warn(`âš ï¸ [è‡ªåŠ¨ä¿å­˜] ${dataType}æœªæ‰¾åˆ°tokenï¼Œè·³è¿‡äº‘ç«¯ä¿å­˜`);
      }
    } catch (error) {
      console.error(`âŒ [è‡ªåŠ¨ä¿å­˜] ${dataType}ä¿å­˜å¤±è´¥:`, error);
    }
    
    return result;
  }
  
  /**
   * æ£€æµ‹æ•°æ®ä¸Šä¼ çŠ¶æ€
   * @returns {Promise<{local: boolean, cloud: boolean, deviceId: string, account: object|null}>}
   */
  async function checkDataUploadStatus() {
    const status = {
      local: false,
      cloud: false,
      deviceId: null,
      account: null,
      token: null
    };
    
    try {
      // æ£€æµ‹è®¾å¤‡ID
      status.deviceId = getOrCreateDeviceId();
      
      // æ£€æµ‹è´¦å·
      const accountStr = localStorage.getItem(AUTO_ACCOUNT_KEY);
      if (accountStr) {
        status.account = JSON.parse(accountStr);
      }
      
      // æ£€æµ‹token
      status.token = localStorage.getItem('auth_token') || localStorage.getItem('token');
      
      // æ£€æµ‹æœ¬åœ°æ•°æ®
      const localPigeons = localStorage.getItem('pigeon_manager_data_v1');
      const localRaces = localStorage.getItem('pigeon_races_v1');
      status.local = !!(localPigeons || localRaces);
      
      // æ£€æµ‹äº‘ç«¯æ•°æ®ï¼ˆå¦‚æœæœ‰tokenï¼‰
      if (status.token) {
        try {
          const apiUrl = getBackendApiUrl();
          let checkUrl = apiUrl.trim();
          if (checkUrl.endsWith('/')) {
            checkUrl = checkUrl.slice(0, -1);
          }
          if (!checkUrl.endsWith('/api/user/data/full')) {
            if (checkUrl.endsWith('/api')) {
              checkUrl = checkUrl + '/user/data/full';
            } else {
              checkUrl = checkUrl + '/api/user/data/full';
            }
          }
          
          const response = await fetch(checkUrl, {
            method: 'GET',
            headers: {
              'Authorization': 'Bearer ' + status.token
            }
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
              const hasCloudData = !!(result.data.pigeons?.length || result.data.races?.length);
              status.cloud = hasCloudData;
            }
          }
        } catch (error) {
          console.warn('âš ï¸ [æ£€æµ‹] äº‘ç«¯æ•°æ®æ£€æµ‹å¤±è´¥:', error.message);
        }
      }
      
      console.log('ğŸ“Š [æ£€æµ‹] æ•°æ®ä¸Šä¼ çŠ¶æ€:', status);
      return status;
    } catch (error) {
      console.error('âŒ [æ£€æµ‹] æ•°æ®ä¸Šä¼ çŠ¶æ€æ£€æµ‹å¤±è´¥:', error);
      return status;
    }
  }
  
  /**
   * è‡ªåŠ¨è°ƒå–æ•°æ®ï¼ˆä¼˜å…ˆä»æœ¬åœ°ï¼Œç„¶åä»äº‘ç«¯ï¼‰
   */
  async function autoLoadData(dataType) {
    try {
      // ä½¿ç”¨ä¸é¡µé¢ä¸€è‡´çš„å­˜å‚¨é”®å
      let storageKey;
      if (dataType === 'pigeons') {
        storageKey = 'pigeon_manager_data_v1'; // ä¸PCç«¯å’Œç§»åŠ¨ç«¯ä¿æŒä¸€è‡´
      } else if (dataType === 'races') {
        storageKey = 'pigeon_races_v1'; // ä¸PCç«¯å’Œç§»åŠ¨ç«¯ä¿æŒä¸€è‡´
      } else {
        storageKey = `pigeon_${dataType}_v1`;
      }
      let localData = null;
      let cloudData = null;
      
      // 1. ä¼˜å…ˆä»æœ¬åœ°åŠ è½½
      const localDataStr = localStorage.getItem(storageKey);
      if (localDataStr) {
        try {
          localData = JSON.parse(localDataStr);
          console.log(`âœ… [è‡ªåŠ¨è°ƒå–] ${dataType}å·²ä»æœ¬åœ°åŠ è½½ï¼Œæ•°é‡: ${Array.isArray(localData) ? localData.length : 'N/A'}`);
        } catch (e) {
          console.warn(`âš ï¸ [è‡ªåŠ¨è°ƒå–] ${dataType}æœ¬åœ°æ•°æ®è§£æå¤±è´¥:`, e);
        }
      }
      
      // 2. ç„¶åä»äº‘ç«¯åŠ è½½ï¼ˆç”¨äºåŒæ­¥å’Œè¡¥å……ï¼‰
      const token = localStorage.getItem('auth_token') || localStorage.getItem('token');
      if (token) {
        const apiUrl = getBackendApiUrl();
        
        // ç¡®ä¿API URLæ ¼å¼æ­£ç¡®
        let cloudUrl = apiUrl.trim();
        if (cloudUrl.endsWith('/')) {
          cloudUrl = cloudUrl.slice(0, -1);
        }
        if (!cloudUrl.endsWith('/api/user/data/' + dataType)) {
          if (cloudUrl.endsWith('/api')) {
            cloudUrl = cloudUrl + '/user/data/' + dataType;
          } else {
            cloudUrl = cloudUrl + '/api/user/data/' + dataType;
          }
        }
        
        try {
          const response = await fetch(cloudUrl, {
            method: 'GET',
            headers: {
              'Authorization': 'Bearer ' + token
            }
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
              cloudData = result.data;
              console.log(`âœ… [è‡ªåŠ¨è°ƒå–] ${dataType}å·²ä»äº‘ç«¯åŠ è½½ï¼Œæ•°é‡: ${Array.isArray(cloudData) ? cloudData.length : 'N/A'}`);
            }
          }
        } catch (error) {
          console.warn(`âš ï¸ [è‡ªåŠ¨è°ƒå–] ${dataType}äº‘ç«¯åŠ è½½å¤±è´¥:`, error.message);
        }
      }
      
      // 3. æ•°æ®åˆå¹¶ç­–ç•¥ï¼šä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ•°æ®ï¼Œäº‘ç«¯æ•°æ®ä½œä¸ºè¡¥å……
      let finalData = null;
      if (localData && Array.isArray(localData) && localData.length > 0) {
        // å¦‚æœæœ‰æœ¬åœ°æ•°æ®ï¼Œä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ•°æ®
        finalData = localData;
        
        // å¦‚æœäº‘ç«¯æœ‰æ•°æ®ï¼Œåˆå¹¶ï¼ˆæœ¬åœ°ä¼˜å…ˆï¼Œäº‘ç«¯è¡¥å……æ–°æ•°æ®ï¼‰
        if (cloudData && Array.isArray(cloudData) && cloudData.length > 0) {
          const localIds = new Set(localData.map(item => item.id || item.ring || JSON.stringify(item)));
          const newCloudItems = cloudData.filter(item => {
            const id = item.id || item.ring || JSON.stringify(item);
            return !localIds.has(id);
          });
          
          if (newCloudItems.length > 0) {
            finalData = [...localData, ...newCloudItems];
            // æ›´æ–°æœ¬åœ°å­˜å‚¨
            localStorage.setItem(storageKey, JSON.stringify(finalData));
            console.log(`âœ… [è‡ªåŠ¨è°ƒå–] ${dataType}å·²åˆå¹¶æœ¬åœ°å’Œäº‘ç«¯æ•°æ®ï¼Œæ–°å¢ ${newCloudItems.length} æ¡`);
          } else {
            console.log(`â„¹ï¸ [è‡ªåŠ¨è°ƒå–] ${dataType}æœ¬åœ°æ•°æ®å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€åˆå¹¶`);
          }
        }
      } else if (cloudData && Array.isArray(cloudData) && cloudData.length > 0) {
        // å¦‚æœæœ¬åœ°æ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨äº‘ç«¯æ•°æ®
        finalData = cloudData;
        // åŒæ­¥åˆ°æœ¬åœ°
        localStorage.setItem(storageKey, JSON.stringify(finalData));
        console.log(`âœ… [è‡ªåŠ¨è°ƒå–] ${dataType}å·²ä»äº‘ç«¯åŠ è½½å¹¶åŒæ­¥åˆ°æœ¬åœ°`);
      } else {
        // éƒ½æ²¡æœ‰æ•°æ®
        finalData = [];
        console.log(`â„¹ï¸ [è‡ªåŠ¨è°ƒå–] ${dataType}æš‚æ— æ•°æ®`);
      }
      
      return finalData;
    } catch (error) {
      console.error(`âŒ [è‡ªåŠ¨è°ƒå–] ${dataType}åŠ è½½å¤±è´¥:`, error);
      return null;
    }
  }
  
  /**
   * é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è°ƒå–æ‰€æœ‰æ•°æ®
   */
  async function autoLoadAllData() {
    console.log('ğŸ”§ [è‡ªåŠ¨è°ƒå–] å¼€å§‹åŠ è½½æ‰€æœ‰æ•°æ®...');
    
    // ç¡®ä¿æœ‰è´¦å·
    let account = JSON.parse(localStorage.getItem(AUTO_ACCOUNT_KEY) || 'null');
    if (!account) {
      account = await autoRegisterAccount();
    }
    
    // å¦‚æœæ²¡æœ‰tokenï¼Œå°è¯•ç™»å½•
    let token = localStorage.getItem('auth_token') || localStorage.getItem('token');
    if (!token && account) {
      const deviceId = getOrCreateDeviceId();
      const apiUrl = getBackendApiUrl();
      
      // ç¡®ä¿ç™»å½•URLæ ¼å¼æ­£ç¡®
      let loginUrl = apiUrl.trim();
      if (loginUrl.endsWith('/')) {
        loginUrl = loginUrl.slice(0, -1);
      }
      if (!loginUrl.endsWith('/api/auth/login')) {
        if (loginUrl.endsWith('/api')) {
          loginUrl = loginUrl + '/auth/login';
        } else {
          loginUrl = loginUrl + '/api/auth/login';
        }
      }
      
      try {
        const loginResponse = await fetch(loginUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: account.username,
            password: account.deviceId
          })
        });
        
        if (loginResponse.ok) {
          const result = await loginResponse.json();
          if (result.success && result.token) {
            token = result.token;
            localStorage.setItem('auth_token', token);
            // åŒæ—¶ä¿å­˜åˆ°tokené”®ï¼ˆå…¼å®¹ç§»åŠ¨ç«¯ï¼‰
            localStorage.setItem('token', token);
            console.log('âœ… [è‡ªåŠ¨è°ƒå–] å·²è‡ªåŠ¨ç™»å½•ï¼Œtokenå·²ä¿å­˜');
            
            // å¦‚æœè¿”å›äº†ç”¨æˆ·ä¿¡æ¯ï¼Œä¿å­˜å®ƒ
            if (result.data && result.data.user) {
              localStorage.setItem('userInfo', JSON.stringify(result.data.user));
              console.log('âœ… [è‡ªåŠ¨è°ƒå–] å·²ä¿å­˜ç”¨æˆ·ä¿¡æ¯');
            } else if (account) {
              // å¦‚æœæ²¡æœ‰è¿”å›ç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨è´¦æˆ·ä¿¡æ¯
              localStorage.setItem('userInfo', JSON.stringify({
                username: account.username,
                email: account.email,
                name: account.username
              }));
            }
            
            // æ›´æ–°ç§»åŠ¨ç«¯ç”¨æˆ·æŒ‰é’®æ˜¾ç¤º
            if (typeof window.updateMobileUserButton === 'function') {
              setTimeout(() => {
                window.updateMobileUserButton();
                console.log('âœ… [è‡ªåŠ¨è°ƒå–] å·²æ›´æ–°ç§»åŠ¨ç«¯ç”¨æˆ·æŒ‰é’®');
              }, 100);
            }
          } else {
            console.warn('âš ï¸ [è‡ªåŠ¨è°ƒå–] ç™»å½•å“åº”æˆåŠŸä½†æœªè¿”å›token:', result);
          }
        } else {
          const errorText = await loginResponse.text();
          console.warn('âš ï¸ [è‡ªåŠ¨è°ƒå–] ç™»å½•å¤±è´¥ï¼ŒçŠ¶æ€ç :', loginResponse.status, 'å“åº”:', errorText);
        }
      } catch (error) {
        console.warn('âš ï¸ [è‡ªåŠ¨è°ƒå–] è‡ªåŠ¨ç™»å½•å¤±è´¥:', error);
      }
    }
    
    // åŠ è½½æ‰€æœ‰æ•°æ®ç±»å‹ï¼ˆä¼˜å…ˆæœ¬åœ°ï¼Œç„¶åäº‘ç«¯ï¼‰
    const dataTypes = ['pigeons', 'races', 'healthRecords', 'trainingRecords', 'pairings', 'qualificationRecords'];
    
    console.log('ğŸ”§ [è‡ªåŠ¨è°ƒå–] å¼€å§‹æŒ‰ä¼˜å…ˆçº§åŠ è½½æ•°æ®ï¼š1.æœ¬åœ° 2.äº‘ç«¯ 3.åˆå¹¶');
    
    for (const dataType of dataTypes) {
      const data = await autoLoadData(dataType); // autoLoadDataå·²ç»å®ç°äº†ä¼˜å…ˆæœ¬åœ°ã€ç„¶åäº‘ç«¯çš„é€»è¾‘
      
      // å¦‚æœå…¨å±€å˜é‡å­˜åœ¨ï¼Œæ›´æ–°å®ƒä»¬
      if (typeof window !== 'undefined') {
        if (dataType === 'pigeons') {
          if (data && Array.isArray(data) && data.length > 0) {
            window.pigeons = data;
            console.log(`âœ… [è‡ªåŠ¨è°ƒå–] å·²æ›´æ–°å…¨å±€å˜é‡ window.pigeonsï¼Œæ•°é‡: ${data.length}`);
          } else if (!window.pigeons) {
            window.pigeons = [];
          }
        } else if (dataType === 'races') {
          if (data && Array.isArray(data) && data.length > 0) {
            window.races = data;
            console.log(`âœ… [è‡ªåŠ¨è°ƒå–] å·²æ›´æ–°å…¨å±€å˜é‡ window.racesï¼Œæ•°é‡: ${data.length}`);
          } else if (!window.races) {
            window.races = [];
          }
        }
        // å…¶ä»–æ•°æ®ç±»å‹ç±»ä¼¼å¤„ç†
      }
    }
    
    // è§¦å‘é¡µé¢åˆ·æ–°ï¼ˆå¦‚æœé¡µé¢æœ‰åˆ·æ–°å‡½æ•°ï¼‰
    if (typeof window !== 'undefined') {
      // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œè®©é¡µé¢çŸ¥é“æ•°æ®å·²åŠ è½½
      window.dispatchEvent(new CustomEvent('pigeonDataLoaded', {
        detail: { 
          pigeons: window.pigeons || [],
          races: window.races || []
        }
      }));
      
      // å¦‚æœé¡µé¢æœ‰åˆ·æ–°å‡½æ•°ï¼Œè°ƒç”¨å®ƒä»¬
      if (typeof window.refreshList === 'function') {
        setTimeout(() => window.refreshList(), 100);
      }
      if (typeof window.refreshDashboard === 'function') {
        setTimeout(() => window.refreshDashboard(), 100);
      }
      if (typeof window.loadData === 'function') {
        setTimeout(() => window.loadData(), 100);
      }
    }
    
    console.log('âœ… [è‡ªåŠ¨è°ƒå–] æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆ');
    
    // è§¦å‘æ•°æ®åŠ è½½å®Œæˆäº‹ä»¶
    if (typeof window !== 'undefined') {
      window.dispatchEvent(new CustomEvent('dataAutoLoaded', {
        detail: { account, token }
      }));
    }
  }
  
  // ==================== 4. åˆå§‹åŒ– ====================
  
  /**
   * åˆå§‹åŒ–è‡ªåŠ¨è´¦å·ç³»ç»Ÿ
   */
  async function init() {
    console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] åˆå§‹åŒ–è‡ªåŠ¨è´¦å·ç³»ç»Ÿ...');
    console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] å¼€å§‹è®¾å¤‡è¯†åˆ«å’Œè‡ªåŠ¨ç™»å½•æµç¨‹...');
    
    // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
    const initFunction = async () => {
      // 1. è¯†åˆ«è®¾å¤‡ä¿¡æ¯
      const deviceId = getOrCreateDeviceId();
      const deviceInfo = getDeviceInfo();
      console.log('âœ… [è‡ªåŠ¨è´¦å·] è®¾å¤‡è¯†åˆ«å®Œæˆ:', {
        deviceId: deviceId ? deviceId.substring(0, 8) + '...' : 'æœªç”Ÿæˆ',
        deviceType: deviceInfo.deviceType,
        platform: deviceInfo.platform
      });
      
      // 2. è‡ªåŠ¨æ³¨å†Œ/ç™»å½•è´¦å·
      console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] å¼€å§‹è‡ªåŠ¨æ³¨å†Œ/ç™»å½•è´¦å·...');
      const account = await autoRegisterAccount();
      if (account) {
        console.log('âœ… [è‡ªåŠ¨è´¦å·] è´¦å·å‡†å¤‡å°±ç»ª:', account.username);
      } else {
        console.warn('âš ï¸ [è‡ªåŠ¨è´¦å·] è´¦å·æ³¨å†Œ/ç™»å½•å¤±è´¥ï¼Œå°†ä½¿ç”¨æœ¬åœ°æ¨¡å¼');
      }
      
      // 3. æ£€æµ‹æ•°æ®ä¸Šä¼ çŠ¶æ€
      const uploadStatus = await checkDataUploadStatus();
      console.log('ğŸ“Š [è‡ªåŠ¨è´¦å·] æ•°æ®ä¸Šä¼ çŠ¶æ€æ£€æµ‹:', {
        æœ¬åœ°æ•°æ®: uploadStatus.local ? 'âœ… æœ‰æ•°æ®' : 'âŒ æ— æ•°æ®',
        äº‘ç«¯æ•°æ®: uploadStatus.cloud ? 'âœ… æœ‰æ•°æ®' : 'âŒ æ— æ•°æ®',
        è®¾å¤‡ID: uploadStatus.deviceId ? 'âœ… å·²ç”Ÿæˆ' : 'âŒ æœªç”Ÿæˆ',
        è´¦å·: uploadStatus.account ? 'âœ… å·²ç™»å½•' : 'âŒ æœªç™»å½•'
      });
      
      // 4. è‡ªåŠ¨åŠ è½½æ‰€æœ‰æ•°æ®ï¼ˆä¼˜å…ˆæœ¬åœ°ï¼Œç„¶åäº‘ç«¯ï¼‰
      console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] å¼€å§‹åŠ è½½æ•°æ®ï¼ˆä¼˜å…ˆæœ¬åœ°ï¼Œç„¶åäº‘ç«¯ï¼‰...');
      await autoLoadAllData();
      
      // 3. å¦‚æœé¡µé¢æœ‰loadFromStorageå‡½æ•°ï¼Œä¹Ÿè°ƒç”¨å®ƒï¼ˆå…¼å®¹ç°æœ‰ä»£ç ï¼‰
      if (typeof window.loadFromStorage === 'function') {
        try {
          await window.loadFromStorage();
          console.log('âœ… [è‡ªåŠ¨è´¦å·] å·²è°ƒç”¨é¡µé¢loadFromStorageå‡½æ•°');
        } catch (error) {
          console.warn('âš ï¸ [è‡ªåŠ¨è´¦å·] è°ƒç”¨loadFromStorageå¤±è´¥:', error);
        }
      }
      
      // 4. å¦‚æœé¡µé¢æœ‰loadDataå‡½æ•°ï¼Œä¹Ÿè°ƒç”¨å®ƒï¼ˆç§»åŠ¨ç«¯ï¼‰
      if (typeof window.loadData === 'function') {
        try {
          window.loadData();
          console.log('âœ… [è‡ªåŠ¨è´¦å·] å·²è°ƒç”¨é¡µé¢loadDataå‡½æ•°');
        } catch (error) {
          console.warn('âš ï¸ [è‡ªåŠ¨è´¦å·] è°ƒç”¨loadDataå¤±è´¥:', error);
        }
      }
      
      // 5. å¦‚æœé¡µé¢æœ‰restoreUserDataIfMissingå‡½æ•°ï¼Œä¹Ÿè°ƒç”¨å®ƒ
      if (typeof window.restoreUserDataIfMissing === 'function') {
        try {
          await window.restoreUserDataIfMissing();
          console.log('âœ… [è‡ªåŠ¨è´¦å·] å·²è°ƒç”¨é¡µé¢restoreUserDataIfMissingå‡½æ•°');
        } catch (error) {
          console.warn('âš ï¸ [è‡ªåŠ¨è´¦å·] è°ƒç”¨restoreUserDataIfMissingå¤±è´¥:', error);
        }
      }
      
      // 6. å¦‚æœå·²è‡ªåŠ¨ç™»å½•ï¼Œéšè—ç™»å½•å¼¹çª—
      const token = localStorage.getItem('auth_token') || localStorage.getItem('token');
      if (token && typeof window.closeLoginModal === 'function') {
        setTimeout(() => {
          window.closeLoginModal();
          console.log('âœ… [è‡ªåŠ¨è´¦å·] å·²è‡ªåŠ¨ç™»å½•ï¼Œéšè—ç™»å½•å¼¹çª—');
        }, 500);
      }
      
      // 7. è§¦å‘æ•°æ®åŠ è½½å®Œæˆäº‹ä»¶ï¼Œè®©é¡µé¢åˆ·æ–°è§†å›¾
      if (typeof window !== 'undefined') {
        const account = JSON.parse(localStorage.getItem(AUTO_ACCOUNT_KEY) || 'null');
        const finalToken = localStorage.getItem('auth_token') || localStorage.getItem('token');
        console.log('ğŸ”” [è‡ªåŠ¨è´¦å·] è§¦å‘dataAutoLoadedäº‹ä»¶ï¼Œaccount:', account ? account.username : 'null', 'token:', finalToken ? 'å·²å­˜åœ¨' : 'ä¸å­˜åœ¨');
        window.dispatchEvent(new CustomEvent('dataAutoLoaded', {
          detail: { 
            account: account,
            token: finalToken
          }
        }));
      }
    };
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initFunction);
    } else {
      // å»¶è¿Ÿä¸€ç‚¹æ‰§è¡Œï¼Œç¡®ä¿å…¶ä»–è„šæœ¬å·²åŠ è½½
      setTimeout(initFunction, 100);
    }
    
    // ç›‘å¬æ•°æ®å˜åŒ–ï¼Œè‡ªåŠ¨ä¿å­˜
    if (typeof window !== 'undefined') {
      // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶
      window.addEventListener('dataChanged', async (event) => {
        const { dataType, data } = event.detail;
        if (dataType && data) {
          await autoSaveData(dataType, data);
        }
      });
      
      // å®šæœŸè‡ªåŠ¨ä¿å­˜ï¼ˆæ¯5åˆ†é’Ÿï¼‰
      setInterval(async () => {
        if (window.pigeons) {
          await autoSaveData('pigeons', window.pigeons);
        }
        if (window.races) {
          await autoSaveData('races', window.races);
        }
      }, 5 * 60 * 1000);
    }
    
    console.log('âœ… [è‡ªåŠ¨è´¦å·] è‡ªåŠ¨è´¦å·ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
  }
  
  // æš´éœ²åˆ°å…¨å±€
  if (typeof window !== 'undefined') {
    window.autoRegisterAccount = autoRegisterAccount;
    window.autoSaveData = autoSaveData;
    window.autoLoadData = autoLoadData;
    window.autoLoadAllData = autoLoadAllData;
    window.getOrCreateDeviceId = getOrCreateDeviceId;
    window.getDeviceInfo = getDeviceInfo;
    window.checkDataUploadStatus = checkDataUploadStatus;
  }
  
  // ç«‹å³åˆå§‹åŒ–
  init();
  
})();

