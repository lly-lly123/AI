/**
 * è‡ªåŠ¨è´¦å·æ³¨å†Œå’Œæ•°æ®ç®¡ç†è„šæœ¬
 * åŠŸèƒ½ï¼š
 * 1. è‡ªåŠ¨è¯†åˆ«è®¾å¤‡ä¿¡æ¯å¹¶ç”Ÿæˆè´¦å·
 * 2. è‡ªåŠ¨ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å’Œäº‘ç«¯
 * 3. é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è°ƒå–æœ¬åœ°å’Œäº‘ç«¯æ•°æ®
 * 4. ç½‘ç«™æ›´æ–°åè‡ªåŠ¨æ¢å¤æ•°æ®
 */

(function() {
  'use strict';
  
  console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] å¼€å§‹åˆå§‹åŒ–è‡ªåŠ¨è´¦å·æ³¨å†Œç³»ç»Ÿ...');
  
  // ==================== 1. è®¾å¤‡ä¿¡æ¯è¯†åˆ« ====================
  
  const DEVICE_ID_KEY = 'pigeon_device_id';
  const DEVICE_INFO_KEY = 'pigeon_device_info';
  const AUTO_ACCOUNT_KEY = 'pigeon_auto_account';
  
  /**
   * è·å–æˆ–åˆ›å»ºè®¾å¤‡ID
   */
  function getOrCreateDeviceId() {
    try {
      let deviceId = localStorage.getItem(DEVICE_ID_KEY);
      if (!deviceId) {
        // ç”Ÿæˆå”¯ä¸€è®¾å¤‡ID
        if (window.crypto && window.crypto.randomUUID) {
          deviceId = window.crypto.randomUUID();
        } else {
          deviceId = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        localStorage.setItem(DEVICE_ID_KEY, deviceId);
        console.log('âœ… [è‡ªåŠ¨è´¦å·] å·²åˆ›å»ºæ–°è®¾å¤‡ID:', deviceId);
      }
      return deviceId;
    } catch (e) {
      console.warn('âš ï¸ [è‡ªåŠ¨è´¦å·] ç”Ÿæˆè®¾å¤‡IDå¤±è´¥:', e);
      return null;
    }
  }
  
  /**
   * è·å–è®¾å¤‡ä¿¡æ¯
   */
  function getDeviceInfo() {
    try {
      let deviceInfo = localStorage.getItem(DEVICE_INFO_KEY);
      if (deviceInfo) {
        return JSON.parse(deviceInfo);
      }
      
      // æ”¶é›†è®¾å¤‡ä¿¡æ¯
      deviceInfo = {
        userAgent: navigator.userAgent || '',
        platform: navigator.platform || '',
        language: navigator.language || '',
        screenWidth: window.screen.width || 0,
        screenHeight: window.screen.height || 0,
        deviceType: /Mobile|Android|iPhone|iPad/i.test(navigator.userAgent) ? 'mobile' : 'desktop',
        timestamp: new Date().toISOString()
      };
      
      localStorage.setItem(DEVICE_INFO_KEY, JSON.stringify(deviceInfo));
      return deviceInfo;
    } catch (e) {
      console.warn('âš ï¸ [è‡ªåŠ¨è´¦å·] è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥:', e);
      return {
        userAgent: navigator.userAgent || '',
        platform: navigator.platform || '',
        deviceType: 'unknown'
      };
    }
  }
  
  // ==================== 2. è‡ªåŠ¨è´¦å·æ³¨å†Œ ====================
  
  /**
   * è‡ªåŠ¨æ³¨å†Œè´¦å·ï¼ˆåŸºäºè®¾å¤‡IDï¼‰
   */
  async function autoRegisterAccount() {
    try {
      // æ£€æŸ¥æ˜¯å¦å·²æœ‰è´¦å·
      const existingAccount = localStorage.getItem(AUTO_ACCOUNT_KEY);
      if (existingAccount) {
        const account = JSON.parse(existingAccount);
        console.log('âœ… [è‡ªåŠ¨è´¦å·] ä½¿ç”¨å·²æœ‰è´¦å·:', account.username);
        return account;
      }
      
      const deviceId = getOrCreateDeviceId();
      if (!deviceId) {
        console.warn('âš ï¸ [è‡ªåŠ¨è´¦å·] æ— æ³•ç”Ÿæˆè®¾å¤‡IDï¼Œè·³è¿‡è‡ªåŠ¨æ³¨å†Œ');
        return null;
      }
      
      const deviceInfo = getDeviceInfo();
      const apiUrl = getBackendApiUrl();
      
      // ç”Ÿæˆç”¨æˆ·åï¼ˆåŸºäºè®¾å¤‡IDï¼‰
      const username = 'user_' + deviceId.substring(0, 8);
      const email = username + '@auto.local';
      const password = deviceId; // ä½¿ç”¨è®¾å¤‡IDä½œä¸ºå¯†ç 
      
      console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] æ­£åœ¨è‡ªåŠ¨æ³¨å†Œè´¦å·...');
      console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] API URL:', apiUrl);
      console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] è®¾å¤‡ä¿¡æ¯:', {
        deviceId: deviceId.substring(0, 8) + '...',
        deviceType: deviceInfo.deviceType,
        platform: deviceInfo.platform
      });
      
      // ç¡®ä¿API URLæ ¼å¼æ­£ç¡®ï¼ˆå¦‚æœå·²ç»åŒ…å«/apiï¼Œä¸å†é‡å¤æ·»åŠ ï¼‰
      let registerUrl = apiUrl;
      if (!registerUrl.endsWith('/api/auth/register')) {
        if (registerUrl.endsWith('/api')) {
          registerUrl = registerUrl + '/auth/register';
        } else if (registerUrl.endsWith('/')) {
          registerUrl = registerUrl + 'api/auth/register';
        } else {
          registerUrl = registerUrl + '/api/auth/register';
        }
      }
      
      console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] æ³¨å†ŒURL:', registerUrl);
      
      // å°è¯•æ³¨å†Œ
      const registerResponse = await fetch(registerUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          username: username,
          email: email,
          password: password
        })
      });
      
      let account = null;
      
      if (registerResponse.ok) {
        const result = await registerResponse.json();
        if (result.success) {
          account = {
            username: username,
            email: email,
            deviceId: deviceId,
            deviceInfo: deviceInfo,
            createdAt: new Date().toISOString(),
            autoGenerated: true
          };
          localStorage.setItem(AUTO_ACCOUNT_KEY, JSON.stringify(account));
          console.log('âœ… [è‡ªåŠ¨è´¦å·] è´¦å·æ³¨å†ŒæˆåŠŸ:', username);
        }
      } else {
        // å¦‚æœæ³¨å†Œå¤±è´¥ï¼ˆå¯èƒ½ç”¨æˆ·åå·²å­˜åœ¨ï¼‰ï¼Œå°è¯•ç™»å½•
        const errorText = await registerResponse.text();
        console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] æ³¨å†Œå¤±è´¥ï¼ŒçŠ¶æ€ç :', registerResponse.status);
        console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] æ³¨å†Œå¤±è´¥ï¼Œå“åº”:', errorText);
        console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] å°è¯•ç™»å½•...');
        
        // ç¡®ä¿ç™»å½•URLæ ¼å¼æ­£ç¡®
        let loginUrl = apiUrl;
        if (!loginUrl.endsWith('/api/auth/login')) {
          if (loginUrl.endsWith('/api')) {
            loginUrl = loginUrl + '/auth/login';
          } else if (loginUrl.endsWith('/')) {
            loginUrl = loginUrl + 'api/auth/login';
          } else {
            loginUrl = loginUrl + '/api/auth/login';
          }
        }
        
        console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] ç™»å½•URL:', loginUrl);
        const loginResponse = await fetch(loginUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: username,
            password: password
          })
        });
        
        if (loginResponse.ok) {
          const result = await loginResponse.json();
          if (result.success && result.token) {
            account = {
              username: username,
              email: email,
              deviceId: deviceId,
              deviceInfo: deviceInfo,
              createdAt: new Date().toISOString(),
              autoGenerated: true
            };
            localStorage.setItem(AUTO_ACCOUNT_KEY, JSON.stringify(account));
            // ä¿å­˜token
            if (typeof setAuthToken === 'function') {
              setAuthToken(result.token);
            } else {
              localStorage.setItem('auth_token', result.token);
            }
            console.log('âœ… [è‡ªåŠ¨è´¦å·] ç™»å½•æˆåŠŸ:', username);
          }
        }
      }
      
      if (!account) {
        console.warn('âš ï¸ [è‡ªåŠ¨è´¦å·] æœªèƒ½åˆ›å»ºæˆ–ç™»å½•è´¦æˆ·ï¼Œå¯èƒ½çš„åŸå› ï¼š');
        console.warn('  1. ç½‘ç»œè¿æ¥é—®é¢˜');
        console.warn('  2. åç«¯æœåŠ¡æœªå¯åŠ¨');
        console.warn('  3. APIåœ°å€é…ç½®é”™è¯¯');
        console.warn('  4. æ³¨å†Œæ¥å£è¿”å›é”™è¯¯');
      }
      
      return account;
    } catch (error) {
      console.error('âŒ [è‡ªåŠ¨è´¦å·] è‡ªåŠ¨æ³¨å†Œå¤±è´¥:', error);
      console.error('âŒ [è‡ªåŠ¨è´¦å·] é”™è¯¯è¯¦æƒ…:', {
        message: error.message,
        stack: error.stack,
        apiUrl: apiUrl
      });
      return null;
    }
  }
  
  /**
   * è·å–åç«¯API URL
   */
  function getBackendApiUrl() {
    // å°è¯•ä»å…¨å±€å˜é‡è·å–
    if (typeof window !== 'undefined' && window.BACKEND_API_URL) {
      return window.BACKEND_API_URL;
    }
    
    // å°è¯•ä»é¡µé¢çš„getBackendApiUrlå‡½æ•°è·å–ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (typeof window !== 'undefined' && typeof window.getBackendApiUrl === 'function') {
      try {
        const apiUrl = window.getBackendApiUrl();
        if (apiUrl) {
          console.log('âœ… [è‡ªåŠ¨è´¦å·] ä»é¡µé¢å‡½æ•°è·å–API URL:', apiUrl);
          return apiUrl;
        }
      } catch (e) {
        console.warn('âš ï¸ [è‡ªåŠ¨è´¦å·] è°ƒç”¨é¡µé¢getBackendApiUrlå¤±è´¥:', e);
      }
    }
    
    // ä»å½“å‰é¡µé¢URLæ¨æ–­
    const hostname = window.location.hostname;
    if (hostname.includes('localhost') || hostname.includes('127.0.0.1')) {
      return 'http://localhost:3000';
    }
    
    // ä½¿ç”¨å½“å‰åŸŸåï¼ˆè‡ªåŠ¨æ·»åŠ /apiè·¯å¾„ï¼‰
    const origin = window.location.origin;
    const apiUrl = origin + '/api';
    console.log('âœ… [è‡ªåŠ¨è´¦å·] ä½¿ç”¨å½“å‰åŸŸåä½œä¸ºAPI URL:', apiUrl);
    return apiUrl;
  }
  
  // ==================== 3. æ•°æ®è‡ªåŠ¨ä¿å­˜å’Œè°ƒå– ====================
  
  /**
   * è‡ªåŠ¨ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å’Œäº‘ç«¯
   */
  async function autoSaveData(dataType, data) {
    try {
      // 1. ä¿å­˜åˆ°æœ¬åœ°
      const storageKey = `pigeon_${dataType}_v1`;
      localStorage.setItem(storageKey, JSON.stringify(data));
      console.log(`âœ… [è‡ªåŠ¨ä¿å­˜] ${dataType}å·²ä¿å­˜åˆ°æœ¬åœ°`);
      
      // 2. ä¿å­˜åˆ°äº‘ç«¯
      const account = JSON.parse(localStorage.getItem(AUTO_ACCOUNT_KEY) || 'null');
      if (!account) {
        // å¦‚æœæ²¡æœ‰è´¦å·ï¼Œå…ˆè‡ªåŠ¨æ³¨å†Œ
        await autoRegisterAccount();
      }
      
      const token = localStorage.getItem('auth_token');
      if (token) {
        const apiUrl = getBackendApiUrl();
        
        try {
          const response = await fetch(apiUrl + '/api/user/data/' + dataType, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({
              [dataType]: data
            })
          });
          
          if (response.ok) {
            console.log(`âœ… [è‡ªåŠ¨ä¿å­˜] ${dataType}å·²ä¿å­˜åˆ°äº‘ç«¯`);
          } else {
            console.warn(`âš ï¸ [è‡ªåŠ¨ä¿å­˜] ${dataType}äº‘ç«¯ä¿å­˜å¤±è´¥:`, response.status);
          }
        } catch (error) {
          console.warn(`âš ï¸ [è‡ªåŠ¨ä¿å­˜] ${dataType}äº‘ç«¯ä¿å­˜å¼‚å¸¸:`, error);
        }
      }
    } catch (error) {
      console.error(`âŒ [è‡ªåŠ¨ä¿å­˜] ${dataType}ä¿å­˜å¤±è´¥:`, error);
    }
  }
  
  /**
   * è‡ªåŠ¨è°ƒå–æ•°æ®ï¼ˆä¼˜å…ˆä»äº‘ç«¯ï¼Œå¤±è´¥åˆ™ä½¿ç”¨æœ¬åœ°ï¼‰
   */
  async function autoLoadData(dataType) {
    try {
      const storageKey = `pigeon_${dataType}_v1`;
      let data = null;
      
      // 1. å°è¯•ä»äº‘ç«¯åŠ è½½
      const token = localStorage.getItem('auth_token');
      if (token) {
        const apiUrl = getBackendApiUrl();
        
        try {
          const response = await fetch(apiUrl + '/api/user/data/' + dataType, {
            method: 'GET',
            headers: {
              'Authorization': 'Bearer ' + token
            }
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
              data = result.data;
              // åŒæ­¥åˆ°æœ¬åœ°
              localStorage.setItem(storageKey, JSON.stringify(data));
              console.log(`âœ… [è‡ªåŠ¨è°ƒå–] ${dataType}å·²ä»äº‘ç«¯åŠ è½½å¹¶åŒæ­¥åˆ°æœ¬åœ°`);
              return data;
            }
          }
        } catch (error) {
          console.warn(`âš ï¸ [è‡ªåŠ¨è°ƒå–] ${dataType}äº‘ç«¯åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:`, error);
        }
      }
      
      // 2. ä»æœ¬åœ°åŠ è½½
      const localData = localStorage.getItem(storageKey);
      if (localData) {
        data = JSON.parse(localData);
        console.log(`âœ… [è‡ªåŠ¨è°ƒå–] ${dataType}å·²ä»æœ¬åœ°åŠ è½½`);
        return data;
      }
      
      console.log(`â„¹ï¸ [è‡ªåŠ¨è°ƒå–] ${dataType}æš‚æ— æ•°æ®`);
      return null;
    } catch (error) {
      console.error(`âŒ [è‡ªåŠ¨è°ƒå–] ${dataType}åŠ è½½å¤±è´¥:`, error);
      return null;
    }
  }
  
  /**
   * é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è°ƒå–æ‰€æœ‰æ•°æ®
   */
  async function autoLoadAllData() {
    console.log('ğŸ”§ [è‡ªåŠ¨è°ƒå–] å¼€å§‹åŠ è½½æ‰€æœ‰æ•°æ®...');
    
    // ç¡®ä¿æœ‰è´¦å·
    let account = JSON.parse(localStorage.getItem(AUTO_ACCOUNT_KEY) || 'null');
    if (!account) {
      account = await autoRegisterAccount();
    }
    
    // å¦‚æœæ²¡æœ‰tokenï¼Œå°è¯•ç™»å½•
    let token = localStorage.getItem('auth_token');
    if (!token && account) {
      const deviceId = getOrCreateDeviceId();
      const apiUrl = getBackendApiUrl();
      
      try {
        const loginResponse = await fetch(apiUrl + '/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: account.username,
            password: account.deviceId
          })
        });
        
        if (loginResponse.ok) {
          const result = await loginResponse.json();
          if (result.success && result.token) {
            token = result.token;
            localStorage.setItem('auth_token', token);
            console.log('âœ… [è‡ªåŠ¨è°ƒå–] å·²è‡ªåŠ¨ç™»å½•');
          }
        }
      } catch (error) {
        console.warn('âš ï¸ [è‡ªåŠ¨è°ƒå–] è‡ªåŠ¨ç™»å½•å¤±è´¥:', error);
      }
    }
    
    // åŠ è½½æ‰€æœ‰æ•°æ®ç±»å‹
    const dataTypes = ['pigeons', 'races', 'healthRecords', 'trainingRecords', 'pairings', 'qualificationRecords'];
    
    for (const dataType of dataTypes) {
      const data = await autoLoadData(dataType);
      // å¦‚æœå…¨å±€å˜é‡å­˜åœ¨ï¼Œæ›´æ–°å®ƒä»¬
      if (typeof window !== 'undefined') {
        if (dataType === 'pigeons' && window.pigeons) {
          window.pigeons = data || [];
        } else if (dataType === 'races' && window.races) {
          window.races = data || [];
        }
        // å…¶ä»–æ•°æ®ç±»å‹ç±»ä¼¼å¤„ç†
      }
    }
    
    console.log('âœ… [è‡ªåŠ¨è°ƒå–] æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆ');
    
    // è§¦å‘æ•°æ®åŠ è½½å®Œæˆäº‹ä»¶
    if (typeof window !== 'undefined') {
      window.dispatchEvent(new CustomEvent('dataAutoLoaded', {
        detail: { account, token }
      }));
    }
  }
  
  // ==================== 4. åˆå§‹åŒ– ====================
  
  /**
   * åˆå§‹åŒ–è‡ªåŠ¨è´¦å·ç³»ç»Ÿ
   */
  async function init() {
    console.log('ğŸ”§ [è‡ªåŠ¨è´¦å·] åˆå§‹åŒ–è‡ªåŠ¨è´¦å·ç³»ç»Ÿ...');
    
    // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
    const initFunction = async () => {
      // 1. è‡ªåŠ¨æ³¨å†Œè´¦å·
      await autoRegisterAccount();
      
      // 2. è‡ªåŠ¨åŠ è½½æ‰€æœ‰æ•°æ®
      await autoLoadAllData();
      
      // 3. å¦‚æœé¡µé¢æœ‰loadFromStorageå‡½æ•°ï¼Œä¹Ÿè°ƒç”¨å®ƒï¼ˆå…¼å®¹ç°æœ‰ä»£ç ï¼‰
      if (typeof window.loadFromStorage === 'function') {
        try {
          await window.loadFromStorage();
          console.log('âœ… [è‡ªåŠ¨è´¦å·] å·²è°ƒç”¨é¡µé¢loadFromStorageå‡½æ•°');
        } catch (error) {
          console.warn('âš ï¸ [è‡ªåŠ¨è´¦å·] è°ƒç”¨loadFromStorageå¤±è´¥:', error);
        }
      }
      
      // 4. å¦‚æœé¡µé¢æœ‰loadDataå‡½æ•°ï¼Œä¹Ÿè°ƒç”¨å®ƒï¼ˆç§»åŠ¨ç«¯ï¼‰
      if (typeof window.loadData === 'function') {
        try {
          window.loadData();
          console.log('âœ… [è‡ªåŠ¨è´¦å·] å·²è°ƒç”¨é¡µé¢loadDataå‡½æ•°');
        } catch (error) {
          console.warn('âš ï¸ [è‡ªåŠ¨è´¦å·] è°ƒç”¨loadDataå¤±è´¥:', error);
        }
      }
      
      // 5. å¦‚æœé¡µé¢æœ‰restoreUserDataIfMissingå‡½æ•°ï¼Œä¹Ÿè°ƒç”¨å®ƒ
      if (typeof window.restoreUserDataIfMissing === 'function') {
        try {
          await window.restoreUserDataIfMissing();
          console.log('âœ… [è‡ªåŠ¨è´¦å·] å·²è°ƒç”¨é¡µé¢restoreUserDataIfMissingå‡½æ•°');
        } catch (error) {
          console.warn('âš ï¸ [è‡ªåŠ¨è´¦å·] è°ƒç”¨restoreUserDataIfMissingå¤±è´¥:', error);
        }
      }
      
      // 6. è§¦å‘æ•°æ®åŠ è½½å®Œæˆäº‹ä»¶ï¼Œè®©é¡µé¢åˆ·æ–°è§†å›¾
      if (typeof window !== 'undefined') {
        window.dispatchEvent(new CustomEvent('dataAutoLoaded', {
          detail: { 
            account: JSON.parse(localStorage.getItem(AUTO_ACCOUNT_KEY) || 'null'),
            token: localStorage.getItem('auth_token')
          }
        }));
      }
    };
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initFunction);
    } else {
      // å»¶è¿Ÿä¸€ç‚¹æ‰§è¡Œï¼Œç¡®ä¿å…¶ä»–è„šæœ¬å·²åŠ è½½
      setTimeout(initFunction, 100);
    }
    
    // ç›‘å¬æ•°æ®å˜åŒ–ï¼Œè‡ªåŠ¨ä¿å­˜
    if (typeof window !== 'undefined') {
      // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶
      window.addEventListener('dataChanged', async (event) => {
        const { dataType, data } = event.detail;
        if (dataType && data) {
          await autoSaveData(dataType, data);
        }
      });
      
      // å®šæœŸè‡ªåŠ¨ä¿å­˜ï¼ˆæ¯5åˆ†é’Ÿï¼‰
      setInterval(async () => {
        if (window.pigeons) {
          await autoSaveData('pigeons', window.pigeons);
        }
        if (window.races) {
          await autoSaveData('races', window.races);
        }
      }, 5 * 60 * 1000);
    }
    
    console.log('âœ… [è‡ªåŠ¨è´¦å·] è‡ªåŠ¨è´¦å·ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
  }
  
  // æš´éœ²åˆ°å…¨å±€
  if (typeof window !== 'undefined') {
    window.autoRegisterAccount = autoRegisterAccount;
    window.autoSaveData = autoSaveData;
    window.autoLoadData = autoLoadData;
    window.autoLoadAllData = autoLoadAllData;
    window.getOrCreateDeviceId = getOrCreateDeviceId;
    window.getDeviceInfo = getDeviceInfo;
  }
  
  // ç«‹å³åˆå§‹åŒ–
  init();
  
})();

