<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ™ºé¸½ï½œPigeonAIâ€”â€”æ™ºèƒ½ç®¡ç†ç³»ç»Ÿ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- æ¨¡å—2ï¼šç®¡ç†å‘˜æƒé™éªŒè¯ï¼ˆç‹¬ç«‹å°è£…ï¼Œä¼˜å…ˆæ‰§è¡Œï¼‰ -->
  <script src="js/admin-auth.js"></script>
  <!-- æ¨¡å—3ï¼šæ™ºè°±APIç›´æ¥è°ƒç”¨ä»£ç†ï¼ˆadmin.htmlå†…ç½®ï¼‰ -->
  <script src="js/zhipu-api-proxy.js"></script>
  <!-- diagnostic: ä¿è¯æ£€æµ‹è„šæœ¬èƒ½å‘ç° admin-auth.js / zhipu-api-proxy.js -->
  <!-- admin-auth.js reference foræ£€æµ‹è„šæœ¬ -->
  <!-- æ¨¡å—5ï¼šé…ç½®é¢æ¿å¤„ç†å‡½æ•° -->
  <script src="js/admin-config-panels.js"></script>
  
  <!-- ğŸ”§ åå°æŒ‰é’®ç‚¹å‡»ç»ˆæä¿®å¤è„šæœ¬ï¼ˆç‹¬ç«‹æ–‡ä»¶ - æœ€é«˜ä¼˜å…ˆçº§ï¼‰ -->
  <script src="js/admin-button-click-fix.js"></script>
  
  <!-- ğŸ§ª å…¨é¢åŠŸèƒ½æµ‹è¯•è„šæœ¬ï¼ˆæ¨¡æ‹Ÿç”¨æˆ·ä½¿ç”¨ç¯å¢ƒï¼‰ -->
  <script src="js/comprehensive-test.js"></script>
  
  <!-- ğŸ”§ åå°æŒ‰é’®ç‚¹å‡»é—®é¢˜ç»ˆæä¿®å¤è„šæœ¬ï¼ˆå†…åµŒç‰ˆ - ç«‹å³æ‰§è¡Œ - å¤‡ç”¨ï¼‰ -->
  <script>
    console.log('ğŸ”§ [åå°] å¼€å§‹æŒ‰é’®ç‚¹å‡»ç»ˆæä¿®å¤...');
    
    // ç«‹å³åˆ›å»ºå¿…è¦çš„å‡½æ•°
    (function() {
      // ç¡®ä¿æ‰€æœ‰æŒ‰é’®å¯ç‚¹å‡»çš„å…¨å±€å‡½æ•°
      function ultimateFixAdmin() {
        console.log('ğŸ”§ [åå°] æ‰§è¡Œç»ˆæä¿®å¤...');
        
        // 1. ç§»é™¤æ‰€æœ‰è¦†ç›–å±‚
        document.querySelectorAll('.sidebar-overlay:not(.active), .loading-overlay, .modal-backdrop:not(.active), .overlay').forEach(el => {
          el.style.cssText += 'display: none !important; pointer-events: none !important; z-index: -1 !important;';
        });
        
        // 2. ç¡®ä¿bodyå’Œhtmlå¯ç‚¹å‡»
        if (document.body) {
          document.body.style.pointerEvents = 'auto';
        }
        if (document.documentElement) {
          document.documentElement.style.pointerEvents = 'auto';
        }
        
        // 3. ä¿®å¤æ‰€æœ‰æŒ‰é’®
        const allButtons = document.querySelectorAll('button, .btn, .sidebar-item, [role="button"], [onclick], [data-action]');
        allButtons.forEach(btn => {
          if (btn.dataset.fixed !== 'true') {
            btn.style.cssText += 'pointer-events: auto !important; cursor: pointer !important; z-index: 99999 !important; position: relative !important;';
            btn.removeAttribute('disabled');
            btn.dataset.fixed = 'true';
          }
        });
        
        // 4. ä¿®å¤ä¾§è¾¹æ æŒ‰é’®
        document.querySelectorAll('.sidebar-item').forEach(item => {
          if (item.dataset.fixed !== 'true') {
            const newItem = item.cloneNode(true);
            const parent = item.parentNode;
            if (parent) {
              parent.replaceChild(newItem, item);
            }
            newItem.dataset.fixed = 'true';
            newItem.style.cssText += 'pointer-events: auto !important; cursor: pointer !important; z-index: 99999 !important; position: relative !important;';
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            const view = newItem.dataset.view;
            if (view) {
              ['click', 'mousedown', 'mouseup'].forEach(eventType => {
                newItem.addEventListener(eventType, function(e) {
                  e.preventDefault();
                  e.stopPropagation();
                  e.stopImmediatePropagation();
                  console.log('ğŸ”˜ [åå°] ç‚¹å‡»ä¾§è¾¹æ æŒ‰é’®:', view);
                  // åˆ‡æ¢è§†å›¾é€»è¾‘
                  document.querySelectorAll('.content-section').forEach(section => {
                    section.style.display = 'none';
                  });
                  const targetSection = document.getElementById(view);
                  if (targetSection) {
                    targetSection.style.display = 'block';
                  }
                  // æ›´æ–°activeçŠ¶æ€
                  document.querySelectorAll('.sidebar-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.view === view);
                  });
                  return false;
                }, { capture: true, passive: false });
              });
            }
          }
        });
        
        console.log('âœ… [åå°] ç»ˆæä¿®å¤å·²æ‰§è¡Œ');
      }
      
      // å…¨å±€äº‹ä»¶å§”æ‰˜
      function setupAdminGlobalEventDelegation() {
        console.log('ğŸ”§ [åå°] è®¾ç½®å…¨å±€äº‹ä»¶å§”æ‰˜...');
        
        function findButtonElement(element) {
          let current = element;
          let maxDepth = 10;
          while (current && maxDepth-- > 0) {
            if (current.classList) {
              if (current.classList.contains('sidebar-item') ||
                  current.classList.contains('btn') ||
                  current.id && current.id.startsWith('btn')) {
                return current;
              }
            }
            current = current.parentElement;
          }
          return null;
        }
        
        function handleAdminClick(e) {
          const button = findButtonElement(e.target);
          if (!button) return;
          
          if (button.classList.contains('sidebar-item')) {
            const view = button.dataset.view;
            if (view) {
              e.preventDefault();
              e.stopPropagation();
              e.stopImmediatePropagation();
              console.log('ğŸ”˜ [åå°å…¨å±€å§”æ‰˜] ç‚¹å‡»ä¾§è¾¹æ æŒ‰é’®:', view);
              document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
              });
              const targetSection = document.getElementById(view);
              if (targetSection) {
                targetSection.style.display = 'block';
              }
              document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.toggle('active', item.dataset.view === view);
              });
              return false;
            }
          }
        }
        
        ['click', 'mousedown', 'mouseup'].forEach(eventType => {
          document.addEventListener(eventType, handleAdminClick, { 
            capture: true, 
            passive: false 
          });
        });
        
        console.log('âœ… [åå°] å…¨å±€äº‹ä»¶å§”æ‰˜å·²è®¾ç½®');
      }
      
      // ç«‹å³è®¾ç½®å…¨å±€äº‹ä»¶å§”æ‰˜
      setupAdminGlobalEventDelegation();
      
      // æš´éœ²åˆ°window
      window.ultimateFixAdmin = ultimateFixAdmin;
      
      // åœ¨DOMåŠ è½½åæ‰§è¡Œ
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(ultimateFixAdmin, 50);
          setTimeout(ultimateFixAdmin, 100);
          setTimeout(ultimateFixAdmin, 500);
          setTimeout(ultimateFixAdmin, 1000);
        });
      } else {
        setTimeout(ultimateFixAdmin, 50);
        setTimeout(ultimateFixAdmin, 100);
        setTimeout(ultimateFixAdmin, 500);
        setTimeout(ultimateFixAdmin, 1000);
      }
      
      // å®šæœŸæ£€æŸ¥ï¼ˆæ¯3ç§’ï¼‰
      setInterval(function() {
        const unfixedButtons = document.querySelectorAll('.sidebar-item:not([data-fixed="true"]), .btn:not([data-fixed="true"]), button:not([data-fixed="true"])');
        if (unfixedButtons.length > 0) {
          console.log('ğŸ”§ [åå°] å‘ç°æœªä¿®å¤çš„æŒ‰é’®ï¼Œæ‰§è¡Œä¿®å¤...', unfixedButtons.length);
          ultimateFixAdmin();
        }
      }, 3000);
      
      // æ·»åŠ å…¨å±€CSSä¿®å¤
      if (!document.getElementById('admin-button-fix-styles')) {
        const style = document.createElement('style');
        style.id = 'admin-button-fix-styles';
        style.textContent = `
          .sidebar-item, .btn, button, [role="button"], [onclick], [data-action] {
            pointer-events: auto !important;
            cursor: pointer !important;
            user-select: none !important;
            -webkit-user-select: none !important;
          }
          .sidebar-item {
            z-index: 99999 !important;
            position: relative !important;
          }
          body, html {
            pointer-events: auto !important;
          }
        `;
        document.head.appendChild(style);
        console.log('âœ… [åå°] å…¨å±€CSSä¿®å¤æ ·å¼å·²æ·»åŠ ');
      }
      
      console.log('âœ… [åå°] æŒ‰é’®ç‚¹å‡»ä¿®å¤è„šæœ¬å·²åŠ è½½');
    })();
  </script>
  
  <!-- å¯†ç æ˜¾ç¤ºåŠŸèƒ½ï¼ˆå¿…é¡»åœ¨headä¸­æå‰å®šä¹‰ï¼Œç¡®ä¿å…¨å±€å¯ç”¨ï¼‰ -->
  <script>
    // å¯†ç æ˜¾ç¤ºåˆ‡æ¢å‡½æ•°ï¼ˆå…¨å±€å‡½æ•°ï¼Œå¿…é¡»åœ¨headä¸­å®šä¹‰ï¼‰
    window.togglePasswordVisibility = function() {
      console.log('ğŸ”„ togglePasswordVisibility è¢«è°ƒç”¨');
      const passwordInput = document.getElementById('password');
      const toggleBtn = document.getElementById('togglePasswordBtn');
      
      if (!passwordInput) {
        console.error('âŒ å¯†ç è¾“å…¥æ¡†æœªæ‰¾åˆ°');
        alert('å¯†ç è¾“å…¥æ¡†æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢');
        return false;
      }
      
      if (!toggleBtn) {
        console.error('âŒ å¯†ç æ˜¾ç¤ºæŒ‰é’®æœªæ‰¾åˆ°');
        alert('å¯†ç æ˜¾ç¤ºæŒ‰é’®æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢');
        return false;
      }
      
      try {
        const currentType = passwordInput.getAttribute('type') || passwordInput.type || 'password';
        const newType = currentType === 'password' ? 'text' : 'password';
        
        console.log('ğŸ”„ åˆ‡æ¢å¯†ç æ˜¾ç¤º:', { currentType, newType });
        
        // ä½¿ç”¨setAttributeå’Œç›´æ¥è®¾ç½®typeå±æ€§ï¼Œç¡®ä¿å…¼å®¹æ€§
        passwordInput.setAttribute('type', newType);
        passwordInput.type = newType;
        
        // æ›´æ–°æŒ‰é’®å›¾æ ‡å’Œæç¤º
        if (newType === 'text') {
          toggleBtn.textContent = 'ğŸ™ˆ';
          toggleBtn.title = 'éšè—å¯†ç ';
          toggleBtn.setAttribute('aria-label', 'éšè—å¯†ç ');
        } else {
          toggleBtn.textContent = 'ğŸ‘ï¸';
          toggleBtn.title = 'æ˜¾ç¤ºå¯†ç ';
          toggleBtn.setAttribute('aria-label', 'æ˜¾ç¤ºå¯†ç ');
        }
        
        // èšç„¦åˆ°è¾“å…¥æ¡†
        setTimeout(() => {
          passwordInput.focus();
        }, 10);
        
        console.log('âœ… å¯†ç æ˜¾ç¤ºçŠ¶æ€å·²åˆ‡æ¢:', newType);
        return true;
      } catch (error) {
        console.error('âŒ åˆ‡æ¢å¯†ç æ˜¾ç¤ºçŠ¶æ€å¤±è´¥:', error);
        alert('åˆ‡æ¢å¤±è´¥: ' + error.message);
        return false;
      }
    };
    console.log('âœ… togglePasswordVisibility å‡½æ•°å·²åœ¨headä¸­å®šä¹‰');
  </script>
  <style>
    /* éšè—å¯èƒ½æ„å¤–æ˜¾ç¤ºçš„ä»£ç å’Œscriptæ ‡ç­¾å†…å®¹ */
    script {
      display: none !important;
      visibility: hidden !important;
    }
    
    /* ç¡®ä¿bodyå†…çš„æ‰€æœ‰å†…å®¹éƒ½è¢«æ­£ç¡®éšè—ï¼ˆé™¤äº†é¢„æœŸçš„å…ƒç´ ï¼‰ */
    body > script {
      display: none !important;
    }
    
    /* ==========================================
       ğŸ¨ CSS å˜é‡ - è®¾è®¡ç³»ç»Ÿï¼ˆä¸ä¸»ç«™ä¸€è‡´ï¼‰
       ========================================== */
    :root {
      /* ä¸»è‰²è°ƒ */
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1d4ed8;
      --primary-50: #eff6ff;
      --primary-100: #dbeafe;
      --primary-200: #bfdbfe;
      
      /* å¼ºè°ƒè‰² */
      --accent: #8b5cf6;
      --accent-light: #a78bfa;
      
      /* æˆåŠŸ/è­¦å‘Š/é”™è¯¯ */
      --success: #10b981;
      --success-light: #d1fae5;
      --warning: #f59e0b;
      --warning-light: #fef3c7;
      --danger: #ef4444;
      --danger-light: #fee2e2;
      
      /* ä¸­æ€§è‰² */
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      
      /* èƒŒæ™¯è‰² */
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f1f5f9;
      
      /* æ–‡å­—é¢œè‰² */
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      
      /* è¾¹æ¡† */
      --border-light: #e2e8f0;
      --border-medium: #cbd5e1;
      
      /* é˜´å½± */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --shadow-glow: 0 0 20px rgba(37, 99, 235, 0.3);
      
      /* åœ†è§’ */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      
      /* è¿‡æ¸¡ */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
      
      /* é¡¶æ é«˜åº¦ */
      --header-height: 68px;
      --sidebar-width: 260px;
    }
    
    /* æ·±è‰²æ¨¡å¼å˜é‡ */
    [data-theme="dark"] {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-light: #334155;
      --border-medium: #475569;
      --gray-50: #1e293b;
      --gray-100: #334155;
      --gray-200: #475569;
    }
    
    /* ==========================================
       ğŸ”§ åŸºç¡€é‡ç½®ä¸é€šç”¨æ ·å¼
       ========================================== */
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    html {
      scroll-behavior: smooth;
    }
    
    body { 
      font-family: 'Inter', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* æ»šåŠ¨æ¡ç¾åŒ– */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--gray-100);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-400);
    }
    
    /* ==========================================
       ğŸ” é¡¶éƒ¨å¯¼èˆªæ ï¼ˆä¸ä¸»ç«™ä¸€è‡´ï¼‰
       ========================================== */
    .top-header { 
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      color: #fff; 
      padding: 0 28px; 
      height: var(--header-height); 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      z-index: 1000;
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .top-header h1 { 
      margin: 0; 
      font-size: 20px; 
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(90deg, #fff 0%, #a5b4fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .top-header h1::before {
      content: 'âš™ï¸';
      font-size: 24px;
      -webkit-text-fill-color: initial;
    }
    .top-header-actions { 
      display: flex; 
      align-items: center; 
      gap: 14px; 
    }
    
    /* ç§»åŠ¨ç«¯èœå•æŒ‰é’® */
    .mobile-menu-btn {
      display: none;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      transition: all var(--transition-fast);
      backdrop-filter: blur(10px);
    }
    .mobile-menu-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    /* ä¾§è¾¹æ é®ç½©å±‚ */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 998;
      opacity: 0;
      transition: opacity var(--transition-normal);
    }
    .sidebar-overlay.active {
      display: block;
      opacity: 1;
    }
    
    /* ==========================================
       ğŸ“± å·¦ä¾§èœå•ï¼ˆä¸ä¸»ç«™ä¸€è‡´ï¼‰
       ========================================== */
    .sidebar { 
      width: var(--sidebar-width); 
      background: var(--bg-secondary);
      position: fixed; 
      top: var(--header-height); 
      left: 0; 
      bottom: 0; 
      box-shadow: var(--shadow-lg);
      overflow-y: auto; 
      z-index: 999;
      border-right: 1px solid var(--border-light);
    }
    .sidebar-menu { 
      padding: 20px 12px;
    }
    .sidebar-item { 
      display: flex; 
      align-items: center; 
      padding: 14px 18px; 
      color: var(--text-secondary); 
      cursor: pointer; 
      transition: all var(--transition-fast);
      border-radius: var(--radius-md);
      margin-bottom: 4px;
      font-weight: 500;
      font-size: 14px;
    }
    .sidebar-item:hover { 
      background: var(--primary-50);
      color: var(--primary);
      transform: translateX(4px);
    }
    .sidebar-item.active { 
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: #fff;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    .sidebar-item-icon { 
      margin-right: 14px; 
      font-size: 18px;
      width: 24px;
      text-align: center;
    }
    
    /* ==========================================
       ğŸ“„ ä¸»å†…å®¹åŒº
       ========================================== */
    .main-content { 
      margin-left: var(--sidebar-width); 
      margin-top: var(--header-height); 
      padding: 28px; 
      min-height: calc(100vh - var(--header-height));
      background: var(--bg-primary);
    }
    .content-wrapper { 
      max-width: 1600px; 
      margin: 0 auto;
    }
    
    /* ==========================================
       ğŸƒ å¡ç‰‡æ ·å¼ï¼ˆä¸ä¸»ç«™ä¸€è‡´ï¼‰
       ========================================== */
    .card { 
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: 28px;
      margin-bottom: 24px;
      border: 1px solid var(--border-light);
      transition: all var(--transition-normal);
    }
    .card:hover {
      box-shadow: var(--shadow-lg);
    }
    .card-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-light);
    }
    .card-header h2 { 
      margin: 0; 
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* ==========================================
       ğŸ”˜ æŒ‰é’®ç³»ç»Ÿï¼ˆä¸ä¸»ç«™ä¸€è‡´ï¼‰
       ========================================== */
    .btn { 
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all var(--transition-fast);
      gap: 6px;
      white-space: nowrap;
    }
    .btn:active {
      transform: scale(0.97);
    }
    .btn-primary { 
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(37, 99, 235, 0.35);
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.45);
      transform: translateY(-2px);
    }
    .btn-outline { 
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
    }
    .btn-outline:hover {
      background: var(--primary-50);
      border-color: var(--primary-dark);
    }
    .btn-danger { 
      background: linear-gradient(135deg, var(--danger) 0%, #f87171 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(239, 68, 68, 0.35);
    }
    .btn-danger:hover {
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.45);
      transform: translateY(-2px);
    }
    .btn-ghost { 
      background: transparent;
      color: var(--text-secondary);
    }
    .btn-ghost:hover {
      background: var(--gray-100);
      color: var(--text-primary);
    }
    .btn-sm { 
      padding: 6px 12px;
      font-size: 13px;
      border-radius: var(--radius-sm);
    }
    
    /* ==========================================
       ğŸ“ è¡¨å•æ ·å¼ï¼ˆä¸ä¸»ç«™ä¸€è‡´ï¼‰
       ========================================== */
    .form-group { 
      display: flex;
      flex-direction: column;
      margin-bottom: 16px;
    }
    
    .form-section {
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border-light);
    }
    
    .form-section:last-child {
      border-bottom: none;
    }
    
    .form-hint {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    .form-group label { 
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }
    .form-group label .required { 
      color: var(--danger);
      margin-left: 4px;
    }
    .form-group input[type="text"],
    .form-group input[type="password"],
    .form-group input[type="email"],
    .form-group textarea {
      padding: 12px 14px;
      border-radius: var(--radius-md);
      border: 2px solid var(--border-light);
      font-size: 14px;
      outline: none;
      transition: all var(--transition-fast);
      background: var(--bg-secondary);
      color: var(--text-primary);
      width: 100%;
    }
    
    /* å¯†ç æ˜¾ç¤ºæŒ‰é’®æ ·å¼ */
    .form-group button[type="button"][id*="Password"],
    .form-group .toggle-password-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      color: var(--gray-500);
      font-size: 18px;
      line-height: 1;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: color var(--transition-fast);
    }
    
    .form-group button[type="button"][id*="Password"]:hover,
    .form-group .toggle-password-btn:hover {
      color: var(--primary);
    }
    .form-group input:focus,
    .form-group textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }
    .form-group input::placeholder,
    .form-group textarea::placeholder {
      color: var(--text-muted);
    }
    
    /* ==========================================
       ğŸ” ç™»å½•é¡µé¢
       ========================================== */
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      background: var(--bg-primary);
    }
    
    .login-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-light);
    }
    
    .login-title {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .login-title h1 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    .login-title p {
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    .error-message {
      margin-top: 16px;
      padding: 12px;
      background: var(--danger-light);
      color: #b91c1c;
      border-radius: var(--radius-md);
      font-size: 14px;
      display: none;
    }
    
    [data-theme="dark"] .error-message {
      background: #7f1d1d;
      color: #fca5a5;
    }
    
    /* ==========================================
       ğŸ“Š è¡¨æ ¼æ ·å¼
       ========================================== */
    table { 
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td { 
      padding: 14px 12px;
      border-bottom: 1px solid var(--border-light);
      text-align: left;
    }
    th { 
      background: var(--gray-50);
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 13px;
    }
    tr:hover { 
      background: var(--primary-50);
    }
    .muted { 
      color: var(--text-muted);
      font-size: 13px;
    }
    
    /* ==========================================
       ğŸ·ï¸ æ ‡ç­¾å’Œå¾½ç« 
       ========================================== */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-active {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #047857;
    }
    
    .status-draft {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
    }
    
    [data-theme="dark"] .status-active {
      background: #064e3b;
      color: #6ee7b7;
    }
    
    [data-theme="dark"] .status-draft {
      background: #78350f;
      color: #fcd34d;
    }
    
    /* ==========================================
       ğŸ“¦ å…¬å‘Šé¡¹æ ·å¼
       ========================================== */
    .announcement-item {
      padding: 20px;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      margin-bottom: 16px;
      background: var(--bg-secondary);
      transition: all var(--transition-fast);
    }
    
    .announcement-item:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--primary-200);
    }
    
    .announcement-content {
      margin-bottom: 12px;
      line-height: 1.6;
      color: var(--text-primary);
      max-height: 120px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      word-break: break-word;
      white-space: pre-wrap;
      cursor: pointer;
      transition: all 0.2s;
    }
    .announcement-content:hover {
      color: var(--primary);
    }
    .announcement-content.expanded {
      max-height: none;
      -webkit-line-clamp: unset;
    }
    .announcement-view-full {
      color: var(--primary);
      font-size: 12px;
      cursor: pointer;
      margin-top: 8px;
      display: inline-block;
      text-decoration: underline;
    }
    .announcement-view-full:hover {
      color: var(--primary-dark);
    }
    
    .announcement-meta {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }
    
    .announcement-actions {
      display: flex;
      gap: 8px;
    }
    
    /* ==========================================
       ğŸ“œ å†å²å…¬å‘Šæ ·å¼
       ========================================== */
    .announcement-history-item {
      transition: all var(--transition-fast);
    }
    
    .announcement-history-item:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--primary-200) !important;
    }
    
    .history-content {
      font-size: 14px;
    }
    
    /* ==========================================
       ğŸªŸ æ¨¡æ€æ¡†æ ·å¼
       ========================================== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: 28px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-light);
    }
    
    .modal-header h3 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }
    
    /* ==========================================
       âš™ï¸ ç³»ç»Ÿè®¾ç½®æ ·å¼
       ========================================== */
    .settings-tab-btn {
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all var(--transition-fast);
      margin-bottom: -2px;
    }
    .settings-tab-btn:hover {
      color: var(--primary);
      background: var(--primary-50);
    }
    .settings-tab-btn.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      font-weight: 600;
    }
    .settings-panel {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .form-text {
      display: block;
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .alert {
      padding: 16px;
      border-radius: var(--radius-md);
      margin-bottom: 16px;
    }
    .alert-info {
      background: var(--primary-50);
      border: 1px solid var(--primary-200);
      color: var(--primary-dark);
    }
    .alert-warning {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      color: #92400e;
    }
    
    /* å…¬å‘Šæ¨¡æ€æ¡†æ ·å¼ï¼ˆç”¨äºç”¨æˆ·ä¿¡æ¯å’Œè®¾ç½®æ¨¡æ€æ¡†ï¼‰ */
    .announcement-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    .announcement-modal.active {
      display: flex;
    }
    .announcement-modal-content {
      background: #fff;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
    }
    .announcement-modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .announcement-modal-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .announcement-modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .announcement-modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    .announcement-modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }
    
    /* ç”¨æˆ·å¤´åƒå’Œè®¾ç½®æŒ‰é’®æ ·å¼ */
    #btnUserAvatar, #btnSettings {
      transition: all 0.2s ease;
    }
    #btnUserAvatar:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(102,126,234,0.4) !important;
    }
    #btnSettings:hover {
      background: rgba(255,255,255,0.2) !important;
      transform: scale(1.05);
    }
    /* æŒ‰é’®å†…æ–‡å­—æ ·å¼ */
    #btnUserAvatar span, #btnSettings span {
      display: inline-flex;
      align-items: center;
    }
    
    /* ==========================================
       ğŸŒ™ æ·±è‰²æ¨¡å¼æ ·å¼
       ========================================== */
    [data-theme="dark"] .top-header {
      background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #020617 100%);
      border-bottom-color: rgba(255,255,255,0.05);
    }
    
    [data-theme="dark"] .sidebar {
      background: #1e293b;
      border-right-color: #334155;
    }
    
    [data-theme="dark"] .sidebar-item:hover {
      background: #334155;
    }
    
    [data-theme="dark"] .card {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%);
      border-color: #334155;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    [data-theme="dark"] .card:hover {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }
    
    [data-theme="dark"] table th {
      background: #334155;
    }
    
    [data-theme="dark"] table tr:hover {
      background: #334155;
    }
    
    [data-theme="dark"] .announcement-item {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%);
      border-color: #334155;
    }
    
    [data-theme="dark"] .modal-content {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%);
      border: 1px solid #334155;
    }
    
    [data-theme="dark"] #passwordChangeSuccess {
      background: #064e3b !important;
      color: #6ee7b7 !important;
    }
    
    /* ç”¨æˆ·ä¿¡æ¯å’Œè®¾ç½®æ¨¡æ€æ¡†æš—è‰²æ¨¡å¼ */
    [data-theme="dark"] #userInfoModal .announcement-modal-content,
    [data-theme="dark"] #settingsModal .announcement-modal-content {
      background: #1e293b !important;
      color: #f1f5f9 !important;
    }
    [data-theme="dark"] #userInfoModal .announcement-modal-body,
    [data-theme="dark"] #settingsModal .announcement-modal-body {
      color: #f1f5f9 !important;
    }
    [data-theme="dark"] #userInfoModal h4,
    [data-theme="dark"] #settingsModal h4 {
      color: #f1f5f9 !important;
      border-bottom-color: #475569 !important;
    }
    [data-theme="dark"] #userInfoModal .announcement-modal-body > div > div,
    [data-theme="dark"] #settingsModal .announcement-modal-body > div > div {
      border-bottom-color: #334155 !important;
    }
    [data-theme="dark"] #userInfoModal .announcement-modal-body span,
    [data-theme="dark"] #settingsModal .announcement-modal-body span {
      color: #94a3b8 !important;
    }
    [data-theme="dark"] #userInfoModal .announcement-modal-body p,
    [data-theme="dark"] #settingsModal .announcement-modal-body p {
      color: #cbd5e1 !important;
    }
    [data-theme="dark"] #settingsModal .announcement-modal-body > div > div[style*="background"] {
      background: #0f172a !important;
    }
    
    /* è®¾ç½®æ¨¡æ€æ¡†æŒ‰é’®æ‚¬åœæ•ˆæœ */
    #settingsModal .btn-outline:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] #settingsModal .btn-outline {
      background: #1e293b !important;
      border-color: #334155 !important;
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] #settingsModal .btn-outline:hover {
      background: #334155 !important;
      border-color: #475569 !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    [data-theme="dark"] #settingsModal h4 {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] #settingsModal div[style*="color:#1e293b"] {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] #settingsModal div[style*="color:#64748b"] {
      color: #94a3b8 !important;
    }
    
    [data-theme="dark"] #settingsModal div[style*="background:linear-gradient"][style*="#f8fafc"] {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%) !important;
      border-color: #334155 !important;
    }
    
    [data-theme="dark"] #settingsModal div[style*="background:linear-gradient"][style*="#f0f9ff"] {
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%) !important;
      border-color: #3b82f6 !important;
    }
    
    [data-theme="dark"] #settingsModal div[style*="border-top"] {
      border-top-color: #334155 !important;
    }
    
    /* ==========================================
       ğŸ  ä¸»ç«™åŠŸèƒ½æ¨¡å—æ ·å¼
       ========================================== */
    
    /* é¦–é¡µæ ·å¼ */
    .home-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .home-overview {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 50%, #1e3a5f 100%);
      border-radius: 16px;
      padding: 24px 32px;
      color: #fff;
      box-shadow: 0 8px 32px rgba(30, 58, 95, 0.3);
    }
    
    .home-overview-left {
      display: flex;
      align-items: center;
      gap: 32px;
      flex: 1;
      margin-right: 32px;
    }
    
    .home-date {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .home-date-day {
      font-size: 56px;
      font-weight: 800;
      line-height: 1;
      background: linear-gradient(180deg, #fff 0%, #a0c4ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .home-date-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .home-date-weekday {
      font-size: 18px;
      font-weight: 600;
    }
    
    .home-date-full {
      font-size: 14px;
      opacity: 0.8;
    }
    
    .home-weather {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }
    
    .home-announcement-bubble {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      max-width: 300px;
      overflow: hidden;
    }
    
    .home-announcement-icon {
      font-size: 24px;
      flex-shrink: 0;
    }
    
    .home-announcement-content {
      flex: 1;
      min-width: 0;
    }
    
    .home-announcement-text {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .home-overview-stats {
      display: flex;
      gap: 24px;
    }
    
    .home-stat-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }
    
    .home-stat-icon {
      font-size: 24px;
    }
    
    .home-stat-content {
      display: flex;
      flex-direction: column;
    }
    
    .home-stat-number {
      font-size: 24px;
      font-weight: 700;
    }
    
    .home-stat-label {
      font-size: 12px;
      opacity: 0.8;
    }
    
    .home-announcement {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      background: linear-gradient(90deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 12px;
      border-left: 4px solid #f59e0b;
    }
    
    .announcement-icon {
      font-size: 20px;
    }
    
    .announcement-text {
      flex: 1;
      font-size: 14px;
      color: #92400e;
      font-weight: 500;
    }
    
    .home-content {
      display: grid;
      grid-template-columns: 1fr 1.2fr 320px;
      gap: 20px;
      min-height: 600px;
    }
    
    .home-column {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .home-column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .home-column-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }
    
    .home-column-footer {
      padding: 16px;
      text-align: center;
      border-top: 1px solid #f0f0f0;
    }
    
    .news-filter {
      display: flex;
      gap: 4px;
    }
    
    .news-filter-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 12px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .news-filter-btn:hover {
      background: #f3f4f6;
      color: #1f2937;
    }
    
    .news-filter-btn.active {
      background: #2b5cff;
      color: #fff;
    }
    
    .news-region-tabs {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #f9fafb;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .news-region-tab {
      flex: 1;
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }
    
    .news-region-tab:hover {
      background: #f3f4f6;
      color: #1f2937;
    }
    
    .news-region-tab.active {
      background: #2563eb;
      color: #fff;
    }
    
    .home-news-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .event-region-tabs {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #f9fafb;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .event-region-tab {
      flex: 1;
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }
    
    .event-region-tab:hover {
      background: #f3f4f6;
      color: #1f2937;
    }
    
    .event-region-tab.active {
      background: #2563eb;
      color: #fff;
    }
    
    .event-tabs {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #f9fafb;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .event-tab-btn {
      flex: 1;
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }
    
    .event-tab-btn:hover {
      background: #f3f4f6;
      color: #1f2937;
    }
    
    .event-tab-btn.active {
      background: #2563eb;
      color: #fff;
    }
    
    .home-events-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .home-sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
      padding: 16px;
    }
    
    .home-widget {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .home-widget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .home-widget-header h4 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
    }
    
    .home-widget-content {
      font-size: 13px;
      color: #4b5563;
    }
    
    .subscription-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .subscription-tag {
      padding: 6px 12px;
      background: #f3f4f6;
      border-radius: 20px;
      font-size: 12px;
      color: #4b5563;
    }
    
    .subscription-tag.add-tag {
      background: #e0f2fe;
      color: #0369a1;
      cursor: pointer;
    }
    
    .quick-links {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .quick-link-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .quick-link-btn:hover {
      background: #f3f4f6;
      border-color: #2563eb;
      transform: translateY(-2px);
    }
    
    .quick-link-btn span:first-child {
      font-size: 24px;
    }
    
    .quick-link-btn span:last-child {
      font-size: 12px;
      color: #4b5563;
      font-weight: 500;
    }
    
    /* æ•°æ®æ¦‚è§ˆç»Ÿè®¡å¡ç‰‡ */
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 20px;
      margin-top: 8px;
    }
    
    @media (max-width: 1200px) {
      .stats-cards {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 800px) {
      .stats-cards {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    .stat-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-radius: 12px;
      padding: 24px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e5e7eb;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #2b5cff 0%, #6366f1 100%);
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    
    .stat-card-label {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 12px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .stat-card-number {
      font-size: 36px;
      font-weight: 700;
      color: #1f2937;
      line-height: 1.2;
      letter-spacing: -0.5px;
    }
    
    .stat-card:nth-child(1)::before {
      background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
    }
    
    .stat-card:nth-child(2)::before {
      background: linear-gradient(90deg, #10b981 0%, #059669 100%);
    }
    
    .stat-card:nth-child(3)::before {
      background: linear-gradient(90deg, #6b7280 0%, #4b5563 100%);
    }
    
    .stat-card:nth-child(4)::before {
      background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
    }
    
    .stat-card:nth-child(5)::before {
      background: linear-gradient(90deg, #8b5cf6 0%, #7c3aed 100%);
    }
    
    /* è§†å›¾åˆ‡æ¢å™¨ */
    .view-switcher {
      display: flex;
      gap: 4px;
      background: var(--gray-100);
      padding: 5px;
      border-radius: var(--radius-md);
    }
    
    .view-switch-btn {
      padding: 10px 20px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
    }
    
    .view-switch-btn:hover {
      background: rgba(255,255,255,0.7);
      color: var(--text-primary);
    }
    
    .view-switch-btn.active {
      background: var(--bg-secondary);
      color: var(--primary);
      font-weight: 600;
      box-shadow: var(--shadow-md);
    }
    
    /* æ¯”èµ›æ ‡ç­¾é¡µ */
    .race-tab-btn {
      padding: 10px 20px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    
    .race-tab-btn:hover {
      color: #2b5cff;
      background: #f0f7ff;
    }
    
    .race-tab-btn.active {
      color: #2b5cff;
      border-bottom-color: #2b5cff;
      font-weight: 600;
    }
    
    .race-tab-content {
      display: none;
      padding: 20px 0;
    }
    
    .race-tab-content.active {
      display: block;
    }
    
    /* è¡¨å•ç½‘æ ¼ */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px 28px;
      margin-top: 12px;
    }
    
    /* é¸½å­å¡ç‰‡è§†å›¾ */
    .pigeon-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 14px;
      margin-top: 16px;
      padding: 8px 0;
    }
    
    .pigeon-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-radius: 10px;
      padding: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .pigeon-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #2b5cff 0%, #6366f1 100%);
    }
    
    .pigeon-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 32px rgba(43,92,255,0.15);
      border-color: #2b5cff;
    }
    
    /* Excelå¯¼å…¥åŒºåŸŸ */
    .excel-import-zone {
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      background: #f9fafb;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .excel-import-zone:hover {
      border-color: #2563eb;
      background: #eff6ff;
    }
    
    .excel-import-zone.dragover {
      border-color: #2563eb;
      background: #dbeafe;
    }
    
    @media (max-width: 1200px) {
      .home-content {
        grid-template-columns: 1fr;
      }
      
      .stats-cards {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 800px) {
      .home-overview {
        flex-direction: column;
        gap: 16px;
      }
      
      .home-overview-stats {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .stats-cards {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* èµ„è®¯å¡ç‰‡æ ·å¼ */
    .news-card {
      padding: 16px;
      border-radius: 12px;
      background: #f9fafb;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid transparent;
    }
    
    .news-card:hover {
      background: #f0f7ff;
      border-color: #dbeafe;
      transform: translateX(4px);
    }
    
    .news-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    
    .news-card-title {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
      line-height: 1.4;
      flex: 1;
    }
    
    .news-card-time {
      font-size: 11px;
      color: #9ca3af;
      white-space: nowrap;
      margin-left: 12px;
    }
    
    .news-card-source {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    
    .news-card-update-time {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }
    
    .news-card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }
    
    .news-card-action-btn {
      flex: 1;
      padding: 6px 12px;
      border: 1px solid #d1d5db;
      background: #fff;
      color: #6b7280;
      font-size: 12px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .news-card-action-btn:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
      color: #1f2937;
    }
    
    .news-card-action-btn.primary {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }
    
    .news-card-action-btn.primary:hover {
      background: #1d4ed8;
      border-color: #1d4ed8;
    }
    
    .news-card-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    
    .news-tag {
      padding: 2px 8px;
      background: #e5e7eb;
      border-radius: 4px;
      font-size: 11px;
      color: #4b5563;
    }
    
    .news-tag.race {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .news-tag.breeding {
      background: #fce7f3;
      color: #be185d;
    }
    
    .news-tag.health {
      background: #d1fae5;
      color: #047857;
    }
    
    .news-tag.hot {
      background: #fee2e2;
      color: #b91c1c;
    }
    
    /* èµ„è®¯è¯¦æƒ…å¼¹çª—æ ·å¼ */
    .news-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .news-modal.active {
      display: flex;
    }
    
    .news-modal-content {
      background: var(--bg-secondary);
      border-radius: 16px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    .news-modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .news-modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }
    
    .news-modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--gray-100);
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      color: var(--text-secondary);
      transition: all 0.2s;
    }
    
    .news-modal-close:hover {
      background: var(--gray-200);
      color: var(--text-primary);
    }
    
    .news-modal-body {
      padding: 24px;
    }
    
    .news-modal-meta {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-light);
      flex-wrap: wrap;
    }
    
    .news-modal-meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .news-modal-content-text {
      font-size: 15px;
      line-height: 1.8;
      color: var(--text-primary);
      margin-bottom: 24px;
    }
    
    .news-modal-footer {
      padding: 20px 24px;
      border-top: 1px solid var(--border-light);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    /* èµ›äº‹å¡ç‰‡æ ·å¼ */
    .event-card {
      padding: 16px;
      border-radius: 12px;
      background: #fff;
      margin-bottom: 12px;
      border: 1px solid #e5e7eb;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .event-card:hover {
      border-color: #2b5cff;
      box-shadow: 0 4px 16px rgba(43,92,255,0.12);
      transform: translateY(-2px);
    }
    
    .event-card-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .event-card-status.ongoing {
      background: #d1fae5;
      color: #047857;
    }
    
    .event-card-status.ongoing::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #10b981;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    .event-card-status.upcoming {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .event-card-status.completed {
      background: #f3f4f6;
      color: #4b5563;
    }
    
    .event-card-title {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
    }
    
    .event-card-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 13px;
      color: #6b7280;
    }
    
    .event-card-info-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .event-card-progress {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #f0f0f0;
    }
    
    .event-progress-bar {
      height: 6px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 6px;
    }
    
    .event-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981 0%, #059669 100%);
      border-radius: 999px;
      transition: width 0.3s;
    }
    
    .event-progress-text {
      font-size: 12px;
      color: #6b7280;
    }
    /* ==========================================
       ğŸ•Šï¸ Evo æ™ºèƒ½åŠ©æ‰‹æ ·å¼
       ============================================ */
    
    /* Evo æµ®åŠ¨æŒ‰é’®å’Œå›¾æ ‡ */
    .evo-assistant {
      position: fixed !important;
      bottom: 80px !important;
      right: 20px !important;
      z-index: 99999 !important;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      pointer-events: auto !important;
      animation: evo-float 6s ease-in-out infinite;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    @keyframes evo-float {
      0%, 100% { transform: translateY(0px) translateX(0px); }
      25% { transform: translateY(-10px) translateX(5px); }
      50% { transform: translateY(-15px) translateX(0px); }
      75% { transform: translateY(-10px) translateX(-5px); }
    }

    .evo-icon-button {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 8px 30px rgba(102, 126, 234, 0.7), 
                  0 0 50px rgba(102, 126, 234, 0.5),
                  0 0 80px rgba(102, 126, 234, 0.3);
      cursor: pointer;
      display: flex !important;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
      visibility: visible !important;
      opacity: 1 !important;
      animation: evo-button-float 4s ease-in-out infinite;
      border: 3px solid rgba(255, 255, 255, 0.3);
    }

    @keyframes evo-button-float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      25% { transform: translateY(-8px) rotate(-3deg); }
      50% { transform: translateY(-12px) rotate(0deg); }
      75% { transform: translateY(-8px) rotate(3deg); }
    }

    .evo-icon-button:hover {
      transform: scale(1.15) translateY(-5px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.7), 
                  0 0 40px rgba(102, 126, 234, 0.4);
      animation-play-state: paused;
    }

    .evo-pigeon-icon {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .evo-icon {
      font-size: 40px;
      animation: evo-fly 2.5s ease-in-out infinite;
      display: block;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4)) 
              drop-shadow(0 0 20px rgba(102, 126, 234, 0.6));
      z-index: 1;
      position: relative;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    @keyframes evo-fly {
      0%, 100% { transform: translateY(0) rotate(0deg) scale(1); }
      15% { transform: translateY(-3px) rotate(-8deg) scale(1.05); }
      30% { transform: translateY(-6px) rotate(0deg) scale(1.1); }
      45% { transform: translateY(-3px) rotate(8deg) scale(1.05); }
      60% { transform: translateY(0) rotate(0deg) scale(1); }
      75% { transform: translateY(-2px) rotate(-4deg) scale(1.02); }
      90% { transform: translateY(0) rotate(0deg) scale(1); }
    }

    .evo-pulse {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: rgba(102, 126, 234, 0.3);
      animation: evo-pulse 2s ease-in-out infinite;
    }

    @keyframes evo-pulse {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.5); opacity: 0; }
    }

    /* Evo å¯¹è¯æ¡† */
    .evo-dialog {
      position: absolute;
      bottom: 70px;
      right: 90px;
      width: 320px;
      max-width: calc(90vw - 120px);
      max-height: 80vh;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: evo-dialog-appear 0.3s ease-out;
    }

    @keyframes evo-dialog-appear {
      from { opacity: 0; transform: translateX(20px) translateY(20px) scale(0.9); }
      to { opacity: 1; transform: translateX(0) translateY(0) scale(1); }
    }

    .evo-header {
      padding: 16px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .evo-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .evo-icon-large {
      font-size: 32px;
      animation: evo-fly 3s ease-in-out infinite;
    }

    .evo-title {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .evo-subtitle {
      margin: 2px 0 0 0;
      font-size: 12px;
      opacity: 0.9;
    }

    .evo-close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.3s;
    }

    .evo-close-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .evo-content {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .evo-tabs {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .evo-tab-headers {
      display: flex;
      border-bottom: 1px solid #e4e7ed;
      padding: 0 8px;
      background: #f5f7fa;
    }

    .evo-tab-header {
      padding: 8px 10px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
      font-size: 12px;
      color: #606266;
      white-space: nowrap;
      flex: 1;
      text-align: center;
    }

    .evo-tab-header.active {
      color: #667eea;
      border-bottom-color: #667eea;
      font-weight: 600;
    }

    .evo-tab-header:hover {
      color: #667eea;
    }

    .evo-tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: none;
    }

    .evo-tab-content.active {
      display: block;
    }

    .evo-chat-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      max-height: 500px;
    }

    .evo-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 0;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .evo-message {
      display: flex;
      gap: 12px;
      animation: evo-message-appear 0.3s ease-out;
    }

    .evo-message.user {
      flex-direction: row-reverse;
      align-items: flex-start;
    }

    @keyframes evo-message-appear {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .evo-message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #f5f7fa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .evo-message.user .evo-message-avatar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .evo-message-content {
      flex: 0 1 auto;
      max-width: 70%;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .evo-message-text {
      background: #f5f7fa;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .evo-message.user .evo-message-text {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .evo-message-time {
      font-size: 11px;
      color: #909399;
      margin-top: 4px;
    }

    .evo-typing-indicator {
      display: flex;
      gap: 4px;
      padding: 10px 14px;
    }

    .evo-typing-indicator span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #909399;
      animation: evo-typing 1.4s ease-in-out infinite;
    }

    .evo-typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .evo-typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes evo-typing {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
      30% { transform: translateY(-10px); opacity: 1; }
    }

    .evo-input-area {
      padding-top: 16px;
      border-top: 1px solid #e4e7ed;
    }

    .evo-input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .evo-input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #e4e7ed;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: all 0.3s;
    }

    .evo-input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    .evo-send-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .evo-send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .evo-quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .evo-quick-action-btn {
      padding: 4px 8px;
      background: #f5f7fa;
      border: 1px solid #e4e7ed;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .evo-quick-action-btn:hover {
      background: #e4e7ed;
      border-color: #667eea;
      color: #667eea;
    }

    .evo-analytics, .evo-recommendations, .evo-settings {
      max-height: 500px;
      overflow-y: auto;
    }

    .evo-analytics-card, .evo-recommendation-card {
      background: #f5f7fa;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 3px solid #667eea;
    }

    .evo-empty {
      text-align: center;
      padding: 40px 20px;
      color: #909399;
    }

    [data-theme="dark"] .evo-dialog {
      background: #1e293b !important;
    }

    [data-theme="dark"] .evo-tab-headers {
      background: #334155 !important;
      border-bottom-color: #475569 !important;
    }

    [data-theme="dark"] .evo-tab-header {
      color: #94a3b8 !important;
    }

    [data-theme="dark"] .evo-tab-header.active {
      color: #a78bfa !important;
      border-bottom-color: #a78bfa !important;
    }

    [data-theme="dark"] .evo-tab-content {
      background: #1e293b !important;
      color: #f1f5f9 !important;
    }

    [data-theme="dark"] .evo-message-text {
      background: #334155 !important;
      color: #f1f5f9 !important;
    }

    [data-theme="dark"] .evo-input {
      background: #334155 !important;
      border-color: #475569 !important;
      color: #f1f5f9 !important;
    }

    [data-theme="dark"] .evo-quick-action-btn {
      background: #334155 !important;
      border-color: #475569 !important;
      color: #f1f5f9 !important;
    }

    /* æ¬¢è¿æ¶ˆæ¯æ°”æ³¡å¼¹çª— */
    .evo-welcome-bubble {
      position: fixed;
      bottom: 160px;
      right: 100px;
      z-index: 99998;
      max-width: 280px;
      animation: evo-bubble-appear 0.3s ease-out;
      pointer-events: auto;
    }

    .evo-welcome-bubble-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.5;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4), 0 0 30px rgba(118, 75, 162, 0.3);
      position: relative;
      word-wrap: break-word;
      font-weight: 500;
      cursor: pointer;
    }

    .evo-welcome-bubble-content::after {
      content: '';
      position: absolute;
      bottom: -8px;
      right: 20px;
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid #764ba2;
    }

    @keyframes evo-bubble-appear {
      from {
        opacity: 0;
        transform: translateY(10px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes evo-bubble-disappear {
      from {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateY(-10px) scale(0.9);
      }
    }

    .evo-welcome-bubble.hiding {
      animation: evo-bubble-disappear 0.3s ease-out forwards;
    }

    [data-theme="dark"] .evo-welcome-bubble-content {
      background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%) !important;
      box-shadow: 0 4px 20px rgba(124, 58, 237, 0.5), 0 0 30px rgba(147, 51, 234, 0.4) !important;
    }

    [data-theme="dark"] .evo-welcome-bubble-content::after {
      border-top-color: #9333ea !important;
    }

    /* ==========================================
       ğŸ“± ç§»åŠ¨ç«¯å“åº”å¼ä¼˜åŒ–
       ========================================== */
    @media (max-width: 768px) {
      /* é¡¶éƒ¨å¯¼èˆªæ ä¼˜åŒ– */
      .top-header {
        padding: 0 12px;
        height: 60px;
        flex-wrap: nowrap;
      }
      .top-header h1 {
        font-size: 14px;
        flex: 1;
        min-width: 0;
      }
      .top-header h1::before {
        font-size: 18px;
      }
      .top-header-actions {
        gap: 6px;
        flex-wrap: nowrap;
        font-size: 12px;
      }
      .top-header-actions .btn {
        padding: 6px 10px;
        font-size: 11px;
      }
      .top-header-actions span {
        display: none;
      }
      
      /* æ˜¾ç¤ºç§»åŠ¨ç«¯èœå•æŒ‰é’® */
      .mobile-menu-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        order: -1;
        margin-right: 8px;
      }
      
      /* æ˜¾ç¤ºä¾§è¾¹æ é®ç½©å±‚ */
      .sidebar-overlay {
        display: block;
      }
      
      /* ä¾§è¾¹æ ç§»åŠ¨ç«¯ä¼˜åŒ– */
      .sidebar {
        transform: translateX(-100%);
        width: 280px;
        transition: transform var(--transition-normal);
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .sidebar-menu {
        padding: 16px 8px;
      }
      .sidebar-item {
        padding: 12px 14px;
        font-size: 13px;
        margin-bottom: 3px;
      }
      .sidebar-item-icon {
        font-size: 16px;
        margin-right: 10px;
        width: 20px;
      }
      
      /* ä¸»å†…å®¹åŒºä¼˜åŒ– */
      .main-content {
        margin-left: 0;
        padding: 12px;
        margin-top: 60px;
      }
      .content-wrapper {
        max-width: 100%;
      }
      
      /* å¡ç‰‡ä¼˜åŒ– */
      .card {
        padding: 16px;
        margin-bottom: 16px;
        border-radius: var(--radius-md);
      }
      .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
        padding-bottom: 16px;
        margin-bottom: 16px;
      }
      .card-header h2 {
        font-size: 18px;
        width: 100%;
      }
      
      /* è¡¨å•ä¼˜åŒ– */
      .form-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .form-group {
        margin-bottom: 16px;
      }
      .form-group label {
        font-size: 13px;
        margin-bottom: 6px;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        font-size: 14px;
        padding: 10px 12px;
      }
      
      /* æŒ‰é’®ä¼˜åŒ– */
      .btn {
        padding: 10px 16px;
        font-size: 13px;
      }
      .btn-sm {
        padding: 8px 12px;
        font-size: 12px;
      }
      
      /* ç»Ÿè®¡å¡ç‰‡ä¼˜åŒ– */
      .stats-cards {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .stat-card {
        padding: 16px;
      }
      .stat-card-label {
        font-size: 12px;
        margin-bottom: 8px;
      }
      .stat-card-number {
        font-size: 28px;
      }
      
      /* é¸½å­å¡ç‰‡ä¼˜åŒ– */
      .pigeon-cards {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .pigeon-card {
        padding: 12px;
      }
      .pigeon-card-name {
        font-size: 14px;
      }
      .pigeon-card-info-item {
        font-size: 11px;
        padding: 5px 6px;
      }
      
      /* è¡¨æ ¼ä¼˜åŒ– */
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      table {
        font-size: 12px;
        min-width: 600px;
      }
      table th,
      table td {
        padding: 8px 10px;
      }
      
      /* å­—æ®µè¡Œä¼˜åŒ– */
      .field-row {
        flex-direction: column;
        align-items: flex-start;
        padding: 12px;
      }
      .field-label {
        width: 100%;
        text-align: left;
        padding-right: 0;
        padding-bottom: 6px;
        border-right: none;
        border-bottom: 1px solid #f0f0f0;
        margin-bottom: 6px;
        font-size: 12px;
      }
      .field-value {
        padding-left: 0;
        width: 100%;
        font-size: 13px;
      }
      
      /* æ ‡ç­¾é¡µä¼˜åŒ– */
      .race-tab-btn {
        padding: 8px 12px;
        font-size: 12px;
        flex: 1;
        min-width: 0;
      }
      
      /* è§†å›¾åˆ‡æ¢å™¨ä¼˜åŒ– */
      .view-switcher {
        flex-wrap: wrap;
        gap: 4px;
      }
      .view-switch-btn {
        padding: 8px 12px;
        font-size: 12px;
        flex: 1;
        min-width: 0;
      }
      
      /* é¦–é¡µæ¦‚è§ˆä¼˜åŒ– */
      .home-overview {
        flex-direction: column;
        gap: 12px;
      }
      .home-overview-stats {
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
      }
      .home-content {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      /* Excelå¯¼å…¥åŒºåŸŸä¼˜åŒ– */
      .excel-import-zone {
        padding: 24px 16px;
      }
      
      /* èµ„è®¯å¡ç‰‡ä¼˜åŒ– */
      .news-card {
        padding: 12px;
      }
      
      /* ç™»å½•é¡µé¢ä¼˜åŒ– */
      .login-container {
        padding: 16px;
      }
      .login-card {
        padding: 24px 20px;
        max-width: 100%;
      }
      .login-title h1 {
        font-size: 20px;
      }
      
      /* EvoåŠ©æ‰‹ç§»åŠ¨ç«¯ä¼˜åŒ– */
      .evo-assistant {
        bottom: 100px;
        right: 15px;
      }
      
      .evo-dialog {
        width: calc(100vw - 30px);
        max-width: none;
        bottom: 70px;
        right: 0;
        max-height: calc(100vh - 100px);
      }
      
      .evo-icon-button {
        width: 60px;
        height: 60px;
      }
      
      .evo-icon {
        font-size: 32px;
      }
    }
    
    /* è¶…å°å±å¹•ä¼˜åŒ–ï¼ˆå°äº480pxï¼‰ */
    @media (max-width: 480px) {
      .top-header h1 {
        font-size: 12px;
      }
      .top-header h1::before {
        font-size: 16px;
      }
      .main-content {
        padding: 8px;
      }
      .card {
        padding: 12px;
      }
      .stat-card-number {
        font-size: 24px;
      }
      .btn {
        padding: 10px 12px;
        font-size: 12px;
      }
      .login-card {
        padding: 20px 16px;
      }
      .login-title h1 {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <!-- ç™»å½•é¡µé¢ -->
  <div id="loginPage" class="login-container">
    <div class="login-card">
      <div class="login-title">
        <h1>æ™ºé¸½ï½œPigeonAIâ€”â€”æ™ºèƒ½ç®¡ç†ç³»ç»Ÿ</h1>
        <p>ç®¡ç†å‘˜ç™»å½•</p>
        <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">é»˜è®¤è´¦æˆ·ï¼šadmin / admin123</p>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label>ç”¨æˆ·åæˆ–é‚®ç®±</label>
          <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±" required />
        </div>
        <div class="form-group">
          <label>å¯†ç </label>
          <div style="position:relative;">
            <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç " required style="padding-right:45px;" />
            <button type="button" id="togglePasswordBtn" onclick="togglePasswordVisibility()" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:4px;color:#6b7280;font-size:18px;line-height:1;width:32px;height:32px;display:flex;align-items:center;justify-content:center;" title="æ˜¾ç¤ºå¯†ç ">ğŸ‘ï¸</button>
          </div>
        </div>
        <div class="form-group" style="margin-bottom: 16px;">
          <label style="display: flex; align-items: center; cursor: pointer; font-size: 14px; font-weight: normal;">
            <input type="checkbox" id="useLocalAuth" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;" />
            <span>ä½¿ç”¨æœ¬åœ°éªŒè¯ï¼ˆæ— éœ€åç«¯æœåŠ¡ï¼‰</span>
          </label>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">ç™»å½•</button>
        <div id="loginError" class="error-message"></div>
      </form>
    </div>
  </div>
  
  <!-- ç®¡ç†ç•Œé¢ -->
  <div id="adminPage" style="display:none;">
    <!-- é¡¶éƒ¨å¯¼èˆªæ ï¼ˆä¸ä¸»ç«™ä¸€è‡´ï¼‰ -->
    <div class="top-header">
      <h1>æ™ºé¸½ï½œPigeonAIâ€”â€”æ™ºèƒ½ç®¡ç†ç³»ç»Ÿ</h1>
      <div class="top-header-actions">
        <span id="adminUserName" style="color: rgba(255,255,255,0.8); font-size: 14px;"></span>
        <button class="btn btn-sm" id="themeToggle" style="background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.15);">ğŸŒ™ æš—è‰²æ¨¡å¼</button>
        <!-- ç”¨æˆ·å¤´åƒ -->
        <button class="btn btn-sm" id="btnUserAvatar" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;font-weight:600;box-shadow:0 4px 12px rgba(102,126,234,0.3);padding:8px 16px;border-radius:20px;display:flex;align-items:center;justify-content:center;gap:6px;font-size:14px;cursor:pointer;white-space:nowrap;" title="æŸ¥çœ‹è´¦æˆ·ä¿¡æ¯">
          <span>ğŸ‘¤</span>
          <span>è´¦æˆ·</span>
        </button>
        <!-- è®¾ç½®æŒ‰é’® -->
        <button class="btn btn-sm" id="btnSettings" style="background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.15);backdrop-filter:blur(10px);padding:8px 16px;border-radius:8px;display:flex;align-items:center;justify-content:center;gap:6px;font-size:14px;cursor:pointer;white-space:nowrap;" title="ç³»ç»Ÿè®¾ç½®">
          <span>âš™ï¸</span>
          <span>è®¾ç½®</span>
        </button>
      </div>
    </div>
    
    <!-- å·¦ä¾§èœå• -->
    <div class="sidebar">
      <div class="sidebar-menu">
        <!-- ä¸»ç«™åŠŸèƒ½æ¨¡å— -->
        <div class="sidebar-item" data-tab="homeView">
          <span class="sidebar-item-icon">ğŸ </span>
          <span>é¦–é¡µ</span>
        </div>
        <div class="sidebar-item" data-tab="dashboardView">
          <span class="sidebar-item-icon">ğŸ“Š</span>
          <span>æ•°æ®æ¦‚è§ˆ</span>
        </div>
        <div class="sidebar-item" data-tab="listView">
          <span class="sidebar-item-icon">ğŸ“‹</span>
          <span>é¸½å­ç®¡ç†</span>
        </div>
        <div class="sidebar-item" data-tab="pedigreeView">
          <span class="sidebar-item-icon">ğŸ§¬</span>
          <span>è¡€ç»Ÿå…³ç³»</span>
        </div>
        <div class="sidebar-item" data-tab="statsView">
          <span class="sidebar-item-icon">ğŸ“ˆ</span>
          <span>ç»Ÿè®¡åˆ†æ</span>
        </div>
        <div class="sidebar-item" data-tab="raceView">
          <span class="sidebar-item-icon">ğŸ†</span>
          <span>æ¯”èµ›ä¸æˆç»©ç®¡ç†</span>
        </div>
        <div class="sidebar-item" data-tab="breedingView">
          <span class="sidebar-item-icon">ğŸ§¬</span>
          <span>ç¹è‚²ä¸é…å¯¹</span>
        </div>
        <div class="sidebar-item" data-tab="healthView">
          <span class="sidebar-item-icon">ğŸ©º</span>
          <span>å¥åº·ç®¡ç†</span>
        </div>
        <div class="sidebar-item" data-tab="analysisView">
          <span class="sidebar-item-icon">ğŸ§ </span>
          <span>æ™ºèƒ½åˆ†æä¸­å¿ƒ</span>
        </div>
        <div class="sidebar-item" data-tab="trainingView">
          <span class="sidebar-item-icon">ğŸƒ</span>
          <span>è®­ç»ƒæ¨¡å—</span>
        </div>
        <div class="sidebar-item" data-tab="qualificationView">
          <span class="sidebar-item-icon">ğŸ¯</span>
          <span>èƒ½åŠ›ç»¼åˆåˆ†æ</span>
        </div>
        
        <!-- åˆ†éš”çº¿ -->
        <div style="height: 1px; background: var(--border-light); margin: 12px 0;"></div>
        
        <!-- æ™ºèƒ½ç®¡ç†åŠŸèƒ½ -->
        <div class="sidebar-item active" data-tab="announcements">
          <span class="sidebar-item-icon">ğŸ“¢</span>
          <span>å…¬å‘Šç®¡ç†</span>
        </div>
        <div class="sidebar-item" data-tab="users">
          <span class="sidebar-item-icon">ğŸ‘¥</span>
          <span>ç”¨æˆ·ç®¡ç†</span>
        </div>
        <div class="sidebar-item" data-tab="settings">
          <span class="sidebar-item-icon">âš™ï¸</span>
          <span>ç³»ç»Ÿè®¾ç½®</span>
        </div>
        <div class="sidebar-item" data-tab="feedbackView">
          <span class="sidebar-item-icon">ğŸ’¬</span>
          <span>æ„è§ä¸åé¦ˆ</span>
        </div>
        <div class="sidebar-item" data-tab="evoSettings">
          <span class="sidebar-item-icon">ğŸ•Šï¸</span>
          <span>Evoè®¾ç½®</span>
        </div>
        <div class="sidebar-item" data-tab="coreAdminView">
          <span class="sidebar-item-icon">ğŸ¤–</span>
          <span>ä¸­æ¢ç®¡å®¶</span>
        </div>
        <div class="sidebar-item" data-tab="upgradeView">
          <span class="sidebar-item-icon">ğŸš€</span>
          <span>ç³»ç»Ÿå‡çº§</span>
        </div>
      </div>
    </div>
    
    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
      <div class="content-wrapper">
        <!-- ä¸»ç«™åŠŸèƒ½æ¨¡å— -->
        <!-- é¦–é¡µ -->
        <section id="homeView" class="home-section" style="display:none;">
          <!-- é¡¶éƒ¨ä»Šæ—¥æ¦‚è§ˆ -->
          <div class="home-overview">
            <div class="home-overview-left">
              <div class="home-date">
                <span class="home-date-day" id="homeDay">19</span>
                <div class="home-date-info">
                  <span class="home-date-weekday" id="homeWeekday">æ˜ŸæœŸäº”</span>
                  <span class="home-date-full" id="homeDateFull">2025å¹´12æœˆ</span>
                </div>
              </div>
              <div class="home-weather" id="homeWeather">
                <span style="font-size:28px;">â˜€ï¸</span>
                <div>
                  <div style="font-weight:600;">æ™´æœ—</div>
                  <div style="font-size:12px;color:#6b7280;">é€‚åˆæ”¾é£</div>
                </div>
              </div>
              <!-- å…¬å‘Šæ  -->
              <div class="home-announcement-bubble" id="homeAnnouncementBubble" style="cursor: pointer;" onclick="showHomeAnnouncementDetail()">
                <span class="home-announcement-icon">ğŸ“¢</span>
                <div class="home-announcement-content">
                  <div class="home-announcement-text" id="homeAnnouncementBubbleText">æš‚æ— å…¬å‘Š</div>
                  <div style="font-size:12px;color:#6b7280;">ç³»ç»Ÿå…¬å‘Š <span id="homeAnnouncementHint" style="display:none; color: rgba(255,255,255,0.7);">ç‚¹å‡»æŸ¥çœ‹å®Œæ•´</span></div>
                </div>
              </div>
            </div>
            <div class="home-overview-stats">
              <div class="home-stat-item">
                <span class="home-stat-icon">ğŸ“°</span>
                <div class="home-stat-content">
                  <span class="home-stat-number" id="homeNewsCount">12</span>
                  <span class="home-stat-label">ä»Šæ—¥èµ„è®¯</span>
                </div>
              </div>
              <div class="home-stat-item">
                <span class="home-stat-icon">ğŸ</span>
                <div class="home-stat-content">
                  <span class="home-stat-number" id="homeActiveRaces">3</span>
                  <span class="home-stat-label">è¿›è¡Œä¸­èµ›äº‹</span>
                </div>
              </div>
              <div class="home-stat-item">
                <span class="home-stat-icon">ğŸ†</span>
                <div class="home-stat-content">
                  <span class="home-stat-number" id="homeCompletedRaces">5</span>
                  <span class="home-stat-label">å·²å…¬å¸ƒæˆç»©</span>
                </div>
              </div>
              <div class="home-stat-item">
                <span class="home-stat-icon">ğŸ•Šï¸</span>
                <div class="home-stat-content">
                  <span class="home-stat-number" id="homePigeonCount">0</span>
                  <span class="home-stat-label">æˆ‘çš„é¸½å­</span>
                </div>
              </div>
            </div>
          </div>

          <!-- é‡è¦å…¬å‘Š -->
          <div class="home-announcement" id="homeAnnouncement" style="display:none;">
            <span class="announcement-icon">ğŸ“¢</span>
            <span class="announcement-text" id="announcementText"></span>
            <button class="btn btn-sm btn-ghost" id="btnCloseAnnouncement">âœ•</button>
          </div>

          <!-- ä¸‰æ å¸ƒå±€ -->
          <div class="home-content">
            <!-- å·¦æ ï¼šèµ›é¸½èµ„è®¯æµ -->
            <div class="home-column home-news">
              <div class="home-column-header">
                <h3>ğŸ“° èµ›é¸½èµ„è®¯</h3>
                <div class="news-filter">
                  <button class="news-filter-btn active" data-filter="all">å…¨éƒ¨</button>
                  <button class="news-filter-btn" data-filter="race">èµ›äº‹</button>
                  <button class="news-filter-btn" data-filter="breeding">è‚²ç§</button>
                  <button class="news-filter-btn" data-filter="health">å¥åº·</button>
                </div>
              </div>
              <div class="news-region-tabs">
                <button class="news-region-tab active" data-region="local">ğŸ“ æœ¬åœ°èµ„è®¯</button>
                <button class="news-region-tab" data-region="national">ğŸŒ å…¨å›½èµ„è®¯</button>
              </div>
              <div class="home-news-list" id="homeNewsList">
                <!-- èµ„è®¯å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
              </div>
              <div class="home-column-footer">
                <button class="btn btn-outline btn-sm" id="btnRefreshNews">ğŸ”„ åˆ·æ–°èµ„è®¯</button>
                <button class="btn btn-outline btn-sm" id="btnLoadMoreNews">åŠ è½½æ›´å¤š</button>
              </div>
            </div>

            <!-- ä¸­æ ï¼šå®æ—¶èµ›äº‹ -->
            <div class="home-column home-events">
              <div class="home-column-header">
                <h3>ğŸ å®æ—¶èµ›äº‹</h3>
                <button class="btn btn-primary btn-sm" id="btnRefreshEvents">ğŸ”„ åˆ·æ–°</button>
              </div>
              <div class="event-region-tabs">
                <button class="event-region-tab active" data-region="local">ğŸ“ æœ¬åœ°èµ›äº‹</button>
                <button class="event-region-tab" data-region="national">ğŸŒ å…¨å›½èµ›äº‹</button>
              </div>
              <div class="event-tabs">
                <button class="event-tab-btn active" data-tab="ongoing">â± è¿›è¡Œä¸­</button>
                <button class="event-tab-btn" data-tab="upcoming">ğŸ“… å³å°†å¼€å§‹</button>
                <button class="event-tab-btn" data-tab="results">ğŸ† æœ€æ–°æˆç»©</button>
              </div>
              <div class="home-events-list" id="homeEventsList">
                <!-- èµ›äº‹å¡ç‰‡å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
              </div>
            </div>

            <!-- å³æ ï¼šæ™ºèƒ½æ¨è & è®¢é˜… -->
            <div class="home-column home-sidebar">
              <!-- æ™ºèƒ½æ¨è -->
              <div class="home-widget">
                <div class="home-widget-header">
                  <h4>ğŸ§  æ™ºèƒ½æ¨è</h4>
                </div>
                <div class="home-widget-content" id="homeRecommendations">
                  <!-- æ¨èå†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
              </div>

              <!-- æˆ‘çš„å…³æ³¨ -->
              <div class="home-widget">
                <div class="home-widget-header">
                  <h4>â­ æˆ‘çš„å…³æ³¨</h4>
                  <button class="btn btn-ghost btn-sm" id="btnEditSubscription">ç¼–è¾‘</button>
                </div>
                <div class="home-widget-content" id="homeSubscriptions">
                  <div class="subscription-tags">
                    <span class="subscription-tag">è´µå·èµ›åŒº</span>
                    <span class="subscription-tag">å…¬æ£šèµ›</span>
                    <span class="subscription-tag">æ˜¥å­£èµ›</span>
                    <span class="subscription-tag add-tag" id="btnAddSubscription">+ æ·»åŠ </span>
                  </div>
                </div>
              </div>

              <!-- å¿«æ·å…¥å£ -->
              <div class="home-widget">
                <div class="home-widget-header">
                  <h4>ğŸš€ å¿«æ·å…¥å£</h4>
                </div>
                <div class="home-widget-content">
                  <div class="quick-links">
                    <button class="quick-link-btn" data-action="addPigeon">
                      <span>â•</span>
                      <span>æ–°å¢é¸½å­</span>
                    </button>
                    <button class="quick-link-btn" data-action="addRace">
                      <span>ğŸ†</span>
                      <span>å½•å…¥æˆç»©</span>
                    </button>
                    <button class="quick-link-btn" data-action="breeding">
                      <span>ğŸ’•</span>
                      <span>é…å¯¹è¯„ä¼°</span>
                    </button>
                    <button class="quick-link-btn" data-action="analysis">
                      <span>ğŸ“Š</span>
                      <span>æ™ºèƒ½åˆ†æ</span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- ä»Šæ—¥æé†’ -->
              <div class="home-widget">
                <div class="home-widget-header">
                  <h4>ğŸ”” ä»Šæ—¥æé†’</h4>
                </div>
                <div class="home-widget-content" id="homeTodayAlerts">
                  <!-- æé†’å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- æ•°æ®æ¦‚è§ˆ -->
        <section id="dashboardView" class="card" style="display:none;">
          <div class="card-header">
            <h2>ğŸ“Š æ•°æ®æ¦‚è§ˆ</h2>
            <span class="muted" style="font-size: 13px;">å®æ—¶ç»Ÿè®¡æ‚¨çš„ä¿¡é¸½æ¡£æ¡ˆæ•°æ®</span>
          </div>
          
          <!-- æ ¸å¿ƒæ•°æ®å¡ç‰‡ -->
          <div class="stats-cards">
            <div class="stat-card">
              <div class="stat-card-label">
                <span style="font-size: 18px;">ğŸ“Š</span>
                <span>æ€»é¸½å­æ•°</span>
              </div>
              <div class="stat-card-number" id="statTotal" style="color:#2563eb;">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-label">
                <span style="font-size: 18px;">ğŸ•Šï¸</span>
                <span>åœ¨ä¸–</span>
              </div>
              <div class="stat-card-number" id="statAlive" style="color:#059669;">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-label">
                <span style="font-size: 18px;">ğŸ’”</span>
                <span>å·²æ­»äº¡</span>
              </div>
              <div class="stat-card-number" id="statDead" style="color:#4b5563;">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-label">
                <span style="font-size: 18px;">ğŸ†</span>
                <span>æœ‰æˆç»©</span>
              </div>
              <div class="stat-card-number" id="statRaced" style="color:#d97706;">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-label">
                <span style="font-size: 18px;">â­</span>
                <span>æ ¸å¿ƒç§é¸½</span>
              </div>
              <div class="stat-card-number" id="statCore" style="color:#7c3aed;">0</div>
            </div>
          </div>
          
          <!-- å›¾è¡¨åŒºåŸŸ -->
          <div class="card" style="margin-top:24px;">
            <div class="card-header">
              <h2>ğŸ“ˆ å¹´åº¦ç»Ÿè®¡</h2>
              <span class="muted" style="font-size: 13px;">æŒ‰å¹´ä»½æ±‡æ€»å‡ºç”Ÿã€æ­»äº¡åŠå‚èµ›è®°å½•</span>
            </div>
            <div id="chartContainer" style="min-height:300px; padding:24px;">
              <div id="dashboardStatsTableBody">
                <!-- å¹´åº¦ç»Ÿè®¡æ•°æ® -->
              </div>
            </div>
          </div>
        </section>

        <!-- é¸½å­ç®¡ç† -->
        <section id="listView" class="card" style="display:none;">
          <div class="card-header">
            <h2>é¸½å­ç®¡ç†</h2>
            <div style="display:flex;align-items:center;gap:12px;">
              <div class="view-switcher">
                <button class="view-switch-btn active" id="btnTableView" data-view-type="table">ğŸ“‹ è¡¨æ ¼</button>
                <button class="view-switch-btn" id="btnCardView" data-view-type="card">ğŸƒ å¡ç‰‡</button>
              </div>
            </div>
          </div>
          
          <!-- è¡¨æ ¼è§†å›¾ -->
          <div id="tableView">
            <table>
              <thead>
              <tr>
                <th>è¶³ç¯å·</th>
                <th>åç§°</th>
                <th>ç±»å‹</th>
                <th>çŠ¶æ€</th>
                <th>çˆ¶é¸½ / æ¯é¸½</th>
                <th>ç°é¸½ä¸»</th>
                <th>å‚èµ›è®°å½•æ•°</th>
                <th>æ“ä½œ</th>
              </tr>
              </thead>
              <tbody id="pigeonTableBody">
              <!-- è¡Œç”± JS å¡«å…… -->
              </tbody>
            </table>
          </div>
          
          <!-- å¡ç‰‡è§†å›¾ -->
          <div id="cardView" style="display:none;">
            <div class="pigeon-cards" id="pigeonCardsBody">
              <!-- å¡ç‰‡ç”± JS å¡«å…… -->
            </div>
          </div>
        </section>

        <!-- è¡€ç»Ÿå…³ç³» -->
        <section id="pedigreeView" class="card" style="display:none;">
          <div class="card-header">
            <h2>ğŸŒ³ è¡€ç»Ÿå…³ç³»æ ‘</h2>
            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
              <select id="pedigreeSelectPigeon" style="padding:8px 12px;border-radius:6px;border:1px solid #E5E7EB;background:#fff;min-width:250px;">
                <option value="">é€‰æ‹©é¸½å­æŸ¥çœ‹è¡€ç»Ÿæ ‘</option>
              </select>
              <div style="display:flex;align-items:center;gap:8px;">
                <input type="text" id="pedigreeSearchInput" placeholder="æœç´¢è¶³ç¯å·æˆ–åå­—..." style="padding:8px 12px;border-radius:6px;border:1px solid #E5E7EB;background:#fff;min-width:200px;font-size:14px;outline:none;" />
                <button class="btn btn-primary btn-sm" id="btnPedigreeSearch">ğŸ” æœç´¢</button>
              </div>
              <button class="btn btn-outline btn-sm" id="btnShowAllBreeders">ğŸ“Š æ˜¾ç¤ºæ‰€æœ‰ç§é¸½æ ‘</button>
              <button class="btn btn-outline btn-sm" id="btnRefreshPedigree">ğŸ”„ åˆ·æ–°</button>
            </div>
          </div>
          <div id="pedigreeTreeContainer" class="pedigree-tree-container" style="min-height:500px;padding:20px;background:#fafbfc;border-radius:8px;">
            <p class="muted" style="text-align:center;padding:40px;">è¯·ä»ä¸Šæ–¹ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©ä¸€åªé¸½å­ï¼Œæˆ–ä½¿ç”¨æœç´¢åŠŸèƒ½æŸ¥æ‰¾ï¼ŒæŸ¥çœ‹å…¶å®Œæ•´è¡€ç»Ÿå…³ç³»æ ‘ï¼ˆåŒ…æ‹¬äº²ä»£å’Œå­ä»£ï¼‰</p>
          </div>
        </section>

        <!-- ç»Ÿè®¡åˆ†æ -->
        <section id="statsView" class="card" style="display:none;">
          <div class="card-header">
            <h2>å¹´åº¦ç»Ÿè®¡æ¦‚è§ˆ</h2>
          </div>
          <p class="muted">æŒ‰å¹´ä»½æ±‡æ€»ï¼šå‡ºç”Ÿæ•°é‡ã€æ­»äº¡æ•°é‡ä»¥åŠæœ‰å‚èµ›è®°å½•çš„é¸½å­æ•°é‡ã€‚</p>
          <table>
            <thead>
            <tr>
              <th>å¹´ä»½</th>
              <th>å‡ºç”Ÿæ•°é‡</th>
              <th>æ­»äº¡æ•°é‡</th>
              <th>æœ‰å‚èµ›è®°å½•çš„é¸½å­æ•°</th>
            </tr>
            </thead>
            <tbody id="statsViewTableBody">
            </tbody>
          </table>
        </section>

        <!-- æ¯”èµ›ä¸æˆç»©ç®¡ç† -->
        <section id="raceView" class="card" style="display:none;">
          <div class="card-header">
            <h2>ğŸ† æ¯”èµ›ä¸æˆç»©ç®¡ç†</h2>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
              <button class="btn btn-primary btn-sm" id="btnAddRace">â• æ–°å¢æ¯”èµ›</button>
              <button class="btn btn-outline btn-sm" id="btnImportExcel">ğŸ“¥ å¯¼å…¥Excel</button>
              <button class="btn btn-outline btn-sm" id="btnExportData">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
              <button class="btn btn-outline btn-sm" id="btnRefreshRaces">ğŸ”„ åˆ·æ–°</button>
            </div>
          </div>

          <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
          <div style="border-bottom:2px solid #e5e7eb;margin-bottom:20px;">
            <div style="display:flex;gap:8px;">
              <button class="race-tab-btn active" data-tab="raceList">ğŸ“‹ æ¯”èµ›åˆ—è¡¨</button>
              <button class="race-tab-btn" data-tab="raceImport">ğŸ“¥ å¯¼å…¥æˆç»©</button>
              <button class="race-tab-btn" data-tab="raceStats">ğŸ“Š æˆç»©ç»Ÿè®¡</button>
              <button class="race-tab-btn" data-tab="raceAnalysis">ğŸ“ˆ æˆç»©åˆ†æ</button>
              <button class="race-tab-btn" data-tab="pedigreeComparison">ğŸ§¬ è¡€ç»Ÿå¯¹æ¯”</button>
            </div>
          </div>

          <!-- æ¯”èµ›åˆ—è¡¨æ ‡ç­¾é¡µ -->
          <div id="raceListTab" class="race-tab-content active">
            <div id="raceListContainer">
              <p class="muted" style="text-align:center;padding:40px;">æš‚æ— æ¯”èµ›è®°å½•ï¼Œç‚¹å‡»"æ–°å¢æ¯”èµ›"å¼€å§‹è®°å½•</p>
            </div>
          </div>

          <!-- å¯¼å…¥æˆç»©æ ‡ç­¾é¡µ -->
          <div id="raceImportTab" class="race-tab-content">
            <div style="max-width:800px;margin:0 auto;">
              <div class="excel-import-zone" id="excelDropZone">
                <div style="font-size:48px;margin-bottom:16px;">ğŸ“Š</div>
                <div style="font-size:16px;font-weight:600;color:#1f2937;margin-bottom:8px;">æ‹–æ”¾ Excel/CSV æ–‡ä»¶åˆ°æ­¤å¤„</div>
                <div style="font-size:13px;color:#6b7280;margin-bottom:16px;">æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" style="display:none;" />
                <button class="btn btn-primary" id="btnSelectExcel">é€‰æ‹©æ–‡ä»¶</button>
              </div>
              <div style="margin-top:24px;padding:20px;background:#f9fafb;border-radius:12px;">
                <h4 style="margin:0 0 12px;color:#1f2937;">ğŸ“‹ æ–‡ä»¶æ ¼å¼è¦æ±‚</h4>
                <div style="font-size:13px;color:#4b5563;line-height:1.8;">
                  <p>Excel æ–‡ä»¶åº”åŒ…å«ä»¥ä¸‹åˆ—ï¼ˆè¡¨å¤´åç§°ï¼‰ï¼š</p>
                  <ul style="margin:8px 0;padding-left:20px;">
                    <li><strong>è¶³ç¯å· / ç¯å·</strong> - é¸½å­çš„è¶³ç¯å·ç ï¼ˆå¿…éœ€ï¼‰</li>
                    <li><strong>åæ¬¡ / æ’å</strong> - æ¯”èµ›åæ¬¡ï¼ˆå¿…éœ€ï¼‰</li>
                    <li><strong>åˆ†é€Ÿ</strong> - æ¯”èµ›åˆ†é€Ÿï¼ˆå¯é€‰ï¼‰</li>
                    <li><strong>å½’å·¢æ—¶é—´</strong> - å½’å·¢æ—¶é—´ï¼ˆå¯é€‰ï¼‰</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <!-- æˆç»©ç»Ÿè®¡æ ‡ç­¾é¡µ -->
          <div id="raceStatsTab" class="race-tab-content">
            <p class="muted" style="text-align:center;padding:40px;">æˆç»©ç»Ÿè®¡åŠŸèƒ½å¼€å‘ä¸­...</p>
          </div>

          <!-- æˆç»©åˆ†ææ ‡ç­¾é¡µ -->
          <div id="raceAnalysisTab" class="race-tab-content">
            <p class="muted" style="text-align:center;padding:40px;">æˆç»©åˆ†æåŠŸèƒ½å¼€å‘ä¸­...</p>
          </div>

          <!-- è¡€ç»Ÿå¯¹æ¯”æ ‡ç­¾é¡µ -->
          <div id="pedigreeComparisonTab" class="race-tab-content">
            <p class="muted" style="text-align:center;padding:40px;">è¡€ç»Ÿå¯¹æ¯”åŠŸèƒ½å¼€å‘ä¸­...</p>
          </div>
        </section>

        <!-- ç¹è‚²ä¸é…å¯¹ -->
        <section id="breedingView" class="card" style="display:none;">
          <div class="card-header">
            <h2>ğŸ§¬ ç¹è‚²ä¸é…å¯¹ç®¡ç†</h2>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
              <button class="btn btn-primary btn-sm" id="btnNewPairing">ğŸ’• æ–°å»ºé…å¯¹</button>
              <button class="btn btn-outline btn-sm" id="btnViewPairingHistory">ğŸ“‹ é…å¯¹å†å²</button>
              <button class="btn btn-outline btn-sm" id="btnRefreshBreeding">ğŸ”„ åˆ·æ–°</button>
            </div>
          </div>

          <!-- é…å¯¹é¢æ¿ -->
          <div class="breeding-panel">
            <div class="breeding-selector-row" style="display:grid;grid-template-columns:1fr auto 1fr;gap:24px;align-items:start;margin-bottom:24px;">
              <!-- å…¬é¸½é€‰æ‹© -->
              <div class="breeding-pigeon-card male-card" style="background:linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);border:2px solid #3b82f6;border-radius:16px;padding:24px;">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
                  <span style="font-size:32px;">â™‚</span>
                  <div>
                    <h3 style="margin:0;color:#1e40af;font-size:18px;">é€‰æ‹©å…¬é¸½</h3>
                    <span style="color:#6b7280;font-size:13px;">Father</span>
                  </div>
                </div>
                <select id="breedingMaleSelect" style="width:100%;padding:12px;border-radius:8px;border:2px solid #93c5fd;font-size:14px;background:#fff;">
                  <option value="">è¯·é€‰æ‹©å…¬é¸½...</option>
                </select>
                <div id="breedingMaleInfo" style="margin-top:16px;min-height:150px;">
                  <p class="muted" style="text-align:center;padding:20px;">é€‰æ‹©å…¬é¸½åæ˜¾ç¤ºè¯¦æƒ…</p>
                </div>
              </div>

              <!-- é…å¯¹è¯„ä¼°ä¸­å¿ƒ -->
              <div class="breeding-assessment" style="background:linear-gradient(135deg, #fdf4ff 0%, #faf5ff 100%);border:2px solid #a855f7;border-radius:16px;padding:24px;min-width:300px;">
                <div style="text-align:center;margin-bottom:20px;">
                  <span style="font-size:48px;">ğŸ’‘</span>
                  <h3 style="margin:8px 0 0;color:#7e22ce;font-size:18px;">é…å¯¹è¯„ä¼°</h3>
                </div>
                <div id="breedingAssessment" style="min-height:200px;">
                  <div style="text-align:center;padding:40px 20px;color:#9ca3af;">
                    <div style="font-size:32px;margin-bottom:12px;">ğŸ”®</div>
                    <p>è¯·å…ˆé€‰æ‹©å…¬é¸½å’Œæ¯é¸½</p>
                    <p style="font-size:12px;">ç³»ç»Ÿå°†è‡ªåŠ¨åˆ†æè¿‘äº²é£é™©ä¸é…å¯¹å»ºè®®</p>
                  </div>
                </div>
                <button class="btn btn-primary" id="btnConfirmPairing" style="width:100%;margin-top:16px;padding:14px;font-size:15px;" disabled>âœ… ç¡®è®¤é…å¯¹</button>
              </div>

              <!-- æ¯é¸½é€‰æ‹© -->
              <div class="breeding-pigeon-card female-card" style="background:linear-gradient(135deg, #fce7f3 0%, #fdf2f8 100%);border:2px solid #ec4899;border-radius:16px;padding:24px;">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
                  <span style="font-size:32px;">â™€</span>
                  <div>
                    <h3 style="margin:0;color:#be185d;font-size:18px;">é€‰æ‹©æ¯é¸½</h3>
                    <span style="color:#6b7280;font-size:13px;">Mother</span>
                  </div>
                </div>
                <select id="breedingFemaleSelect" style="width:100%;padding:12px;border-radius:8px;border:2px solid #f9a8d4;font-size:14px;background:#fff;">
                  <option value="">è¯·é€‰æ‹©æ¯é¸½...</option>
                </select>
                <div id="breedingFemaleInfo" style="margin-top:16px;min-height:150px;">
                  <p class="muted" style="text-align:center;padding:20px;">é€‰æ‹©æ¯é¸½åæ˜¾ç¤ºè¯¦æƒ…</p>
                </div>
              </div>
            </div>

            <!-- å†å²é…å¯¹æˆåŠŸæ¡ˆä¾‹ -->
            <div class="breeding-history-section" style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-top:24px;">
              <h4 style="margin:0 0 16px;color:#1f2937;display:flex;align-items:center;gap:8px;">
                <span>ğŸ“Š</span> å†å²é…å¯¹ä¸åä»£è¡¨ç°
              </h4>
              <div id="breedingHistoryContainer">
                <p class="muted" style="text-align:center;padding:20px;">æš‚æ— é…å¯¹å†å²è®°å½•</p>
              </div>
            </div>
          </div>
        </section>

        <!-- å¥åº·ç®¡ç† -->
        <section id="healthView" class="card" style="display:none;">
          <div class="card-header">
            <h2>ğŸ©º å¥åº·ä¸ç”¨è¯ç®¡ç†</h2>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
              <button class="btn btn-primary btn-sm" id="btnAddHealthRecord">ğŸ’‰ æ·»åŠ è®°å½•</button>
              <button class="btn btn-outline btn-sm" id="btnHealthCalendar">ğŸ“… æé†’æ—¥å†</button>
              <button class="btn btn-outline btn-sm" id="btnRefreshHealth">ğŸ”„ åˆ·æ–°</button>
            </div>
          </div>

          <!-- å¥åº·çŠ¶æ€æ¦‚è§ˆ -->
          <div class="health-overview" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:16px;margin-bottom:24px;">
            <div style="background:linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);padding:20px;border-radius:12px;border:1px solid #10b981;">
              <div style="font-size:28px;">âœ…</div>
              <div style="font-size:13px;color:#047857;margin-top:8px;">å¥åº·çŠ¶æ€</div>
              <div id="healthyCount" style="font-size:32px;font-weight:700;color:#047857;">0</div>
            </div>
            <div style="background:linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);padding:20px;border-radius:12px;border:1px solid #f59e0b;">
              <div style="font-size:28px;">â°</div>
              <div style="font-size:13px;color:#b45309;margin-top:8px;">å³å°†åˆ°æœŸ</div>
              <div id="upcomingCount" style="font-size:32px;font-weight:700;color:#b45309;">0</div>
            </div>
            <div style="background:linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);padding:20px;border-radius:12px;border:1px solid #ef4444;">
              <div style="font-size:28px;">ğŸ¥</div>
              <div style="font-size:13px;color:#dc2626;margin-top:8px;">éœ€è¦å…³æ³¨</div>
              <div id="needAttentionCount" style="font-size:32px;font-weight:700;color:#dc2626;">0</div>
            </div>
            <div style="background:linear-gradient(135deg, #e0e7ff 0%, #eef2ff 100%);padding:20px;border-radius:12px;border:1px solid #6366f1;">
              <div style="font-size:28px;">ğŸ’Š</div>
              <div style="font-size:13px;color:#4338ca;margin-top:8px;">ç”¨è¯ä¸­</div>
              <div id="medicatingCount" style="font-size:32px;font-weight:700;color:#4338ca;">0</div>
            </div>
          </div>

          <!-- å¥åº·æé†’åˆ—è¡¨ -->
          <div class="health-alerts" style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:24px;">
            <h4 style="margin:0 0 16px;color:#1f2937;display:flex;align-items:center;gap:8px;">
              <span>ğŸ””</span> å¥åº·æé†’
            </h4>
            <div id="healthAlertsContainer">
              <p class="muted" style="text-align:center;padding:20px;">æš‚æ— å¥åº·æé†’</p>
            </div>
          </div>

          <!-- é¸½å­å¥åº·æ—¶é—´è½´ -->
          <div class="health-timeline" style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
              <h4 style="margin:0;color:#1f2937;display:flex;align-items:center;gap:8px;">
                <span>ğŸ“‹</span> å¥åº·è®°å½•æ—¶é—´è½´
              </h4>
              <select id="healthPigeonSelect" style="padding:8px 12px;border-radius:6px;border:1px solid #E5E7EB;min-width:200px;">
                <option value="">é€‰æ‹©é¸½å­æŸ¥çœ‹è®°å½•...</option>
              </select>
            </div>
            <div id="healthTimelineContainer">
              <p class="muted" style="text-align:center;padding:40px;">é€‰æ‹©é¸½å­åæ˜¾ç¤ºå¥åº·æ—¶é—´è½´</p>
            </div>
          </div>
        </section>

        <!-- æ™ºèƒ½åˆ†æä¸­å¿ƒ -->
        <section id="analysisView" class="card" style="display:none;">
          <div class="card-header">
            <h2>ğŸ§  æ™ºèƒ½åˆ†æä¸­å¿ƒ</h2>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
              <button class="btn btn-primary btn-sm" id="btnRunAnalysis">ğŸš€ è¿è¡Œå…¨é¢åˆ†æ</button>
              <button class="btn btn-outline btn-sm" id="btnExportReport">ğŸ“¤ å¯¼å‡ºæŠ¥å‘Š</button>
              <button class="btn btn-outline btn-sm" id="btnRefreshAnalysis">ğŸ”„ åˆ·æ–°</button>
            </div>
          </div>

          <!-- æ™ºèƒ½æ´å¯Ÿå¡ç‰‡ -->
          <div class="insight-cards" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:20px;margin-bottom:24px;">
            <!-- ä»Šå¹´æœ€æˆåŠŸçš„è¡€ç³» -->
            <div class="insight-card" style="background:linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);padding:24px;border-radius:16px;border:2px solid #f59e0b;">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                <span style="font-size:32px;">ğŸ†</span>
                <h4 style="margin:0;color:#92400e;">ä»Šå¹´æœ€æˆåŠŸè¡€ç³»</h4>
              </div>
              <div id="topBloodlineCard">
                <p class="muted">åˆ†æä¸­...</p>
              </div>
            </div>

            <!-- æœ€å¼ºç§å…¬ -->
            <div class="insight-card" style="background:linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);padding:24px;border-radius:16px;border:2px solid #3b82f6;">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                <span style="font-size:32px;">â™‚</span>
                <h4 style="margin:0;color:#1e40af;">æœ€å¼ºç§å…¬</h4>
              </div>
              <div id="topMaleCard">
                <p class="muted">åˆ†æä¸­...</p>
              </div>
            </div>

            <!-- æœ€å¼ºç§æ¯ -->
            <div class="insight-card" style="background:linear-gradient(135deg, #fce7f3 0%, #fdf2f8 100%);padding:24px;border-radius:16px;border:2px solid #ec4899;">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                <span style="font-size:32px;">â™€</span>
                <h4 style="margin:0;color:#be185d;">æœ€å¼ºç§æ¯</h4>
              </div>
              <div id="topFemaleCard">
                <p class="muted">åˆ†æä¸­...</p>
              </div>
            </div>

            <!-- æ¨èé…å¯¹ -->
            <div class="insight-card" style="background:linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);padding:24px;border-radius:16px;border:2px solid #10b981;">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                <span style="font-size:32px;">ğŸ’•</span>
                <h4 style="margin:0;color:#047857;">æ™ºèƒ½æ¨èé…å¯¹</h4>
              </div>
              <div id="recommendedPairingCard">
                <p class="muted">åˆ†æä¸­...</p>
              </div>
            </div>
          </div>

          <!-- è¯¦ç»†åˆ†ææŠ¥å‘Š -->
          <div class="card" style="margin-top:24px;">
            <div class="card-header">
              <h3>ğŸ“Š è¯¦ç»†åˆ†ææŠ¥å‘Š</h3>
            </div>
            <div id="analysisReportContainer">
              <p class="muted" style="text-align:center;padding:40px;">ç‚¹å‡»"è¿è¡Œå…¨é¢åˆ†æ"ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š</p>
            </div>
          </div>
        </section>

        <!-- è®­ç»ƒæ¨¡å— -->
        <section id="trainingView" class="card" style="display:none;">
          <div class="card-header">
            <h2>ğŸƒ è®­ç»ƒæ¨¡å—</h2>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
              <button class="btn btn-primary btn-sm" id="btnScanQR">ğŸ“· æ‰«ç å½•å…¥</button>
              <button class="btn btn-outline btn-sm" id="btnManualInput">âœï¸ æ‰‹åŠ¨è¾“å…¥</button>
              <button class="btn btn-outline btn-sm" id="btnRefreshTraining">ğŸ”„ åˆ·æ–°</button>
            </div>
          </div>

          <!-- æ‰«ç /è¾“å…¥åŒºåŸŸ -->
          <div class="card" style="margin-bottom:24px;background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
            <div style="display:flex;gap:20px;align-items:flex-start;flex-wrap:wrap;">
              <div style="flex:1;min-width:300px;">
                <h4 style="margin:0 0 16px;color:#0369a1;">ğŸ“· æ‰«ç æˆ–è¾“å…¥è„šç¯å·</h4>
                <div style="display:flex;gap:12px;margin-bottom:16px;">
                  <input type="text" id="trainingRingInput" placeholder="è¾“å…¥è„šç¯å·" style="flex:1;padding:12px;border-radius:8px;border:2px solid #0ea5e9;font-size:14px;" />
                  <button class="btn btn-primary" id="btnSearchPigeon">ğŸ” æŸ¥æ‰¾</button>
                </div>
                <div id="qrScannerContainer" style="display:none;margin-top:16px;">
                  <video id="qrVideo" width="100%" style="max-width:400px;border-radius:8px;background:#000;"></video>
                  <canvas id="qrCanvas" style="display:none;"></canvas>
                  <div style="margin-top:12px;">
                    <button class="btn btn-outline btn-sm" id="btnStopScan">åœæ­¢æ‰«æ</button>
                  </div>
                </div>
              </div>
              <div id="selectedPigeonInfo" style="flex:1;min-width:300px;display:none;">
                <h4 style="margin:0 0 16px;color:#0369a1;">é€‰ä¸­çš„é¸½å­</h4>
                <div id="selectedPigeonDetails" style="background:#fff;padding:16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);"></div>
              </div>
            </div>
          </div>

          <!-- è®­ç»ƒè®°å½•è¡¨å• -->
          <div id="trainingFormContainer" style="display:none;">
            <div class="card-header">
              <h3>ğŸ“ è®°å½•è®­ç»ƒå†…å®¹</h3>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label>è®­ç»ƒæ—¥æœŸ<span class="required">*</span></label>
                <input type="date" id="trainingDate" required />
              </div>
              <div class="form-group">
                <label>è®­ç»ƒè·ç¦»ï¼ˆå…¬é‡Œï¼‰<span class="required">*</span></label>
                <input type="number" id="trainingDistance" step="0.1" placeholder="ä¾‹å¦‚ï¼š50" required />
              </div>
              <div class="form-group">
                <label>é£è¡Œæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰<span class="required">*</span></label>
                <input type="number" id="trainingDuration" step="1" placeholder="ä¾‹å¦‚ï¼š60" required />
              </div>
              <div class="form-group">
                <label>å¤©æ°”çŠ¶å†µ</label>
                <select id="trainingWeather">
                  <option value="æ™´æœ—">æ™´æœ—</option>
                  <option value="å¤šäº‘">å¤šäº‘</option>
                  <option value="é˜´å¤©">é˜´å¤©</option>
                  <option value="å°é›¨">å°é›¨</option>
                  <option value="å¤§é£">å¤§é£</option>
                </select>
              </div>
            </div>
            <div class="form-group" style="margin-top:12px;">
              <label>å¤‡æ³¨</label>
              <textarea id="trainingNotes" rows="3" placeholder="è®°å½•è®­ç»ƒè¿‡ç¨‹ä¸­çš„ç‰¹æ®Šæƒ…å†µ..."></textarea>
            </div>
            <div class="form-actions" style="margin-top:20px;">
              <button class="btn btn-outline" id="btnCancelTraining">å–æ¶ˆ</button>
              <button class="btn btn-primary" id="btnSaveTraining">ä¿å­˜è®­ç»ƒè®°å½•</button>
            </div>
          </div>

          <!-- è®­ç»ƒè®°å½•åˆ—è¡¨ -->
          <div class="card" style="margin-top:24px;">
            <div class="card-header">
              <h3>ğŸ“‹ è®­ç»ƒè®°å½•å†å²</h3>
            </div>
            <div id="trainingHistoryContainer">
              <p class="muted" style="text-align:center;padding:40px;">æš‚æ— è®­ç»ƒè®°å½•</p>
            </div>
          </div>
          
          <!-- æ™ºèƒ½åˆ†æä¸æ€»ç»“ -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="margin:0;">ğŸ¤– æ™ºèƒ½åˆ†æä¸æ€»ç»“</h3>
            </div>
            <div id="trainingAnalysisContainerAdmin">
              <p class="muted">æš‚æ— åˆ†ææ•°æ®ï¼Œè¯·å…ˆæ·»åŠ è®­ç»ƒè®°å½•</p>
            </div>
          </div>
          
          <!-- å†å²åˆ†æä¸æ€»ç»“è¡¨æ ¼ -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="margin:0;">ğŸ“Š å†å²åˆ†æä¸æ€»ç»“</h3>
              <div style="display: flex; gap: 8px; align-items: center;">
                <input type="text" id="trainingAnalysisSearchAdmin" placeholder="æœç´¢é¸½å­åå­—æˆ–è¶³ç¯å·..." 
                       style="padding: 8px 12px; border-radius: 6px; border: 1px solid #E5E7EB; font-size: 13px; width: 200px;"
                       oninput="filterTrainingAnalysisAdmin()" />
              </div>
            </div>
            <div style="overflow-x: auto;">
              <table id="trainingAnalysisTableAdmin" style="width: 100%; border-collapse: collapse; min-width: 800px;">
                <thead>
                  <tr style="background: #f9fafb; border-bottom: 2px solid #E5E7EB;">
                    <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #1f2937;">é¸½å­</th>
                    <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #1f2937;">è¶³ç¯å·</th>
                    <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #1f2937;">æœ€æ–°åˆ†ææ—¥æœŸ</th>
                    <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #1f2937;">è®­ç»ƒæ¬¡æ•°</th>
                    <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #1f2937;">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="trainingAnalysisTableBodyAdmin">
                  <tr>
                    <td colspan="5" style="padding: 40px; text-align: center; color: #6b7280;">æš‚æ— åˆ†ææ•°æ®</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
        
        <!-- è®­ç»ƒåˆ†æä¸æ€»ç»“è¯¦æƒ…æ¨¡æ€æ¡† -->
        <div id="trainingAnalysisDetailModalAdmin" class="modal" style="display:none;">
          <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
              <h2 id="trainingAnalysisDetailTitleAdmin">è®­ç»ƒåˆ†æä¸æ€»ç»“</h2>
              <button class="modal-close" onclick="closeTrainingAnalysisDetailModalAdmin()">âœ•</button>
            </div>
            <div class="modal-body">
              <!-- æœ€æ–°åˆ†æä¸æ€»ç»“ -->
              <div class="card" style="margin-bottom: 24px;">
                <h4 style="margin:0 0 16px;color:#1f2937;">ğŸ“ˆ æœ€æ–°åˆ†æä¸æ€»ç»“</h4>
                <div id="trainingAnalysisLatestAdmin" style="padding: 16px; background: #f9fafb; border-radius: 8px;">
                  <p class="muted">æš‚æ— æœ€æ–°åˆ†æ</p>
                </div>
              </div>
              
              <!-- å†å²åˆ†æä¸æ€»ç»“ -->
              <div class="card">
                <h4 style="margin:0 0 16px;color:#1f2937;">ğŸ“š å†å²åˆ†æä¸æ€»ç»“</h4>
                <div id="trainingAnalysisHistoryAdmin" style="max-height: 400px; overflow-y: auto;">
                  <p class="muted">æš‚æ— å†å²åˆ†æ</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- èƒ½åŠ›ç»¼åˆåˆ†æ -->
        <section id="qualificationView" class="card" style="display:none;">
          <div class="card-header">
            <h2>ğŸ¯ èƒ½åŠ›ç»¼åˆåˆ†æ</h2>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
              <button class="btn btn-outline btn-sm" id="btnRefreshQualification">ğŸ”„ åˆ·æ–°</button>
            </div>
          </div>

          <!-- é€‰æ‹©é¸½å­å’Œæ¯”èµ›è·ç¦» -->
          <div class="card" style="margin-bottom:24px;background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
            <h4 style="margin:0 0 16px;color:#0369a1;">é€‰æ‹©é¸½å­å’Œæ¯”èµ›ä¿¡æ¯</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>é€‰æ‹©é¸½å­<span class="required">*</span></label>
                <select id="qualificationPigeonSelect" style="width:100%;">
                  <option value="">è¯·é€‰æ‹©é¸½å­</option>
                </select>
              </div>
              <div class="form-group">
                <label>æ¯”èµ›è·ç¦»ï¼ˆå…¬é‡Œï¼‰<span class="required">*</span></label>
                <input type="number" id="qualificationDistance" step="0.1" placeholder="ä¾‹å¦‚ï¼š500" required />
              </div>
              <div class="form-group" style="align-items:flex-end;">
                <button class="btn btn-primary" id="btnAnalyzeQualification">ğŸš€ å¼€å§‹åˆ†æ</button>
              </div>
            </div>
          </div>

          <!-- åˆ†æç»“æœ -->
          <div id="qualificationResultContainer" style="display:none;">
            <!-- å…è´£å£°æ˜ -->
            <div class="card" style="background:#fef3c7;border:2px solid #f59e0b;margin-bottom:24px;">
              <div style="display:flex;align-items:flex-start;gap:12px;">
                <span style="font-size:24px;">âš ï¸</span>
                <div>
                  <h4 style="margin:0 0 8px;color:#92400e;">æ•°æ®ä»…ä¾›å‚è€ƒ</h4>
                  <p style="margin:0;color:#78350f;font-size:14px;" id="qualificationDisclaimer">
                    æœ¬åˆ†æç»“æœä»…ä¾›å‚è€ƒï¼Œå®é™…å‚èµ›èµ„æ ¼ä»¥èµ›äº‹ç»„å§”ä¼šè§„å®šä¸ºå‡†ã€‚æ•°æ®æ¥æºäºè®­ç»ƒè®°å½•ã€å†å²æ¯”èµ›è®°å½•åŠå…¬å¼€èµ›äº‹æ•°æ®ï¼Œå¯èƒ½å­˜åœ¨è¯¯å·®ã€‚
                  </p>
                </div>
              </div>
            </div>

            <!-- ç»¼åˆåˆ†æç»“æœ -->
            <div class="card" style="margin-bottom:24px;">
              <h3 style="margin:0 0 16px;color:#1f2937;">ğŸ“Š ç»¼åˆåˆ†æç»“æœ</h3>
              <div id="qualificationAnalysisResult">
                <!-- åˆ†æç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
              </div>
            </div>
          </div>
        </section>

        <!-- æ™ºèƒ½ç®¡ç†åŠŸèƒ½ -->
        <!-- å…¬å‘Šç®¡ç† -->
        <div id="announcementsTab" class="card" style="display:block;">
          <div class="card-header">
            <h2>ğŸ“¢ å…¬å‘Šç®¡ç†</h2>
            <button class="btn btn-primary btn-sm" id="createAnnouncementBtn">â• å‘å¸ƒæ–°å…¬å‘Š</button>
          </div>
          <div id="announcementsList">
            <p class="muted" style="text-align: center; padding: 40px;">åŠ è½½ä¸­...</p>
          </div>
          
          <!-- å†å²å…¬å‘Šæ¨¡å— -->
          <div style="margin-top: 32px; padding-top: 24px; border-top: 2px solid var(--border-light);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="margin: 0; font-size: 18px; color: var(--text-primary);">ğŸ“œ å†å²å…¬å‘Š</h3>
              <button class="btn btn-outline btn-sm" id="refreshHistoryBtn" onclick="loadAnnouncementHistory()">ğŸ”„ åˆ·æ–°</button>
            </div>
            <div id="announcementHistoryList">
              <p class="muted" style="text-align: center; padding: 40px;">åŠ è½½ä¸­...</p>
            </div>
          </div>
        </div>

        <!-- æ„è§ä¸åé¦ˆ -->
        <div id="feedbackViewTab" class="card" style="display:none;">
          <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <h2>ğŸ’¬ ç”¨æˆ·æ„è§ä¸åé¦ˆ</h2>
              <p class="muted" style="margin-top:4px;font-size:13px;">æŸ¥çœ‹æ¥è‡ª PC ä¸ç§»åŠ¨ç«¯ç”¨æˆ·æäº¤çš„æ„è§å’Œé—®é¢˜</p>
            </div>
            <div>
              <select id="feedbackStatusFilter" style="padding:6px 10px;border-radius:6px;border:1px solid var(--border-light);font-size:13px;">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="new">æœªå¤„ç†</option>
              </select>
              <button class="btn btn-primary btn-sm" id="btnRefreshFeedback" style="margin-left:8px;">ğŸ”„ åˆ·æ–°</button>
            </div>
          </div>
          <div style="padding:16px;">
            <div class="table-wrapper">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width:18%;">æäº¤æ—¶é—´</th>
                    <th style="width:12%;">æ¥æº</th>
                    <th style="width:20%;">ç”¨æˆ·</th>
                    <th>å†…å®¹</th>
                    <th style="width:16%;">è”ç³»æ–¹å¼</th>
                  </tr>
                </thead>
                <tbody id="feedbackTableBody">
                  <tr>
                    <td colspan="5" style="text-align:center;color:var(--text-muted);padding:32px;">æš‚æ— æ•°æ®</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- ç”¨æˆ·ç®¡ç† -->
        <div id="usersTab" class="card" style="display:none;">
          <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
            <h2>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
            <div style="display:flex;gap:10px;">
              <input type="text" id="userSearchInput" placeholder="æœç´¢ç”¨æˆ·åæˆ–é‚®ç®±..." style="padding:8px 12px;border:1px solid var(--border-light);border-radius:6px;font-size:14px;width:250px;" />
              <button class="btn btn-primary btn-sm" onclick="loadUsers()">ğŸ”„ åˆ·æ–°</button>
            </div>
          </div>
          <div id="usersList">
            <p class="muted" style="text-align: center; padding: 40px;">åŠ è½½ä¸­...</p>
          </div>
        </div>
        
        <!-- ç”¨æˆ·æ•°æ®è¯¦æƒ…æ¨¡æ€æ¡† -->
        <div id="userDataModal" class="modal" style="display:none;">
          <div class="modal-content" style="max-width:900px;max-height:85vh;overflow-y:auto;">
            <div class="modal-header">
              <h3 id="userDataModalTitle">ç”¨æˆ·æ•°æ®è¯¦æƒ…</h3>
              <button class="modal-close" onclick="closeUserDataModal()">Ã—</button>
            </div>
            <div class="modal-body" id="userDataModalBody">
              <p class="muted">åŠ è½½ä¸­...</p>
            </div>
          </div>
        </div>
        
        <!-- ç³»ç»Ÿè®¾ç½® -->
        <div id="settingsTab" class="card" style="display:none;">
          <div class="card-header">
            <h2>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h2>
            <p class="muted" style="margin-top: 8px;">ç®¡ç†ç³»ç»Ÿé…ç½®å‚æ•°</p>
          </div>
          
          <div style="padding: 24px;">
            <!-- è®¾ç½®æ ‡ç­¾é¡µ -->
            <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid var(--border-light);">
              <button class="settings-tab-btn active" data-tab="general">åŸºç¡€è®¾ç½®</button>
              <button class="settings-tab-btn" data-tab="rss">RSSæºç®¡ç†</button>
              <button class="settings-tab-btn" data-tab="cache">ç¼“å­˜é…ç½®</button>
              <button class="settings-tab-btn" data-tab="ai">AIé…ç½®</button>
              <button class="settings-tab-btn" data-tab="database">æ•°æ®åº“é…ç½®</button>
            </div>
            
            <!-- åŸºç¡€è®¾ç½® -->
            <div id="settingsGeneral" class="settings-panel">
              <h3 style="margin-bottom: 20px; color: var(--text-primary);">æœåŠ¡å™¨é…ç½®</h3>
              
              <div class="form-group">
                <label>æœåŠ¡å™¨ç«¯å£</label>
                <input type="number" id="serverPort" class="form-control" placeholder="3000" min="1" max="65535" />
                <small class="form-text">å½“å‰è¿è¡Œç«¯å£ï¼ˆä¿®æ”¹éœ€è¦é‡å¯æœåŠ¡ï¼‰</small>
              </div>
              
              <div class="form-group">
                <label>è¿è¡Œç¯å¢ƒ</label>
                <select id="serverEnv" class="form-control">
                  <option value="development">å¼€å‘ç¯å¢ƒ</option>
                  <option value="production">ç”Ÿäº§ç¯å¢ƒ</option>
                </select>
                <small class="form-text">å½“å‰è¿è¡Œç¯å¢ƒ</small>
              </div>
              
              <div class="form-group">
                <label>APIé€Ÿç‡é™åˆ¶</label>
                <input type="number" id="apiRateLimit" class="form-control" placeholder="100" min="1" />
                <small class="form-text">æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ•°</small>
              </div>
              
              <h3 style="margin-top: 32px; margin-bottom: 20px; color: var(--text-primary);">æ—¥å¿—é…ç½®</h3>
              
              <div class="form-group">
                <label>æ—¥å¿—çº§åˆ«</label>
                <select id="logLevel" class="form-control">
                  <option value="error">é”™è¯¯</option>
                  <option value="warn">è­¦å‘Š</option>
                  <option value="info">ä¿¡æ¯</option>
                  <option value="debug">è°ƒè¯•</option>
                </select>
                <small class="form-text">æ—¥å¿—è®°å½•çº§åˆ«</small>
              </div>
              
              <div class="form-actions" style="margin-top: 24px;">
                <button type="button" class="btn btn-primary" id="btnSaveGeneralSettings">ä¿å­˜åŸºç¡€è®¾ç½®</button>
                <button type="button" class="btn btn-outline" id="btnResetGeneralSettings">é‡ç½®</button>
              </div>
            </div>
            
            <!-- RSSæºç®¡ç† -->
            <div id="settingsRss" class="settings-panel" style="display:none;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: var(--text-primary);">RSSæ•°æ®æºç®¡ç†</h3>
                <button type="button" class="btn btn-primary btn-sm" id="btnAddRssSource">+ æ·»åŠ RSSæº</button>
              </div>
              
              <div id="rssSourcesList" style="display: grid; gap: 16px;">
                <!-- RSSæºåˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
              </div>
              
              <div id="rssSourceForm" style="display:none; margin-top: 24px; padding: 20px; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                <h4 style="margin-bottom: 16px;">æ·»åŠ /ç¼–è¾‘RSSæº</h4>
                <div class="form-group">
                  <label>æºåç§° <span class="required">*</span></label>
                  <input type="text" id="rssSourceName" class="form-control" placeholder="ä¾‹å¦‚ï¼šä¸­å›½ä¿¡é¸½ä¿¡æ¯ç½‘" />
                </div>
                <div class="form-group">
                  <label>RSS URL <span class="required">*</span></label>
                  <input type="url" id="rssSourceUrl" class="form-control" placeholder="https://example.com/rss" />
                </div>
                <div class="form-group">
                  <label>ç±»å‹ <span class="required">*</span></label>
                  <select id="rssSourceType" class="form-control">
                    <option value="media">åª’ä½“</option>
                    <option value="association">åä¼š</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>åœ°åŒº <span class="required">*</span></label>
                  <select id="rssSourceRegion" class="form-control">
                    <option value="local">æœ¬åœ°</option>
                    <option value="national">å…¨å›½</option>
                  </select>
                </div>
                <div class="form-actions">
                  <button type="button" class="btn btn-primary" id="btnSaveRssSource">ä¿å­˜</button>
                  <button type="button" class="btn btn-outline" id="btnCancelRssSource">å–æ¶ˆ</button>
                  <button type="button" class="btn btn-outline" id="btnTestRssSource">æµ‹è¯•è¿æ¥</button>
                </div>
                <div id="rssSourceTestResult" style="margin-top: 12px;"></div>
              </div>
            </div>
            
            <!-- ç¼“å­˜é…ç½® -->
            <div id="settingsCache" class="settings-panel" style="display:none;">
              <h3 style="margin-bottom: 20px; color: var(--text-primary);">ç¼“å­˜é…ç½®</h3>
              <p class="muted" style="margin-bottom: 24px;">é…ç½®å„ç±»æ•°æ®çš„ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰</p>
              
              <div class="form-group">
                <label>èµ„è®¯ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰</label>
                <input type="number" id="cacheTtlNews" class="form-control" placeholder="3600" min="0" />
                <small class="form-text">èµ„è®¯æ•°æ®ç¼“å­˜æ—¶é—´ï¼Œé»˜è®¤3600ç§’ï¼ˆ1å°æ—¶ï¼‰</small>
              </div>
              
              <div class="form-group">
                <label>èµ›äº‹ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰</label>
                <input type="number" id="cacheTtlEvents" class="form-control" placeholder="300" min="0" />
                <small class="form-text">èµ›äº‹æ•°æ®ç¼“å­˜æ—¶é—´ï¼Œé»˜è®¤300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰</small>
              </div>
              
              <div class="form-group">
                <label>æˆç»©ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰</label>
                <input type="number" id="cacheTtlResults" class="form-control" placeholder="7200" min="0" />
                <small class="form-text">æˆç»©æ•°æ®ç¼“å­˜æ—¶é—´ï¼Œé»˜è®¤7200ç§’ï¼ˆ2å°æ—¶ï¼‰</small>
              </div>
              
              <h3 style="margin-top: 32px; margin-bottom: 20px; color: var(--text-primary);">æ›´æ–°é¢‘ç‡</h3>
              
              <div class="form-group">
                <label>èµ„è®¯æ›´æ–°é—´éš”ï¼ˆç§’ï¼‰</label>
                <input type="number" id="updateIntervalNews" class="form-control" placeholder="3600" min="0" />
                <small class="form-text">è‡ªåŠ¨æ›´æ–°èµ„è®¯çš„é—´éš”æ—¶é—´</small>
              </div>
              
              <div class="form-group">
                <label>èµ›äº‹æ›´æ–°é—´éš”ï¼ˆç§’ï¼‰</label>
                <input type="number" id="updateIntervalEvents" class="form-control" placeholder="300" min="0" />
                <small class="form-text">è‡ªåŠ¨æ›´æ–°èµ›äº‹çš„é—´éš”æ—¶é—´</small>
              </div>
              
              <div class="form-group">
                <label>æˆç»©æ›´æ–°é—´éš”ï¼ˆç§’ï¼‰</label>
                <input type="number" id="updateIntervalResults" class="form-control" placeholder="1800" min="0" />
                <small class="form-text">è‡ªåŠ¨æ›´æ–°æˆç»©çš„é—´éš”æ—¶é—´</small>
              </div>
              
              <div class="form-actions" style="margin-top: 24px;">
                <button type="button" class="btn btn-primary" id="btnSaveCacheSettings">ä¿å­˜ç¼“å­˜é…ç½®</button>
                <button type="button" class="btn btn-outline" id="btnResetCacheSettings">é‡ç½®</button>
              </div>
            </div>
            
            <!-- AIé…ç½® -->
            <div id="settingsAi" class="settings-panel" style="display:none;">
              <h3 style="margin-bottom: 20px; color: var(--text-primary);">AIæœåŠ¡é…ç½®</h3>
              <p class="muted" style="margin-bottom: 24px;">é…ç½®AIæœåŠ¡æä¾›å•†çš„API Keyï¼ˆæ•æ„Ÿä¿¡æ¯ï¼Œè¯·å¦¥å–„ä¿ç®¡ï¼‰ã€‚æ”¯æŒä»…æœ¬åœ°ä¿å­˜æˆ–ä¿å­˜åˆ°åå°ç«‹å³ç”Ÿæ•ˆã€‚</p>
              
              <div class="alert alert-info" style="margin-bottom: 24px; padding: 16px; background: var(--primary-50); border: 1px solid var(--primary-200); border-radius: var(--radius-md);">
                <strong>æç¤ºï¼š</strong>ç°åœ¨æ”¯æŒåœ¨åå°ä¿å­˜AI Keyå¹¶å³æ—¶ç”Ÿæ•ˆï¼ˆæ— éœ€é‡å¯ï¼‰ã€‚è‹¥ä½¿ç”¨Verceléƒ¨ç½²ï¼Œä»éœ€åœ¨ç¯å¢ƒå˜é‡ä¸­åŒæ­¥é…ç½®ã€‚<br>
                <strong>é‡è¦ï¼š</strong>è¯·åŒºåˆ†ä¸¤ä¸ªä¸åŒçš„API Keyï¼Œé¿å…æ··ç”¨ï¼
              </div>
              
              <div class="form-group">
                <label>æ™ºè°±AI API Key - Evoæ™ºèƒ½åŠ©æ‰‹ï¼ˆåç§°ï¼šæ™ºé¸½ï¼‰</label>
                <div style="display: flex; gap: 8px;">
                  <input type="password" id="zhipuApiKeyEvo" class="form-control" placeholder="æœªé…ç½®" />
                  <button type="button" class="btn btn-outline btn-sm" onclick="alert('EvoåŠ©æ‰‹ Keyï¼šZHIPU_API_KEY_EVO\\nç”¨é€”ï¼šä¸»ç«™åŠ©æ‰‹\\næ¥æºï¼šopen.bigmodel.cn')">æŸ¥çœ‹é…ç½®è¯´æ˜</button>
                </div>
                <small class="form-text">ç”¨äºEvoæ™ºèƒ½åŠ©æ‰‹ï¼ˆä¸»ç«™AIåŠ©æ‰‹ï¼‰ã€‚è·å–åœ°å€ï¼š<a href="https://open.bigmodel.cn/" target="_blank">https://open.bigmodel.cn/</a></small>
              </div>
              
              <div class="form-group">
                <label>æ™ºè°±AI API Key - ä¸­æ¢ç®¡å®¶ï¼ˆåç§°ï¼šæ™ºé¸½Â·ä¸­æ¢ç®¡å®¶ï¼‰</label>
                <div style="display: flex; gap: 8px;">
                  <input type="password" id="zhipuApiKeyAdmin" class="form-control" placeholder="æœªé…ç½®" />
                  <button type="button" class="btn btn-outline btn-sm" onclick="alert('ç®¡å®¶ Keyï¼šZHIPU_API_KEY_ADMIN\\nç”¨é€”ï¼šä¸­æ¢ç®¡å®¶\\næ¥æºï¼šopen.bigmodel.cn')">æŸ¥çœ‹é…ç½®è¯´æ˜</button>
                </div>
                <small class="form-text">ç”¨äºä¸­æ¢ç®¡å®¶ç³»ç»Ÿï¼ˆæ™ºèƒ½AIç®¡ç†ï¼‰ã€‚è·å–åœ°å€ï¼š<a href="https://open.bigmodel.cn/" target="_blank">https://open.bigmodel.cn/</a></small>
              </div>
              
              <div class="form-group">
                <label>é€šä¹‰åƒé—® API Key</label>
                <div style="display: flex; gap: 8px;">
                  <input type="password" id="qwenApiKey" class="form-control" placeholder="æœªé…ç½®" />
                  <button type="button" class="btn btn-outline btn-sm" onclick="alert('é€šä¹‰ Keyï¼šQWEN_API_KEY\\nç”¨é€”ï¼šå¤‡é€‰æ¨¡å‹\\næ¥æºï¼šdashscope.aliyun.com')">æŸ¥çœ‹é…ç½®è¯´æ˜</button>
                </div>
                <small class="form-text">è·å–åœ°å€ï¼š<a href="https://dashscope.aliyun.com/" target="_blank">https://dashscope.aliyun.com/</a></small>
              </div>
              
              <div class="form-group">
                <label>Hugging Face API Key</label>
                <div style="display: flex; gap: 8px;">
                  <input type="password" id="huggingFaceApiKey" class="form-control" placeholder="æœªé…ç½®" />
                  <button type="button" class="btn btn-outline btn-sm" onclick="alert('HuggingFace Keyï¼šHUGGING_FACE_API_KEY\\nç”¨é€”ï¼šå¤‡é€‰æ¨¡å‹\\næ¥æºï¼šhuggingface.co')">æŸ¥çœ‹é…ç½®è¯´æ˜</button>
                </div>
                <small class="form-text">è·å–åœ°å€ï¼š<a href="https://huggingface.co/settings/tokens" target="_blank">https://huggingface.co/settings/tokens</a></small>
              </div>
              
              <div class="form-group">
                <label>AIæ¨¡å‹é€‰æ‹©</label>
                <select id="aiModel" class="form-control">
                  <option value="auto">è‡ªåŠ¨é€‰æ‹©ï¼ˆæ¨èï¼‰</option>
                  <option value="zhipu">æ™ºè°±AI</option>
                  <option value="qwen">é€šä¹‰åƒé—®</option>
                  <option value="huggingface">Hugging Face</option>
                </select>
                <small class="form-text">é€‰æ‹©ä½¿ç”¨çš„AIæœåŠ¡æä¾›å•†</small>
              </div>
              
              <div class="form-actions" style="margin-top: 24px; display:flex; gap:12px; flex-wrap:wrap;">
                <button type="button" class="btn btn-outline" id="btnSaveZhipuConfig">ä»…ä¿å­˜åˆ°æœ¬åœ°æµè§ˆå™¨</button>
                <button type="button" class="btn btn-primary" id="btnSaveAiSettings">ä¿å­˜åˆ°åå°å¹¶ç«‹å³ç”Ÿæ•ˆ</button>
                <div id="aiSettingsStatus" class="muted" style="display:none;"></div>
              </div>
            </div>
            
            <!-- æ•°æ®åº“é…ç½® -->
            <div id="settingsDatabase" class="settings-panel" style="display:none;">
              <h3 style="margin-bottom: 20px; color: var(--text-primary);">æ•°æ®åº“é…ç½®</h3>
              <p class="muted" style="margin-bottom: 24px;">é…ç½®Supabaseäº‘æ•°æ®åº“è¿æ¥ï¼ˆç”¨äºæ•°æ®æŒä¹…åŒ–ï¼‰</p>
              
              <div class="alert alert-warning" style="margin-bottom: 24px; padding: 16px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: var(--radius-md);">
                <strong>é‡è¦ï¼š</strong>é…ç½®Supabaseå¯ä»¥ç¡®ä¿æ•°æ®åœ¨Verceléƒ¨ç½²åä¸ä¸¢å¤±ã€‚è¯·åœ¨Vercelç¯å¢ƒå˜é‡ä¸­é…ç½®ã€‚
              </div>
              
              <div class="form-group">
                <label>Supabase URL</label>
                <div style="display: flex; gap: 8px;">
                  <input type="text" id="supabaseUrl" class="form-control" placeholder="https://xxx.supabase.co" readonly />
                  <button type="button" class="btn btn-outline btn-sm" onclick="alert('è¯·åœ¨Vercelç¯å¢ƒå˜é‡ä¸­é…ç½® SUPABASE_URL')">æŸ¥çœ‹é…ç½®è¯´æ˜</button>
                </div>
                <small class="form-text">Supabaseé¡¹ç›®URL</small>
              </div>
              
              <div class="form-group">
                <label>Supabase Anon Key</label>
                <div style="display: flex; gap: 8px;">
                  <input type="password" id="supabaseAnonKey" class="form-control" placeholder="å·²é…ç½®ï¼ˆå®‰å…¨éšè—ï¼‰" readonly />
                  <button type="button" class="btn btn-outline btn-sm" onclick="alert('è¯·åœ¨Vercelç¯å¢ƒå˜é‡ä¸­é…ç½® SUPABASE_ANON_KEY')">æŸ¥çœ‹é…ç½®è¯´æ˜</button>
                </div>
                <small class="form-text">SupabaseåŒ¿åå¯†é’¥</small>
              </div>
              
              <div class="form-actions" style="margin-top: 24px;">
                <button type="button" class="btn btn-outline" onclick="alert('æ•°æ®åº“é…ç½®éœ€è¦åœ¨Vercelç¯å¢ƒå˜é‡ä¸­è®¾ç½®ï¼Œè¯·å‚è€ƒã€Šæ•°æ®ä¿æŠ¤ä¸å‡çº§æŒ‡å—.mdã€‹')">æŸ¥çœ‹é…ç½®æŒ‡å—</button>
              </div>
            </div>
            
            <!-- çŠ¶æ€æç¤º -->
            <div id="settingsStatus" style="margin-top: 24px; padding: 12px; border-radius: var(--radius-md); display: none;"></div>
          </div>
        </div>
        
        <!-- Evoè®¾ç½® -->
        <div id="evoSettingsTab" class="card" style="display:none;">
          <div class="card-header">
            <h2>ğŸ•Šï¸ Evo æ™ºèƒ½åŠ©æ‰‹è®¾ç½®</h2>
          </div>
          <div class="card-body">
            <div class="form-section">
              <h3 style="margin-bottom: 16px; color: var(--text-primary);">åŸºæœ¬è®¾ç½®</h3>
              
              <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="evoEnabled" checked style="width: auto;">
                  <span>å¯ç”¨æ™ºèƒ½åŠ©æ‰‹</span>
                </label>
                <div class="form-hint">åœ¨ä¸»ç«™å’Œæ™ºèƒ½ç®¡ç†ç³»ç»Ÿæ˜¾ç¤ºEvoæ™ºèƒ½åŠ©æ‰‹</div>
              </div>
              
              <div class="form-group">
                <label>åŠ©æ‰‹ä½ç½®</label>
                <select id="evoPosition" style="width: 100%; padding: 8px; border: 1px solid var(--border-medium); border-radius: 6px;">
                  <option value="bottom-right">å³ä¸‹è§’</option>
                  <option value="bottom-left">å·¦ä¸‹è§’</option>
                  <option value="top-right">å³ä¸Šè§’</option>
                  <option value="top-left">å·¦ä¸Šè§’</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>æ˜¾ç¤ºæ¨¡å¼</label>
                <select id="evoDisplayMode" style="width: 100%; padding: 8px; border: 1px solid var(--border-medium); border-radius: 6px;">
                  <option value="always">å§‹ç»ˆæ˜¾ç¤º</option>
                  <option value="hover">é¼ æ ‡æ‚¬åœæ˜¾ç¤º</option>
                  <option value="click">ç‚¹å‡»æ˜¾ç¤º</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>è‡ªåŠ¨å…³é—­æ—¶é—´ï¼ˆç§’ï¼‰</label>
                <input type="number" id="evoAutoClose" value="5" min="0" max="60" style="width: 100%; padding: 8px; border: 1px solid var(--border-medium); border-radius: 6px;">
                <div class="form-hint">è®¾ç½®ä¸º0è¡¨ç¤ºä¸è‡ªåŠ¨å…³é—­</div>
              </div>
            </div>
            
            <div class="form-section" style="margin-top: 24px;">
              <h3 style="margin-bottom: 16px; color: var(--text-primary);">å¤–è§‚è®¾ç½®</h3>
              
              <div class="form-group">
                <label>å›¾æ ‡å¤§å°</label>
                <input type="range" id="evoIconSize" min="50" max="100" value="70" style="width: 100%;">
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                  <span>å°</span>
                  <span id="evoIconSizeValue">70px</span>
                  <span>å¤§</span>
                </div>
              </div>
              
              <div class="form-group">
                <label>ä¸»é¢˜é¢œè‰²</label>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                  <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                    <input type="radio" name="evoTheme" value="purple" checked>
                    <span style="display: inline-block; width: 24px; height: 24px; border-radius: 4px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></span>
                    <span>ç´«è‰²</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                    <input type="radio" name="evoTheme" value="blue">
                    <span style="display: inline-block; width: 24px; height: 24px; border-radius: 4px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);"></span>
                    <span>è“è‰²</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                    <input type="radio" name="evoTheme" value="green">
                    <span style="display: inline-block; width: 24px; height: 24px; border-radius: 4px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);"></span>
                    <span>ç»¿è‰²</span>
                  </label>
                </div>
              </div>
            </div>
            
            <div class="form-section" style="margin-top: 24px;">
              <h3 style="margin-bottom: 16px; color: var(--text-primary);">åŠŸèƒ½è®¾ç½®</h3>
              
              <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="evoShowWelcome" checked style="width: auto;">
                  <span>æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯</span>
                </label>
              </div>
              
              <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="evoSaveHistory" checked style="width: auto;">
                  <span>ä¿å­˜å¯¹è¯å†å²</span>
                </label>
              </div>
              
              <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="evoShowAnalytics" checked style="width: auto;">
                  <span>æ˜¾ç¤ºæ•°æ®åˆ†ææ ‡ç­¾</span>
                </label>
              </div>
              
              <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="evoShowRecommendations" checked style="width: auto;">
                  <span>æ˜¾ç¤ºæ™ºèƒ½æ¨èæ ‡ç­¾</span>
                </label>
              </div>
            </div>
            
            <div class="form-section" style="margin-top: 24px;">
              <h3 style="margin-bottom: 16px; color: var(--text-primary);">ğŸ¤– AI æ¨¡å‹ä¿¡æ¯</h3>
              
              <div style="background: var(--bg-secondary); border: 1px solid var(--border-medium); border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                <div id="evoAIModelInfo" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                  <div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">æ¨¡å‹åç§°</div>
                    <div id="evoAIModelName" style="font-size: 16px; font-weight: 600; color: var(--text-primary);">åŠ è½½ä¸­...</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">æœåŠ¡æä¾›å•†</div>
                    <div id="evoAIProvider" style="font-size: 16px; font-weight: 600; color: var(--text-primary);">åŠ è½½ä¸­...</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">ä½¿ç”¨çŠ¶æ€</div>
                    <div id="evoAIStatus" style="font-size: 14px; padding: 4px 12px; border-radius: 4px; display: inline-block; background: rgba(255, 152, 0, 0.3);">åŠ è½½ä¸­...</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">æ¨¡å‹æ¥æº</div>
                    <a id="evoAISource" href="#" target="_blank" style="font-size: 14px; color: var(--primary); text-decoration: none;">æŸ¥çœ‹è¯¦æƒ…</a>
                  </div>
                </div>
                
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-light);">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">æ¨¡å‹æè¿°</div>
                  <div id="evoAIDescription" style="font-size: 14px; color: var(--text-primary); line-height: 1.6;">åŠ è½½ä¸­...</div>
                </div>
                
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-light);">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">åŠŸèƒ½ç‰¹æ€§</div>
                  <div id="evoAIFeatures" style="font-size: 14px; color: var(--text-primary); line-height: 1.8;">åŠ è½½ä¸­...</div>
                </div>
                
                <div style="margin-top: 16px; display: flex; gap: 12px;">
                  <button type="button" class="btn btn-outline" id="btnEvoRefreshAIInfo" style="flex: 1;">ğŸ”„ åˆ·æ–°ä¿¡æ¯</button>
                  <button type="button" class="btn btn-outline" id="btnEvoTestAI" style="flex: 1;">ğŸ§ª æµ‹è¯•è¿æ¥</button>
                </div>
              </div>
              
              <div id="evoAIInfoStatus" style="margin-top: 12px; padding: 12px; border-radius: 6px; display: none; font-size: 14px;"></div>
            </div>
            
            <!-- æ™ºè°± API é…ç½®ï¼ˆæ•´åˆè‡ªæ™ºè°±APIé…ç½®é¢æ¿ï¼Œç”¨äºæ§åˆ¶ä¸»ç«™ Evoï¼‰ -->
            <div class="form-section" style="margin-top: 24px;">
              <h3 style="margin-bottom: 16px; color: var(--text-primary);">ğŸ”‘ æ™ºè°± API é…ç½®</h3>
              <p class="muted" style="margin-bottom: 16px;">é…ç½®ç”¨äºä¸»ç«™ Evo åŠ©æ‰‹è°ƒç”¨çš„æ™ºè°± AI å‚æ•°</p>
              
              <div class="form-group">
                <label>æ™ºè°±API Key <span class="required">*</span></label>
                <div style="display: flex; gap: 8px;">
                  <input type="password" id="zhipuApiKeyConfig" class="form-control" placeholder="è¯·è¾“å…¥æ™ºè°±API Key" />
                  <button type="button" class="btn btn-outline btn-sm" id="btnTestZhipuKey">éªŒè¯</button>
                </div>
                <small class="form-text">è·å–åœ°å€ï¼š<a href="https://open.bigmodel.cn/" target="_blank">https://open.bigmodel.cn/</a></small>
                <div id="zhipuKeyTestResult" style="margin-top: 8px; display: none;"></div>
              </div>
              
              <div class="form-group">
                <label>æ¨¡å‹é€‰æ‹©</label>
                <select id="zhipuModelConfig" class="form-control">
                  <option value="glm-4">GLM-4ï¼ˆæ¨èï¼‰</option>
                  <option value="glm-4-flash">GLM-4-Flashï¼ˆå¿«é€Ÿï¼‰</option>
                  <option value="glm-3-turbo">GLM-3-Turbo</option>
                </select>
                <small class="form-text">é»˜è®¤ä½¿ç”¨GLM-4æ¨¡å‹</small>
              </div>
              
              <div class="form-group">
                <label>Temperatureï¼ˆæ¸©åº¦ï¼‰</label>
                <input type="range" id="zhipuTemperatureConfig" min="0" max="1" step="0.1" value="0.7" class="form-control" />
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                  <span>0ï¼ˆç¡®å®šæ€§ï¼‰</span>
                  <span id="zhipuTemperatureValue">0.7</span>
                  <span>1ï¼ˆåˆ›é€ æ€§ï¼‰</span>
                </div>
                <small class="form-text">æ§åˆ¶å›å¤çš„éšæœºæ€§ï¼Œå€¼è¶Šå¤§è¶Šæœ‰åˆ›é€ æ€§</small>
              </div>
              
              <div class="form-group">
                <label>Max Tokensï¼ˆæœ€å¤§è¾“å‡ºé•¿åº¦ï¼‰</label>
                <input type="number" id="zhipuMaxTokensConfig" min="100" max="2000" step="100" value="2000" class="form-control" />
                <small class="form-text">é™åˆ¶AIå›å¤çš„æœ€å¤§é•¿åº¦ï¼ŒèŒƒå›´ï¼š100-2000</small>
              </div>
              
              <div class="form-actions" style="margin-top: 24px;">
                <button type="button" class="btn btn-outline" id="btnSaveZhipuConfig">ä»…ä¿å­˜åˆ°æœ¬åœ°æµè§ˆå™¨</button>
              </div>
              
              <div id="zhipuConfigStatus" style="margin-top: 16px; padding: 12px; border-radius: 6px; display: none;"></div>
            </div>
            
            <!-- åŠ©æ‰‹åŠŸèƒ½é…ç½®ï¼ˆæ•´åˆè‡ªåŠ©æ‰‹åŠŸèƒ½é…ç½®é¢æ¿ï¼Œç”¨äºæ§åˆ¶ä¸»ç«™ Evo è¡Œä¸ºï¼‰ -->
            <div class="form-section" style="margin-top: 24px;">
              <h3 style="margin-bottom: 16px; color: var(--text-primary);">ğŸ¤– åŠ©æ‰‹è¡Œä¸ºé…ç½®</h3>
              
              <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="assistantEnabledConfig" checked style="width: auto;" />
                  <span>å¯ç”¨åŠ©æ‰‹ç›´æ¥è°ƒç”¨APIåŠŸèƒ½</span>
                </label>
                <div class="form-hint">å…³é—­åï¼Œä¸»ç«™ Evo åŠ©æ‰‹å°†æ— æ³•è°ƒç”¨æ™ºè°±API</div>
              </div>
              
              <div class="form-group">
                <label>æ¬¢è¿è¯­</label>
                <textarea id="assistantWelcomeMessageConfig" class="form-control" rows="3" placeholder="ä½ å¥½ï¼æˆ‘æ˜¯æ™ºé¸½AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ"></textarea>
                <small class="form-text">åŠ©æ‰‹æ‰“å¼€æ—¶æ˜¾ç¤ºçš„æ¬¢è¿æ¶ˆæ¯</small>
                <div id="assistantWelcomePreview" style="margin-top: 8px; padding: 12px; background: var(--bg-tertiary); border-radius: 6px; display: none;">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">é¢„è§ˆï¼š</div>
                  <div id="assistantWelcomePreviewText" style="font-size: 14px; color: var(--text-primary);"></div>
                </div>
              </div>
              
              <div class="form-group">
                <label>é”™è¯¯æç¤º</label>
                <textarea id="assistantErrorMessageConfig" class="form-control" rows="2" placeholder="AIåŠ©æ‰‹æš‚æ—¶æ— æ³•å“åº”ï¼Œè¯·ç¨åå†è¯•ã€‚å¦‚é—®é¢˜æŒç»­ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚"></textarea>
                <small class="form-text">APIè°ƒç”¨å¤±è´¥æ—¶æ˜¾ç¤ºçš„é”™è¯¯æç¤º</small>
              </div>
              
              <div class="form-group">
                <label>å¯¹è¯å†å²ä¿ç•™æ—¶é•¿ï¼ˆå¤©ï¼‰</label>
                <input type="number" id="assistantHistoryDaysConfig" min="1" max="30" value="7" class="form-control" />
                <small class="form-text">æœ¬åœ°å­˜å‚¨çš„å¯¹è¯å†å²ä¿ç•™å¤©æ•°ï¼ŒèŒƒå›´ï¼š1-30å¤©</small>
              </div>
              
              <div class="form-actions" style="margin-top: 24px;">
                <button type="button" class="btn btn-outline" id="btnSaveAssistantConfig">ä¿å­˜åŠ©æ‰‹é…ç½®</button>
                <button type="button" class="btn btn-outline" id="btnSyncAssistantConfig">åŒæ­¥åˆ°PC/ç§»åŠ¨ç«¯</button>
              </div>
              
              <div id="assistantConfigStatus" style="margin-top: 16px; padding: 12px; border-radius: 6px; display: none;"></div>
            </div>
            
            <div class="form-section" style="margin-top: 24px;">
              <h3 style="margin-bottom: 16px; color: var(--text-primary);">GitHub èŠå¤©æœºå™¨äººé…ç½®</h3>
              
              <div class="form-group">
                <label>ä»“åº“åœ°å€</label>
                <input type="text" id="evoGithubRepo" placeholder="ä¾‹å¦‚: username/repo-name" style="width: 100%; padding: 8px; border: 1px solid var(--border-medium); border-radius: 6px;">
                <div class="form-hint">æ ¼å¼ï¼šç”¨æˆ·å/ä»“åº“å</div>
              </div>
              
              <div class="form-group">
                <label>Token</label>
                <input type="password" id="evoGithubToken" placeholder="GitHub Personal Access Token" style="width: 100%; padding: 8px; border: 1px solid var(--border-medium); border-radius: 6px;">
                <div class="form-hint">
                  <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--primary);">è·å– Token</a>
                </div>
              </div>
              
              <div class="form-group">
                <label>APIç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="evoGithubApiEndpoint" placeholder="ä¾‹å¦‚: https://your-app.vercel.app/api/chat" style="width: 100%; padding: 8px; border: 1px solid var(--border-medium); border-radius: 6px;">
                <div class="form-hint">å¦‚æœNext.jsåº”ç”¨å·²éƒ¨ç½²ï¼Œå¯ç›´æ¥æŒ‡å®šAPIç«¯ç‚¹</div>
              </div>
            </div>
            
            <div class="form-section" style="margin-top: 24px;">
              <h3 style="margin-bottom: 16px; color: var(--text-primary);">åŠŸèƒ½ä½¿ç”¨è¯´æ˜ç®¡ç†</h3>
              <div class="form-hint" style="margin-bottom: 16px; color: var(--text-secondary);">
                é…ç½®ä¸»ç«™å„åŠŸèƒ½æ¨¡å—çš„ä½¿ç”¨è¯´æ˜ï¼ŒåŠ©æ‰‹å°†ç»“åˆè¿™äº›è¯´æ˜å’ŒAIæ™ºèƒ½å›ç­”ç”¨æˆ·é—®é¢˜
              </div>
              
              <div id="functionGuidesContainer" style="display: grid; gap: 16px;">
                <!-- åŠŸèƒ½è¯´æ˜é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
              </div>
              
              <button type="button" class="btn btn-outline btn-sm" id="btnAddFunctionGuide" style="margin-top: 16px;">
                â• æ·»åŠ åŠŸèƒ½è¯´æ˜
              </button>
            </div>
            
            <div class="form-actions" style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border-light);">
              <button type="button" class="btn btn-primary" id="btnSaveEvoSettings">ä¿å­˜è®¾ç½®</button>
              <button type="button" class="btn btn-outline" id="btnResetEvoSettings">é‡ç½®ä¸ºé»˜è®¤</button>
              <button type="button" class="btn btn-outline" id="btnSyncEvoSettings">åŒæ­¥åˆ°ä¸»ç«™</button>
            </div>
            
            <div id="evoSettingsStatus" style="margin-top: 16px; padding: 12px; border-radius: 6px; display: none;"></div>
          </div>
        </div>
        
        
        <!-- ä¸­æ¢ç®¡å®¶æ ‡ç­¾é¡µ -->
        <div id="coreAdminViewTab" style="display:none;">
          <!-- é¡µé¢å¤´éƒ¨ - ä¼˜åŒ–è®¾è®¡ -->
          <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:20px;padding:40px;margin-bottom:32px;box-shadow:0 10px 40px rgba(102,126,234,0.3);position:relative;overflow:hidden;">
            <!-- è£…é¥°æ€§èƒŒæ™¯å…ƒç´  -->
            <div style="position:absolute;top:-60px;right:-60px;width:200px;height:200px;background:rgba(255,255,255,0.1);border-radius:50%;backdrop-filter:blur(20px);"></div>
            <div style="position:absolute;bottom:-40px;left:-40px;width:150px;height:150px;background:rgba(255,255,255,0.08);border-radius:50%;backdrop-filter:blur(20px);"></div>
            <div style="position:absolute;top:50%;right:20%;width:100px;height:100px;background:rgba(255,255,255,0.05);border-radius:50%;backdrop-filter:blur(20px);"></div>
            
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:24px;position:relative;z-index:1;">
              <div style="flex:1;min-width:300px;">
                <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;">
                  <div style="width:72px;height:72px;background:rgba(255,255,255,0.25);backdrop-filter:blur(20px);border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:40px;border:2px solid rgba(255,255,255,0.3);box-shadow:0 8px 24px rgba(0,0,0,0.15);">ğŸ¤–</div>
                  <div>
                    <h2 style="margin:0 0 6px 0;font-size:32px;font-weight:800;color:#fff;letter-spacing:-0.5px;text-shadow:0 2px 8px rgba(0,0,0,0.2);">
                      æ™ºé¸½Â·ä¸­æ¢ç®¡å®¶
                    </h2>
                    <p style="margin:0;color:rgba(255,255,255,0.95);font-size:15px;line-height:1.6;font-weight:400;">
                      ZhiPigeon Core Admin - AIé©±åŠ¨çš„æ™ºèƒ½æœºå™¨äººç®¡ç†å‘˜ç³»ç»Ÿ
                    </p>
                  </div>
                </div>
                <div style="display:flex;gap:20px;flex-wrap:wrap;margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.2);">
                  <div style="display:flex;align-items:center;gap:10px;color:rgba(255,255,255,0.95);font-size:14px;font-weight:500;">
                    <span style="width:8px;height:8px;background:#10b981;border-radius:50%;box-shadow:0 0 8px rgba(16,185,129,0.6);animation:pulse 2s ease-in-out infinite;"></span>
                    <span>ğŸ›¡ï¸ å®ˆæŠ¤æ•°æ®çœŸå®æ€§</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:10px;color:rgba(255,255,255,0.95);font-size:14px;font-weight:500;">
                    <span style="width:8px;height:8px;background:#3b82f6;border-radius:50%;box-shadow:0 0 8px rgba(59,130,246,0.6);animation:pulse 2s ease-in-out infinite;animation-delay:0.5s;"></span>
                    <span>âš¡ æ°¸è¿œåœ¨çº¿</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:10px;color:rgba(255,255,255,0.95);font-size:14px;font-weight:500;">
                    <span style="width:8px;height:8px;background:#f59e0b;border-radius:50%;box-shadow:0 0 8px rgba(245,158,11,0.6);animation:pulse 2s ease-in-out infinite;animation-delay:1s;"></span>
                    <span>ğŸ¯ æ‹¥æœ‰æœ€ç»ˆæ‰§è¡Œæƒ</span>
                  </div>
                </div>
              </div>
              <div style="display:flex;gap:16px;flex-wrap:wrap;">
                <div style="background:rgba(255,255,255,0.25);backdrop-filter:blur(20px);padding:16px 24px;border-radius:14px;border:2px solid rgba(255,255,255,0.3);box-shadow:0 4px 16px rgba(0,0,0,0.1);transition:all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.35)';this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.25)';this.style.transform='translateY(0)'">
                  <div style="font-size:11px;color:rgba(255,255,255,0.85);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">è¿è¡ŒçŠ¶æ€</div>
                  <div style="font-size:18px;font-weight:700;color:#fff;display:flex;align-items:center;gap:8px;">
                    <span style="width:10px;height:10px;background:#10b981;border-radius:50%;box-shadow:0 0 12px rgba(16,185,129,0.8);animation:pulse 2s ease-in-out infinite;"></span>
                    <span>åœ¨çº¿è¿è¡Œ</span>
                  </div>
                </div>
              </div>
            </div>
            
            <style>
              @keyframes pulse {
                0%, 100% { opacity: 1; transform: scale(1); }
                50% { opacity: 0.7; transform: scale(1.1); }
              }
            </style>
          </div>

          <!-- ç³»ç»ŸçŠ¶æ€å¡ç‰‡ -->
          <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:24px;margin-bottom:32px;">
            <div style="background:linear-gradient(135deg, #e6f0ff 0%, #dbeafe 100%);border-radius:16px;padding:24px;box-shadow:0 4px 20px rgba(59,130,246,0.15);border:2px solid rgba(59,130,246,0.2);transition:transform 0.3s ease,box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 30px rgba(59,130,246,0.25)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 20px rgba(59,130,246,0.15)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
                <div style="font-size:14px;font-weight:600;color:#1e40af;text-transform:uppercase;letter-spacing:0.5px;">ç³»ç»Ÿå¥åº·åº¦</div>
                <div style="font-size:24px;">ğŸ’™</div>
              </div>
              <div style="font-size:42px;font-weight:700;color:#1e293b;margin-bottom:8px;line-height:1;" id="coreAdminHealthScore">--</div>
              <div style="font-size:13px;color:#475569;font-weight:500;" id="coreAdminHealthStatus">æ£€æŸ¥ä¸­...</div>
            </div>
            
            <div style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border-radius:16px;padding:24px;box-shadow:0 4px 20px rgba(245,158,11,0.15);border:2px solid rgba(245,158,11,0.2);transition:transform 0.3s ease,box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 30px rgba(245,158,11,0.25)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 20px rgba(245,158,11,0.15)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
                <div style="font-size:14px;font-weight:600;color:#92400e;text-transform:uppercase;letter-spacing:0.5px;">APIå¥åº·ç‡</div>
                <div style="font-size:24px;">ğŸ’›</div>
              </div>
              <div style="font-size:42px;font-weight:700;color:#1e293b;margin-bottom:8px;line-height:1;" id="coreAdminApiHealth">--</div>
              <div style="font-size:13px;color:#475569;font-weight:500;">å®æ—¶ç›‘æ§ä¸­</div>
            </div>
            
            <div style="background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);border-radius:16px;padding:24px;box-shadow:0 4px 20px rgba(16,185,129,0.15);border:2px solid rgba(16,185,129,0.2);transition:transform 0.3s ease,box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 30px rgba(16,185,129,0.25)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 20px rgba(16,185,129,0.15)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
                <div style="font-size:14px;font-weight:600;color:#065f46;text-transform:uppercase;letter-spacing:0.5px;">æ•°æ®çœŸå®æ€§</div>
                <div style="font-size:24px;">ğŸ’š</div>
              </div>
              <div style="font-size:42px;font-weight:700;color:#1e293b;margin-bottom:8px;line-height:1;" id="coreAdminDataTruth">--</div>
              <div style="font-size:13px;color:#475569;font-weight:500;">å·²éªŒè¯é€šè¿‡</div>
            </div>
            
            <div style="background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);border-radius:16px;padding:24px;box-shadow:0 4px 20px rgba(236,72,153,0.15);border:2px solid rgba(236,72,153,0.2);transition:transform 0.3s ease,box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 30px rgba(236,72,153,0.25)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 20px rgba(236,72,153,0.15)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
                <div style="font-size:14px;font-weight:600;color:#9f1239;text-transform:uppercase;letter-spacing:0.5px;">AIè°ƒç”¨æ¬¡æ•°</div>
                <div style="font-size:24px;">ğŸ’œ</div>
              </div>
              <div style="font-size:42px;font-weight:700;color:#1e293b;margin-bottom:8px;line-height:1;" id="coreAdminAICalls">--</div>
              <div style="font-size:13px;color:#475569;font-weight:500;">ä»Šæ—¥ç»Ÿè®¡</div>
            </div>
          </div>

            <!-- æ¨¡å‹æ¥å…¥ä¿¡æ¯ -->
            <div class="card" style="margin-bottom:32px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08);">
              <div class="card-header" style="border-bottom:2px solid #f1f5f9;padding-bottom:20px;">
                <h3 style="margin:0;font-size:20px;font-weight:700;color:#1e293b;display:flex;align-items:center;gap:10px;">
                  <span style="font-size:24px;">ğŸ¤–</span>
                  <span>æ¨¡å‹æ¥å…¥ä¿¡æ¯</span>
                </h3>
                <button class="btn btn-sm btn-outline" id="btnRefreshModelInfo" style="border-radius:8px;padding:8px 16px;">ğŸ”„ åˆ·æ–°</button>
              </div>
              <div id="coreAdminModelInfo" style="padding:28px;">
                <!-- ä¸»è¦ä¿¡æ¯å¡ç‰‡ -->
                <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));gap:20px;margin-bottom:28px;">
                  <div style="background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);border-radius:12px;padding:20px;border:1px solid #e2e8f0;transition:all 0.3s ease;" onmouseover="this.style.borderColor='#cbd5e1';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'" onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:40px;height:40px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;">ğŸ¢</div>
                      <div>
                        <div style="font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">æœåŠ¡æä¾›å•†</div>
                        <div id="coreAdminModelProvider" style="font-size:18px;font-weight:700;color:#1e293b;margin-top:4px;">åŠ è½½ä¸­...</div>
                      </div>
                    </div>
                  </div>
                  
                  <div style="background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);border-radius:12px;padding:20px;border:1px solid #e2e8f0;transition:all 0.3s ease;" onmouseover="this.style.borderColor='#cbd5e1';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'" onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:40px;height:40px;background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;">ğŸ§ </div>
                      <div>
                        <div style="font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">æ¨¡å‹åç§°</div>
                        <div id="coreAdminModelName" style="font-size:18px;font-weight:700;color:#1e293b;margin-top:4px;">åŠ è½½ä¸­...</div>
                      </div>
                    </div>
                  </div>
                  
                  <div style="background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);border-radius:12px;padding:20px;border:1px solid #e2e8f0;transition:all 0.3s ease;" onmouseover="this.style.borderColor='#cbd5e1';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'" onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:40px;height:40px;background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;">ğŸ”‘</div>
                      <div style="flex:1;">
                        <div style="font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;margin-bottom:8px;">API KeyçŠ¶æ€</div>
                        <div id="coreAdminApiKeyStatus" style="font-size:13px;padding:6px 14px;border-radius:8px;display:inline-block;font-weight:600;">åŠ è½½ä¸­...</div>
                      </div>
                    </div>
                  </div>
                  
                  <div style="background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);border-radius:12px;padding:20px;border:1px solid #e2e8f0;transition:all 0.3s ease;" onmouseover="this.style.borderColor='#cbd5e1';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'" onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:40px;height:40px;background:linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;">ğŸ”Œ</div>
                      <div style="flex:1;">
                        <div style="font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;margin-bottom:8px;">è¿æ¥çŠ¶æ€</div>
                        <div id="coreAdminConnectionStatus" style="font-size:13px;padding:6px 14px;border-radius:8px;display:inline-block;font-weight:600;">åŠ è½½ä¸­...</div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- é…ç½®è¯¦æƒ… -->
                <div style="background:#f8fafc;border-radius:12px;padding:24px;margin-bottom:24px;border:1px solid #e2e8f0;">
                  <div style="font-size:14px;font-weight:700;color:#1e293b;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                    <span>âš™ï¸</span>
                    <span>é…ç½®è¯¦æƒ…</span>
                  </div>
                  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));gap:20px;">
                    <div>
                      <div style="font-size:12px;color:#64748b;margin-bottom:6px;font-weight:500;">API Keyé¢„è§ˆ</div>
                      <div id="coreAdminApiKeyPreview" style="font-size:13px;color:#475569;font-family:'Monaco','Menlo','Courier New',monospace;background:#fff;padding:8px 12px;border-radius:6px;border:1px solid #e2e8f0;">--</div>
                    </div>
                    <div>
                      <div style="font-size:12px;color:#64748b;margin-bottom:6px;font-weight:500;">APIç«¯ç‚¹</div>
                      <div id="coreAdminApiBase" style="font-size:13px;color:#475569;font-family:'Monaco','Menlo','Courier New',monospace;background:#fff;padding:8px 12px;border-radius:6px;border:1px solid #e2e8f0;word-break:break-all;">--</div>
                    </div>
                    <div>
                      <div style="font-size:12px;color:#64748b;margin-bottom:6px;font-weight:500;">æ¯å°æ—¶æœ€å¤§è°ƒç”¨</div>
                      <div id="coreAdminMaxCalls" style="font-size:16px;font-weight:600;color:#1e293b;background:#fff;padding:8px 12px;border-radius:6px;border:1px solid #e2e8f0;">--</div>
                    </div>
                    <div>
                      <div style="font-size:12px;color:#64748b;margin-bottom:6px;font-weight:500;">ç½®ä¿¡åº¦é˜ˆå€¼</div>
                      <div id="coreAdminConfidence" style="font-size:16px;font-weight:600;color:#1e293b;background:#fff;padding:8px 12px;border-radius:6px;border:1px solid #e2e8f0;">--</div>
                    </div>
                  </div>
                </div>
                
                <!-- è°ƒç”¨ç»Ÿè®¡ -->
                <div style="background:linear-gradient(135deg, #667eea15 0%, #764ba215 100%);border-radius:12px;padding:24px;border:1px solid rgba(102,126,234,0.2);">
                  <div style="font-size:16px;font-weight:700;color:#1e293b;margin-bottom:20px;display:flex;align-items:center;gap:10px;">
                    <span style="font-size:20px;">ğŸ“Š</span>
                    <span>è°ƒç”¨ç»Ÿè®¡</span>
                  </div>
                  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:20px;">
                    <div style="background:#fff;border-radius:10px;padding:20px;border:1px solid #e2e8f0;text-align:center;">
                      <div style="font-size:12px;color:#64748b;margin-bottom:8px;font-weight:500;">æ€»è°ƒç”¨æ¬¡æ•°</div>
                      <div id="coreAdminTotalCalls" style="font-size:28px;font-weight:700;color:#667eea;line-height:1;">--</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:20px;border:1px solid #e2e8f0;text-align:center;">
                      <div style="font-size:12px;color:#64748b;margin-bottom:8px;font-weight:500;">æœ€è¿‘1å°æ—¶</div>
                      <div id="coreAdminRecentCalls" style="font-size:28px;font-weight:700;color:#f5576c;line-height:1;">--</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:20px;border:1px solid #e2e8f0;text-align:center;">
                      <div style="font-size:12px;color:#64748b;margin-bottom:8px;font-weight:500;">æˆåŠŸç‡</div>
                      <div id="coreAdminSuccessRate" style="font-size:28px;font-weight:700;color:#43e97b;line-height:1;">--</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:20px;border:1px solid #e2e8f0;text-align:center;">
                      <div style="font-size:12px;color:#64748b;margin-bottom:8px;font-weight:500;">å¹³å‡ç½®ä¿¡åº¦</div>
                      <div id="coreAdminAvgConfidence" style="font-size:28px;font-weight:700;color:#4facfe;line-height:1;">--</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- åŠŸèƒ½æ¨¡å—åŒºåŸŸ - ä¼˜åŒ–å¸ƒå±€ -->
            <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:24px;margin-bottom:24px;">
              <!-- AIç®¡ç†å»ºè®® -->
              <div class="card" style="margin-bottom:0;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08);transition:all 0.3s ease;background:linear-gradient(135deg, #fff 0%, #fef3c7 5%);border:1px solid rgba(245,158,11,0.1);" onmouseover="this.style.boxShadow='0 8px 30px rgba(245,158,11,0.2)';this.style.transform='translateY(-4px)';this.style.borderColor='rgba(245,158,11,0.3)'" onmouseout="this.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)';this.style.transform='translateY(0)';this.style.borderColor='rgba(245,158,11,0.1)'">
                <div class="card-header" style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border-bottom:2px solid #fbbf24;padding-bottom:20px;border-radius:16px 16px 0 0;">
                  <h3 style="margin:0;font-size:18px;font-weight:700;color:#78350f;display:flex;align-items:center;gap:10px;">
                    <span style="width:36px;height:36px;background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;">ğŸ’¡</span>
                    <span>AIç®¡ç†å»ºè®®</span>
                  </h3>
                  <button class="btn btn-sm btn-primary" id="btnRefreshAdvice" style="border-radius:8px;padding:8px 16px;background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);border:none;color:#fff;font-weight:600;box-shadow:0 2px 8px rgba(245,158,11,0.3);">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div id="coreAdminAdvice" style="padding:24px;min-height:200px;">
                  <p class="muted" style="text-align:center;color:#94a3b8;padding:40px 0;">æ­£åœ¨è·å–AIç®¡ç†å»ºè®®...</p>
                </div>
              </div>

              <!-- æ•°æ®åˆ†æ -->
              <div class="card" style="margin-bottom:0;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08);transition:all 0.3s ease;background:linear-gradient(135deg, #fff 0%, #dbeafe 5%);border:1px solid rgba(59,130,246,0.1);" onmouseover="this.style.boxShadow='0 8px 30px rgba(59,130,246,0.2)';this.style.transform='translateY(-4px)';this.style.borderColor='rgba(59,130,246,0.3)'" onmouseout="this.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)';this.style.transform='translateY(0)';this.style.borderColor='rgba(59,130,246,0.1)'">
                <div class="card-header" style="background:linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);border-bottom:2px solid #3b82f6;padding-bottom:20px;border-radius:16px 16px 0 0;">
                  <h3 style="margin:0;font-size:18px;font-weight:700;color:#1e3a8a;display:flex;align-items:center;gap:10px;">
                    <span style="width:36px;height:36px;background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;">ğŸ“Š</span>
                    <span>æ•°æ®åˆ†æ</span>
                  </h3>
                  <button class="btn btn-sm btn-outline" id="btnRefreshAnalytics" style="border-radius:8px;padding:8px 16px;border-color:#3b82f6;color:#3b82f6;font-weight:600;">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div id="coreAdminAnalytics" style="padding:24px;min-height:200px;">
                  <p class="muted" style="text-align:center;color:#94a3b8;padding:40px 0;">æ­£åœ¨åŠ è½½æ•°æ®åˆ†æ...</p>
                </div>
              </div>
            </div>

            <!-- APIç›‘ç®¡ - å…¨å®½æ˜¾ç¤º -->
            <div class="card" style="margin-bottom:24px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08);transition:all 0.3s ease;background:linear-gradient(135deg, #fff 0%, #e0e7ff 5%);border:1px solid rgba(99,102,241,0.1);" onmouseover="this.style.boxShadow='0 8px 30px rgba(99,102,241,0.2)';this.style.transform='translateY(-4px)';this.style.borderColor='rgba(99,102,241,0.3)'" onmouseout="this.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)';this.style.transform='translateY(0)';this.style.borderColor='rgba(99,102,241,0.1)'">
              <div class="card-header" style="background:linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);border-bottom:2px solid #6366f1;padding-bottom:20px;border-radius:16px 16px 0 0;">
                <h3 style="margin:0;font-size:18px;font-weight:700;color:#312e81;display:flex;align-items:center;gap:10px;">
                  <span style="width:36px;height:36px;background:linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;">ğŸ”</span>
                  <span>APIç›‘ç®¡</span>
                </h3>
                <button class="btn btn-sm btn-outline" id="btnRefreshApis" style="border-radius:8px;padding:8px 16px;border-color:#6366f1;color:#6366f1;font-weight:600;">ğŸ”„ åˆ·æ–°</button>
              </div>
              <div id="coreAdminApiList" style="padding:24px;">
                <p class="muted" style="text-align:center;color:#94a3b8;padding:40px 0;">æ­£åœ¨åŠ è½½APIåˆ—è¡¨...</p>
              </div>
            </div>

            <!-- å­¦ä¹ ç³»ç»Ÿä¸è‡ªåŠ¨ç»´æŠ¤ -->
            <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:24px;">
              <!-- å­¦ä¹ ç³»ç»Ÿ -->
              <div class="card" style="margin-bottom:0;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08);transition:all 0.3s ease;background:linear-gradient(135deg, #fff 0%, #f3e8ff 5%);border:1px solid rgba(168,85,247,0.1);" onmouseover="this.style.boxShadow='0 8px 30px rgba(168,85,247,0.2)';this.style.transform='translateY(-4px)';this.style.borderColor='rgba(168,85,247,0.3)'" onmouseout="this.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)';this.style.transform='translateY(0)';this.style.borderColor='rgba(168,85,247,0.1)'">
                <div class="card-header" style="background:linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);border-bottom:2px solid #a855f7;padding-bottom:20px;border-radius:16px 16px 0 0;">
                  <h3 style="margin:0;font-size:18px;font-weight:700;color:#581c87;display:flex;align-items:center;gap:10px;">
                    <span style="width:36px;height:36px;background:linear-gradient(135deg, #a855f7 0%, #9333ea 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;">ğŸ§ </span>
                    <span>å­¦ä¹ ç³»ç»Ÿ</span>
                  </h3>
                  <button class="btn btn-sm btn-outline" id="btnRefreshLearning" style="border-radius:8px;padding:8px 16px;border-color:#a855f7;color:#a855f7;font-weight:600;">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div id="coreAdminLearning" style="padding:24px;min-height:200px;">
                  <p class="muted" style="text-align:center;color:#94a3b8;padding:40px 0;">æ­£åœ¨åŠ è½½å­¦ä¹ æ•°æ®...</p>
                </div>
              </div>

              <!-- è‡ªåŠ¨ç»´æŠ¤ -->
              <div class="card" style="margin-bottom:0;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08);transition:all 0.3s ease;background:linear-gradient(135deg, #fff 0%, #fef3c7 5%);border:1px solid rgba(245,158,11,0.1);" onmouseover="this.style.boxShadow='0 8px 30px rgba(245,158,11,0.2)';this.style.transform='translateY(-4px)';this.style.borderColor='rgba(245,158,11,0.3)'" onmouseout="this.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)';this.style.transform='translateY(0)';this.style.borderColor='rgba(245,158,11,0.1)'">
                <div class="card-header" style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border-bottom:2px solid #f59e0b;padding-bottom:20px;border-radius:16px 16px 0 0;">
                  <h3 style="margin:0;font-size:18px;font-weight:700;color:#78350f;display:flex;align-items:center;gap:10px;">
                    <span style="width:36px;height:36px;background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;">ğŸ”§</span>
                    <span>è‡ªåŠ¨ç»´æŠ¤</span>
                  </h3>
                  <button class="btn btn-sm btn-outline" id="btnRefreshMaintenance" style="border-radius:8px;padding:8px 16px;border-color:#f59e0b;color:#f59e0b;font-weight:600;">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div id="coreAdminMaintenance" style="padding:24px;min-height:200px;">
                  <p class="muted" style="text-align:center;color:#94a3b8;padding:40px 0;">æ­£åœ¨åŠ è½½ç»´æŠ¤ä¿¡æ¯...</p>
                </div>
              </div>
            </div>

            <!-- æ™ºèƒ½åŠŸèƒ½æ¨¡å— -->
            <div class="card" style="margin-top:32px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08);background:linear-gradient(135deg, #fff 0%, #f0f9ff 5%);border:2px solid rgba(14,165,233,0.2);">
              <div class="card-header" style="background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);border-bottom:2px solid #0ea5e9;padding-bottom:20px;border-radius:16px 16px 0 0;">
                <h3 style="margin:0;font-size:20px;font-weight:700;color:#0c4a6e;display:flex;align-items:center;gap:10px;">
                  <span style="width:40px;height:40px;background:linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;color:#fff;">ğŸ§ </span>
                  <span>æ™ºèƒ½åŠŸèƒ½æ¨¡å—</span>
                </h3>
                <p style="margin:8px 0 0 0;font-size:13px;color:#0369a1;font-weight:500;">AIé©±åŠ¨çš„æ™ºèƒ½ç®¡ç†åŠŸèƒ½</p>
              </div>
              <div style="padding:28px;">
                <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:20px;">
                  <!-- å†³ç­–å¼•æ“ -->
                  <div style="background:#fff;border-radius:12px;padding:20px;border:2px solid #e0f2fe;transition:all 0.3s ease;cursor:pointer;" 
                       onmouseover="this.style.borderColor='#0ea5e9';this.style.boxShadow='0 4px 12px rgba(14,165,233,0.2)';this.style.transform='translateY(-2px)'" 
                       onmouseout="this.style.borderColor='#e0f2fe';this.style.boxShadow='none';this.style.transform='translateY(0)'"
                       onclick="loadIntelligentAdvice()">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:48px;height:48px;background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;">âš¡</div>
                      <div style="flex:1;">
                        <h4 style="margin:0;font-size:16px;font-weight:700;color:#1e293b;">å†³ç­–å¼•æ“</h4>
                        <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">æ™ºèƒ½å†³ç­–å»ºè®®</p>
                      </div>
                    </div>
                    <div id="intelligentAdvicePreview" style="font-size:13px;color:#475569;line-height:1.5;min-height:40px;">ç‚¹å‡»æŸ¥çœ‹æ™ºèƒ½å»ºè®®</div>
                  </div>

                  <!-- é¢„æµ‹ç»´æŠ¤ -->
                  <div style="background:#fff;border-radius:12px;padding:20px;border:2px solid #fef3c7;transition:all 0.3s ease;cursor:pointer;" 
                       onmouseover="this.style.borderColor='#f59e0b';this.style.boxShadow='0 4px 12px rgba(245,158,11,0.2)';this.style.transform='translateY(-2px)'" 
                       onmouseout="this.style.borderColor='#fef3c7';this.style.boxShadow='none';this.style.transform='translateY(0)'"
                       onclick="loadIntelligentPredictions()">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:48px;height:48px;background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;">ğŸ”®</div>
                      <div style="flex:1;">
                        <h4 style="margin:0;font-size:16px;font-weight:700;color:#1e293b;">é¢„æµ‹ç»´æŠ¤</h4>
                        <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">é¢„æµ‹ç³»ç»Ÿé—®é¢˜</p>
                      </div>
                    </div>
                    <div id="intelligentPredictionsPreview" style="font-size:13px;color:#475569;line-height:1.5;min-height:40px;">ç‚¹å‡»æŸ¥çœ‹é¢„æµ‹ä¿¡æ¯</div>
                  </div>

                  <!-- å·¥ä½œæµå¼•æ“ -->
                  <div style="background:#fff;border-radius:12px;padding:20px;border:2px solid #dbeafe;transition:all 0.3s ease;cursor:pointer;" 
                       onmouseover="this.style.borderColor='#3b82f6';this.style.boxShadow='0 4px 12px rgba(59,130,246,0.2)';this.style.transform='translateY(-2px)'" 
                       onmouseout="this.style.borderColor='#dbeafe';this.style.boxShadow='none';this.style.transform='translateY(0)'"
                       onclick="loadIntelligentWorkflows()">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:48px;height:48px;background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;">ğŸ”„</div>
                      <div style="flex:1;">
                        <h4 style="margin:0;font-size:16px;font-weight:700;color:#1e293b;">å·¥ä½œæµå¼•æ“</h4>
                        <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">è‡ªåŠ¨åŒ–å·¥ä½œæµ</p>
                      </div>
                    </div>
                    <div id="intelligentWorkflowsPreview" style="font-size:13px;color:#475569;line-height:1.5;min-height:40px;">ç‚¹å‡»æŸ¥çœ‹å·¥ä½œæµ</div>
                  </div>

                  <!-- å‘Šè­¦ç³»ç»Ÿ -->
                  <div style="background:#fff;border-radius:12px;padding:20px;border:2px solid #fee2e2;transition:all 0.3s ease;cursor:pointer;" 
                       onmouseover="this.style.borderColor='#ef4444';this.style.boxShadow='0 4px 12px rgba(239,68,68,0.2)';this.style.transform='translateY(-2px)'" 
                       onmouseout="this.style.borderColor='#fee2e2';this.style.boxShadow='none';this.style.transform='translateY(0)'"
                       onclick="loadIntelligentAlerts()">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:48px;height:48px;background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;">ğŸš¨</div>
                      <div style="flex:1;">
                        <h4 style="margin:0;font-size:16px;font-weight:700;color:#1e293b;">å‘Šè­¦ç³»ç»Ÿ</h4>
                        <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">æ™ºèƒ½å‘Šè­¦ç®¡ç†</p>
                      </div>
                    </div>
                    <div id="intelligentAlertsPreview" style="font-size:13px;color:#475569;line-height:1.5;min-height:40px;">ç‚¹å‡»æŸ¥çœ‹å‘Šè­¦</div>
                  </div>

                  <!-- è‡ªé€‚åº”ä¼˜åŒ– -->
                  <div style="background:#fff;border-radius:12px;padding:20px;border:2px solid #d1fae5;transition:all 0.3s ease;cursor:pointer;" 
                       onmouseover="this.style.borderColor='#10b981';this.style.boxShadow='0 4px 12px rgba(16,185,129,0.2)';this.style.transform='translateY(-2px)'" 
                       onmouseout="this.style.borderColor='#d1fae5';this.style.boxShadow='none';this.style.transform='translateY(0)'"
                       onclick="loadIntelligentOptimization()">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:48px;height:48px;background:linear-gradient(135deg, #10b981 0%, #059669 100%);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;">âš™ï¸</div>
                      <div style="flex:1;">
                        <h4 style="margin:0;font-size:16px;font-weight:700;color:#1e293b;">è‡ªé€‚åº”ä¼˜åŒ–</h4>
                        <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">è‡ªåŠ¨æ€§èƒ½ä¼˜åŒ–</p>
                      </div>
                    </div>
                    <div id="intelligentOptimizationPreview" style="font-size:13px;color:#475569;line-height:1.5;min-height:40px;">ç‚¹å‡»æŸ¥çœ‹ä¼˜åŒ–çŠ¶æ€</div>
                  </div>

                  <!-- çŸ¥è¯†å›¾è°± -->
                  <div style="background:#fff;border-radius:12px;padding:20px;border:2px solid #f3e8ff;transition:all 0.3s ease;cursor:pointer;" 
                       onmouseover="this.style.borderColor='#a855f7';this.style.boxShadow='0 4px 12px rgba(168,85,247,0.2)';this.style.transform='translateY(-2px)'" 
                       onmouseout="this.style.borderColor='#f3e8ff';this.style.boxShadow='none';this.style.transform='translateY(0)'"
                       onclick="loadIntelligentKnowledge()">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:48px;height:48px;background:linear-gradient(135deg, #a855f7 0%, #9333ea 100%);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;">ğŸ•¸ï¸</div>
                      <div style="flex:1;">
                        <h4 style="margin:0;font-size:16px;font-weight:700;color:#1e293b;">çŸ¥è¯†å›¾è°±</h4>
                        <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">æ™ºèƒ½çŸ¥è¯†æŸ¥è¯¢</p>
                      </div>
                    </div>
                    <div id="intelligentKnowledgePreview" style="font-size:13px;color:#475569;line-height:1.5;min-height:40px;">ç‚¹å‡»æŸ¥è¯¢çŸ¥è¯†å›¾è°±</div>
                  </div>

                  <!-- æ™ºèƒ½æŠ¥å‘Š -->
                  <div style="background:#fff;border-radius:12px;padding:20px;border:2px solid #fce7f3;transition:all 0.3s ease;cursor:pointer;" 
                       onmouseover="this.style.borderColor='#ec4899';this.style.boxShadow='0 4px 12px rgba(236,72,153,0.2)';this.style.transform='translateY(-2px)'" 
                       onmouseout="this.style.borderColor='#fce7f3';this.style.boxShadow='none';this.style.transform='translateY(0)'"
                       onclick="loadIntelligentReports()">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:48px;height:48px;background:linear-gradient(135deg, #ec4899 0%, #db2777 100%);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;">ğŸ“Š</div>
                      <div style="flex:1;">
                        <h4 style="margin:0;font-size:16px;font-weight:700;color:#1e293b;">æ™ºèƒ½æŠ¥å‘Š</h4>
                        <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">AIç”ŸæˆæŠ¥å‘Š</p>
                      </div>
                    </div>
                    <div id="intelligentReportsPreview" style="font-size:13px;color:#475569;line-height:1.5;min-height:40px;">ç‚¹å‡»æŸ¥çœ‹æŠ¥å‘Š</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- å…¬å‘Šç¼–è¾‘æ¨¡æ€æ¡† -->
  <div id="announcementModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">å‘å¸ƒæ–°å…¬å‘Š</h3>
        <button class="btn btn-ghost btn-sm" id="closeModalBtn">âœ•</button>
      </div>
      <form id="announcementForm">
        <input type="hidden" id="announcementId" />
        <div class="form-group">
          <label>å…¬å‘Šå†…å®¹ <span class="required">*</span></label>
          <textarea id="announcementContent" rows="6" placeholder="è¯·è¾“å…¥å…¬å‘Šå†…å®¹..." required style="font-family: inherit;"></textarea>
        </div>
        <div class="form-group">
          <label style="flex-direction: row; align-items: center; cursor: pointer;">
            <input type="checkbox" id="announcementActive" checked style="width: auto; margin-right: 8px;" /> 
            <span>ç«‹å³å‘å¸ƒï¼ˆå–æ¶ˆå‹¾é€‰åˆ™ä¿å­˜ä¸ºè‰ç¨¿ï¼‰</span>
          </label>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-outline" id="cancelBtn">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- ç”¨æˆ·ä¿¡æ¯æ¨¡æ€æ¡† -->
  <div class="announcement-modal" id="userInfoModal" style="display:none;">
    <div class="announcement-modal-content" style="max-width:500px;">
      <div class="announcement-modal-header">
        <h3 class="announcement-modal-title">
          <span>ğŸ‘¤</span>
          <span>è´¦æˆ·ä¿¡æ¯</span>
        </h3>
        <button class="announcement-modal-close" onclick="closeUserInfoModal()">Ã—</button>
      </div>
      <div class="announcement-modal-body">
        <!-- æŸ¥çœ‹æ¨¡å¼ -->
        <div id="userInfoViewMode">
          <div style="text-align:center;padding:20px 0;">
            <div style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);margin:0 auto 20px;display:flex;align-items:center;justify-content:center;font-size:40px;color:#fff;box-shadow:0 4px 12px rgba(102,126,234,0.3);background-size:cover;background-position:center;background-repeat:no-repeat;" id="userAvatarDisplay">ğŸ‘¤</div>
            <h4 style="margin:0 0 10px;font-size:18px;color:#1f2937;" id="userNameDisplay">ç”¨æˆ·å</h4>
            <p style="margin:0;color:#6b7280;font-size:14px;" id="userEmailDisplay">user@example.com</p>
          </div>
          <div style="border-top:1px solid #e5e7eb;padding:20px 0;">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f3f4f6;">
              <span style="color:#6b7280;font-size:14px;">è´¦æˆ·ç±»å‹</span>
              <span style="color:#1f2937;font-weight:600;font-size:14px;" id="userTypeDisplay">ç®¡ç†å‘˜</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f3f4f6;">
              <span style="color:#6b7280;font-size:14px;">æ³¨å†Œæ—¶é—´</span>
              <span style="color:#1f2937;font-weight:600;font-size:14px;" id="userRegisterDate">2024-01-01</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;">
              <span style="color:#6b7280;font-size:14px;">æƒé™çº§åˆ«</span>
              <span style="color:#1f2937;font-weight:600;font-size:14px;" id="userRoleDisplay">ç®¡ç†å‘˜</span>
            </div>
          </div>
          <div style="padding-top:20px;border-top:1px solid #e5e7eb;display:flex;gap:10px;">
            <button class="btn btn-primary" style="flex:1;" onclick="enterEditUserInfoMode()">âœï¸ ç¼–è¾‘èµ„æ–™</button>
            <button class="btn btn-outline" style="flex:1;" onclick="closeUserInfoModal(); showSettingsModal();">âš™ï¸ ç³»ç»Ÿè®¾ç½®</button>
            <button class="btn btn-outline" style="flex:1;" onclick="closeUserInfoModal()">å…³é—­</button>
          </div>
        </div>
        
        <!-- ç¼–è¾‘æ¨¡å¼ -->
        <div id="userInfoEditMode" style="display:none;">
          <div style="text-align:center;padding:20px 0;">
            <div style="position:relative;display:inline-block;margin-bottom:20px;">
              <div style="width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);margin:0 auto;display:flex;align-items:center;justify-content:center;font-size:50px;color:#fff;box-shadow:0 4px 12px rgba(102,126,234,0.3);background-size:cover;background-position:center;background-repeat:no-repeat;border:3px solid #fff;" id="userAvatarEditDisplay">ğŸ‘¤</div>
              <label for="userAvatarInput" style="position:absolute;bottom:0;right:0;width:36px;height:36px;background:#2563eb;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 8px rgba(37,99,235,0.3);border:3px solid #fff;">
                <span style="font-size:18px;">ğŸ“·</span>
              </label>
              <input type="file" id="userAvatarInput" accept="image/*" style="display:none;" />
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;text-align:left;margin-bottom:8px;color:#6b7280;font-size:14px;font-weight:600;">æ˜µç§°</label>
              <input type="text" id="userNameInput" placeholder="è¯·è¾“å…¥æ˜µç§°" style="width:100%;padding:10px 12px;border-radius:8px;border:2px solid #e5e7eb;font-size:14px;outline:none;transition:border-color 0.2s;" />
              <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;text-align:left;">æ˜µç§°å°†æ˜¾ç¤ºåœ¨è´¦æˆ·ç•Œé¢å’Œé¡¶éƒ¨å¯¼èˆªæ </p>
            </div>
          </div>
          <div style="padding-top:20px;border-top:1px solid #e5e7eb;display:flex;gap:10px;">
            <button class="btn btn-primary" style="flex:1;" onclick="saveUserInfo()">ğŸ’¾ ä¿å­˜</button>
            <button class="btn btn-outline" style="flex:1;" onclick="cancelEditUserInfo()">å–æ¶ˆ</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- è®¾ç½®æ¨¡æ€æ¡† -->
  <div class="announcement-modal" id="settingsModal" style="display:none;">
    <div class="announcement-modal-content" style="max-width:600px;max-height:80vh;overflow-y:auto;">
      <div class="announcement-modal-header">
        <h3 class="announcement-modal-title">
          <span>âš™ï¸</span>
          <span>è®¾ç½®</span>
        </h3>
        <button class="announcement-modal-close" onclick="closeSettingsModal()">Ã—</button>
      </div>
      <div class="announcement-modal-body">
        <div style="padding:24px 0;">
          <!-- å¤–è§‚è®¾ç½® -->
          <div style="margin-bottom:32px;">
            <h4 style="margin:0 0 16px;font-size:14px;font-weight:600;color:#1f2937;text-transform:uppercase;letter-spacing:0.5px;">ğŸ¨ å¤–è§‚è®¾ç½®</h4>
            <div style="background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);border-radius:12px;padding:20px;border:1px solid #e2e8f0;">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div style="font-size:15px;font-weight:500;color:#1e293b;margin-bottom:4px;">ä¸»é¢˜æ¨¡å¼</div>
                  <div style="font-size:12px;color:#64748b;">åˆ‡æ¢æµ…è‰²/æ·±è‰²ä¸»é¢˜</div>
                </div>
                <button class="btn btn-sm" id="btnToggleThemeInModal" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;padding:10px 20px;border-radius:8px;font-weight:500;box-shadow:0 2px 8px rgba(102,126,234,0.3);transition:all 0.2s;cursor:pointer;">ğŸŒ™ åˆ‡æ¢ä¸»é¢˜</button>
              </div>
            </div>
          </div>
          
          <!-- æ•°æ®ç®¡ç† -->
          <div style="margin-bottom:32px;">
            <h4 style="margin:0 0 16px;font-size:14px;font-weight:600;color:#1f2937;text-transform:uppercase;letter-spacing:0.5px;">ğŸ’¾ æ•°æ®ç®¡ç†</h4>
            <div style="display:flex;flex-direction:column;gap:12px;">
              <button class="btn btn-outline" id="btnBackupDataInModal" style="width:100%;justify-content:flex-start;padding:16px 20px;border-radius:12px;border:1px solid #e2e8f0;background:#fff;transition:all 0.2s;text-align:left;">
                <div style="display:flex;align-items:center;gap:12px;flex:1;">
                  <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);display:flex;align-items:center;justify-content:center;font-size:20px;">ğŸ’¾</div>
                  <div style="flex:1;">
                    <div style="font-size:15px;font-weight:500;color:#1e293b;margin-bottom:4px;">å¤‡ä»½æ•°æ®</div>
                    <div style="font-size:12px;color:#64748b;">å¯¼å‡ºæ‰€æœ‰é¸½å­æ•°æ®åˆ°æœ¬åœ°æ–‡ä»¶</div>
                  </div>
                </div>
              </button>
              <button class="btn btn-outline" id="btnExportDataInModal" style="width:100%;justify-content:flex-start;padding:16px 20px;border-radius:12px;border:1px solid #e2e8f0;background:#fff;transition:all 0.2s;text-align:left;">
                <div style="display:flex;align-items:center;gap:12px;flex:1;">
                  <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);display:flex;align-items:center;justify-content:center;font-size:20px;">ğŸ“¥</div>
                  <div style="flex:1;">
                    <div style="font-size:15px;font-weight:500;color:#1e293b;margin-bottom:4px;">å¯¼å‡ºæ•°æ®</div>
                    <div style="font-size:12px;color:#64748b;">å¯¼å‡ºä¸ºJSONæ ¼å¼æ–‡ä»¶</div>
                  </div>
                </div>
              </button>
              <button class="btn btn-outline" id="btnImportDataInModal" style="width:100%;justify-content:flex-start;padding:16px 20px;border-radius:12px;border:1px solid #e2e8f0;background:#fff;transition:all 0.2s;text-align:left;">
                <div style="display:flex;align-items:center;gap:12px;flex:1;">
                  <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);display:flex;align-items:center;justify-content:center;font-size:20px;">ğŸ“¤</div>
                  <div style="flex:1;">
                    <div style="font-size:15px;font-weight:500;color:#1e293b;margin-bottom:4px;">å¯¼å…¥æ•°æ®</div>
                    <div style="font-size:12px;color:#64748b;">ä»JSONæ–‡ä»¶å¯¼å…¥æ•°æ®</div>
                  </div>
                </div>
              </button>
            </div>
          </div>
          
          <!-- æ™ºèƒ½ç®¡ç† -->
          <div style="margin-bottom:32px;">
            <h4 style="margin:0 0 16px;font-size:14px;font-weight:600;color:#1f2937;text-transform:uppercase;letter-spacing:0.5px;">âš™ï¸ æ™ºèƒ½ç®¡ç†</h4>
            <div style="background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);border-radius:12px;padding:20px;border:1px solid #bae6fd;">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;">âš™ï¸</div>
                <div style="flex:1;">
                  <div style="font-size:15px;font-weight:500;color:#1e293b;margin-bottom:4px;">ç®¡ç†åŠŸèƒ½</div>
                  <div style="font-size:12px;color:#64748b;">æ™ºèƒ½ç®¡ç†åŠŸèƒ½å·²é›†æˆåœ¨å·¦ä¾§èœå•ä¸­</div>
                </div>
              </div>
              <div style="display:flex;flex-direction:column;gap:8px;margin-top:12px;">
                <div style="font-size:13px;color:#64748b;padding:8px;background:rgba(255,255,255,0.5);border-radius:6px;">â€¢ å…¬å‘Šç®¡ç†ï¼šå‘å¸ƒå’Œç®¡ç†ç³»ç»Ÿå…¬å‘Š</div>
                <div style="font-size:13px;color:#64748b;padding:8px;background:rgba(255,255,255,0.5);border-radius:6px;">â€¢ ç”¨æˆ·ç®¡ç†ï¼šç®¡ç†ç”¨æˆ·è´¦æˆ·</div>
                <div style="font-size:13px;color:#64748b;padding:8px;background:rgba(255,255,255,0.5);border-radius:6px;">â€¢ ç³»ç»Ÿè®¾ç½®ï¼šé…ç½®ç³»ç»Ÿå‚æ•°</div>
                <div style="font-size:13px;color:#64748b;padding:8px;background:rgba(255,255,255,0.5);border-radius:6px;">â€¢ Evoè®¾ç½®ï¼šé…ç½®AIåŠ©æ‰‹</div>
              </div>
            </div>
          </div>
          
          <!-- å…³äº -->
          <div style="margin-bottom:32px;">
            <h4 style="margin:0 0 16px;font-size:14px;font-weight:600;color:#1f2937;text-transform:uppercase;letter-spacing:0.5px;">â„¹ï¸ å…³äº</h4>
            <div style="background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);border-radius:12px;padding:20px;border:1px solid #e2e8f0;">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;box-shadow:0 4px 12px rgba(102,126,234,0.3);">ğŸ¦</div>
                <div style="flex:1;">
                  <div style="font-size:16px;font-weight:600;color:#1e293b;margin-bottom:4px;">æ™ºé¸½ï½œPigeonAIâ€”â€”æ™ºèƒ½ç®¡ç†ç³»ç»Ÿ</div>
                  <div style="font-size:13px;color:#64748b;">æ¯åªé¸½å­, çš†æ˜¯èµ›çº§ ï½œEvery Pigeon, Race-Grade</div>
                </div>
              </div>
              <div style="padding-top:12px;border-top:1px solid #e2e8f0;margin-top:12px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                  <span style="font-size:13px;color:#64748b;">ç‰ˆæœ¬</span>
                  <span style="font-size:13px;font-weight:500;color:#1e293b;">1.0.0</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- è´¦æˆ·å®‰å…¨ï¼šä¿®æ”¹å¯†ç  -->
          <div style="margin-bottom:32px;">
            <h4 style="margin:0 0 16px;font-size:14px;font-weight:600;color:#1f2937;text-transform:uppercase;letter-spacing:0.5px;">ğŸ”’ è´¦æˆ·å®‰å…¨</h4>
            <div style="background:#f9fafb;border-radius:12px;padding:20px;border:1px solid #e5e7eb;">
              <form id="changePasswordForm" style="max-width: 100%;">
                <div class="form-group">
                  <label>åŸå¯†ç  <span class="required">*</span></label>
                  <div style="position:relative;">
                    <input type="password" id="oldPassword" placeholder="è¯·è¾“å…¥åŸå¯†ç " required style="padding-right:45px;" />
                    <button type="button" class="toggle-password-btn" data-target="oldPassword" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:4px;color:#6b7280;font-size:18px;line-height:1;width:32px;height:32px;display:flex;align-items:center;justify-content:center;" title="æ˜¾ç¤ºå¯†ç ">ğŸ‘ï¸</button>
                  </div>
                </div>
                <div class="form-group">
                  <label>æ–°å¯†ç  <span class="required">*</span></label>
                  <div style="position:relative;">
                    <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" required minlength="6" style="padding-right:45px;" />
                    <button type="button" class="toggle-password-btn" data-target="newPassword" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:4px;color:#6b7280;font-size:18px;line-height:1;width:32px;height:32px;display:flex;align-items:center;justify-content:center;" title="æ˜¾ç¤ºå¯†ç ">ğŸ‘ï¸</button>
                  </div>
                </div>
                <div class="form-group">
                  <label>ç¡®è®¤æ–°å¯†ç  <span class="required">*</span></label>
                  <div style="position:relative;">
                    <input type="password" id="confirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " required minlength="6" style="padding-right:45px;" />
                    <button type="button" class="toggle-password-btn" data-target="confirmPassword" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:4px;color:#6b7280;font-size:18px;line-height:1;width:32px;height:32px;display:flex;align-items:center;justify-content:center;" title="æ˜¾ç¤ºå¯†ç ">ğŸ‘ï¸</button>
                  </div>
                </div>
                <div class="form-actions">
                  <button type="submit" class="btn btn-primary" style="width:100%;">ä¿å­˜å¯†ç </button>
                </div>
                <div id="passwordChangeError" class="error-message" style="margin-top: 16px;"></div>
                <div id="passwordChangeSuccess" style="margin-top: 16px; padding: 12px; background: var(--success-light); color: #047857; border-radius: var(--radius-md); font-size: 14px; display: none;">
                  å¯†ç ä¿®æ”¹æˆåŠŸï¼
                </div>
              </form>
            </div>
          </div>
          
          <!-- é€€å‡ºç™»å½• -->
          <div>
            <h4 style="margin:0 0 16px;font-size:14px;font-weight:600;color:#1f2937;text-transform:uppercase;letter-spacing:0.5px;">ğŸšª è´¦æˆ·æ“ä½œ</h4>
            <button class="btn btn-outline" id="logoutBtnInModal" style="width:100%;justify-content:flex-start;padding:16px 20px;border-radius:12px;border:1px solid #ef4444;background:#fff;transition:all 0.2s;text-align:left;color:#ef4444;">
              <div style="display:flex;align-items:center;gap:12px;flex:1;">
                <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);display:flex;align-items:center;justify-content:center;font-size:20px;">ğŸšª</div>
                <div style="flex:1;">
                  <div style="font-size:15px;font-weight:500;color:#ef4444;margin-bottom:4px;">é€€å‡ºç™»å½•</div>
                  <div style="font-size:12px;color:#64748b;">å®‰å…¨é€€å‡ºæ™ºèƒ½ç®¡ç†ç³»ç»Ÿ</div>
                </div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

        <!-- ç³»ç»Ÿå‡çº§æ ‡ç­¾é¡µ -->
        <div id="upgradeViewTab" style="display:none; margin-left: var(--sidebar-width); margin-top: var(--header-height); padding: 28px;">
          <!-- é¡µé¢å¤´éƒ¨ -->
          <div class="card" style="margin-bottom:24px;background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);color:#fff;border:none;position:relative;overflow:hidden;">
            <div style="position:absolute;top:-60px;right:-60px;width:200px;height:200px;background:rgba(255,255,255,0.08);border-radius:50%;backdrop-filter:blur(20px);"></div>
            <div style="position:absolute;bottom:-40px;left:-40px;width:160px;height:160px;background:rgba(255,255,255,0.06);border-radius:50%;backdrop-filter:blur(18px);"></div>
            <div style="position:relative;z-index:1;display:flex;align-items:flex-start;justify-content:space-between;gap:24px;flex-wrap:wrap;">
              <div style="display:flex;gap:16px;align-items:center;flex:1;min-width:260px;">
                <div style="width:60px;height:60px;border-radius:18px;background:rgba(255,255,255,0.16);display:flex;align-items:center;justify-content:center;font-size:32px;border:1px solid rgba(255,255,255,0.3);">
                  ğŸš€
                </div>
                <div>
                  <div style="font-size:13px;opacity:.9;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;">SYSTEM UPGRADE</div>
                  <h2 style="margin:0 0 4px 0;font-size:22px;font-weight:700;">ç³»ç»Ÿå‡çº§è®°å½•</h2>
                  <p style="margin:0;font-size:13px;opacity:.9;">æŸ¥çœ‹æ¯ä¸€æ¬¡ç‰ˆæœ¬å‡çº§å¸¦æ¥çš„å˜åŒ–å’Œèƒ½åŠ›æå‡</p>
                </div>
              </div>
              <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:stretch;">
                <div style="min-width:150px;padding:12px 16px;border-radius:12px;background:rgba(255,255,255,0.16);backdrop-filter:blur(14px);">
                  <div style="font-size:11px;opacity:.85;margin-bottom:4px;">å½“å‰ç‰ˆæœ¬</div>
                  <div id="upgradeVersion" style="font-size:18px;font-weight:700;">v3.0.0</div>
                </div>
              </div>
            </div>
          </div>

          <!-- å‡çº§æ¦‚è§ˆ + åˆ—è¡¨ä¸¤åˆ—å¸ƒå±€ -->
          <div style="display:grid;grid-template-columns:minmax(0,2fr) minmax(0,3fr);gap:24px;align-items:flex-start;">
            <!-- å‡çº§æ¦‚è§ˆå¡ç‰‡ -->
            <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px;">
              <div class="card" style="padding:20px;">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#1e40af;">å‡çº§éƒ¨åˆ†</div>
                  <div style="font-size:20px;">ğŸ“¦</div>
                </div>
                <div id="upgradePartsCount" style="font-size:28px;font-weight:700;color:#111827;margin-bottom:4px;">--</div>
                <div style="font-size:12px;color:#6b7280;">å·²å®Œæˆæ¨¡å—æ•°</div>
              </div>
              <div class="card" style="padding:20px;">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#065f46;">æ–°å¢æ–‡ä»¶</div>
                  <div style="font-size:20px;">ğŸ“„</div>
                </div>
                <div id="upgradeNewFiles" style="font-size:28px;font-weight:700;color:#111827;margin-bottom:4px;">--</div>
                <div style="font-size:12px;color:#6b7280;">æ–°å¢æ–‡ä»¶æ•°é‡</div>
              </div>
              <div class="card" style="padding:20px;">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#92400e;">æ–°å¢ä»£ç </div>
                  <div style="font-size:20px;">ğŸ’»</div>
                </div>
                <div id="upgradeNewCode" style="font-size:28px;font-weight:700;color:#111827;margin-bottom:4px;">--</div>
                <div style="font-size:12px;color:#6b7280;">æ–°å¢ä»£ç è¡Œæ•°</div>
              </div>
              <div class="card" style="padding:20px;">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#9f1239;">è‡ªåŠ¨åŒ–ç‡</div>
                  <div style="font-size:20px;">âš¡</div>
                </div>
                <div id="upgradeAutomation" style="font-size:28px;font-weight:700;color:#111827;margin-bottom:4px;">--</div>
                <div style="font-size:12px;color:#6b7280;">è‡ªåŠ¨åŒ–èƒ½åŠ›æå‡</div>
              </div>
            </div>

            <!-- å‡çº§éƒ¨åˆ†åˆ—è¡¨ -->
            <div class="card" style="margin:0;">
              <div class="card-header">
                <h3 style="margin:0;font-size:18px;font-weight:700;color:#1e293b;display:flex;align-items:center;gap:8px;">
                  <span style="font-size:20px;">ğŸ“‹</span>
                  <span>å‡çº§å†…å®¹æ˜ç»†</span>
                </h3>
              </div>
              <div class="card-body" id="upgradePartsList" style="padding-top:16px;">
                <div style="text-align:center;padding:32px 0;">
                  <div style="font-size:40px;margin-bottom:12px;">â³</div>
                  <p style="color:#6b7280;font-size:13px;margin:0;">æ­£åœ¨åŠ è½½å‡çº§è®°å½•...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- èƒ½åŠ›æå‡ -->
          <div class="card" style="margin-top:24px;">
            <div class="card-header">
              <h3 style="margin:0;font-size:18px;font-weight:700;color:#1e293b;display:flex;align-items:center;gap:8px;">
                <span style="font-size:20px;">ğŸ“Š</span>
                <span>èƒ½åŠ›æå‡æ€»è§ˆ</span>
              </h3>
            </div>
            <div class="card-body" id="upgradeCapabilities" style="padding-top:16px;">
              <div style="text-align:center;padding:32px 0;">
                <div style="font-size:40px;margin-bottom:12px;">â³</div>
                <p style="color:#6b7280;font-size:13px;margin:0;">æ­£åœ¨åŠ è½½èƒ½åŠ›æå‡æ•°æ®...</p>
              </div>
            </div>
          </div>
        </div>

  <!-- èµ„è®¯è¯¦æƒ…å¼¹çª— -->
  <div class="news-modal" id="newsModal">
    <div class="news-modal-content">
      <div class="news-modal-header">
        <h3 class="news-modal-title" id="newsModalTitle">èµ„è®¯æ ‡é¢˜</h3>
        <button class="news-modal-close" id="newsModalClose">âœ•</button>
      </div>
      <div class="news-modal-body">
        <div class="news-modal-meta">
          <div class="news-modal-meta-item">
            <span>ğŸ“°</span>
            <span id="newsModalSource">æ¥æºï¼šæœªçŸ¥</span>
          </div>
          <div class="news-modal-meta-item">
            <span>ğŸ“</span>
            <span id="newsModalRegion">å…¨å›½èµ„è®¯</span>
          </div>
          <div class="news-modal-meta-item">
            <span>ğŸ•</span>
            <span id="newsModalUpdateTime">æ›´æ–°æ—¶é—´ï¼šæœªçŸ¥</span>
          </div>
        </div>
        <div class="news-modal-content-text" id="newsModalContent">
          èµ„è®¯å†…å®¹åŠ è½½ä¸­...
        </div>
      </div>
      <div class="news-modal-footer">
        <button class="btn btn-outline" id="newsModalViewOriginal">ğŸ”— æŸ¥çœ‹åŸæ–‡</button>
        <button class="btn btn-primary" id="newsModalCloseBtn">å…³é—­</button>
      </div>
    </div>
  </div>
  
  <script>
    // å¯†ç æ˜¾ç¤ºå‡½æ•°å·²åœ¨headä¸­å®šä¹‰ï¼Œè¿™é‡Œä¸å†é‡å¤å®šä¹‰
    
    // APIé…ç½®
    function getApiUrl() {
      const config = localStorage.getItem('pigeon_api_config');
      if (config) {
        const parsed = JSON.parse(config);
        // å¦‚æœé…ç½®äº†è‡ªå®šä¹‰API URLä¸”ä¸æ˜¯localhostï¼Œä½¿ç”¨å®ƒ
        if (parsed.apiUrl && !parsed.apiUrl.includes('localhost')) {
          return parsed.apiUrl;
        }
      }
      
      // è‡ªåŠ¨æ£€æµ‹å½“å‰åŸŸåå¹¶æ„å»ºAPI URL
      const currentOrigin = window.location.origin;
      return currentOrigin + '/api';
    }
    
    // ä¸»é¢˜åˆ‡æ¢
    const themeToggle = document.getElementById('themeToggle');
    const currentTheme = localStorage.getItem('adminTheme') || 'light';
    document.documentElement.setAttribute('data-theme', currentTheme);
    updateThemeButton();
    
    function updateThemeButton() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      if (themeToggle) {
        themeToggle.textContent = isDark ? 'â˜€ï¸ æµ…è‰²æ¨¡å¼' : 'ğŸŒ™ æš—è‰²æ¨¡å¼';
      }
    }
    
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme');
        const newTheme = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('adminTheme', newTheme);
        updateThemeButton();
      });
    }
    
    // å¯†ç æ˜¾ç¤ºå‡½æ•°å·²åœ¨headä¸­å®šä¹‰ï¼Œè¿™é‡ŒéªŒè¯ä¸€ä¸‹
    if (typeof window.togglePasswordVisibility === 'undefined') {
      console.error('âŒ togglePasswordVisibility å‡½æ•°æœªåœ¨headä¸­å®šä¹‰ï¼');
      alert('å¯†ç æ˜¾ç¤ºåŠŸèƒ½åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
    } else {
      console.log('âœ… togglePasswordVisibility å‡½æ•°å·²ä»headåŠ è½½');
    }
    
    // ç™»å½•åŠŸèƒ½ï¼ˆç¡®ä¿DOMå·²åŠ è½½ï¼‰
    function initLoginForm() {
      const loginForm = document.getElementById('loginForm');
      const loginPage = document.getElementById('loginPage');
      const adminPage = document.getElementById('adminPage');
      
      if (!loginForm || !loginPage || !adminPage) {
        console.warn('âš ï¸ ç™»å½•è¡¨å•å…ƒç´ æœªæ‰¾åˆ°ï¼Œå»¶è¿Ÿåˆå§‹åŒ–...');
        setTimeout(initLoginForm, 100);
        return;
      }
      
      // ç»‘å®šç™»å½•è¡¨å•æäº¤äº‹ä»¶ï¼ˆé¿å…é‡å¤ç»‘å®šï¼‰
      if (!loginForm.dataset.initialized) {
        loginForm.dataset.initialized = 'true';
        loginForm.addEventListener('submit', handleLoginSubmit);
        console.log('âœ… ç™»å½•è¡¨å•å·²åˆå§‹åŒ–');
      }
    }
    
    // ç«‹å³åˆå§‹åŒ–ç™»å½•è¡¨å•
    initLoginForm();
    
    // ç™»å½•æäº¤å¤„ç†å‡½æ•°
    async function handleLoginSubmit(e) {
      e.preventDefault();
      e.stopPropagation();
      
      // è®¾ç½®ç™»å½•è¿›è¡Œä¸­æ ‡è®°ï¼Œé˜²æ­¢checkAuthå¹²æ‰°
      window.__loginInProgress = true;
      
      const usernameEl = document.getElementById('username');
      const passwordEl = document.getElementById('password');
      const useLocalAuthEl = document.getElementById('useLocalAuth');
      const errorDiv = document.getElementById('loginError');
      const loginPage = document.getElementById('loginPage');
      const adminPage = document.getElementById('adminPage');
      
      if (!usernameEl || !passwordEl || !errorDiv || !loginPage || !adminPage) {
        console.error('âŒ ç™»å½•è¡¨å•å…ƒç´ æœªæ‰¾åˆ°');
        window.__loginInProgress = false; // é‡ç½®æ ‡è®°
        if (errorDiv) {
          errorDiv.textContent = 'ç³»ç»Ÿé”™è¯¯ï¼šç™»å½•è¡¨å•å…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
          errorDiv.style.display = 'block';
        }
        return;
      }
      
      // è·å–å¹¶æ¸…ç†è¾“å…¥å€¼
      const username = usernameEl.value.trim().toLowerCase(); // è½¬æ¢ä¸ºå°å†™ï¼Œå¿½ç•¥å¤§å°å†™
      const password = passwordEl.value.trim(); // å»é™¤é¦–å°¾ç©ºæ ¼
      const useLocalAuth = useLocalAuthEl ? useLocalAuthEl.checked : false;
      
      // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
      errorDiv.textContent = '';
      errorDiv.style.display = 'none';
      
      // éªŒè¯è¾“å…¥
      if (!username || !password) {
        window.__loginInProgress = false; // é‡ç½®æ ‡è®°
        errorDiv.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
        errorDiv.style.display = 'block';
        return;
      }
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const loginFormEl = document.getElementById('loginForm');
      const submitBtn = loginFormEl ? loginFormEl.querySelector('button[type="submit"]') : null;
      const originalBtnText = submitBtn ? submitBtn.textContent : 'ç™»å½•';
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ç™»å½•ä¸­...';
      }
      
      // å¦‚æœå‹¾é€‰äº†"ä½¿ç”¨æœ¬åœ°éªŒè¯"ï¼Œç›´æ¥ä½¿ç”¨æœ¬åœ°éªŒè¯
      if (useLocalAuth) {
        console.log('ğŸ”§ ä½¿ç”¨æœ¬åœ°éªŒè¯æ¨¡å¼');
        console.log('ğŸ” è¾“å…¥çš„ç”¨æˆ·å:', username);
        console.log('ğŸ” è¾“å…¥çš„å¯†ç :', password ? '***' : '(ç©º)');
        
        // æœ¬åœ°éªŒè¯ï¼šåªæ”¯æŒé»˜è®¤è´¦å·ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
        const validUsername = 'admin';
        const validPassword = 'admin123';
        
        // æ·»åŠ è¯¦ç»†çš„éªŒè¯æ—¥å¿—
        console.log('ğŸ” éªŒè¯è¯¦æƒ…:', {
          inputUsername: username,
          inputPassword: password ? '***' : '(ç©º)',
          validUsername: validUsername,
          validPassword: validPassword,
          usernameMatch: username === validUsername,
          passwordMatch: password === validPassword,
          bothMatch: username === validUsername && password === validPassword
        });
        
        if (username === validUsername && password === validPassword) {
          console.log('âœ… æœ¬åœ°éªŒè¯æˆåŠŸ');
          
          // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç™»å½•ä¿¡æ¯ï¼Œé¿å…å¹²æ‰°
          try {
            // ä¿å­˜æ–°çš„ç™»å½•ä¿¡æ¯
            const mockUser = {
              id: 'admin_local',
              username: 'admin',
              email: 'admin@example.com',
              role: 'admin',
              createdAt: new Date().toISOString()
            };
            
            const mockToken = 'local_admin_token_' + Date.now();
            
            // å…ˆæ¸…é™¤æ—§çš„ï¼Œå†è®¾ç½®æ–°çš„
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            localStorage.removeItem('adminUserInfo');
            localStorage.removeItem('offlineMode');
            
            // è®¾ç½®æ–°çš„ç™»å½•ä¿¡æ¯
            localStorage.setItem('adminToken', mockToken);
            localStorage.setItem('adminUser', JSON.stringify(mockUser));
            localStorage.setItem('offlineMode', 'true');
            
            const userInfo = {
              name: mockUser.username,
              email: mockUser.email,
              type: 'ç®¡ç†å‘˜',
              role: 'ç®¡ç†å‘˜',
              registerDate: new Date().toISOString().split('T')[0]
            };
            localStorage.setItem('adminUserInfo', JSON.stringify(userInfo));
            
            console.log('âœ… ç™»å½•ä¿¡æ¯å·²ä¿å­˜åˆ°localStorage');
            
            // ç¡®ä¿é¡µé¢å…ƒç´ å­˜åœ¨åå†åˆ‡æ¢
            const loginPageEl = document.getElementById('loginPage');
            const adminPageEl = document.getElementById('adminPage');
            
            if (loginPageEl && adminPageEl) {
              console.log('ğŸ” å‡†å¤‡åˆ‡æ¢é¡µé¢:', {
                loginPageExists: !!loginPageEl,
                adminPageExists: !!adminPageEl,
                loginPageCurrentDisplay: window.getComputedStyle(loginPageEl).display,
                adminPageCurrentDisplay: window.getComputedStyle(adminPageEl).display
              });
              
              // ç«‹å³åˆ‡æ¢é¡µé¢æ˜¾ç¤ºï¼ˆä½¿ç”¨!importantç¡®ä¿ä¼˜å…ˆçº§ï¼‰
              loginPageEl.style.setProperty('display', 'none', 'important');
              adminPageEl.style.setProperty('display', 'block', 'important');
              
              // åŒæ—¶è®¾ç½®å†…è”æ ·å¼ä½œä¸ºå¤‡ä»½
              loginPageEl.style.display = 'none';
              adminPageEl.style.display = 'block';
              
              // å¼ºåˆ¶è§¦å‘é‡æ’
              loginPageEl.offsetHeight;
              adminPageEl.offsetHeight;
              
              console.log('ğŸ” é¡µé¢åˆ‡æ¢å:', {
                loginPageDisplay: window.getComputedStyle(loginPageEl).display,
                adminPageDisplay: window.getComputedStyle(adminPageEl).display
              });
              
              // æ›´æ–°ç”¨æˆ·åæ˜¾ç¤º
              const adminUserNameEl = document.getElementById('adminUserName');
              if (adminUserNameEl) {
                adminUserNameEl.textContent = `æ¬¢è¿ï¼Œ${mockUser.username}ï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰`;
              }
              
              // æ¢å¤æŒ‰é’®çŠ¶æ€
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
              }
              
              // è°ƒç”¨åˆå§‹åŒ–å‡½æ•°
              if (typeof updateTopBarUserDisplay === 'function') {
                try {
                  updateTopBarUserDisplay();
                } catch (e) {
                  console.warn('updateTopBarUserDisplay è°ƒç”¨å¤±è´¥:', e);
                }
              }
              
              if (typeof loadAnnouncements === 'function') {
                try {
                  loadAnnouncements();
                } catch (e) {
                  console.warn('loadAnnouncements è°ƒç”¨å¤±è´¥:', e);
                }
              }
              
              setTimeout(() => {
                if (typeof initEvoAssistant === 'function') {
                  try {
                    initEvoAssistant();
                  } catch (e) {
                    console.warn('initEvoAssistant è°ƒç”¨å¤±è´¥:', e);
                  }
                }
              }, 500);
              
              console.log('âœ… ç™»å½•æˆåŠŸï¼Œå·²åˆ‡æ¢åˆ°ç®¡ç†é¡µé¢');
              
              // é˜»æ­¢checkAuthå†æ¬¡æ‰§è¡Œï¼ˆé€šè¿‡è®¾ç½®æ ‡è®°ï¼‰
              window.__loginInProgress = false;
              window.__justLoggedIn = true;
              
              // éªŒè¯é¡µé¢åˆ‡æ¢æ˜¯å¦æˆåŠŸï¼ˆå¤šæ¬¡æ£€æŸ¥ï¼‰
              const verifyPageSwitch = () => {
                const currentLoginDisplay = window.getComputedStyle(loginPageEl).display;
                const currentAdminDisplay = window.getComputedStyle(adminPageEl).display;
                
                if (currentLoginDisplay !== 'none' || currentAdminDisplay !== 'block') {
                  console.warn('âš ï¸ æ£€æµ‹åˆ°é¡µé¢çŠ¶æ€å¼‚å¸¸ï¼Œå¼ºåˆ¶ä¿®å¤:', {
                    loginPage: currentLoginDisplay,
                    adminPage: currentAdminDisplay
                  });
                  loginPageEl.style.setProperty('display', 'none', 'important');
                  adminPageEl.style.setProperty('display', 'block', 'important');
                }
              };
              
              // ç«‹å³éªŒè¯
              setTimeout(verifyPageSwitch, 50);
              // 100msåå†æ¬¡éªŒè¯
              setTimeout(verifyPageSwitch, 100);
              // 500msåå†æ¬¡éªŒè¯
              setTimeout(verifyPageSwitch, 500);
              // 1ç§’åå†æ¬¡éªŒè¯
              setTimeout(verifyPageSwitch, 1000);
              
              // ç¡®ä¿ä¸ä¼šå› ä¸ºcheckAuthè€Œè·³è½¬å›ç™»å½•é¡µï¼ˆå»¶é•¿ä¿æŠ¤æ—¶é—´åˆ°10ç§’ï¼‰
              setTimeout(() => {
                verifyPageSwitch(); // æœ€åéªŒè¯ä¸€æ¬¡
                window.__justLoggedIn = false;
                console.log('âœ… ç™»å½•æµç¨‹å®Œæˆï¼ŒcheckAuthå·²æ¢å¤');
              }, 10000); // å»¶é•¿åˆ°10ç§’
              
              return;
            } else {
              console.error('âŒ é¡µé¢å…ƒç´ æœªæ‰¾åˆ°ï¼Œæ— æ³•åˆ‡æ¢é¡µé¢');
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
              }
              errorDiv.textContent = 'ç³»ç»Ÿé”™è¯¯ï¼šé¡µé¢å…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
              errorDiv.style.display = 'block';
              return;
            }
          } catch (storageError) {
            console.error('âŒ ä¿å­˜ç™»å½•ä¿¡æ¯å¤±è´¥:', storageError);
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = originalBtnText;
            }
            errorDiv.textContent = 'ç³»ç»Ÿé”™è¯¯ï¼šæ— æ³•ä¿å­˜ç™»å½•ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®';
            errorDiv.style.display = 'block';
            return;
          }
        } else {
          // æ¢å¤æŒ‰é’®çŠ¶æ€å’Œç™»å½•æ ‡è®°
          window.__loginInProgress = false;
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = originalBtnText;
          }
          errorDiv.textContent = 'æœ¬åœ°éªŒè¯å¤±è´¥ï¼šä»…æ”¯æŒé»˜è®¤è´¦å· admin / admin123';
          errorDiv.style.display = 'block';
          console.warn('âŒ æœ¬åœ°éªŒè¯å¤±è´¥:', { 
            username, 
            passwordMatch: password === validPassword,
            expectedUsername: validUsername,
            expectedPassword: validPassword
          });
          return;
        }
      }
      
      // é¦–å…ˆå°è¯•æ­£å¸¸ç™»å½•ï¼ˆè®¾ç½®5ç§’è¶…æ—¶ï¼‰
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000);
      
      try {
        const apiUrl = getApiUrl();
        console.log('ğŸ” å°è¯•ç™»å½•ï¼ŒAPIåœ°å€:', apiUrl);
        console.log('ğŸ” ç”¨æˆ·å:', username);
        
        const response = await fetch(`${apiUrl}/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        console.log('ğŸ” ç™»å½•å“åº”çŠ¶æ€:', response.status);
        
        if (!response.ok) {
          const errorResult = await response.json().catch(() => ({ error: 'ç½‘ç»œé”™è¯¯' }));
          console.error('âŒ ç™»å½•å¤±è´¥:', errorResult);
          
          // å¦‚æœåç«¯è¿”å›401/403ç­‰é”™è¯¯ï¼Œä¹Ÿå°è¯•æœ¬åœ°fallbackï¼ˆç”¨äºå¼€å‘æµ‹è¯•ï¼‰
          if ((response.status === 401 || response.status === 403 || response.status >= 500) && username === 'admin' && password === 'admin123') {
            console.log('âš ï¸ åç«¯éªŒè¯å¤±è´¥ï¼Œå°è¯•æœ¬åœ°fallback...');
            
            const mockUser = {
              id: 'admin_local',
              username: 'admin',
              email: 'admin@example.com',
              role: 'admin',
              createdAt: new Date().toISOString()
            };
            
            const mockToken = 'local_admin_token_' + Date.now();
            
            localStorage.setItem('adminToken', mockToken);
            localStorage.setItem('adminUser', JSON.stringify(mockUser));
            localStorage.setItem('offlineMode', 'true');
            
            const userInfo = {
              name: mockUser.username,
              email: mockUser.email,
              type: 'ç®¡ç†å‘˜',
              role: 'ç®¡ç†å‘˜',
              registerDate: new Date().toISOString().split('T')[0]
            };
            localStorage.setItem('adminUserInfo', JSON.stringify(userInfo));
            
            const loginPageEl = document.getElementById('loginPage');
            const adminPageEl = document.getElementById('adminPage');
            
            if (loginPageEl && adminPageEl) {
              loginPageEl.style.display = 'none';
              adminPageEl.style.display = 'block';
              
              const adminUserNameEl = document.getElementById('adminUserName');
              if (adminUserNameEl) {
                adminUserNameEl.textContent = `æ¬¢è¿ï¼Œ${mockUser.username}ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰`;
              }
              
              if (typeof updateTopBarUserDisplay === 'function') {
                updateTopBarUserDisplay();
              }
              
              setTimeout(() => {
                alert('âš ï¸ å½“å‰ä¸ºç¦»çº¿æ¨¡å¼\n\nåç«¯æœåŠ¡éªŒè¯å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°éªŒè¯ã€‚\né»˜è®¤è´¦å·ï¼šadmin / admin123');
              }, 300);
              
              if (typeof loadAnnouncements === 'function') {
                loadAnnouncements();
              }
              
              setTimeout(() => {
                if (typeof initEvoAssistant === 'function') {
                  initEvoAssistant();
                }
              }, 500);
            }
            
            return;
          }
          
          errorDiv.textContent = errorResult.error || `ç™»å½•å¤±è´¥ (HTTP ${response.status})`;
          errorDiv.style.display = 'block';
          return;
        }
        
        const result = await response.json();
        console.log('ğŸ” ç™»å½•ç»“æœ:', result);
        
        if (result.success && result.data) {
          const user = result.data.user;
          console.log('ğŸ” ç”¨æˆ·ä¿¡æ¯:', user);
          
          // æ£€æŸ¥ç®¡ç†å‘˜æƒé™ï¼ˆæ”¯æŒ role === 'admin' æˆ– role === 'ç®¡ç†å‘˜'ï¼‰
          if (user.role !== 'admin' && user.role !== 'ç®¡ç†å‘˜') {
            console.warn('âš ï¸ ç”¨æˆ·æ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼Œrole:', user.role);
            errorDiv.textContent = `æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼ˆå½“å‰è§’è‰²ï¼š${user.role}ï¼‰`;
            errorDiv.style.display = 'block';
            return;
          }
          
          localStorage.setItem('adminToken', result.data.token);
          localStorage.setItem('adminUser', JSON.stringify(user));
          
          // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
          const userInfo = {
            name: user.username,
            email: user.email || 'admin@example.com',
            type: 'ç®¡ç†å‘˜',
            role: 'ç®¡ç†å‘˜',
            registerDate: user.createdAt ? new Date(user.createdAt).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]
          };
          localStorage.setItem('adminUserInfo', JSON.stringify(userInfo));
          
          // ç¡®ä¿é¡µé¢å…ƒç´ å­˜åœ¨åå†åˆ‡æ¢
          const loginPageEl = document.getElementById('loginPage');
          const adminPageEl = document.getElementById('adminPage');
          
            if (loginPageEl && adminPageEl) {
              loginPageEl.style.display = 'none';
              adminPageEl.style.display = 'block';
              
              const adminUserNameEl = document.getElementById('adminUserName');
              if (adminUserNameEl) {
                adminUserNameEl.textContent = `æ¬¢è¿ï¼Œ${user.username}`;
              }
              
              const submitBtn = document.getElementById('loginForm')?.querySelector('button[type="submit"]');
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ç™»å½•';
              }
              
              // æ›´æ–°ç”¨æˆ·æ˜¾ç¤ºï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰å¤´åƒå’Œåå­—ï¼‰
              if (typeof updateTopBarUserDisplay === 'function') {
                try {
                  updateTopBarUserDisplay();
                } catch (e) {
                  console.warn('updateTopBarUserDisplay è°ƒç”¨å¤±è´¥:', e);
                }
              }
              
              console.log('âœ… ç™»å½•æˆåŠŸï¼Œå·²åˆ‡æ¢åˆ°ç®¡ç†é¡µé¢');
              
              // æ£€æŸ¥æ˜¯å¦ä¸ºé»˜è®¤å¯†ç ï¼ˆé¦–æ¬¡ç™»å½•ï¼‰
              if (username === 'admin' && password === 'admin123') {
                setTimeout(() => {
                  if (confirm('æ£€æµ‹åˆ°æ‚¨ä½¿ç”¨çš„æ˜¯é»˜è®¤å¯†ç ï¼Œä¸ºäº†å®‰å…¨èµ·è§ï¼Œå»ºè®®æ‚¨ç«‹å³ä¿®æ”¹å¯†ç ã€‚\n\næ˜¯å¦ç°åœ¨å‰å¾€ä¿®æ”¹å¯†ç é¡µé¢ï¼Ÿ')) {
                    // åˆ‡æ¢åˆ°ä¿®æ”¹å¯†ç æ ‡ç­¾é¡µ
                    const passwordTabBtn = document.querySelector('[data-tab="password"]');
                    const passwordTab = document.getElementById('passwordTab');
                    if (passwordTabBtn && passwordTab) {
                      document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                      document.querySelectorAll('[id$="Tab"]').forEach(tab => tab.style.display = 'none');
                      passwordTabBtn.classList.add('active');
                      passwordTab.style.display = 'block';
                    }
                  }
                }, 500);
              }
              
              if (typeof loadAnnouncements === 'function') {
                try {
                  loadAnnouncements();
                } catch (e) {
                  console.warn('loadAnnouncements è°ƒç”¨å¤±è´¥:', e);
                }
              }
              
              // åˆå§‹åŒ–EvoåŠ©æ‰‹
              setTimeout(() => {
                if (typeof initEvoAssistant === 'function') {
                  try {
                    initEvoAssistant();
                  } catch (e) {
                    console.warn('initEvoAssistant è°ƒç”¨å¤±è´¥:', e);
                  }
                }
              }, 500);
              
              // è®¾ç½®ç™»å½•æˆåŠŸæ ‡è®°
              window.__loginInProgress = false;
              window.__justLoggedIn = true;
              setTimeout(() => {
                window.__justLoggedIn = false;
                console.log('âœ… ç™»å½•æµç¨‹å®Œæˆï¼ŒcheckAuthå·²æ¢å¤');
              }, 3000);
              
              return;
          } else {
            console.error('âŒ é¡µé¢å…ƒç´ æœªæ‰¾åˆ°ï¼Œæ— æ³•åˆ‡æ¢é¡µé¢');
            errorDiv.textContent = 'ç³»ç»Ÿé”™è¯¯ï¼šé¡µé¢å…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
            errorDiv.style.display = 'block';
            return;
          }
        } else {
          window.__loginInProgress = false; // é‡ç½®æ ‡è®°
          const submitBtn = document.getElementById('loginForm')?.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'ç™»å½•';
          }
          console.error('âŒ ç™»å½•å¤±è´¥:', result);
          errorDiv.textContent = result.error || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ';
          errorDiv.style.display = 'block';
          return;
        }
      } catch (error) {
        // ç™»å½•å¤±è´¥ï¼Œå°è¯•æœ¬åœ°fallbackéªŒè¯ï¼ˆç”¨äºå¼€å‘æµ‹è¯•ï¼‰
        console.error('ç™»å½•å¤±è´¥:', error);
        if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('Load failed') || error.message.includes('timeout') || error.name === 'TimeoutError' || error.name === 'AbortError')) {
          console.log('âš ï¸ åç«¯æœåŠ¡æ— æ³•è¿æ¥ï¼Œå°è¯•æœ¬åœ°éªŒè¯...');
          
          // æœ¬åœ°fallbackï¼šä½¿ç”¨é»˜è®¤è´¦å·å¯†ç è¿›è¡ŒéªŒè¯
          // é»˜è®¤è´¦å·ï¼šadmin / admin123
          if (username === 'admin' && password === 'admin123') {
            console.log('âœ… æœ¬åœ°éªŒè¯æˆåŠŸï¼ˆä½¿ç”¨é»˜è®¤è´¦å·ï¼‰');
            
            // åˆ›å»ºæ¨¡æ‹Ÿçš„ç”¨æˆ·æ•°æ®å’Œtoken
            const mockUser = {
              id: 'admin_local',
              username: 'admin',
              email: 'admin@example.com',
              role: 'admin',
              createdAt: new Date().toISOString()
            };
            
            const mockToken = 'local_admin_token_' + Date.now();
            
            localStorage.setItem('adminToken', mockToken);
            localStorage.setItem('adminUser', JSON.stringify(mockUser));
            localStorage.setItem('offlineMode', 'true'); // æ ‡è®°ä¸ºç¦»çº¿æ¨¡å¼
            
            const userInfo = {
              name: mockUser.username,
              email: mockUser.email,
              type: 'ç®¡ç†å‘˜',
              role: 'ç®¡ç†å‘˜',
              registerDate: new Date().toISOString().split('T')[0]
            };
            localStorage.setItem('adminUserInfo', JSON.stringify(userInfo));
            
            const loginPageEl = document.getElementById('loginPage');
            const adminPageEl = document.getElementById('adminPage');
            
            if (loginPageEl && adminPageEl) {
              loginPageEl.style.display = 'none';
              adminPageEl.style.display = 'block';
              
              const adminUserNameEl = document.getElementById('adminUserName');
              if (adminUserNameEl) {
                adminUserNameEl.textContent = `æ¬¢è¿ï¼Œ${mockUser.username}ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰`;
              }
              
              if (typeof updateTopBarUserDisplay === 'function') {
                updateTopBarUserDisplay();
              }
              
              // æ˜¾ç¤ºç¦»çº¿æ¨¡å¼æç¤º
              setTimeout(() => {
                alert('âš ï¸ å½“å‰ä¸ºç¦»çº¿æ¨¡å¼\n\nåç«¯æœåŠ¡æœªè¿æ¥ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨ã€‚\né»˜è®¤è´¦å·ï¼šadmin / admin123');
              }, 300);
              
              if (typeof loadAnnouncements === 'function') {
                loadAnnouncements();
              }
              
              setTimeout(() => {
                if (typeof initEvoAssistant === 'function') {
                  initEvoAssistant();
                }
              }, 500);
            }
            
            return;
          } else {
            window.__loginInProgress = false; // é‡ç½®æ ‡è®°
            const submitBtn = document.getElementById('loginForm')?.querySelector('button[type="submit"]');
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = 'ç™»å½•';
            }
            errorDiv.textContent = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œä¸”æœ¬åœ°éªŒè¯å¤±è´¥ã€‚\n\næç¤ºï¼š\n1) ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨\n2) æˆ–ä½¿ç”¨é»˜è®¤è´¦å·ï¼šadmin / admin123ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰';
            errorDiv.style.display = 'block';
            return;
          }
        } else {
          window.__loginInProgress = false; // é‡ç½®æ ‡è®°
          const submitBtn = document.getElementById('loginForm')?.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'ç™»å½•';
          }
          errorDiv.textContent = 'ç™»å½•å¤±è´¥ï¼š' + (error.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨');
          errorDiv.style.display = 'block';
          console.error('ç™»å½•é”™è¯¯è¯¦æƒ…:', error);
          return;
        }
      } finally {
        // ç¡®ä¿åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½é‡ç½®æ ‡è®°ï¼ˆå¦‚æœè¿˜æ²¡æœ‰é‡ç½®ï¼‰
        // æ³¨æ„ï¼šæˆåŠŸè·¯å¾„å·²ç»åœ¨å†…éƒ¨é‡ç½®äº†æ ‡è®°
      }
    }
    
    // æ˜¾ç¤º/éšè—å¯†ç åŠŸèƒ½ï¼ˆç®€åŒ–ç‰ˆï¼Œç›´æ¥ç»‘å®šäº‹ä»¶ï¼‰
    function initPasswordToggle(buttonId, inputId) {
      const toggleBtn = document.getElementById(buttonId);
      const passwordInput = document.getElementById(inputId);
      
      if (!toggleBtn || !passwordInput) {
        console.warn('âš ï¸ å¯†ç æ˜¾ç¤ºåŠŸèƒ½åˆå§‹åŒ–å¤±è´¥:', { buttonId, inputId, toggleBtn: !!toggleBtn, passwordInput: !!passwordInput });
        return false;
      }
      
      // ç§»é™¤æ‰€æœ‰æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆé€šè¿‡å…‹éš†èŠ‚ç‚¹ï¼‰
      const newToggleBtn = toggleBtn.cloneNode(true);
      toggleBtn.parentNode.replaceChild(newToggleBtn, toggleBtn);
      
      // é‡æ–°è·å–å¼•ç”¨
      const freshToggleBtn = document.getElementById(buttonId);
      const freshPasswordInput = document.getElementById(inputId);
      
      if (!freshToggleBtn || !freshPasswordInput) {
        console.error('âŒ æ— æ³•é‡æ–°è·å–å…ƒç´ å¼•ç”¨');
        return false;
      }
      
      // ç»‘å®šæ–°çš„äº‹ä»¶ç›‘å¬å™¨
      freshToggleBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        try {
          const currentType = freshPasswordInput.getAttribute('type') || freshPasswordInput.type || 'password';
          const newType = currentType === 'password' ? 'text' : 'password';
          
          console.log('ğŸ”„ åˆ‡æ¢å¯†ç æ˜¾ç¤º:', { currentType, newType });
          
          // ä½¿ç”¨setAttributeå’Œç›´æ¥è®¾ç½®typeå±æ€§ï¼Œç¡®ä¿å…¼å®¹æ€§
          freshPasswordInput.setAttribute('type', newType);
          freshPasswordInput.type = newType;
          
          // æ›´æ–°æŒ‰é’®å›¾æ ‡å’Œæç¤º
          if (newType === 'text') {
            freshToggleBtn.textContent = 'ğŸ™ˆ';
            freshToggleBtn.title = 'éšè—å¯†ç ';
            freshToggleBtn.setAttribute('aria-label', 'éšè—å¯†ç ');
          } else {
            freshToggleBtn.textContent = 'ğŸ‘ï¸';
            freshToggleBtn.title = 'æ˜¾ç¤ºå¯†ç ';
            freshToggleBtn.setAttribute('aria-label', 'æ˜¾ç¤ºå¯†ç ');
          }
          
          // èšç„¦åˆ°è¾“å…¥æ¡†
          setTimeout(() => {
            freshPasswordInput.focus();
          }, 10);
          
          console.log('âœ… å¯†ç æ˜¾ç¤ºçŠ¶æ€å·²åˆ‡æ¢:', newType);
        } catch (error) {
          console.error('âŒ åˆ‡æ¢å¯†ç æ˜¾ç¤ºçŠ¶æ€å¤±è´¥:', error);
        }
      }, true); // ä½¿ç”¨æ•è·é˜¶æ®µï¼Œç¡®ä¿ä¼˜å…ˆæ‰§è¡Œ
      
      freshToggleBtn.dataset.initialized = 'true';
      console.log('âœ… å¯†ç æ˜¾ç¤ºåŠŸèƒ½å·²åˆå§‹åŒ–:', inputId);
      return true;
    }
    
    // åˆ›å»ºå¯†ç åˆ‡æ¢å¤„ç†å‡½æ•°
    function createPasswordToggleHandler(passwordInput, toggleBtn) {
      return function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        try {
          const currentType = passwordInput.getAttribute('type') || passwordInput.type || 'password';
          const newType = currentType === 'password' ? 'text' : 'password';
          
          // ä½¿ç”¨setAttributeå’Œç›´æ¥è®¾ç½®typeå±æ€§ï¼Œç¡®ä¿å…¼å®¹æ€§
          passwordInput.setAttribute('type', newType);
          passwordInput.type = newType;
          
          // æ›´æ–°æŒ‰é’®å›¾æ ‡å’Œæç¤º
          if (newType === 'text') {
            toggleBtn.textContent = 'ğŸ™ˆ';
            toggleBtn.title = 'éšè—å¯†ç ';
            toggleBtn.setAttribute('aria-label', 'éšè—å¯†ç ');
          } else {
            toggleBtn.textContent = 'ğŸ‘ï¸';
            toggleBtn.title = 'æ˜¾ç¤ºå¯†ç ';
            toggleBtn.setAttribute('aria-label', 'æ˜¾ç¤ºå¯†ç ');
          }
          
          // èšç„¦åˆ°è¾“å…¥æ¡†
          setTimeout(() => {
            passwordInput.focus();
          }, 10);
          
          console.log('âœ… å¯†ç æ˜¾ç¤ºçŠ¶æ€å·²åˆ‡æ¢:', newType);
        } catch (error) {
          console.error('âŒ åˆ‡æ¢å¯†ç æ˜¾ç¤ºçŠ¶æ€å¤±è´¥:', error);
        }
      };
    }
    
    // åˆå§‹åŒ–æ‰€æœ‰å¯†ç æ˜¾ç¤ºæŒ‰é’®ï¼ˆç®€åŒ–ç‰ˆï¼Œç›´æ¥åˆå§‹åŒ–ï¼‰
    function initAllPasswordToggles() {
      // åˆå§‹åŒ–ç™»å½•é¡µé¢çš„å¯†ç æ˜¾ç¤ºæŒ‰é’®
      const loginToggleBtn = document.getElementById('togglePasswordBtn');
      const loginPasswordInput = document.getElementById('password');
      
      if (loginToggleBtn && loginPasswordInput) {
        const success = initPasswordToggle('togglePasswordBtn', 'password');
        if (success) {
          console.log('âœ… ç™»å½•é¡µé¢å¯†ç æ˜¾ç¤ºåŠŸèƒ½å·²åˆå§‹åŒ–');
        } else {
          console.error('âŒ ç™»å½•é¡µé¢å¯†ç æ˜¾ç¤ºåŠŸèƒ½åˆå§‹åŒ–å¤±è´¥');
        }
      } else {
        console.warn('âš ï¸ å¯†ç æ˜¾ç¤ºæŒ‰é’®æˆ–è¾“å…¥æ¡†æœªæ‰¾åˆ°:', {
          toggleBtn: !!loginToggleBtn,
          passwordInput: !!loginPasswordInput
        });
      }
      
      // åˆå§‹åŒ–ä¿®æ”¹å¯†ç è¡¨å•çš„å¯†ç æ˜¾ç¤ºæŒ‰é’®
      document.querySelectorAll('.toggle-password-btn').forEach(btn => {
        const targetId = btn.getAttribute('data-target');
        if (targetId) {
          const passwordInput = document.getElementById(targetId);
          if (passwordInput) {
            // å…‹éš†æŒ‰é’®ç§»é™¤æ—§äº‹ä»¶
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            const freshBtn = btn.parentNode.querySelector(`[data-target="${targetId}"]`);
            const freshInput = document.getElementById(targetId);
            
            if (freshBtn && freshInput) {
              freshBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const currentType = freshInput.getAttribute('type') || 'password';
                const newType = currentType === 'password' ? 'text' : 'password';
                freshInput.setAttribute('type', newType);
                freshInput.type = newType;
                freshBtn.textContent = newType === 'text' ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
                freshBtn.title = newType === 'text' ? 'éšè—å¯†ç ' : 'æ˜¾ç¤ºå¯†ç ';
              }, true);
              console.log('âœ… ä¿®æ”¹å¯†ç è¡¨å•å¯†ç æ˜¾ç¤ºåŠŸèƒ½å·²åˆå§‹åŒ–:', targetId);
            }
          }
        }
      });
    }
    
    // ç«‹å³åˆå§‹åŒ–ï¼ˆä¸ç­‰å¾…DOMContentLoadedï¼‰
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initAllPasswordToggles, 50);
      });
    } else {
      setTimeout(initAllPasswordToggles, 50);
    }
    
    // å¤šæ¬¡é‡è¯•ç¡®ä¿åˆå§‹åŒ–æˆåŠŸ
    setTimeout(initAllPasswordToggles, 200);
    setTimeout(initAllPasswordToggles, 500);
    setTimeout(initAllPasswordToggles, 1000);
    
    // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆå¢å¼ºç‰ˆï¼Œé¿å…å¹²æ‰°æ­£åœ¨è¿›è¡Œçš„ç™»å½•ï¼‰
    function checkAuth() {
      // å¦‚æœæ­£åœ¨ç™»å½•æˆ–åˆšåˆšç™»å½•ï¼Œè·³è¿‡æ£€æŸ¥
      if (window.__loginInProgress || window.__justLoggedIn) {
        console.log('â¸ï¸ è·³è¿‡checkAuthï¼šç™»å½•è¿›è¡Œä¸­æˆ–åˆšåˆšç™»å½•');
        
        // å¦‚æœå·²ç™»å½•ï¼Œç¡®ä¿ç®¡ç†é¡µé¢æ˜¾ç¤º
        const token = localStorage.getItem('adminToken');
        const user = localStorage.getItem('adminUser');
        if (token && user) {
          const loginPage = document.getElementById('loginPage');
          const adminPage = document.getElementById('adminPage');
          if (loginPage && adminPage) {
            loginPage.style.setProperty('display', 'none', 'important');
            adminPage.style.setProperty('display', 'block', 'important');
          }
        }
        return;
      }
      
      const token = localStorage.getItem('adminToken');
      const user = localStorage.getItem('adminUser');
      const loginPage = document.getElementById('loginPage');
      const adminPage = document.getElementById('adminPage');
      
      if (!loginPage || !adminPage) {
        console.warn('âš ï¸ ç™»å½•é¡µé¢å…ƒç´ æœªæ‰¾åˆ°ï¼Œå»¶è¿Ÿæ£€æŸ¥...');
        setTimeout(checkAuth, 100);
        return;
      }
      
      // æ£€æŸ¥è®¡ç®—æ ·å¼ï¼Œæ›´å‡†ç¡®
      const loginPageComputed = window.getComputedStyle(loginPage).display;
      const adminPageComputed = window.getComputedStyle(adminPage).display;
      
      // å¦‚æœç®¡ç†é¡µé¢å·²ç»æ˜¾ç¤ºï¼Œä¸”ç”¨æˆ·å·²ç™»å½•ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
      if (adminPageComputed === 'block' && token && user) {
        console.log('âœ… ç”¨æˆ·å·²ç™»å½•ï¼Œç®¡ç†é¡µé¢å·²æ˜¾ç¤ºï¼Œè·³è¿‡æ£€æŸ¥');
        return;
      }
      
      if (token && user) {
        try {
          const userData = JSON.parse(user);
          if (userData.role === 'admin' || userData.role === 'ç®¡ç†å‘˜') {
            // åªæœ‰åœ¨ç™»å½•é¡µé¢æ˜¾ç¤ºæ—¶æ‰åˆ‡æ¢ï¼ˆä½¿ç”¨è®¡ç®—æ ·å¼åˆ¤æ–­ï¼‰
            const loginPageComputed = window.getComputedStyle(loginPage).display;
            if (loginPageComputed !== 'none') {
              loginPage.style.setProperty('display', 'none', 'important');
              adminPage.style.setProperty('display', 'block', 'important');
              loginPage.style.display = 'none';
              adminPage.style.display = 'block';
              
              const userNameText = userData.username || 'ç®¡ç†å‘˜';
              const adminUserNameEl = document.getElementById('adminUserName');
              if (adminUserNameEl) {
                const mode = localStorage.getItem('offlineMode') === 'true' ? 'ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰' : '';
                adminUserNameEl.textContent = `æ¬¢è¿ï¼Œ${userNameText}${mode}`;
              }
              
              if (typeof updateTopBarUserDisplay === 'function') {
                try {
                  updateTopBarUserDisplay();
                } catch (e) {
                  console.warn('updateTopBarUserDisplay è°ƒç”¨å¤±è´¥:', e);
                }
              }
              
              if (typeof loadAnnouncements === 'function') {
                try {
                  loadAnnouncements();
                } catch (e) {
                  console.warn('loadAnnouncements è°ƒç”¨å¤±è´¥:', e);
                }
              }
              
              // åˆå§‹åŒ–EvoåŠ©æ‰‹
              setTimeout(() => {
                if (typeof initEvoAssistant === 'function') {
                  try {
                    initEvoAssistant();
                  } catch (e) {
                    console.warn('initEvoAssistant è°ƒç”¨å¤±è´¥:', e);
                  }
                }
              }, 500);
              
              console.log('âœ… checkAuthï¼šå·²åˆ‡æ¢åˆ°ç®¡ç†é¡µé¢');
            }
            return;
          }
        } catch (e) {
          console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
          // æ¸…é™¤æ— æ•ˆçš„ç™»å½•ä¿¡æ¯
          localStorage.removeItem('adminToken');
          localStorage.removeItem('adminUser');
        }
      }
      
      // åªæœ‰åœ¨ç®¡ç†é¡µé¢æ˜¾ç¤ºæ—¶æ‰åˆ‡æ¢å›ç™»å½•é¡µï¼ˆä½†è¦æ£€æŸ¥æ˜¯å¦åˆšåˆšç™»å½•ï¼‰
      if (adminPageComputed === 'block' && (!token || !user)) {
        // å¦‚æœåˆšåˆšç™»å½•ï¼Œä¸æ‰§è¡Œåˆ‡æ¢
        if (window.__justLoggedIn) {
          console.log('â¸ï¸ checkAuthï¼šæ£€æµ‹åˆ°åˆšåˆšç™»å½•ï¼Œè·³è¿‡åˆ‡æ¢å›ç™»å½•é¡µ');
          return;
        }
        
        loginPage.style.setProperty('display', 'flex', 'important');
        adminPage.style.setProperty('display', 'none', 'important');
        console.log('âš ï¸ checkAuthï¼šæœªç™»å½•ï¼Œå·²åˆ‡æ¢åˆ°ç™»å½•é¡µé¢');
      }
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…ä¸ç™»å½•æµç¨‹å†²çªï¼‰
    function safeCheckAuth() {
      // å¦‚æœæ­£åœ¨ç™»å½•æˆ–åˆšåˆšç™»å½•ï¼Œè·³è¿‡
      if (window.__loginInProgress || window.__justLoggedIn) {
        console.log('â¸ï¸ å»¶è¿ŸcheckAuthï¼šç™»å½•æµç¨‹è¿›è¡Œä¸­');
        setTimeout(safeCheckAuth, 1000);
        return;
      }
      // å®‰å…¨ç‰ˆæœ¬çš„checkAuthè°ƒç”¨ï¼ˆæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼‰
    if (!window.__loginInProgress && !window.__justLoggedIn) {
      setTimeout(function() {
        if (!window.__loginInProgress && !window.__justLoggedIn) {
          checkAuth();
        }
      }, 2000);
    }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(safeCheckAuth, 1000);
      });
    } else {
      setTimeout(safeCheckAuth, 1000);
    }
    
    // ä¾§è¾¹æ èœå•åˆ‡æ¢
    document.querySelectorAll('.sidebar-item').forEach(item => {
      item.addEventListener('click', () => {
        const tabName = item.dataset.tab;
        
        // å¦‚æœç‚¹å‡»çš„æ˜¯Evoè®¾ç½®ï¼ŒåŠ è½½AIä¿¡æ¯
        if (tabName === 'evoSettings') {
          console.log('ğŸ”„ ç‚¹å‡»Evoè®¾ç½®èœå•é¡¹ï¼Œå‡†å¤‡åŠ è½½AIä¿¡æ¯...');
          setTimeout(() => {
            loadEvoAIModelInfo();
          }, 300);
        }
        
        // æ›´æ–°èœå•çŠ¶æ€
        document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        
        // éšè—æ‰€æœ‰sectionå’Œtab
        document.querySelectorAll('section[id$="View"], section[id$="View"]').forEach(section => {
          section.style.display = 'none';
        });
        document.querySelectorAll('[id$="Tab"]').forEach(tab => {
          tab.style.display = 'none';
        });
        
        // æ ¹æ®é€‰æ‹©çš„èœå•æ§åˆ¶ä¸»å†…å®¹æ˜¾ç¤ºï¼ˆç³»ç»Ÿå‡çº§æ˜¯ç‹¬ç«‹é¡µé¢ï¼‰
        const mainContentEl = document.querySelector('.main-content');
        if (mainContentEl) {
          if (tabName === 'upgradeView') {
            mainContentEl.style.display = 'none';
          } else {
            mainContentEl.style.display = '';
          }
        }
        
        // æ˜¾ç¤ºå¯¹åº”çš„è§†å›¾æˆ–æ ‡ç­¾é¡µ
        // ä¸»ç«™åŠŸèƒ½æ¨¡å—ä½¿ç”¨Viewåç¼€
        // æ³¨æ„ï¼šcoreAdminView è™½ç„¶ä»¥ View ç»“å°¾ï¼Œä½†å®é™…ä½¿ç”¨çš„æ˜¯ Tab åç¼€çš„å…ƒç´ 
        if (tabName === 'coreAdminView') {
          // ä¸­æ¢ç®¡å®¶ä½¿ç”¨coreAdminViewTabä½œä¸ºID
          const coreAdminTab = document.getElementById('coreAdminViewTab');
          if (coreAdminTab) {
            coreAdminTab.style.display = 'block';
          }
        } else if (tabName === 'upgradeView') {
          const upgradeTab = document.getElementById('upgradeViewTab');
          if (upgradeTab) {
            upgradeTab.style.display = 'block';
            // ç¡®ä¿ç³»ç»Ÿå‡çº§åŒºåŸŸåœ¨å¯è§†åŒºåŸŸå†…ï¼ˆå®ƒä½äºä¸»å†…å®¹ä¹‹åï¼‰
            setTimeout(() => {
              try {
                upgradeTab.scrollIntoView({ behavior: 'smooth', block: 'start' });
              } catch (e) {
                // Safari è€ç‰ˆæœ¬å¯èƒ½ä¸æ”¯æŒ options å†™æ³•ï¼Œé™çº§å¤„ç†
                upgradeTab.scrollIntoView(true);
              }
            }, 50);
          }
        } else if (tabName.endsWith('View')) {
          const targetView = document.getElementById(tabName);
          if (targetView) {
            targetView.style.display = '';
            // å¦‚æœæ˜¯cardç±»å‹çš„sectionï¼Œéœ€è¦è®¾ç½®ä¸ºblock
            if (targetView.classList.contains('card')) {
              targetView.style.display = 'block';
            }
          }
        } else {
          // æ™ºèƒ½ç®¡ç†åŠŸèƒ½ä½¿ç”¨Tabåç¼€
          const targetTab = document.getElementById(`${tabName}Tab`);
          if (targetTab) {
            targetTab.style.display = 'block';
            
            // å¦‚æœåˆ‡æ¢åˆ°ç³»ç»Ÿè®¾ç½®ï¼ŒåŠ è½½è®¾ç½®æ•°æ®
            if (tabName === 'settings') {
              loadSystemSettings();
            }
            
            // å¦‚æœæ˜¯Evoè®¾ç½®æ ‡ç­¾é¡µï¼ŒåŠ è½½AIä¿¡æ¯
            if (tabName === 'evoSettings') {
              console.log('ğŸ”„ Evoè®¾ç½®æ ‡ç­¾é¡µå·²æ˜¾ç¤ºï¼ŒåŠ è½½AIä¿¡æ¯...');
              setTimeout(() => {
                loadEvoAIModelInfo();
              }, 200);
            }
          }
        }
        
        // åŠ è½½å¯¹åº”å†…å®¹
        if (tabName === 'announcements') {
          loadAnnouncements();
        } else if (tabName === 'homeView') {
          // åˆå§‹åŒ–é¦–é¡µå†…å®¹
          initHomeView();
        } else if (tabName === 'dashboardView') {
          // åˆå§‹åŒ–æ•°æ®æ¦‚è§ˆ
          if (typeof refreshDashboard === 'function') refreshDashboard();
        } else if (tabName === 'listView') {
          // åˆå§‹åŒ–é¸½å­ç®¡ç†
          if (typeof renderPigeonList === 'function') renderPigeonList();
        } else if (tabName === 'pedigreeView') {
          // åˆå§‹åŒ–è¡€ç»Ÿå…³ç³»
          if (typeof fillPedigreeSelect === 'function') fillPedigreeSelect();
        } else if (tabName === 'statsView') {
          // åˆå§‹åŒ–ç»Ÿè®¡åˆ†æ
          if (typeof renderStatsViewTable === 'function') renderStatsViewTable();
        } else if (tabName === 'raceView') {
          // åˆå§‹åŒ–æ¯”èµ›ç®¡ç†
          if (typeof loadRaces === 'function') loadRaces();
        } else if (tabName === 'breedingView') {
          // åˆå§‹åŒ–ç¹è‚²é…å¯¹
          if (typeof fillBreedingSelects === 'function') fillBreedingSelects();
        } else if (tabName === 'healthView') {
          // åˆå§‹åŒ–å¥åº·ç®¡ç†
          if (typeof renderHealthOverview === 'function') renderHealthOverview();
        } else if (tabName === 'analysisView') {
          // åˆå§‹åŒ–æ™ºèƒ½åˆ†æ
          if (typeof runFullAnalysis === 'function') runFullAnalysis();
        } else if (tabName === 'trainingView') {
          // åˆå§‹åŒ–è®­ç»ƒæ¨¡å—
          if (typeof loadTrainingHistory === 'function') loadTrainingHistory();
        } else if (tabName === 'qualificationView') {
          // åˆå§‹åŒ–èƒ½åŠ›åˆ†æ
          if (typeof fillQualificationSelect === 'function') fillQualificationSelect();
        } else if (tabName === 'feedbackView') {
          // åŠ è½½æ„è§ä¸åé¦ˆåˆ—è¡¨
          if (typeof loadFeedbackList === 'function') loadFeedbackList();
        } else if (tabName === 'evoSettings') {
          // åˆå§‹åŒ–Evoè®¾ç½®ä¸ç›¸å…³åŠ©æ‰‹é…ç½®
          loadEvoSettings();
          loadAdminAIModelInfo(); // åŠ è½½AIæ¨¡å‹ä¿¡æ¯
          // åŒæ—¶åŠ è½½æ™ºè°±APIä¸åŠ©æ‰‹è¡Œä¸ºé…ç½®ï¼ˆå†™å…¥ localStorageï¼Œç”¨äºä¸»ç«™ Evo ä½¿ç”¨ï¼‰
          if (typeof loadZhipuConfig === 'function') loadZhipuConfig();
          if (typeof loadAssistantConfig === 'function') loadAssistantConfig();
        } else if (tabName === 'coreAdminView') {
          // ä¸­æ¢ç®¡å®¶æ ‡ç­¾é¡µå·²åœ¨ä¸Šé¢ç»Ÿä¸€å¤„ç†æ˜¾ç¤º
          // åˆå§‹åŒ–ä¸­æ¢ç®¡å®¶
          setTimeout(() => {
            loadCoreAdminData();
          }, 200);
        } else if (tabName === 'upgradeView') {
          // åˆå§‹åŒ–ç³»ç»Ÿå‡çº§
          setTimeout(() => {
            loadUpgradeData();
          }, 200);
        }
      });
    });
    
    // åŠ è½½å…¬å‘Šåˆ—è¡¨
    async function loadAnnouncements() {
      const container = document.getElementById('announcementsList');
      const token = localStorage.getItem('adminToken');
      if (!token) {
        container.innerHTML = '<p class="muted" style="text-align: center; padding: 40px;">è¯·å…ˆç™»å½•</p>';
        return;
      }
      
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`${getApiUrl()}/admin/announcements`, {
          headers: {
            'Authorization': `Bearer ${token}`
          },
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error('è·å–å…¬å‘Šåˆ—è¡¨å¤±è´¥');
        }
        
        const result = await response.json();
        const announcements = result.data || [];
        
        if (announcements.length === 0) {
          container.innerHTML = '<p class="muted" style="text-align: center; padding: 40px;">æš‚æ— å…¬å‘Šï¼Œç‚¹å‡»"å‘å¸ƒæ–°å…¬å‘Š"åˆ›å»ºç¬¬ä¸€æ¡å…¬å‘Š</p>';
        } else {
          // è½¬ä¹‰HTMLå‡½æ•°
          function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
          }
          
          container.innerHTML = announcements.map(ann => {
            const content = ann.content || '';
            const escapedContent = escapeHtml(content);
            const isLong = content.length > 150;
            const displayContent = isLong ? escapedContent.substring(0, 150) + '...' : escapedContent;
            
            // å®‰å…¨åœ°æ ¼å¼åŒ–æ—¥æœŸ
            function formatDate(dateString) {
              try {
                if (!dateString) return '-';
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '-';
                return date.toLocaleString('zh-CN');
              } catch (e) {
                return '-';
              }
            }
            
            const createdAtStr = formatDate(ann.createdAt);
            const updatedAtStr = ann.updatedAt && ann.updatedAt !== ann.createdAt ? formatDate(ann.updatedAt) : null;
            
            return `
            <div class="announcement-item">
              <div class="announcement-content" id="announcement-content-${ann.id}" onclick="toggleAnnouncementContent('${ann.id}')" data-full-content="${escapeHtml(escapedContent)}">
                ${displayContent}
              </div>
              ${isLong ? `<div class="announcement-view-full" onclick="event.stopPropagation(); viewFullAnnouncement('${ann.id}')">ğŸ“– æŸ¥çœ‹å®Œæ•´å…¬å‘Š</div>` : ''}
              <div class="announcement-meta">
                ${ann.active ? '<span class="status-badge status-active">âœ“ å·²å‘å¸ƒ</span>' : '<span class="status-badge status-draft">âœ— è‰ç¨¿</span>'}
                Â· åˆ›å»ºæ—¶é—´ï¼š${createdAtStr}
                ${updatedAtStr ? ` Â· æ›´æ–°æ—¶é—´ï¼š${updatedAtStr}` : ''}
              </div>
              <div class="announcement-actions">
                <button class="btn btn-outline btn-sm" onclick="viewAnnouncementHistory('${ann.id}')">å†å²</button>
                <button class="btn btn-outline btn-sm" onclick="editAnnouncement('${ann.id}')">ç¼–è¾‘</button>
                <button class="btn btn-outline btn-sm" onclick="deleteAnnouncement('${ann.id}')" style="color: var(--danger);">åˆ é™¤</button>
              </div>
            </div>
          `;
          }).join('');
          
          // ä¿å­˜å®Œæ•´å…¬å‘Šæ•°æ®ä¾›æŸ¥çœ‹ä½¿ç”¨
          window.announcementsData = announcements;
        }
        
        // åŠ è½½å†å²å…¬å‘Š
        loadAnnouncementHistory();
      } catch (error) {
        if (error.name === 'AbortError' || error.message.includes('Failed to fetch') || error.message.includes('Load failed')) {
          container.innerHTML = '<div style="padding: 20px; background: var(--warning-light); border-radius: var(--radius-md); margin-bottom: 16px;"><p style="color: #92400e; margin: 0;">âš ï¸ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ã€‚è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å·²å¯åŠ¨ã€‚</p></div><p class="muted" style="text-align: center; padding: 40px;">æ— æ³•åŠ è½½å…¬å‘Šåˆ—è¡¨</p>';
        } else {
        container.innerHTML = `<p style="color: var(--danger); text-align: center; padding: 40px;">åŠ è½½å¤±è´¥ï¼š${error.message}</p>`;
        }
        // å³ä½¿å…¬å‘Šåˆ—è¡¨åŠ è½½å¤±è´¥ï¼Œä¹Ÿå°è¯•åŠ è½½å†å²å…¬å‘Š
        loadAnnouncementHistory();
      }
    }
    
    // åŠ è½½å†å²å…¬å‘Šåˆ—è¡¨
    async function loadAnnouncementHistory() {
      const container = document.getElementById('announcementHistoryList');
      if (!container) return;
      
      const token = localStorage.getItem('adminToken');
      if (!token) {
        container.innerHTML = '<p class="muted" style="text-align: center; padding: 40px;">è¯·å…ˆç™»å½•</p>';
        return;
      }
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`${getApiUrl()}/admin/announcements`, {
          headers: {
            'Authorization': `Bearer ${token}`
          },
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error('è·å–å…¬å‘Šåˆ—è¡¨å¤±è´¥');
        }
        
        const result = await response.json();
        const announcements = result.data || [];
        
        // æ”¶é›†æ‰€æœ‰å†å²è®°å½•ï¼ˆåŒ…æ‹¬å½“å‰ç‰ˆæœ¬ï¼‰
        const allHistoryItems = [];
        
        // éªŒè¯æ—¥æœŸæ˜¯å¦æœ‰æ•ˆçš„è¾…åŠ©å‡½æ•°
        function isValidDate(dateString) {
          if (!dateString) return false;
          const date = new Date(dateString);
          return date instanceof Date && !isNaN(date);
        }
        
        // è·å–æœ‰æ•ˆçš„æ—¶é—´æˆ³
        function getValidTimestamp(timestamp, fallback) {
          if (isValidDate(timestamp)) {
            return timestamp;
          }
          if (fallback && isValidDate(fallback)) {
            return fallback;
          }
          return new Date().toISOString();
        }
        
        announcements.forEach(ann => {
          const validTimestamp = getValidTimestamp(ann.updatedAt, ann.createdAt);
          
          // æ·»åŠ å½“å‰ç‰ˆæœ¬ä½œä¸ºå†å²è®°å½•
          allHistoryItems.push({
            announcementId: ann.id,
            announcementContent: ann.content || '',
            content: ann.content || '',
            active: ann.active !== undefined ? ann.active : true,
            timestamp: validTimestamp,
            isCurrent: true
          });
          
          // æ·»åŠ å†å²ç‰ˆæœ¬
          if (ann.history && Array.isArray(ann.history) && ann.history.length > 0) {
            ann.history.forEach((histItem, idx) => {
              const histTimestamp = getValidTimestamp(histItem.timestamp, validTimestamp);
              allHistoryItems.push({
                announcementId: ann.id,
                announcementContent: ann.content || '',
                content: histItem.content || '',
                active: histItem.active !== undefined ? histItem.active : (ann.active !== undefined ? ann.active : true),
                timestamp: histTimestamp,
                isCurrent: false,
                versionIndex: idx + 1
              });
            });
          }
        });
        
        // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæ·»åŠ é”™è¯¯å¤„ç†ï¼‰
        allHistoryItems.sort((a, b) => {
          try {
            const dateA = new Date(a.timestamp);
            const dateB = new Date(b.timestamp);
            if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) {
              return 0; // å¦‚æœæ—¥æœŸæ— æ•ˆï¼Œä¿æŒåŸæœ‰é¡ºåº
            }
            return dateB - dateA;
          } catch (e) {
            return 0;
          }
        });
        
        if (allHistoryItems.length === 0) {
          container.innerHTML = '<p class="muted" style="text-align: center; padding: 40px;">æš‚æ— å†å²å…¬å‘Šè®°å½•</p>';
          return;
        }
        
        // è½¬ä¹‰HTMLå‡½æ•°
        function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text || '';
          return div.innerHTML;
        }
        
        // å°†å†å²æ•°æ®å­˜å‚¨åˆ°å…¨å±€å˜é‡ï¼Œä¾›æŒ‰é’®äº‹ä»¶ä½¿ç”¨
        window.allHistoryItemsData = allHistoryItems;
        
        container.innerHTML = allHistoryItems.map((item, index) => {
          const content = item.content || '';
          const escapedContent = escapeHtml(content);
          const isLong = content.length > 100;
          const displayContent = isLong ? escapedContent.substring(0, 100) + '...' : escapedContent;
          
          // å®‰å…¨åœ°æ ¼å¼åŒ–æ—¶é—´æˆ³
          let timestamp = '-';
          try {
            const date = new Date(item.timestamp);
            if (!isNaN(date.getTime())) {
              timestamp = date.toLocaleString('zh-CN');
            }
          } catch (e) {
            console.warn('æ—¶é—´æˆ³æ ¼å¼åŒ–å¤±è´¥:', item.timestamp, e);
          }
          
          return `
            <div class="announcement-history-item" style="padding: 16px; border: 1px solid var(--border-light); border-radius: var(--radius-md); margin-bottom: 12px; background: var(--bg-secondary);">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                    ${item.isCurrent ? '<span style="background: var(--primary-light); color: var(--primary); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">å½“å‰ç‰ˆæœ¬</span>' : ''}
                    <span style="color: var(--text-secondary); font-size: 12px;">${timestamp}</span>
                  </div>
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                    çŠ¶æ€ï¼š${item.active ? '<span style="color: var(--success);">âœ“ å·²å‘å¸ƒ</span>' : '<span style="color: var(--text-muted);">âœ— è‰ç¨¿</span>'}
                  </div>
                </div>
              </div>
              <div class="history-content" style="color: var(--text-primary); line-height: 1.6; word-break: break-word; white-space: pre-wrap;">
                ${displayContent}
              </div>
              ${isLong ? `<div style="margin-top: 8px;"><button class="btn btn-ghost btn-sm view-history-detail-btn" data-index="${index}" style="font-size: 12px; padding: 4px 8px;">æŸ¥çœ‹å®Œæ•´å†…å®¹</button></div>` : ''}
            </div>
          `;
        }).join('');
        
        // ä¸ºæŸ¥çœ‹è¯¦æƒ…æŒ‰é’®ç»‘å®šäº‹ä»¶
        container.querySelectorAll('.view-history-detail-btn').forEach((btn) => {
          btn.addEventListener('click', function() {
            // ä»å­˜å‚¨çš„å…¨å±€æ•°æ®ä¸­è·å–å†…å®¹ï¼ˆé¿å…HTMLè½¬ä¹‰é—®é¢˜ï¼‰
            const idx = parseInt(this.dataset.index);
            const item = window.allHistoryItemsData && window.allHistoryItemsData[idx];
            if (item) {
              viewHistoryItemDetail(item.content, item.timestamp, item.active, item.announcementId);
            }
          });
        });
        
      } catch (error) {
        console.error('åŠ è½½å†å²å…¬å‘Šå¤±è´¥:', error);
        if (error.name === 'AbortError' || error.message.includes('Failed to fetch')) {
          container.innerHTML = '<p class="muted" style="text-align: center; padding: 40px; color: var(--danger);">æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦å·²å¯åŠ¨</p>';
        } else {
          container.innerHTML = `<p style="color: var(--danger); text-align: center; padding: 40px;">åŠ è½½å¤±è´¥ï¼š${error.message}</p>`;
        }
      }
    }
    
    // æŸ¥çœ‹å†å²è®°å½•è¯¦æƒ…
    window.viewHistoryItemDetail = function(content, timestamp, active, announcementId) {
      let detailModal = document.getElementById('historyDetailModal');
      let isNewModal = false;
      
      if (!detailModal) {
        isNewModal = true;
        detailModal = document.createElement('div');
        detailModal.id = 'historyDetailModal';
        detailModal.className = 'modal';
        detailModal.innerHTML = `
          <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
              <h3>ğŸ“œ å†å²å…¬å‘Šè¯¦æƒ…</h3>
              <button class="btn btn-ghost btn-sm" onclick="closeHistoryDetailModal()" style="padding: 4px 12px;">âœ•</button>
            </div>
            <div class="modal-body">
              <div style="margin-bottom: 16px;">
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                  ğŸ“… æ—¶é—´ï¼š<span id="historyDetailTimestamp"></span>
                </div>
                <div style="font-size: 13px; color: var(--text-secondary);">
                  çŠ¶æ€ï¼š<span id="historyDetailStatus"></span>
                </div>
              </div>
              <div style="padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); white-space: pre-wrap; word-break: break-word; line-height: 1.8; color: var(--text-primary);" id="historyDetailContent"></div>
              <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-primary" onclick="closeHistoryDetailModal()">å…³é—­</button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(detailModal);
        
        // åªåœ¨é¦–æ¬¡åˆ›å»ºæ—¶ç»‘å®šç‚¹å‡»èƒŒæ™¯å…³é—­äº‹ä»¶ï¼ˆé¿å…é‡å¤ç»‘å®šï¼‰
        detailModal.addEventListener('click', function(e) {
          if (e.target === detailModal) {
            closeHistoryDetailModal();
          }
        });
      }
      
      // å®‰å…¨åœ°æ ¼å¼åŒ–æ—¶é—´æˆ³
      let formattedTimestamp = '-';
      try {
        if (timestamp) {
          const date = new Date(timestamp);
          if (!isNaN(date.getTime())) {
            formattedTimestamp = date.toLocaleString('zh-CN');
          }
        }
      } catch (e) {
        console.warn('æ—¶é—´æˆ³æ ¼å¼åŒ–å¤±è´¥:', timestamp, e);
      }
      document.getElementById('historyDetailTimestamp').textContent = formattedTimestamp;
      document.getElementById('historyDetailStatus').innerHTML = active 
        ? '<span style="color: var(--success);">âœ“ å·²å‘å¸ƒ</span>' 
        : '<span style="color: var(--text-muted);">âœ— è‰ç¨¿</span>';
      
      // è®¾ç½®å†…å®¹ï¼ˆä½¿ç”¨textContentç¡®ä¿å®‰å…¨æ˜¾ç¤ºï¼‰
      document.getElementById('historyDetailContent').textContent = content || 'æš‚æ— å†…å®¹';
      
      detailModal.classList.add('active');
    };
    
    window.closeHistoryDetailModal = function() {
      const modal = document.getElementById('historyDetailModal');
      if (modal) {
        modal.classList.remove('active');
      }
    };

    // æ„è§ä¸åé¦ˆç­›é€‰ä¸åˆ·æ–°æŒ‰é’®äº‹ä»¶
    (function initFeedbackEvents() {
      const statusSelect = document.getElementById('feedbackStatusFilter');
      const refreshBtn = document.getElementById('btnRefreshFeedback');

      if (statusSelect) {
        statusSelect.addEventListener('change', () => {
          loadFeedbackList();
        });
      }

      if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
          loadFeedbackList();
        });
      }
    })();

    // åŠ è½½ç”¨æˆ·æ„è§ä¸åé¦ˆåˆ—è¡¨
    async function loadFeedbackList() {
      const tbody = document.getElementById('feedbackTableBody');
      const statusFilter = document.getElementById('feedbackStatusFilter');
      const token = localStorage.getItem('adminToken');

      if (!tbody) return;

      if (!token) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:32px;">è¯·å…ˆç™»å½•</td></tr>';
        return;
      }

      const status = statusFilter ? statusFilter.value : '';

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);

        const url = new URL(`${getApiUrl()}/admin/feedbacks`);
        if (status) {
          url.searchParams.set('status', status);
        }

        const response = await fetch(url.toString(), {
          headers: {
            'Authorization': `Bearer ${token}`
          },
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error('è·å–åé¦ˆåˆ—è¡¨å¤±è´¥');
        }

        const result = await response.json();
        const items = (result.data && result.data.items) || [];

        if (items.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:32px;">æš‚æ— åé¦ˆæ•°æ®</td></tr>';
          return;
        }

        function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text || '';
          return div.innerHTML;
        }

        tbody.innerHTML = items.map(item => {
          const createdAt = item.createdAt ? new Date(item.createdAt).toLocaleString('zh-CN') : '-';
          const source = item.source || 'web';
          const page = item.page || '';
          const user = item.username ? `${escapeHtml(item.username)} (${item.userId || '-'})` : 'æœªç™»å½•ç”¨æˆ·';
          const content = escapeHtml(item.content || '');
          const contact = escapeHtml(item.contact || '');

          const sourceLabel = source === 'mobile' ? 'ç§»åŠ¨ç«¯' : 'ç½‘é¡µç«¯';
          const pageLabel = page ? ` / ${page}` : '';

          return `
            <tr>
              <td>${createdAt}</td>
              <td>${sourceLabel}${pageLabel}</td>
              <td>${user}</td>
              <td style="max-width:360px;white-space:normal;word-break:break-word;">${content}</td>
              <td>${contact || '<span style="color:var(--text-muted);">æœªå¡«å†™</span>'}</td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        console.error('åŠ è½½åé¦ˆåˆ—è¡¨å¤±è´¥:', error);
        if (error.name === 'AbortError' || error.message.includes('Failed to fetch') || error.message.includes('Load failed')) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--danger);padding:32px;">æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦å·²å¯åŠ¨</td></tr>';
        } else {
          tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:var(--danger);padding:32px;">åŠ è½½å¤±è´¥ï¼š${error.message}</td></tr>`;
        }
      }
    }
    
    // ==========================================
    // ç”¨æˆ·ç®¡ç†åŠŸèƒ½
    // ==========================================
    
    // åŠ è½½ç”¨æˆ·åˆ—è¡¨
    window.loadUsers = async function() {
      const container = document.getElementById('usersList');
      const token = localStorage.getItem('adminToken');
      if (!token) {
        container.innerHTML = '<p class="muted" style="text-align: center; padding: 40px;">è¯·å…ˆç™»å½•</p>';
        return;
      }
      
      
      container.innerHTML = '<p class="muted" style="text-align: center; padding: 40px;">åŠ è½½ä¸­...</p>';
      
      try {
        const searchQuery = document.getElementById('userSearchInput')?.value || '';
        const apiUrl = getApiUrl();
        
        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        const usersResponse = await fetch(`${apiUrl}/admin/users?limit=100${searchQuery ? `&search=${encodeURIComponent(searchQuery)}` : ''}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!usersResponse.ok) {
          throw new Error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
        }
        
        const usersResult = await usersResponse.json();
        const users = usersResult.data?.users || [];
        
        // åŠ è½½ç”¨æˆ·æ•°æ®ç»Ÿè®¡
        const dataResponse = await fetch(`${apiUrl}/admin/users/data`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        let userDataStats = {};
        if (dataResponse.ok) {
          const dataResult = await dataResponse.json();
          if (dataResult.success && dataResult.data) {
            dataResult.data.forEach(stat => {
              userDataStats[stat.userId] = stat;
            });
          }
        }
        
        if (users.length === 0) {
          container.innerHTML = '<p class="muted" style="text-align: center; padding: 40px;">æš‚æ— ç”¨æˆ·</p>';
          return;
        }
        
        container.innerHTML = `
          <div style="overflow-x:auto;">
            <table style="width:100%;border-collapse:collapse;">
              <thead>
                <tr style="background:var(--gray-50);border-bottom:2px solid var(--border-light);">
                  <th style="padding:12px;text-align:left;font-weight:600;color:var(--text-primary);">ç”¨æˆ·å</th>
                  <th style="padding:12px;text-align:left;font-weight:600;color:var(--text-primary);">é‚®ç®±</th>
                  <th style="padding:12px;text-align:left;font-weight:600;color:var(--text-primary);">è§’è‰²</th>
                  <th style="padding:12px;text-align:left;font-weight:600;color:var(--text-primary);">çŠ¶æ€</th>
                  <th style="padding:12px;text-align:left;font-weight:600;color:var(--text-primary);">é¸½å­æ•°é‡</th>
                  <th style="padding:12px;text-align:left;font-weight:600;color:var(--text-primary);">æ³¨å†Œæ—¶é—´</th>
                  <th style="padding:12px;text-align:left;font-weight:600;color:var(--text-primary);">æœ€åç™»å½•</th>
                  <th style="padding:12px;text-align:left;font-weight:600;color:var(--text-primary);">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${users.map(user => {
                  const stats = userDataStats[user.id] || {};
                  const statusBadge = user.status === 'active' 
                    ? '<span style="padding:4px 8px;background:#d1fae5;color:#065f46;border-radius:4px;font-size:12px;">âœ“ æ´»è·ƒ</span>'
                    : user.status === 'inactive'
                    ? '<span style="padding:4px 8px;background:#fef3c7;color:#92400e;border-radius:4px;font-size:12px;">â—‹ æœªæ¿€æ´»</span>'
                    : '<span style="padding:4px 8px;background:#fee2e2;color:#991b1b;border-radius:4px;font-size:12px;">âœ— å·²ç¦ç”¨</span>';
                  
                  const roleBadge = user.role === 'admin'
                    ? '<span style="padding:4px 8px;background:#dbeafe;color:#1e40af;border-radius:4px;font-size:12px;">ç®¡ç†å‘˜</span>'
                    : '<span style="padding:4px 8px;background:#f3f4f6;color:#4b5563;border-radius:4px;font-size:12px;">æ™®é€šç”¨æˆ·</span>';
                  
                  return `
                    <tr style="border-bottom:1px solid var(--border-light);">
                      <td style="padding:12px;">${user.username || '--'}</td>
                      <td style="padding:12px;">${user.email || '--'}</td>
                      <td style="padding:12px;">${roleBadge}</td>
                      <td style="padding:12px;">${statusBadge}</td>
                      <td style="padding:12px;">
                        <span style="color:var(--primary);font-weight:600;">${stats.pigeonsCount || 0}</span>
                      </td>
                      <td style="padding:12px;color:var(--text-secondary);font-size:13px;">
                        ${user.createdAt ? new Date(user.createdAt).toLocaleString('zh-CN') : '--'}
                      </td>
                      <td style="padding:12px;color:var(--text-secondary);font-size:13px;">
                        ${user.lastLogin ? new Date(user.lastLogin).toLocaleString('zh-CN') : 'ä»æœªç™»å½•'}
                      </td>
                      <td style="padding:12px;">
                        <button class="btn btn-outline btn-sm" onclick="viewUserData('${user.id}', '${user.username}')" style="margin-right:8px;">ğŸ“Š æŸ¥çœ‹æ•°æ®</button>
                        ${user.status === 'active' 
                          ? `<button class="btn btn-outline btn-sm" onclick="updateUserStatus('${user.id}', 'inactive')" style="color:var(--warning);">ç¦ç”¨</button>`
                          : `<button class="btn btn-outline btn-sm" onclick="updateUserStatus('${user.id}', 'active')" style="color:var(--success);">å¯ç”¨</button>`
                        }
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
        container.innerHTML = `<p style="color: var(--danger); text-align: center; padding: 40px;">åŠ è½½å¤±è´¥ï¼š${error.message}</p>`;
      }
    };
    
    // æŸ¥çœ‹ç”¨æˆ·æ•°æ®
    window.viewUserData = async function(userId, username) {
      const modal = document.getElementById('userDataModal');
      const modalBody = document.getElementById('userDataModalBody');
      const modalTitle = document.getElementById('userDataModalTitle');
      const token = localStorage.getItem('adminToken');
      
      if (!token) {
        alert('è¯·å…ˆç™»å½•');
        return;
      }
      
      modal.style.display = 'flex';
      modalTitle.textContent = `ç”¨æˆ·æ•°æ® - ${username}`;
      modalBody.innerHTML = '<p class="muted">åŠ è½½ä¸­...</p>';
      
      try {
        const apiUrl = getApiUrl();
        const response = await fetch(`${apiUrl}/admin/users/${userId}/data`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('è·å–ç”¨æˆ·æ•°æ®å¤±è´¥');
        }
        
        const result = await response.json();
        const userData = result.data;
        const data = userData?.data || {};
        const pigeons = data.pigeons || [];
        const races = data.races || [];
        const healthRecords = data.healthRecords || [];
        const trainingRecords = data.trainingRecords || [];
        const pairings = data.pairings || [];
        const qualificationRecords = data.qualificationRecords || [];
        const sharing = userData.sharing || { visibility: 'private', allowedUserIds: [] };
        
        if (pigeons.length === 0 && races.length === 0 && healthRecords.length === 0 && trainingRecords.length === 0) {
          modalBody.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">è¯¥ç”¨æˆ·æš‚æ— åŒæ­¥æ•°æ®</p>';
          return;
        }
        
        modalBody.innerHTML = `
          <div style="margin-bottom:20px;">
            <h4 style="margin-bottom:12px;">ğŸ“Š æ•°æ®ç»Ÿè®¡</h4>
            <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;">
              <div style="padding:16px;background:var(--gray-50);border-radius:8px;">
                <div style="font-size:24px;font-weight:600;color:var(--primary);">${pigeons.length}</div>
                <div style="font-size:13px;color:var(--text-secondary);margin-top:4px;">é¸½å­æ€»æ•°</div>
              </div>
              <div style="padding:16px;background:var(--gray-50);border-radius:8px;">
                <div style="font-size:24px;font-weight:600;color:var(--success);">${pigeons.filter(p => p.alive !== false).length}</div>
                <div style="font-size:13px;color:var(--text-secondary);margin-top:4px;">å­˜æ´»æ•°é‡</div>
              </div>
              <div style="padding:16px;background:var(--gray-50);border-radius:8px;">
                <div style="font-size:13px;color:var(--text-secondary);">æœ€åæ›´æ–°</div>
                <div style="font-size:14px;color:var(--text-primary);margin-top:4px;">${userData.updatedAt ? new Date(userData.updatedAt).toLocaleString('zh-CN') : '--'}</div>
              </div>
            </div>
          </div>
          
          <div style="margin-bottom:20px;">
            <h4 style="margin-bottom:12px;">ğŸ” å…±äº«ä¸æƒé™</h4>
            <div style="padding:16px;background:var(--gray-50);border-radius:8px;display:flex;flex-direction:column;gap:12px;">
              <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                <label style="font-size:13px;color:var(--text-secondary);min-width:80px;">å¯è§èŒƒå›´</label>
                <select id="userSharingVisibility" style="padding:6px 10px;border-radius:6px;border:1px solid var(--border-light);font-size:13px;">
                  <option value="private" ${sharing.visibility === 'private' ? 'selected' : ''}>ä»…æœ¬äººå¯è§</option>
                  <option value="shared" ${sharing.visibility === 'shared' ? 'selected' : ''}>ç«™å†…å…±äº«ï¼ˆç™»å½•ç”¨æˆ·å¯è§ï¼‰</option>
                  <option value="public" ${sharing.visibility === 'public' ? 'selected' : ''}>å…¬å¼€ï¼ˆæ‰€æœ‰è®¿å®¢å¯è§ï¼‰</option>
                </select>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px;">
                <label style="font-size:13px;color:var(--text-secondary);">åä½œç¼–è¾‘å…è®¸çš„ç”¨æˆ·IDï¼ˆé€—å·åˆ†éš”ï¼Œå¯é€‰ï¼‰</label>
                <input id="userSharingAllowedIds" type="text" placeholder="ä¾‹å¦‚: user_1,user_2" 
                  value="${Array.isArray(sharing.allowedUserIds) && sharing.allowedUserIds.length ? sharing.allowedUserIds.join(',') : ''}"
                  style="padding:6px 10px;border-radius:6px;border:1px solid var(--border-light);font-size:13px;width:100%;" />
                <p class="muted" style="font-size:12px;margin:0;">è¯´æ˜ï¼šä»…ç®¡ç†å‘˜å’Œæ•°æ®æ‰€æœ‰è€…å¯ä»¥ä¿®æ”¹å…±äº«è®¾ç½®ï¼Œå…¶ä»–ç”¨æˆ·å³ä½¿èƒ½æŸ¥çœ‹æ•°æ®ä¹Ÿä¸èƒ½ç¼–è¾‘ã€‚</p>
              </div>
              <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:4px;">
                <button class="btn btn-outline btn-sm" onclick="saveUserSharing('${userId}')" style="font-size:13px;">ğŸ’¾ ä¿å­˜å…±äº«è®¾ç½®</button>
              </div>
            </div>
          </div>
          
          <div>
            <h4 style="margin-bottom:12px;">ğŸ•Šï¸ é¸½å­åˆ—è¡¨</h4>
            <div style="max-height:400px;overflow-y:auto;">
              ${pigeons.length === 0 
                ? '<p class="muted" style="text-align:center;padding:20px;">æš‚æ— é¸½å­æ•°æ®</p>'
                : pigeons.map(p => `
                  <div style="padding:12px;background:var(--gray-50);border-radius:8px;margin-bottom:8px;">
                    <div style="font-weight:600;margin-bottom:4px;">${p.name || 'æœªå‘½å'}</div>
                    <div style="font-size:12px;color:var(--text-secondary);">
                      ${p.ringNumber ? `è¶³ç¯å·: ${p.ringNumber} Â· ` : ''}
                      ${p.gender ? `æ€§åˆ«: ${p.gender} Â· ` : ''}
                      ${p.type ? `ç±»å‹: ${p.type}` : ''}
                    </div>
                  </div>
                `).join('')
              }
            </div>
          </div>
          
          <div style="margin-top:24px;">
            <h4 style="margin-bottom:12px;">ğŸ æ¯”èµ›è®°å½•æ¦‚è§ˆ</h4>
            ${races.length === 0 
              ? '<p class="muted" style="font-size:13px;">æš‚æ— æ¯”èµ›æ•°æ®</p>'
              : `<p class="muted" style="font-size:13px;margin-bottom:8px;">å…± ${races.length} åœºæ¯”èµ›è®°å½•ã€‚</p>`}
          </div>
        `;
      } catch (error) {
        console.error('è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
        modalBody.innerHTML = `<p style="color: var(--danger); text-align: center; padding: 40px;">åŠ è½½å¤±è´¥ï¼š${error.message}</p>`;
      }
    };
    
    // å…³é—­ç”¨æˆ·æ•°æ®æ¨¡æ€æ¡†
    window.closeUserDataModal = function() {
      const modal = document.getElementById('userDataModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };

    // ä¿å­˜ç”¨æˆ·å…±äº«è®¾ç½®ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
    window.saveUserSharing = async function(userId) {
      const visibilitySelect = document.getElementById('userSharingVisibility');
      const allowedIdsInput = document.getElementById('userSharingAllowedIds');
      const token = localStorage.getItem('adminToken');
      
      if (!token) {
        alert('è¯·å…ˆç™»å½•');
        return;
      }
      
      const visibility = visibilitySelect ? visibilitySelect.value : 'private';
      const allowedIdsRaw = allowedIdsInput ? allowedIdsInput.value.trim() : '';
      const allowedUserIds = allowedIdsRaw
        ? allowedIdsRaw.split(',').map(id => id.trim()).filter(Boolean)
        : [];
      
      try {
        const apiUrl = getApiUrl();
        const resp = await fetch(`${apiUrl}/admin/users/${userId}/sharing`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ visibility, allowedUserIds })
        });
        
        const result = await resp.json();
        if (!resp.ok || !result.success) {
          throw new Error(result.error || 'ä¿å­˜å…±äº«è®¾ç½®å¤±è´¥');
        }
        
        alert('å…±äº«è®¾ç½®å·²ä¿å­˜');
      } catch (error) {
        console.error('ä¿å­˜å…±äº«è®¾ç½®å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
      }
    };
    
    // æ›´æ–°ç”¨æˆ·çŠ¶æ€
    window.updateUserStatus = async function(userId, status) {
      if (!confirm(`ç¡®å®šè¦${status === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨'}è¯¥ç”¨æˆ·å—ï¼Ÿ`)) {
        return;
      }
      
      const token = localStorage.getItem('adminToken');
      try {
        const apiUrl = getApiUrl();
        const response = await fetch(`${apiUrl}/admin/users/${userId}/status`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status })
        });
        
        if (!response.ok) {
          throw new Error('æ›´æ–°ç”¨æˆ·çŠ¶æ€å¤±è´¥');
        }
        
        alert('ç”¨æˆ·çŠ¶æ€æ›´æ–°æˆåŠŸ');
        loadUsers();
      } catch (error) {
        console.error('æ›´æ–°ç”¨æˆ·çŠ¶æ€å¤±è´¥:', error);
        alert('æ›´æ–°å¤±è´¥ï¼š' + error.message);
      }
    };
    
    // ç»‘å®šæœç´¢è¾“å…¥æ¡†
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('userSearchInput');
      if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            loadUsers();
          }, 500);
        });
      }
      
      // ç”¨æˆ·ç®¡ç†æ ‡ç­¾é¡µæ˜¾ç¤ºæ—¶è‡ªåŠ¨åŠ è½½
      const usersTab = document.getElementById('usersTab');
      if (usersTab) {
        const observer = new MutationObserver(function(mutations) {
          if (usersTab.style.display !== 'none') {
            loadUsers();
          }
        });
        observer.observe(usersTab, { attributes: true, attributeFilter: ['style'] });
      }
    });
    
    // ç¼–è¾‘å…¬å‘Š
    window.editAnnouncement = async function(id) {
      const token = localStorage.getItem('adminToken');
      
      try {
        const response = await fetch(`${getApiUrl()}/admin/announcements`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) throw new Error('è·å–å…¬å‘Šå¤±è´¥');
        
        const result = await response.json();
        const announcement = result.data.find(a => a.id === id);
        
        if (!announcement) {
          alert('å…¬å‘Šä¸å­˜åœ¨');
          return;
        }
        
        document.getElementById('announcementId').value = announcement.id;
        document.getElementById('announcementContent').value = announcement.content;
        document.getElementById('announcementActive').checked = announcement.active;
        document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å…¬å‘Š';
        document.getElementById('announcementModal').classList.add('active');
      } catch (error) {
        alert('åŠ è½½å…¬å‘Šå¤±è´¥ï¼š' + error.message);
      }
    };
    
    // åˆ‡æ¢å…¬å‘Šå†…å®¹å±•å¼€/æ”¶èµ·
    window.toggleAnnouncementContent = function(id) {
      const contentEl = document.getElementById(`announcement-content-${id}`);
      if (contentEl) {
        const isExpanded = contentEl.classList.contains('expanded');
        if (!isExpanded) {
          // å±•å¼€æ—¶æ˜¾ç¤ºå®Œæ•´å†…å®¹
          const fullContent = contentEl.getAttribute('data-full-content') || contentEl.textContent;
          contentEl.innerHTML = fullContent;
          contentEl.classList.add('expanded');
        } else {
          // æ”¶èµ·æ—¶æ¢å¤æˆªæ–­æ˜¾ç¤º
          const fullContent = contentEl.getAttribute('data-full-content') || contentEl.textContent;
          const displayContent = fullContent.length > 150 ? fullContent.substring(0, 150) + '...' : fullContent;
          contentEl.innerHTML = displayContent;
          contentEl.classList.remove('expanded');
        }
      }
    };
    
    // æŸ¥çœ‹å®Œæ•´å…¬å‘Š
    window.viewFullAnnouncement = function(id) {
      if (!window.announcementsData) {
        alert('å…¬å‘Šæ•°æ®æœªåŠ è½½');
        return;
      }
      
      const announcement = window.announcementsData.find(a => a.id === id);
      if (!announcement) {
        alert('å…¬å‘Šä¸å­˜åœ¨');
        return;
      }
      
      // åˆ›å»ºæˆ–è·å–æŸ¥çœ‹å…¬å‘Šçš„æ¨¡æ€æ¡†
      let viewModal = document.getElementById('viewAnnouncementModal');
      if (!viewModal) {
        viewModal = document.createElement('div');
        viewModal.id = 'viewAnnouncementModal';
        viewModal.className = 'modal';
        viewModal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h3>ğŸ“¢ å…¬å‘Šè¯¦æƒ…</h3>
              <button class="btn btn-ghost btn-sm" onclick="closeViewAnnouncementModal()" style="padding: 4px 12px;">âœ•</button>
            </div>
            <div class="modal-body">
              <div style="padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); margin-bottom: 16px; white-space: pre-wrap; word-break: break-word; line-height: 1.8; color: var(--text-primary);" id="viewAnnouncementContent"></div>
              <div style="font-size: 12px; color: var(--text-secondary);">
                <div>ğŸ“… åˆ›å»ºæ—¶é—´ï¼š<span id="viewAnnouncementCreatedAt"></span></div>
                <div id="viewAnnouncementUpdatedAt" style="margin-top: 8px;"></div>
                <div style="margin-top: 8px;">çŠ¶æ€ï¼š<span id="viewAnnouncementStatus"></span></div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" onclick="closeViewAnnouncementModal()">å…³é—­</button>
            </div>
          </div>
        `;
        document.body.appendChild(viewModal);
      }
      
      // å¡«å……å†…å®¹
      document.getElementById('viewAnnouncementContent').textContent = announcement.content || 'æš‚æ— å†…å®¹';
      
      // å®‰å…¨åœ°æ ¼å¼åŒ–æ—¥æœŸ
      function formatDate(dateString) {
        try {
          if (!dateString) return '-';
          const date = new Date(dateString);
          if (isNaN(date.getTime())) return '-';
          return date.toLocaleString('zh-CN');
        } catch (e) {
          return '-';
        }
      }
      
      document.getElementById('viewAnnouncementCreatedAt').textContent = formatDate(announcement.createdAt);
      
      const updatedAtEl = document.getElementById('viewAnnouncementUpdatedAt');
      if (announcement.updatedAt && announcement.updatedAt !== announcement.createdAt) {
        const formattedUpdatedAt = formatDate(announcement.updatedAt);
        updatedAtEl.innerHTML = `ğŸ”„ æ›´æ–°æ—¶é—´ï¼š<span>${formattedUpdatedAt}</span>`;
        updatedAtEl.style.display = 'block';
      } else {
        updatedAtEl.style.display = 'none';
      }
      
      const statusEl = document.getElementById('viewAnnouncementStatus');
      statusEl.innerHTML = announcement.active 
        ? '<span class="status-badge status-active">âœ“ å·²å‘å¸ƒ</span>' 
        : '<span class="status-badge status-draft">âœ— è‰ç¨¿</span>';
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      viewModal.classList.add('active');
      
      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      viewModal.addEventListener('click', function(e) {
        if (e.target === viewModal) {
          closeViewAnnouncementModal();
        }
      });
    };
    
    // æŸ¥çœ‹å…¬å‘Šå†å²
    window.viewAnnouncementHistory = async function(id) {
      const token = localStorage.getItem('adminToken');
      if (!token) {
        alert('è¯·å…ˆç™»å½•');
        return;
      }
      let historyModal = document.getElementById('announcementHistoryModal');
      if (!historyModal) {
        historyModal = document.createElement('div');
        historyModal.id = 'announcementHistoryModal';
        historyModal.className = 'modal';
        historyModal.innerHTML = `
          <div class="modal-content" style="max-width: 640px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
              <h3>ğŸ“œ å†å²å…¬å‘Šè®°å½•</h3>
              <button class="btn btn-ghost btn-sm" onclick="closeAnnouncementHistory()" style="padding: 4px 12px;">âœ•</button>
            </div>
            <div class="modal-body" id="announcementHistoryBody" style="padding: 12px 0;">
              <p class="muted" style="text-align:center;">åŠ è½½ä¸­...</p>
            </div>
          </div>
        `;
        document.body.appendChild(historyModal);
      }
      const bodyEl = document.getElementById('announcementHistoryBody');
      historyModal.classList.add('active');
      try {
        const resp = await fetch(`${getApiUrl()}/admin/announcements/${id}/history`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!resp.ok) throw new Error('åŠ è½½å¤±è´¥');
        const result = await resp.json();
        const history = result.data || [];
        if (history.length === 0) {
          bodyEl.innerHTML = '<p class="muted" style="text-align:center;">æš‚æ— å†å²è®°å½•</p>';
          return;
        }
        const listHtml = history.map((item, idx) => `
          <div style="padding:12px 16px; border-bottom:1px solid var(--border-light);">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
              <div style="font-weight:600;">ç‰ˆæœ¬ ${history.length - idx}</div>
              <div style="color:var(--text-secondary); font-size:12px;">${new Date(item.timestamp || item.updatedAt || Date.now()).toLocaleString('zh-CN')}</div>
            </div>
            <div style="margin-top:8px; color:var(--text-secondary);">çŠ¶æ€ï¼š${item.active ? 'âœ“ å·²å‘å¸ƒ' : 'âœ— è‰ç¨¿'}</div>
            <div style="margin-top:8px; white-space: pre-wrap; word-break: break-word;">${item.content || ''}</div>
          </div>
        `).join('');
        bodyEl.innerHTML = listHtml;
      } catch (e) {
        bodyEl.innerHTML = `<p style="color:var(--danger);text-align:center;">åŠ è½½å¤±è´¥ï¼š${e.message}</p>`;
      }
      historyModal.addEventListener('click', function(e) {
        if (e.target === historyModal) {
          closeAnnouncementHistory();
        }
      });
    };
    
    window.closeAnnouncementHistory = function() {
      const modal = document.getElementById('announcementHistoryModal');
      if (modal) modal.classList.remove('active');
    };
    
    // å…³é—­æŸ¥çœ‹å…¬å‘Šæ¨¡æ€æ¡†
    window.closeViewAnnouncementModal = function() {
      const viewModal = document.getElementById('viewAnnouncementModal');
      if (viewModal) {
        viewModal.classList.remove('active');
      }
    };
    
    // åˆ é™¤å…¬å‘Š
    window.deleteAnnouncement = async function(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å…¬å‘Šå—ï¼Ÿ')) {
        return;
      }
      
      const token = localStorage.getItem('adminToken');
      
      try {
        const response = await fetch(`${getApiUrl()}/admin/announcements/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) throw new Error('åˆ é™¤å¤±è´¥');
        
        const result = await response.json();
        if (result.success) {
          loadAnnouncements();
          // å¦‚æœå½“å‰åœ¨é¦–é¡µï¼Œåˆ·æ–°ä¸»é¡µå…¬å‘Šæ 
          const homeView = document.getElementById('homeView');
          if (homeView && homeView.style.display !== 'none') {
            loadHomeAnnouncementBubble();
          }
        }
      } catch (error) {
        alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
      }
    };
    
    // åˆ›å»ºæ–°å…¬å‘Š
    document.getElementById('createAnnouncementBtn').addEventListener('click', () => {
      document.getElementById('announcementId').value = '';
      document.getElementById('announcementContent').value = '';
      document.getElementById('announcementActive').checked = true;
      document.getElementById('modalTitle').textContent = 'å‘å¸ƒæ–°å…¬å‘Š';
      document.getElementById('announcementModal').classList.add('active');
    });
    
    // å…³é—­æ¨¡æ€æ¡†
    document.getElementById('closeModalBtn').addEventListener('click', () => {
      document.getElementById('announcementModal').classList.remove('active');
    });
    
    document.getElementById('cancelBtn').addEventListener('click', () => {
      document.getElementById('announcementModal').classList.remove('active');
    });
    
    // ä¿å­˜å…¬å‘Š
    document.getElementById('announcementForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = document.getElementById('announcementId').value;
      const content = document.getElementById('announcementContent').value.trim();
      const active = document.getElementById('announcementActive').checked;
      const token = localStorage.getItem('adminToken');
      
      if (!content) {
        alert('è¯·è¾“å…¥å…¬å‘Šå†…å®¹');
        return;
      }
      
      try {
        const url = id 
          ? `${getApiUrl()}/admin/announcements/${id}`
          : `${getApiUrl()}/admin/announcements`;
        
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ content, active })
        });
        
        if (!response.ok) throw new Error(id ? 'æ›´æ–°å¤±è´¥' : 'åˆ›å»ºå¤±è´¥');
        
        const result = await response.json();
        if (result.success) {
          document.getElementById('announcementModal').classList.remove('active');
          loadAnnouncements();
          // å¦‚æœå½“å‰åœ¨é¦–é¡µï¼Œåˆ·æ–°ä¸»é¡µå…¬å‘Šæ 
          const homeView = document.getElementById('homeView');
          if (homeView && homeView.style.display !== 'none') {
            loadHomeAnnouncementBubble();
          }
        }
      } catch (error) {
        alert((id ? 'æ›´æ–°' : 'åˆ›å»º') + 'å¤±è´¥ï¼š' + error.message);
      }
    });
    
    // ä¿®æ”¹å¯†ç åŠŸèƒ½
    document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const errorDiv = document.getElementById('passwordChangeError');
      const successDiv = document.getElementById('passwordChangeSuccess');
      const token = localStorage.getItem('adminToken');
      
      // éšè—ä¹‹å‰çš„æ¶ˆæ¯
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';
      
      // éªŒè¯æ–°å¯†ç 
      if (newPassword.length < 6) {
        errorDiv.textContent = 'æ–°å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½';
        errorDiv.style.display = 'block';
        return;
      }
      
      if (newPassword !== confirmPassword) {
        errorDiv.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´';
        errorDiv.style.display = 'block';
        return;
      }
      
      if (oldPassword === newPassword) {
        errorDiv.textContent = 'æ–°å¯†ç ä¸èƒ½ä¸åŸå¯†ç ç›¸åŒ';
        errorDiv.style.display = 'block';
        return;
      }
      
      try {
        const response = await fetch(`${getApiUrl()}/auth/change-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ oldPassword, newPassword })
        });
        
        const result = await response.json();
        
        if (result.success) {
          successDiv.style.display = 'block';
          document.getElementById('changePasswordForm').reset();
          
          // 3ç§’åéšè—æˆåŠŸæ¶ˆæ¯
          setTimeout(() => {
            successDiv.style.display = 'none';
          }, 3000);
        } else {
          errorDiv.textContent = result.error || 'å¯†ç ä¿®æ”¹å¤±è´¥';
          errorDiv.style.display = 'block';
        }
      } catch (error) {
        errorDiv.textContent = 'å¯†ç ä¿®æ”¹å¤±è´¥ï¼š' + (error.message || 'ç½‘ç»œé”™è¯¯');
        errorDiv.style.display = 'block';
      }
    });
    
    // ==========================================
    // ğŸ“° èµ„è®¯æ›´æ–°åŠŸèƒ½ï¼ˆä»ä¸»ç«™ç§»æ¤ï¼‰
    // ==========================================
    
    // èµ„è®¯æ•°æ®å­˜å‚¨
    let NEWS_DATA = [];
    let currentNewsFilter = 'all';
    let currentNewsRegion = 'local'; // 'local' æˆ– 'national'
    
    // è·å–APIé…ç½®ï¼ˆä¸ä¸»ç«™ä¸€è‡´ï¼‰
    function getApiConfig() {
      const config = localStorage.getItem('pigeon_api_config');
      if (config) {
        const parsed = JSON.parse(config);
        // ç¡®ä¿æœ‰apiUrlå­—æ®µ
        if (!parsed.apiUrl) {
          parsed.apiUrl = 'http://localhost:3000/api';
        }
        return parsed;
      }
      
      // é»˜è®¤é…ç½®ï¼ˆåç«¯æœåŠ¡åœ°å€ï¼‰
      const defaultBaseUrl = 'http://localhost:3000/api';
      return {
        apiUrl: defaultBaseUrl, // APIåŸºç¡€åœ°å€
        newsApiUrl: defaultBaseUrl + '/news', // èµ„è®¯APIåœ°å€
        eventsApiUrl: defaultBaseUrl + '/events', // èµ›äº‹APIåœ°å€
        apiKey: '' // APIå¯†é’¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
      };
    }
    
    // ä¿å­˜APIé…ç½®
    function saveApiConfig(config) {
      localStorage.setItem('pigeon_api_config', JSON.stringify(config));
    }
    
    // ä»localStorageåŠ è½½èµ„è®¯æ•°æ®
    function loadNewsFromStorage() {
      const stored = localStorage.getItem('pigeon_news_data');
      const lastUpdate = localStorage.getItem('pigeon_news_last_update');
      
      if (stored && lastUpdate) {
        const lastUpdateDate = new Date(lastUpdate);
        const now = new Date();
        const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
        
        // å¦‚æœæ•°æ®æ˜¯ä»Šå¤©çš„ï¼Œç›´æ¥ä½¿ç”¨
        if (daysDiff === 0) {
          NEWS_DATA = JSON.parse(stored);
          return true;
        }
      }
      
      return false;
    }
    
    // ä¿å­˜èµ„è®¯æ•°æ®åˆ°localStorage
    function saveNewsToStorage() {
      localStorage.setItem('pigeon_news_data', JSON.stringify(NEWS_DATA));
      localStorage.setItem('pigeon_news_last_update', new Date().toISOString());
    }
    
    // ä»çœŸå®APIè·å–èµ„è®¯æ•°æ®
    async function fetchNewsFromWeb() {
      // è·å–APIé…ç½®
      const apiConfig = getApiConfig();
      
      if (!apiConfig.newsApiUrl) {
        throw new Error('èµ„è®¯APIæœªé…ç½®ï¼Œè¯·åœ¨è®¾ç½®ä¸­é…ç½®APIåœ°å€');
      }
      
      try {
        // æ„å»ºè¯·æ±‚å¤´
        const headers = {
          'Content-Type': 'application/json'
        };
        if (apiConfig.apiKey) {
          headers['Authorization'] = 'Bearer ' + apiConfig.apiKey;
        }
        
        // å°è¯•ä»APIè·å–æ•°æ®
        const response = await fetch(apiConfig.newsApiUrl, {
          method: 'GET',
          headers: headers
        });
        
        if (!response.ok) {
          throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
        }
        
        const result = await response.json();
        
        // åç«¯APIè¿”å›æ ¼å¼: {success: true, data: [...], count: X, timestamp: "..."}
        if (!result.success) {
          throw new Error(result.error || 'APIè¿”å›é”™è¯¯');
        }
        
        const data = result.data || result;
        
        // éªŒè¯æ•°æ®æ ¼å¼
        if (!Array.isArray(data)) {
          throw new Error('APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºæ•°ç»„');
        }
        
        // è½¬æ¢æ•°æ®æ ¼å¼
        return data.map(item => ({
          id: item.id || Date.now() + Math.random(),
          title: item.title || 'æ— æ ‡é¢˜',
          source: item.source || 'æœªçŸ¥æ¥æº',
          sourceUrl: item.sourceUrl || item.url || '#',
          time: item.time || formatUpdateTime(item.updateTime),
          updateTime: item.updateTime || new Date().toISOString(),
          tags: item.tags || [],
          category: item.category || 'race',
          region: item.region || 'national',
          content: item.content || item.description || '',
          hot: item.hot || false
        }));
        
      } catch (error) {
        console.error('è·å–èµ„è®¯å¤±è´¥:', error);
        throw error;
      }
    }
    
    // æ ¼å¼åŒ–æ›´æ–°æ—¶é—´
    function formatUpdateTime(updateTime) {
      if (!updateTime) return 'æœªçŸ¥';
      const date = new Date(updateTime);
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 60) {
        return `${minutes}åˆ†é’Ÿå‰`;
      } else if (hours < 24) {
        return `${hours}å°æ—¶å‰`;
      } else if (days < 7) {
        return `${days}å¤©å‰`;
      } else {
        return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
      }
    }
    
    // æ¸²æŸ“èµ„è®¯åˆ—è¡¨
    function renderNewsList(filter = 'all', region = 'local') {
      const container = document.getElementById('homeNewsList');
      if (!container) return;
      
      // å…ˆæŒ‰åœ°åŒºç­›é€‰
      let filteredNews = NEWS_DATA.filter(n => n.region === region);
      
      // å†æŒ‰åˆ†ç±»ç­›é€‰
      if (filter !== 'all') {
        filteredNews = filteredNews.filter(n => n.category === filter);
      }
      
      // æŒ‰æ›´æ–°æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      filteredNews.sort((a, b) => {
        const timeA = new Date(a.updateTime || 0);
        const timeB = new Date(b.updateTime || 0);
        return timeB - timeA;
      });
      
      if (filteredNews.length === 0) {
        const apiConfig = getApiConfig();
        if (!apiConfig.newsApiUrl) {
          // APIæœªé…ç½®ï¼Œæ˜¾ç¤ºé…ç½®æç¤º
          showApiConfigPrompt('èµ„è®¯');
          return;
        }
        
        container.innerHTML = `
          <div style="padding:40px;text-align:center;color:#9ca3af;">
            <div style="font-size:48px;margin-bottom:16px;">ğŸ“°</div>
            <div>æš‚æ— ${region === 'local' ? 'æœ¬åœ°' : 'å…¨å›½'}èµ„è®¯</div>
            <div style="font-size:12px;margin-top:8px;">ç‚¹å‡»"åˆ·æ–°èµ„è®¯"æŒ‰é’®è·å–æœ€æ–°èµ„è®¯</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredNews.map(news => {
        const updateTimeStr = formatUpdateTime(news.updateTime);
        return `
          <div class="news-card" data-news-id="${news.id}">
            <div class="news-card-header">
              <div class="news-card-title">${news.title}</div>
              <div class="news-card-time">${news.time}</div>
            </div>
            <div class="news-card-source">æ¥æºï¼š${news.source}</div>
            <div class="news-card-update-time">æ›´æ–°æ—¶é—´ï¼š${updateTimeStr}</div>
            <div class="news-card-tags">
              ${news.hot ? '<span class="news-tag hot">ğŸ”¥ çƒ­é—¨</span>' : ''}
              ${news.tags.map(tag => `<span class="news-tag ${news.category}">#${tag}</span>`).join('')}
            </div>
            <div class="news-card-actions">
              <button class="news-card-action-btn" onclick="viewNewsDetail(${news.id})">ğŸ“– æŸ¥çœ‹è¯¦æƒ…</button>
              <button class="news-card-action-btn primary" onclick="openNewsOriginal(${news.id})">ğŸ”— æŸ¥çœ‹åŸæ–‡</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // æŸ¥çœ‹èµ„è®¯è¯¦æƒ…ï¼ˆæš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼‰
    window.viewNewsDetail = function(newsId) {
      const news = NEWS_DATA.find(n => n.id === newsId);
      if (!news) {
        alert('èµ„è®¯ä¸å­˜åœ¨');
        return;
      }
      
      const modal = document.getElementById('newsModal');
      if (!modal) return;
      
      const titleEl = document.getElementById('newsModalTitle');
      const sourceEl = document.getElementById('newsModalSource');
      const regionEl = document.getElementById('newsModalRegion');
      const updateTimeEl = document.getElementById('newsModalUpdateTime');
      const contentEl = document.getElementById('newsModalContent');
      
      if (titleEl) titleEl.textContent = news.title;
      if (sourceEl) sourceEl.textContent = `æ¥æºï¼š${news.source}`;
      if (regionEl) regionEl.textContent = news.region === 'local' ? 'ğŸ“ æœ¬åœ°èµ„è®¯' : 'ğŸŒ å…¨å›½èµ„è®¯';
      if (updateTimeEl) updateTimeEl.textContent = `æ›´æ–°æ—¶é—´ï¼š${formatUpdateTime(news.updateTime)}`;
      if (contentEl) contentEl.textContent = news.content || 'æš‚æ— è¯¦ç»†å†…å®¹';
      
      // è®¾ç½®æŸ¥çœ‹åŸæ–‡æŒ‰é’®çš„é“¾æ¥
      const viewOriginalBtn = document.getElementById('newsModalViewOriginal');
      if (viewOriginalBtn) {
        viewOriginalBtn.onclick = () => window.openNewsOriginal(newsId);
      }
      
      modal.classList.add('active');
    };
    
    // æ‰“å¼€åŸèµ„è®¯é“¾æ¥ï¼ˆæš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼‰
    window.openNewsOriginal = function(newsId) {
      const news = NEWS_DATA.find(n => n.id === newsId);
      if (!news || !news.sourceUrl) {
        alert('åŸèµ„è®¯é“¾æ¥ä¸å­˜åœ¨');
        return;
      }
      
      window.open(news.sourceUrl, '_blank');
    };
    
    // å…³é—­èµ„è®¯è¯¦æƒ…å¼¹çª—
    function closeNewsModal() {
      const modal = document.getElementById('newsModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }
    
    // è‡ªåŠ¨æ›´æ–°èµ„è®¯
    async function updateNews() {
      try {
        const news = await fetchNewsFromWeb();
        NEWS_DATA = news;
        saveNewsToStorage();
        renderNewsList(currentNewsFilter, currentNewsRegion);
        updateHomeStats();
        console.log('èµ„è®¯æ›´æ–°æˆåŠŸï¼Œå…±è·å–', news.length, 'æ¡èµ„è®¯');
      } catch (error) {
        console.error('æ›´æ–°èµ„è®¯å¤±è´¥:', error);
        
        // å¦‚æœAPIæœªé…ç½®ï¼Œæ˜¾ç¤ºé…ç½®æç¤º
        if (error.message && error.message.includes('æœªé…ç½®')) {
          NEWS_DATA = [];
          renderNewsList(currentNewsFilter, currentNewsRegion);
          showApiConfigPrompt('èµ„è®¯');
          return;
        }
        
        // å¦‚æœæ›´æ–°å¤±è´¥ï¼Œå°è¯•åŠ è½½ç¼“å­˜æ•°æ®
        if (loadNewsFromStorage()) {
          renderNewsList(currentNewsFilter, currentNewsRegion);
        } else {
          // æ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
          NEWS_DATA = [];
          renderNewsList(currentNewsFilter, currentNewsRegion);
        }
      }
    }
    
    // æ˜¾ç¤ºAPIé…ç½®æç¤º
    function showApiConfigPrompt(type) {
      const container = type === 'èµ„è®¯' ? document.getElementById('homeNewsList') : document.getElementById('homeEventsList');
      if (!container) return;
      
      const apiConfig = getApiConfig();
      const apiUrl = type === 'èµ„è®¯' ? apiConfig.newsApiUrl : apiConfig.eventsApiUrl;
      
      if (!apiUrl) {
        container.innerHTML = `
          <div style="padding:40px;text-align:center;color:#9ca3af;">
            <div style="font-size:48px;margin-bottom:16px;">${type === 'èµ„è®¯' ? 'ğŸ“°' : 'ğŸ'}</div>
            <div style="font-size:16px;font-weight:600;color:#374151;margin-bottom:8px;">${type}APIæœªé…ç½®</div>
            <div style="font-size:13px;color:#6b7280;margin-bottom:16px;">è¯·é…ç½®${type}APIåœ°å€ä»¥è·å–çœŸå®æ•°æ®</div>
            <button class="btn btn-primary btn-sm" onclick="showApiConfigModal('${type}')" style="margin-top:12px;">
              âš™ï¸ é…ç½®API
            </button>
          </div>
        `;
      }
    }
    
    // æ˜¾ç¤ºAPIé…ç½®å¼¹çª—
    window.showApiConfigModal = function(type) {
      const apiConfig = getApiConfig();
      const apiUrl = type === 'èµ„è®¯' ? apiConfig.newsApiUrl : apiConfig.eventsApiUrl;
      const apiKey = apiConfig.apiKey || '';
      
      const newsApiUrl = prompt(`è¯·è¾“å…¥${type === 'èµ„è®¯' ? 'èµ„è®¯' : 'èµ›äº‹'}APIåœ°å€:`, apiUrl || '');
      if (newsApiUrl === null) return; // ç”¨æˆ·å–æ¶ˆ
      
      const newApiKey = prompt('è¯·è¾“å…¥APIå¯†é’¥ï¼ˆå¯é€‰ï¼Œç›´æ¥å›è½¦è·³è¿‡ï¼‰:', apiKey);
      
      const newConfig = {
        ...apiConfig,
        [type === 'èµ„è®¯' ? 'newsApiUrl' : 'eventsApiUrl']: newsApiUrl,
        apiKey: newApiKey || apiKey
      };
      
      saveApiConfig(newConfig);
      
      // é‡æ–°å°è¯•è·å–æ•°æ®
      if (type === 'èµ„è®¯') {
        updateNews();
      }
      
      alert('APIé…ç½®å·²ä¿å­˜ï¼Œæ­£åœ¨è·å–æ•°æ®...');
    };
    
    // æ›´æ–°é¦–é¡µç»Ÿè®¡
    function updateHomeStats() {
      const pigeonCountEl = document.getElementById('homePigeonCount');
      if (pigeonCountEl) {
        // è¿™é‡Œå¯ä»¥ä»localStorageè·å–é¸½å­æ•°æ®
        try {
          const pigeonsData = localStorage.getItem('pigeons');
          if (pigeonsData) {
            const pigeons = JSON.parse(pigeonsData);
            pigeonCountEl.textContent = pigeons.filter(p => p && p.alive).length || 0;
          } else {
            pigeonCountEl.textContent = '0';
          }
        } catch (e) {
          pigeonCountEl.textContent = '0';
        }
      }
      
      // æ›´æ–°å…¶ä»–ç»Ÿè®¡
      const newsCountEl = document.getElementById('homeNewsCount');
      if (newsCountEl) {
        newsCountEl.textContent = NEWS_DATA.length || 0;
      }
      
      // æ›´æ–°èµ›äº‹ç»Ÿè®¡
      const activeRacesEl = document.getElementById('homeActiveRaces');
      if (activeRacesEl) {
        activeRacesEl.textContent = (EVENTS_DATA.ongoing || []).length;
      }
      
      const completedRacesEl = document.getElementById('homeCompletedRaces');
      if (completedRacesEl) {
        completedRacesEl.textContent = (EVENTS_DATA.results || []).length;
      }
      
      // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
      const now = new Date();
      const dayEl = document.getElementById('homeDay');
      const weekdayEl = document.getElementById('homeWeekday');
      const dateFullEl = document.getElementById('homeDateFull');
      
      if (dayEl) dayEl.textContent = now.getDate();
      if (weekdayEl) {
        const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        weekdayEl.textContent = weekdays[now.getDay()];
      }
      if (dateFullEl) {
        dateFullEl.textContent = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ`;
      }
    }
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°èµ„è®¯ï¼ˆæ¯å¤©æ›´æ–°ä¸€æ¬¡ï¼‰
    function checkAndUpdateNews() {
      const lastUpdate = localStorage.getItem('pigeon_news_last_update');
      if (!lastUpdate) {
        // é¦–æ¬¡åŠ è½½ï¼Œç›´æ¥æ›´æ–°
        updateNews();
        return;
      }
      
      const lastUpdateDate = new Date(lastUpdate);
      const now = new Date();
      const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
      
      if (daysDiff >= 1) {
        // è¶…è¿‡1å¤©ï¼Œéœ€è¦æ›´æ–°
        updateNews();
      } else {
        // ä½¿ç”¨ç¼“å­˜æ•°æ®
        if (loadNewsFromStorage()) {
          renderNewsList(currentNewsFilter, currentNewsRegion);
        } else {
          // å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œåˆ™æ›´æ–°
          updateNews();
        }
      }
    }
    
    // ==========================================
    // ğŸ å®æ—¶èµ›äº‹åŠŸèƒ½ï¼ˆä»ä¸»ç«™ç§»æ¤ï¼‰
    // ==========================================
    
    // èµ›äº‹æ•°æ®å­˜å‚¨
    let EVENTS_DATA = {
      ongoing: [],
      upcoming: [],
      results: []
    };
    
    let currentEventTab = 'ongoing';
    let currentEventRegion = 'local'; // 'local' æˆ– 'national'
    
    // ä»localStorageåŠ è½½èµ›äº‹æ•°æ®
    function loadEventsFromStorage() {
      const stored = localStorage.getItem('pigeon_events_data');
      const lastUpdate = localStorage.getItem('pigeon_events_last_update');
      
      if (stored && lastUpdate) {
        const lastUpdateDate = new Date(lastUpdate);
        const now = new Date();
        const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
        
        // å¦‚æœæ•°æ®æ˜¯ä»Šå¤©çš„ï¼Œç›´æ¥ä½¿ç”¨
        if (daysDiff === 0) {
          EVENTS_DATA = JSON.parse(stored);
          return true;
        }
      }
      
      return false;
    }
    
    // ä¿å­˜èµ›äº‹æ•°æ®åˆ°localStorage
    function saveEventsToStorage() {
      localStorage.setItem('pigeon_events_data', JSON.stringify(EVENTS_DATA));
      localStorage.setItem('pigeon_events_last_update', new Date().toISOString());
    }
    
    // ä»çœŸå®APIè·å–èµ›äº‹æ•°æ®
    async function fetchEventsFromWeb() {
      // è·å–APIé…ç½®
      const apiConfig = getApiConfig();
      
      if (!apiConfig.eventsApiUrl) {
        throw new Error('èµ›äº‹APIæœªé…ç½®ï¼Œè¯·åœ¨è®¾ç½®ä¸­é…ç½®APIåœ°å€');
      }
      
      try {
        // æ„å»ºè¯·æ±‚å¤´
        const headers = {
          'Content-Type': 'application/json'
        };
        if (apiConfig.apiKey) {
          headers['Authorization'] = 'Bearer ' + apiConfig.apiKey;
        }
        
        // å°è¯•ä»APIè·å–æ•°æ®ï¼ˆè·å–æ‰€æœ‰ç±»å‹çš„èµ›äº‹ï¼‰
        const response = await fetch(apiConfig.eventsApiUrl, {
          method: 'GET',
          headers: headers
        });
        
        if (!response.ok) {
          const errorText = await response.text().catch(() => '');
          throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}. ${errorText}`);
        }
        
        const result = await response.json();
        
        // åç«¯APIè¿”å›æ ¼å¼: {success: true, data: {ongoing: [], upcoming: [], results: []}}
        if (!result.success) {
          throw new Error(result.error || result.message || 'APIè¿”å›é”™è¯¯');
        }
        
        const data = result.data || result;
        
        // éªŒè¯æ•°æ®æ ¼å¼
        if (!data.ongoing || !data.upcoming || !data.results) {
          throw new Error('APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”åŒ…å«ongoingã€upcomingã€resultså­—æ®µ');
        }
        
        // è½¬æ¢æ•°æ®æ ¼å¼å¹¶éªŒè¯
        const now = new Date();
        return {
          ongoing: (data.ongoing || []).map(item => {
            const releaseTimeFull = item.releaseTimeFull ? new Date(item.releaseTimeFull) : null;
            const endTimeFull = item.endTimeFull ? new Date(item.endTimeFull) : null;
            
            if (endTimeFull && endTimeFull <= now) {
              return null;
            }
            
            if (releaseTimeFull && releaseTimeFull > now) {
              return null;
            }
            
            return {
              id: item.id || Date.now() + Math.random(),
              name: item.name || 'æœªçŸ¥èµ›äº‹',
              organizer: item.organizer || 'æœªçŸ¥ç»„ç»‡',
              source: item.source || 'æœªçŸ¥æ¥æº',
              sourceUrl: item.sourceUrl || item.url || '#',
              releaseTime: item.releaseTime || 'æœªçŸ¥æ—¶é—´',
              releaseTimeFull: item.releaseTimeFull || new Date().toISOString(),
              endTimeFull: item.endTimeFull || null,
              distance: item.distance || 'æœªçŸ¥è·ç¦»',
              status: 'ongoing',
              region: item.region || 'national',
              returned: item.returned || 0,
              total: item.total || 0,
              weather: item.weather || 'æœªçŸ¥',
              updateTime: item.updateTime || new Date().toISOString()
            };
          }).filter(item => item !== null),
          upcoming: (data.upcoming || []).map(item => {
            const startTimeFull = item.startTimeFull ? new Date(item.startTimeFull) : null;
            
            if (startTimeFull && startTimeFull <= now) {
              return null;
            }
            
            return {
              id: item.id || Date.now() + Math.random(),
              name: item.name || 'æœªçŸ¥èµ›äº‹',
              organizer: item.organizer || 'æœªçŸ¥ç»„ç»‡',
              source: item.source || 'æœªçŸ¥æ¥æº',
              sourceUrl: item.sourceUrl || item.url || '#',
              startTime: item.startTime || 'æœªçŸ¥æ—¶é—´',
              startTimeFull: item.startTimeFull || new Date(now.getTime() + 86400000).toISOString(),
              distance: item.distance || 'æœªçŸ¥è·ç¦»',
              status: 'upcoming',
              region: item.region || 'national',
              participants: item.participants || 0,
              weather: item.weather || 'æœªçŸ¥',
              updateTime: item.updateTime || new Date().toISOString()
            };
          }).filter(item => item !== null),
          results: (data.results || []).map(item => {
            const endTimeFull = item.endTimeFull ? new Date(item.endTimeFull) : null;
            
            if (endTimeFull && endTimeFull > now) {
              return null;
            }
            
            return {
              id: item.id || Date.now() + Math.random(),
              name: item.name || 'æœªçŸ¥èµ›äº‹',
              organizer: item.organizer || 'æœªçŸ¥ç»„ç»‡',
              source: item.source || 'æœªçŸ¥æ¥æº',
              sourceUrl: item.sourceUrl || item.url || '#',
              endTime: item.endTime || 'æœªçŸ¥æ—¶é—´',
              endTimeFull: item.endTimeFull || new Date(now.getTime() - 86400000).toISOString(),
              distance: item.distance || 'æœªçŸ¥è·ç¦»',
              status: 'completed',
              region: item.region || 'national',
              champion: item.champion || 'æœªçŸ¥',
              championRing: item.championRing || 'æœªçŸ¥',
              championTime: item.championTime || 'æœªçŸ¥',
              updateTime: item.updateTime || new Date().toISOString()
            };
          }).filter(item => item !== null)
        };
        
      } catch (error) {
        console.error('è·å–èµ›äº‹å¤±è´¥:', error);
        throw error;
      }
    }
    
    // éªŒè¯èµ›äº‹æ—¶é—´æ˜¯å¦æœ‰æ•ˆ
    function isValidEventTime(event, tab) {
      const now = new Date();
      
      if (tab === 'ongoing') {
        if (!event.releaseTimeFull) return false;
        const releaseTime = new Date(event.releaseTimeFull);
        const hoursSinceRelease = (now - releaseTime) / (1000 * 60 * 60);
        if (hoursSinceRelease > 24) return false;
        if (releaseTime > now) return false;
        return true;
      } else if (tab === 'upcoming') {
        if (!event.startTimeFull) return false;
        const startTime = new Date(event.startTimeFull);
        if (startTime <= now) return false;
        return true;
      } else if (tab === 'results') {
        if (!event.endTimeFull) return false;
        const endTime = new Date(event.endTimeFull);
        if (endTime > now) return false;
        return true;
      }
      
      return true;
    }
    
    // éªŒè¯èµ›äº‹æ•°æ®æ˜¯å¦è¿‡æ—¶
    function isEventOutdated(event) {
      if (!event.updateTime) return true;
      
      const updateTime = new Date(event.updateTime);
      const now = new Date();
      const hoursSinceUpdate = (now - updateTime) / (1000 * 60 * 60);
      
      if (event.status === 'ongoing' && hoursSinceUpdate > 2) {
        return true;
      }
      
      if (hoursSinceUpdate > 24) {
        return true;
      }
      
      return false;
    }
    
    // æ¸²æŸ“èµ›äº‹åˆ—è¡¨
    function renderEventsList(tab = 'ongoing', region = 'local') {
      const container = document.getElementById('homeEventsList');
      if (!container) return;
      
      // å…ˆæŒ‰åœ°åŒºç­›é€‰
      let events = (EVENTS_DATA[tab] || []).filter(event => event.region === region);
      
      // è¿‡æ»¤æ‰æ—¶é—´ä¸å»åˆçš„èµ›äº‹
      events = events.filter(event => isValidEventTime(event, tab));
      
      // è¿‡æ»¤æ‰è¿‡æ—¶çš„èµ›äº‹
      events = events.filter(event => !isEventOutdated(event));
      
      // å¯¹äº"è¿›è¡Œä¸­"çš„èµ›äº‹ï¼Œé¢å¤–éªŒè¯
      if (tab === 'ongoing') {
        events = events.filter(event => {
          if (event.endTimeFull) {
            const endTime = new Date(event.endTimeFull);
            if (endTime <= new Date()) {
              return false;
            }
          }
          return true;
        });
      }
      
      // æŒ‰æ›´æ–°æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      events.sort((a, b) => {
        const timeA = new Date(a.updateTime || 0);
        const timeB = new Date(b.updateTime || 0);
        return timeB - timeA;
      });
      
      if (events.length === 0) {
        const apiConfig = getApiConfig();
        if (!apiConfig.eventsApiUrl) {
          showApiConfigPrompt('èµ›äº‹');
          return;
        }
        
        container.innerHTML = `
          <div style="padding:40px;text-align:center;color:#9ca3af;">
            <div style="font-size:48px;margin-bottom:16px;">ğŸ</div>
            <div>æš‚æ— ${region === 'local' ? 'æœ¬åœ°' : 'å…¨å›½'}${tab === 'ongoing' ? 'è¿›è¡Œä¸­' : tab === 'upcoming' ? 'å³å°†å¼€å§‹' : 'æœ€æ–°æˆç»©'}èµ›äº‹</div>
            <div style="font-size:12px;margin-top:8px;">ç‚¹å‡»"åˆ·æ–°"æŒ‰é’®è·å–æœ€æ–°èµ›äº‹</div>
          </div>
        `;
        return;
      }
      
      if (tab === 'ongoing') {
        container.innerHTML = events.map(event => {
          const updateTimeStr = formatUpdateTime(event.updateTime);
          const progressPercent = event.total > 0 ? ((event.returned / event.total) * 100).toFixed(1) : 0;
          return `
            <div class="event-card" style="cursor:pointer;" onclick="openEventUrl('${event.sourceUrl || '#'}')">
              <div class="event-card-status ongoing">
                <span>è¿›è¡Œä¸­</span>
              </div>
              <div class="event-card-title">${event.name}</div>
              <div class="event-card-info">
                <div class="event-card-info-item">
                  <span>ğŸ¢</span>
                  <span>${event.organizer}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ“</span>
                  <span>${event.distance}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ•</span>
                  <span>æ”¾é£ï¼š${event.releaseTime}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸŒ¤ï¸</span>
                  <span>${event.weather}</span>
                </div>
              </div>
              <div class="event-card-progress">
                <div class="event-progress-bar">
                  <div class="event-progress-fill" style="width:${progressPercent}%;"></div>
                </div>
                <div class="event-progress-text">å·²å½’å·¢ ${event.returned} / ${event.total} åªï¼ˆ${progressPercent}%ï¼‰</div>
              </div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
                <span>ğŸ“° æ¥æºï¼š${event.source || 'æœªçŸ¥'}</span>
                <span>ğŸ• æ›´æ–°ï¼š${updateTimeStr}</span>
              </div>
              ${event.sourceUrl && event.sourceUrl !== '#' ? `
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                <button class="btn btn-outline btn-sm" style="width:100%;" onclick="event.stopPropagation();window.open('${event.sourceUrl}', '_blank')">
                  ğŸ”— æŸ¥çœ‹åŸèµ›äº‹ç½‘é¡µ
                </button>
              </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } else if (tab === 'upcoming') {
        container.innerHTML = events.map(event => {
          const updateTimeStr = formatUpdateTime(event.updateTime);
          return `
            <div class="event-card" style="cursor:pointer;" onclick="openEventUrl('${event.sourceUrl || '#'}')">
              <div class="event-card-status upcoming">å³å°†å¼€å§‹</div>
              <div class="event-card-title">${event.name}</div>
              <div class="event-card-info">
                <div class="event-card-info-item">
                  <span>ğŸ¢</span>
                  <span>${event.organizer}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ“</span>
                  <span>${event.distance}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ•</span>
                  <span>å¼€å§‹ï¼š${event.startTime}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ•Šï¸</span>
                  <span>å‚èµ›ï¼š${event.participants}åª</span>
                </div>
              </div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
                <span>ğŸ“° æ¥æºï¼š${event.source || 'æœªçŸ¥'}</span>
                <span>ğŸ• æ›´æ–°ï¼š${updateTimeStr}</span>
              </div>
              ${event.sourceUrl && event.sourceUrl !== '#' ? `
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                <button class="btn btn-outline btn-sm" style="width:100%;" onclick="event.stopPropagation();window.open('${event.sourceUrl}', '_blank')">
                  ğŸ”— æŸ¥çœ‹åŸèµ›äº‹ç½‘é¡µ
                </button>
              </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } else if (tab === 'results') {
        container.innerHTML = events.map(event => {
          const updateTimeStr = formatUpdateTime(event.updateTime);
          return `
            <div class="event-card" style="cursor:pointer;" onclick="openEventUrl('${event.sourceUrl || '#'}')">
              <div class="event-card-status completed">å·²ç»“æŸ</div>
              <div class="event-card-title">${event.name}</div>
              <div class="event-card-info">
                <div class="event-card-info-item">
                  <span>ğŸ¢</span>
                  <span>${event.organizer}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ“</span>
                  <span>${event.distance}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ•</span>
                  <span>ç»“æŸï¼š${event.endTime}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ†</span>
                  <span>å† å†›ï¼š${event.champion} (${event.championRing})</span>
                </div>
                ${event.championTime ? `
                <div class="event-card-info-item">
                  <span>â±ï¸</span>
                  <span>æˆç»©ï¼š${event.championTime}</span>
                </div>
                ` : ''}
              </div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
                <span>ğŸ“° æ¥æºï¼š${event.source || 'æœªçŸ¥'}</span>
                <span>ğŸ• æ›´æ–°ï¼š${updateTimeStr}</span>
              </div>
              ${event.sourceUrl && event.sourceUrl !== '#' ? `
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                <button class="btn btn-outline btn-sm" style="width:100%;" onclick="event.stopPropagation();window.open('${event.sourceUrl}', '_blank')">
                  ğŸ”— æŸ¥çœ‹åŸèµ›äº‹ç½‘é¡µ
                </button>
              </div>
              ` : ''}
            </div>
          `;
        }).join('');
      }
    }
    
    // æ‰“å¼€èµ›äº‹é“¾æ¥ï¼ˆæš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼‰
    window.openEventUrl = function(url) {
      if (url && url !== '#') {
        window.open(url, '_blank');
      }
    };
    
    // è‡ªåŠ¨æ›´æ–°èµ›äº‹
    async function updateEvents() {
      try {
        const events = await fetchEventsFromWeb();
        
        // å†æ¬¡éªŒè¯å’Œè¿‡æ»¤æ•°æ®
        const now = new Date();
        
        // è¿‡æ»¤è¿›è¡Œä¸­çš„èµ›äº‹
        events.ongoing = events.ongoing.filter(event => {
          if (!event.releaseTimeFull) return false;
          const releaseTime = new Date(event.releaseTimeFull);
          if (releaseTime > now) return false;
          
          if (event.endTimeFull) {
            const endTime = new Date(event.endTimeFull);
            if (endTime <= now) return false;
          }
          
          if (event.updateTime) {
            const updateTime = new Date(event.updateTime);
            const hoursSinceUpdate = (now - updateTime) / (1000 * 60 * 60);
            if (hoursSinceUpdate > 2) return false;
          }
          
          return true;
        });
        
        // è¿‡æ»¤å³å°†å¼€å§‹çš„èµ›äº‹
        events.upcoming = events.upcoming.filter(event => {
          if (!event.startTimeFull) return false;
          const startTime = new Date(event.startTimeFull);
          return startTime > now;
        });
        
        // è¿‡æ»¤å·²ç»“æŸçš„èµ›äº‹
        events.results = events.results.filter(event => {
          if (!event.endTimeFull) return false;
          const endTime = new Date(event.endTimeFull);
          return endTime <= now;
        });
        
        EVENTS_DATA = events;
        saveEventsToStorage();
        renderEventsList(currentEventTab, currentEventRegion);
        updateHomeStats();
        console.log('èµ›äº‹æ›´æ–°æˆåŠŸï¼Œå…±è·å–', 
          events.ongoing.length + events.upcoming.length + events.results.length, 
          'åœºæœ‰æ•ˆèµ›äº‹');
      } catch (error) {
        console.error('æ›´æ–°èµ›äº‹å¤±è´¥:', error);
        
        // å¦‚æœAPIæœªé…ç½®ï¼Œæ˜¾ç¤ºé…ç½®æç¤º
        if (error.message && error.message.includes('æœªé…ç½®')) {
          EVENTS_DATA = { ongoing: [], upcoming: [], results: [] };
          renderEventsList(currentEventTab, currentEventRegion);
          showApiConfigPrompt('èµ›äº‹');
          return;
        }
        
        // å¦‚æœæ›´æ–°å¤±è´¥ï¼Œå°è¯•åŠ è½½ç¼“å­˜æ•°æ®
        if (loadEventsFromStorage()) {
          renderEventsList(currentEventTab, currentEventRegion);
        } else {
          // æ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
          EVENTS_DATA = { ongoing: [], upcoming: [], results: [] };
          renderEventsList(currentEventTab, currentEventRegion);
        }
      }
    }
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°èµ›äº‹
    function checkAndUpdateEvents() {
      const lastUpdate = localStorage.getItem('pigeon_events_last_update');
      if (!lastUpdate) {
        updateEvents();
        return;
      }
      
      const lastUpdateDate = new Date(lastUpdate);
      const now = new Date();
      const minutesSinceUpdate = (now - lastUpdateDate) / (1000 * 60);
      
      const hasOngoingEvents = (EVENTS_DATA.ongoing || []).length > 0;
      
      if (hasOngoingEvents) {
        if (minutesSinceUpdate >= 5) {
          updateEvents();
        } else {
          if (loadEventsFromStorage()) {
            renderEventsList(currentEventTab, currentEventRegion);
          } else {
            updateEvents();
          }
        }
      } else {
        if (minutesSinceUpdate >= 60) {
          updateEvents();
        } else {
          if (loadEventsFromStorage()) {
            renderEventsList(currentEventTab, currentEventRegion);
          } else {
            updateEvents();
          }
        }
      }
    }
    
    // åŠ è½½ä¸»é¡µå…¬å‘Šæ 
    // å­˜å‚¨é¦–é¡µå½“å‰å…¬å‘Šæ•°æ®
    let homeCurrentAnnouncement = null;
    
    async function loadHomeAnnouncementBubble() {
      const bubbleEl = document.getElementById('homeAnnouncementBubbleText');
      const hintEl = document.getElementById('homeAnnouncementHint');
      const bubbleContainer = document.getElementById('homeAnnouncementBubble');
      if (!bubbleEl) return;
      
      const token = localStorage.getItem('adminToken');
      if (!token) {
        bubbleEl.textContent = 'æš‚æ— å…¬å‘Š';
        homeCurrentAnnouncement = null;
        if (hintEl) hintEl.style.display = 'none';
        if (bubbleContainer) bubbleContainer.style.cursor = 'default';
        return;
      }
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`${getApiUrl()}/admin/announcements`, {
          headers: {
            'Authorization': `Bearer ${token}`
          },
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error('è·å–å…¬å‘Šå¤±è´¥');
        }
        
        const result = await response.json();
        const announcements = result.data || [];
        
        // ä¿å­˜å…¬å‘Šæ•°æ®ä¾›æŸ¥çœ‹ä½¿ç”¨
        window.announcementsData = announcements;
        
        // è·å–æœ€æ–°çš„å·²å‘å¸ƒå…¬å‘Š
        const activeAnnouncements = announcements.filter(ann => ann.active);
        if (activeAnnouncements.length > 0) {
          // æŒ‰æ›´æ–°æ—¶é—´æ’åºï¼Œè·å–æœ€æ–°çš„
          activeAnnouncements.sort((a, b) => {
            const timeA = new Date(a.updatedAt || a.createdAt);
            const timeB = new Date(b.updatedAt || b.createdAt);
            return timeB - timeA;
          });
          
          const latestAnnouncement = activeAnnouncements[0];
          homeCurrentAnnouncement = latestAnnouncement;
          
          const content = latestAnnouncement.content || 'æš‚æ— å…¬å‘Š';
          
          // å¦‚æœå†…å®¹è¾ƒé•¿ï¼Œæ˜¾ç¤ºæç¤º
          if (content.length > 50) {
            if (hintEl) hintEl.style.display = 'inline';
            // é™åˆ¶æ˜¾ç¤ºé•¿åº¦
            const maxLength = 80;
            if (content.length > maxLength) {
              bubbleEl.textContent = content.substring(0, maxLength) + '...';
            } else {
              bubbleEl.textContent = content;
            }
          } else {
            bubbleEl.textContent = content;
            if (hintEl) hintEl.style.display = 'none';
          }
          
          // æ·»åŠ ç‚¹å‡»äº‹ä»¶
          if (bubbleContainer) {
            bubbleContainer.style.cursor = 'pointer';
          }
        } else {
          bubbleEl.textContent = 'æš‚æ— å…¬å‘Š';
          homeCurrentAnnouncement = null;
          if (hintEl) hintEl.style.display = 'none';
          if (bubbleContainer) bubbleContainer.style.cursor = 'default';
        }
      } catch (error) {
        console.error('åŠ è½½å…¬å‘Šå¤±è´¥:', error);
        bubbleEl.textContent = 'æš‚æ— å…¬å‘Š';
        homeCurrentAnnouncement = null;
        if (hintEl) hintEl.style.display = 'none';
      }
    }
    
    // æ˜¾ç¤ºé¦–é¡µå…¬å‘Šè¯¦æƒ…
    window.showHomeAnnouncementDetail = function() {
      if (!homeCurrentAnnouncement) {
        console.warn('æ²¡æœ‰å¯æ˜¾ç¤ºçš„å…¬å‘Š');
        return;
      }
      
      // ä½¿ç”¨å·²æœ‰çš„æŸ¥çœ‹å…¬å‘Šæ¨¡æ€æ¡†å‡½æ•°
      if (window.viewFullAnnouncement) {
        viewFullAnnouncement(homeCurrentAnnouncement.id);
      } else {
        // å¦‚æœviewFullAnnouncementä¸å­˜åœ¨ï¼Œç›´æ¥æ˜¾ç¤º
        alert('å…¬å‘Šè¯¦æƒ…åŠŸèƒ½æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢');
      }
    };
    
    // åˆå§‹åŒ–é¦–é¡µè§†å›¾
    function initHomeView() {
      // æ›´æ–°é¦–é¡µç»Ÿè®¡
      updateHomeStats();
      
      // åŠ è½½ä¸»é¡µå…¬å‘Šæ 
      loadHomeAnnouncementBubble();
      
      // æ£€æŸ¥å¹¶æ›´æ–°èµ„è®¯
      checkAndUpdateNews();
      
      // æ£€æŸ¥å¹¶æ›´æ–°èµ›äº‹
      checkAndUpdateEvents();
      
      // ç»‘å®šèµ„è®¯ç­›é€‰æŒ‰é’®äº‹ä»¶
      document.querySelectorAll('.news-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.news-filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentNewsFilter = btn.dataset.filter;
          renderNewsList(currentNewsFilter, currentNewsRegion);
        });
      });
      
      // æœ¬åœ°/å…¨å›½èµ„è®¯æ ‡ç­¾é¡µåˆ‡æ¢
      document.querySelectorAll('.news-region-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.news-region-tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentNewsRegion = btn.dataset.region;
          renderNewsList(currentNewsFilter, currentNewsRegion);
        });
      });
      
      // åˆ·æ–°èµ„è®¯æŒ‰é’®
      const btnRefreshNews = document.getElementById('btnRefreshNews');
      if (btnRefreshNews) {
        btnRefreshNews.addEventListener('click', () => {
          updateNews();
          alert('æ­£åœ¨åˆ·æ–°èµ„è®¯ï¼Œè¯·ç¨å€™...');
        });
      }
      
      // èµ„è®¯è¯¦æƒ…å¼¹çª—å…³é—­äº‹ä»¶
      const newsModalClose = document.getElementById('newsModalClose');
      const newsModalCloseBtn = document.getElementById('newsModalCloseBtn');
      const newsModal = document.getElementById('newsModal');
      
      if (newsModalClose) {
        newsModalClose.addEventListener('click', closeNewsModal);
      }
      if (newsModalCloseBtn) {
        newsModalCloseBtn.addEventListener('click', closeNewsModal);
      }
      if (newsModal) {
        newsModal.addEventListener('click', (e) => {
          if (e.target.id === 'newsModal') {
            closeNewsModal();
          }
        });
      }
      
      // èµ›äº‹åœ°åŒºæ ‡ç­¾é¡µåˆ‡æ¢
      document.querySelectorAll('.event-region-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.event-region-tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentEventRegion = btn.dataset.region;
          renderEventsList(currentEventTab, currentEventRegion);
        });
      });
      
      // èµ›äº‹æ ‡ç­¾é¡µåˆ‡æ¢
      document.querySelectorAll('.event-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.event-tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentEventTab = btn.dataset.tab;
          renderEventsList(currentEventTab, currentEventRegion);
        });
      });
      
      // åˆ·æ–°èµ›äº‹æŒ‰é’®
      const btnRefreshEvents = document.getElementById('btnRefreshEvents');
      if (btnRefreshEvents) {
        btnRefreshEvents.addEventListener('click', () => {
          updateEvents();
          alert('æ­£åœ¨åˆ·æ–°èµ›äº‹æ•°æ®ï¼Œè¯·ç¨å€™...');
        });
      }
    }
    
    // ==========================================
    // ğŸ•Šï¸ Evo æ™ºèƒ½åŠ©æ‰‹è®¾ç½®åŠŸèƒ½
    // ==========================================
    
    const EVO_SETTINGS_KEY = 'evo_settings';
    const EVO_SYNC_KEY = 'evo_settings_sync';
    
    // é»˜è®¤è®¾ç½®
    const defaultEvoSettings = {
      enabled: true,
      position: 'bottom-right',
      displayMode: 'always',
      autoClose: 5,
      iconSize: 70,
      theme: 'purple',
      showWelcome: true,
      saveHistory: true,
      showAnalytics: true,
      showRecommendations: true,
      github: {
        repo: '',
        token: '',
        apiEndpoint: ''
      },
      functionGuides: {
        'é¦–é¡µ': {
          description: 'é¦–é¡µæ˜¯ç³»ç»Ÿçš„ä¿¡æ¯ä¸­å¿ƒ',
          features: [
            'ğŸ“° èµ›é¸½èµ„è®¯ï¼šæŸ¥çœ‹æœ€æ–°çš„èµ›é¸½ç›¸å…³èµ„è®¯ï¼Œå¯ä»¥æŒ‰ç±»å‹ï¼ˆå…¨éƒ¨/èµ›äº‹/è‚²ç§/å¥åº·ï¼‰å’Œåœ°åŒºï¼ˆæœ¬åœ°/å…¨å›½ï¼‰ç­›é€‰',
            'ğŸ å®æ—¶èµ›äº‹ï¼šæŸ¥çœ‹è¿›è¡Œä¸­ã€å³å°†å¼€å§‹å’Œæœ€æ–°æˆç»©çš„èµ›äº‹ä¿¡æ¯',
            'ğŸ§  æ™ºèƒ½æ¨èï¼šç³»ç»Ÿæ ¹æ®æ‚¨çš„æ•°æ®æä¾›ä¸ªæ€§åŒ–æ¨è',
            'â­ æˆ‘çš„å…³æ³¨ï¼šç®¡ç†æ‚¨å…³æ³¨çš„èµ›åŒºã€èµ›äº‹ç±»å‹ç­‰',
            'ğŸš€ å¿«æ·å…¥å£ï¼šå¿«é€Ÿè®¿é—®å¸¸ç”¨åŠŸèƒ½ï¼ˆæ–°å¢é¸½å­ã€å½•å…¥æˆç»©ã€é…å¯¹è¯„ä¼°ã€æ™ºèƒ½åˆ†æï¼‰',
            'ğŸ”” ä»Šæ—¥æé†’ï¼šæŸ¥çœ‹ä»Šæ—¥çš„é‡è¦æé†’äº‹é¡¹'
          ]
        },
        'æ•°æ®æ¦‚è§ˆ': {
          description: 'æŸ¥çœ‹ç³»ç»Ÿçš„æ•´ä½“æ•°æ®ç»Ÿè®¡',
          features: [
            'ğŸ“Š æ ¸å¿ƒæ•°æ®å¡ç‰‡ï¼šæ˜¾ç¤ºæ€»é¸½å­æ•°ã€åœ¨ä¸–ã€å·²æ­»äº¡ã€æœ‰æˆç»©ã€æ ¸å¿ƒç§é¸½ç­‰ç»Ÿè®¡',
            'ğŸ“ˆ å¹´åº¦ç»Ÿè®¡ï¼šæŒ‰å¹´ä»½æ±‡æ€»å‡ºç”Ÿæ•°é‡ã€æ­»äº¡æ•°é‡ä»¥åŠæœ‰å‚èµ›è®°å½•çš„é¸½å­æ•°é‡'
          ]
        },
        'é¸½å­ç®¡ç†': {
          description: 'ç®¡ç†æ‚¨çš„ä¿¡é¸½æ¡£æ¡ˆ',
          features: [
            'ğŸ“‹ è¡¨æ ¼è§†å›¾ï¼šä»¥è¡¨æ ¼å½¢å¼æŸ¥çœ‹æ‰€æœ‰é¸½å­ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¶³ç¯å·ã€åç§°ã€ç±»å‹ã€çŠ¶æ€ã€çˆ¶é¸½/æ¯é¸½ã€ç°é¸½ä¸»ã€å‚èµ›è®°å½•æ•°',
            'ğŸƒ å¡ç‰‡è§†å›¾ï¼šä»¥å¡ç‰‡å½¢å¼æŸ¥çœ‹é¸½å­ä¿¡æ¯ï¼Œæ›´ç›´è§‚ç¾è§‚',
            'â• æ–°å¢é¸½å­ï¼šæ·»åŠ æ–°çš„ä¿¡é¸½æ¡£æ¡ˆ',
            'ğŸ” æŸ¥çœ‹è¯¦æƒ…ï¼šç‚¹å‡»æŸ¥çœ‹æŒ‰é’®æŸ¥çœ‹é¸½å­çš„è¯¦ç»†ä¿¡æ¯'
          ]
        },
        'è¡€ç»Ÿå…³ç³»': {
          description: 'æŸ¥çœ‹å’Œç®¡ç†ä¿¡é¸½çš„è¡€ç»Ÿå…³ç³»æ ‘',
          features: [
            'ğŸŒ³ è¡€ç»Ÿæ ‘ï¼šé€‰æ‹©é¸½å­æŸ¥çœ‹å…¶å®Œæ•´çš„è¡€ç»Ÿå…³ç³»æ ‘ï¼ˆåŒ…æ‹¬äº²ä»£å’Œå­ä»£ï¼‰',
            'ğŸ” æœç´¢åŠŸèƒ½ï¼šé€šè¿‡è¶³ç¯å·æˆ–åå­—æœç´¢é¸½å­',
            'ğŸ“Š ç§é¸½æ ‘ï¼šæ˜¾ç¤ºæ‰€æœ‰ç§é¸½çš„å…³ç³»æ ‘'
          ]
        },
        'ç»Ÿè®¡åˆ†æ': {
          description: 'æŸ¥çœ‹å¹´åº¦ç»Ÿè®¡æ•°æ®',
          features: [
            'ğŸ“ˆ å¹´åº¦ç»Ÿè®¡æ¦‚è§ˆï¼šæŒ‰å¹´ä»½æ±‡æ€»å‡ºç”Ÿæ•°é‡ã€æ­»äº¡æ•°é‡ä»¥åŠæœ‰å‚èµ›è®°å½•çš„é¸½å­æ•°é‡',
            'ğŸ“Š æ•°æ®è¡¨æ ¼ï¼šä»¥è¡¨æ ¼å½¢å¼å±•ç¤ºç»Ÿè®¡æ•°æ®'
          ]
        },
        'æ¯”èµ›ä¸æˆç»©': {
          description: 'ç®¡ç†æ¯”èµ›å’Œæˆç»©è®°å½•',
          features: [
            'ğŸ“‹ æ¯”èµ›åˆ—è¡¨ï¼šæŸ¥çœ‹æ‰€æœ‰æ¯”èµ›ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¯”èµ›åç§°ã€æ—¥æœŸã€åœ°ç‚¹ã€è·ç¦»ã€çŠ¶æ€ã€å‚èµ›æ•°',
            'ğŸ“¥ å¯¼å…¥æˆç»©ï¼šä»Excelæ–‡ä»¶å¯¼å…¥æ¯”èµ›æˆç»©',
            'ğŸ“Š æ¯”èµ›ç»Ÿè®¡ï¼šæŸ¥çœ‹æ¯”èµ›ç»Ÿè®¡æ•°æ®',
            'ğŸ§  æˆç»©åˆ†æï¼šåˆ†ææ¯”èµ›æˆç»©è¶‹åŠ¿',
            'ğŸ§¬ è¡€ç»Ÿå¯¹æ¯”ï¼šå¯¹æ¯”ä¸åŒè¡€ç»Ÿçš„é¸½å­è¡¨ç°'
          ]
        },
        'ç¹è‚²ä¸é…å¯¹': {
          description: 'ç®¡ç†ä¿¡é¸½çš„ç¹è‚²å’Œé…å¯¹',
          features: [
            'ğŸ’• é…å¯¹é€‰æ‹©ï¼šé€‰æ‹©çˆ¶é¸½å’Œæ¯é¸½è¿›è¡Œé…å¯¹',
            'ğŸ“Š é…å¯¹åˆ†æï¼šç³»ç»Ÿè‡ªåŠ¨åˆ†æé…å¯¹å¯è¡Œæ€§',
            'â• æ–°å¢é…å¯¹ï¼šæ·»åŠ æ–°çš„é…å¯¹è®°å½•'
          ]
        },
        'å¥åº·ç®¡ç†': {
          description: 'ç®¡ç†ä¿¡é¸½çš„å¥åº·è®°å½•',
          features: [
            'ğŸ“ å¥åº·è®°å½•ï¼šè®°å½•é¸½å­çš„å¥åº·çŠ¶æ€ã€æ—¥æœŸã€å¤‡æ³¨ç­‰ä¿¡æ¯',
            'â• æ–°å¢è®°å½•ï¼šæ·»åŠ æ–°çš„å¥åº·è®°å½•',
            'ğŸ“‹ è®°å½•åˆ—è¡¨ï¼šæŸ¥çœ‹æ‰€æœ‰å¥åº·è®°å½•'
          ]
        },
        'æ™ºèƒ½åˆ†æä¸­å¿ƒ': {
          description: 'ä½¿ç”¨AIè¿›è¡Œæ™ºèƒ½åˆ†æ',
          features: [
            'ğŸ“Š è¡€ç»Ÿåˆ†æï¼šåˆ†æé¸½å­çš„è¡€ç»Ÿä¼˜åŠ¿å’Œé—ä¼ ç‰¹å¾',
            'ğŸ† æˆç»©åˆ†æï¼šåˆ†æé¸½å­çš„æ¯”èµ›è¡¨ç°å’Œæˆç»©è¶‹åŠ¿',
            'ğŸ’• é…å¯¹å»ºè®®ï¼šåŸºäºAIç®—æ³•çš„æ™ºèƒ½é…å¯¹æ¨è'
          ]
        },
        'è®­ç»ƒæ¨¡å—': {
          description: 'ç®¡ç†ä¿¡é¸½çš„è®­ç»ƒè®°å½•',
          features: [
            'ğŸ“ è®­ç»ƒè®°å½•ï¼šè®°å½•è®­ç»ƒæ—¥æœŸã€é¸½å­ã€è®­ç»ƒç±»å‹ã€è·ç¦»ã€ç”¨æ—¶ç­‰ä¿¡æ¯',
            'â• æ–°å¢è®°å½•ï¼šæ·»åŠ æ–°çš„è®­ç»ƒè®°å½•',
            'ğŸ“‹ è®°å½•åˆ—è¡¨ï¼šæŸ¥çœ‹æ‰€æœ‰è®­ç»ƒè®°å½•'
          ]
        },
        'èƒ½åŠ›ç»¼åˆåˆ†æ': {
          description: 'ç»¼åˆåˆ†æé¸½å­çš„å„é¡¹èƒ½åŠ›æŒ‡æ ‡',
          features: [
            'ğŸ† æ¯”èµ›èƒ½åŠ›ï¼šè¯„ä¼°é¸½å­çš„æ¯”èµ›è¡¨ç°èƒ½åŠ›',
            'ğŸ§¬ é—ä¼ ä»·å€¼ï¼šè¯„ä¼°é¸½å­çš„é—ä¼ ä»·å€¼',
            'ğŸ’ª å¥åº·æŒ‡æ•°ï¼šè¯„ä¼°é¸½å­çš„å¥åº·çŠ¶å†µ',
            'â­ ç»¼åˆè¯„åˆ†ï¼šç»¼åˆå„é¡¹æŒ‡æ ‡ç»™å‡ºæ€»ä½“è¯„åˆ†'
          ]
        }
      }
    };
    
    // åŠ è½½Evoè®¾ç½®
    // ä»æœåŠ¡å™¨åŠ è½½Evoè®¾ç½®ï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
    async function loadEvoSettings() {
      try {
        const token = getAuthToken();
        if (!token) {
          console.warn('æœªç™»å½•ï¼Œæ— æ³•åŠ è½½Evoè®¾ç½®');
          return;
        }
        
        // ä»æœåŠ¡å™¨åŠ è½½è®¾ç½®
        const response = await fetch(`${getApiUrl()}/admin/evo-settings`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        let settings = defaultEvoSettings;
        
        if (response.ok) {
          const result = await response.json();
          if (result.success && result.data) {
            settings = result.data;
            // ä¿å­˜åˆ°localStorageä½œä¸ºç¼“å­˜
            localStorage.setItem(EVO_SETTINGS_KEY, JSON.stringify(settings));
          }
        } else {
          // å¦‚æœæœåŠ¡å™¨åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨localStorageç¼“å­˜
          const saved = localStorage.getItem(EVO_SETTINGS_KEY);
          if (saved) {
            settings = JSON.parse(saved);
          }
        }
        
        // å¡«å……è¡¨å•
        document.getElementById('evoEnabled').checked = settings.enabled !== false;
        document.getElementById('evoPosition').value = settings.position || 'bottom-right';
        document.getElementById('evoDisplayMode').value = settings.displayMode || 'always';
        document.getElementById('evoAutoClose').value = settings.autoClose || 5;
        
        // æ¸²æŸ“åŠŸèƒ½ä½¿ç”¨è¯´æ˜ï¼ˆå¦‚æœå‡½æ•°å­˜åœ¨ï¼‰
        if (typeof renderFunctionGuides === 'function') {
          renderFunctionGuides(settings.functionGuides || defaultEvoSettings.functionGuides);
        }
        document.getElementById('evoIconSize').value = settings.iconSize || 70;
        document.getElementById('evoIconSizeValue').textContent = (settings.iconSize || 70) + 'px';
        
        // è®¾ç½®ä¸»é¢˜å•é€‰æŒ‰é’®
        const themeRadios = document.querySelectorAll('input[name="evoTheme"]');
        themeRadios.forEach(radio => {
          if (radio.value === (settings.theme || 'purple')) {
            radio.checked = true;
          }
        });
        
        document.getElementById('evoShowWelcome').checked = settings.showWelcome !== false;
        document.getElementById('evoSaveHistory').checked = settings.saveHistory !== false;
        document.getElementById('evoShowAnalytics').checked = settings.showAnalytics !== false;
        document.getElementById('evoShowRecommendations').checked = settings.showRecommendations !== false;
        
        // GitHubé…ç½®
        if (settings.github) {
          document.getElementById('evoGithubRepo').value = settings.github.repo || '';
          document.getElementById('evoGithubToken').value = settings.github.token || '';
          document.getElementById('evoGithubApiEndpoint').value = settings.github.apiEndpoint || '';
        }
        
        // å›¾æ ‡å¤§å°æ»‘å—äº‹ä»¶
        const iconSizeSlider = document.getElementById('evoIconSize');
        if (iconSizeSlider) {
          iconSizeSlider.addEventListener('input', (e) => {
            document.getElementById('evoIconSizeValue').textContent = e.target.value + 'px';
          });
        }
      } catch (error) {
        console.error('åŠ è½½Evoè®¾ç½®å¤±è´¥:', error);
        // ä½¿ç”¨localStorageä½œä¸ºå¤‡ç”¨
        const saved = localStorage.getItem(EVO_SETTINGS_KEY);
        if (saved) {
          const settings = JSON.parse(saved);
          document.getElementById('evoEnabled').checked = settings.enabled !== false;
          document.getElementById('evoPosition').value = settings.position || 'bottom-right';
          // ... å…¶ä»–å­—æ®µå¡«å……ï¼ˆåŒä¸Šï¼‰
        }
      }
    }
    
    // æ¸²æŸ“åŠŸèƒ½ä½¿ç”¨è¯´æ˜
    function renderFunctionGuides(functionGuides) {
      const container = document.getElementById('functionGuidesContainer');
      if (!container) return;
      
      container.innerHTML = '';
      
      Object.entries(functionGuides).forEach(([funcName, guide]) => {
        const guideItem = document.createElement('div');
        guideItem.className = 'function-guide-item';
        guideItem.style.cssText = `
          border: 1px solid var(--border-medium);
          border-radius: 8px;
          padding: 16px;
          background: var(--bg-secondary);
        `;
        
        guideItem.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <h4 style="margin: 0; color: var(--text-primary);">${funcName}</h4>
            <button type="button" class="btn btn-sm btn-outline" onclick="editFunctionGuide('${funcName}')" style="padding: 4px 12px;">ç¼–è¾‘</button>
          </div>
          <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">${guide.description}</div>
          <div style="font-size: 13px; color: var(--text-muted);">
            <strong>åŠŸèƒ½ç‚¹ï¼š</strong>${guide.features.length} é¡¹
          </div>
        `;
        
        container.appendChild(guideItem);
      });
    }
    
    // ç¼–è¾‘åŠŸèƒ½è¯´æ˜
    window.editFunctionGuide = function(funcName) {
      const functionGuides = getFunctionGuidesFromSettings();
      const guide = functionGuides[funcName] || { description: '', features: [] };
      
      const description = prompt(`ç¼–è¾‘"${funcName}"çš„æè¿°ï¼š`, guide.description);
      if (description === null) return;
      
      const featuresStr = prompt(`ç¼–è¾‘"${funcName}"çš„åŠŸèƒ½ç‚¹ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š`, guide.features.join('\n'));
      if (featuresStr === null) return;
      
      const features = featuresStr.split('\n').filter(f => f.trim());
      
      functionGuides[funcName] = {
        description: description.trim(),
        features: features
      };
      
      renderFunctionGuides(functionGuides);
      showEvoSettingsStatus('åŠŸèƒ½è¯´æ˜å·²æ›´æ–°ï¼Œè¯·ç‚¹å‡»"ä¿å­˜è®¾ç½®"ä¿å­˜', 'info');
    };
    
    // ä»è®¾ç½®ä¸­è·å–åŠŸèƒ½è¯´æ˜
    function getFunctionGuidesFromSettings() {
      const container = document.getElementById('functionGuidesContainer');
      if (!container) return defaultEvoSettings.functionGuides;
      
      // ä»å½“å‰æ˜¾ç¤ºçš„è®¾ç½®ä¸­è·å–ï¼ˆå®é™…åº”è¯¥ä»è¡¨å•æˆ–è®¾ç½®å¯¹è±¡ä¸­è·å–ï¼‰
      // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€
      try {
        const saved = localStorage.getItem(EVO_SETTINGS_KEY);
        if (saved) {
          const settings = JSON.parse(saved);
          return settings.functionGuides || defaultEvoSettings.functionGuides;
        }
      } catch (e) {}
      
      return defaultEvoSettings.functionGuides;
    }
    
    // ä¿å­˜Evoè®¾ç½®åˆ°æœåŠ¡å™¨ï¼ˆç®¡ç†å‘˜æƒé™ï¼Œä¸»ç«™ä¼šè‡ªåŠ¨åŒæ­¥ï¼‰
    async function saveEvoSettings() {
      try {
        const settings = {
          enabled: document.getElementById('evoEnabled').checked,
          position: document.getElementById('evoPosition').value,
          displayMode: document.getElementById('evoDisplayMode').value,
          autoClose: parseInt(document.getElementById('evoAutoClose').value) || 5,
          iconSize: parseInt(document.getElementById('evoIconSize').value) || 70,
          theme: document.querySelector('input[name="evoTheme"]:checked')?.value || 'purple',
          showWelcome: document.getElementById('evoShowWelcome').checked,
          saveHistory: document.getElementById('evoSaveHistory').checked,
          showAnalytics: document.getElementById('evoShowAnalytics').checked,
          showRecommendations: document.getElementById('evoShowRecommendations').checked,
          github: {
            repo: document.getElementById('evoGithubRepo').value.trim(),
            token: document.getElementById('evoGithubToken').value.trim(),
            apiEndpoint: document.getElementById('evoGithubApiEndpoint').value.trim()
          },
          functionGuides: getFunctionGuidesFromSettings()
        };
        
        // ç›´æ¥ä¿å­˜åˆ°æœåŠ¡å™¨ï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
        const token = getAuthToken();
        if (!token) {
          throw new Error('è¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦å·');
        }
        
        const response = await fetch(`${getApiUrl()}/admin/evo-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(settings)
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            // ä¿å­˜åˆ°localStorageä½œä¸ºç¼“å­˜
            localStorage.setItem(EVO_SETTINGS_KEY, JSON.stringify(result.data));
            
            // è®¾ç½®åŒæ­¥æ ‡å¿—ï¼Œä¸»ç«™ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶åŒæ­¥
            localStorage.setItem(EVO_SYNC_KEY, 'true');
            localStorage.setItem('evo_settings_sync_timestamp', Date.now().toString());
            
            showEvoSettingsStatus('âœ… è®¾ç½®å·²ä¿å­˜åˆ°æœåŠ¡å™¨ï¼ä¸»ç«™å°†è‡ªåŠ¨æ›´æ–°ã€‚', 'success');
            console.log('âœ… Evoè®¾ç½®å·²ä¿å­˜åˆ°æœåŠ¡å™¨ï¼Œä¸»ç«™å°†è‡ªåŠ¨åŒæ­¥');
            
            return result.data;
          } else {
            throw new Error(result.error || 'ä¿å­˜å¤±è´¥');
          }
        } else {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || 'æœåŠ¡å™¨å“åº”é”™è¯¯');
        }
      } catch (error) {
        console.error('ä¿å­˜Evoè®¾ç½®å¤±è´¥:', error);
        showEvoSettingsStatus('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
        return null;
      }
    }
    
    // é‡ç½®ä¸ºé»˜è®¤è®¾ç½®
    function resetEvoSettings() {
      if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤è®¾ç½®å—ï¼Ÿ')) {
        localStorage.removeItem(EVO_SETTINGS_KEY);
        loadEvoSettings();
        showEvoSettingsStatus('å·²é‡ç½®ä¸ºé»˜è®¤è®¾ç½®', 'info');
      }
    }
    
    // åŒæ­¥åˆ°ä¸»ç«™ï¼ˆå·²é›†æˆåˆ°saveEvoSettingsä¸­ï¼Œæ­¤å‡½æ•°ä¿ç•™ç”¨äºæ‰‹åŠ¨è§¦å‘ï¼‰
    async function syncEvoSettingsToMainSite() {
      try {
        // å…ˆä¿å­˜è®¾ç½®
        const settings = await saveEvoSettings();
        if (settings) {
          showEvoSettingsStatus('âœ… è®¾ç½®å·²ä¿å­˜å¹¶åŒæ­¥ï¼ä¸»ç«™å°†è‡ªåŠ¨æ›´æ–°ã€‚', 'success');
          
          // å¯é€‰ï¼šæ‰“å¼€ä¸»ç«™æŸ¥çœ‹æ•ˆæœ
          const mainSiteUrl = window.location.origin.replace('/admin.html', '/index.html');
          if (confirm('è®¾ç½®å·²ä¿å­˜ï¼æ˜¯å¦ç°åœ¨æ‰“å¼€ä¸»ç«™æŸ¥çœ‹æ•ˆæœï¼Ÿ')) {
            window.open(mainSiteUrl, '_blank');
          }
        }
      } catch (error) {
        console.error('åŒæ­¥åˆ°ä¸»ç«™å¤±è´¥:', error);
        showEvoSettingsStatus('âŒ åŒæ­¥å¤±è´¥ï¼š' + error.message, 'error');
      }
    }
    
    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showEvoSettingsStatus(message, type = 'info') {
      const statusEl = document.getElementById('evoSettingsStatus');
      if (!statusEl) return;
      
      statusEl.style.display = 'block';
      statusEl.textContent = message;
      
      // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
      statusEl.style.background = type === 'success' ? 'var(--success-light)' : 
                                  type === 'error' ? 'var(--danger-light)' : 
                                  'var(--primary-50)';
      statusEl.style.color = type === 'success' ? 'var(--success)' : 
                             type === 'error' ? 'var(--danger)' : 
                             'var(--primary)';
      statusEl.style.border = `1px solid ${type === 'success' ? 'var(--success)' : 
                                            type === 'error' ? 'var(--danger)' : 
                                            'var(--primary)'}`;
      
      // 3ç§’åè‡ªåŠ¨éšè—
      setTimeout(() => {
        statusEl.style.display = 'none';
      }, 3000);
    }
    
    // åŠ è½½AIæ¨¡å‹ä¿¡æ¯ï¼ˆæ™ºèƒ½ç®¡ç†ï¼‰
    async function loadAdminAIModelInfo() {
      try {
        const token = getAuthToken();
        if (!token) return;
        
        const response = await fetch(`${getApiUrl()}/evo/model-info`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.data) {
            displayAdminAIModelInfo(data.data);
          }
        }
      } catch (error) {
        console.error('åŠ è½½AIæ¨¡å‹ä¿¡æ¯å¤±è´¥:', error);
        // ä½¿ç”¨é»˜è®¤ä¿¡æ¯
        displayAdminAIModelInfo({
          name: 'Zephyr-7B-Beta',
          provider: 'Hugging Face',
          source: 'https://huggingface.co/HuggingFaceH4/zephyr-7b-beta',
          free: true,
          features: ['å®Œå…¨å…è´¹ä½¿ç”¨', 'æ— éœ€ä¿¡ç”¨å¡', 'æ”¯æŒä¸­æ–‡å¯¹è¯', 'é«˜æ€§èƒ½å“åº”', 'å¼€æºæ¨¡å‹']
        });
      }
    }
    
    // æ˜¾ç¤ºAIæ¨¡å‹ä¿¡æ¯ï¼ˆæ™ºèƒ½ç®¡ç†ï¼‰
    function displayAdminAIModelInfo(modelInfo) {
      if (!modelInfo) return;
      
      const nameEl = document.getElementById('adminAIModelName');
      const providerEl = document.getElementById('adminAIProvider');
      const sourceEl = document.getElementById('adminAISource');
      const statusEl = document.getElementById('adminAIStatus');
      const featuresEl = document.getElementById('adminAIFeatures');
      
      if (nameEl) nameEl.textContent = modelInfo.name || 'æœªçŸ¥';
      if (providerEl) providerEl.textContent = modelInfo.provider || 'æœªçŸ¥';
      if (sourceEl) {
        sourceEl.href = modelInfo.source || '#';
        sourceEl.textContent = modelInfo.source ? 'æŸ¥çœ‹æ¨¡å‹è¯¦æƒ…' : 'æœªçŸ¥';
      }
      
      if (statusEl) {
        statusEl.textContent = modelInfo.free ? 'âœ… å…è´¹ä½¿ç”¨' : 'ğŸ’° ä»˜è´¹';
        statusEl.style.background = modelInfo.free ? 'rgba(76, 175, 80, 0.3)' : 'rgba(255, 152, 0, 0.3)';
      }
      
      if (featuresEl && modelInfo.features) {
        featuresEl.innerHTML = modelInfo.features.map(f => `â€¢ ${f}`).join('<br>');
      }
    }
    
    // æµ‹è¯•AIè¿æ¥ï¼ˆæ™ºèƒ½ç®¡ç†ï¼‰
    async function testAdminAIConnection() {
      const btn = document.getElementById('btnAdminTestAI');
      const statusEl = document.getElementById('adminAIStatus');
      
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'æµ‹è¯•ä¸­...';
      }
      
      if (statusEl) {
        statusEl.textContent = 'æµ‹è¯•ä¸­...';
        statusEl.style.background = 'rgba(255, 152, 0, 0.3)';
      }
      
      try {
        const token = getAuthToken();
        if (!token) {
          throw new Error('è¯·å…ˆç™»å½•');
        }
        
        const response = await fetch(`${getApiUrl()}/evo/test`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          if (statusEl) {
            statusEl.textContent = 'âœ… è¿æ¥æ­£å¸¸';
            statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
          }
          alert('AI è¿æ¥æµ‹è¯•æˆåŠŸï¼\n\næ¨¡å‹ï¼š' + (data.data?.model || 'æœªçŸ¥') + '\næä¾›å•†ï¼š' + (data.data?.provider || 'æœªçŸ¥'));
        } else {
          throw new Error(data.message || 'è¿æ¥å¤±è´¥');
        }
      } catch (error) {
        if (statusEl) {
          statusEl.textContent = 'âŒ è¿æ¥å¤±è´¥';
          statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
        }
        alert('AI è¿æ¥æµ‹è¯•å¤±è´¥ï¼š' + error.message);
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'æµ‹è¯• AI è¿æ¥';
        }
      }
    }
    
    // ç”¨æˆ·ä¿¡æ¯å’Œè®¾ç½®æ¨¡æ€æ¡†å‡½æ•°
    // åŠ è½½ç”¨æˆ·è®¾ç½®
    function loadUserSettings() {
      try {
        const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
        return {
          avatar: settings.avatar || null,
          displayName: settings.displayName || null
        };
      } catch (e) {
        console.error('åŠ è½½ç”¨æˆ·è®¾ç½®å¤±è´¥:', e);
        return { avatar: null, displayName: null };
      }
    }
    
    // ä¿å­˜ç”¨æˆ·è®¾ç½®
    function saveUserSettings(settings) {
      try {
        localStorage.setItem('userSettings', JSON.stringify(settings));
        return true;
      } catch (e) {
        console.error('ä¿å­˜ç”¨æˆ·è®¾ç½®å¤±è´¥:', e);
        return false;
      }
    }
    
    // æ›´æ–°é¡¶éƒ¨å¯¼èˆªæ çš„ç”¨æˆ·æ˜¾ç¤º
    function updateTopBarUserDisplay() {
      const settings = loadUserSettings();
      const adminUserName = document.getElementById('adminUserName');
      const btnUserAvatar = document.getElementById('btnUserAvatar');
      
      // æ›´æ–°ç”¨æˆ·åæ˜¾ç¤º
      if (adminUserName) {
        const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
        const displayName = settings.displayName || userInfo.username || 'ç®¡ç†å‘˜';
        adminUserName.textContent = `æ¬¢è¿ï¼Œ${displayName}`;
      }
      
      // æ›´æ–°è´¦æˆ·æŒ‰é’®
      if (btnUserAvatar) {
        const avatarSpan = btnUserAvatar.querySelector('span:first-child');
        const textSpan = btnUserAvatar.querySelector('span:last-child');
        
        if (settings.avatar) {
          // å¦‚æœæœ‰è‡ªå®šä¹‰å¤´åƒï¼Œæ˜¾ç¤ºå¤´åƒå›¾ç‰‡
          if (!avatarSpan || avatarSpan.textContent === 'ğŸ‘¤') {
            const img = document.createElement('img');
            img.src = settings.avatar;
            img.style.cssText = 'width:20px;height:20px;border-radius:50%;object-fit:cover;';
            if (avatarSpan) {
              avatarSpan.replaceWith(img);
            } else {
              btnUserAvatar.insertBefore(img, textSpan);
            }
          } else if (avatarSpan.tagName === 'IMG') {
            avatarSpan.src = settings.avatar;
          }
        } else {
          // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰å¤´åƒï¼Œæ˜¾ç¤ºé»˜è®¤å›¾æ ‡
          if (avatarSpan && avatarSpan.tagName === 'IMG') {
            const span = document.createElement('span');
            span.textContent = 'ğŸ‘¤';
            span.style.fontSize = '16px';
            avatarSpan.replaceWith(span);
          }
        }
        
        if (textSpan) {
          const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
          const displayName = settings.displayName || userInfo.username || 'è´¦æˆ·';
          textSpan.textContent = displayName.length > 8 ? displayName.substring(0, 8) + '...' : displayName;
        }
      }
    }
    
    window.showUserInfoModal = function() {
      const modal = document.getElementById('userInfoModal');
      if (!modal) return;
      
      // åˆ‡æ¢åˆ°æŸ¥çœ‹æ¨¡å¼
      document.getElementById('userInfoViewMode').style.display = 'block';
      document.getElementById('userInfoEditMode').style.display = 'none';
      
      // ä»localStorageæˆ–å½“å‰ç™»å½•ä¿¡æ¯è·å–ç”¨æˆ·æ•°æ®
      const adminUserName = document.getElementById('adminUserName')?.textContent || '';
      const userNameMatch = adminUserName.match(/æ¬¢è¿ï¼Œ(.+)/);
        const defaultUserName = userNameMatch ? userNameMatch[1] : 'ç®¡ç†å‘˜';
      
      // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆä»localStorageæˆ–APIï¼‰
      const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
      const userSettings = loadUserSettings();
      const userName = userSettings.displayName || defaultUserName;
      const userEmail = userInfo.email || 'admin@example.com';
      const userType = userInfo.type || 'ç®¡ç†å‘˜';
      const registerDate = userInfo.registerDate || new Date().toISOString().split('T')[0];
      const userRole = userInfo.role || 'ç®¡ç†å‘˜';
      
      // æ›´æ–°æ˜¾ç¤º
      const avatarDisplay = document.getElementById('userAvatarDisplay');
      if (userSettings.avatar) {
        avatarDisplay.style.backgroundImage = `url(${userSettings.avatar})`;
        avatarDisplay.textContent = '';
      } else {
        avatarDisplay.style.backgroundImage = '';
        avatarDisplay.textContent = 'ğŸ‘¤';
      }
      
      document.getElementById('userNameDisplay').textContent = userName;
      document.getElementById('userEmailDisplay').textContent = userEmail;
      document.getElementById('userTypeDisplay').textContent = userType;
      document.getElementById('userRegisterDate').textContent = registerDate;
      document.getElementById('userRoleDisplay').textContent = userRole;
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      modal.style.display = 'flex';
    };
    
    // è¿›å…¥ç¼–è¾‘æ¨¡å¼
    window.enterEditUserInfoMode = function() {
      document.getElementById('userInfoViewMode').style.display = 'none';
      document.getElementById('userInfoEditMode').style.display = 'block';
      
      // åŠ è½½å½“å‰è®¾ç½®
      const userSettings = loadUserSettings();
      const adminUserName = document.getElementById('adminUserName')?.textContent || '';
      const userNameMatch = adminUserName.match(/æ¬¢è¿ï¼Œ(.+)/);
        const defaultUserName = userNameMatch ? userNameMatch[1] : 'ç®¡ç†å‘˜';
      const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
      
      // è®¾ç½®å¤´åƒæ˜¾ç¤º
      const avatarEditDisplay = document.getElementById('userAvatarEditDisplay');
      if (userSettings.avatar) {
        avatarEditDisplay.style.backgroundImage = `url(${userSettings.avatar})`;
        avatarEditDisplay.textContent = '';
      } else {
        avatarEditDisplay.style.backgroundImage = '';
        avatarEditDisplay.textContent = 'ğŸ‘¤';
      }
      
      // è®¾ç½®åå­—è¾“å…¥æ¡†
      document.getElementById('userNameInput').value = userSettings.displayName || defaultUserName;
      
      // ç»‘å®šå¤´åƒä¸Šä¼ äº‹ä»¶
      const avatarInput = document.getElementById('userAvatarInput');
      if (avatarInput) {
        avatarInput.onchange = function(e) {
          const file = e.target.files[0];
          if (file) {
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º2MBï¼‰
            if (file.size > 2 * 1024 * 1024) {
              alert('å¤´åƒæ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡2MB');
              return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
              alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
              return;
            }
            
            // è¯»å–æ–‡ä»¶å¹¶è½¬æ¢ä¸ºbase64
            const reader = new FileReader();
            reader.onload = function(e) {
              const base64 = e.target.result;
              avatarEditDisplay.style.backgroundImage = `url(${base64})`;
              avatarEditDisplay.textContent = '';
            };
            reader.readAsDataURL(file);
          }
        };
      }
    };
    
    // å–æ¶ˆç¼–è¾‘
    window.cancelEditUserInfo = function() {
      document.getElementById('userInfoViewMode').style.display = 'block';
      document.getElementById('userInfoEditMode').style.display = 'none';
      showUserInfoModal(); // é‡æ–°åŠ è½½æ˜¾ç¤º
    };
    
    // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
    window.saveUserInfo = function() {
      const userNameInput = document.getElementById('userNameInput');
      const avatarInput = document.getElementById('userAvatarInput');
      const avatarEditDisplay = document.getElementById('userAvatarEditDisplay');
      
      const displayName = userNameInput.value.trim();
      if (!displayName) {
        alert('è¯·è¾“å…¥æ˜µç§°');
        return;
      }
      
      // è·å–å¤´åƒï¼ˆbase64ï¼‰
      let avatar = null;
      if (avatarEditDisplay.style.backgroundImage && avatarEditDisplay.style.backgroundImage !== 'none') {
        avatar = avatarEditDisplay.style.backgroundImage.replace('url("', '').replace('")', '').replace("url('", '').replace("')", '');
      }
      
      // ä¿å­˜è®¾ç½®
      const success = saveUserSettings({
        avatar: avatar,
        displayName: displayName
      });
      
      if (success) {
        // æ›´æ–°é¡¶éƒ¨å¯¼èˆªæ 
        updateTopBarUserDisplay();
        
        // åˆ‡æ¢å›æŸ¥çœ‹æ¨¡å¼å¹¶åˆ·æ–°
        cancelEditUserInfo();
        alert('ä¿å­˜æˆåŠŸï¼');
      } else {
        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    };
    
    window.closeUserInfoModal = function() {
      const modal = document.getElementById('userInfoModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };
    
    window.showSettingsModal = function() {
      const modal = document.getElementById('settingsModal');
      if (!modal) return;
      modal.style.display = 'flex';
      // æ›´æ–°ä¸»é¢˜æŒ‰é’®æ–‡æœ¬
      const themeBtn = document.getElementById('btnToggleThemeInModal');
      if (themeBtn) {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        themeBtn.textContent = currentTheme === 'dark' ? 'â˜€ï¸ æµ…è‰²æ¨¡å¼' : 'ğŸŒ™ å¤œé—´æ¨¡å¼';
        themeBtn.title = currentTheme === 'dark' ? 'åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼' : 'åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼';
      }
    };
    
    window.closeSettingsModal = function() {
      const modal = document.getElementById('settingsModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };
    
    // æ•°æ®å¯¼å‡ºå’Œå¯¼å…¥åŠŸèƒ½
    window.exportAllData = function() {
      try {
        // ä»localStorageè¯»å–ä¸»ç«™æ•°æ®
        const pigeonsData = JSON.parse(localStorage.getItem('pigeons') || '[]');
        const racesData = JSON.parse(localStorage.getItem('races') || '[]');
        const pairingsData = JSON.parse(localStorage.getItem('pairings') || '[]');
        const healthRecordsData = JSON.parse(localStorage.getItem('healthRecords') || '[]');
        const usedNamesData = JSON.parse(localStorage.getItem('usedNames') || '[]');
        const ownerRegionPairsData = JSON.parse(localStorage.getItem('ownerRegionPairs') || '[]');
        
        const exportData = {
          version: '2.0',
          exportDate: new Date().toISOString(),
          data: {
            pigeons: pigeonsData,
            races: racesData,
            pairings: pairingsData,
            healthRecords: healthRecordsData,
            usedNames: usedNamesData,
            ownerRegionPairs: ownerRegionPairsData
          }
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pigeon_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('æ•°æ®å¤‡ä»½å·²ä¸‹è½½ï¼\n\nå¤‡ä»½äº† ' + pigeonsData.length + ' åªé¸½å­çš„æ•°æ®ã€‚\nè¯·å¦¥å–„ä¿ç®¡å¤‡ä»½æ–‡ä»¶ã€‚');
      } catch (error) {
        console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
        alert('å¯¼å‡ºæ•°æ®å¤±è´¥ï¼š' + error.message);
      }
    };
    
    window.importBackupData = function(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const backupData = JSON.parse(e.target.result);
          
          if (!backupData.data || !backupData.data.pigeons) {
            alert('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼');
            return;
          }
          
          if (!confirm(`ç¡®å®šè¦æ¢å¤å¤‡ä»½æ•°æ®å—ï¼Ÿ\n\nå¤‡ä»½æ—¶é—´: ${backupData.exportDate}\né¸½å­æ•°é‡: ${backupData.data.pigeons.length}\næ¯”èµ›æ•°é‡: ${backupData.data.races?.length || 0}\n\nâš ï¸ è¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼`)) {
            return;
          }
          
          // æ¢å¤æ•°æ®åˆ°localStorage
          localStorage.setItem('pigeons', JSON.stringify(backupData.data.pigeons));
          
          if (backupData.data.races) {
            localStorage.setItem('races', JSON.stringify(backupData.data.races));
          }
          
          if (backupData.data.pairings) {
            localStorage.setItem('pairings', JSON.stringify(backupData.data.pairings));
          }
          
          if (backupData.data.healthRecords) {
            localStorage.setItem('healthRecords', JSON.stringify(backupData.data.healthRecords));
          }
          
          if (backupData.data.usedNames) {
            localStorage.setItem('usedNames', JSON.stringify(backupData.data.usedNames));
          }
          
          if (backupData.data.ownerRegionPairs) {
            localStorage.setItem('ownerRegionPairs', JSON.stringify(backupData.data.ownerRegionPairs));
          }
          
          alert('æ•°æ®æ¢å¤æˆåŠŸï¼\n\nå·²æ¢å¤ ' + backupData.data.pigeons.length + ' åªé¸½å­çš„æ•°æ®ã€‚\nè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹æ›´æ–°ã€‚');
        } catch (error) {
          console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
          alert('å¯¼å…¥æ•°æ®å¤±è´¥ï¼š' + error.message);
        }
      };
      reader.readAsText(file);
    };
    
    // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    function initAdminUserInfo() {
      const userInfo = localStorage.getItem('adminUserInfo');
      if (!userInfo) {
        const adminUserName = document.getElementById('adminUserName')?.textContent || '';
        const userNameMatch = adminUserName.match(/æ¬¢è¿ï¼Œ(.+)/);
        const userName = userNameMatch ? userNameMatch[1] : 'ç®¡ç†å‘˜';
        
        const defaultUserInfo = {
          name: userName,
          email: 'admin@example.com',
          type: 'ç®¡ç†å‘˜',
          role: 'ç®¡ç†å‘˜',
          registerDate: new Date().toISOString().split('T')[0]
        };
        localStorage.setItem('adminUserInfo', JSON.stringify(defaultUserInfo));
      }
    }
    
    // ç»‘å®šç”¨æˆ·å¤´åƒå’Œè®¾ç½®æŒ‰é’®äº‹ä»¶
    function bindUserButtons() {
      // ç»‘å®šç”¨æˆ·å¤´åƒæŒ‰é’®
      const btnUserAvatar = document.getElementById('btnUserAvatar');
      if (btnUserAvatar) {
        btnUserAvatar.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          showUserInfoModal();
        });
        
        // é¡µé¢åŠ è½½æ—¶æ›´æ–°é¡¶éƒ¨å¯¼èˆªæ çš„ç”¨æˆ·æ˜¾ç¤º
        updateTopBarUserDisplay();
      }
      
      // ç»‘å®šè®¾ç½®æŒ‰é’®
      const btnSettings = document.getElementById('btnSettings');
      if (btnSettings) {
        btnSettings.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          showSettingsModal();
        });
      }
      
      // ç»‘å®šè®¾ç½®æ¨¡æ€æ¡†å†…çš„æŒ‰é’®
      const btnToggleThemeInModal = document.getElementById('btnToggleThemeInModal');
      if (btnToggleThemeInModal) {
        btnToggleThemeInModal.addEventListener('click', function() {
          const themeToggle = document.getElementById('themeToggle');
          if (themeToggle) {
            themeToggle.click();
          }
          // æ›´æ–°æŒ‰é’®æ–‡æœ¬
          setTimeout(() => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            btnToggleThemeInModal.textContent = currentTheme === 'dark' ? 'â˜€ï¸ æµ…è‰²æ¨¡å¼' : 'ğŸŒ™ å¤œé—´æ¨¡å¼';
            btnToggleThemeInModal.title = currentTheme === 'dark' ? 'åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼' : 'åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼';
          }, 100);
        });
      }
      
      // ç»‘å®šæ•°æ®ç®¡ç†æŒ‰é’®
      const btnBackupDataInModal = document.getElementById('btnBackupDataInModal');
      if (btnBackupDataInModal) {
        btnBackupDataInModal.addEventListener('click', function() {
          exportAllData();
        });
      }
      
      const btnExportDataInModal = document.getElementById('btnExportDataInModal');
      if (btnExportDataInModal) {
        btnExportDataInModal.addEventListener('click', function() {
          exportAllData();
        });
      }
      
      const btnImportDataInModal = document.getElementById('btnImportDataInModal');
      if (btnImportDataInModal) {
        btnImportDataInModal.addEventListener('click', function() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
              importBackupData(file);
            }
          };
          input.click();
        });
      }
      
      // ç»‘å®šé€€å‡ºç™»å½•æŒ‰é’®ï¼ˆåœ¨è®¾ç½®æ¨¡æ€æ¡†å†…ï¼‰
      const logoutBtnInModal = document.getElementById('logoutBtnInModal');
      if (logoutBtnInModal) {
        logoutBtnInModal.addEventListener('click', function() {
          localStorage.removeItem('adminToken');
          localStorage.removeItem('adminUser');
          const loginPage = document.getElementById('loginPage');
          const adminPage = document.getElementById('adminPage');
          if (loginPage) loginPage.style.display = 'flex';
          if (adminPage) adminPage.style.display = 'none';
          const usernameInput = document.getElementById('username');
          const passwordInput = document.getElementById('password');
          if (usernameInput) usernameInput.value = '';
          if (passwordInput) passwordInput.value = '';
          closeSettingsModal();
        });
      }
      
      // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
      const userInfoModal = document.getElementById('userInfoModal');
      const settingsModal = document.getElementById('settingsModal');
      
      if (userInfoModal) {
        userInfoModal.addEventListener('click', function(e) {
          if (e.target === userInfoModal) {
            closeUserInfoModal();
          }
        });
      }
      
      if (settingsModal) {
        settingsModal.addEventListener('click', function(e) {
          if (e.target === settingsModal) {
            closeSettingsModal();
          }
        });
      }
      
      // ESCé”®å…³é—­æ¨¡æ€æ¡†
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeUserInfoModal();
          closeSettingsModal();
        }
      });
    }
    
    // ç»‘å®šEvoè®¾ç½®æŒ‰é’®äº‹ä»¶
    document.addEventListener('DOMContentLoaded', () => {
      // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
      initAdminUserInfo();
      
      // ç»‘å®šç”¨æˆ·æŒ‰é’®
      bindUserButtons();
      
      // å»¶è¿Ÿç»‘å®šï¼Œç¡®ä¿ç”¨æˆ·åå·²åŠ è½½
      setTimeout(() => {
        initAdminUserInfo();
      }, 1000);
      const btnSave = document.getElementById('btnSaveEvoSettings');
      const btnReset = document.getElementById('btnResetEvoSettings');
      const btnSync = document.getElementById('btnSyncEvoSettings');
      const btnTestAI = document.getElementById('btnAdminTestAI');
      
      if (btnSave) {
        btnSave.addEventListener('click', saveEvoSettings);
      }
      
      if (btnReset) {
        btnReset.addEventListener('click', resetEvoSettings);
      }
      
      if (btnSync) {
        btnSync.addEventListener('click', syncEvoSettingsToMainSite);
      }
      
      if (btnTestAI) {
        btnTestAI.addEventListener('click', testAdminAIConnection);
      }
      
      // å½“åˆ‡æ¢åˆ°Evoè®¾ç½®æ ‡ç­¾æ—¶ï¼ŒåŠ è½½AIæ¨¡å‹ä¿¡æ¯
      const evoSettingsTab = document.getElementById('evoSettingsTab');
      if (evoSettingsTab) {
        // ç«‹å³åŠ è½½ä¸€æ¬¡ï¼ˆå¦‚æœæ ‡ç­¾é¡µå·²ç»æ˜¾ç¤ºï¼‰
        if (evoSettingsTab.style.display !== 'none') {
          console.log('ğŸ”„ Evoè®¾ç½®é¡µé¢å·²æ˜¾ç¤ºï¼Œç«‹å³åŠ è½½AIä¿¡æ¯...');
          setTimeout(() => {
            loadAdminAIModelInfo();
            loadEvoAIModelInfo();
          }, 200);
        }
        
        const observer = new MutationObserver((mutations) => {
          if (evoSettingsTab.style.display !== 'none') {
            console.log('ğŸ”„ Evoè®¾ç½®é¡µé¢æ˜¾ç¤ºï¼ŒåŠ è½½AIä¿¡æ¯...');
            setTimeout(() => {
              loadAdminAIModelInfo();
              loadEvoAIModelInfo();
            }, 200);
          }
        });
        observer.observe(evoSettingsTab, { attributes: true, attributeFilter: ['style'] });
        
        // ç›‘å¬æ‰€æœ‰å¯èƒ½çš„æ ‡ç­¾åˆ‡æ¢æ–¹å¼
        // æ–¹å¼1ï¼šé€šè¿‡å¯¼èˆªèœå•
        document.querySelectorAll('[data-tab="evoSettings"], [onclick*="evoSettings"]').forEach(el => {
          el.addEventListener('click', () => {
            setTimeout(() => {
              if (evoSettingsTab.style.display !== 'none') {
                console.log('ğŸ”„ ç‚¹å‡»Evoè®¾ç½®æ ‡ç­¾ï¼ŒåŠ è½½AIä¿¡æ¯...');
                loadEvoAIModelInfo();
              }
            }, 300);
          });
        });
        
        // æ–¹å¼2ï¼šé€šè¿‡ä¾§è¾¹æ ç‚¹å‡»
        const sidebarLinks = document.querySelectorAll('a, .nav-item, .menu-item');
        sidebarLinks.forEach(link => {
          if (link.textContent && link.textContent.includes('Evoè®¾ç½®')) {
            link.addEventListener('click', () => {
              setTimeout(() => {
                if (evoSettingsTab.style.display !== 'none') {
                  console.log('ğŸ”„ é€šè¿‡ä¾§è¾¹æ æ‰“å¼€Evoè®¾ç½®ï¼ŒåŠ è½½AIä¿¡æ¯...');
                  loadEvoAIModelInfo();
                }
              }, 300);
            });
          }
        });
      }
      
      // é¡µé¢åŠ è½½å®Œæˆåä¹Ÿå°è¯•åŠ è½½ä¸€æ¬¡
      if (document.readyState === 'complete') {
        setTimeout(() => {
          if (evoSettingsTab && evoSettingsTab.style.display !== 'none') {
            console.log('ğŸ”„ é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥Evoè®¾ç½®é¡µé¢...');
            loadEvoAIModelInfo();
          }
        }, 1000);
      } else {
        window.addEventListener('load', () => {
          setTimeout(() => {
            if (evoSettingsTab && evoSettingsTab.style.display !== 'none') {
              console.log('ğŸ”„ çª—å£åŠ è½½å®Œæˆï¼Œæ£€æŸ¥Evoè®¾ç½®é¡µé¢...');
              loadEvoAIModelInfo();
            }
          }, 1000);
        });
      }
      
      // ç»‘å®šEvoè®¾ç½®é¡µé¢çš„AIä¿¡æ¯æŒ‰é’®
      const btnRefreshAI = document.getElementById('btnEvoRefreshAIInfo');
      const btnTestEvoAI = document.getElementById('btnEvoTestAI');
      
      if (btnRefreshAI) {
        btnRefreshAI.addEventListener('click', () => {
          console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°AIä¿¡æ¯æŒ‰é’®è¢«ç‚¹å‡»');
          loadEvoAIModelInfo();
          const statusEl = document.getElementById('evoAIInfoStatus');
          if (statusEl) {
            statusEl.style.display = 'block';
            statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
            statusEl.style.color = 'var(--text-primary)';
            statusEl.textContent = 'âœ… AIä¿¡æ¯å·²åˆ·æ–°';
            setTimeout(() => {
              statusEl.style.display = 'none';
            }, 2000);
          }
        });
      }
      
      // ç¡®ä¿é¡µé¢åŠ è½½æ—¶ä¹Ÿå°è¯•åŠ è½½AIä¿¡æ¯
      setTimeout(() => {
        const evoSettingsTab = document.getElementById('evoSettingsTab');
        if (evoSettingsTab && evoSettingsTab.style.display !== 'none') {
          console.log('ğŸ”„ Evoè®¾ç½®é¡µé¢å¯è§ï¼Œè‡ªåŠ¨åŠ è½½AIä¿¡æ¯');
          loadEvoAIModelInfo();
        }
      }, 1000);
      
      if (btnTestEvoAI) {
        btnTestEvoAI.addEventListener('click', async () => {
          btnTestEvoAI.disabled = true;
          btnTestEvoAI.textContent = 'æµ‹è¯•ä¸­...';
          
          const statusEl = document.getElementById('evoAIInfoStatus');
          if (statusEl) {
            statusEl.style.display = 'block';
            statusEl.style.background = 'rgba(255, 152, 0, 0.3)';
            statusEl.textContent = 'ğŸ”„ æ­£åœ¨æµ‹è¯•AIè¿æ¥...';
          }
          
          try {
            const token = getAuthToken();
            if (!token) {
              throw new Error('è¯·å…ˆç™»å½•');
            }
            
            const response = await fetch(`${getApiUrl()}/evo/test`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              }
            });
            
            const result = await response.json();
            
            if (statusEl) {
              if (result.success) {
                statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
                statusEl.textContent = `âœ… ${result.message || 'AIè¿æ¥æµ‹è¯•æˆåŠŸï¼'}`;
              } else {
                statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
                statusEl.textContent = `âŒ ${result.message || 'AIè¿æ¥æµ‹è¯•å¤±è´¥'}`;
              }
            }
          } catch (error) {
            if (statusEl) {
              statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
              statusEl.textContent = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
          } finally {
            btnTestEvoAI.disabled = false;
            btnTestEvoAI.textContent = 'ğŸ§ª æµ‹è¯•è¿æ¥';
          }
        });
      }
    });
    
    // è·å–tokenå‡½æ•°ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    function getAuthToken() {
      // ä¼˜å…ˆä½¿ç”¨adminTokenï¼ˆæ™ºèƒ½ç®¡ç†ç³»ç»Ÿä½¿ç”¨çš„tokenï¼‰
      const adminToken = localStorage.getItem('adminToken');
      if (adminToken) {
        return adminToken;
      }
      // å¦‚æœæ²¡æœ‰adminTokenï¼Œå°è¯•ä½¿ç”¨tokenï¼ˆä¸»ç«™ä½¿ç”¨çš„tokenï¼‰
      return localStorage.getItem('token');
    }
    
    // åŠ è½½Evoè®¾ç½®é¡µé¢çš„AIæ¨¡å‹ä¿¡æ¯
    async function loadEvoAIModelInfo() {
      // å…ˆæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
      const nameEl = document.getElementById('evoAIModelName');
      const statusInfoEl = document.getElementById('evoAIInfoStatus');
      
      if (!nameEl) {
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        if (statusInfoEl) {
          statusInfoEl.style.display = 'block';
          statusInfoEl.style.background = 'rgba(255, 152, 0, 0.3)';
          statusInfoEl.style.color = 'var(--text-primary)';
          statusInfoEl.innerHTML = 'â³ é¡µé¢æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™...';
        }
        setTimeout(() => loadEvoAIModelInfo(), 500);
        return;
      }
      
      // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
      if (statusInfoEl) {
        statusInfoEl.style.display = 'block';
        statusInfoEl.style.background = 'rgba(255, 152, 0, 0.3)';
        statusInfoEl.style.color = 'var(--text-primary)';
        statusInfoEl.innerHTML = 'ğŸ”„ æ­£åœ¨åŠ è½½AIä¿¡æ¯...';
      }
      
      const providerEl = document.getElementById('evoAIProvider');
      if (nameEl) nameEl.textContent = 'åŠ è½½ä¸­...';
      if (providerEl) providerEl.textContent = 'åŠ è½½ä¸­...';
      
      try {
        const token = getAuthToken();
        if (!token) {
          if (statusInfoEl) {
            statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
            statusInfoEl.innerHTML = 'âŒ <strong>æœªç™»å½•</strong><br>è¯·å…ˆç™»å½•ç³»ç»Ÿï¼Œç„¶åæ‰èƒ½æŸ¥çœ‹AIæ¨¡å‹ä¿¡æ¯ã€‚';
          }
          displayEvoAIModelInfo(null);
          return;
        }
        
        const apiUrl = getApiUrl();
        
        const response = await fetch(`${apiUrl}/evo/model-info`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success && result.data) {
            displayEvoAIModelInfo(result.data);
          } else {
            if (statusInfoEl) {
              statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
              statusInfoEl.innerHTML = `âŒ <strong>APIè¿”å›é”™è¯¯</strong><br>${result.error || 'æœªçŸ¥é”™è¯¯'}`;
            }
            displayEvoAIModelInfo(null);
          }
        } else {
          const errorData = await response.json().catch(() => ({ error: 'æ— æ³•è§£æé”™è¯¯ä¿¡æ¯' }));
          
          if (statusInfoEl) {
            statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
            let errorMsg = `âŒ <strong>åŠ è½½å¤±è´¥ (${response.status})</strong><br>`;
            
            if (response.status === 401) {
              errorMsg += 'è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•ï¼';
            } else if (response.status === 404) {
              errorMsg += 'APIæ¥å£ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡ï¼';
            } else if (response.status === 500) {
              errorMsg += 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æ—¥å¿—ï¼';
            } else {
              errorMsg += errorData.error || 'æœªçŸ¥é”™è¯¯';
            }
            
            statusInfoEl.innerHTML = errorMsg;
          }
          
          displayEvoAIModelInfo(null);
        }
      } catch (error) {
        if (statusInfoEl) {
          statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
          let errorMsg = 'âŒ <strong>ç½‘ç»œé”™è¯¯</strong><br>';
          
          if (error.message.includes('Failed to fetch')) {
            errorMsg += 'æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ï¼<br>è¯·ç¡®è®¤ï¼š<br>1. åç«¯æœåŠ¡å·²å¯åŠ¨ï¼ˆè¿è¡Œ npm startï¼‰<br>2. æœåŠ¡åœ°å€æ­£ç¡®ï¼ˆhttp://localhost:3000ï¼‰<br>3. ç½‘ç»œè¿æ¥æ­£å¸¸';
          } else {
            errorMsg += error.message || 'æœªçŸ¥é”™è¯¯';
          }
          
          statusInfoEl.innerHTML = errorMsg;
        }
        
        displayEvoAIModelInfo(null);
      }
    }
    
    // æ˜¾ç¤ºEvoè®¾ç½®é¡µé¢çš„AIæ¨¡å‹ä¿¡æ¯
    function displayEvoAIModelInfo(modelInfo) {
      const nameEl = document.getElementById('evoAIModelName');
      const providerEl = document.getElementById('evoAIProvider');
      const statusEl = document.getElementById('evoAIStatus');
      const sourceEl = document.getElementById('evoAISource');
      const descEl = document.getElementById('evoAIDescription');
      const featuresEl = document.getElementById('evoAIFeatures');
      const statusInfoEl = document.getElementById('evoAIInfoStatus');
      
      // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
      if (statusInfoEl) {
        statusInfoEl.style.display = 'block';
        statusInfoEl.style.padding = '12px';
        statusInfoEl.style.borderRadius = '6px';
        statusInfoEl.style.fontSize = '14px';
      }
      
      if (!modelInfo) {
        if (nameEl) nameEl.textContent = 'âŒ æœªé…ç½®';
        if (providerEl) providerEl.textContent = 'æœªçŸ¥';
        if (statusEl) {
          statusEl.textContent = 'âŒ æœªé…ç½®';
          statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
        }
        if (sourceEl) {
          sourceEl.href = '#';
          sourceEl.textContent = 'æ— ';
        }
        if (descEl) descEl.textContent = 'AIæœåŠ¡æœªé…ç½®ï¼Œè¯·æ£€æŸ¥API Keyè®¾ç½®';
        if (featuresEl) featuresEl.textContent = 'æ— å¯ç”¨åŠŸèƒ½';
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        if (statusInfoEl) {
          statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
          statusInfoEl.style.color = 'var(--text-primary)';
          statusInfoEl.innerHTML = 'âŒ <strong>AIä¿¡æ¯åŠ è½½å¤±è´¥</strong><br>è¯·ç‚¹å‡»"ğŸ”„ åˆ·æ–°ä¿¡æ¯"æŒ‰é’®é‡è¯•ï¼Œæˆ–æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚';
        }
        return;
      }
      
      // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
      if (statusInfoEl) {
        statusInfoEl.style.background = 'rgba(76, 175, 80, 0.3)';
        statusInfoEl.style.color = 'var(--text-primary)';
        statusInfoEl.innerHTML = 'âœ… <strong>AIä¿¡æ¯åŠ è½½æˆåŠŸ</strong>';
        setTimeout(() => {
          if (statusInfoEl) statusInfoEl.style.display = 'none';
        }, 3000);
      }
      
      if (nameEl) nameEl.textContent = modelInfo.name || 'æœªçŸ¥';
      if (providerEl) providerEl.textContent = modelInfo.provider || 'æœªçŸ¥';
      
      if (statusEl) {
        if (modelInfo.free) {
          statusEl.textContent = 'âœ… å…è´¹ä½¿ç”¨';
          statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
        } else {
          statusEl.textContent = 'ğŸ’° ä»˜è´¹';
          statusEl.style.background = 'rgba(255, 152, 0, 0.3)';
        }
      }
      
      if (sourceEl) {
        sourceEl.href = modelInfo.source || '#';
        sourceEl.textContent = modelInfo.source ? 'æŸ¥çœ‹æ¨¡å‹è¯¦æƒ…' : 'æ— ';
      }
      
      if (descEl) {
        descEl.textContent = modelInfo.description || 'æ™ºèƒ½å¯¹è¯æ¨¡å‹ï¼Œæ”¯æŒä¸­æ–‡å¯¹è¯';
      }
      
      if (featuresEl && modelInfo.features && Array.isArray(modelInfo.features)) {
        featuresEl.innerHTML = modelInfo.features.map(f => `â€¢ ${f}`).join('<br>');
      } else if (featuresEl) {
        featuresEl.innerHTML = 'â€¢ å®Œå…¨å…è´¹ä½¿ç”¨<br>â€¢ æ”¯æŒä¸­æ–‡å¯¹è¯<br>â€¢ é«˜æ€§èƒ½å“åº”';
      }
    }
    
    // ==========================================
    // ğŸ•Šï¸ Evo æ™ºèƒ½åŠ©æ‰‹åŠŸèƒ½
    // ==========================================
    
    const EvoAssistant = (function() {
      const CHAT_HISTORY_KEY = 'evo_chat_history';
      const USED_GREETINGS_KEY = 'evo_used_greetings_admin';
      
      // æ¬¢è¿æ¶ˆæ¯åç¼€é€‰é¡¹ï¼ˆé’ˆå¯¹æ™ºèƒ½ç®¡ç†ï¼‰
      const GREETING_SUFFIXES = [
        'ç®¡ç†å…¬å‘Š',
        'æŸ¥çœ‹ç»Ÿè®¡æ•°æ®',
        'ç®¡ç†ç³»ç»Ÿè®¾ç½®',
        'é…ç½®æ™ºèƒ½åŠ©æ‰‹',
        'åˆ†æç”¨æˆ·æ•°æ®',
        'ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½',
        'æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—',
        'ç®¡ç†æƒé™è®¾ç½®',
        'ç”Ÿæˆæ•°æ®æŠ¥è¡¨',
        'ç›‘æ§ç³»ç»ŸçŠ¶æ€',
        'é…ç½®APIæ¥å£',
        'ç®¡ç†æ•°æ®å¤‡ä»½',
        'ä¼˜åŒ–æ•°æ®åº“',
        'æŸ¥çœ‹ç³»ç»Ÿåˆ†æ',
        'ç®¡ç†åŠŸèƒ½æ¨¡å—'
      ];
      
      let isExpanded = false;
      let activeTab = 'chat';
      let messages = [];
      let isTyping = false;
      let hasShownGreetingThisPageLoad = false;
      let assistantEl, iconButton, dialog, messagesContainer, inputField, sendBtn;
      
      function init() {
        try {
          createHTML();
          bindEvents();
          ensureIconVisible();
          setTimeout(() => ensureIconVisible(), 100);
          setTimeout(() => ensureIconVisible(), 500);
          
          // å»¶è¿Ÿæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
          hasShownGreetingThisPageLoad = false;
          setTimeout(() => {
            showWelcomeGreeting();
          }, 1500);
          setTimeout(() => {
            const existingBubble = document.getElementById('evoWelcomeBubble');
            if (!existingBubble) {
              showWelcomeGreeting();
            }
          }, 3000);
        } catch (error) {
          console.error('Evoåˆå§‹åŒ–é”™è¯¯:', error);
        }
      }
      
      function ensureIconVisible() {
        try {
          let assistant = document.getElementById('evoAssistant');
          if (!assistant) {
            createHTML();
            assistant = document.getElementById('evoAssistant');
          }
          if (assistant) {
            assistant.style.cssText = `
              position: fixed !important;
              bottom: 80px !important;
              right: 20px !important;
              z-index: 99999 !important;
              display: block !important;
              visibility: visible !important;
              opacity: 1 !important;
              pointer-events: auto !important;
            `;
            assistantEl = assistant;
          }
        } catch (error) {
          console.error('ensureIconVisibleé”™è¯¯:', error);
        }
      }
      
      function createHTML() {
        const existing = document.getElementById('evoAssistant');
        if (existing) existing.remove();
        
        const html = `
          <div class="evo-assistant" id="evoAssistant">
            <div class="evo-icon-button" id="evoIconButton">
              <div class="evo-pigeon-icon">
                <span class="evo-icon">ğŸ•Šï¸</span>
                <div class="evo-pulse"></div>
              </div>
            </div>
            
            <div class="evo-dialog" id="evoDialog" style="display: none;">
              <div class="evo-header">
                <div class="evo-header-left">
                  <span class="evo-icon-large">ğŸ•Šï¸</span>
                  <div>
                    <h3 class="evo-title">Evo æ™ºèƒ½åŠ©æ‰‹</h3>
                    <p class="evo-subtitle" id="evoStatus">å‡†å¤‡å¥½ä¸ºæ‚¨æœåŠ¡</p>
                  </div>
                </div>
                <button class="evo-close-btn" id="evoCloseBtn">Ã—</button>
              </div>
              
              <div class="evo-content">
                <div class="evo-tabs">
                  <div class="evo-tab-headers">
                    <div class="evo-tab-header active" data-tab="chat">ğŸ’¬ å¯¹è¯</div>
                    <div class="evo-tab-header" data-tab="analytics">ğŸ“Š æ•°æ®</div>
                    <div class="evo-tab-header" data-tab="recommendations">âœ¨ æ¨è</div>
                  </div>
                  
                  <div class="evo-tab-content active" id="tabChat">
                    <div class="evo-chat-container">
                      <div class="evo-messages" id="evoMessages"></div>
                      <div class="evo-input-area">
                        <div class="evo-input-group">
                          <input type="text" class="evo-input" id="evoInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜...">
                          <button class="evo-send-btn" id="evoSendBtn">å‘é€</button>
                        </div>
                        <div class="evo-quick-actions">
                          <button class="evo-quick-action-btn" data-action="stats">æŸ¥çœ‹ç»Ÿè®¡æ•°æ®</button>
                          <button class="evo-quick-action-btn" data-action="help">å¸®åŠ©</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="evo-tab-content" id="tabAnalytics">
                    <div class="evo-analytics" id="evoAnalytics">
                      <div class="evo-empty">æš‚æ— åˆ†ææŠ¥å‘Š</div>
                    </div>
                  </div>
                  
                  <div class="evo-tab-content" id="tabRecommendations">
                    <div class="evo-recommendations" id="evoRecommendations">
                      <div class="evo-empty">æš‚æ— æ¨èå†…å®¹</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', html);
        
        assistantEl = document.getElementById('evoAssistant');
        iconButton = document.getElementById('evoIconButton');
        dialog = document.getElementById('evoDialog');
        messagesContainer = document.getElementById('evoMessages');
        inputField = document.getElementById('evoInput');
        sendBtn = document.getElementById('evoSendBtn');
        
        if (assistantEl) {
          assistantEl.style.cssText = `
            position: fixed !important;
            bottom: 80px !important;
            right: 20px !important;
            z-index: 99999 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
          `;
        }
      }
      
      function bindEvents() {
        if (!iconButton) return;
        
        iconButton.addEventListener('click', toggleExpanded);
        const closeBtn = document.getElementById('evoCloseBtn');
        if (closeBtn) {
          closeBtn.addEventListener('click', toggleExpanded);
        }
        
        if (sendBtn) sendBtn.addEventListener('click', sendMessage);
        if (inputField) {
          inputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isTyping) {
              sendMessage();
            }
          });
        }
        
        document.querySelectorAll('.evo-tab-header').forEach(header => {
          header.addEventListener('click', () => {
            const tab = header.dataset.tab;
            switchTab(tab);
          });
        });
        
        document.querySelectorAll('.evo-quick-action-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const action = btn.dataset.action;
            if (action === 'stats') {
              inputField.value = 'æŸ¥çœ‹ç»Ÿè®¡æ•°æ®';
              sendMessage();
            } else if (action === 'help') {
              inputField.value = 'å¸®åŠ©';
              sendMessage();
            }
          });
        });
      }
      
      function toggleExpanded() {
        isExpanded = !isExpanded;
        if (dialog) {
          dialog.style.display = isExpanded ? 'flex' : 'none';
        }
        if (isExpanded) {
          loadHistory();
        }
      }
      
      function switchTab(tab) {
        activeTab = tab;
        document.querySelectorAll('.evo-tab-header').forEach(h => {
          h.classList.toggle('active', h.dataset.tab === tab);
        });
        document.querySelectorAll('.evo-tab-content').forEach(c => {
          c.classList.toggle('active', c.id === `tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
        });
      }
      
      async function sendMessage() {
        const text = inputField.value.trim();
        if (!text || isTyping) return;
        
        addMessage('user', text);
        inputField.value = '';
        
        isTyping = true;
        updateStatus('æ­£åœ¨æ€è€ƒ...');
        
        try {
          const response = await chat(text);
          addMessage('evo', response.text);
          saveHistory();
        } catch (error) {
          addMessage('evo', 'æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å“åº”ï¼Œè¯·ç¨åå†è¯•ã€‚');
        } finally {
          isTyping = false;
          updateStatus('åœ¨çº¿');
        }
      }
      
      // è·å–tokenå‡½æ•°
      function getAuthToken() {
        // ä¼˜å…ˆä½¿ç”¨adminTokenï¼ˆæ™ºèƒ½ç®¡ç†ç³»ç»Ÿä½¿ç”¨çš„tokenï¼‰
        const adminToken = localStorage.getItem('adminToken');
        if (adminToken) {
          return adminToken;
        }
        // å¦‚æœæ²¡æœ‰adminTokenï¼Œå°è¯•ä½¿ç”¨tokenï¼ˆä¸»ç«™ä½¿ç”¨çš„tokenï¼‰
        return localStorage.getItem('token');
      }
      
      // è°ƒç”¨åç«¯AI API
      async function chatWithBackendAPI(question, history = [], context = {}) {
        try {
          // ä½¿ç”¨ç»Ÿä¸€çš„getApiUrlå‡½æ•°
          const apiBaseUrl = getApiUrl();
          
          const token = getAuthToken();
          if (!token) {
            console.warn('âŒ æœªæ‰¾åˆ°tokenï¼Œæ— æ³•è°ƒç”¨åç«¯APIã€‚è¯·å…ˆç™»å½•ï¼');
            return null;
          }
          
          console.log(`ğŸ”„ æ­£åœ¨è°ƒç”¨åç«¯AI API...`);
          console.log(`ğŸ“¡ APIåœ°å€: ${apiBaseUrl}/evo/chat`);
          console.log(`ğŸ“ é—®é¢˜: ${question.substring(0, 50)}...`);
          
          const startTime = Date.now();
          const response = await fetch(`${apiBaseUrl}/evo/chat`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              question: question,
              history: history,
              context: context
            })
          });
          
          const responseTime = Date.now() - startTime;
          console.log(`â±ï¸ å“åº”æ—¶é—´: ${responseTime}ms`);
          
          if (response.ok) {
            const data = await response.json();
            console.log('ğŸ“¥ APIå“åº”æ•°æ®:', data);
            
            if (data.success && data.data) {
              const responseText = data.data.text || data.data.response;
              if (responseText && responseText.length > 10) {
                console.log(`âœ… AI APIè°ƒç”¨æˆåŠŸï¼`);
                console.log(`ğŸ“Š å›å¤é•¿åº¦: ${responseText.length} å­—ç¬¦`);
                console.log(`ğŸ¤– ä½¿ç”¨æ¨¡å‹: ${data.data.model || 'æœªçŸ¥'}`);
                console.log(`ğŸ¢ æœåŠ¡æä¾›å•†: ${data.data.provider || 'æœªçŸ¥'}`);
                console.log(`ğŸ’¬ å›å¤é¢„è§ˆ: ${responseText.substring(0, 100)}...`);
                
                return { 
                  text: responseText, 
                  data: data.data,
                  modelInfo: data.modelInfo || null
                };
              } else {
                console.warn('âš ï¸ AIå›å¤ä¸ºç©ºæˆ–å¤ªçŸ­ï¼Œé•¿åº¦:', responseText?.length || 0);
              }
            } else {
              console.warn('âš ï¸ APIè¿”å›success=false:', data);
            }
          } else {
            const errorData = await response.json().catch(() => ({}));
            console.error('âŒ åç«¯AI APIå“åº”é”™è¯¯:', response.status);
            console.error('âŒ é”™è¯¯è¯¦æƒ…:', errorData);
            
            if (response.status === 401) {
              console.error('âŒ è®¤è¯å¤±è´¥ï¼è¯·é‡æ–°ç™»å½•ï¼');
              alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ï¼');
            } else if (response.status === 500) {
              console.error('âŒ æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼');
            } else if (response.status === 404) {
              console.error('âŒ APIæ¥å£ä¸å­˜åœ¨ï¼è¯·æ£€æŸ¥åç«¯æœåŠ¡ï¼');
            }
          }
        } catch (error) {
          console.error('âŒ Backend AI APIè°ƒç”¨å¼‚å¸¸:', error);
          console.error('âŒ é”™è¯¯ç±»å‹:', error.name);
          console.error('âŒ é”™è¯¯æ¶ˆæ¯:', error.message);
          
          if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            console.error('âŒ ç½‘ç»œé”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ï¼');
            console.error('ğŸ’¡ è¯·ç¡®è®¤ï¼š1) åç«¯æœåŠ¡å·²å¯åŠ¨ 2) æœåŠ¡åœ°å€æ­£ç¡® 3) ç½‘ç»œè¿æ¥æ­£å¸¸');
          }
        }
        
        return null;
      }
      
      async function chat(question) {
        console.log('ğŸ’¬ æ”¶åˆ°ç”¨æˆ·é—®é¢˜:', question);
        
        // è·å–å¯¹è¯å†å²
        const history = messages.map(msg => ({
          type: msg.type,
          text: msg.text,
          time: msg.time
        }));
        
        // è·å–ä¸Šä¸‹æ–‡æ•°æ®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        const context = {};
        
        // ä¼˜å…ˆçº§1ï¼šå°è¯•ä½¿ç”¨åç«¯AI APIï¼ˆå¿…é¡»ä¼˜å…ˆä½¿ç”¨AIï¼‰
        try {
          console.log('ğŸ”„ æ­£åœ¨è°ƒç”¨åç«¯AI API...');
          const apiResponse = await chatWithBackendAPI(question, history, context);
          
          if (apiResponse && apiResponse.text && apiResponse.text.length > 10) {
            console.log('âœ… AI APIè°ƒç”¨æˆåŠŸï¼Œè¿”å›æ™ºèƒ½AIå›å¤');
            return apiResponse;
          } else {
            console.warn('âš ï¸ AI APIè¿”å›çš„å›å¤ä¸ºç©ºæˆ–å¤ªçŸ­');
            console.warn('âš ï¸ å›å¤å†…å®¹:', apiResponse?.text || '(ç©º)');
            console.warn('âš ï¸ ç»§ç»­å°è¯•å…¶ä»–æ–¹å¼...');
          }
        } catch (error) {
          console.error('âŒ åç«¯AI APIè°ƒç”¨å¤±è´¥:', error);
          console.error('âŒ é”™è¯¯å †æ ˆ:', error.stack);
        }
        
        // å¦‚æœAI APIå¤±è´¥ï¼Œæ˜¾ç¤ºæ˜ç¡®çš„é”™è¯¯æç¤º
        const token = getAuthToken();
        if (!token) {
          return { 
            text: 'âŒ æ— æ³•ä½¿ç”¨AIåŠŸèƒ½ï¼šæ‚¨å°šæœªç™»å½•ã€‚\n\nè¯·å…ˆç™»å½•ç³»ç»Ÿï¼Œç„¶åæ‰èƒ½ä½¿ç”¨AIåŠ©æ‰‹åŠŸèƒ½ã€‚\n\nç™»å½•åï¼ŒAIåŠ©æ‰‹å°†ä¸ºæ‚¨æä¾›æ™ºèƒ½å›å¤ã€‚' 
          };
        }
        
        // æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯è¾¾
        try {
          const healthCheck = await fetch(`${getApiUrl()}/health`).catch(() => null);
          if (!healthCheck || !healthCheck.ok) {
            return { 
              text: 'âŒ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ã€‚\n\nè¯·ç¡®è®¤ï¼š\n1. åç«¯æœåŠ¡å·²å¯åŠ¨ï¼ˆè¿è¡Œ npm startï¼‰\n2. æœåŠ¡åœ°å€æ­£ç¡®ï¼ˆhttp://localhost:3000ï¼‰\n3. ç½‘ç»œè¿æ¥æ­£å¸¸\n\nè¿æ¥æˆåŠŸåï¼ŒAIåŠ©æ‰‹å°†æ­£å¸¸å·¥ä½œã€‚' 
            };
          }
        } catch (e) {
          return { 
            text: 'âŒ åç«¯æœåŠ¡è¿æ¥å¤±è´¥ã€‚\n\nè¯·æ£€æŸ¥ï¼š\n1. åç«¯æœåŠ¡æ˜¯å¦å·²å¯åŠ¨\n2. æœåŠ¡åœ°å€æ˜¯å¦æ­£ç¡®\n3. é˜²ç«å¢™è®¾ç½®\n\nä¿®å¤åï¼ŒAIåŠ©æ‰‹å°†è‡ªåŠ¨æ¢å¤ã€‚' 
          };
        }
        
        // å¦‚æœåç«¯æœåŠ¡æ­£å¸¸ä½†AIè°ƒç”¨å¤±è´¥ï¼Œæ˜¾ç¤ºæç¤º
        return { 
          text: `âš ï¸ AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ã€‚\n\né—®é¢˜ï¼š"${question}"\n\nå¯èƒ½çš„åŸå› ï¼š\n1. AI APIé…ç½®é—®é¢˜\n2. API Keyæ— æ•ˆæˆ–è¿‡æœŸ\n3. ç½‘ç»œè¿æ¥é—®é¢˜\n\nè¯·æ£€æŸ¥ï¼š\nâ€¢ æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯\nâ€¢ åç«¯æ—¥å¿—æ–‡ä»¶\nâ€¢ API Keyé…ç½®\n\nä¿®å¤åï¼ŒAIåŠ©æ‰‹å°†è‡ªåŠ¨æ¢å¤æ™ºèƒ½å›å¤åŠŸèƒ½ã€‚` 
        };
      }
      
      function addMessage(type, text) {
        const message = { type, text, time: new Date() };
        messages.push(message);
        renderMessages();
      }
      
      function renderMessages() {
        if (!messagesContainer) return;
        
        messagesContainer.innerHTML = messages.map(msg => {
          const timeStr = formatTime(msg.time);
          if (msg.type === 'user') {
            return `
              <div class="evo-message user">
                <div class="evo-message-avatar">ğŸ‘¤</div>
                <div class="evo-message-content">
                  <div class="evo-message-text">${formatMessage(msg.text)}</div>
                  <div class="evo-message-time">${timeStr}</div>
                </div>
              </div>
            `;
          } else {
            return `
              <div class="evo-message evo">
                <div class="evo-message-avatar">ğŸ•Šï¸</div>
                <div class="evo-message-content">
                  <div class="evo-message-text">${formatMessage(msg.text)}</div>
                  <div class="evo-message-time">${timeStr}</div>
                </div>
              </div>
            `;
          }
        }).join('');
        
        if (isTyping) {
          messagesContainer.innerHTML += `
            <div class="evo-message evo">
              <div class="evo-message-avatar">ğŸ•Šï¸</div>
              <div class="evo-message-content">
                <div class="evo-typing-indicator">
                  <span></span><span></span><span></span>
                </div>
              </div>
            </div>
          `;
        }
        
        scrollToBottom();
      }
      
      function formatMessage(text) {
        return text.replace(/\n/g, '<br>');
      }
      
      function formatTime(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        if (minutes < 1) return 'åˆšåˆš';
        if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
        return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      }
      
      function scrollToBottom() {
        if (messagesContainer) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }
      
      function updateStatus(status) {
        const statusEl = document.getElementById('evoStatus');
        if (statusEl) {
          statusEl.textContent = status;
        }
      }
      
      function saveHistory() {
        try {
          localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(messages));
        } catch (error) {
          console.error('Failed to save chat history:', error);
        }
      }
      
      function loadHistory() {
        try {
          const history = localStorage.getItem(CHAT_HISTORY_KEY);
          if (history) {
            messages = JSON.parse(history).map(msg => ({
              ...msg,
              time: new Date(msg.time)
            }));
            renderMessages();
          }
        } catch (error) {
          console.error('Failed to load chat history:', error);
        }
      }
      
      // è·å–æœªä½¿ç”¨çš„æ¬¢è¿æ¶ˆæ¯åç¼€
      function getUnusedGreetingSuffix() {
        try {
          const used = JSON.parse(localStorage.getItem(USED_GREETINGS_KEY) || '[]');
          const available = GREETING_SUFFIXES.filter(suffix => !used.includes(suffix));
          
          if (available.length === 0) {
            localStorage.setItem(USED_GREETINGS_KEY, '[]');
            return GREETING_SUFFIXES[Math.floor(Math.random() * GREETING_SUFFIXES.length)];
          }
          
          const selected = available[Math.floor(Math.random() * available.length)];
          used.push(selected);
          localStorage.setItem(USED_GREETINGS_KEY, JSON.stringify(used));
          
          return selected;
        } catch (error) {
          console.error('è·å–æ¬¢è¿æ¶ˆæ¯å¤±è´¥:', error);
          return GREETING_SUFFIXES[0];
        }
      }
      
      // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯æ°”æ³¡å¼¹çª—
      function showWelcomeGreeting() {
        const existingBubble = document.getElementById('evoWelcomeBubble');
        if (existingBubble) {
          return;
        }
        
        hasShownGreetingThisPageLoad = true;
        
        try {
          if (!document.body) {
            setTimeout(showWelcomeGreeting, 500);
            return;
          }
          
          const suffix = getUnusedGreetingSuffix();
          const greeting = `ä½ å¥½ï¼Œæˆ‘æ˜¯Evoï¼Œæˆ‘å¯ä»¥å¸®ä½ ${suffix}ã€‚`;
          
          const bubble = document.createElement('div');
          bubble.id = 'evoWelcomeBubble';
          bubble.className = 'evo-welcome-bubble';
          
          bubble.style.position = 'fixed';
          bubble.style.bottom = '160px';
          bubble.style.right = '100px';
          bubble.style.zIndex = '99998';
          bubble.style.maxWidth = '280px';
          bubble.style.pointerEvents = 'auto';
          bubble.style.display = 'block';
          bubble.style.visibility = 'visible';
          bubble.style.opacity = '1';
          
          const bubbleContent = document.createElement('div');
          bubbleContent.className = 'evo-welcome-bubble-content';
          bubbleContent.textContent = greeting;
          
          bubbleContent.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          bubbleContent.style.color = '#fff';
          bubbleContent.style.padding = '12px 16px';
          bubbleContent.style.borderRadius = '8px';
          bubbleContent.style.fontSize = '14px';
          bubbleContent.style.lineHeight = '1.5';
          bubbleContent.style.boxShadow = '0 4px 20px rgba(102, 126, 234, 0.4), 0 0 30px rgba(118, 75, 162, 0.3)';
          bubbleContent.style.position = 'relative';
          bubbleContent.style.wordWrap = 'break-word';
          bubbleContent.style.cursor = 'pointer';
          bubbleContent.style.fontWeight = '500';
          
          bubbleContent.addEventListener('click', () => {
            hideWelcomeBubble();
            if (!dialog) {
              dialog = document.getElementById('evoDialog');
            }
            if (dialog) {
              isExpanded = true;
              dialog.style.display = 'flex';
              activeTab = 'chat';
              switchTab('chat');
              
              if (!messagesContainer) {
                messagesContainer = document.getElementById('evoMessages');
              }
              if (messagesContainer) {
                messages = [];
                messagesContainer.innerHTML = '';
                addMessage('evo', greeting);
                saveHistory();
                setTimeout(() => scrollToBottom(), 100);
              }
            }
          });
          
          bubble.appendChild(bubbleContent);
          document.body.appendChild(bubble);
          
          setTimeout(() => {
            const checkBubble = document.getElementById('evoWelcomeBubble');
            if (checkBubble) {
              const rect = checkBubble.getBoundingClientRect();
              const checkComputedStyle = window.getComputedStyle(checkBubble);
              if (rect.width === 0 || rect.height === 0 || checkComputedStyle.display === 'none' || checkComputedStyle.visibility === 'hidden') {
                checkBubble.style.cssText = `
                  position: fixed !important;
                  bottom: 160px !important;
                  right: 100px !important;
                  z-index: 99998 !important;
                  max-width: 280px !important;
                  display: block !important;
                  visibility: visible !important;
                  opacity: 1 !important;
                `;
              }
            }
          }, 100);
          
          setTimeout(() => {
            hideWelcomeBubble();
          }, 3000);
          
        } catch (error) {
          console.error('æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯å¤±è´¥:', error);
        }
      }
      
      // éšè—æ¬¢è¿æ¶ˆæ¯æ°”æ³¡
      function hideWelcomeBubble() {
        const bubble = document.getElementById('evoWelcomeBubble');
        if (bubble) {
          bubble.classList.add('hiding');
          setTimeout(() => {
            if (bubble.parentNode) {
              bubble.remove();
            }
          }, 300);
        }
      }
      
      return {
        init,
        ensureIconVisible
      };
    })();
    
    // åˆå§‹åŒ–EvoåŠ©æ‰‹ï¼ˆåœ¨ç™»å½•åï¼‰
    function initEvoAssistant() {
      setTimeout(() => {
        try {
          EvoAssistant.init();
          console.log('âœ… Evo æ™ºèƒ½åŠ©æ‰‹å·²åˆå§‹åŒ–');
          
          setTimeout(() => {
            EvoAssistant.ensureIconVisible();
          }, 500);
        } catch (error) {
          console.error('âš ï¸ æ™ºèƒ½åŠ©æ‰‹åˆå§‹åŒ–å¤±è´¥:', error);
        }
      }, 500);
    }
    
    // ========================================
    // æ™ºé¸½Â·ä¸­æ¢ç®¡å®¶åŠŸèƒ½
    // ========================================
    
    const CORE_ADMIN_API_BASE = 'http://localhost:3001/api';
    
    // åŠ è½½ä¸­æ¢ç®¡å®¶æ•°æ®
    async function loadCoreAdminData() {
      try {
        // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®ï¼Œå³ä½¿éƒ¨åˆ†å¤±è´¥ä¹Ÿèƒ½æ˜¾ç¤ºå…¶ä»–å†…å®¹
        await Promise.allSettled([
          loadCoreAdminStatus(),
          loadCoreAdminModelInfo(),
          loadCoreAdminAdvice(),
          loadCoreAdminAnalytics(),
          loadCoreAdminApis(),
          loadCoreAdminLearning(),
          loadCoreAdminMaintenance()
        ]);
      } catch (error) {
        console.error('åŠ è½½ä¸­æ¢ç®¡å®¶æ•°æ®å¤±è´¥:', error);
      }
    }
    
    // åŠ è½½ç³»ç»ŸçŠ¶æ€
    async function loadCoreAdminStatus() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/status`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const result = await response.json();
        
        if (result.success && result.data) {
          const status = result.data;
          const healthScore = (status.metrics?.systemHealth || 0) * 100;
          
          document.getElementById('coreAdminHealthScore').textContent = healthScore.toFixed(0) + '%';
          document.getElementById('coreAdminHealthStatus').textContent = 
            status.metrics?.riskLevel === 'low' ? 'âœ… è¿è¡Œæ­£å¸¸' :
            status.metrics?.riskLevel === 'medium' ? 'âš ï¸ éœ€è¦æ³¨æ„' :
            status.metrics?.riskLevel === 'high' ? 'ğŸ”´ é£é™©è¾ƒé«˜' : 'æ£€æŸ¥ä¸­...';
        } else {
          throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
        }
      } catch (error) {
        console.error('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
        document.getElementById('coreAdminHealthScore').textContent = '--';
        document.getElementById('coreAdminHealthStatus').textContent = 'âš ï¸ æœåŠ¡æœªè¿è¡Œ';
        document.getElementById('coreAdminHealthStatus').style.color = '#f59e0b';
      }
    }
    
    // åŠ è½½æ¨¡å‹æ¥å…¥ä¿¡æ¯
    async function loadCoreAdminModelInfo() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/model/config`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const result = await response.json();
        
        if (result.success && result.data) {
          const modelInfo = result.data;
          
          // æ›´æ–°åŸºæœ¬ä¿¡æ¯
          document.getElementById('coreAdminModelProvider').textContent = modelInfo.provider || 'æœªçŸ¥';
          document.getElementById('coreAdminModelName').textContent = modelInfo.model || 'æœªçŸ¥';
          document.getElementById('coreAdminApiKeyPreview').textContent = modelInfo.apiKeyPreview || '--';
          document.getElementById('coreAdminApiBase').textContent = modelInfo.apiBase || '--';
          document.getElementById('coreAdminMaxCalls').textContent = modelInfo.maxCallsPerHour || '--';
          document.getElementById('coreAdminConfidence').textContent = (modelInfo.confidenceThreshold * 100).toFixed(0) + '%' || '--';
          
          // æ›´æ–°API KeyçŠ¶æ€
          const apiKeyStatusEl = document.getElementById('coreAdminApiKeyStatus');
          if (modelInfo.apiKeyStatus === 'configured') {
            apiKeyStatusEl.textContent = 'âœ… å·²é…ç½®';
            apiKeyStatusEl.style.background = 'rgba(76, 175, 80, 0.3)';
            apiKeyStatusEl.style.color = '#2e7d32';
          } else {
            apiKeyStatusEl.textContent = 'âŒ æœªé…ç½®';
            apiKeyStatusEl.style.background = 'rgba(244, 67, 54, 0.3)';
            apiKeyStatusEl.style.color = '#c62828';
          }
          
          // æ›´æ–°è¿æ¥çŠ¶æ€
          const connectionStatusEl = document.getElementById('coreAdminConnectionStatus');
          if (modelInfo.connectionStatus === 'connected' && modelInfo.enabled) {
            connectionStatusEl.textContent = 'âœ… å·²è¿æ¥';
            connectionStatusEl.style.background = 'rgba(76, 175, 80, 0.3)';
            connectionStatusEl.style.color = '#2e7d32';
          } else {
            connectionStatusEl.textContent = 'âŒ æœªè¿æ¥';
            connectionStatusEl.style.background = 'rgba(244, 67, 54, 0.3)';
            connectionStatusEl.style.color = '#c62828';
          }
          
          // æ›´æ–°è°ƒç”¨ç»Ÿè®¡
          if (modelInfo.stats) {
            const stats = modelInfo.stats;
            document.getElementById('coreAdminTotalCalls').textContent = stats.totalCalls || 0;
            document.getElementById('coreAdminRecentCalls').textContent = stats.recentCalls || 0;
            document.getElementById('coreAdminSuccessRate').textContent = (stats.successRate * 100).toFixed(1) + '%';
            document.getElementById('coreAdminAvgConfidence').textContent = (stats.avgConfidence * 100).toFixed(1) + '%';
          }
          
          // æ›´æ–°AIè°ƒç”¨æ¬¡æ•°ï¼ˆåœ¨é¡¶éƒ¨å¡ç‰‡ä¸­ï¼‰
          if (modelInfo.stats) {
            document.getElementById('coreAdminAICalls').textContent = modelInfo.stats.recentCalls || 0;
          }
        } else {
          throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
        }
      } catch (error) {
        console.error('åŠ è½½æ¨¡å‹æ¥å…¥ä¿¡æ¯å¤±è´¥:', error);
        const container = document.getElementById('coreAdminModelInfo');
        container.innerHTML = `
          <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:1px solid #f59e0b;">
            <p style="margin:0 0 12px 0;color:#92400e;font-weight:600;">âš ï¸ ä¸­æ¢ç®¡å®¶æœåŠ¡æœªè¿è¡Œ</p>
            <p style="margin:0;color:#78350f;font-size:14px;">è¯·å¯åŠ¨åç«¯æœåŠ¡ï¼š<code style="background:#fde68a;padding:2px 6px;border-radius:4px;">cd backend/core-admin && npm start</code></p>
          </div>
        `;
      }
    }
    
    // åŠ è½½ç®¡ç†å»ºè®®
    async function loadCoreAdminAdvice() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/advice`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const result = await response.json();
        
        if (result.success && result.data) {
          const advice = result.data.advice || {};
          const container = document.getElementById('coreAdminAdvice');
          
          let html = '';
          if (advice.summary) {
            html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;margin-bottom:12px;">`;
            html += `<div style="font-weight:600;margin-bottom:8px;color:#1f2937;">${advice.summary}</div>`;
            if (advice.actions && advice.actions.length > 0) {
              html += `<ul style="margin:8px 0;padding-left:20px;">`;
              advice.actions.forEach(action => {
                html += `<li style="margin:4px 0;color:#4b5563;">${action}</li>`;
              });
              html += `</ul>`;
            }
            html += `</div>`;
          } else {
            html = '<p class="muted" style="text-align:center;">æš‚æ— å»ºè®®</p>';
          }
          
          container.innerHTML = html;
        } else {
          throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
        }
      } catch (error) {
        console.error('åŠ è½½ç®¡ç†å»ºè®®å¤±è´¥:', error);
        const container = document.getElementById('coreAdminAdvice');
        container.innerHTML = `
          <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:1px solid #f59e0b;">
            <p style="margin:0 0 12px 0;color:#92400e;font-weight:600;">âš ï¸ ä¸­æ¢ç®¡å®¶æœåŠ¡æœªè¿è¡Œ</p>
            <p style="margin:0;color:#78350f;font-size:14px;">è¯·å¯åŠ¨åç«¯æœåŠ¡ï¼š<code style="background:#fde68a;padding:2px 6px;border-radius:4px;">cd backend/core-admin && npm start</code></p>
          </div>
        `;
      }
    }
    
    // åŠ è½½æ•°æ®åˆ†æ
    async function loadCoreAdminAnalytics() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/analytics/report`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const report = result.data;
          const container = document.getElementById('coreAdminAnalytics');
          
          let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:20px;">';
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">æ€»ç‚¹å‡»é‡</div>`;
          html += `<div style="font-size:24px;font-weight:600;color:#1f2937;">${report.clicks?.total || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">æ•°æ®ä¸Šä¼ </div>`;
          html += `<div style="font-size:24px;font-weight:600;color:#1f2937;">${report.uploads?.total || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ç”¨æˆ·è¡Œä¸º</div>`;
          html += `<div style="font-size:24px;font-weight:600;color:#1f2937;">${report.userBehaviors?.total || 0}</div>`;
          html += `</div>`;
          
          html += `</div>`;
          
          if (report.apiUsage?.topEndpoints && report.apiUsage.topEndpoints.length > 0) {
            html += `<div style="margin-top:20px;"><h4 style="margin-bottom:12px;">çƒ­é—¨API</h4>`;
            html += `<table style="width:100%;border-collapse:collapse;">`;
            html += `<thead><tr style="background:#f9fafb;"><th style="padding:8px;text-align:left;">ç«¯ç‚¹</th><th style="padding:8px;text-align:center;">è°ƒç”¨æ¬¡æ•°</th><th style="padding:8px;text-align:center;">æˆåŠŸç‡</th></tr></thead><tbody>`;
            report.apiUsage.topEndpoints.slice(0, 5).forEach(api => {
              html += `<tr><td style="padding:8px;">${api.endpoint}</td>`;
              html += `<td style="padding:8px;text-align:center;">${api.calls}</td>`;
              html += `<td style="padding:8px;text-align:center;">${(api.successRate * 100).toFixed(1)}%</td></tr>`;
            });
            html += `</tbody></table></div>`;
          }
          
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('åŠ è½½æ•°æ®åˆ†æå¤±è´¥:', error);
        const container = document.getElementById('coreAdminAnalytics');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">æ•°æ®åˆ†ææœåŠ¡æš‚ä¸å¯ç”¨</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ</p>
          </div>
        `;
      }
    }
    
    // åŠ è½½APIåˆ—è¡¨
    async function loadCoreAdminApis() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/apis`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const apis = result.data;
          const container = document.getElementById('coreAdminApiList');
          
          if (apis.length === 0) {
            container.innerHTML = '<p class="muted" style="text-align:center;">æš‚æ— API</p>';
            return;
          }
          
          let html = '<table style="width:100%;border-collapse:collapse;">';
          html += '<thead><tr style="background:#f9fafb;">';
          html += '<th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">APIåç§°</th>';
          html += '<th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">çŠ¶æ€</th>';
          html += '<th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">å“åº”æ—¶é—´</th>';
          html += '<th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">æ•°æ®çœŸå®æ€§</th>';
          html += '</tr></thead><tbody>';
          
          apis.forEach(api => {
            const statusColor = api.health.status === 'healthy' ? '#10b981' : '#ef4444';
            const statusText = api.health.status === 'healthy' ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸';
            const truthStatus = api.health.truthStatus || 'unknown';
            const truthColor = truthStatus === 'verified' ? '#10b981' : truthStatus === 'suspect' ? '#f59e0b' : '#ef4444';
            const truthText = truthStatus === 'verified' ? 'âœ… å·²éªŒè¯' : truthStatus === 'suspect' ? 'âš ï¸ å¯ç–‘' : 'âŒ æ— æ•ˆ';
            
            html += `<tr style="border-bottom:1px solid #f0f0f0;">`;
            html += `<td style="padding:12px;"><strong>${api.name}</strong><br><span style="color:#6b7280;font-size:12px;">${api.url}</span></td>`;
            html += `<td style="padding:12px;text-align:center;"><span style="color:${statusColor};font-weight:600;">${statusText}</span></td>`;
            html += `<td style="padding:12px;text-align:center;">${api.stats.avgResponseTime.toFixed(0)}ms</td>`;
            html += `<td style="padding:12px;text-align:center;"><span style="color:${truthColor};font-weight:600;">${truthText}</span></td>`;
            html += `</tr>`;
          });
          
          html += '</tbody></table>';
          container.innerHTML = html;
          
          // æ›´æ–°APIå¥åº·ç‡
          const healthyCount = apis.filter(a => a.health.status === 'healthy').length;
          const healthRate = apis.length > 0 ? (healthyCount / apis.length * 100) : 0;
          document.getElementById('coreAdminApiHealth').textContent = healthRate.toFixed(0) + '%';
        }
      } catch (error) {
        console.error('åŠ è½½APIåˆ—è¡¨å¤±è´¥:', error);
        const container = document.getElementById('coreAdminApiList');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">APIç›‘ç®¡æœåŠ¡æš‚ä¸å¯ç”¨</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ</p>
          </div>
        `;
      }
    }
    
    // åŠ è½½å­¦ä¹ ç³»ç»Ÿ
    async function loadCoreAdminLearning() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/learning/stats`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const stats = result.data;
          const container = document.getElementById('coreAdminLearning');
          
          let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">';
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">æ€»äº‹ä»¶æ•°</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalEvents || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ç­–ç•¥æ•°</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalStrategies || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">å†³ç­–æ•°</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalDecisions || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">å¹³å‡æœ‰æ•ˆæ€§</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${((stats.avgEffectiveness || 0) * 100).toFixed(1)}%</div>`;
          html += `</div>`;
          
          html += `</div>`;
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('åŠ è½½å­¦ä¹ ç³»ç»Ÿå¤±è´¥:', error);
        const container = document.getElementById('coreAdminLearning');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">å­¦ä¹ ç³»ç»ŸæœåŠ¡æš‚ä¸å¯ç”¨</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ</p>
          </div>
        `;
      }
    }
    
    // åŠ è½½è‡ªåŠ¨ç»´æŠ¤
    async function loadCoreAdminMaintenance() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/maintenance/stats`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const stats = result.data;
          const container = document.getElementById('coreAdminMaintenance');
          
          let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">';
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">æ€»Bugæ•°</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalBugs || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">å·²ä¿®å¤</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.fixedBugs || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">æ€»ä¿®å¤æ•°</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalFixes || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ç³»ç»Ÿå‡çº§</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalUpgrades || 0}</div>`;
          html += `</div>`;
          
          html += `</div>`;
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('åŠ è½½è‡ªåŠ¨ç»´æŠ¤å¤±è´¥:', error);
        const container = document.getElementById('coreAdminMaintenance');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">è‡ªåŠ¨ç»´æŠ¤æœåŠ¡æš‚ä¸å¯ç”¨</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ</p>
          </div>
        `;
      }
    }
    
    // ç»‘å®šåˆ·æ–°æŒ‰é’®
    // ==========================================
    // ç³»ç»Ÿè®¾ç½®åŠŸèƒ½
    // ==========================================
    
    let currentRssSourceEditId = null;
    
    // åŠ è½½ç³»ç»Ÿè®¾ç½®
    async function loadSystemSettings() {
      try {
        const token = localStorage.getItem('adminToken');
        if (!token) {
          showSettingsStatus('è¯·å…ˆç™»å½•', 'error');
          return;
        }
        
        const response = await fetch(`${getApiUrl()}/api/admin/system-settings`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const settings = result.data;
          
          // å¡«å……åŸºç¡€è®¾ç½®
          document.getElementById('serverPort').value = settings.server?.port || '';
          document.getElementById('serverEnv').value = settings.server?.env || 'production';
          document.getElementById('apiRateLimit').value = settings.api?.rateLimit || '';
          document.getElementById('logLevel').value = settings.logging?.level || 'info';
          
          // å¡«å……ç¼“å­˜è®¾ç½®
          document.getElementById('cacheTtlNews').value = settings.cache?.ttl?.news || '';
          document.getElementById('cacheTtlEvents').value = settings.cache?.ttl?.events || '';
          document.getElementById('cacheTtlResults').value = settings.cache?.ttl?.results || '';
          document.getElementById('updateIntervalNews').value = settings.updateInterval?.news || '';
          document.getElementById('updateIntervalEvents').value = settings.updateInterval?.events || '';
          document.getElementById('updateIntervalResults').value = settings.updateInterval?.results || '';
          
          // å¡«å……AIè®¾ç½®
          document.getElementById('zhipuApiKeyEvo').value = settings.ai?.zhipuApiKeyEvo || '';
          document.getElementById('zhipuApiKeyAdmin').value = settings.ai?.zhipuApiKeyAdmin || '';
          document.getElementById('qwenApiKey').value = settings.ai?.qwenApiKey || '';
          document.getElementById('huggingFaceApiKey').value = settings.ai?.huggingFaceApiKey || '';
          document.getElementById('aiModel').value = settings.ai?.model || 'auto';
          
          // å¡«å……æ•°æ®åº“è®¾ç½®
          document.getElementById('supabaseUrl').value = settings.supabase?.url || '';
          document.getElementById('supabaseAnonKey').value = settings.supabase?.anonKey || '';
          
          // åŠ è½½RSSæºåˆ—è¡¨
          loadRssSources();
        }
      } catch (error) {
        console.error('åŠ è½½ç³»ç»Ÿè®¾ç½®å¤±è´¥:', error);
        showSettingsStatus('åŠ è½½ç³»ç»Ÿè®¾ç½®å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // åŠ è½½RSSæºåˆ—è¡¨
    async function loadRssSources() {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const sources = result.data;
          const container = document.getElementById('rssSourcesList');
          
          if (sources.length === 0) {
            container.innerHTML = '<p class="muted" style="text-align:center;padding:20px;">æš‚æ— RSSæºï¼Œç‚¹å‡»"æ·»åŠ RSSæº"æŒ‰é’®æ·»åŠ </p>';
            return;
          }
          
          let html = '';
          sources.forEach(source => {
            const statusColor = source.active !== false ? '#10b981' : '#ef4444';
            const statusText = source.active !== false ? 'å¯ç”¨' : 'ç¦ç”¨';
            
            html += `
              <div style="padding:16px;background:var(--bg-secondary);border:1px solid var(--border-light);border-radius:var(--radius-md);">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
                  <div style="flex:1;">
                    <div style="font-weight:600;color:var(--text-primary);margin-bottom:4px;">${source.name}</div>
                    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">${source.url}</div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                      <span style="padding:4px 8px;background:var(--primary-50);color:var(--primary);border-radius:4px;font-size:12px;">${source.type === 'media' ? 'åª’ä½“' : 'åä¼š'}</span>
                      <span style="padding:4px 8px;background:var(--gray-100);color:var(--gray-700);border-radius:4px;font-size:12px;">${source.region === 'local' ? 'æœ¬åœ°' : 'å…¨å›½'}</span>
                      <span style="padding:4px 8px;background:${statusColor}20;color:${statusColor};border-radius:4px;font-size:12px;">${statusText}</span>
                    </div>
                  </div>
                  <div style="display:flex;gap:8px;">
                    <button class="btn btn-sm btn-outline" onclick="editRssSource('${source.id}')">ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-outline" onclick="toggleRssSource('${source.id}', ${source.active !== false})">${source.active !== false ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                    <button class="btn btn-sm btn-outline" style="color:var(--danger);" onclick="deleteRssSource('${source.id}')">åˆ é™¤</button>
                  </div>
                </div>
              </div>
            `;
          });
          
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('åŠ è½½RSSæºåˆ—è¡¨å¤±è´¥:', error);
      }
    }
    
    // ç³»ç»Ÿè®¾ç½®æ ‡ç­¾é¡µåˆ‡æ¢
    document.querySelectorAll('.settings-tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.settings-tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // æ˜¾ç¤ºå¯¹åº”é¢æ¿
        document.querySelectorAll('.settings-panel').forEach(p => p.style.display = 'none');
        document.getElementById(`settings${tab.charAt(0).toUpperCase() + tab.slice(1)}`).style.display = 'block';
      });
    });
    
    // ä¿å­˜åŸºç¡€è®¾ç½®
    document.getElementById('btnSaveGeneralSettings')?.addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('adminToken');
        const settings = {
          custom: {
            server: {
              port: parseInt(document.getElementById('serverPort').value) || 3000,
              env: document.getElementById('serverEnv').value
            },
            api: {
              rateLimit: parseInt(document.getElementById('apiRateLimit').value) || 100
            },
            logging: {
              level: document.getElementById('logLevel').value
            }
          }
        };
        
        const response = await fetch(`${getApiUrl()}/api/admin/system-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ settings })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('åŸºç¡€è®¾ç½®å·²ä¿å­˜ï¼ˆéƒ¨åˆ†é…ç½®éœ€è¦ä¿®æ”¹ç¯å¢ƒå˜é‡åé‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆï¼‰', 'success');
        } else {
          showSettingsStatus('ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        showSettingsStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
      }
    });
    
    // ä¿å­˜ç¼“å­˜è®¾ç½®
    document.getElementById('btnSaveCacheSettings')?.addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('adminToken');
        const settings = {
          custom: {
            cache: {
              ttl: {
                news: parseInt(document.getElementById('cacheTtlNews').value) || 3600,
                events: parseInt(document.getElementById('cacheTtlEvents').value) || 300,
                results: parseInt(document.getElementById('cacheTtlResults').value) || 7200
              }
            },
            updateInterval: {
              news: parseInt(document.getElementById('updateIntervalNews').value) || 3600,
              events: parseInt(document.getElementById('updateIntervalEvents').value) || 300,
              results: parseInt(document.getElementById('updateIntervalResults').value) || 1800
            }
          }
        };
        
        const response = await fetch(`${getApiUrl()}/api/admin/system-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ settings })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('ç¼“å­˜é…ç½®å·²ä¿å­˜ï¼ˆéœ€è¦ä¿®æ”¹ç¯å¢ƒå˜é‡åé‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆï¼‰', 'success');
        } else {
          showSettingsStatus('ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        showSettingsStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
      }
    });
    
    // æ·»åŠ RSSæº
    document.getElementById('btnAddRssSource')?.addEventListener('click', () => {
      currentRssSourceEditId = null;
      document.getElementById('rssSourceForm').style.display = 'block';
      document.getElementById('rssSourceName').value = '';
      document.getElementById('rssSourceUrl').value = '';
      document.getElementById('rssSourceType').value = 'media';
      document.getElementById('rssSourceRegion').value = 'local';
    });
    
    // ä¿å­˜RSSæº
    document.getElementById('btnSaveRssSource')?.addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('adminToken');
        const name = document.getElementById('rssSourceName').value.trim();
        const url = document.getElementById('rssSourceUrl').value.trim();
        const type = document.getElementById('rssSourceType').value;
        const region = document.getElementById('rssSourceRegion').value;
        
        if (!name || !url) {
          showSettingsStatus('è¯·å¡«å†™å®Œæ•´çš„RSSæºä¿¡æ¯', 'error');
          return;
        }
        
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ name, url, type, region })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('RSSæºå·²æ·»åŠ ', 'success');
          document.getElementById('rssSourceForm').style.display = 'none';
          loadRssSources();
        } else {
          showSettingsStatus('æ·»åŠ å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        showSettingsStatus('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
      }
    });
    
    // å–æ¶ˆRSSæºç¼–è¾‘
    document.getElementById('btnCancelRssSource')?.addEventListener('click', () => {
      document.getElementById('rssSourceForm').style.display = 'none';
      currentRssSourceEditId = null;
    });
    
    // æµ‹è¯•RSSæº
    document.getElementById('btnTestRssSource')?.addEventListener('click', async () => {
      const url = document.getElementById('rssSourceUrl').value.trim();
      if (!url) {
        showSettingsStatus('è¯·å…ˆè¾“å…¥RSS URL', 'error');
        return;
      }
      
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources/test`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ url })
        });
        
        const result = await response.json();
        const resultDiv = document.getElementById('rssSourceTestResult');
        
        if (result.success && result.data?.valid) {
          resultDiv.innerHTML = `<div style="padding:12px;background:#d1fae5;color:#047857;border-radius:6px;">âœ… è¿æ¥æˆåŠŸï¼æ‰¾åˆ° ${result.data.itemCount} æ¡å†…å®¹</div>`;
        } else {
          resultDiv.innerHTML = `<div style="padding:12px;background:#fee2e2;color:#991b1b;border-radius:6px;">âŒ è¿æ¥å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
        }
      } catch (error) {
        document.getElementById('rssSourceTestResult').innerHTML = `<div style="padding:12px;background:#fee2e2;color:#991b1b;border-radius:6px;">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
      }
    });
    
    // ç¼–è¾‘RSSæº
    window.editRssSource = async (id) => {
      // TODO: å®ç°ç¼–è¾‘åŠŸèƒ½
      alert('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...');
    };
    
    // åˆ‡æ¢RSSæºçŠ¶æ€
    window.toggleRssSource = async (id, currentStatus) => {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources/${id}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ active: !currentStatus })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('RSSæºçŠ¶æ€å·²æ›´æ–°', 'success');
          loadRssSources();
        } else {
          showSettingsStatus('æ›´æ–°å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        showSettingsStatus('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
      }
    };
    
    // åˆ é™¤RSSæº
    window.deleteRssSource = async (id) => {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªRSSæºå—ï¼Ÿ')) return;
      
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('RSSæºå·²åˆ é™¤', 'success');
          loadRssSources();
        } else {
          showSettingsStatus('åˆ é™¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        showSettingsStatus('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    };
    
    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showSettingsStatus(message, type) {
      const statusDiv = document.getElementById('settingsStatus');
      statusDiv.style.display = 'block';
      statusDiv.style.padding = '12px';
      statusDiv.style.borderRadius = 'var(--radius-md)';
      
      if (type === 'success') {
        statusDiv.style.background = '#d1fae5';
        statusDiv.style.color = '#047857';
      } else {
        statusDiv.style.background = '#fee2e2';
        statusDiv.style.color = '#991b1b';
      }
      
      statusDiv.textContent = message;
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      const btnRefreshModelInfo = document.getElementById('btnRefreshModelInfo');
      const btnRefreshAdvice = document.getElementById('btnRefreshAdvice');
      const btnRefreshAnalytics = document.getElementById('btnRefreshAnalytics');
      const btnRefreshApis = document.getElementById('btnRefreshApis');
      const btnRefreshLearning = document.getElementById('btnRefreshLearning');
      const btnRefreshMaintenance = document.getElementById('btnRefreshMaintenance');
      
      if (btnRefreshModelInfo) {
        btnRefreshModelInfo.addEventListener('click', () => {
          loadCoreAdminModelInfo();
        });
      }
      
      if (btnRefreshAdvice) {
        btnRefreshAdvice.addEventListener('click', () => {
          loadCoreAdminAdvice();
        });
      }
      
      if (btnRefreshAnalytics) {
        btnRefreshAnalytics.addEventListener('click', () => {
          loadCoreAdminAnalytics();
        });
      }
      
      if (btnRefreshApis) {
        btnRefreshApis.addEventListener('click', () => {
          loadCoreAdminApis();
        });
      }
      
      if (btnRefreshLearning) {
        btnRefreshLearning.addEventListener('click', () => {
          loadCoreAdminLearning();
        });
      }
      
      if (btnRefreshMaintenance) {
        btnRefreshMaintenance.addEventListener('click', () => {
          loadCoreAdminMaintenance();
        });
      }
    });
    
    // ç³»ç»Ÿå‡çº§åŠŸèƒ½
    async function loadUpgradeData() {
      const CORE_ADMIN_API_BASE = 'http://localhost:3001/api';
      
      try {
        // åŠ è½½å‡çº§æ¦‚è§ˆ
        const overviewResponse = await fetch(`${CORE_ADMIN_API_BASE}/upgrade/overview`);
        if (overviewResponse.ok) {
          const overviewResult = await overviewResponse.json();
          if (overviewResult.success && overviewResult.data) {
            const overview = overviewResult.data;
            document.getElementById('upgradeVersion').textContent = `v${overview.version}`;
            document.getElementById('upgradePartsCount').textContent = overview.completedCount || '--';
            document.getElementById('upgradeNewFiles').textContent = overview.statistics?.newFiles || '--';
            document.getElementById('upgradeNewCode').textContent = (overview.statistics?.newCodeLines / 1000).toFixed(1) + 'K';
            document.getElementById('upgradeAutomation').textContent = overview.capabilities?.automation || '--';
          }
        }

        // åŠ è½½å‡çº§éƒ¨åˆ†
        const partsResponse = await fetch(`${CORE_ADMIN_API_BASE}/upgrade/parts`);
        if (partsResponse.ok) {
          const partsResult = await partsResponse.json();
          if (partsResult.success && partsResult.data) {
            renderUpgradeParts(partsResult.data);
          }
        }

        // åŠ è½½èƒ½åŠ›æå‡
        const capabilitiesResponse = await fetch(`${CORE_ADMIN_API_BASE}/upgrade/capabilities`);
        if (capabilitiesResponse.ok) {
          const capabilitiesResult = await capabilitiesResponse.json();
          if (capabilitiesResult.success && capabilitiesResult.data) {
            renderCapabilities(capabilitiesResult.data);
          }
        }
      } catch (error) {
        console.error('åŠ è½½å‡çº§æ•°æ®å¤±è´¥:', error);
        document.getElementById('upgradePartsList').innerHTML = `
          <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:1px solid #f59e0b;">
            <p style="margin:0 0 12px 0;color:#92400e;font-weight:600;">âš ï¸ æ— æ³•è¿æ¥åˆ°å‡çº§æœåŠ¡</p>
            <p style="margin:0;color:#78350f;font-size:14px;">è¯·ç¡®ä¿ä¸­æ¢ç®¡å®¶æœåŠ¡æ­£åœ¨è¿è¡Œ</p>
          </div>
        `;
      }
    }

    // æ¸²æŸ“å‡çº§éƒ¨åˆ†
    function renderUpgradeParts(parts) {
      const container = document.getElementById('upgradePartsList');
      
      if (!parts || parts.length === 0) {
        container.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">æš‚æ— å‡çº§è®°å½•</p>';
        return;
      }

      const html = parts.map(part => `
        <div style="background:#f8fafc;border-radius:12px;padding:24px;margin-bottom:16px;border:2px solid #e2e8f0;transition:all 0.3s ease;" 
             onmouseover="this.style.borderColor='#3b82f6';this.style.boxShadow='0 4px 12px rgba(59,130,246,0.15)'" 
             onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
          <div style="display:flex;align-items:start;gap:16px;">
            <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;">
              ${part.id === 'frontend' ? 'ğŸ¨' : part.id === 'security' ? 'ğŸ”’' : part.id === 'database' ? 'ğŸ—„ï¸' : 'ğŸ¤–'}
            </div>
            <div style="flex:1;">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                <h4 style="margin:0;font-size:18px;font-weight:700;color:#1e293b;">${part.name}</h4>
                <span style="background:#10b981;color:#fff;padding:4px 12px;border-radius:6px;font-size:12px;font-weight:600;">âœ… ${part.status === 'completed' ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}</span>
              </div>
              <p style="margin:0 0 16px 0;color:#64748b;font-size:14px;line-height:1.6;">${part.description}</p>
              
              ${part.files && part.files.length > 0 ? `
                <div style="margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;">ç›¸å…³æ–‡ä»¶ï¼š</div>
                  <div style="display:flex;flex-wrap:wrap;gap:8px;">
                    ${part.files.map(file => `
                      <span style="background:#e2e8f0;color:#475569;padding:4px 10px;border-radius:6px;font-size:12px;font-family:monospace;">${file}</span>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              ${part.modules && part.modules.length > 0 ? `
                <div style="margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;">æ–°å¢æ¨¡å—ï¼š</div>
                  <div style="display:flex;flex-wrap:wrap;gap:8px;">
                    ${part.modules.map(module => `
                      <div style="background:#dbeafe;color:#1e40af;padding:6px 12px;border-radius:6px;font-size:12px;display:flex;align-items:center;gap:6px;">
                        <span>ğŸ“¦</span>
                        <span>${module.name}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              ${part.benefits && part.benefits.length > 0 ? `
                <div>
                  <div style="font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;">æ”¶ç›Šï¼š</div>
                  <ul style="margin:0;padding-left:20px;color:#64748b;font-size:13px;">
                    ${part.benefits.map(benefit => `<li style="margin-bottom:4px;">${benefit}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    // æ¸²æŸ“èƒ½åŠ›æå‡
    function renderCapabilities(capabilities) {
      const container = document.getElementById('upgradeCapabilities');
      
      const html = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">
          <div style="background:linear-gradient(135deg, #e6f0ff 0%, #dbeafe 100%);border-radius:12px;padding:20px;border:2px solid rgba(59,130,246,0.2);">
            <div style="font-size:14px;font-weight:600;color:#1e40af;margin-bottom:8px;">è‡ªåŠ¨åŒ–ç‡</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.automation || '--'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);border-radius:12px;padding:20px;border:2px solid rgba(16,185,129,0.2);">
            <div style="font-size:14px;font-weight:600;color:#065f46;margin-bottom:8px;">æ™ºèƒ½åŒ–ç‡</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.intelligence || '--'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border-radius:12px;padding:20px;border:2px solid rgba(245,158,11,0.2);">
            <div style="font-size:14px;font-weight:600;color:#92400e;margin-bottom:8px;">é¢„æµ‹å‡†ç¡®ç‡</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.prediction || '--'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);border-radius:12px;padding:20px;border:2px solid rgba(236,72,153,0.2);">
            <div style="font-size:14px;font-weight:600;color:#9f1239;margin-bottom:8px;">APIå®‰å…¨æ€§</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.security || '--'}</div>
          </div>
        </div>
      `;

      container.innerHTML = html;
    }

    // æ™ºèƒ½åŠŸèƒ½æ¨¡å—åŠ è½½å‡½æ•°ï¼ˆä½¿ç”¨å…¨å±€ CORE_ADMIN_API_BASEï¼‰

    // åŠ è½½æ™ºèƒ½å†³ç­–å»ºè®®
    async function loadIntelligentAdvice() {
      const preview = document.getElementById('intelligentAdvicePreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/advice`);
        const result = await response.json();
        if (result.success && result.data) {
          const advice = result.data;
          preview.innerHTML = `<strong>${advice.title || 'æ™ºèƒ½å»ºè®®'}</strong><br>${advice.description || advice.reason || 'æš‚æ— å»ºè®®'}`;
          // å¯ä»¥æ‰“å¼€è¯¦ç»†æ¨¡æ€æ¡†æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
          showIntelligentModal('å†³ç­–å¼•æ“', advice);
        } else {
          preview.innerHTML = 'æš‚æ— å»ºè®®';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½æ™ºèƒ½å»ºè®®å¤±è´¥:', error);
      }
    }

    // åŠ è½½é¢„æµ‹ç»´æŠ¤ä¿¡æ¯
    async function loadIntelligentPredictions() {
      const preview = document.getElementById('intelligentPredictionsPreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/predictions`);
        const result = await response.json();
        if (result.success && result.data) {
          const predictions = result.data;
          const count = predictions.predictions?.length || 0;
          preview.innerHTML = `å‘ç° <strong>${count}</strong> ä¸ªæ½œåœ¨é—®é¢˜<br>${predictions.summary || 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…'}`;
          showIntelligentModal('é¢„æµ‹ç»´æŠ¤', predictions);
        } else {
          preview.innerHTML = 'æš‚æ— é¢„æµ‹ä¿¡æ¯';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½é¢„æµ‹ä¿¡æ¯å¤±è´¥:', error);
      }
    }

    // åŠ è½½å·¥ä½œæµåˆ—è¡¨
    async function loadIntelligentWorkflows() {
      const preview = document.getElementById('intelligentWorkflowsPreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/workflows`);
        const result = await response.json();
        if (result.success && result.data) {
          const workflows = result.data;
          const count = workflows.workflows?.length || 0;
          preview.innerHTML = `å…±æœ‰ <strong>${count}</strong> ä¸ªå·¥ä½œæµ<br>${workflows.summary || 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…'}`;
          showIntelligentModal('å·¥ä½œæµå¼•æ“', workflows);
        } else {
          preview.innerHTML = 'æš‚æ— å·¥ä½œæµ';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½å·¥ä½œæµå¤±è´¥:', error);
      }
    }

    // åŠ è½½å‘Šè­¦åˆ—è¡¨
    async function loadIntelligentAlerts() {
      const preview = document.getElementById('intelligentAlertsPreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/alerts`);
        const result = await response.json();
        if (result.success && result.data) {
          const alerts = result.data;
          const activeCount = alerts.alerts?.filter(a => a.status === 'active').length || 0;
          preview.innerHTML = `æ´»è·ƒå‘Šè­¦: <strong style="color:#ef4444;">${activeCount}</strong><br>${alerts.summary || 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…'}`;
          showIntelligentModal('å‘Šè­¦ç³»ç»Ÿ', alerts);
        } else {
          preview.innerHTML = 'æš‚æ— å‘Šè­¦';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½å‘Šè­¦å¤±è´¥:', error);
      }
    }

    // åŠ è½½è‡ªé€‚åº”ä¼˜åŒ–çŠ¶æ€
    async function loadIntelligentOptimization() {
      const preview = document.getElementById('intelligentOptimizationPreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/optimization`);
        const result = await response.json();
        if (result.success && result.data) {
          const optimization = result.data;
          preview.innerHTML = `ä¼˜åŒ–çŠ¶æ€: <strong>${optimization.status || 'è¿è¡Œä¸­'}</strong><br>${optimization.summary || 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…'}`;
          showIntelligentModal('è‡ªé€‚åº”ä¼˜åŒ–', optimization);
        } else {
          preview.innerHTML = 'æš‚æ— ä¼˜åŒ–ä¿¡æ¯';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½ä¼˜åŒ–ä¿¡æ¯å¤±è´¥:', error);
      }
    }

    // åŠ è½½çŸ¥è¯†å›¾è°±
    async function loadIntelligentKnowledge() {
      const preview = document.getElementById('intelligentKnowledgePreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/knowledge`);
        const result = await response.json();
        if (result.success && result.data) {
          const knowledge = result.data;
          preview.innerHTML = `å®ä½“æ•°é‡: <strong>${knowledge.entities?.length || 0}</strong><br>${knowledge.summary || 'ç‚¹å‡»æŸ¥è¯¢çŸ¥è¯†å›¾è°±'}`;
          showIntelligentModal('çŸ¥è¯†å›¾è°±', knowledge);
        } else {
          preview.innerHTML = 'æš‚æ— çŸ¥è¯†æ•°æ®';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½çŸ¥è¯†å›¾è°±å¤±è´¥:', error);
      }
    }

    // åŠ è½½æ™ºèƒ½æŠ¥å‘Š
    async function loadIntelligentReports() {
      const preview = document.getElementById('intelligentReportsPreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/reports`);
        const result = await response.json();
        if (result.success && result.data) {
          const reports = result.data;
          const count = reports.reports?.length || 0;
          preview.innerHTML = `å…±æœ‰ <strong>${count}</strong> ä¸ªæŠ¥å‘Š<br>${reports.summary || 'ç‚¹å‡»æŸ¥çœ‹æŠ¥å‘Š'}`;
          showIntelligentModal('æ™ºèƒ½æŠ¥å‘Š', reports);
        } else {
          preview.innerHTML = 'æš‚æ— æŠ¥å‘Š';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½æŠ¥å‘Šå¤±è´¥:', error);
      }
    }

    // æ˜¾ç¤ºæ™ºèƒ½åŠŸèƒ½è¯¦ç»†ä¿¡æ¯çš„æ¨¡æ€æ¡†
    function showIntelligentModal(title, data) {
      // åˆ›å»ºæˆ–è·å–æ¨¡æ€æ¡†
      let modal = document.getElementById('intelligentModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'intelligentModal';
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-content" style="max-width:800px;">
            <div class="modal-header">
              <h3 id="intelligentModalTitle">${title}</h3>
              <button class="btn btn-ghost btn-sm" onclick="closeIntelligentModal()">âœ•</button>
            </div>
            <div class="modal-body" id="intelligentModalBody" style="max-height:70vh;overflow-y:auto;">
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" onclick="closeIntelligentModal()">å…³é—­</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      document.getElementById('intelligentModalTitle').textContent = title;
      const body = document.getElementById('intelligentModalBody');
      
      // æ ¼å¼åŒ–æ˜¾ç¤ºæ•°æ®
      body.innerHTML = `<pre style="white-space:pre-wrap;word-wrap:break-word;font-family:inherit;font-size:14px;line-height:1.6;">${JSON.stringify(data, null, 2)}</pre>`;
      
      modal.style.display = 'flex';
    }

    function closeIntelligentModal() {
      const modal = document.getElementById('intelligentModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    // åˆå§‹åŒ–
    // å®‰å…¨ç‰ˆæœ¬çš„checkAuthè°ƒç”¨ï¼ˆæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼‰
    if (!window.__loginInProgress && !window.__justLoggedIn) {
      setTimeout(function() {
        if (!window.__loginInProgress && !window.__justLoggedIn) {
          checkAuth();
        }
      }, 2000);
    }
  </script>
  
  <script>
    // ä¿å­˜å…¬å‘Š
    document.getElementById('announcementForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = document.getElementById('announcementId').value;
      const content = document.getElementById('announcementContent').value.trim();
      const active = document.getElementById('announcementActive').checked;
      const token = localStorage.getItem('adminToken');
      
      if (!content) {
        alert('è¯·è¾“å…¥å…¬å‘Šå†…å®¹');
        return;
      }
      
      try {
        const url = id 
          ? `${getApiUrl()}/admin/announcements/${id}`
          : `${getApiUrl()}/admin/announcements`;
        
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ content, active })
        });
        
        if (!response.ok) throw new Error(id ? 'æ›´æ–°å¤±è´¥' : 'åˆ›å»ºå¤±è´¥');
        
        const result = await response.json();
        if (result.success) {
          document.getElementById('announcementModal').classList.remove('active');
          loadAnnouncements();
          // å¦‚æœå½“å‰åœ¨é¦–é¡µï¼Œåˆ·æ–°ä¸»é¡µå…¬å‘Šæ 
          const homeView = document.getElementById('homeView');
          if (homeView && homeView.style.display !== 'none') {
            loadHomeAnnouncementBubble();
          }
        }
      } catch (error) {
        alert((id ? 'æ›´æ–°' : 'åˆ›å»º') + 'å¤±è´¥ï¼š' + error.message);
      }
    });
    
    // ä¿®æ”¹å¯†ç åŠŸèƒ½
    document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const errorDiv = document.getElementById('passwordChangeError');
      const successDiv = document.getElementById('passwordChangeSuccess');
      const token = localStorage.getItem('adminToken');
      
      // éšè—ä¹‹å‰çš„æ¶ˆæ¯
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';
      
      // éªŒè¯æ–°å¯†ç 
      if (newPassword.length < 6) {
        errorDiv.textContent = 'æ–°å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½';
        errorDiv.style.display = 'block';
        return;
      }
      
      if (newPassword !== confirmPassword) {
        errorDiv.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´';
        errorDiv.style.display = 'block';
        return;
      }
      
      if (oldPassword === newPassword) {
        errorDiv.textContent = 'æ–°å¯†ç ä¸èƒ½ä¸åŸå¯†ç ç›¸åŒ';
        errorDiv.style.display = 'block';
        return;
      }
      
      try {
        const response = await fetch(`${getApiUrl()}/auth/change-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ oldPassword, newPassword })
        });
        
        const result = await response.json();
        
        if (result.success) {
          successDiv.style.display = 'block';
          document.getElementById('changePasswordForm').reset();
          
          // 3ç§’åéšè—æˆåŠŸæ¶ˆæ¯
          setTimeout(() => {
            successDiv.style.display = 'none';
          }, 3000);
        } else {
          errorDiv.textContent = result.error || 'å¯†ç ä¿®æ”¹å¤±è´¥';
          errorDiv.style.display = 'block';
        }
      } catch (error) {
        errorDiv.textContent = 'å¯†ç ä¿®æ”¹å¤±è´¥ï¼š' + (error.message || 'ç½‘ç»œé”™è¯¯');
        errorDiv.style.display = 'block';
      }
    });
    
    // ==========================================
    // ğŸ“° èµ„è®¯æ›´æ–°åŠŸèƒ½ï¼ˆä»ä¸»ç«™ç§»æ¤ï¼‰
    // ==========================================
    
    // èµ„è®¯æ•°æ®å­˜å‚¨
    let NEWS_DATA = [];
    let currentNewsFilter = 'all';
    let currentNewsRegion = 'local'; // 'local' æˆ– 'national'
    
    // è·å–APIé…ç½®ï¼ˆä¸ä¸»ç«™ä¸€è‡´ï¼‰
    function getApiConfig() {
      const config = localStorage.getItem('pigeon_api_config');
      if (config) {
        const parsed = JSON.parse(config);
        // ç¡®ä¿æœ‰apiUrlå­—æ®µ
        if (!parsed.apiUrl) {
          parsed.apiUrl = 'http://localhost:3000/api';
        }
        return parsed;
      }
      
      // é»˜è®¤é…ç½®ï¼ˆåç«¯æœåŠ¡åœ°å€ï¼‰
      const defaultBaseUrl = 'http://localhost:3000/api';
      return {
        apiUrl: defaultBaseUrl, // APIåŸºç¡€åœ°å€
        newsApiUrl: defaultBaseUrl + '/news', // èµ„è®¯APIåœ°å€
        eventsApiUrl: defaultBaseUrl + '/events', // èµ›äº‹APIåœ°å€
        apiKey: '' // APIå¯†é’¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
      };
    }
    
    // ä¿å­˜APIé…ç½®
    function saveApiConfig(config) {
      localStorage.setItem('pigeon_api_config', JSON.stringify(config));
    }
    
    // ä»localStorageåŠ è½½èµ„è®¯æ•°æ®
    function loadNewsFromStorage() {
      const stored = localStorage.getItem('pigeon_news_data');
      const lastUpdate = localStorage.getItem('pigeon_news_last_update');
      
      if (stored && lastUpdate) {
        const lastUpdateDate = new Date(lastUpdate);
        const now = new Date();
        const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
        
        // å¦‚æœæ•°æ®æ˜¯ä»Šå¤©çš„ï¼Œç›´æ¥ä½¿ç”¨
        if (daysDiff === 0) {
          NEWS_DATA = JSON.parse(stored);
          return true;
        }
      }
      
      return false;
    }
    
    // ä¿å­˜èµ„è®¯æ•°æ®åˆ°localStorage
    function saveNewsToStorage() {
      localStorage.setItem('pigeon_news_data', JSON.stringify(NEWS_DATA));
      localStorage.setItem('pigeon_news_last_update', new Date().toISOString());
    }
    
    // ä»çœŸå®APIè·å–èµ„è®¯æ•°æ®
    async function fetchNewsFromWeb() {
      // è·å–APIé…ç½®
      const apiConfig = getApiConfig();
      
      if (!apiConfig.newsApiUrl) {
        throw new Error('èµ„è®¯APIæœªé…ç½®ï¼Œè¯·åœ¨è®¾ç½®ä¸­é…ç½®APIåœ°å€');
      }
      
      try {
        // æ„å»ºè¯·æ±‚å¤´
        const headers = {
          'Content-Type': 'application/json'
        };
        if (apiConfig.apiKey) {
          headers['Authorization'] = 'Bearer ' + apiConfig.apiKey;
        }
        
        // å°è¯•ä»APIè·å–æ•°æ®
        const response = await fetch(apiConfig.newsApiUrl, {
          method: 'GET',
          headers: headers
        });
        
        if (!response.ok) {
          throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
        }
        
        const result = await response.json();
        
        // åç«¯APIè¿”å›æ ¼å¼: {success: true, data: [...], count: X, timestamp: "..."}
        if (!result.success) {
          throw new Error(result.error || 'APIè¿”å›é”™è¯¯');
        }
        
        const data = result.data || result;
        
        // éªŒè¯æ•°æ®æ ¼å¼
        if (!Array.isArray(data)) {
          throw new Error('APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºæ•°ç»„');
        }
        
        // è½¬æ¢æ•°æ®æ ¼å¼
        return data.map(item => ({
          id: item.id || Date.now() + Math.random(),
          title: item.title || 'æ— æ ‡é¢˜',
          source: item.source || 'æœªçŸ¥æ¥æº',
          sourceUrl: item.sourceUrl || item.url || '#',
          time: item.time || formatUpdateTime(item.updateTime),
          updateTime: item.updateTime || new Date().toISOString(),
          tags: item.tags || [],
          category: item.category || 'race',
          region: item.region || 'national',
          content: item.content || item.description || '',
          hot: item.hot || false
        }));
        
      } catch (error) {
        console.error('è·å–èµ„è®¯å¤±è´¥:', error);
        throw error;
      }
    }
    
    // æ ¼å¼åŒ–æ›´æ–°æ—¶é—´
    function formatUpdateTime(updateTime) {
      if (!updateTime) return 'æœªçŸ¥';
      const date = new Date(updateTime);
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 60) {
        return `${minutes}åˆ†é’Ÿå‰`;
      } else if (hours < 24) {
        return `${hours}å°æ—¶å‰`;
      } else if (days < 7) {
        return `${days}å¤©å‰`;
      } else {
        return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
      }
    }
    
    // æ¸²æŸ“èµ„è®¯åˆ—è¡¨
    function renderNewsList(filter = 'all', region = 'local') {
      const container = document.getElementById('homeNewsList');
      if (!container) return;
      
      // å…ˆæŒ‰åœ°åŒºç­›é€‰
      let filteredNews = NEWS_DATA.filter(n => n.region === region);
      
      // å†æŒ‰åˆ†ç±»ç­›é€‰
      if (filter !== 'all') {
        filteredNews = filteredNews.filter(n => n.category === filter);
      }
      
      // æŒ‰æ›´æ–°æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      filteredNews.sort((a, b) => {
        const timeA = new Date(a.updateTime || 0);
        const timeB = new Date(b.updateTime || 0);
        return timeB - timeA;
      });
      
      if (filteredNews.length === 0) {
        const apiConfig = getApiConfig();
        if (!apiConfig.newsApiUrl) {
          // APIæœªé…ç½®ï¼Œæ˜¾ç¤ºé…ç½®æç¤º
          showApiConfigPrompt('èµ„è®¯');
          return;
        }
        
        container.innerHTML = `
          <div style="padding:40px;text-align:center;color:#9ca3af;">
            <div style="font-size:48px;margin-bottom:16px;">ğŸ“°</div>
            <div>æš‚æ— ${region === 'local' ? 'æœ¬åœ°' : 'å…¨å›½'}èµ„è®¯</div>
            <div style="font-size:12px;margin-top:8px;">ç‚¹å‡»"åˆ·æ–°èµ„è®¯"æŒ‰é’®è·å–æœ€æ–°èµ„è®¯</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredNews.map(news => {
        const updateTimeStr = formatUpdateTime(news.updateTime);
        return `
          <div class="news-card" data-news-id="${news.id}">
            <div class="news-card-header">
              <div class="news-card-title">${news.title}</div>
              <div class="news-card-time">${news.time}</div>
            </div>
            <div class="news-card-source">æ¥æºï¼š${news.source}</div>
            <div class="news-card-update-time">æ›´æ–°æ—¶é—´ï¼š${updateTimeStr}</div>
            <div class="news-card-tags">
              ${news.hot ? '<span class="news-tag hot">ğŸ”¥ çƒ­é—¨</span>' : ''}
              ${news.tags.map(tag => `<span class="news-tag ${news.category}">#${tag}</span>`).join('')}
            </div>
            <div class="news-card-actions">
              <button class="news-card-action-btn" onclick="viewNewsDetail(${news.id})">ğŸ“– æŸ¥çœ‹è¯¦æƒ…</button>
              <button class="news-card-action-btn primary" onclick="openNewsOriginal(${news.id})">ğŸ”— æŸ¥çœ‹åŸæ–‡</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // æŸ¥çœ‹èµ„è®¯è¯¦æƒ…ï¼ˆæš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼‰
    window.viewNewsDetail = function(newsId) {
      const news = NEWS_DATA.find(n => n.id === newsId);
      if (!news) {
        alert('èµ„è®¯ä¸å­˜åœ¨');
        return;
      }
      
      const modal = document.getElementById('newsModal');
      if (!modal) return;
      
      const titleEl = document.getElementById('newsModalTitle');
      const sourceEl = document.getElementById('newsModalSource');
      const regionEl = document.getElementById('newsModalRegion');
      const updateTimeEl = document.getElementById('newsModalUpdateTime');
      const contentEl = document.getElementById('newsModalContent');
      
      if (titleEl) titleEl.textContent = news.title;
      if (sourceEl) sourceEl.textContent = `æ¥æºï¼š${news.source}`;
      if (regionEl) regionEl.textContent = news.region === 'local' ? 'ğŸ“ æœ¬åœ°èµ„è®¯' : 'ğŸŒ å…¨å›½èµ„è®¯';
      if (updateTimeEl) updateTimeEl.textContent = `æ›´æ–°æ—¶é—´ï¼š${formatUpdateTime(news.updateTime)}`;
      if (contentEl) contentEl.textContent = news.content || 'æš‚æ— è¯¦ç»†å†…å®¹';
      
      // è®¾ç½®æŸ¥çœ‹åŸæ–‡æŒ‰é’®çš„é“¾æ¥
      const viewOriginalBtn = document.getElementById('newsModalViewOriginal');
      if (viewOriginalBtn) {
        viewOriginalBtn.onclick = () => window.openNewsOriginal(newsId);
      }
      
      modal.classList.add('active');
    };
    
    // æ‰“å¼€åŸèµ„è®¯é“¾æ¥ï¼ˆæš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼‰
    window.openNewsOriginal = function(newsId) {
      const news = NEWS_DATA.find(n => n.id === newsId);
      if (!news || !news.sourceUrl) {
        alert('åŸèµ„è®¯é“¾æ¥ä¸å­˜åœ¨');
        return;
      }
      
      window.open(news.sourceUrl, '_blank');
    };
    
    // å…³é—­èµ„è®¯è¯¦æƒ…å¼¹çª—
    function closeNewsModal() {
      const modal = document.getElementById('newsModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }
    
    // è‡ªåŠ¨æ›´æ–°èµ„è®¯
    async function updateNews() {
      try {
        const news = await fetchNewsFromWeb();
        NEWS_DATA = news;
        saveNewsToStorage();
        renderNewsList(currentNewsFilter, currentNewsRegion);
        updateHomeStats();
        console.log('èµ„è®¯æ›´æ–°æˆåŠŸï¼Œå…±è·å–', news.length, 'æ¡èµ„è®¯');
      } catch (error) {
        console.error('æ›´æ–°èµ„è®¯å¤±è´¥:', error);
        
        // å¦‚æœAPIæœªé…ç½®ï¼Œæ˜¾ç¤ºé…ç½®æç¤º
        if (error.message && error.message.includes('æœªé…ç½®')) {
          NEWS_DATA = [];
          renderNewsList(currentNewsFilter, currentNewsRegion);
          showApiConfigPrompt('èµ„è®¯');
          return;
        }
        
        // å¦‚æœæ›´æ–°å¤±è´¥ï¼Œå°è¯•åŠ è½½ç¼“å­˜æ•°æ®
        if (loadNewsFromStorage()) {
          renderNewsList(currentNewsFilter, currentNewsRegion);
        } else {
          // æ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
          NEWS_DATA = [];
          renderNewsList(currentNewsFilter, currentNewsRegion);
        }
      }
    }
    
    // æ˜¾ç¤ºAPIé…ç½®æç¤º
    function showApiConfigPrompt(type) {
      const container = type === 'èµ„è®¯' ? document.getElementById('homeNewsList') : document.getElementById('homeEventsList');
      if (!container) return;
      
      const apiConfig = getApiConfig();
      const apiUrl = type === 'èµ„è®¯' ? apiConfig.newsApiUrl : apiConfig.eventsApiUrl;
      
      if (!apiUrl) {
        container.innerHTML = `
          <div style="padding:40px;text-align:center;color:#9ca3af;">
            <div style="font-size:48px;margin-bottom:16px;">${type === 'èµ„è®¯' ? 'ğŸ“°' : 'ğŸ'}</div>
            <div style="font-size:16px;font-weight:600;color:#374151;margin-bottom:8px;">${type}APIæœªé…ç½®</div>
            <div style="font-size:13px;color:#6b7280;margin-bottom:16px;">è¯·é…ç½®${type}APIåœ°å€ä»¥è·å–çœŸå®æ•°æ®</div>
            <button class="btn btn-primary btn-sm" onclick="showApiConfigModal('${type}')" style="margin-top:12px;">
              âš™ï¸ é…ç½®API
            </button>
          </div>
        `;
      }
    }
    
    // æ˜¾ç¤ºAPIé…ç½®å¼¹çª—
    window.showApiConfigModal = function(type) {
      const apiConfig = getApiConfig();
      const apiUrl = type === 'èµ„è®¯' ? apiConfig.newsApiUrl : apiConfig.eventsApiUrl;
      const apiKey = apiConfig.apiKey || '';
      
      const newsApiUrl = prompt(`è¯·è¾“å…¥${type === 'èµ„è®¯' ? 'èµ„è®¯' : 'èµ›äº‹'}APIåœ°å€:`, apiUrl || '');
      if (newsApiUrl === null) return; // ç”¨æˆ·å–æ¶ˆ
      
      const newApiKey = prompt('è¯·è¾“å…¥APIå¯†é’¥ï¼ˆå¯é€‰ï¼Œç›´æ¥å›è½¦è·³è¿‡ï¼‰:', apiKey);
      
      const newConfig = {
        ...apiConfig,
        [type === 'èµ„è®¯' ? 'newsApiUrl' : 'eventsApiUrl']: newsApiUrl,
        apiKey: newApiKey || apiKey
      };
      
      saveApiConfig(newConfig);
      
      // é‡æ–°å°è¯•è·å–æ•°æ®
      if (type === 'èµ„è®¯') {
        updateNews();
      }
      
      alert('APIé…ç½®å·²ä¿å­˜ï¼Œæ­£åœ¨è·å–æ•°æ®...');
    };
    
    // æ›´æ–°é¦–é¡µç»Ÿè®¡
    function updateHomeStats() {
      const pigeonCountEl = document.getElementById('homePigeonCount');
      if (pigeonCountEl) {
        // è¿™é‡Œå¯ä»¥ä»localStorageè·å–é¸½å­æ•°æ®
        try {
          const pigeonsData = localStorage.getItem('pigeons');
          if (pigeonsData) {
            const pigeons = JSON.parse(pigeonsData);
            pigeonCountEl.textContent = pigeons.filter(p => p && p.alive).length || 0;
          } else {
            pigeonCountEl.textContent = '0';
          }
        } catch (e) {
          pigeonCountEl.textContent = '0';
        }
      }
      
      // æ›´æ–°å…¶ä»–ç»Ÿè®¡
      const newsCountEl = document.getElementById('homeNewsCount');
      if (newsCountEl) {
        newsCountEl.textContent = NEWS_DATA.length || 0;
      }
      
      // æ›´æ–°èµ›äº‹ç»Ÿè®¡
      const activeRacesEl = document.getElementById('homeActiveRaces');
      if (activeRacesEl) {
        activeRacesEl.textContent = (EVENTS_DATA.ongoing || []).length;
      }
      
      const completedRacesEl = document.getElementById('homeCompletedRaces');
      if (completedRacesEl) {
        completedRacesEl.textContent = (EVENTS_DATA.results || []).length;
      }
      
      // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
      const now = new Date();
      const dayEl = document.getElementById('homeDay');
      const weekdayEl = document.getElementById('homeWeekday');
      const dateFullEl = document.getElementById('homeDateFull');
      
      if (dayEl) dayEl.textContent = now.getDate();
      if (weekdayEl) {
        const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        weekdayEl.textContent = weekdays[now.getDay()];
      }
      if (dateFullEl) {
        dateFullEl.textContent = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ`;
      }
    }
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°èµ„è®¯ï¼ˆæ¯å¤©æ›´æ–°ä¸€æ¬¡ï¼‰
    function checkAndUpdateNews() {
      const lastUpdate = localStorage.getItem('pigeon_news_last_update');
      if (!lastUpdate) {
        // é¦–æ¬¡åŠ è½½ï¼Œç›´æ¥æ›´æ–°
        updateNews();
        return;
      }
      
      const lastUpdateDate = new Date(lastUpdate);
      const now = new Date();
      const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
      
      if (daysDiff >= 1) {
        // è¶…è¿‡1å¤©ï¼Œéœ€è¦æ›´æ–°
        updateNews();
      } else {
        // ä½¿ç”¨ç¼“å­˜æ•°æ®
        if (loadNewsFromStorage()) {
          renderNewsList(currentNewsFilter, currentNewsRegion);
        } else {
          // å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œåˆ™æ›´æ–°
          updateNews();
        }
      }
    }
    
    // ==========================================
    // ğŸ å®æ—¶èµ›äº‹åŠŸèƒ½ï¼ˆä»ä¸»ç«™ç§»æ¤ï¼‰
    // ==========================================
    
    // èµ›äº‹æ•°æ®å­˜å‚¨
    let EVENTS_DATA = {
      ongoing: [],
      upcoming: [],
      results: []
    };
    
    let currentEventTab = 'ongoing';
    let currentEventRegion = 'local'; // 'local' æˆ– 'national'
    
    // ä»localStorageåŠ è½½èµ›äº‹æ•°æ®
    function loadEventsFromStorage() {
      const stored = localStorage.getItem('pigeon_events_data');
      const lastUpdate = localStorage.getItem('pigeon_events_last_update');
      
      if (stored && lastUpdate) {
        const lastUpdateDate = new Date(lastUpdate);
        const now = new Date();
        const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
        
        // å¦‚æœæ•°æ®æ˜¯ä»Šå¤©çš„ï¼Œç›´æ¥ä½¿ç”¨
        if (daysDiff === 0) {
          EVENTS_DATA = JSON.parse(stored);
          return true;
        }
      }
      
      return false;
    }
    
    // ä¿å­˜èµ›äº‹æ•°æ®åˆ°localStorage
    function saveEventsToStorage() {
      localStorage.setItem('pigeon_events_data', JSON.stringify(EVENTS_DATA));
      localStorage.setItem('pigeon_events_last_update', new Date().toISOString());
    }
    
    // ä»çœŸå®APIè·å–èµ›äº‹æ•°æ®
    async function fetchEventsFromWeb() {
      // è·å–APIé…ç½®
      const apiConfig = getApiConfig();
      
      if (!apiConfig.eventsApiUrl) {
        throw new Error('èµ›äº‹APIæœªé…ç½®ï¼Œè¯·åœ¨è®¾ç½®ä¸­é…ç½®APIåœ°å€');
      }
      
      try {
        // æ„å»ºè¯·æ±‚å¤´
        const headers = {
          'Content-Type': 'application/json'
        };
        if (apiConfig.apiKey) {
          headers['Authorization'] = 'Bearer ' + apiConfig.apiKey;
        }
        
        // å°è¯•ä»APIè·å–æ•°æ®ï¼ˆè·å–æ‰€æœ‰ç±»å‹çš„èµ›äº‹ï¼‰
        const response = await fetch(apiConfig.eventsApiUrl, {
          method: 'GET',
          headers: headers
        });
        
        if (!response.ok) {
          const errorText = await response.text().catch(() => '');
          throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}. ${errorText}`);
        }
        
        const result = await response.json();
        
        // åç«¯APIè¿”å›æ ¼å¼: {success: true, data: {ongoing: [], upcoming: [], results: []}}
        if (!result.success) {
          throw new Error(result.error || result.message || 'APIè¿”å›é”™è¯¯');
        }
        
        const data = result.data || result;
        
        // éªŒè¯æ•°æ®æ ¼å¼
        if (!data.ongoing || !data.upcoming || !data.results) {
          throw new Error('APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”åŒ…å«ongoingã€upcomingã€resultså­—æ®µ');
        }
        
        // è½¬æ¢æ•°æ®æ ¼å¼å¹¶éªŒè¯
        const now = new Date();
        return {
          ongoing: (data.ongoing || []).map(item => {
            const releaseTimeFull = item.releaseTimeFull ? new Date(item.releaseTimeFull) : null;
            const endTimeFull = item.endTimeFull ? new Date(item.endTimeFull) : null;
            
            if (endTimeFull && endTimeFull <= now) {
              return null;
            }
            
            if (releaseTimeFull && releaseTimeFull > now) {
              return null;
            }
            
            return {
              id: item.id || Date.now() + Math.random(),
              name: item.name || 'æœªçŸ¥èµ›äº‹',
              organizer: item.organizer || 'æœªçŸ¥ç»„ç»‡',
              source: item.source || 'æœªçŸ¥æ¥æº',
              sourceUrl: item.sourceUrl || item.url || '#',
              releaseTime: item.releaseTime || 'æœªçŸ¥æ—¶é—´',
              releaseTimeFull: item.releaseTimeFull || new Date().toISOString(),
              endTimeFull: item.endTimeFull || null,
              distance: item.distance || 'æœªçŸ¥è·ç¦»',
              status: 'ongoing',
              region: item.region || 'national',
              returned: item.returned || 0,
              total: item.total || 0,
              weather: item.weather || 'æœªçŸ¥',
              updateTime: item.updateTime || new Date().toISOString()
            };
          }).filter(item => item !== null),
          upcoming: (data.upcoming || []).map(item => {
            const startTimeFull = item.startTimeFull ? new Date(item.startTimeFull) : null;
            
            if (startTimeFull && startTimeFull <= now) {
              return null;
            }
            
            return {
              id: item.id || Date.now() + Math.random(),
              name: item.name || 'æœªçŸ¥èµ›äº‹',
              organizer: item.organizer || 'æœªçŸ¥ç»„ç»‡',
              source: item.source || 'æœªçŸ¥æ¥æº',
              sourceUrl: item.sourceUrl || item.url || '#',
              startTime: item.startTime || 'æœªçŸ¥æ—¶é—´',
              startTimeFull: item.startTimeFull || new Date(now.getTime() + 86400000).toISOString(),
              distance: item.distance || 'æœªçŸ¥è·ç¦»',
              status: 'upcoming',
              region: item.region || 'national',
              participants: item.participants || 0,
              weather: item.weather || 'æœªçŸ¥',
              updateTime: item.updateTime || new Date().toISOString()
            };
          }).filter(item => item !== null),
          results: (data.results || []).map(item => {
            const endTimeFull = item.endTimeFull ? new Date(item.endTimeFull) : null;
            
            if (endTimeFull && endTimeFull > now) {
              return null;
            }
            
            return {
              id: item.id || Date.now() + Math.random(),
              name: item.name || 'æœªçŸ¥èµ›äº‹',
              organizer: item.organizer || 'æœªçŸ¥ç»„ç»‡',
              source: item.source || 'æœªçŸ¥æ¥æº',
              sourceUrl: item.sourceUrl || item.url || '#',
              endTime: item.endTime || 'æœªçŸ¥æ—¶é—´',
              endTimeFull: item.endTimeFull || new Date(now.getTime() - 86400000).toISOString(),
              distance: item.distance || 'æœªçŸ¥è·ç¦»',
              status: 'completed',
              region: item.region || 'national',
              champion: item.champion || 'æœªçŸ¥',
              championRing: item.championRing || 'æœªçŸ¥',
              championTime: item.championTime || 'æœªçŸ¥',
              updateTime: item.updateTime || new Date().toISOString()
            };
          }).filter(item => item !== null)
        };
        
      } catch (error) {
        console.error('è·å–èµ›äº‹å¤±è´¥:', error);
        throw error;
      }
    }
    
    // éªŒè¯èµ›äº‹æ—¶é—´æ˜¯å¦æœ‰æ•ˆ
    function isValidEventTime(event, tab) {
      const now = new Date();
      
      if (tab === 'ongoing') {
        if (!event.releaseTimeFull) return false;
        const releaseTime = new Date(event.releaseTimeFull);
        const hoursSinceRelease = (now - releaseTime) / (1000 * 60 * 60);
        if (hoursSinceRelease > 24) return false;
        if (releaseTime > now) return false;
        return true;
      } else if (tab === 'upcoming') {
        if (!event.startTimeFull) return false;
        const startTime = new Date(event.startTimeFull);
        if (startTime <= now) return false;
        return true;
      } else if (tab === 'results') {
        if (!event.endTimeFull) return false;
        const endTime = new Date(event.endTimeFull);
        if (endTime > now) return false;
        return true;
      }
      
      return true;
    }
    
    // éªŒè¯èµ›äº‹æ•°æ®æ˜¯å¦è¿‡æ—¶
    function isEventOutdated(event) {
      if (!event.updateTime) return true;
      
      const updateTime = new Date(event.updateTime);
      const now = new Date();
      const hoursSinceUpdate = (now - updateTime) / (1000 * 60 * 60);
      
      if (event.status === 'ongoing' && hoursSinceUpdate > 2) {
        return true;
      }
      
      if (hoursSinceUpdate > 24) {
        return true;
      }
      
      return false;
    }
    
    // æ¸²æŸ“èµ›äº‹åˆ—è¡¨
    function renderEventsList(tab = 'ongoing', region = 'local') {
      const container = document.getElementById('homeEventsList');
      if (!container) return;
      
      // å…ˆæŒ‰åœ°åŒºç­›é€‰
      let events = (EVENTS_DATA[tab] || []).filter(event => event.region === region);
      
      // è¿‡æ»¤æ‰æ—¶é—´ä¸å»åˆçš„èµ›äº‹
      events = events.filter(event => isValidEventTime(event, tab));
      
      // è¿‡æ»¤æ‰è¿‡æ—¶çš„èµ›äº‹
      events = events.filter(event => !isEventOutdated(event));
      
      // å¯¹äº"è¿›è¡Œä¸­"çš„èµ›äº‹ï¼Œé¢å¤–éªŒè¯
      if (tab === 'ongoing') {
        events = events.filter(event => {
          if (event.endTimeFull) {
            const endTime = new Date(event.endTimeFull);
            if (endTime <= new Date()) {
              return false;
            }
          }
          return true;
        });
      }
      
      // æŒ‰æ›´æ–°æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      events.sort((a, b) => {
        const timeA = new Date(a.updateTime || 0);
        const timeB = new Date(b.updateTime || 0);
        return timeB - timeA;
      });
      
      if (events.length === 0) {
        const apiConfig = getApiConfig();
        if (!apiConfig.eventsApiUrl) {
          showApiConfigPrompt('èµ›äº‹');
          return;
        }
        
        container.innerHTML = `
          <div style="padding:40px;text-align:center;color:#9ca3af;">
            <div style="font-size:48px;margin-bottom:16px;">ğŸ</div>
            <div>æš‚æ— ${region === 'local' ? 'æœ¬åœ°' : 'å…¨å›½'}${tab === 'ongoing' ? 'è¿›è¡Œä¸­' : tab === 'upcoming' ? 'å³å°†å¼€å§‹' : 'æœ€æ–°æˆç»©'}èµ›äº‹</div>
            <div style="font-size:12px;margin-top:8px;">ç‚¹å‡»"åˆ·æ–°"æŒ‰é’®è·å–æœ€æ–°èµ›äº‹</div>
          </div>
        `;
        return;
      }
      
      if (tab === 'ongoing') {
        container.innerHTML = events.map(event => {
          const updateTimeStr = formatUpdateTime(event.updateTime);
          const progressPercent = event.total > 0 ? ((event.returned / event.total) * 100).toFixed(1) : 0;
          return `
            <div class="event-card" style="cursor:pointer;" onclick="openEventUrl('${event.sourceUrl || '#'}')">
              <div class="event-card-status ongoing">
                <span>è¿›è¡Œä¸­</span>
              </div>
              <div class="event-card-title">${event.name}</div>
              <div class="event-card-info">
                <div class="event-card-info-item">
                  <span>ğŸ¢</span>
                  <span>${event.organizer}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ“</span>
                  <span>${event.distance}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ•</span>
                  <span>æ”¾é£ï¼š${event.releaseTime}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸŒ¤ï¸</span>
                  <span>${event.weather}</span>
                </div>
              </div>
              <div class="event-card-progress">
                <div class="event-progress-bar">
                  <div class="event-progress-fill" style="width:${progressPercent}%;"></div>
                </div>
                <div class="event-progress-text">å·²å½’å·¢ ${event.returned} / ${event.total} åªï¼ˆ${progressPercent}%ï¼‰</div>
              </div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
                <span>ğŸ“° æ¥æºï¼š${event.source || 'æœªçŸ¥'}</span>
                <span>ğŸ• æ›´æ–°ï¼š${updateTimeStr}</span>
              </div>
              ${event.sourceUrl && event.sourceUrl !== '#' ? `
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                <button class="btn btn-outline btn-sm" style="width:100%;" onclick="event.stopPropagation();window.open('${event.sourceUrl}', '_blank')">
                  ğŸ”— æŸ¥çœ‹åŸèµ›äº‹ç½‘é¡µ
                </button>
              </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } else if (tab === 'upcoming') {
        container.innerHTML = events.map(event => {
          const updateTimeStr = formatUpdateTime(event.updateTime);
          return `
            <div class="event-card" style="cursor:pointer;" onclick="openEventUrl('${event.sourceUrl || '#'}')">
              <div class="event-card-status upcoming">å³å°†å¼€å§‹</div>
              <div class="event-card-title">${event.name}</div>
              <div class="event-card-info">
                <div class="event-card-info-item">
                  <span>ğŸ¢</span>
                  <span>${event.organizer}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ“</span>
                  <span>${event.distance}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ•</span>
                  <span>å¼€å§‹ï¼š${event.startTime}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ•Šï¸</span>
                  <span>å‚èµ›ï¼š${event.participants}åª</span>
                </div>
              </div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
                <span>ğŸ“° æ¥æºï¼š${event.source || 'æœªçŸ¥'}</span>
                <span>ğŸ• æ›´æ–°ï¼š${updateTimeStr}</span>
              </div>
              ${event.sourceUrl && event.sourceUrl !== '#' ? `
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                <button class="btn btn-outline btn-sm" style="width:100%;" onclick="event.stopPropagation();window.open('${event.sourceUrl}', '_blank')">
                  ğŸ”— æŸ¥çœ‹åŸèµ›äº‹ç½‘é¡µ
                </button>
              </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } else if (tab === 'results') {
        container.innerHTML = events.map(event => {
          const updateTimeStr = formatUpdateTime(event.updateTime);
          return `
            <div class="event-card" style="cursor:pointer;" onclick="openEventUrl('${event.sourceUrl || '#'}')">
              <div class="event-card-status completed">å·²ç»“æŸ</div>
              <div class="event-card-title">${event.name}</div>
              <div class="event-card-info">
                <div class="event-card-info-item">
                  <span>ğŸ¢</span>
                  <span>${event.organizer}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ“</span>
                  <span>${event.distance}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ•</span>
                  <span>ç»“æŸï¼š${event.endTime}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ†</span>
                  <span>å† å†›ï¼š${event.champion} (${event.championRing})</span>
                </div>
                ${event.championTime ? `
                <div class="event-card-info-item">
                  <span>â±ï¸</span>
                  <span>æˆç»©ï¼š${event.championTime}</span>
                </div>
                ` : ''}
              </div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
                <span>ğŸ“° æ¥æºï¼š${event.source || 'æœªçŸ¥'}</span>
                <span>ğŸ• æ›´æ–°ï¼š${updateTimeStr}</span>
              </div>
              ${event.sourceUrl && event.sourceUrl !== '#' ? `
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                <button class="btn btn-outline btn-sm" style="width:100%;" onclick="event.stopPropagation();window.open('${event.sourceUrl}', '_blank')">
                  ğŸ”— æŸ¥çœ‹åŸèµ›äº‹ç½‘é¡µ
                </button>
              </div>
              ` : ''}
            </div>
          `;
        }).join('');
      }
    }
    
    // æ‰“å¼€èµ›äº‹é“¾æ¥ï¼ˆæš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼‰
    window.openEventUrl = function(url) {
      if (url && url !== '#') {
        window.open(url, '_blank');
      }
    };
    
    // è‡ªåŠ¨æ›´æ–°èµ›äº‹
    async function updateEvents() {
      try {
        const events = await fetchEventsFromWeb();
        
        // å†æ¬¡éªŒè¯å’Œè¿‡æ»¤æ•°æ®
        const now = new Date();
        
        // è¿‡æ»¤è¿›è¡Œä¸­çš„èµ›äº‹
        events.ongoing = events.ongoing.filter(event => {
          if (!event.releaseTimeFull) return false;
          const releaseTime = new Date(event.releaseTimeFull);
          if (releaseTime > now) return false;
          
          if (event.endTimeFull) {
            const endTime = new Date(event.endTimeFull);
            if (endTime <= now) return false;
          }
          
          if (event.updateTime) {
            const updateTime = new Date(event.updateTime);
            const hoursSinceUpdate = (now - updateTime) / (1000 * 60 * 60);
            if (hoursSinceUpdate > 2) return false;
          }
          
          return true;
        });
        
        // è¿‡æ»¤å³å°†å¼€å§‹çš„èµ›äº‹
        events.upcoming = events.upcoming.filter(event => {
          if (!event.startTimeFull) return false;
          const startTime = new Date(event.startTimeFull);
          return startTime > now;
        });
        
        // è¿‡æ»¤å·²ç»“æŸçš„èµ›äº‹
        events.results = events.results.filter(event => {
          if (!event.endTimeFull) return false;
          const endTime = new Date(event.endTimeFull);
          return endTime <= now;
        });
        
        EVENTS_DATA = events;
        saveEventsToStorage();
        renderEventsList(currentEventTab, currentEventRegion);
        updateHomeStats();
        console.log('èµ›äº‹æ›´æ–°æˆåŠŸï¼Œå…±è·å–', 
          events.ongoing.length + events.upcoming.length + events.results.length, 
          'åœºæœ‰æ•ˆèµ›äº‹');
      } catch (error) {
        console.error('æ›´æ–°èµ›äº‹å¤±è´¥:', error);
        
        // å¦‚æœAPIæœªé…ç½®ï¼Œæ˜¾ç¤ºé…ç½®æç¤º
        if (error.message && error.message.includes('æœªé…ç½®')) {
          EVENTS_DATA = { ongoing: [], upcoming: [], results: [] };
          renderEventsList(currentEventTab, currentEventRegion);
          showApiConfigPrompt('èµ›äº‹');
          return;
        }
        
        // å¦‚æœæ›´æ–°å¤±è´¥ï¼Œå°è¯•åŠ è½½ç¼“å­˜æ•°æ®
        if (loadEventsFromStorage()) {
          renderEventsList(currentEventTab, currentEventRegion);
        } else {
          // æ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
          EVENTS_DATA = { ongoing: [], upcoming: [], results: [] };
          renderEventsList(currentEventTab, currentEventRegion);
        }
      }
    }
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°èµ›äº‹
    function checkAndUpdateEvents() {
      const lastUpdate = localStorage.getItem('pigeon_events_last_update');
      if (!lastUpdate) {
        updateEvents();
        return;
      }
      
      const lastUpdateDate = new Date(lastUpdate);
      const now = new Date();
      const minutesSinceUpdate = (now - lastUpdateDate) / (1000 * 60);
      
      const hasOngoingEvents = (EVENTS_DATA.ongoing || []).length > 0;
      
      if (hasOngoingEvents) {
        if (minutesSinceUpdate >= 5) {
          updateEvents();
        } else {
          if (loadEventsFromStorage()) {
            renderEventsList(currentEventTab, currentEventRegion);
          } else {
            updateEvents();
          }
        }
      } else {
        if (minutesSinceUpdate >= 60) {
          updateEvents();
        } else {
          if (loadEventsFromStorage()) {
            renderEventsList(currentEventTab, currentEventRegion);
          } else {
            updateEvents();
          }
        }
      }
    }
    
    // åŠ è½½ä¸»é¡µå…¬å‘Šæ 
    // å­˜å‚¨é¦–é¡µå½“å‰å…¬å‘Šæ•°æ®
    let homeCurrentAnnouncement = null;
    
    async function loadHomeAnnouncementBubble() {
      const bubbleEl = document.getElementById('homeAnnouncementBubbleText');
      const hintEl = document.getElementById('homeAnnouncementHint');
      const bubbleContainer = document.getElementById('homeAnnouncementBubble');
      if (!bubbleEl) return;
      
      const token = localStorage.getItem('adminToken');
      if (!token) {
        bubbleEl.textContent = 'æš‚æ— å…¬å‘Š';
        homeCurrentAnnouncement = null;
        if (hintEl) hintEl.style.display = 'none';
        if (bubbleContainer) bubbleContainer.style.cursor = 'default';
        return;
      }
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`${getApiUrl()}/admin/announcements`, {
          headers: {
            'Authorization': `Bearer ${token}`
          },
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error('è·å–å…¬å‘Šå¤±è´¥');
        }
        
        const result = await response.json();
        const announcements = result.data || [];
        
        // ä¿å­˜å…¬å‘Šæ•°æ®ä¾›æŸ¥çœ‹ä½¿ç”¨
        window.announcementsData = announcements;
        
        // è·å–æœ€æ–°çš„å·²å‘å¸ƒå…¬å‘Š
        const activeAnnouncements = announcements.filter(ann => ann.active);
        if (activeAnnouncements.length > 0) {
          // æŒ‰æ›´æ–°æ—¶é—´æ’åºï¼Œè·å–æœ€æ–°çš„
          activeAnnouncements.sort((a, b) => {
            const timeA = new Date(a.updatedAt || a.createdAt);
            const timeB = new Date(b.updatedAt || b.createdAt);
            return timeB - timeA;
          });
          
          const latestAnnouncement = activeAnnouncements[0];
          homeCurrentAnnouncement = latestAnnouncement;
          
          const content = latestAnnouncement.content || 'æš‚æ— å…¬å‘Š';
          
          // å¦‚æœå†…å®¹è¾ƒé•¿ï¼Œæ˜¾ç¤ºæç¤º
          if (content.length > 50) {
            if (hintEl) hintEl.style.display = 'inline';
            // é™åˆ¶æ˜¾ç¤ºé•¿åº¦
            const maxLength = 80;
            if (content.length > maxLength) {
              bubbleEl.textContent = content.substring(0, maxLength) + '...';
            } else {
              bubbleEl.textContent = content;
            }
          } else {
            bubbleEl.textContent = content;
            if (hintEl) hintEl.style.display = 'none';
          }
          
          // æ·»åŠ ç‚¹å‡»äº‹ä»¶
          if (bubbleContainer) {
            bubbleContainer.style.cursor = 'pointer';
          }
        } else {
          bubbleEl.textContent = 'æš‚æ— å…¬å‘Š';
          homeCurrentAnnouncement = null;
          if (hintEl) hintEl.style.display = 'none';
          if (bubbleContainer) bubbleContainer.style.cursor = 'default';
        }
      } catch (error) {
        console.error('åŠ è½½å…¬å‘Šå¤±è´¥:', error);
        bubbleEl.textContent = 'æš‚æ— å…¬å‘Š';
        homeCurrentAnnouncement = null;
        if (hintEl) hintEl.style.display = 'none';
      }
    }
    
    // æ˜¾ç¤ºé¦–é¡µå…¬å‘Šè¯¦æƒ…
    window.showHomeAnnouncementDetail = function() {
      if (!homeCurrentAnnouncement) {
        console.warn('æ²¡æœ‰å¯æ˜¾ç¤ºçš„å…¬å‘Š');
        return;
      }
      
      // ä½¿ç”¨å·²æœ‰çš„æŸ¥çœ‹å…¬å‘Šæ¨¡æ€æ¡†å‡½æ•°
      if (window.viewFullAnnouncement) {
        viewFullAnnouncement(homeCurrentAnnouncement.id);
      } else {
        // å¦‚æœviewFullAnnouncementä¸å­˜åœ¨ï¼Œç›´æ¥æ˜¾ç¤º
        alert('å…¬å‘Šè¯¦æƒ…åŠŸèƒ½æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢');
      }
    };
    
    // åˆå§‹åŒ–é¦–é¡µè§†å›¾
    function initHomeView() {
      // æ›´æ–°é¦–é¡µç»Ÿè®¡
      updateHomeStats();
      
      // åŠ è½½ä¸»é¡µå…¬å‘Šæ 
      loadHomeAnnouncementBubble();
      
      // æ£€æŸ¥å¹¶æ›´æ–°èµ„è®¯
      checkAndUpdateNews();
      
      // æ£€æŸ¥å¹¶æ›´æ–°èµ›äº‹
      checkAndUpdateEvents();
      
      // ç»‘å®šèµ„è®¯ç­›é€‰æŒ‰é’®äº‹ä»¶
      document.querySelectorAll('.news-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.news-filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentNewsFilter = btn.dataset.filter;
          renderNewsList(currentNewsFilter, currentNewsRegion);
        });
      });
      
      // æœ¬åœ°/å…¨å›½èµ„è®¯æ ‡ç­¾é¡µåˆ‡æ¢
      document.querySelectorAll('.news-region-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.news-region-tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentNewsRegion = btn.dataset.region;
          renderNewsList(currentNewsFilter, currentNewsRegion);
        });
      });
      
      // åˆ·æ–°èµ„è®¯æŒ‰é’®
      const btnRefreshNews = document.getElementById('btnRefreshNews');
      if (btnRefreshNews) {
        btnRefreshNews.addEventListener('click', () => {
          updateNews();
          alert('æ­£åœ¨åˆ·æ–°èµ„è®¯ï¼Œè¯·ç¨å€™...');
        });
      }
      
      // èµ„è®¯è¯¦æƒ…å¼¹çª—å…³é—­äº‹ä»¶
      const newsModalClose = document.getElementById('newsModalClose');
      const newsModalCloseBtn = document.getElementById('newsModalCloseBtn');
      const newsModal = document.getElementById('newsModal');
      
      if (newsModalClose) {
        newsModalClose.addEventListener('click', closeNewsModal);
      }
      if (newsModalCloseBtn) {
        newsModalCloseBtn.addEventListener('click', closeNewsModal);
      }
      if (newsModal) {
        newsModal.addEventListener('click', (e) => {
          if (e.target.id === 'newsModal') {
            closeNewsModal();
          }
        });
      }
      
      // èµ›äº‹åœ°åŒºæ ‡ç­¾é¡µåˆ‡æ¢
      document.querySelectorAll('.event-region-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.event-region-tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentEventRegion = btn.dataset.region;
          renderEventsList(currentEventTab, currentEventRegion);
        });
      });
      
      // èµ›äº‹æ ‡ç­¾é¡µåˆ‡æ¢
      document.querySelectorAll('.event-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.event-tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentEventTab = btn.dataset.tab;
          renderEventsList(currentEventTab, currentEventRegion);
        });
      });
      
      // åˆ·æ–°èµ›äº‹æŒ‰é’®
      const btnRefreshEvents = document.getElementById('btnRefreshEvents');
      if (btnRefreshEvents) {
        btnRefreshEvents.addEventListener('click', () => {
          updateEvents();
          alert('æ­£åœ¨åˆ·æ–°èµ›äº‹æ•°æ®ï¼Œè¯·ç¨å€™...');
        });
      }
    }
    
    // ==========================================
    // ğŸ•Šï¸ Evo æ™ºèƒ½åŠ©æ‰‹è®¾ç½®åŠŸèƒ½
    // ==========================================
    
    const EVO_SETTINGS_KEY = 'evo_settings';
    const EVO_SYNC_KEY = 'evo_settings_sync';
    
    // é»˜è®¤è®¾ç½®
    const defaultEvoSettings = {
      enabled: true,
      position: 'bottom-right',
      displayMode: 'always',
      autoClose: 5,
      iconSize: 70,
      theme: 'purple',
      showWelcome: true,
      saveHistory: true,
      showAnalytics: true,
      showRecommendations: true,
      github: {
        repo: '',
        token: '',
        apiEndpoint: ''
      },
      functionGuides: {
        'é¦–é¡µ': {
          description: 'é¦–é¡µæ˜¯ç³»ç»Ÿçš„ä¿¡æ¯ä¸­å¿ƒ',
          features: [
            'ğŸ“° èµ›é¸½èµ„è®¯ï¼šæŸ¥çœ‹æœ€æ–°çš„èµ›é¸½ç›¸å…³èµ„è®¯ï¼Œå¯ä»¥æŒ‰ç±»å‹ï¼ˆå…¨éƒ¨/èµ›äº‹/è‚²ç§/å¥åº·ï¼‰å’Œåœ°åŒºï¼ˆæœ¬åœ°/å…¨å›½ï¼‰ç­›é€‰',
            'ğŸ å®æ—¶èµ›äº‹ï¼šæŸ¥çœ‹è¿›è¡Œä¸­ã€å³å°†å¼€å§‹å’Œæœ€æ–°æˆç»©çš„èµ›äº‹ä¿¡æ¯',
            'ğŸ§  æ™ºèƒ½æ¨èï¼šç³»ç»Ÿæ ¹æ®æ‚¨çš„æ•°æ®æä¾›ä¸ªæ€§åŒ–æ¨è',
            'â­ æˆ‘çš„å…³æ³¨ï¼šç®¡ç†æ‚¨å…³æ³¨çš„èµ›åŒºã€èµ›äº‹ç±»å‹ç­‰',
            'ğŸš€ å¿«æ·å…¥å£ï¼šå¿«é€Ÿè®¿é—®å¸¸ç”¨åŠŸèƒ½ï¼ˆæ–°å¢é¸½å­ã€å½•å…¥æˆç»©ã€é…å¯¹è¯„ä¼°ã€æ™ºèƒ½åˆ†æï¼‰',
            'ğŸ”” ä»Šæ—¥æé†’ï¼šæŸ¥çœ‹ä»Šæ—¥çš„é‡è¦æé†’äº‹é¡¹'
          ]
        },
        'æ•°æ®æ¦‚è§ˆ': {
          description: 'æŸ¥çœ‹ç³»ç»Ÿçš„æ•´ä½“æ•°æ®ç»Ÿè®¡',
          features: [
            'ğŸ“Š æ ¸å¿ƒæ•°æ®å¡ç‰‡ï¼šæ˜¾ç¤ºæ€»é¸½å­æ•°ã€åœ¨ä¸–ã€å·²æ­»äº¡ã€æœ‰æˆç»©ã€æ ¸å¿ƒç§é¸½ç­‰ç»Ÿè®¡',
            'ğŸ“ˆ å¹´åº¦ç»Ÿè®¡ï¼šæŒ‰å¹´ä»½æ±‡æ€»å‡ºç”Ÿæ•°é‡ã€æ­»äº¡æ•°é‡ä»¥åŠæœ‰å‚èµ›è®°å½•çš„é¸½å­æ•°é‡'
          ]
        },
        'é¸½å­ç®¡ç†': {
          description: 'ç®¡ç†æ‚¨çš„ä¿¡é¸½æ¡£æ¡ˆ',
          features: [
            'ğŸ“‹ è¡¨æ ¼è§†å›¾ï¼šä»¥è¡¨æ ¼å½¢å¼æŸ¥çœ‹æ‰€æœ‰é¸½å­ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¶³ç¯å·ã€åç§°ã€ç±»å‹ã€çŠ¶æ€ã€çˆ¶é¸½/æ¯é¸½ã€ç°é¸½ä¸»ã€å‚èµ›è®°å½•æ•°',
            'ğŸƒ å¡ç‰‡è§†å›¾ï¼šä»¥å¡ç‰‡å½¢å¼æŸ¥çœ‹é¸½å­ä¿¡æ¯ï¼Œæ›´ç›´è§‚ç¾è§‚',
            'â• æ–°å¢é¸½å­ï¼šæ·»åŠ æ–°çš„ä¿¡é¸½æ¡£æ¡ˆ',
            'ğŸ” æŸ¥çœ‹è¯¦æƒ…ï¼šç‚¹å‡»æŸ¥çœ‹æŒ‰é’®æŸ¥çœ‹é¸½å­çš„è¯¦ç»†ä¿¡æ¯'
          ]
        },
        'è¡€ç»Ÿå…³ç³»': {
          description: 'æŸ¥çœ‹å’Œç®¡ç†ä¿¡é¸½çš„è¡€ç»Ÿå…³ç³»æ ‘',
          features: [
            'ğŸŒ³ è¡€ç»Ÿæ ‘ï¼šé€‰æ‹©é¸½å­æŸ¥çœ‹å…¶å®Œæ•´çš„è¡€ç»Ÿå…³ç³»æ ‘ï¼ˆåŒ…æ‹¬äº²ä»£å’Œå­ä»£ï¼‰',
            'ğŸ” æœç´¢åŠŸèƒ½ï¼šé€šè¿‡è¶³ç¯å·æˆ–åå­—æœç´¢é¸½å­',
            'ğŸ“Š ç§é¸½æ ‘ï¼šæ˜¾ç¤ºæ‰€æœ‰ç§é¸½çš„å…³ç³»æ ‘'
          ]
        },
        'ç»Ÿè®¡åˆ†æ': {
          description: 'æŸ¥çœ‹å¹´åº¦ç»Ÿè®¡æ•°æ®',
          features: [
            'ğŸ“ˆ å¹´åº¦ç»Ÿè®¡æ¦‚è§ˆï¼šæŒ‰å¹´ä»½æ±‡æ€»å‡ºç”Ÿæ•°é‡ã€æ­»äº¡æ•°é‡ä»¥åŠæœ‰å‚èµ›è®°å½•çš„é¸½å­æ•°é‡',
            'ğŸ“Š æ•°æ®è¡¨æ ¼ï¼šä»¥è¡¨æ ¼å½¢å¼å±•ç¤ºç»Ÿè®¡æ•°æ®'
          ]
        },
        'æ¯”èµ›ä¸æˆç»©': {
          description: 'ç®¡ç†æ¯”èµ›å’Œæˆç»©è®°å½•',
          features: [
            'ğŸ“‹ æ¯”èµ›åˆ—è¡¨ï¼šæŸ¥çœ‹æ‰€æœ‰æ¯”èµ›ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¯”èµ›åç§°ã€æ—¥æœŸã€åœ°ç‚¹ã€è·ç¦»ã€çŠ¶æ€ã€å‚èµ›æ•°',
            'ğŸ“¥ å¯¼å…¥æˆç»©ï¼šä»Excelæ–‡ä»¶å¯¼å…¥æ¯”èµ›æˆç»©',
            'ğŸ“Š æ¯”èµ›ç»Ÿè®¡ï¼šæŸ¥çœ‹æ¯”èµ›ç»Ÿè®¡æ•°æ®',
            'ğŸ§  æˆç»©åˆ†æï¼šåˆ†ææ¯”èµ›æˆç»©è¶‹åŠ¿',
            'ğŸ§¬ è¡€ç»Ÿå¯¹æ¯”ï¼šå¯¹æ¯”ä¸åŒè¡€ç»Ÿçš„é¸½å­è¡¨ç°'
          ]
        },
        'ç¹è‚²ä¸é…å¯¹': {
          description: 'ç®¡ç†ä¿¡é¸½çš„ç¹è‚²å’Œé…å¯¹',
          features: [
            'ğŸ’• é…å¯¹é€‰æ‹©ï¼šé€‰æ‹©çˆ¶é¸½å’Œæ¯é¸½è¿›è¡Œé…å¯¹',
            'ğŸ“Š é…å¯¹åˆ†æï¼šç³»ç»Ÿè‡ªåŠ¨åˆ†æé…å¯¹å¯è¡Œæ€§',
            'â• æ–°å¢é…å¯¹ï¼šæ·»åŠ æ–°çš„é…å¯¹è®°å½•'
          ]
        },
        'å¥åº·ç®¡ç†': {
          description: 'ç®¡ç†ä¿¡é¸½çš„å¥åº·è®°å½•',
          features: [
            'ğŸ“ å¥åº·è®°å½•ï¼šè®°å½•é¸½å­çš„å¥åº·çŠ¶æ€ã€æ—¥æœŸã€å¤‡æ³¨ç­‰ä¿¡æ¯',
            'â• æ–°å¢è®°å½•ï¼šæ·»åŠ æ–°çš„å¥åº·è®°å½•',
            'ğŸ“‹ è®°å½•åˆ—è¡¨ï¼šæŸ¥çœ‹æ‰€æœ‰å¥åº·è®°å½•'
          ]
        },
        'æ™ºèƒ½åˆ†æä¸­å¿ƒ': {
          description: 'ä½¿ç”¨AIè¿›è¡Œæ™ºèƒ½åˆ†æ',
          features: [
            'ğŸ“Š è¡€ç»Ÿåˆ†æï¼šåˆ†æé¸½å­çš„è¡€ç»Ÿä¼˜åŠ¿å’Œé—ä¼ ç‰¹å¾',
            'ğŸ† æˆç»©åˆ†æï¼šåˆ†æé¸½å­çš„æ¯”èµ›è¡¨ç°å’Œæˆç»©è¶‹åŠ¿',
            'ğŸ’• é…å¯¹å»ºè®®ï¼šåŸºäºAIç®—æ³•çš„æ™ºèƒ½é…å¯¹æ¨è'
          ]
        },
        'è®­ç»ƒæ¨¡å—': {
          description: 'ç®¡ç†ä¿¡é¸½çš„è®­ç»ƒè®°å½•',
          features: [
            'ğŸ“ è®­ç»ƒè®°å½•ï¼šè®°å½•è®­ç»ƒæ—¥æœŸã€é¸½å­ã€è®­ç»ƒç±»å‹ã€è·ç¦»ã€ç”¨æ—¶ç­‰ä¿¡æ¯',
            'â• æ–°å¢è®°å½•ï¼šæ·»åŠ æ–°çš„è®­ç»ƒè®°å½•',
            'ğŸ“‹ è®°å½•åˆ—è¡¨ï¼šæŸ¥çœ‹æ‰€æœ‰è®­ç»ƒè®°å½•'
          ]
        },
        'èƒ½åŠ›ç»¼åˆåˆ†æ': {
          description: 'ç»¼åˆåˆ†æé¸½å­çš„å„é¡¹èƒ½åŠ›æŒ‡æ ‡',
          features: [
            'ğŸ† æ¯”èµ›èƒ½åŠ›ï¼šè¯„ä¼°é¸½å­çš„æ¯”èµ›è¡¨ç°èƒ½åŠ›',
            'ğŸ§¬ é—ä¼ ä»·å€¼ï¼šè¯„ä¼°é¸½å­çš„é—ä¼ ä»·å€¼',
            'ğŸ’ª å¥åº·æŒ‡æ•°ï¼šè¯„ä¼°é¸½å­çš„å¥åº·çŠ¶å†µ',
            'â­ ç»¼åˆè¯„åˆ†ï¼šç»¼åˆå„é¡¹æŒ‡æ ‡ç»™å‡ºæ€»ä½“è¯„åˆ†'
          ]
        }
      }
    };
    
    // åŠ è½½Evoè®¾ç½®
    // ä»æœåŠ¡å™¨åŠ è½½Evoè®¾ç½®ï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
    async function loadEvoSettings() {
      try {
        const token = getAuthToken();
        if (!token) {
          console.warn('æœªç™»å½•ï¼Œæ— æ³•åŠ è½½Evoè®¾ç½®');
          return;
        }
        
        // ä»æœåŠ¡å™¨åŠ è½½è®¾ç½®
        const response = await fetch(`${getApiUrl()}/admin/evo-settings`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        let settings = defaultEvoSettings;
        
        if (response.ok) {
          const result = await response.json();
          if (result.success && result.data) {
            settings = result.data;
            // ä¿å­˜åˆ°localStorageä½œä¸ºç¼“å­˜
            localStorage.setItem(EVO_SETTINGS_KEY, JSON.stringify(settings));
          }
        } else {
          // å¦‚æœæœåŠ¡å™¨åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨localStorageç¼“å­˜
          const saved = localStorage.getItem(EVO_SETTINGS_KEY);
          if (saved) {
            settings = JSON.parse(saved);
          }
        }
        
        // å¡«å……è¡¨å•
        document.getElementById('evoEnabled').checked = settings.enabled !== false;
        document.getElementById('evoPosition').value = settings.position || 'bottom-right';
        document.getElementById('evoDisplayMode').value = settings.displayMode || 'always';
        document.getElementById('evoAutoClose').value = settings.autoClose || 5;
        
        // æ¸²æŸ“åŠŸèƒ½ä½¿ç”¨è¯´æ˜ï¼ˆå¦‚æœå‡½æ•°å­˜åœ¨ï¼‰
        if (typeof renderFunctionGuides === 'function') {
          renderFunctionGuides(settings.functionGuides || defaultEvoSettings.functionGuides);
        }
        document.getElementById('evoIconSize').value = settings.iconSize || 70;
        document.getElementById('evoIconSizeValue').textContent = (settings.iconSize || 70) + 'px';
        
        // è®¾ç½®ä¸»é¢˜å•é€‰æŒ‰é’®
        const themeRadios = document.querySelectorAll('input[name="evoTheme"]');
        themeRadios.forEach(radio => {
          if (radio.value === (settings.theme || 'purple')) {
            radio.checked = true;
          }
        });
        
        document.getElementById('evoShowWelcome').checked = settings.showWelcome !== false;
        document.getElementById('evoSaveHistory').checked = settings.saveHistory !== false;
        document.getElementById('evoShowAnalytics').checked = settings.showAnalytics !== false;
        document.getElementById('evoShowRecommendations').checked = settings.showRecommendations !== false;
        
        // GitHubé…ç½®
        if (settings.github) {
          document.getElementById('evoGithubRepo').value = settings.github.repo || '';
          document.getElementById('evoGithubToken').value = settings.github.token || '';
          document.getElementById('evoGithubApiEndpoint').value = settings.github.apiEndpoint || '';
        }
        
        // å›¾æ ‡å¤§å°æ»‘å—äº‹ä»¶
        const iconSizeSlider = document.getElementById('evoIconSize');
        if (iconSizeSlider) {
          iconSizeSlider.addEventListener('input', (e) => {
            document.getElementById('evoIconSizeValue').textContent = e.target.value + 'px';
          });
        }
      } catch (error) {
        console.error('åŠ è½½Evoè®¾ç½®å¤±è´¥:', error);
        // ä½¿ç”¨localStorageä½œä¸ºå¤‡ç”¨
        const saved = localStorage.getItem(EVO_SETTINGS_KEY);
        if (saved) {
          const settings = JSON.parse(saved);
          document.getElementById('evoEnabled').checked = settings.enabled !== false;
          document.getElementById('evoPosition').value = settings.position || 'bottom-right';
          // ... å…¶ä»–å­—æ®µå¡«å……ï¼ˆåŒä¸Šï¼‰
        }
      }
    }
    
    // æ¸²æŸ“åŠŸèƒ½ä½¿ç”¨è¯´æ˜
    function renderFunctionGuides(functionGuides) {
      const container = document.getElementById('functionGuidesContainer');
      if (!container) return;
      
      container.innerHTML = '';
      
      Object.entries(functionGuides).forEach(([funcName, guide]) => {
        const guideItem = document.createElement('div');
        guideItem.className = 'function-guide-item';
        guideItem.style.cssText = `
          border: 1px solid var(--border-medium);
          border-radius: 8px;
          padding: 16px;
          background: var(--bg-secondary);
        `;
        
        guideItem.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <h4 style="margin: 0; color: var(--text-primary);">${funcName}</h4>
            <button type="button" class="btn btn-sm btn-outline" onclick="editFunctionGuide('${funcName}')" style="padding: 4px 12px;">ç¼–è¾‘</button>
          </div>
          <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">${guide.description}</div>
          <div style="font-size: 13px; color: var(--text-muted);">
            <strong>åŠŸèƒ½ç‚¹ï¼š</strong>${guide.features.length} é¡¹
          </div>
        `;
        
        container.appendChild(guideItem);
      });
    }
    
    // ç¼–è¾‘åŠŸèƒ½è¯´æ˜
    window.editFunctionGuide = function(funcName) {
      const functionGuides = getFunctionGuidesFromSettings();
      const guide = functionGuides[funcName] || { description: '', features: [] };
      
      const description = prompt(`ç¼–è¾‘"${funcName}"çš„æè¿°ï¼š`, guide.description);
      if (description === null) return;
      
      const featuresStr = prompt(`ç¼–è¾‘"${funcName}"çš„åŠŸèƒ½ç‚¹ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š`, guide.features.join('\n'));
      if (featuresStr === null) return;
      
      const features = featuresStr.split('\n').filter(f => f.trim());
      
      functionGuides[funcName] = {
        description: description.trim(),
        features: features
      };
      
      renderFunctionGuides(functionGuides);
      showEvoSettingsStatus('åŠŸèƒ½è¯´æ˜å·²æ›´æ–°ï¼Œè¯·ç‚¹å‡»"ä¿å­˜è®¾ç½®"ä¿å­˜', 'info');
    };
    
    // ä»è®¾ç½®ä¸­è·å–åŠŸèƒ½è¯´æ˜
    function getFunctionGuidesFromSettings() {
      const container = document.getElementById('functionGuidesContainer');
      if (!container) return defaultEvoSettings.functionGuides;
      
      // ä»å½“å‰æ˜¾ç¤ºçš„è®¾ç½®ä¸­è·å–ï¼ˆå®é™…åº”è¯¥ä»è¡¨å•æˆ–è®¾ç½®å¯¹è±¡ä¸­è·å–ï¼‰
      // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€
      try {
        const saved = localStorage.getItem(EVO_SETTINGS_KEY);
        if (saved) {
          const settings = JSON.parse(saved);
          return settings.functionGuides || defaultEvoSettings.functionGuides;
        }
      } catch (e) {}
      
      return defaultEvoSettings.functionGuides;
    }
    
    // ä¿å­˜Evoè®¾ç½®åˆ°æœåŠ¡å™¨ï¼ˆç®¡ç†å‘˜æƒé™ï¼Œä¸»ç«™ä¼šè‡ªåŠ¨åŒæ­¥ï¼‰
    async function saveEvoSettings() {
      try {
        const settings = {
          enabled: document.getElementById('evoEnabled').checked,
          position: document.getElementById('evoPosition').value,
          displayMode: document.getElementById('evoDisplayMode').value,
          autoClose: parseInt(document.getElementById('evoAutoClose').value) || 5,
          iconSize: parseInt(document.getElementById('evoIconSize').value) || 70,
          theme: document.querySelector('input[name="evoTheme"]:checked')?.value || 'purple',
          showWelcome: document.getElementById('evoShowWelcome').checked,
          saveHistory: document.getElementById('evoSaveHistory').checked,
          showAnalytics: document.getElementById('evoShowAnalytics').checked,
          showRecommendations: document.getElementById('evoShowRecommendations').checked,
          github: {
            repo: document.getElementById('evoGithubRepo').value.trim(),
            token: document.getElementById('evoGithubToken').value.trim(),
            apiEndpoint: document.getElementById('evoGithubApiEndpoint').value.trim()
          },
          functionGuides: getFunctionGuidesFromSettings()
        };
        
        // ç›´æ¥ä¿å­˜åˆ°æœåŠ¡å™¨ï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
        const token = getAuthToken();
        if (!token) {
          throw new Error('è¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦å·');
        }
        
        const response = await fetch(`${getApiUrl()}/admin/evo-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(settings)
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            // ä¿å­˜åˆ°localStorageä½œä¸ºç¼“å­˜
            localStorage.setItem(EVO_SETTINGS_KEY, JSON.stringify(result.data));
            
            // è®¾ç½®åŒæ­¥æ ‡å¿—ï¼Œä¸»ç«™ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶åŒæ­¥
            localStorage.setItem(EVO_SYNC_KEY, 'true');
            localStorage.setItem('evo_settings_sync_timestamp', Date.now().toString());
            
            showEvoSettingsStatus('âœ… è®¾ç½®å·²ä¿å­˜åˆ°æœåŠ¡å™¨ï¼ä¸»ç«™å°†è‡ªåŠ¨æ›´æ–°ã€‚', 'success');
            console.log('âœ… Evoè®¾ç½®å·²ä¿å­˜åˆ°æœåŠ¡å™¨ï¼Œä¸»ç«™å°†è‡ªåŠ¨åŒæ­¥');
            
            return result.data;
          } else {
            throw new Error(result.error || 'ä¿å­˜å¤±è´¥');
          }
        } else {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || 'æœåŠ¡å™¨å“åº”é”™è¯¯');
        }
      } catch (error) {
        console.error('ä¿å­˜Evoè®¾ç½®å¤±è´¥:', error);
        showEvoSettingsStatus('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
        return null;
      }
    }
    
    // é‡ç½®ä¸ºé»˜è®¤è®¾ç½®
    function resetEvoSettings() {
      if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤è®¾ç½®å—ï¼Ÿ')) {
        localStorage.removeItem(EVO_SETTINGS_KEY);
        loadEvoSettings();
        showEvoSettingsStatus('å·²é‡ç½®ä¸ºé»˜è®¤è®¾ç½®', 'info');
      }
    }
    
    // åŒæ­¥åˆ°ä¸»ç«™ï¼ˆå·²é›†æˆåˆ°saveEvoSettingsä¸­ï¼Œæ­¤å‡½æ•°ä¿ç•™ç”¨äºæ‰‹åŠ¨è§¦å‘ï¼‰
    async function syncEvoSettingsToMainSite() {
      try {
        // å…ˆä¿å­˜è®¾ç½®
        const settings = await saveEvoSettings();
        if (settings) {
          showEvoSettingsStatus('âœ… è®¾ç½®å·²ä¿å­˜å¹¶åŒæ­¥ï¼ä¸»ç«™å°†è‡ªåŠ¨æ›´æ–°ã€‚', 'success');
          
          // å¯é€‰ï¼šæ‰“å¼€ä¸»ç«™æŸ¥çœ‹æ•ˆæœ
          const mainSiteUrl = window.location.origin.replace('/admin.html', '/index.html');
          if (confirm('è®¾ç½®å·²ä¿å­˜ï¼æ˜¯å¦ç°åœ¨æ‰“å¼€ä¸»ç«™æŸ¥çœ‹æ•ˆæœï¼Ÿ')) {
            window.open(mainSiteUrl, '_blank');
          }
        }
      } catch (error) {
        console.error('åŒæ­¥åˆ°ä¸»ç«™å¤±è´¥:', error);
        showEvoSettingsStatus('âŒ åŒæ­¥å¤±è´¥ï¼š' + error.message, 'error');
      }
    }
    
    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showEvoSettingsStatus(message, type = 'info') {
      const statusEl = document.getElementById('evoSettingsStatus');
      if (!statusEl) return;
      
      statusEl.style.display = 'block';
      statusEl.textContent = message;
      
      // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
      statusEl.style.background = type === 'success' ? 'var(--success-light)' : 
                                  type === 'error' ? 'var(--danger-light)' : 
                                  'var(--primary-50)';
      statusEl.style.color = type === 'success' ? 'var(--success)' : 
                             type === 'error' ? 'var(--danger)' : 
                             'var(--primary)';
      statusEl.style.border = `1px solid ${type === 'success' ? 'var(--success)' : 
                                            type === 'error' ? 'var(--danger)' : 
                                            'var(--primary)'}`;
      
      // 3ç§’åè‡ªåŠ¨éšè—
      setTimeout(() => {
        statusEl.style.display = 'none';
      }, 3000);
    }
    
    // åŠ è½½AIæ¨¡å‹ä¿¡æ¯ï¼ˆæ™ºèƒ½ç®¡ç†ï¼‰
    async function loadAdminAIModelInfo() {
      try {
        const token = getAuthToken();
        if (!token) return;
        
        const response = await fetch(`${getApiUrl()}/evo/model-info`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.data) {
            displayAdminAIModelInfo(data.data);
          }
        }
      } catch (error) {
        console.error('åŠ è½½AIæ¨¡å‹ä¿¡æ¯å¤±è´¥:', error);
        // ä½¿ç”¨é»˜è®¤ä¿¡æ¯
        displayAdminAIModelInfo({
          name: 'Zephyr-7B-Beta',
          provider: 'Hugging Face',
          source: 'https://huggingface.co/HuggingFaceH4/zephyr-7b-beta',
          free: true,
          features: ['å®Œå…¨å…è´¹ä½¿ç”¨', 'æ— éœ€ä¿¡ç”¨å¡', 'æ”¯æŒä¸­æ–‡å¯¹è¯', 'é«˜æ€§èƒ½å“åº”', 'å¼€æºæ¨¡å‹']
        });
      }
    }
    
    // æ˜¾ç¤ºAIæ¨¡å‹ä¿¡æ¯ï¼ˆæ™ºèƒ½ç®¡ç†ï¼‰
    function displayAdminAIModelInfo(modelInfo) {
      if (!modelInfo) return;
      
      const nameEl = document.getElementById('adminAIModelName');
      const providerEl = document.getElementById('adminAIProvider');
      const sourceEl = document.getElementById('adminAISource');
      const statusEl = document.getElementById('adminAIStatus');
      const featuresEl = document.getElementById('adminAIFeatures');
      
      if (nameEl) nameEl.textContent = modelInfo.name || 'æœªçŸ¥';
      if (providerEl) providerEl.textContent = modelInfo.provider || 'æœªçŸ¥';
      if (sourceEl) {
        sourceEl.href = modelInfo.source || '#';
        sourceEl.textContent = modelInfo.source ? 'æŸ¥çœ‹æ¨¡å‹è¯¦æƒ…' : 'æœªçŸ¥';
      }
      
      if (statusEl) {
        statusEl.textContent = modelInfo.free ? 'âœ… å…è´¹ä½¿ç”¨' : 'ğŸ’° ä»˜è´¹';
        statusEl.style.background = modelInfo.free ? 'rgba(76, 175, 80, 0.3)' : 'rgba(255, 152, 0, 0.3)';
      }
      
      if (featuresEl && modelInfo.features) {
        featuresEl.innerHTML = modelInfo.features.map(f => `â€¢ ${f}`).join('<br>');
      }
    }
    
    // æµ‹è¯•AIè¿æ¥ï¼ˆæ™ºèƒ½ç®¡ç†ï¼‰
    async function testAdminAIConnection() {
      const btn = document.getElementById('btnAdminTestAI');
      const statusEl = document.getElementById('adminAIStatus');
      
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'æµ‹è¯•ä¸­...';
      }
      
      if (statusEl) {
        statusEl.textContent = 'æµ‹è¯•ä¸­...';
        statusEl.style.background = 'rgba(255, 152, 0, 0.3)';
      }
      
      try {
        const token = getAuthToken();
        if (!token) {
          throw new Error('è¯·å…ˆç™»å½•');
        }
        
        const response = await fetch(`${getApiUrl()}/evo/test`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          if (statusEl) {
            statusEl.textContent = 'âœ… è¿æ¥æ­£å¸¸';
            statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
          }
          alert('AI è¿æ¥æµ‹è¯•æˆåŠŸï¼\n\næ¨¡å‹ï¼š' + (data.data?.model || 'æœªçŸ¥') + '\næä¾›å•†ï¼š' + (data.data?.provider || 'æœªçŸ¥'));
        } else {
          throw new Error(data.message || 'è¿æ¥å¤±è´¥');
        }
      } catch (error) {
        if (statusEl) {
          statusEl.textContent = 'âŒ è¿æ¥å¤±è´¥';
          statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
        }
        alert('AI è¿æ¥æµ‹è¯•å¤±è´¥ï¼š' + error.message);
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'æµ‹è¯• AI è¿æ¥';
        }
      }
    }
    
    // ç”¨æˆ·ä¿¡æ¯å’Œè®¾ç½®æ¨¡æ€æ¡†å‡½æ•°
    // åŠ è½½ç”¨æˆ·è®¾ç½®
    function loadUserSettings() {
      try {
        const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
        return {
          avatar: settings.avatar || null,
          displayName: settings.displayName || null
        };
      } catch (e) {
        console.error('åŠ è½½ç”¨æˆ·è®¾ç½®å¤±è´¥:', e);
        return { avatar: null, displayName: null };
      }
    }
    
    // ä¿å­˜ç”¨æˆ·è®¾ç½®
    function saveUserSettings(settings) {
      try {
        localStorage.setItem('userSettings', JSON.stringify(settings));
        return true;
      } catch (e) {
        console.error('ä¿å­˜ç”¨æˆ·è®¾ç½®å¤±è´¥:', e);
        return false;
      }
    }
    
    // æ›´æ–°é¡¶éƒ¨å¯¼èˆªæ çš„ç”¨æˆ·æ˜¾ç¤º
    function updateTopBarUserDisplay() {
      const settings = loadUserSettings();
      const adminUserName = document.getElementById('adminUserName');
      const btnUserAvatar = document.getElementById('btnUserAvatar');
      
      // æ›´æ–°ç”¨æˆ·åæ˜¾ç¤º
      if (adminUserName) {
        const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
        const displayName = settings.displayName || userInfo.username || 'ç®¡ç†å‘˜';
        adminUserName.textContent = `æ¬¢è¿ï¼Œ${displayName}`;
      }
      
      // æ›´æ–°è´¦æˆ·æŒ‰é’®
      if (btnUserAvatar) {
        const avatarSpan = btnUserAvatar.querySelector('span:first-child');
        const textSpan = btnUserAvatar.querySelector('span:last-child');
        
        if (settings.avatar) {
          // å¦‚æœæœ‰è‡ªå®šä¹‰å¤´åƒï¼Œæ˜¾ç¤ºå¤´åƒå›¾ç‰‡
          if (!avatarSpan || avatarSpan.textContent === 'ğŸ‘¤') {
            const img = document.createElement('img');
            img.src = settings.avatar;
            img.style.cssText = 'width:20px;height:20px;border-radius:50%;object-fit:cover;';
            if (avatarSpan) {
              avatarSpan.replaceWith(img);
            } else {
              btnUserAvatar.insertBefore(img, textSpan);
            }
          } else if (avatarSpan.tagName === 'IMG') {
            avatarSpan.src = settings.avatar;
          }
        } else {
          // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰å¤´åƒï¼Œæ˜¾ç¤ºé»˜è®¤å›¾æ ‡
          if (avatarSpan && avatarSpan.tagName === 'IMG') {
            const span = document.createElement('span');
            span.textContent = 'ğŸ‘¤';
            span.style.fontSize = '16px';
            avatarSpan.replaceWith(span);
          }
        }
        
        if (textSpan) {
          const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
          const displayName = settings.displayName || userInfo.username || 'è´¦æˆ·';
          textSpan.textContent = displayName.length > 8 ? displayName.substring(0, 8) + '...' : displayName;
        }
      }
    }
    
    window.showUserInfoModal = function() {
      const modal = document.getElementById('userInfoModal');
      if (!modal) return;
      
      // åˆ‡æ¢åˆ°æŸ¥çœ‹æ¨¡å¼
      document.getElementById('userInfoViewMode').style.display = 'block';
      document.getElementById('userInfoEditMode').style.display = 'none';
      
      // ä»localStorageæˆ–å½“å‰ç™»å½•ä¿¡æ¯è·å–ç”¨æˆ·æ•°æ®
      const adminUserName = document.getElementById('adminUserName')?.textContent || '';
      const userNameMatch = adminUserName.match(/æ¬¢è¿ï¼Œ(.+)/);
        const defaultUserName = userNameMatch ? userNameMatch[1] : 'ç®¡ç†å‘˜';
      
      // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆä»localStorageæˆ–APIï¼‰
      const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
      const userSettings = loadUserSettings();
      const userName = userSettings.displayName || defaultUserName;
      const userEmail = userInfo.email || 'admin@example.com';
      const userType = userInfo.type || 'ç®¡ç†å‘˜';
      const registerDate = userInfo.registerDate || new Date().toISOString().split('T')[0];
      const userRole = userInfo.role || 'ç®¡ç†å‘˜';
      
      // æ›´æ–°æ˜¾ç¤º
      const avatarDisplay = document.getElementById('userAvatarDisplay');
      if (userSettings.avatar) {
        avatarDisplay.style.backgroundImage = `url(${userSettings.avatar})`;
        avatarDisplay.textContent = '';
      } else {
        avatarDisplay.style.backgroundImage = '';
        avatarDisplay.textContent = 'ğŸ‘¤';
      }
      
      document.getElementById('userNameDisplay').textContent = userName;
      document.getElementById('userEmailDisplay').textContent = userEmail;
      document.getElementById('userTypeDisplay').textContent = userType;
      document.getElementById('userRegisterDate').textContent = registerDate;
      document.getElementById('userRoleDisplay').textContent = userRole;
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      modal.style.display = 'flex';
    };
    
    // è¿›å…¥ç¼–è¾‘æ¨¡å¼
    window.enterEditUserInfoMode = function() {
      document.getElementById('userInfoViewMode').style.display = 'none';
      document.getElementById('userInfoEditMode').style.display = 'block';
      
      // åŠ è½½å½“å‰è®¾ç½®
      const userSettings = loadUserSettings();
      const adminUserName = document.getElementById('adminUserName')?.textContent || '';
      const userNameMatch = adminUserName.match(/æ¬¢è¿ï¼Œ(.+)/);
        const defaultUserName = userNameMatch ? userNameMatch[1] : 'ç®¡ç†å‘˜';
      const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
      
      // è®¾ç½®å¤´åƒæ˜¾ç¤º
      const avatarEditDisplay = document.getElementById('userAvatarEditDisplay');
      if (userSettings.avatar) {
        avatarEditDisplay.style.backgroundImage = `url(${userSettings.avatar})`;
        avatarEditDisplay.textContent = '';
      } else {
        avatarEditDisplay.style.backgroundImage = '';
        avatarEditDisplay.textContent = 'ğŸ‘¤';
      }
      
      // è®¾ç½®åå­—è¾“å…¥æ¡†
      document.getElementById('userNameInput').value = userSettings.displayName || defaultUserName;
      
      // ç»‘å®šå¤´åƒä¸Šä¼ äº‹ä»¶
      const avatarInput = document.getElementById('userAvatarInput');
      if (avatarInput) {
        avatarInput.onchange = function(e) {
          const file = e.target.files[0];
          if (file) {
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º2MBï¼‰
            if (file.size > 2 * 1024 * 1024) {
              alert('å¤´åƒæ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡2MB');
              return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
              alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
              return;
            }
            
            // è¯»å–æ–‡ä»¶å¹¶è½¬æ¢ä¸ºbase64
            const reader = new FileReader();
            reader.onload = function(e) {
              const base64 = e.target.result;
              avatarEditDisplay.style.backgroundImage = `url(${base64})`;
              avatarEditDisplay.textContent = '';
            };
            reader.readAsDataURL(file);
          }
        };
      }
    };
    
    // å–æ¶ˆç¼–è¾‘
    window.cancelEditUserInfo = function() {
      document.getElementById('userInfoViewMode').style.display = 'block';
      document.getElementById('userInfoEditMode').style.display = 'none';
      showUserInfoModal(); // é‡æ–°åŠ è½½æ˜¾ç¤º
    };
    
    // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
    window.saveUserInfo = function() {
      const userNameInput = document.getElementById('userNameInput');
      const avatarInput = document.getElementById('userAvatarInput');
      const avatarEditDisplay = document.getElementById('userAvatarEditDisplay');
      
      const displayName = userNameInput.value.trim();
      if (!displayName) {
        alert('è¯·è¾“å…¥æ˜µç§°');
        return;
      }
      
      // è·å–å¤´åƒï¼ˆbase64ï¼‰
      let avatar = null;
      if (avatarEditDisplay.style.backgroundImage && avatarEditDisplay.style.backgroundImage !== 'none') {
        avatar = avatarEditDisplay.style.backgroundImage.replace('url("', '').replace('")', '').replace("url('", '').replace("')", '');
      }
      
      // ä¿å­˜è®¾ç½®
      const success = saveUserSettings({
        avatar: avatar,
        displayName: displayName
      });
      
      if (success) {
        // æ›´æ–°é¡¶éƒ¨å¯¼èˆªæ 
        updateTopBarUserDisplay();
        
        // åˆ‡æ¢å›æŸ¥çœ‹æ¨¡å¼å¹¶åˆ·æ–°
        cancelEditUserInfo();
        alert('ä¿å­˜æˆåŠŸï¼');
      } else {
        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    };
    
    window.closeUserInfoModal = function() {
      const modal = document.getElementById('userInfoModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };
    
    window.showSettingsModal = function() {
      const modal = document.getElementById('settingsModal');
      if (!modal) return;
      modal.style.display = 'flex';
      // æ›´æ–°ä¸»é¢˜æŒ‰é’®æ–‡æœ¬
      const themeBtn = document.getElementById('btnToggleThemeInModal');
      if (themeBtn) {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        themeBtn.textContent = currentTheme === 'dark' ? 'â˜€ï¸ æµ…è‰²æ¨¡å¼' : 'ğŸŒ™ å¤œé—´æ¨¡å¼';
        themeBtn.title = currentTheme === 'dark' ? 'åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼' : 'åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼';
      }
    };
    
    window.closeSettingsModal = function() {
      const modal = document.getElementById('settingsModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };
    
    // æ•°æ®å¯¼å‡ºå’Œå¯¼å…¥åŠŸèƒ½
    window.exportAllData = function() {
      try {
        // ä»localStorageè¯»å–ä¸»ç«™æ•°æ®
        const pigeonsData = JSON.parse(localStorage.getItem('pigeons') || '[]');
        const racesData = JSON.parse(localStorage.getItem('races') || '[]');
        const pairingsData = JSON.parse(localStorage.getItem('pairings') || '[]');
        const healthRecordsData = JSON.parse(localStorage.getItem('healthRecords') || '[]');
        const usedNamesData = JSON.parse(localStorage.getItem('usedNames') || '[]');
        const ownerRegionPairsData = JSON.parse(localStorage.getItem('ownerRegionPairs') || '[]');
        
        const exportData = {
          version: '2.0',
          exportDate: new Date().toISOString(),
          data: {
            pigeons: pigeonsData,
            races: racesData,
            pairings: pairingsData,
            healthRecords: healthRecordsData,
            usedNames: usedNamesData,
            ownerRegionPairs: ownerRegionPairsData
          }
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pigeon_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('æ•°æ®å¤‡ä»½å·²ä¸‹è½½ï¼\n\nå¤‡ä»½äº† ' + pigeonsData.length + ' åªé¸½å­çš„æ•°æ®ã€‚\nè¯·å¦¥å–„ä¿ç®¡å¤‡ä»½æ–‡ä»¶ã€‚');
      } catch (error) {
        console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
        alert('å¯¼å‡ºæ•°æ®å¤±è´¥ï¼š' + error.message);
      }
    };
    
    window.importBackupData = function(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const backupData = JSON.parse(e.target.result);
          
          if (!backupData.data || !backupData.data.pigeons) {
            alert('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼');
            return;
          }
          
          if (!confirm(`ç¡®å®šè¦æ¢å¤å¤‡ä»½æ•°æ®å—ï¼Ÿ\n\nå¤‡ä»½æ—¶é—´: ${backupData.exportDate}\né¸½å­æ•°é‡: ${backupData.data.pigeons.length}\næ¯”èµ›æ•°é‡: ${backupData.data.races?.length || 0}\n\nâš ï¸ è¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼`)) {
            return;
          }
          
          // æ¢å¤æ•°æ®åˆ°localStorage
          localStorage.setItem('pigeons', JSON.stringify(backupData.data.pigeons));
          
          if (backupData.data.races) {
            localStorage.setItem('races', JSON.stringify(backupData.data.races));
          }
          
          if (backupData.data.pairings) {
            localStorage.setItem('pairings', JSON.stringify(backupData.data.pairings));
          }
          
          if (backupData.data.healthRecords) {
            localStorage.setItem('healthRecords', JSON.stringify(backupData.data.healthRecords));
          }
          
          if (backupData.data.usedNames) {
            localStorage.setItem('usedNames', JSON.stringify(backupData.data.usedNames));
          }
          
          if (backupData.data.ownerRegionPairs) {
            localStorage.setItem('ownerRegionPairs', JSON.stringify(backupData.data.ownerRegionPairs));
          }
          
          alert('æ•°æ®æ¢å¤æˆåŠŸï¼\n\nå·²æ¢å¤ ' + backupData.data.pigeons.length + ' åªé¸½å­çš„æ•°æ®ã€‚\nè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹æ›´æ–°ã€‚');
        } catch (error) {
          console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
          alert('å¯¼å…¥æ•°æ®å¤±è´¥ï¼š' + error.message);
        }
      };
      reader.readAsText(file);
    };
    
    // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    function initAdminUserInfo() {
      const userInfo = localStorage.getItem('adminUserInfo');
      if (!userInfo) {
        const adminUserName = document.getElementById('adminUserName')?.textContent || '';
        const userNameMatch = adminUserName.match(/æ¬¢è¿ï¼Œ(.+)/);
        const userName = userNameMatch ? userNameMatch[1] : 'ç®¡ç†å‘˜';
        
        const defaultUserInfo = {
          name: userName,
          email: 'admin@example.com',
          type: 'ç®¡ç†å‘˜',
          role: 'ç®¡ç†å‘˜',
          registerDate: new Date().toISOString().split('T')[0]
        };
        localStorage.setItem('adminUserInfo', JSON.stringify(defaultUserInfo));
      }
    }
    
    // ç»‘å®šç”¨æˆ·å¤´åƒå’Œè®¾ç½®æŒ‰é’®äº‹ä»¶
    function bindUserButtons() {
      // ç»‘å®šç”¨æˆ·å¤´åƒæŒ‰é’®
      const btnUserAvatar = document.getElementById('btnUserAvatar');
      if (btnUserAvatar) {
        btnUserAvatar.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          showUserInfoModal();
        });
        
        // é¡µé¢åŠ è½½æ—¶æ›´æ–°é¡¶éƒ¨å¯¼èˆªæ çš„ç”¨æˆ·æ˜¾ç¤º
        updateTopBarUserDisplay();
      }
      
      // ç»‘å®šè®¾ç½®æŒ‰é’®
      const btnSettings = document.getElementById('btnSettings');
      if (btnSettings) {
        btnSettings.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          showSettingsModal();
        });
      }
      
      // ç»‘å®šè®¾ç½®æ¨¡æ€æ¡†å†…çš„æŒ‰é’®
      const btnToggleThemeInModal = document.getElementById('btnToggleThemeInModal');
      if (btnToggleThemeInModal) {
        btnToggleThemeInModal.addEventListener('click', function() {
          const themeToggle = document.getElementById('themeToggle');
          if (themeToggle) {
            themeToggle.click();
          }
          // æ›´æ–°æŒ‰é’®æ–‡æœ¬
          setTimeout(() => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            btnToggleThemeInModal.textContent = currentTheme === 'dark' ? 'â˜€ï¸ æµ…è‰²æ¨¡å¼' : 'ğŸŒ™ å¤œé—´æ¨¡å¼';
            btnToggleThemeInModal.title = currentTheme === 'dark' ? 'åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼' : 'åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼';
          }, 100);
        });
      }
      
      // ç»‘å®šæ•°æ®ç®¡ç†æŒ‰é’®
      const btnBackupDataInModal = document.getElementById('btnBackupDataInModal');
      if (btnBackupDataInModal) {
        btnBackupDataInModal.addEventListener('click', function() {
          exportAllData();
        });
      }
      
      const btnExportDataInModal = document.getElementById('btnExportDataInModal');
      if (btnExportDataInModal) {
        btnExportDataInModal.addEventListener('click', function() {
          exportAllData();
        });
      }
      
      const btnImportDataInModal = document.getElementById('btnImportDataInModal');
      if (btnImportDataInModal) {
        btnImportDataInModal.addEventListener('click', function() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
              importBackupData(file);
            }
          };
          input.click();
        });
      }
      
      // ç»‘å®šé€€å‡ºç™»å½•æŒ‰é’®ï¼ˆåœ¨è®¾ç½®æ¨¡æ€æ¡†å†…ï¼‰
      const logoutBtnInModal = document.getElementById('logoutBtnInModal');
      if (logoutBtnInModal) {
        logoutBtnInModal.addEventListener('click', function() {
          localStorage.removeItem('adminToken');
          localStorage.removeItem('adminUser');
          const loginPage = document.getElementById('loginPage');
          const adminPage = document.getElementById('adminPage');
          if (loginPage) loginPage.style.display = 'flex';
          if (adminPage) adminPage.style.display = 'none';
          const usernameInput = document.getElementById('username');
          const passwordInput = document.getElementById('password');
          if (usernameInput) usernameInput.value = '';
          if (passwordInput) passwordInput.value = '';
          closeSettingsModal();
        });
      }
      
      // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
      const userInfoModal = document.getElementById('userInfoModal');
      const settingsModal = document.getElementById('settingsModal');
      
      if (userInfoModal) {
        userInfoModal.addEventListener('click', function(e) {
          if (e.target === userInfoModal) {
            closeUserInfoModal();
          }
        });
      }
      
      if (settingsModal) {
        settingsModal.addEventListener('click', function(e) {
          if (e.target === settingsModal) {
            closeSettingsModal();
          }
        });
      }
      
      // ESCé”®å…³é—­æ¨¡æ€æ¡†
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeUserInfoModal();
          closeSettingsModal();
        }
      });
    }
    
    // ç»‘å®šEvoè®¾ç½®æŒ‰é’®äº‹ä»¶
    document.addEventListener('DOMContentLoaded', () => {
      // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
      initAdminUserInfo();
      
      // ç»‘å®šç”¨æˆ·æŒ‰é’®
      bindUserButtons();
      
      // å»¶è¿Ÿç»‘å®šï¼Œç¡®ä¿ç”¨æˆ·åå·²åŠ è½½
      setTimeout(() => {
        initAdminUserInfo();
      }, 1000);
      const btnSave = document.getElementById('btnSaveEvoSettings');
      const btnReset = document.getElementById('btnResetEvoSettings');
      const btnSync = document.getElementById('btnSyncEvoSettings');
      const btnTestAI = document.getElementById('btnAdminTestAI');
      
      if (btnSave) {
        btnSave.addEventListener('click', saveEvoSettings);
      }
      
      if (btnReset) {
        btnReset.addEventListener('click', resetEvoSettings);
      }
      
      if (btnSync) {
        btnSync.addEventListener('click', syncEvoSettingsToMainSite);
      }
      
      if (btnTestAI) {
        btnTestAI.addEventListener('click', testAdminAIConnection);
      }
      
      // å½“åˆ‡æ¢åˆ°Evoè®¾ç½®æ ‡ç­¾æ—¶ï¼ŒåŠ è½½AIæ¨¡å‹ä¿¡æ¯
      const evoSettingsTab = document.getElementById('evoSettingsTab');
      if (evoSettingsTab) {
        // ç«‹å³åŠ è½½ä¸€æ¬¡ï¼ˆå¦‚æœæ ‡ç­¾é¡µå·²ç»æ˜¾ç¤ºï¼‰
        if (evoSettingsTab.style.display !== 'none') {
          console.log('ğŸ”„ Evoè®¾ç½®é¡µé¢å·²æ˜¾ç¤ºï¼Œç«‹å³åŠ è½½AIä¿¡æ¯...');
          setTimeout(() => {
            loadAdminAIModelInfo();
            loadEvoAIModelInfo();
          }, 200);
        }
        
        const observer = new MutationObserver((mutations) => {
          if (evoSettingsTab.style.display !== 'none') {
            console.log('ğŸ”„ Evoè®¾ç½®é¡µé¢æ˜¾ç¤ºï¼ŒåŠ è½½AIä¿¡æ¯...');
            setTimeout(() => {
              loadAdminAIModelInfo();
              loadEvoAIModelInfo();
            }, 200);
          }
        });
        observer.observe(evoSettingsTab, { attributes: true, attributeFilter: ['style'] });
        
        // ç›‘å¬æ‰€æœ‰å¯èƒ½çš„æ ‡ç­¾åˆ‡æ¢æ–¹å¼
        // æ–¹å¼1ï¼šé€šè¿‡å¯¼èˆªèœå•
        document.querySelectorAll('[data-tab="evoSettings"], [onclick*="evoSettings"]').forEach(el => {
          el.addEventListener('click', () => {
            setTimeout(() => {
              if (evoSettingsTab.style.display !== 'none') {
                console.log('ğŸ”„ ç‚¹å‡»Evoè®¾ç½®æ ‡ç­¾ï¼ŒåŠ è½½AIä¿¡æ¯...');
                loadEvoAIModelInfo();
              }
            }, 300);
          });
        });
        
        // æ–¹å¼2ï¼šé€šè¿‡ä¾§è¾¹æ ç‚¹å‡»
        const sidebarLinks = document.querySelectorAll('a, .nav-item, .menu-item');
        sidebarLinks.forEach(link => {
          if (link.textContent && link.textContent.includes('Evoè®¾ç½®')) {
            link.addEventListener('click', () => {
              setTimeout(() => {
                if (evoSettingsTab.style.display !== 'none') {
                  console.log('ğŸ”„ é€šè¿‡ä¾§è¾¹æ æ‰“å¼€Evoè®¾ç½®ï¼ŒåŠ è½½AIä¿¡æ¯...');
                  loadEvoAIModelInfo();
                }
              }, 300);
            });
          }
        });
      }
      
      // é¡µé¢åŠ è½½å®Œæˆåä¹Ÿå°è¯•åŠ è½½ä¸€æ¬¡
      if (document.readyState === 'complete') {
        setTimeout(() => {
          if (evoSettingsTab && evoSettingsTab.style.display !== 'none') {
            console.log('ğŸ”„ é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥Evoè®¾ç½®é¡µé¢...');
            loadEvoAIModelInfo();
          }
        }, 1000);
      } else {
        window.addEventListener('load', () => {
          setTimeout(() => {
            if (evoSettingsTab && evoSettingsTab.style.display !== 'none') {
              console.log('ğŸ”„ çª—å£åŠ è½½å®Œæˆï¼Œæ£€æŸ¥Evoè®¾ç½®é¡µé¢...');
              loadEvoAIModelInfo();
            }
          }, 1000);
        });
      }
      
      // ç»‘å®šEvoè®¾ç½®é¡µé¢çš„AIä¿¡æ¯æŒ‰é’®
      const btnRefreshAI = document.getElementById('btnEvoRefreshAIInfo');
      const btnTestEvoAI = document.getElementById('btnEvoTestAI');
      
      if (btnRefreshAI) {
        btnRefreshAI.addEventListener('click', () => {
          console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°AIä¿¡æ¯æŒ‰é’®è¢«ç‚¹å‡»');
          loadEvoAIModelInfo();
          const statusEl = document.getElementById('evoAIInfoStatus');
          if (statusEl) {
            statusEl.style.display = 'block';
            statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
            statusEl.style.color = 'var(--text-primary)';
            statusEl.textContent = 'âœ… AIä¿¡æ¯å·²åˆ·æ–°';
            setTimeout(() => {
              statusEl.style.display = 'none';
            }, 2000);
          }
        });
      }
      
      // ç¡®ä¿é¡µé¢åŠ è½½æ—¶ä¹Ÿå°è¯•åŠ è½½AIä¿¡æ¯
      setTimeout(() => {
        const evoSettingsTab = document.getElementById('evoSettingsTab');
        if (evoSettingsTab && evoSettingsTab.style.display !== 'none') {
          console.log('ğŸ”„ Evoè®¾ç½®é¡µé¢å¯è§ï¼Œè‡ªåŠ¨åŠ è½½AIä¿¡æ¯');
          loadEvoAIModelInfo();
        }
      }, 1000);
      
      if (btnTestEvoAI) {
        btnTestEvoAI.addEventListener('click', async () => {
          btnTestEvoAI.disabled = true;
          btnTestEvoAI.textContent = 'æµ‹è¯•ä¸­...';
          
          const statusEl = document.getElementById('evoAIInfoStatus');
          if (statusEl) {
            statusEl.style.display = 'block';
            statusEl.style.background = 'rgba(255, 152, 0, 0.3)';
            statusEl.textContent = 'ğŸ”„ æ­£åœ¨æµ‹è¯•AIè¿æ¥...';
          }
          
          try {
            const token = getAuthToken();
            if (!token) {
              throw new Error('è¯·å…ˆç™»å½•');
            }
            
            const response = await fetch(`${getApiUrl()}/evo/test`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              }
            });
            
            const result = await response.json();
            
            if (statusEl) {
              if (result.success) {
                statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
                statusEl.textContent = `âœ… ${result.message || 'AIè¿æ¥æµ‹è¯•æˆåŠŸï¼'}`;
              } else {
                statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
                statusEl.textContent = `âŒ ${result.message || 'AIè¿æ¥æµ‹è¯•å¤±è´¥'}`;
              }
            }
          } catch (error) {
            if (statusEl) {
              statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
              statusEl.textContent = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
          } finally {
            btnTestEvoAI.disabled = false;
            btnTestEvoAI.textContent = 'ğŸ§ª æµ‹è¯•è¿æ¥';
          }
        });
      }
    });
    
    // è·å–tokenå‡½æ•°ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    function getAuthToken() {
      // ä¼˜å…ˆä½¿ç”¨adminTokenï¼ˆæ™ºèƒ½ç®¡ç†ç³»ç»Ÿä½¿ç”¨çš„tokenï¼‰
      const adminToken = localStorage.getItem('adminToken');
      if (adminToken) {
        return adminToken;
      }
      // å¦‚æœæ²¡æœ‰adminTokenï¼Œå°è¯•ä½¿ç”¨tokenï¼ˆä¸»ç«™ä½¿ç”¨çš„tokenï¼‰
      return localStorage.getItem('token');
    }
    
    // åŠ è½½Evoè®¾ç½®é¡µé¢çš„AIæ¨¡å‹ä¿¡æ¯
    async function loadEvoAIModelInfo() {
      // å…ˆæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
      const nameEl = document.getElementById('evoAIModelName');
      const statusInfoEl = document.getElementById('evoAIInfoStatus');
      
      if (!nameEl) {
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        if (statusInfoEl) {
          statusInfoEl.style.display = 'block';
          statusInfoEl.style.background = 'rgba(255, 152, 0, 0.3)';
          statusInfoEl.style.color = 'var(--text-primary)';
          statusInfoEl.innerHTML = 'â³ é¡µé¢æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™...';
        }
        setTimeout(() => loadEvoAIModelInfo(), 500);
        return;
      }
      
      // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
      if (statusInfoEl) {
        statusInfoEl.style.display = 'block';
        statusInfoEl.style.background = 'rgba(255, 152, 0, 0.3)';
        statusInfoEl.style.color = 'var(--text-primary)';
        statusInfoEl.innerHTML = 'ğŸ”„ æ­£åœ¨åŠ è½½AIä¿¡æ¯...';
      }
      
      const providerEl = document.getElementById('evoAIProvider');
      if (nameEl) nameEl.textContent = 'åŠ è½½ä¸­...';
      if (providerEl) providerEl.textContent = 'åŠ è½½ä¸­...';
      
      try {
        const token = getAuthToken();
        if (!token) {
          if (statusInfoEl) {
            statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
            statusInfoEl.innerHTML = 'âŒ <strong>æœªç™»å½•</strong><br>è¯·å…ˆç™»å½•ç³»ç»Ÿï¼Œç„¶åæ‰èƒ½æŸ¥çœ‹AIæ¨¡å‹ä¿¡æ¯ã€‚';
          }
          displayEvoAIModelInfo(null);
          return;
        }
        
        const apiUrl = getApiUrl();
        
        const response = await fetch(`${apiUrl}/evo/model-info`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success && result.data) {
            displayEvoAIModelInfo(result.data);
          } else {
            if (statusInfoEl) {
              statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
              statusInfoEl.innerHTML = `âŒ <strong>APIè¿”å›é”™è¯¯</strong><br>${result.error || 'æœªçŸ¥é”™è¯¯'}`;
            }
            displayEvoAIModelInfo(null);
          }
        } else {
          const errorData = await response.json().catch(() => ({ error: 'æ— æ³•è§£æé”™è¯¯ä¿¡æ¯' }));
          
          if (statusInfoEl) {
            statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
            let errorMsg = `âŒ <strong>åŠ è½½å¤±è´¥ (${response.status})</strong><br>`;
            
            if (response.status === 401) {
              errorMsg += 'è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•ï¼';
            } else if (response.status === 404) {
              errorMsg += 'APIæ¥å£ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡ï¼';
            } else if (response.status === 500) {
              errorMsg += 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æ—¥å¿—ï¼';
            } else {
              errorMsg += errorData.error || 'æœªçŸ¥é”™è¯¯';
            }
            
            statusInfoEl.innerHTML = errorMsg;
          }
          
          displayEvoAIModelInfo(null);
        }
      } catch (error) {
        if (statusInfoEl) {
          statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
          let errorMsg = 'âŒ <strong>ç½‘ç»œé”™è¯¯</strong><br>';
          
          if (error.message.includes('Failed to fetch')) {
            errorMsg += 'æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ï¼<br>è¯·ç¡®è®¤ï¼š<br>1. åç«¯æœåŠ¡å·²å¯åŠ¨ï¼ˆè¿è¡Œ npm startï¼‰<br>2. æœåŠ¡åœ°å€æ­£ç¡®ï¼ˆhttp://localhost:3000ï¼‰<br>3. ç½‘ç»œè¿æ¥æ­£å¸¸';
          } else {
            errorMsg += error.message || 'æœªçŸ¥é”™è¯¯';
          }
          
          statusInfoEl.innerHTML = errorMsg;
        }
        
        displayEvoAIModelInfo(null);
      }
    }
    
    // æ˜¾ç¤ºEvoè®¾ç½®é¡µé¢çš„AIæ¨¡å‹ä¿¡æ¯
    function displayEvoAIModelInfo(modelInfo) {
      const nameEl = document.getElementById('evoAIModelName');
      const providerEl = document.getElementById('evoAIProvider');
      const statusEl = document.getElementById('evoAIStatus');
      const sourceEl = document.getElementById('evoAISource');
      const descEl = document.getElementById('evoAIDescription');
      const featuresEl = document.getElementById('evoAIFeatures');
      const statusInfoEl = document.getElementById('evoAIInfoStatus');
      
      // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
      if (statusInfoEl) {
        statusInfoEl.style.display = 'block';
        statusInfoEl.style.padding = '12px';
        statusInfoEl.style.borderRadius = '6px';
        statusInfoEl.style.fontSize = '14px';
      }
      
      if (!modelInfo) {
        if (nameEl) nameEl.textContent = 'âŒ æœªé…ç½®';
        if (providerEl) providerEl.textContent = 'æœªçŸ¥';
        if (statusEl) {
          statusEl.textContent = 'âŒ æœªé…ç½®';
          statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
        }
        if (sourceEl) {
          sourceEl.href = '#';
          sourceEl.textContent = 'æ— ';
        }
        if (descEl) descEl.textContent = 'AIæœåŠ¡æœªé…ç½®ï¼Œè¯·æ£€æŸ¥API Keyè®¾ç½®';
        if (featuresEl) featuresEl.textContent = 'æ— å¯ç”¨åŠŸèƒ½';
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        if (statusInfoEl) {
          statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
          statusInfoEl.style.color = 'var(--text-primary)';
          statusInfoEl.innerHTML = 'âŒ <strong>AIä¿¡æ¯åŠ è½½å¤±è´¥</strong><br>è¯·ç‚¹å‡»"ğŸ”„ åˆ·æ–°ä¿¡æ¯"æŒ‰é’®é‡è¯•ï¼Œæˆ–æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚';
        }
        return;
      }
      
      // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
      if (statusInfoEl) {
        statusInfoEl.style.background = 'rgba(76, 175, 80, 0.3)';
        statusInfoEl.style.color = 'var(--text-primary)';
        statusInfoEl.innerHTML = 'âœ… <strong>AIä¿¡æ¯åŠ è½½æˆåŠŸ</strong>';
        setTimeout(() => {
          if (statusInfoEl) statusInfoEl.style.display = 'none';
        }, 3000);
      }
      
      if (nameEl) nameEl.textContent = modelInfo.name || 'æœªçŸ¥';
      if (providerEl) providerEl.textContent = modelInfo.provider || 'æœªçŸ¥';
      
      if (statusEl) {
        if (modelInfo.free) {
          statusEl.textContent = 'âœ… å…è´¹ä½¿ç”¨';
          statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
        } else {
          statusEl.textContent = 'ğŸ’° ä»˜è´¹';
          statusEl.style.background = 'rgba(255, 152, 0, 0.3)';
        }
      }
      
      if (sourceEl) {
        sourceEl.href = modelInfo.source || '#';
        sourceEl.textContent = modelInfo.source ? 'æŸ¥çœ‹æ¨¡å‹è¯¦æƒ…' : 'æ— ';
      }
      
      if (descEl) {
        descEl.textContent = modelInfo.description || 'æ™ºèƒ½å¯¹è¯æ¨¡å‹ï¼Œæ”¯æŒä¸­æ–‡å¯¹è¯';
      }
      
      if (featuresEl && modelInfo.features && Array.isArray(modelInfo.features)) {
        featuresEl.innerHTML = modelInfo.features.map(f => `â€¢ ${f}`).join('<br>');
      } else if (featuresEl) {
        featuresEl.innerHTML = 'â€¢ å®Œå…¨å…è´¹ä½¿ç”¨<br>â€¢ æ”¯æŒä¸­æ–‡å¯¹è¯<br>â€¢ é«˜æ€§èƒ½å“åº”';
      }
    }
    
    // ==========================================
    // ğŸ•Šï¸ Evo æ™ºèƒ½åŠ©æ‰‹åŠŸèƒ½
    // ==========================================
    
    const EvoAssistant = (function() {
      const CHAT_HISTORY_KEY = 'evo_chat_history';
      const USED_GREETINGS_KEY = 'evo_used_greetings_admin';
      
      // æ¬¢è¿æ¶ˆæ¯åç¼€é€‰é¡¹ï¼ˆé’ˆå¯¹æ™ºèƒ½ç®¡ç†ï¼‰
      const GREETING_SUFFIXES = [
        'ç®¡ç†å…¬å‘Š',
        'æŸ¥çœ‹ç»Ÿè®¡æ•°æ®',
        'ç®¡ç†ç³»ç»Ÿè®¾ç½®',
        'é…ç½®æ™ºèƒ½åŠ©æ‰‹',
        'åˆ†æç”¨æˆ·æ•°æ®',
        'ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½',
        'æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—',
        'ç®¡ç†æƒé™è®¾ç½®',
        'ç”Ÿæˆæ•°æ®æŠ¥è¡¨',
        'ç›‘æ§ç³»ç»ŸçŠ¶æ€',
        'é…ç½®APIæ¥å£',
        'ç®¡ç†æ•°æ®å¤‡ä»½',
        'ä¼˜åŒ–æ•°æ®åº“',
        'æŸ¥çœ‹ç³»ç»Ÿåˆ†æ',
        'ç®¡ç†åŠŸèƒ½æ¨¡å—'
      ];
      
      let isExpanded = false;
      let activeTab = 'chat';
      let messages = [];
      let isTyping = false;
      let hasShownGreetingThisPageLoad = false;
      let assistantEl, iconButton, dialog, messagesContainer, inputField, sendBtn;
      
      function init() {
        try {
          createHTML();
          bindEvents();
          ensureIconVisible();
          setTimeout(() => ensureIconVisible(), 100);
          setTimeout(() => ensureIconVisible(), 500);
          
          // å»¶è¿Ÿæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
          hasShownGreetingThisPageLoad = false;
          setTimeout(() => {
            showWelcomeGreeting();
          }, 1500);
          setTimeout(() => {
            const existingBubble = document.getElementById('evoWelcomeBubble');
            if (!existingBubble) {
              showWelcomeGreeting();
            }
          }, 3000);
        } catch (error) {
          console.error('Evoåˆå§‹åŒ–é”™è¯¯:', error);
        }
      }
      
      function ensureIconVisible() {
        try {
          let assistant = document.getElementById('evoAssistant');
          if (!assistant) {
            createHTML();
            assistant = document.getElementById('evoAssistant');
          }
          if (assistant) {
            assistant.style.cssText = `
              position: fixed !important;
              bottom: 80px !important;
              right: 20px !important;
              z-index: 99999 !important;
              display: block !important;
              visibility: visible !important;
              opacity: 1 !important;
              pointer-events: auto !important;
            `;
            assistantEl = assistant;
          }
        } catch (error) {
          console.error('ensureIconVisibleé”™è¯¯:', error);
        }
      }
      
      function createHTML() {
        const existing = document.getElementById('evoAssistant');
        if (existing) existing.remove();
        
        const html = `
          <div class="evo-assistant" id="evoAssistant">
            <div class="evo-icon-button" id="evoIconButton">
              <div class="evo-pigeon-icon">
                <span class="evo-icon">ğŸ•Šï¸</span>
                <div class="evo-pulse"></div>
              </div>
            </div>
            
            <div class="evo-dialog" id="evoDialog" style="display: none;">
              <div class="evo-header">
                <div class="evo-header-left">
                  <span class="evo-icon-large">ğŸ•Šï¸</span>
                  <div>
                    <h3 class="evo-title">Evo æ™ºèƒ½åŠ©æ‰‹</h3>
                    <p class="evo-subtitle" id="evoStatus">å‡†å¤‡å¥½ä¸ºæ‚¨æœåŠ¡</p>
                  </div>
                </div>
                <button class="evo-close-btn" id="evoCloseBtn">Ã—</button>
              </div>
              
              <div class="evo-content">
                <div class="evo-tabs">
                  <div class="evo-tab-headers">
                    <div class="evo-tab-header active" data-tab="chat">ğŸ’¬ å¯¹è¯</div>
                    <div class="evo-tab-header" data-tab="analytics">ğŸ“Š æ•°æ®</div>
                    <div class="evo-tab-header" data-tab="recommendations">âœ¨ æ¨è</div>
                  </div>
                  
                  <div class="evo-tab-content active" id="tabChat">
                    <div class="evo-chat-container">
                      <div class="evo-messages" id="evoMessages"></div>
                      <div class="evo-input-area">
                        <div class="evo-input-group">
                          <input type="text" class="evo-input" id="evoInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜...">
                          <button class="evo-send-btn" id="evoSendBtn">å‘é€</button>
                        </div>
                        <div class="evo-quick-actions">
                          <button class="evo-quick-action-btn" data-action="stats">æŸ¥çœ‹ç»Ÿè®¡æ•°æ®</button>
                          <button class="evo-quick-action-btn" data-action="help">å¸®åŠ©</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="evo-tab-content" id="tabAnalytics">
                    <div class="evo-analytics" id="evoAnalytics">
                      <div class="evo-empty">æš‚æ— åˆ†ææŠ¥å‘Š</div>
                    </div>
                  </div>
                  
                  <div class="evo-tab-content" id="tabRecommendations">
                    <div class="evo-recommendations" id="evoRecommendations">
                      <div class="evo-empty">æš‚æ— æ¨èå†…å®¹</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', html);
        
        assistantEl = document.getElementById('evoAssistant');
        iconButton = document.getElementById('evoIconButton');
        dialog = document.getElementById('evoDialog');
        messagesContainer = document.getElementById('evoMessages');
        inputField = document.getElementById('evoInput');
        sendBtn = document.getElementById('evoSendBtn');
        
        if (assistantEl) {
          assistantEl.style.cssText = `
            position: fixed !important;
            bottom: 80px !important;
            right: 20px !important;
            z-index: 99999 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
          `;
        }
      }
      
      function bindEvents() {
        if (!iconButton) return;
        
        iconButton.addEventListener('click', toggleExpanded);
        const closeBtn = document.getElementById('evoCloseBtn');
        if (closeBtn) {
          closeBtn.addEventListener('click', toggleExpanded);
        }
        
        if (sendBtn) sendBtn.addEventListener('click', sendMessage);
        if (inputField) {
          inputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isTyping) {
              sendMessage();
            }
          });
        }
        
        document.querySelectorAll('.evo-tab-header').forEach(header => {
          header.addEventListener('click', () => {
            const tab = header.dataset.tab;
            switchTab(tab);
          });
        });
        
        document.querySelectorAll('.evo-quick-action-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const action = btn.dataset.action;
            if (action === 'stats') {
              inputField.value = 'æŸ¥çœ‹ç»Ÿè®¡æ•°æ®';
              sendMessage();
            } else if (action === 'help') {
              inputField.value = 'å¸®åŠ©';
              sendMessage();
            }
          });
        });
      }
      
      function toggleExpanded() {
        isExpanded = !isExpanded;
        if (dialog) {
          dialog.style.display = isExpanded ? 'flex' : 'none';
        }
        if (isExpanded) {
          loadHistory();
        }
      }
      
      function switchTab(tab) {
        activeTab = tab;
        document.querySelectorAll('.evo-tab-header').forEach(h => {
          h.classList.toggle('active', h.dataset.tab === tab);
        });
        document.querySelectorAll('.evo-tab-content').forEach(c => {
          c.classList.toggle('active', c.id === `tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
        });
      }
      
      async function sendMessage() {
        const text = inputField.value.trim();
        if (!text || isTyping) return;
        
        addMessage('user', text);
        inputField.value = '';
        
        isTyping = true;
        updateStatus('æ­£åœ¨æ€è€ƒ...');
        
        try {
          const response = await chat(text);
          addMessage('evo', response.text);
          saveHistory();
        } catch (error) {
          addMessage('evo', 'æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å“åº”ï¼Œè¯·ç¨åå†è¯•ã€‚');
        } finally {
          isTyping = false;
          updateStatus('åœ¨çº¿');
        }
      }
      
      // è·å–tokenå‡½æ•°
      function getAuthToken() {
        // ä¼˜å…ˆä½¿ç”¨adminTokenï¼ˆæ™ºèƒ½ç®¡ç†ç³»ç»Ÿä½¿ç”¨çš„tokenï¼‰
        const adminToken = localStorage.getItem('adminToken');
        if (adminToken) {
          return adminToken;
        }
        // å¦‚æœæ²¡æœ‰adminTokenï¼Œå°è¯•ä½¿ç”¨tokenï¼ˆä¸»ç«™ä½¿ç”¨çš„tokenï¼‰
        return localStorage.getItem('token');
      }
      
      // è°ƒç”¨åç«¯AI API
      async function chatWithBackendAPI(question, history = [], context = {}) {
        try {
          // ä½¿ç”¨ç»Ÿä¸€çš„getApiUrlå‡½æ•°
          const apiBaseUrl = getApiUrl();
          
          const token = getAuthToken();
          if (!token) {
            console.warn('âŒ æœªæ‰¾åˆ°tokenï¼Œæ— æ³•è°ƒç”¨åç«¯APIã€‚è¯·å…ˆç™»å½•ï¼');
            return null;
          }
          
          console.log(`ğŸ”„ æ­£åœ¨è°ƒç”¨åç«¯AI API...`);
          console.log(`ğŸ“¡ APIåœ°å€: ${apiBaseUrl}/evo/chat`);
          console.log(`ğŸ“ é—®é¢˜: ${question.substring(0, 50)}...`);
          
          const startTime = Date.now();
          const response = await fetch(`${apiBaseUrl}/evo/chat`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              question: question,
              history: history,
              context: context
            })
          });
          
          const responseTime = Date.now() - startTime;
          console.log(`â±ï¸ å“åº”æ—¶é—´: ${responseTime}ms`);
          
          if (response.ok) {
            const data = await response.json();
            console.log('ğŸ“¥ APIå“åº”æ•°æ®:', data);
            
            if (data.success && data.data) {
              const responseText = data.data.text || data.data.response;
              if (responseText && responseText.length > 10) {
                console.log(`âœ… AI APIè°ƒç”¨æˆåŠŸï¼`);
                console.log(`ğŸ“Š å›å¤é•¿åº¦: ${responseText.length} å­—ç¬¦`);
                console.log(`ğŸ¤– ä½¿ç”¨æ¨¡å‹: ${data.data.model || 'æœªçŸ¥'}`);
                console.log(`ğŸ¢ æœåŠ¡æä¾›å•†: ${data.data.provider || 'æœªçŸ¥'}`);
                console.log(`ğŸ’¬ å›å¤é¢„è§ˆ: ${responseText.substring(0, 100)}...`);
                
                return { 
                  text: responseText, 
                  data: data.data,
                  modelInfo: data.modelInfo || null
                };
              } else {
                console.warn('âš ï¸ AIå›å¤ä¸ºç©ºæˆ–å¤ªçŸ­ï¼Œé•¿åº¦:', responseText?.length || 0);
              }
            } else {
              console.warn('âš ï¸ APIè¿”å›success=false:', data);
            }
          } else {
            const errorData = await response.json().catch(() => ({}));
            console.error('âŒ åç«¯AI APIå“åº”é”™è¯¯:', response.status);
            console.error('âŒ é”™è¯¯è¯¦æƒ…:', errorData);
            
            if (response.status === 401) {
              console.error('âŒ è®¤è¯å¤±è´¥ï¼è¯·é‡æ–°ç™»å½•ï¼');
              alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ï¼');
            } else if (response.status === 500) {
              console.error('âŒ æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼');
            } else if (response.status === 404) {
              console.error('âŒ APIæ¥å£ä¸å­˜åœ¨ï¼è¯·æ£€æŸ¥åç«¯æœåŠ¡ï¼');
            }
          }
        } catch (error) {
          console.error('âŒ Backend AI APIè°ƒç”¨å¼‚å¸¸:', error);
          console.error('âŒ é”™è¯¯ç±»å‹:', error.name);
          console.error('âŒ é”™è¯¯æ¶ˆæ¯:', error.message);
          
          if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            console.error('âŒ ç½‘ç»œé”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ï¼');
            console.error('ğŸ’¡ è¯·ç¡®è®¤ï¼š1) åç«¯æœåŠ¡å·²å¯åŠ¨ 2) æœåŠ¡åœ°å€æ­£ç¡® 3) ç½‘ç»œè¿æ¥æ­£å¸¸');
          }
        }
        
        return null;
      }
      
      async function chat(question) {
        console.log('ğŸ’¬ æ”¶åˆ°ç”¨æˆ·é—®é¢˜:', question);
        
        // è·å–å¯¹è¯å†å²
        const history = messages.map(msg => ({
          type: msg.type,
          text: msg.text,
          time: msg.time
        }));
        
        // è·å–ä¸Šä¸‹æ–‡æ•°æ®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        const context = {};
        
        // ä¼˜å…ˆçº§1ï¼šå°è¯•ä½¿ç”¨åç«¯AI APIï¼ˆå¿…é¡»ä¼˜å…ˆä½¿ç”¨AIï¼‰
        try {
          console.log('ğŸ”„ æ­£åœ¨è°ƒç”¨åç«¯AI API...');
          const apiResponse = await chatWithBackendAPI(question, history, context);
          
          if (apiResponse && apiResponse.text && apiResponse.text.length > 10) {
            console.log('âœ… AI APIè°ƒç”¨æˆåŠŸï¼Œè¿”å›æ™ºèƒ½AIå›å¤');
            return apiResponse;
          } else {
            console.warn('âš ï¸ AI APIè¿”å›çš„å›å¤ä¸ºç©ºæˆ–å¤ªçŸ­');
            console.warn('âš ï¸ å›å¤å†…å®¹:', apiResponse?.text || '(ç©º)');
            console.warn('âš ï¸ ç»§ç»­å°è¯•å…¶ä»–æ–¹å¼...');
          }
        } catch (error) {
          console.error('âŒ åç«¯AI APIè°ƒç”¨å¤±è´¥:', error);
          console.error('âŒ é”™è¯¯å †æ ˆ:', error.stack);
        }
        
        // å¦‚æœAI APIå¤±è´¥ï¼Œæ˜¾ç¤ºæ˜ç¡®çš„é”™è¯¯æç¤º
        const token = getAuthToken();
        if (!token) {
          return { 
            text: 'âŒ æ— æ³•ä½¿ç”¨AIåŠŸèƒ½ï¼šæ‚¨å°šæœªç™»å½•ã€‚\n\nè¯·å…ˆç™»å½•ç³»ç»Ÿï¼Œç„¶åæ‰èƒ½ä½¿ç”¨AIåŠ©æ‰‹åŠŸèƒ½ã€‚\n\nç™»å½•åï¼ŒAIåŠ©æ‰‹å°†ä¸ºæ‚¨æä¾›æ™ºèƒ½å›å¤ã€‚' 
          };
        }
        
        // æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯è¾¾
        try {
          const healthCheck = await fetch(`${getApiUrl()}/health`).catch(() => null);
          if (!healthCheck || !healthCheck.ok) {
            return { 
              text: 'âŒ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ã€‚\n\nè¯·ç¡®è®¤ï¼š\n1. åç«¯æœåŠ¡å·²å¯åŠ¨ï¼ˆè¿è¡Œ npm startï¼‰\n2. æœåŠ¡åœ°å€æ­£ç¡®ï¼ˆhttp://localhost:3000ï¼‰\n3. ç½‘ç»œè¿æ¥æ­£å¸¸\n\nè¿æ¥æˆåŠŸåï¼ŒAIåŠ©æ‰‹å°†æ­£å¸¸å·¥ä½œã€‚' 
            };
          }
        } catch (e) {
          return { 
            text: 'âŒ åç«¯æœåŠ¡è¿æ¥å¤±è´¥ã€‚\n\nè¯·æ£€æŸ¥ï¼š\n1. åç«¯æœåŠ¡æ˜¯å¦å·²å¯åŠ¨\n2. æœåŠ¡åœ°å€æ˜¯å¦æ­£ç¡®\n3. é˜²ç«å¢™è®¾ç½®\n\nä¿®å¤åï¼ŒAIåŠ©æ‰‹å°†è‡ªåŠ¨æ¢å¤ã€‚' 
          };
        }
        
        // å¦‚æœåç«¯æœåŠ¡æ­£å¸¸ä½†AIè°ƒç”¨å¤±è´¥ï¼Œæ˜¾ç¤ºæç¤º
        return { 
          text: `âš ï¸ AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ã€‚\n\né—®é¢˜ï¼š"${question}"\n\nå¯èƒ½çš„åŸå› ï¼š\n1. AI APIé…ç½®é—®é¢˜\n2. API Keyæ— æ•ˆæˆ–è¿‡æœŸ\n3. ç½‘ç»œè¿æ¥é—®é¢˜\n\nè¯·æ£€æŸ¥ï¼š\nâ€¢ æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯\nâ€¢ åç«¯æ—¥å¿—æ–‡ä»¶\nâ€¢ API Keyé…ç½®\n\nä¿®å¤åï¼ŒAIåŠ©æ‰‹å°†è‡ªåŠ¨æ¢å¤æ™ºèƒ½å›å¤åŠŸèƒ½ã€‚` 
        };
      }
      
      function addMessage(type, text) {
        const message = { type, text, time: new Date() };
        messages.push(message);
        renderMessages();
      }
      
      function renderMessages() {
        if (!messagesContainer) return;
        
        messagesContainer.innerHTML = messages.map(msg => {
          const timeStr = formatTime(msg.time);
          if (msg.type === 'user') {
            return `
              <div class="evo-message user">
                <div class="evo-message-avatar">ğŸ‘¤</div>
                <div class="evo-message-content">
                  <div class="evo-message-text">${formatMessage(msg.text)}</div>
                  <div class="evo-message-time">${timeStr}</div>
                </div>
              </div>
            `;
          } else {
            return `
              <div class="evo-message evo">
                <div class="evo-message-avatar">ğŸ•Šï¸</div>
                <div class="evo-message-content">
                  <div class="evo-message-text">${formatMessage(msg.text)}</div>
                  <div class="evo-message-time">${timeStr}</div>
                </div>
              </div>
            `;
          }
        }).join('');
        
        if (isTyping) {
          messagesContainer.innerHTML += `
            <div class="evo-message evo">
              <div class="evo-message-avatar">ğŸ•Šï¸</div>
              <div class="evo-message-content">
                <div class="evo-typing-indicator">
                  <span></span><span></span><span></span>
                </div>
              </div>
            </div>
          `;
        }
        
        scrollToBottom();
      }
      
      function formatMessage(text) {
        return text.replace(/\n/g, '<br>');
      }
      
      function formatTime(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        if (minutes < 1) return 'åˆšåˆš';
        if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
        return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      }
      
      function scrollToBottom() {
        if (messagesContainer) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }
      
      function updateStatus(status) {
        const statusEl = document.getElementById('evoStatus');
        if (statusEl) {
          statusEl.textContent = status;
        }
      }
      
      function saveHistory() {
        try {
          localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(messages));
        } catch (error) {
          console.error('Failed to save chat history:', error);
        }
      }
      
      function loadHistory() {
        try {
          const history = localStorage.getItem(CHAT_HISTORY_KEY);
          if (history) {
            messages = JSON.parse(history).map(msg => ({
              ...msg,
              time: new Date(msg.time)
            }));
            renderMessages();
          }
        } catch (error) {
          console.error('Failed to load chat history:', error);
        }
      }
      
      // è·å–æœªä½¿ç”¨çš„æ¬¢è¿æ¶ˆæ¯åç¼€
      function getUnusedGreetingSuffix() {
        try {
          const used = JSON.parse(localStorage.getItem(USED_GREETINGS_KEY) || '[]');
          const available = GREETING_SUFFIXES.filter(suffix => !used.includes(suffix));
          
          if (available.length === 0) {
            localStorage.setItem(USED_GREETINGS_KEY, '[]');
            return GREETING_SUFFIXES[Math.floor(Math.random() * GREETING_SUFFIXES.length)];
          }
          
          const selected = available[Math.floor(Math.random() * available.length)];
          used.push(selected);
          localStorage.setItem(USED_GREETINGS_KEY, JSON.stringify(used));
          
          return selected;
        } catch (error) {
          console.error('è·å–æ¬¢è¿æ¶ˆæ¯å¤±è´¥:', error);
          return GREETING_SUFFIXES[0];
        }
      }
      
      // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯æ°”æ³¡å¼¹çª—
      function showWelcomeGreeting() {
        const existingBubble = document.getElementById('evoWelcomeBubble');
        if (existingBubble) {
          return;
        }
        
        hasShownGreetingThisPageLoad = true;
        
        try {
          if (!document.body) {
            setTimeout(showWelcomeGreeting, 500);
            return;
          }
          
          const suffix = getUnusedGreetingSuffix();
          const greeting = `ä½ å¥½ï¼Œæˆ‘æ˜¯Evoï¼Œæˆ‘å¯ä»¥å¸®ä½ ${suffix}ã€‚`;
          
          const bubble = document.createElement('div');
          bubble.id = 'evoWelcomeBubble';
          bubble.className = 'evo-welcome-bubble';
          
          bubble.style.position = 'fixed';
          bubble.style.bottom = '160px';
          bubble.style.right = '100px';
          bubble.style.zIndex = '99998';
          bubble.style.maxWidth = '280px';
          bubble.style.pointerEvents = 'auto';
          bubble.style.display = 'block';
          bubble.style.visibility = 'visible';
          bubble.style.opacity = '1';
          
          const bubbleContent = document.createElement('div');
          bubbleContent.className = 'evo-welcome-bubble-content';
          bubbleContent.textContent = greeting;
          
          bubbleContent.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          bubbleContent.style.color = '#fff';
          bubbleContent.style.padding = '12px 16px';
          bubbleContent.style.borderRadius = '8px';
          bubbleContent.style.fontSize = '14px';
          bubbleContent.style.lineHeight = '1.5';
          bubbleContent.style.boxShadow = '0 4px 20px rgba(102, 126, 234, 0.4), 0 0 30px rgba(118, 75, 162, 0.3)';
          bubbleContent.style.position = 'relative';
          bubbleContent.style.wordWrap = 'break-word';
          bubbleContent.style.cursor = 'pointer';
          bubbleContent.style.fontWeight = '500';
          
          bubbleContent.addEventListener('click', () => {
            hideWelcomeBubble();
            if (!dialog) {
              dialog = document.getElementById('evoDialog');
            }
            if (dialog) {
              isExpanded = true;
              dialog.style.display = 'flex';
              activeTab = 'chat';
              switchTab('chat');
              
              if (!messagesContainer) {
                messagesContainer = document.getElementById('evoMessages');
              }
              if (messagesContainer) {
                messages = [];
                messagesContainer.innerHTML = '';
                addMessage('evo', greeting);
                saveHistory();
                setTimeout(() => scrollToBottom(), 100);
              }
            }
          });
          
          bubble.appendChild(bubbleContent);
          document.body.appendChild(bubble);
          
          setTimeout(() => {
            const checkBubble = document.getElementById('evoWelcomeBubble');
            if (checkBubble) {
              const rect = checkBubble.getBoundingClientRect();
              const checkComputedStyle = window.getComputedStyle(checkBubble);
              if (rect.width === 0 || rect.height === 0 || checkComputedStyle.display === 'none' || checkComputedStyle.visibility === 'hidden') {
                checkBubble.style.cssText = `
                  position: fixed !important;
                  bottom: 160px !important;
                  right: 100px !important;
                  z-index: 99998 !important;
                  max-width: 280px !important;
                  display: block !important;
                  visibility: visible !important;
                  opacity: 1 !important;
                `;
              }
            }
          }, 100);
          
          setTimeout(() => {
            hideWelcomeBubble();
          }, 3000);
          
        } catch (error) {
          console.error('æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯å¤±è´¥:', error);
        }
      }
      
      // éšè—æ¬¢è¿æ¶ˆæ¯æ°”æ³¡
      function hideWelcomeBubble() {
        const bubble = document.getElementById('evoWelcomeBubble');
        if (bubble) {
          bubble.classList.add('hiding');
          setTimeout(() => {
            if (bubble.parentNode) {
              bubble.remove();
            }
          }, 300);
        }
      }
      
      return {
        init,
        ensureIconVisible
      };
    })();
    
    // åˆå§‹åŒ–EvoåŠ©æ‰‹ï¼ˆåœ¨ç™»å½•åï¼‰
    function initEvoAssistant() {
      setTimeout(() => {
        try {
          EvoAssistant.init();
          console.log('âœ… Evo æ™ºèƒ½åŠ©æ‰‹å·²åˆå§‹åŒ–');
          
          setTimeout(() => {
            EvoAssistant.ensureIconVisible();
          }, 500);
        } catch (error) {
          console.error('âš ï¸ æ™ºèƒ½åŠ©æ‰‹åˆå§‹åŒ–å¤±è´¥:', error);
        }
      }, 500);
    }
    
    // ========================================
    // æ™ºé¸½Â·ä¸­æ¢ç®¡å®¶åŠŸèƒ½
    // ========================================
    
    // åŠ è½½ä¸­æ¢ç®¡å®¶æ•°æ®ï¼ˆä½¿ç”¨å…¨å±€ CORE_ADMIN_API_BASEï¼‰
    async function loadCoreAdminData() {
      try {
        // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®ï¼Œå³ä½¿éƒ¨åˆ†å¤±è´¥ä¹Ÿèƒ½æ˜¾ç¤ºå…¶ä»–å†…å®¹
        await Promise.allSettled([
          loadCoreAdminStatus(),
          loadCoreAdminModelInfo(),
          loadCoreAdminAdvice(),
          loadCoreAdminAnalytics(),
          loadCoreAdminApis(),
          loadCoreAdminLearning(),
          loadCoreAdminMaintenance()
        ]);
      } catch (error) {
        console.error('åŠ è½½ä¸­æ¢ç®¡å®¶æ•°æ®å¤±è´¥:', error);
      }
    }
    
    // åŠ è½½ç³»ç»ŸçŠ¶æ€
    async function loadCoreAdminStatus() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/status`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const result = await response.json();
        
        if (result.success && result.data) {
          const status = result.data;
          const healthScore = (status.metrics?.systemHealth || 0) * 100;
          
          document.getElementById('coreAdminHealthScore').textContent = healthScore.toFixed(0) + '%';
          document.getElementById('coreAdminHealthStatus').textContent = 
            status.metrics?.riskLevel === 'low' ? 'âœ… è¿è¡Œæ­£å¸¸' :
            status.metrics?.riskLevel === 'medium' ? 'âš ï¸ éœ€è¦æ³¨æ„' :
            status.metrics?.riskLevel === 'high' ? 'ğŸ”´ é£é™©è¾ƒé«˜' : 'æ£€æŸ¥ä¸­...';
        } else {
          throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
        }
      } catch (error) {
        console.error('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
        document.getElementById('coreAdminHealthScore').textContent = '--';
        document.getElementById('coreAdminHealthStatus').textContent = 'âš ï¸ æœåŠ¡æœªè¿è¡Œ';
        document.getElementById('coreAdminHealthStatus').style.color = '#f59e0b';
      }
    }
    
    // åŠ è½½æ¨¡å‹æ¥å…¥ä¿¡æ¯
    async function loadCoreAdminModelInfo() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/model/config`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const result = await response.json();
        
        if (result.success && result.data) {
          const modelInfo = result.data;
          
          // æ›´æ–°åŸºæœ¬ä¿¡æ¯
          document.getElementById('coreAdminModelProvider').textContent = modelInfo.provider || 'æœªçŸ¥';
          document.getElementById('coreAdminModelName').textContent = modelInfo.model || 'æœªçŸ¥';
          document.getElementById('coreAdminApiKeyPreview').textContent = modelInfo.apiKeyPreview || '--';
          document.getElementById('coreAdminApiBase').textContent = modelInfo.apiBase || '--';
          document.getElementById('coreAdminMaxCalls').textContent = modelInfo.maxCallsPerHour || '--';
          document.getElementById('coreAdminConfidence').textContent = (modelInfo.confidenceThreshold * 100).toFixed(0) + '%' || '--';
          
          // æ›´æ–°API KeyçŠ¶æ€
          const apiKeyStatusEl = document.getElementById('coreAdminApiKeyStatus');
          if (modelInfo.apiKeyStatus === 'configured') {
            apiKeyStatusEl.textContent = 'âœ… å·²é…ç½®';
            apiKeyStatusEl.style.background = 'rgba(76, 175, 80, 0.3)';
            apiKeyStatusEl.style.color = '#2e7d32';
          } else {
            apiKeyStatusEl.textContent = 'âŒ æœªé…ç½®';
            apiKeyStatusEl.style.background = 'rgba(244, 67, 54, 0.3)';
            apiKeyStatusEl.style.color = '#c62828';
          }
          
          // æ›´æ–°è¿æ¥çŠ¶æ€
          const connectionStatusEl = document.getElementById('coreAdminConnectionStatus');
          if (modelInfo.connectionStatus === 'connected' && modelInfo.enabled) {
            connectionStatusEl.textContent = 'âœ… å·²è¿æ¥';
            connectionStatusEl.style.background = 'rgba(76, 175, 80, 0.3)';
            connectionStatusEl.style.color = '#2e7d32';
          } else {
            connectionStatusEl.textContent = 'âŒ æœªè¿æ¥';
            connectionStatusEl.style.background = 'rgba(244, 67, 54, 0.3)';
            connectionStatusEl.style.color = '#c62828';
          }
          
          // æ›´æ–°è°ƒç”¨ç»Ÿè®¡
          if (modelInfo.stats) {
            const stats = modelInfo.stats;
            document.getElementById('coreAdminTotalCalls').textContent = stats.totalCalls || 0;
            document.getElementById('coreAdminRecentCalls').textContent = stats.recentCalls || 0;
            document.getElementById('coreAdminSuccessRate').textContent = (stats.successRate * 100).toFixed(1) + '%';
            document.getElementById('coreAdminAvgConfidence').textContent = (stats.avgConfidence * 100).toFixed(1) + '%';
          }
          
          // æ›´æ–°AIè°ƒç”¨æ¬¡æ•°ï¼ˆåœ¨é¡¶éƒ¨å¡ç‰‡ä¸­ï¼‰
          if (modelInfo.stats) {
            document.getElementById('coreAdminAICalls').textContent = modelInfo.stats.recentCalls || 0;
          }
        } else {
          throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
        }
      } catch (error) {
        console.error('åŠ è½½æ¨¡å‹æ¥å…¥ä¿¡æ¯å¤±è´¥:', error);
        const container = document.getElementById('coreAdminModelInfo');
        container.innerHTML = `
          <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:1px solid #f59e0b;">
            <p style="margin:0 0 12px 0;color:#92400e;font-weight:600;">âš ï¸ ä¸­æ¢ç®¡å®¶æœåŠ¡æœªè¿è¡Œ</p>
            <p style="margin:0;color:#78350f;font-size:14px;">è¯·å¯åŠ¨åç«¯æœåŠ¡ï¼š<code style="background:#fde68a;padding:2px 6px;border-radius:4px;">cd backend/core-admin && npm start</code></p>
          </div>
        `;
      }
    }
    
    // åŠ è½½ç®¡ç†å»ºè®®
    async function loadCoreAdminAdvice() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/advice`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const result = await response.json();
        
        if (result.success && result.data) {
          const advice = result.data.advice || {};
          const container = document.getElementById('coreAdminAdvice');
          
          let html = '';
          if (advice.summary) {
            html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;margin-bottom:12px;">`;
            html += `<div style="font-weight:600;margin-bottom:8px;color:#1f2937;">${advice.summary}</div>`;
            if (advice.actions && advice.actions.length > 0) {
              html += `<ul style="margin:8px 0;padding-left:20px;">`;
              advice.actions.forEach(action => {
                html += `<li style="margin:4px 0;color:#4b5563;">${action}</li>`;
              });
              html += `</ul>`;
            }
            html += `</div>`;
          } else {
            html = '<p class="muted" style="text-align:center;">æš‚æ— å»ºè®®</p>';
          }
          
          container.innerHTML = html;
        } else {
          throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
        }
      } catch (error) {
        console.error('åŠ è½½ç®¡ç†å»ºè®®å¤±è´¥:', error);
        const container = document.getElementById('coreAdminAdvice');
        container.innerHTML = `
          <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:1px solid #f59e0b;">
            <p style="margin:0 0 12px 0;color:#92400e;font-weight:600;">âš ï¸ ä¸­æ¢ç®¡å®¶æœåŠ¡æœªè¿è¡Œ</p>
            <p style="margin:0;color:#78350f;font-size:14px;">è¯·å¯åŠ¨åç«¯æœåŠ¡ï¼š<code style="background:#fde68a;padding:2px 6px;border-radius:4px;">cd backend/core-admin && npm start</code></p>
          </div>
        `;
      }
    }
    
    // åŠ è½½æ•°æ®åˆ†æ
    async function loadCoreAdminAnalytics() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/analytics/report`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const report = result.data;
          const container = document.getElementById('coreAdminAnalytics');
          
          let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:20px;">';
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">æ€»ç‚¹å‡»é‡</div>`;
          html += `<div style="font-size:24px;font-weight:600;color:#1f2937;">${report.clicks?.total || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">æ•°æ®ä¸Šä¼ </div>`;
          html += `<div style="font-size:24px;font-weight:600;color:#1f2937;">${report.uploads?.total || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ç”¨æˆ·è¡Œä¸º</div>`;
          html += `<div style="font-size:24px;font-weight:600;color:#1f2937;">${report.userBehaviors?.total || 0}</div>`;
          html += `</div>`;
          
          html += `</div>`;
          
          if (report.apiUsage?.topEndpoints && report.apiUsage.topEndpoints.length > 0) {
            html += `<div style="margin-top:20px;"><h4 style="margin-bottom:12px;">çƒ­é—¨API</h4>`;
            html += `<table style="width:100%;border-collapse:collapse;">`;
            html += `<thead><tr style="background:#f9fafb;"><th style="padding:8px;text-align:left;">ç«¯ç‚¹</th><th style="padding:8px;text-align:center;">è°ƒç”¨æ¬¡æ•°</th><th style="padding:8px;text-align:center;">æˆåŠŸç‡</th></tr></thead><tbody>`;
            report.apiUsage.topEndpoints.slice(0, 5).forEach(api => {
              html += `<tr><td style="padding:8px;">${api.endpoint}</td>`;
              html += `<td style="padding:8px;text-align:center;">${api.calls}</td>`;
              html += `<td style="padding:8px;text-align:center;">${(api.successRate * 100).toFixed(1)}%</td></tr>`;
            });
            html += `</tbody></table></div>`;
          }
          
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('åŠ è½½æ•°æ®åˆ†æå¤±è´¥:', error);
        const container = document.getElementById('coreAdminAnalytics');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">æ•°æ®åˆ†ææœåŠ¡æš‚ä¸å¯ç”¨</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ</p>
          </div>
        `;
      }
    }
    
    // åŠ è½½APIåˆ—è¡¨
    async function loadCoreAdminApis() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/apis`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const apis = result.data;
          const container = document.getElementById('coreAdminApiList');
          
          if (apis.length === 0) {
            container.innerHTML = '<p class="muted" style="text-align:center;">æš‚æ— API</p>';
            return;
          }
          
          let html = '<table style="width:100%;border-collapse:collapse;">';
          html += '<thead><tr style="background:#f9fafb;">';
          html += '<th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">APIåç§°</th>';
          html += '<th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">çŠ¶æ€</th>';
          html += '<th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">å“åº”æ—¶é—´</th>';
          html += '<th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">æ•°æ®çœŸå®æ€§</th>';
          html += '</tr></thead><tbody>';
          
          apis.forEach(api => {
            const statusColor = api.health.status === 'healthy' ? '#10b981' : '#ef4444';
            const statusText = api.health.status === 'healthy' ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸';
            const truthStatus = api.health.truthStatus || 'unknown';
            const truthColor = truthStatus === 'verified' ? '#10b981' : truthStatus === 'suspect' ? '#f59e0b' : '#ef4444';
            const truthText = truthStatus === 'verified' ? 'âœ… å·²éªŒè¯' : truthStatus === 'suspect' ? 'âš ï¸ å¯ç–‘' : 'âŒ æ— æ•ˆ';
            
            html += `<tr style="border-bottom:1px solid #f0f0f0;">`;
            html += `<td style="padding:12px;"><strong>${api.name}</strong><br><span style="color:#6b7280;font-size:12px;">${api.url}</span></td>`;
            html += `<td style="padding:12px;text-align:center;"><span style="color:${statusColor};font-weight:600;">${statusText}</span></td>`;
            html += `<td style="padding:12px;text-align:center;">${api.stats.avgResponseTime.toFixed(0)}ms</td>`;
            html += `<td style="padding:12px;text-align:center;"><span style="color:${truthColor};font-weight:600;">${truthText}</span></td>`;
            html += `</tr>`;
          });
          
          html += '</tbody></table>';
          container.innerHTML = html;
          
          // æ›´æ–°APIå¥åº·ç‡
          const healthyCount = apis.filter(a => a.health.status === 'healthy').length;
          const healthRate = apis.length > 0 ? (healthyCount / apis.length * 100) : 0;
          document.getElementById('coreAdminApiHealth').textContent = healthRate.toFixed(0) + '%';
        }
      } catch (error) {
        console.error('åŠ è½½APIåˆ—è¡¨å¤±è´¥:', error);
        const container = document.getElementById('coreAdminApiList');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">APIç›‘ç®¡æœåŠ¡æš‚ä¸å¯ç”¨</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ</p>
          </div>
        `;
      }
    }
    
    // åŠ è½½å­¦ä¹ ç³»ç»Ÿ
    async function loadCoreAdminLearning() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/learning/stats`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const stats = result.data;
          const container = document.getElementById('coreAdminLearning');
          
          let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">';
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">æ€»äº‹ä»¶æ•°</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalEvents || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ç­–ç•¥æ•°</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalStrategies || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">å†³ç­–æ•°</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalDecisions || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">å¹³å‡æœ‰æ•ˆæ€§</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${((stats.avgEffectiveness || 0) * 100).toFixed(1)}%</div>`;
          html += `</div>`;
          
          html += `</div>`;
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('åŠ è½½å­¦ä¹ ç³»ç»Ÿå¤±è´¥:', error);
        const container = document.getElementById('coreAdminLearning');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">å­¦ä¹ ç³»ç»ŸæœåŠ¡æš‚ä¸å¯ç”¨</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ</p>
          </div>
        `;
      }
    }
    
    // åŠ è½½è‡ªåŠ¨ç»´æŠ¤
    async function loadCoreAdminMaintenance() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/maintenance/stats`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const stats = result.data;
          const container = document.getElementById('coreAdminMaintenance');
          
          let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">';
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">æ€»Bugæ•°</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalBugs || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">å·²ä¿®å¤</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.fixedBugs || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">æ€»ä¿®å¤æ•°</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalFixes || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ç³»ç»Ÿå‡çº§</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalUpgrades || 0}</div>`;
          html += `</div>`;
          
          html += `</div>`;
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('åŠ è½½è‡ªåŠ¨ç»´æŠ¤å¤±è´¥:', error);
        const container = document.getElementById('coreAdminMaintenance');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">è‡ªåŠ¨ç»´æŠ¤æœåŠ¡æš‚ä¸å¯ç”¨</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ</p>
          </div>
        `;
      }
    }
    
    // ç»‘å®šåˆ·æ–°æŒ‰é’®
    // ==========================================
    // ç³»ç»Ÿè®¾ç½®åŠŸèƒ½
    // ==========================================
    
    let currentRssSourceEditId = null;
    
    // åŠ è½½ç³»ç»Ÿè®¾ç½®
    async function loadSystemSettings() {
      try {
        const token = localStorage.getItem('adminToken');
        if (!token) {
          showSettingsStatus('è¯·å…ˆç™»å½•', 'error');
          return;
        }
        
        const response = await fetch(`${getApiUrl()}/api/admin/system-settings`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const settings = result.data;
          
          // å¡«å……åŸºç¡€è®¾ç½®
          document.getElementById('serverPort').value = settings.server?.port || '';
          document.getElementById('serverEnv').value = settings.server?.env || 'production';
          document.getElementById('apiRateLimit').value = settings.api?.rateLimit || '';
          document.getElementById('logLevel').value = settings.logging?.level || 'info';
          
          // å¡«å……ç¼“å­˜è®¾ç½®
          document.getElementById('cacheTtlNews').value = settings.cache?.ttl?.news || '';
          document.getElementById('cacheTtlEvents').value = settings.cache?.ttl?.events || '';
          document.getElementById('cacheTtlResults').value = settings.cache?.ttl?.results || '';
          document.getElementById('updateIntervalNews').value = settings.updateInterval?.news || '';
          document.getElementById('updateIntervalEvents').value = settings.updateInterval?.events || '';
          document.getElementById('updateIntervalResults').value = settings.updateInterval?.results || '';
          
          // å¡«å……AIè®¾ç½®
          document.getElementById('zhipuApiKeyEvo').value = settings.ai?.zhipuApiKeyEvo || '';
          document.getElementById('zhipuApiKeyAdmin').value = settings.ai?.zhipuApiKeyAdmin || '';
          document.getElementById('qwenApiKey').value = settings.ai?.qwenApiKey || '';
          document.getElementById('huggingFaceApiKey').value = settings.ai?.huggingFaceApiKey || '';
          document.getElementById('aiModel').value = settings.ai?.model || 'auto';
          
          // å¡«å……æ•°æ®åº“è®¾ç½®
          document.getElementById('supabaseUrl').value = settings.supabase?.url || '';
          document.getElementById('supabaseAnonKey').value = settings.supabase?.anonKey || '';
          
          // åŠ è½½RSSæºåˆ—è¡¨
          loadRssSources();
        }
      } catch (error) {
        console.error('åŠ è½½ç³»ç»Ÿè®¾ç½®å¤±è´¥:', error);
        showSettingsStatus('åŠ è½½ç³»ç»Ÿè®¾ç½®å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // åŠ è½½RSSæºåˆ—è¡¨
    async function loadRssSources() {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const sources = result.data;
          const container = document.getElementById('rssSourcesList');
          
          if (sources.length === 0) {
            container.innerHTML = '<p class="muted" style="text-align:center;padding:20px;">æš‚æ— RSSæºï¼Œç‚¹å‡»"æ·»åŠ RSSæº"æŒ‰é’®æ·»åŠ </p>';
            return;
          }
          
          let html = '';
          sources.forEach(source => {
            const statusColor = source.active !== false ? '#10b981' : '#ef4444';
            const statusText = source.active !== false ? 'å¯ç”¨' : 'ç¦ç”¨';
            
            html += `
              <div style="padding:16px;background:var(--bg-secondary);border:1px solid var(--border-light);border-radius:var(--radius-md);">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
                  <div style="flex:1;">
                    <div style="font-weight:600;color:var(--text-primary);margin-bottom:4px;">${source.name}</div>
                    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">${source.url}</div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                      <span style="padding:4px 8px;background:var(--primary-50);color:var(--primary);border-radius:4px;font-size:12px;">${source.type === 'media' ? 'åª’ä½“' : 'åä¼š'}</span>
                      <span style="padding:4px 8px;background:var(--gray-100);color:var(--gray-700);border-radius:4px;font-size:12px;">${source.region === 'local' ? 'æœ¬åœ°' : 'å…¨å›½'}</span>
                      <span style="padding:4px 8px;background:${statusColor}20;color:${statusColor};border-radius:4px;font-size:12px;">${statusText}</span>
                    </div>
                  </div>
                  <div style="display:flex;gap:8px;">
                    <button class="btn btn-sm btn-outline" onclick="editRssSource('${source.id}')">ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-outline" onclick="toggleRssSource('${source.id}', ${source.active !== false})">${source.active !== false ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                    <button class="btn btn-sm btn-outline" style="color:var(--danger);" onclick="deleteRssSource('${source.id}')">åˆ é™¤</button>
                  </div>
                </div>
              </div>
            `;
          });
          
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('åŠ è½½RSSæºåˆ—è¡¨å¤±è´¥:', error);
      }
    }
    
    // ç³»ç»Ÿè®¾ç½®æ ‡ç­¾é¡µåˆ‡æ¢
    document.querySelectorAll('.settings-tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.settings-tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // æ˜¾ç¤ºå¯¹åº”é¢æ¿
        document.querySelectorAll('.settings-panel').forEach(p => p.style.display = 'none');
        document.getElementById(`settings${tab.charAt(0).toUpperCase() + tab.slice(1)}`).style.display = 'block';
      });
    });
    
    // ä¿å­˜åŸºç¡€è®¾ç½®
    document.getElementById('btnSaveGeneralSettings')?.addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('adminToken');
        const settings = {
          custom: {
            server: {
              port: parseInt(document.getElementById('serverPort').value) || 3000,
              env: document.getElementById('serverEnv').value
            },
            api: {
              rateLimit: parseInt(document.getElementById('apiRateLimit').value) || 100
            },
            logging: {
              level: document.getElementById('logLevel').value
            }
          }
        };
        
        const response = await fetch(`${getApiUrl()}/api/admin/system-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ settings })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('åŸºç¡€è®¾ç½®å·²ä¿å­˜ï¼ˆéƒ¨åˆ†é…ç½®éœ€è¦ä¿®æ”¹ç¯å¢ƒå˜é‡åé‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆï¼‰', 'success');
        } else {
          showSettingsStatus('ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        showSettingsStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
      }
    });
    
    // ä¿å­˜ç¼“å­˜è®¾ç½®
    document.getElementById('btnSaveCacheSettings')?.addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('adminToken');
        const settings = {
          custom: {
            cache: {
              ttl: {
                news: parseInt(document.getElementById('cacheTtlNews').value) || 3600,
                events: parseInt(document.getElementById('cacheTtlEvents').value) || 300,
                results: parseInt(document.getElementById('cacheTtlResults').value) || 7200
              }
            },
            updateInterval: {
              news: parseInt(document.getElementById('updateIntervalNews').value) || 3600,
              events: parseInt(document.getElementById('updateIntervalEvents').value) || 300,
              results: parseInt(document.getElementById('updateIntervalResults').value) || 1800
            }
          }
        };
        
        const response = await fetch(`${getApiUrl()}/api/admin/system-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ settings })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('ç¼“å­˜é…ç½®å·²ä¿å­˜ï¼ˆéœ€è¦ä¿®æ”¹ç¯å¢ƒå˜é‡åé‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆï¼‰', 'success');
        } else {
          showSettingsStatus('ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        showSettingsStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
      }
    });
    
    // æ·»åŠ RSSæº
    document.getElementById('btnAddRssSource')?.addEventListener('click', () => {
      currentRssSourceEditId = null;
      document.getElementById('rssSourceForm').style.display = 'block';
      document.getElementById('rssSourceName').value = '';
      document.getElementById('rssSourceUrl').value = '';
      document.getElementById('rssSourceType').value = 'media';
      document.getElementById('rssSourceRegion').value = 'local';
    });
    
    // ä¿å­˜RSSæº
    document.getElementById('btnSaveRssSource')?.addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('adminToken');
        const name = document.getElementById('rssSourceName').value.trim();
        const url = document.getElementById('rssSourceUrl').value.trim();
        const type = document.getElementById('rssSourceType').value;
        const region = document.getElementById('rssSourceRegion').value;
        
        if (!name || !url) {
          showSettingsStatus('è¯·å¡«å†™å®Œæ•´çš„RSSæºä¿¡æ¯', 'error');
          return;
        }
        
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ name, url, type, region })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('RSSæºå·²æ·»åŠ ', 'success');
          document.getElementById('rssSourceForm').style.display = 'none';
          loadRssSources();
        } else {
          showSettingsStatus('æ·»åŠ å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        showSettingsStatus('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
      }
    });
    
    // å–æ¶ˆRSSæºç¼–è¾‘
    document.getElementById('btnCancelRssSource')?.addEventListener('click', () => {
      document.getElementById('rssSourceForm').style.display = 'none';
      currentRssSourceEditId = null;
    });
    
    // æµ‹è¯•RSSæº
    document.getElementById('btnTestRssSource')?.addEventListener('click', async () => {
      const url = document.getElementById('rssSourceUrl').value.trim();
      if (!url) {
        showSettingsStatus('è¯·å…ˆè¾“å…¥RSS URL', 'error');
        return;
      }
      
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources/test`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ url })
        });
        
        const result = await response.json();
        const resultDiv = document.getElementById('rssSourceTestResult');
        
        if (result.success && result.data?.valid) {
          resultDiv.innerHTML = `<div style="padding:12px;background:#d1fae5;color:#047857;border-radius:6px;">âœ… è¿æ¥æˆåŠŸï¼æ‰¾åˆ° ${result.data.itemCount} æ¡å†…å®¹</div>`;
        } else {
          resultDiv.innerHTML = `<div style="padding:12px;background:#fee2e2;color:#991b1b;border-radius:6px;">âŒ è¿æ¥å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
        }
      } catch (error) {
        document.getElementById('rssSourceTestResult').innerHTML = `<div style="padding:12px;background:#fee2e2;color:#991b1b;border-radius:6px;">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
      }
    });
    
    // ç¼–è¾‘RSSæº
    window.editRssSource = async (id) => {
      // TODO: å®ç°ç¼–è¾‘åŠŸèƒ½
      alert('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...');
    };
    
    // åˆ‡æ¢RSSæºçŠ¶æ€
    window.toggleRssSource = async (id, currentStatus) => {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources/${id}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ active: !currentStatus })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('RSSæºçŠ¶æ€å·²æ›´æ–°', 'success');
          loadRssSources();
        } else {
          showSettingsStatus('æ›´æ–°å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        showSettingsStatus('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
      }
    };
    
    // åˆ é™¤RSSæº
    window.deleteRssSource = async (id) => {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªRSSæºå—ï¼Ÿ')) return;
      
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('RSSæºå·²åˆ é™¤', 'success');
          loadRssSources();
        } else {
          showSettingsStatus('åˆ é™¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        showSettingsStatus('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    };
    
    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showSettingsStatus(message, type) {
      const statusDiv = document.getElementById('settingsStatus');
      statusDiv.style.display = 'block';
      statusDiv.style.padding = '12px';
      statusDiv.style.borderRadius = 'var(--radius-md)';
      
      if (type === 'success') {
        statusDiv.style.background = '#d1fae5';
        statusDiv.style.color = '#047857';
      } else {
        statusDiv.style.background = '#fee2e2';
        statusDiv.style.color = '#991b1b';
      }
      
      statusDiv.textContent = message;
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      const btnRefreshModelInfo = document.getElementById('btnRefreshModelInfo');
      const btnRefreshAdvice = document.getElementById('btnRefreshAdvice');
      const btnRefreshAnalytics = document.getElementById('btnRefreshAnalytics');
      const btnRefreshApis = document.getElementById('btnRefreshApis');
      const btnRefreshLearning = document.getElementById('btnRefreshLearning');
      const btnRefreshMaintenance = document.getElementById('btnRefreshMaintenance');
      
      if (btnRefreshModelInfo) {
        btnRefreshModelInfo.addEventListener('click', () => {
          loadCoreAdminModelInfo();
        });
      }
      
      if (btnRefreshAdvice) {
        btnRefreshAdvice.addEventListener('click', () => {
          loadCoreAdminAdvice();
        });
      }
      
      if (btnRefreshAnalytics) {
        btnRefreshAnalytics.addEventListener('click', () => {
          loadCoreAdminAnalytics();
        });
      }
      
      if (btnRefreshApis) {
        btnRefreshApis.addEventListener('click', () => {
          loadCoreAdminApis();
        });
      }
      
      if (btnRefreshLearning) {
        btnRefreshLearning.addEventListener('click', () => {
          loadCoreAdminLearning();
        });
      }
      
      if (btnRefreshMaintenance) {
        btnRefreshMaintenance.addEventListener('click', () => {
          loadCoreAdminMaintenance();
        });
      }
    });
    
    // ç³»ç»Ÿå‡çº§åŠŸèƒ½
    async function loadUpgradeData() {
      const CORE_ADMIN_API_BASE = 'http://localhost:3001/api';
      
      try {
        // åŠ è½½å‡çº§æ¦‚è§ˆ
        const overviewResponse = await fetch(`${CORE_ADMIN_API_BASE}/upgrade/overview`);
        if (overviewResponse.ok) {
          const overviewResult = await overviewResponse.json();
          if (overviewResult.success && overviewResult.data) {
            const overview = overviewResult.data;
            document.getElementById('upgradeVersion').textContent = `v${overview.version}`;
            document.getElementById('upgradePartsCount').textContent = overview.completedCount || '--';
            document.getElementById('upgradeNewFiles').textContent = overview.statistics?.newFiles || '--';
            document.getElementById('upgradeNewCode').textContent = (overview.statistics?.newCodeLines / 1000).toFixed(1) + 'K';
            document.getElementById('upgradeAutomation').textContent = overview.capabilities?.automation || '--';
          }
        }

        // åŠ è½½å‡çº§éƒ¨åˆ†
        const partsResponse = await fetch(`${CORE_ADMIN_API_BASE}/upgrade/parts`);
        if (partsResponse.ok) {
          const partsResult = await partsResponse.json();
          if (partsResult.success && partsResult.data) {
            renderUpgradeParts(partsResult.data);
          }
        }

        // åŠ è½½èƒ½åŠ›æå‡
        const capabilitiesResponse = await fetch(`${CORE_ADMIN_API_BASE}/upgrade/capabilities`);
        if (capabilitiesResponse.ok) {
          const capabilitiesResult = await capabilitiesResponse.json();
          if (capabilitiesResult.success && capabilitiesResult.data) {
            renderCapabilities(capabilitiesResult.data);
          }
        }
      } catch (error) {
        console.error('åŠ è½½å‡çº§æ•°æ®å¤±è´¥:', error);
        document.getElementById('upgradePartsList').innerHTML = `
          <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:1px solid #f59e0b;">
            <p style="margin:0 0 12px 0;color:#92400e;font-weight:600;">âš ï¸ æ— æ³•è¿æ¥åˆ°å‡çº§æœåŠ¡</p>
            <p style="margin:0;color:#78350f;font-size:14px;">è¯·ç¡®ä¿ä¸­æ¢ç®¡å®¶æœåŠ¡æ­£åœ¨è¿è¡Œ</p>
          </div>
        `;
      }
    }

    // æ¸²æŸ“å‡çº§éƒ¨åˆ†
    function renderUpgradeParts(parts) {
      const container = document.getElementById('upgradePartsList');
      
      if (!parts || parts.length === 0) {
        container.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">æš‚æ— å‡çº§è®°å½•</p>';
        return;
      }

      const html = parts.map(part => `
        <div style="background:#f8fafc;border-radius:12px;padding:24px;margin-bottom:16px;border:2px solid #e2e8f0;transition:all 0.3s ease;" 
             onmouseover="this.style.borderColor='#3b82f6';this.style.boxShadow='0 4px 12px rgba(59,130,246,0.15)'" 
             onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
          <div style="display:flex;align-items:start;gap:16px;">
            <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;">
              ${part.id === 'frontend' ? 'ğŸ¨' : part.id === 'security' ? 'ğŸ”’' : part.id === 'database' ? 'ğŸ—„ï¸' : 'ğŸ¤–'}
            </div>
            <div style="flex:1;">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                <h4 style="margin:0;font-size:18px;font-weight:700;color:#1e293b;">${part.name}</h4>
                <span style="background:#10b981;color:#fff;padding:4px 12px;border-radius:6px;font-size:12px;font-weight:600;">âœ… ${part.status === 'completed' ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}</span>
              </div>
              <p style="margin:0 0 16px 0;color:#64748b;font-size:14px;line-height:1.6;">${part.description}</p>
              
              ${part.files && part.files.length > 0 ? `
                <div style="margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;">ç›¸å…³æ–‡ä»¶ï¼š</div>
                  <div style="display:flex;flex-wrap:wrap;gap:8px;">
                    ${part.files.map(file => `
                      <span style="background:#e2e8f0;color:#475569;padding:4px 10px;border-radius:6px;font-size:12px;font-family:monospace;">${file}</span>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              ${part.modules && part.modules.length > 0 ? `
                <div style="margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;">æ–°å¢æ¨¡å—ï¼š</div>
                  <div style="display:flex;flex-wrap:wrap;gap:8px;">
                    ${part.modules.map(module => `
                      <div style="background:#dbeafe;color:#1e40af;padding:6px 12px;border-radius:6px;font-size:12px;display:flex;align-items:center;gap:6px;">
                        <span>ğŸ“¦</span>
                        <span>${module.name}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              ${part.benefits && part.benefits.length > 0 ? `
                <div>
                  <div style="font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;">æ”¶ç›Šï¼š</div>
                  <ul style="margin:0;padding-left:20px;color:#64748b;font-size:13px;">
                    ${part.benefits.map(benefit => `<li style="margin-bottom:4px;">${benefit}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    // æ¸²æŸ“èƒ½åŠ›æå‡
    function renderCapabilities(capabilities) {
      const container = document.getElementById('upgradeCapabilities');
      
      const html = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">
          <div style="background:linear-gradient(135deg, #e6f0ff 0%, #dbeafe 100%);border-radius:12px;padding:20px;border:2px solid rgba(59,130,246,0.2);">
            <div style="font-size:14px;font-weight:600;color:#1e40af;margin-bottom:8px;">è‡ªåŠ¨åŒ–ç‡</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.automation || '--'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);border-radius:12px;padding:20px;border:2px solid rgba(16,185,129,0.2);">
            <div style="font-size:14px;font-weight:600;color:#065f46;margin-bottom:8px;">æ™ºèƒ½åŒ–ç‡</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.intelligence || '--'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border-radius:12px;padding:20px;border:2px solid rgba(245,158,11,0.2);">
            <div style="font-size:14px;font-weight:600;color:#92400e;margin-bottom:8px;">é¢„æµ‹å‡†ç¡®ç‡</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.prediction || '--'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);border-radius:12px;padding:20px;border:2px solid rgba(236,72,153,0.2);">
            <div style="font-size:14px;font-weight:600;color:#9f1239;margin-bottom:8px;">APIå®‰å…¨æ€§</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.security || '--'}</div>
          </div>
        </div>
      `;

      container.innerHTML = html;
    }

    // æ™ºèƒ½åŠŸèƒ½æ¨¡å—åŠ è½½å‡½æ•°ï¼ˆä½¿ç”¨å…¨å±€ CORE_ADMIN_API_BASEï¼‰

    // åŠ è½½æ™ºèƒ½å†³ç­–å»ºè®®
    async function loadIntelligentAdvice() {
      const preview = document.getElementById('intelligentAdvicePreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/advice`);
        const result = await response.json();
        if (result.success && result.data) {
          const advice = result.data;
          preview.innerHTML = `<strong>${advice.title || 'æ™ºèƒ½å»ºè®®'}</strong><br>${advice.description || advice.reason || 'æš‚æ— å»ºè®®'}`;
          // å¯ä»¥æ‰“å¼€è¯¦ç»†æ¨¡æ€æ¡†æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
          showIntelligentModal('å†³ç­–å¼•æ“', advice);
        } else {
          preview.innerHTML = 'æš‚æ— å»ºè®®';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½æ™ºèƒ½å»ºè®®å¤±è´¥:', error);
      }
    }

    // åŠ è½½é¢„æµ‹ç»´æŠ¤ä¿¡æ¯
    async function loadIntelligentPredictions() {
      const preview = document.getElementById('intelligentPredictionsPreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/predictions`);
        const result = await response.json();
        if (result.success && result.data) {
          const predictions = result.data;
          const count = predictions.predictions?.length || 0;
          preview.innerHTML = `å‘ç° <strong>${count}</strong> ä¸ªæ½œåœ¨é—®é¢˜<br>${predictions.summary || 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…'}`;
          showIntelligentModal('é¢„æµ‹ç»´æŠ¤', predictions);
        } else {
          preview.innerHTML = 'æš‚æ— é¢„æµ‹ä¿¡æ¯';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½é¢„æµ‹ä¿¡æ¯å¤±è´¥:', error);
      }
    }

    // åŠ è½½å·¥ä½œæµåˆ—è¡¨
    async function loadIntelligentWorkflows() {
      const preview = document.getElementById('intelligentWorkflowsPreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/workflows`);
        const result = await response.json();
        if (result.success && result.data) {
          const workflows = result.data;
          const count = workflows.workflows?.length || 0;
          preview.innerHTML = `å…±æœ‰ <strong>${count}</strong> ä¸ªå·¥ä½œæµ<br>${workflows.summary || 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…'}`;
          showIntelligentModal('å·¥ä½œæµå¼•æ“', workflows);
        } else {
          preview.innerHTML = 'æš‚æ— å·¥ä½œæµ';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½å·¥ä½œæµå¤±è´¥:', error);
      }
    }

    // åŠ è½½å‘Šè­¦åˆ—è¡¨
    async function loadIntelligentAlerts() {
      const preview = document.getElementById('intelligentAlertsPreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/alerts`);
        const result = await response.json();
        if (result.success && result.data) {
          const alerts = result.data;
          const activeCount = alerts.alerts?.filter(a => a.status === 'active').length || 0;
          preview.innerHTML = `æ´»è·ƒå‘Šè­¦: <strong style="color:#ef4444;">${activeCount}</strong><br>${alerts.summary || 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…'}`;
          showIntelligentModal('å‘Šè­¦ç³»ç»Ÿ', alerts);
        } else {
          preview.innerHTML = 'æš‚æ— å‘Šè­¦';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½å‘Šè­¦å¤±è´¥:', error);
      }
    }

    // åŠ è½½è‡ªé€‚åº”ä¼˜åŒ–çŠ¶æ€
    async function loadIntelligentOptimization() {
      const preview = document.getElementById('intelligentOptimizationPreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/optimization`);
        const result = await response.json();
        if (result.success && result.data) {
          const optimization = result.data;
          preview.innerHTML = `ä¼˜åŒ–çŠ¶æ€: <strong>${optimization.status || 'è¿è¡Œä¸­'}</strong><br>${optimization.summary || 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…'}`;
          showIntelligentModal('è‡ªé€‚åº”ä¼˜åŒ–', optimization);
        } else {
          preview.innerHTML = 'æš‚æ— ä¼˜åŒ–ä¿¡æ¯';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½ä¼˜åŒ–ä¿¡æ¯å¤±è´¥:', error);
      }
    }

    // åŠ è½½çŸ¥è¯†å›¾è°±
    async function loadIntelligentKnowledge() {
      const preview = document.getElementById('intelligentKnowledgePreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/knowledge`);
        const result = await response.json();
        if (result.success && result.data) {
          const knowledge = result.data;
          preview.innerHTML = `å®ä½“æ•°é‡: <strong>${knowledge.entities?.length || 0}</strong><br>${knowledge.summary || 'ç‚¹å‡»æŸ¥è¯¢çŸ¥è¯†å›¾è°±'}`;
          showIntelligentModal('çŸ¥è¯†å›¾è°±', knowledge);
        } else {
          preview.innerHTML = 'æš‚æ— çŸ¥è¯†æ•°æ®';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½çŸ¥è¯†å›¾è°±å¤±è´¥:', error);
      }
    }

    // åŠ è½½æ™ºèƒ½æŠ¥å‘Š
    async function loadIntelligentReports() {
      const preview = document.getElementById('intelligentReportsPreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/reports`);
        const result = await response.json();
        if (result.success && result.data) {
          const reports = result.data;
          const count = reports.reports?.length || 0;
          preview.innerHTML = `å…±æœ‰ <strong>${count}</strong> ä¸ªæŠ¥å‘Š<br>${reports.summary || 'ç‚¹å‡»æŸ¥çœ‹æŠ¥å‘Š'}`;
          showIntelligentModal('æ™ºèƒ½æŠ¥å‘Š', reports);
        } else {
          preview.innerHTML = 'æš‚æ— æŠ¥å‘Š';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½æŠ¥å‘Šå¤±è´¥:', error);
      }
    }

    // æ˜¾ç¤ºæ™ºèƒ½åŠŸèƒ½è¯¦ç»†ä¿¡æ¯çš„æ¨¡æ€æ¡†
    function showIntelligentModal(title, data) {
      // åˆ›å»ºæˆ–è·å–æ¨¡æ€æ¡†
      let modal = document.getElementById('intelligentModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'intelligentModal';
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-content" style="max-width:800px;">
            <div class="modal-header">
              <h3 id="intelligentModalTitle">${title}</h3>
              <button class="btn btn-ghost btn-sm" onclick="closeIntelligentModal()">âœ•</button>
            </div>
            <div class="modal-body" id="intelligentModalBody" style="max-height:70vh;overflow-y:auto;">
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" onclick="closeIntelligentModal()">å…³é—­</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      document.getElementById('intelligentModalTitle').textContent = title;
      const body = document.getElementById('intelligentModalBody');
      
      // æ ¼å¼åŒ–æ˜¾ç¤ºæ•°æ®
      body.innerHTML = `<pre style="white-space:pre-wrap;word-wrap:break-word;font-family:inherit;font-size:14px;line-height:1.6;">${JSON.stringify(data, null, 2)}</pre>`;
      
      modal.style.display = 'flex';
    }

    function closeIntelligentModal() {
      const modal = document.getElementById('intelligentModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    // åˆå§‹åŒ–
    // å®‰å…¨ç‰ˆæœ¬çš„checkAuthè°ƒç”¨ï¼ˆæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼‰
    if (!window.__loginInProgress && !window.__justLoggedIn) {
      setTimeout(function() {
        if (!window.__loginInProgress && !window.__justLoggedIn) {
          checkAuth();
        }
      }, 2000);
    }
  </script>
  
  <script>
    // ä¿å­˜å…¬å‘Š
    document.getElementById('announcementForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = document.getElementById('announcementId').value;
      const content = document.getElementById('announcementContent').value.trim();
      const active = document.getElementById('announcementActive').checked;
      const token = localStorage.getItem('adminToken');
      
      if (!content) {
        alert('è¯·è¾“å…¥å…¬å‘Šå†…å®¹');
        return;
      }
      
      try {
        const url = id 
          ? `${getApiUrl()}/admin/announcements/${id}`
          : `${getApiUrl()}/admin/announcements`;
        
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ content, active })
        });
        
        if (!response.ok) throw new Error(id ? 'æ›´æ–°å¤±è´¥' : 'åˆ›å»ºå¤±è´¥');
        
        const result = await response.json();
        if (result.success) {
          document.getElementById('announcementModal').classList.remove('active');
          loadAnnouncements();
          // å¦‚æœå½“å‰åœ¨é¦–é¡µï¼Œåˆ·æ–°ä¸»é¡µå…¬å‘Šæ 
          const homeView = document.getElementById('homeView');
          if (homeView && homeView.style.display !== 'none') {
            loadHomeAnnouncementBubble();
          }
        }
      } catch (error) {
        alert((id ? 'æ›´æ–°' : 'åˆ›å»º') + 'å¤±è´¥ï¼š' + error.message);
      }
    });
    
    // ä¿®æ”¹å¯†ç åŠŸèƒ½
    document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const errorDiv = document.getElementById('passwordChangeError');
      const successDiv = document.getElementById('passwordChangeSuccess');
      const token = localStorage.getItem('adminToken');
      
      // éšè—ä¹‹å‰çš„æ¶ˆæ¯
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';
      
      // éªŒè¯æ–°å¯†ç 
      if (newPassword.length < 6) {
        errorDiv.textContent = 'æ–°å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½';
        errorDiv.style.display = 'block';
        return;
      }
      
      if (newPassword !== confirmPassword) {
        errorDiv.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´';
        errorDiv.style.display = 'block';
        return;
      }
      
      if (oldPassword === newPassword) {
        errorDiv.textContent = 'æ–°å¯†ç ä¸èƒ½ä¸åŸå¯†ç ç›¸åŒ';
        errorDiv.style.display = 'block';
        return;
      }
      
      try {
        const response = await fetch(`${getApiUrl()}/auth/change-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ oldPassword, newPassword })
        });
        
        const result = await response.json();
        
        if (result.success) {
          successDiv.style.display = 'block';
          document.getElementById('changePasswordForm').reset();
          
          // 3ç§’åéšè—æˆåŠŸæ¶ˆæ¯
          setTimeout(() => {
            successDiv.style.display = 'none';
          }, 3000);
        } else {
          errorDiv.textContent = result.error || 'å¯†ç ä¿®æ”¹å¤±è´¥';
          errorDiv.style.display = 'block';
        }
      } catch (error) {
        errorDiv.textContent = 'å¯†ç ä¿®æ”¹å¤±è´¥ï¼š' + (error.message || 'ç½‘ç»œé”™è¯¯');
        errorDiv.style.display = 'block';
      }
    });
    
    // ==========================================
    // ğŸ“° èµ„è®¯æ›´æ–°åŠŸèƒ½ï¼ˆä»ä¸»ç«™ç§»æ¤ï¼‰
    // ==========================================
    
    // èµ„è®¯æ•°æ®å­˜å‚¨
    let NEWS_DATA = [];
    let currentNewsFilter = 'all';
    let currentNewsRegion = 'local'; // 'local' æˆ– 'national'
    
    // è·å–APIé…ç½®ï¼ˆä¸ä¸»ç«™ä¸€è‡´ï¼‰
    function getApiConfig() {
      const config = localStorage.getItem('pigeon_api_config');
      if (config) {
        const parsed = JSON.parse(config);
        // ç¡®ä¿æœ‰apiUrlå­—æ®µ
        if (!parsed.apiUrl) {
          parsed.apiUrl = 'http://localhost:3000/api';
        }
        return parsed;
      }
      
      // é»˜è®¤é…ç½®ï¼ˆåç«¯æœåŠ¡åœ°å€ï¼‰
      const defaultBaseUrl = 'http://localhost:3000/api';
      return {
        apiUrl: defaultBaseUrl, // APIåŸºç¡€åœ°å€
        newsApiUrl: defaultBaseUrl + '/news', // èµ„è®¯APIåœ°å€
        eventsApiUrl: defaultBaseUrl + '/events', // èµ›äº‹APIåœ°å€
        apiKey: '' // APIå¯†é’¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
      };
    }
    
    // ä¿å­˜APIé…ç½®
    function saveApiConfig(config) {
      localStorage.setItem('pigeon_api_config', JSON.stringify(config));
    }
    
    // ä»localStorageåŠ è½½èµ„è®¯æ•°æ®
    function loadNewsFromStorage() {
      const stored = localStorage.getItem('pigeon_news_data');
      const lastUpdate = localStorage.getItem('pigeon_news_last_update');
      
      if (stored && lastUpdate) {
        const lastUpdateDate = new Date(lastUpdate);
        const now = new Date();
        const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
        
        // å¦‚æœæ•°æ®æ˜¯ä»Šå¤©çš„ï¼Œç›´æ¥ä½¿ç”¨
        if (daysDiff === 0) {
          NEWS_DATA = JSON.parse(stored);
          return true;
        }
      }
      
      return false;
    }
    
    // ä¿å­˜èµ„è®¯æ•°æ®åˆ°localStorage
    function saveNewsToStorage() {
      localStorage.setItem('pigeon_news_data', JSON.stringify(NEWS_DATA));
      localStorage.setItem('pigeon_news_last_update', new Date().toISOString());
    }
    
    // ä»çœŸå®APIè·å–èµ„è®¯æ•°æ®
    async function fetchNewsFromWeb() {
      // è·å–APIé…ç½®
      const apiConfig = getApiConfig();
      
      if (!apiConfig.newsApiUrl) {
        throw new Error('èµ„è®¯APIæœªé…ç½®ï¼Œè¯·åœ¨è®¾ç½®ä¸­é…ç½®APIåœ°å€');
      }
      
      try {
        // æ„å»ºè¯·æ±‚å¤´
        const headers = {
          'Content-Type': 'application/json'
        };
        if (apiConfig.apiKey) {
          headers['Authorization'] = 'Bearer ' + apiConfig.apiKey;
        }
        
        // å°è¯•ä»APIè·å–æ•°æ®
        const response = await fetch(apiConfig.newsApiUrl, {
          method: 'GET',
          headers: headers
        });
        
        if (!response.ok) {
          throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
        }
        
        const result = await response.json();
        
        // åç«¯APIè¿”å›æ ¼å¼: {success: true, data: [...], count: X, timestamp: "..."}
        if (!result.success) {
          throw new Error(result.error || 'APIè¿”å›é”™è¯¯');
        }
        
        const data = result.data || result;
        
        // éªŒè¯æ•°æ®æ ¼å¼
        if (!Array.isArray(data)) {
          throw new Error('APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºæ•°ç»„');
        }
        
        // è½¬æ¢æ•°æ®æ ¼å¼
        return data.map(item => ({
          id: item.id || Date.now() + Math.random(),
          title: item.title || 'æ— æ ‡é¢˜',
          source: item.source || 'æœªçŸ¥æ¥æº',
          sourceUrl: item.sourceUrl || item.url || '#',
          time: item.time || formatUpdateTime(item.updateTime),
          updateTime: item.updateTime || new Date().toISOString(),
          tags: item.tags || [],
          category: item.category || 'race',
          region: item.region || 'national',
          content: item.content || item.description || '',
          hot: item.hot || false
        }));
        
      } catch (error) {
        console.error('è·å–èµ„è®¯å¤±è´¥:', error);
        throw error;
      }
    }
    
    // æ ¼å¼åŒ–æ›´æ–°æ—¶é—´
    function formatUpdateTime(updateTime) {
      if (!updateTime) return 'æœªçŸ¥';
      const date = new Date(updateTime);
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 60) {
        return `${minutes}åˆ†é’Ÿå‰`;
      } else if (hours < 24) {
        return `${hours}å°æ—¶å‰`;
      } else if (days < 7) {
        return `${days}å¤©å‰`;
      } else {
        return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
      }
    }
    
    // æ¸²æŸ“èµ„è®¯åˆ—è¡¨
    function renderNewsList(filter = 'all', region = 'local') {
      const container = document.getElementById('homeNewsList');
      if (!container) return;
      
      // å…ˆæŒ‰åœ°åŒºç­›é€‰
      let filteredNews = NEWS_DATA.filter(n => n.region === region);
      
      // å†æŒ‰åˆ†ç±»ç­›é€‰
      if (filter !== 'all') {
        filteredNews = filteredNews.filter(n => n.category === filter);
      }
      
      // æŒ‰æ›´æ–°æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      filteredNews.sort((a, b) => {
        const timeA = new Date(a.updateTime || 0);
        const timeB = new Date(b.updateTime || 0);
        return timeB - timeA;
      });
      
      if (filteredNews.length === 0) {
        const apiConfig = getApiConfig();
        if (!apiConfig.newsApiUrl) {
          // APIæœªé…ç½®ï¼Œæ˜¾ç¤ºé…ç½®æç¤º
          showApiConfigPrompt('èµ„è®¯');
          return;
        }
        
        container.innerHTML = `
          <div style="padding:40px;text-align:center;color:#9ca3af;">
            <div style="font-size:48px;margin-bottom:16px;">ğŸ“°</div>
            <div>æš‚æ— ${region === 'local' ? 'æœ¬åœ°' : 'å…¨å›½'}èµ„è®¯</div>
            <div style="font-size:12px;margin-top:8px;">ç‚¹å‡»"åˆ·æ–°èµ„è®¯"æŒ‰é’®è·å–æœ€æ–°èµ„è®¯</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredNews.map(news => {
        const updateTimeStr = formatUpdateTime(news.updateTime);
        return `
          <div class="news-card" data-news-id="${news.id}">
            <div class="news-card-header">
              <div class="news-card-title">${news.title}</div>
              <div class="news-card-time">${news.time}</div>
            </div>
            <div class="news-card-source">æ¥æºï¼š${news.source}</div>
            <div class="news-card-update-time">æ›´æ–°æ—¶é—´ï¼š${updateTimeStr}</div>
            <div class="news-card-tags">
              ${news.hot ? '<span class="news-tag hot">ğŸ”¥ çƒ­é—¨</span>' : ''}
              ${news.tags.map(tag => `<span class="news-tag ${news.category}">#${tag}</span>`).join('')}
            </div>
            <div class="news-card-actions">
              <button class="news-card-action-btn" onclick="viewNewsDetail(${news.id})">ğŸ“– æŸ¥çœ‹è¯¦æƒ…</button>
              <button class="news-card-action-btn primary" onclick="openNewsOriginal(${news.id})">ğŸ”— æŸ¥çœ‹åŸæ–‡</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // æŸ¥çœ‹èµ„è®¯è¯¦æƒ…ï¼ˆæš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼‰
    window.viewNewsDetail = function(newsId) {
      const news = NEWS_DATA.find(n => n.id === newsId);
      if (!news) {
        alert('èµ„è®¯ä¸å­˜åœ¨');
        return;
      }
      
      const modal = document.getElementById('newsModal');
      if (!modal) return;
      
      const titleEl = document.getElementById('newsModalTitle');
      const sourceEl = document.getElementById('newsModalSource');
      const regionEl = document.getElementById('newsModalRegion');
      const updateTimeEl = document.getElementById('newsModalUpdateTime');
      const contentEl = document.getElementById('newsModalContent');
      
      if (titleEl) titleEl.textContent = news.title;
      if (sourceEl) sourceEl.textContent = `æ¥æºï¼š${news.source}`;
      if (regionEl) regionEl.textContent = news.region === 'local' ? 'ğŸ“ æœ¬åœ°èµ„è®¯' : 'ğŸŒ å…¨å›½èµ„è®¯';
      if (updateTimeEl) updateTimeEl.textContent = `æ›´æ–°æ—¶é—´ï¼š${formatUpdateTime(news.updateTime)}`;
      if (contentEl) contentEl.textContent = news.content || 'æš‚æ— è¯¦ç»†å†…å®¹';
      
      // è®¾ç½®æŸ¥çœ‹åŸæ–‡æŒ‰é’®çš„é“¾æ¥
      const viewOriginalBtn = document.getElementById('newsModalViewOriginal');
      if (viewOriginalBtn) {
        viewOriginalBtn.onclick = () => window.openNewsOriginal(newsId);
      }
      
      modal.classList.add('active');
    };
    
    // æ‰“å¼€åŸèµ„è®¯é“¾æ¥ï¼ˆæš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼‰
    window.openNewsOriginal = function(newsId) {
      const news = NEWS_DATA.find(n => n.id === newsId);
      if (!news || !news.sourceUrl) {
        alert('åŸèµ„è®¯é“¾æ¥ä¸å­˜åœ¨');
        return;
      }
      
      window.open(news.sourceUrl, '_blank');
    };
    
    // å…³é—­èµ„è®¯è¯¦æƒ…å¼¹çª—
    function closeNewsModal() {
      const modal = document.getElementById('newsModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }
    
    // è‡ªåŠ¨æ›´æ–°èµ„è®¯
    async function updateNews() {
      try {
        const news = await fetchNewsFromWeb();
        NEWS_DATA = news;
        saveNewsToStorage();
        renderNewsList(currentNewsFilter, currentNewsRegion);
        updateHomeStats();
        console.log('èµ„è®¯æ›´æ–°æˆåŠŸï¼Œå…±è·å–', news.length, 'æ¡èµ„è®¯');
      } catch (error) {
        console.error('æ›´æ–°èµ„è®¯å¤±è´¥:', error);
        
        // å¦‚æœAPIæœªé…ç½®ï¼Œæ˜¾ç¤ºé…ç½®æç¤º
        if (error.message && error.message.includes('æœªé…ç½®')) {
          NEWS_DATA = [];
          renderNewsList(currentNewsFilter, currentNewsRegion);
          showApiConfigPrompt('èµ„è®¯');
          return;
        }
        
        // å¦‚æœæ›´æ–°å¤±è´¥ï¼Œå°è¯•åŠ è½½ç¼“å­˜æ•°æ®
        if (loadNewsFromStorage()) {
          renderNewsList(currentNewsFilter, currentNewsRegion);
        } else {
          // æ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
          NEWS_DATA = [];
          renderNewsList(currentNewsFilter, currentNewsRegion);
        }
      }
    }
    
    // æ˜¾ç¤ºAPIé…ç½®æç¤º
    function showApiConfigPrompt(type) {
      const container = type === 'èµ„è®¯' ? document.getElementById('homeNewsList') : document.getElementById('homeEventsList');
      if (!container) return;
      
      const apiConfig = getApiConfig();
      const apiUrl = type === 'èµ„è®¯' ? apiConfig.newsApiUrl : apiConfig.eventsApiUrl;
      
      if (!apiUrl) {
        container.innerHTML = `
          <div style="padding:40px;text-align:center;color:#9ca3af;">
            <div style="font-size:48px;margin-bottom:16px;">${type === 'èµ„è®¯' ? 'ğŸ“°' : 'ğŸ'}</div>
            <div style="font-size:16px;font-weight:600;color:#374151;margin-bottom:8px;">${type}APIæœªé…ç½®</div>
            <div style="font-size:13px;color:#6b7280;margin-bottom:16px;">è¯·é…ç½®${type}APIåœ°å€ä»¥è·å–çœŸå®æ•°æ®</div>
            <button class="btn btn-primary btn-sm" onclick="showApiConfigModal('${type}')" style="margin-top:12px;">
              âš™ï¸ é…ç½®API
            </button>
          </div>
        `;
      }
    }
    
    // æ˜¾ç¤ºAPIé…ç½®å¼¹çª—
    window.showApiConfigModal = function(type) {
      const apiConfig = getApiConfig();
      const apiUrl = type === 'èµ„è®¯' ? apiConfig.newsApiUrl : apiConfig.eventsApiUrl;
      const apiKey = apiConfig.apiKey || '';
      
      const newsApiUrl = prompt(`è¯·è¾“å…¥${type === 'èµ„è®¯' ? 'èµ„è®¯' : 'èµ›äº‹'}APIåœ°å€:`, apiUrl || '');
      if (newsApiUrl === null) return; // ç”¨æˆ·å–æ¶ˆ
      
      const newApiKey = prompt('è¯·è¾“å…¥APIå¯†é’¥ï¼ˆå¯é€‰ï¼Œç›´æ¥å›è½¦è·³è¿‡ï¼‰:', apiKey);
      
      const newConfig = {
        ...apiConfig,
        [type === 'èµ„è®¯' ? 'newsApiUrl' : 'eventsApiUrl']: newsApiUrl,
        apiKey: newApiKey || apiKey
      };
      
      saveApiConfig(newConfig);
      
      // é‡æ–°å°è¯•è·å–æ•°æ®
      if (type === 'èµ„è®¯') {
        updateNews();
      }
      
      alert('APIé…ç½®å·²ä¿å­˜ï¼Œæ­£åœ¨è·å–æ•°æ®...');
    };
    
    // æ›´æ–°é¦–é¡µç»Ÿè®¡
    function updateHomeStats() {
      const pigeonCountEl = document.getElementById('homePigeonCount');
      if (pigeonCountEl) {
        // è¿™é‡Œå¯ä»¥ä»localStorageè·å–é¸½å­æ•°æ®
        try {
          const pigeonsData = localStorage.getItem('pigeons');
          if (pigeonsData) {
            const pigeons = JSON.parse(pigeonsData);
            pigeonCountEl.textContent = pigeons.filter(p => p && p.alive).length || 0;
          } else {
            pigeonCountEl.textContent = '0';
          }
        } catch (e) {
          pigeonCountEl.textContent = '0';
        }
      }
      
      // æ›´æ–°å…¶ä»–ç»Ÿè®¡
      const newsCountEl = document.getElementById('homeNewsCount');
      if (newsCountEl) {
        newsCountEl.textContent = NEWS_DATA.length || 0;
      }
      
      // æ›´æ–°èµ›äº‹ç»Ÿè®¡
      const activeRacesEl = document.getElementById('homeActiveRaces');
      if (activeRacesEl) {
        activeRacesEl.textContent = (EVENTS_DATA.ongoing || []).length;
      }
      
      const completedRacesEl = document.getElementById('homeCompletedRaces');
      if (completedRacesEl) {
        completedRacesEl.textContent = (EVENTS_DATA.results || []).length;
      }
      
      // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
      const now = new Date();
      const dayEl = document.getElementById('homeDay');
      const weekdayEl = document.getElementById('homeWeekday');
      const dateFullEl = document.getElementById('homeDateFull');
      
      if (dayEl) dayEl.textContent = now.getDate();
      if (weekdayEl) {
        const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        weekdayEl.textContent = weekdays[now.getDay()];
      }
      if (dateFullEl) {
        dateFullEl.textContent = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ`;
      }
    }
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°èµ„è®¯ï¼ˆæ¯å¤©æ›´æ–°ä¸€æ¬¡ï¼‰
    function checkAndUpdateNews() {
      const lastUpdate = localStorage.getItem('pigeon_news_last_update');
      if (!lastUpdate) {
        // é¦–æ¬¡åŠ è½½ï¼Œç›´æ¥æ›´æ–°
        updateNews();
        return;
      }
      
      const lastUpdateDate = new Date(lastUpdate);
      const now = new Date();
      const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
      
      if (daysDiff >= 1) {
        // è¶…è¿‡1å¤©ï¼Œéœ€è¦æ›´æ–°
        updateNews();
      } else {
        // ä½¿ç”¨ç¼“å­˜æ•°æ®
        if (loadNewsFromStorage()) {
          renderNewsList(currentNewsFilter, currentNewsRegion);
        } else {
          // å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œåˆ™æ›´æ–°
          updateNews();
        }
      }
    }
    
    // ==========================================
    // ğŸ å®æ—¶èµ›äº‹åŠŸèƒ½ï¼ˆä»ä¸»ç«™ç§»æ¤ï¼‰
    // ==========================================
    
    // èµ›äº‹æ•°æ®å­˜å‚¨
    let EVENTS_DATA = {
      ongoing: [],
      upcoming: [],
      results: []
    };
    
    let currentEventTab = 'ongoing';
    let currentEventRegion = 'local'; // 'local' æˆ– 'national'
    
    // ä»localStorageåŠ è½½èµ›äº‹æ•°æ®
    function loadEventsFromStorage() {
      const stored = localStorage.getItem('pigeon_events_data');
      const lastUpdate = localStorage.getItem('pigeon_events_last_update');
      
      if (stored && lastUpdate) {
        const lastUpdateDate = new Date(lastUpdate);
        const now = new Date();
        const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
        
        // å¦‚æœæ•°æ®æ˜¯ä»Šå¤©çš„ï¼Œç›´æ¥ä½¿ç”¨
        if (daysDiff === 0) {
          EVENTS_DATA = JSON.parse(stored);
          return true;
        }
      }
      
      return false;
    }
    
    // ä¿å­˜èµ›äº‹æ•°æ®åˆ°localStorage
    function saveEventsToStorage() {
      localStorage.setItem('pigeon_events_data', JSON.stringify(EVENTS_DATA));
      localStorage.setItem('pigeon_events_last_update', new Date().toISOString());
    }
    
    // ä»çœŸå®APIè·å–èµ›äº‹æ•°æ®
    async function fetchEventsFromWeb() {
      // è·å–APIé…ç½®
      const apiConfig = getApiConfig();
      
      if (!apiConfig.eventsApiUrl) {
        throw new Error('èµ›äº‹APIæœªé…ç½®ï¼Œè¯·åœ¨è®¾ç½®ä¸­é…ç½®APIåœ°å€');
      }
      
      try {
        // æ„å»ºè¯·æ±‚å¤´
        const headers = {
          'Content-Type': 'application/json'
        };
        if (apiConfig.apiKey) {
          headers['Authorization'] = 'Bearer ' + apiConfig.apiKey;
        }
        
        // å°è¯•ä»APIè·å–æ•°æ®ï¼ˆè·å–æ‰€æœ‰ç±»å‹çš„èµ›äº‹ï¼‰
        const response = await fetch(apiConfig.eventsApiUrl, {
          method: 'GET',
          headers: headers
        });
        
        if (!response.ok) {
          const errorText = await response.text().catch(() => '');
          throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}. ${errorText}`);
        }
        
        const result = await response.json();
        
        // åç«¯APIè¿”å›æ ¼å¼: {success: true, data: {ongoing: [], upcoming: [], results: []}}
        if (!result.success) {
          throw new Error(result.error || result.message || 'APIè¿”å›é”™è¯¯');
        }
        
        const data = result.data || result;
        
        // éªŒè¯æ•°æ®æ ¼å¼
        if (!data.ongoing || !data.upcoming || !data.results) {
          throw new Error('APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”åŒ…å«ongoingã€upcomingã€resultså­—æ®µ');
        }
        
        // è½¬æ¢æ•°æ®æ ¼å¼å¹¶éªŒè¯
        const now = new Date();
        return {
          ongoing: (data.ongoing || []).map(item => {
            const releaseTimeFull = item.releaseTimeFull ? new Date(item.releaseTimeFull) : null;
            const endTimeFull = item.endTimeFull ? new Date(item.endTimeFull) : null;
            
            if (endTimeFull && endTimeFull <= now) {
              return null;
            }
            
            if (releaseTimeFull && releaseTimeFull > now) {
              return null;
            }
            
            return {
              id: item.id || Date.now() + Math.random(),
              name: item.name || 'æœªçŸ¥èµ›äº‹',
              organizer: item.organizer || 'æœªçŸ¥ç»„ç»‡',
              source: item.source || 'æœªçŸ¥æ¥æº',
              sourceUrl: item.sourceUrl || item.url || '#',
              releaseTime: item.releaseTime || 'æœªçŸ¥æ—¶é—´',
              releaseTimeFull: item.releaseTimeFull || new Date().toISOString(),
              endTimeFull: item.endTimeFull || null,
              distance: item.distance || 'æœªçŸ¥è·ç¦»',
              status: 'ongoing',
              region: item.region || 'national',
              returned: item.returned || 0,
              total: item.total || 0,
              weather: item.weather || 'æœªçŸ¥',
              updateTime: item.updateTime || new Date().toISOString()
            };
          }).filter(item => item !== null),
          upcoming: (data.upcoming || []).map(item => {
            const startTimeFull = item.startTimeFull ? new Date(item.startTimeFull) : null;
            
            if (startTimeFull && startTimeFull <= now) {
              return null;
            }
            
            return {
              id: item.id || Date.now() + Math.random(),
              name: item.name || 'æœªçŸ¥èµ›äº‹',
              organizer: item.organizer || 'æœªçŸ¥ç»„ç»‡',
              source: item.source || 'æœªçŸ¥æ¥æº',
              sourceUrl: item.sourceUrl || item.url || '#',
              startTime: item.startTime || 'æœªçŸ¥æ—¶é—´',
              startTimeFull: item.startTimeFull || new Date(now.getTime() + 86400000).toISOString(),
              distance: item.distance || 'æœªçŸ¥è·ç¦»',
              status: 'upcoming',
              region: item.region || 'national',
              participants: item.participants || 0,
              weather: item.weather || 'æœªçŸ¥',
              updateTime: item.updateTime || new Date().toISOString()
            };
          }).filter(item => item !== null),
          results: (data.results || []).map(item => {
            const endTimeFull = item.endTimeFull ? new Date(item.endTimeFull) : null;
            
            if (endTimeFull && endTimeFull > now) {
              return null;
            }
            
            return {
              id: item.id || Date.now() + Math.random(),
              name: item.name || 'æœªçŸ¥èµ›äº‹',
              organizer: item.organizer || 'æœªçŸ¥ç»„ç»‡',
              source: item.source || 'æœªçŸ¥æ¥æº',
              sourceUrl: item.sourceUrl || item.url || '#',
              endTime: item.endTime || 'æœªçŸ¥æ—¶é—´',
              endTimeFull: item.endTimeFull || new Date(now.getTime() - 86400000).toISOString(),
              distance: item.distance || 'æœªçŸ¥è·ç¦»',
              status: 'completed',
              region: item.region || 'national',
              champion: item.champion || 'æœªçŸ¥',
              championRing: item.championRing || 'æœªçŸ¥',
              championTime: item.championTime || 'æœªçŸ¥',
              updateTime: item.updateTime || new Date().toISOString()
            };
          }).filter(item => item !== null)
        };
        
      } catch (error) {
        console.error('è·å–èµ›äº‹å¤±è´¥:', error);
        throw error;
      }
    }
    
    // éªŒè¯èµ›äº‹æ—¶é—´æ˜¯å¦æœ‰æ•ˆ
    function isValidEventTime(event, tab) {
      const now = new Date();
      
      if (tab === 'ongoing') {
        if (!event.releaseTimeFull) return false;
        const releaseTime = new Date(event.releaseTimeFull);
        const hoursSinceRelease = (now - releaseTime) / (1000 * 60 * 60);
        if (hoursSinceRelease > 24) return false;
        if (releaseTime > now) return false;
        return true;
      } else if (tab === 'upcoming') {
        if (!event.startTimeFull) return false;
        const startTime = new Date(event.startTimeFull);
        if (startTime <= now) return false;
        return true;
      } else if (tab === 'results') {
        if (!event.endTimeFull) return false;
        const endTime = new Date(event.endTimeFull);
        if (endTime > now) return false;
        return true;
      }
      
      return true;
    }
    
    // éªŒè¯èµ›äº‹æ•°æ®æ˜¯å¦è¿‡æ—¶
    function isEventOutdated(event) {
      if (!event.updateTime) return true;
      
      const updateTime = new Date(event.updateTime);
      const now = new Date();
      const hoursSinceUpdate = (now - updateTime) / (1000 * 60 * 60);
      
      if (event.status === 'ongoing' && hoursSinceUpdate > 2) {
        return true;
      }
      
      if (hoursSinceUpdate > 24) {
        return true;
      }
      
      return false;
    }
    
    // æ¸²æŸ“èµ›äº‹åˆ—è¡¨
    function renderEventsList(tab = 'ongoing', region = 'local') {
      const container = document.getElementById('homeEventsList');
      if (!container) return;
      
      // å…ˆæŒ‰åœ°åŒºç­›é€‰
      let events = (EVENTS_DATA[tab] || []).filter(event => event.region === region);
      
      // è¿‡æ»¤æ‰æ—¶é—´ä¸å»åˆçš„èµ›äº‹
      events = events.filter(event => isValidEventTime(event, tab));
      
      // è¿‡æ»¤æ‰è¿‡æ—¶çš„èµ›äº‹
      events = events.filter(event => !isEventOutdated(event));
      
      // å¯¹äº"è¿›è¡Œä¸­"çš„èµ›äº‹ï¼Œé¢å¤–éªŒè¯
      if (tab === 'ongoing') {
        events = events.filter(event => {
          if (event.endTimeFull) {
            const endTime = new Date(event.endTimeFull);
            if (endTime <= new Date()) {
              return false;
            }
          }
          return true;
        });
      }
      
      // æŒ‰æ›´æ–°æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      events.sort((a, b) => {
        const timeA = new Date(a.updateTime || 0);
        const timeB = new Date(b.updateTime || 0);
        return timeB - timeA;
      });
      
      if (events.length === 0) {
        const apiConfig = getApiConfig();
        if (!apiConfig.eventsApiUrl) {
          showApiConfigPrompt('èµ›äº‹');
          return;
        }
        
        container.innerHTML = `
          <div style="padding:40px;text-align:center;color:#9ca3af;">
            <div style="font-size:48px;margin-bottom:16px;">ğŸ</div>
            <div>æš‚æ— ${region === 'local' ? 'æœ¬åœ°' : 'å…¨å›½'}${tab === 'ongoing' ? 'è¿›è¡Œä¸­' : tab === 'upcoming' ? 'å³å°†å¼€å§‹' : 'æœ€æ–°æˆç»©'}èµ›äº‹</div>
            <div style="font-size:12px;margin-top:8px;">ç‚¹å‡»"åˆ·æ–°"æŒ‰é’®è·å–æœ€æ–°èµ›äº‹</div>
          </div>
        `;
        return;
      }
      
      if (tab === 'ongoing') {
        container.innerHTML = events.map(event => {
          const updateTimeStr = formatUpdateTime(event.updateTime);
          const progressPercent = event.total > 0 ? ((event.returned / event.total) * 100).toFixed(1) : 0;
          return `
            <div class="event-card" style="cursor:pointer;" onclick="openEventUrl('${event.sourceUrl || '#'}')">
              <div class="event-card-status ongoing">
                <span>è¿›è¡Œä¸­</span>
              </div>
              <div class="event-card-title">${event.name}</div>
              <div class="event-card-info">
                <div class="event-card-info-item">
                  <span>ğŸ¢</span>
                  <span>${event.organizer}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ“</span>
                  <span>${event.distance}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ•</span>
                  <span>æ”¾é£ï¼š${event.releaseTime}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸŒ¤ï¸</span>
                  <span>${event.weather}</span>
                </div>
              </div>
              <div class="event-card-progress">
                <div class="event-progress-bar">
                  <div class="event-progress-fill" style="width:${progressPercent}%;"></div>
                </div>
                <div class="event-progress-text">å·²å½’å·¢ ${event.returned} / ${event.total} åªï¼ˆ${progressPercent}%ï¼‰</div>
              </div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
                <span>ğŸ“° æ¥æºï¼š${event.source || 'æœªçŸ¥'}</span>
                <span>ğŸ• æ›´æ–°ï¼š${updateTimeStr}</span>
              </div>
              ${event.sourceUrl && event.sourceUrl !== '#' ? `
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                <button class="btn btn-outline btn-sm" style="width:100%;" onclick="event.stopPropagation();window.open('${event.sourceUrl}', '_blank')">
                  ğŸ”— æŸ¥çœ‹åŸèµ›äº‹ç½‘é¡µ
                </button>
              </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } else if (tab === 'upcoming') {
        container.innerHTML = events.map(event => {
          const updateTimeStr = formatUpdateTime(event.updateTime);
          return `
            <div class="event-card" style="cursor:pointer;" onclick="openEventUrl('${event.sourceUrl || '#'}')">
              <div class="event-card-status upcoming">å³å°†å¼€å§‹</div>
              <div class="event-card-title">${event.name}</div>
              <div class="event-card-info">
                <div class="event-card-info-item">
                  <span>ğŸ¢</span>
                  <span>${event.organizer}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ“</span>
                  <span>${event.distance}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ•</span>
                  <span>å¼€å§‹ï¼š${event.startTime}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ•Šï¸</span>
                  <span>å‚èµ›ï¼š${event.participants}åª</span>
                </div>
              </div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
                <span>ğŸ“° æ¥æºï¼š${event.source || 'æœªçŸ¥'}</span>
                <span>ğŸ• æ›´æ–°ï¼š${updateTimeStr}</span>
              </div>
              ${event.sourceUrl && event.sourceUrl !== '#' ? `
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                <button class="btn btn-outline btn-sm" style="width:100%;" onclick="event.stopPropagation();window.open('${event.sourceUrl}', '_blank')">
                  ğŸ”— æŸ¥çœ‹åŸèµ›äº‹ç½‘é¡µ
                </button>
              </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } else if (tab === 'results') {
        container.innerHTML = events.map(event => {
          const updateTimeStr = formatUpdateTime(event.updateTime);
          return `
            <div class="event-card" style="cursor:pointer;" onclick="openEventUrl('${event.sourceUrl || '#'}')">
              <div class="event-card-status completed">å·²ç»“æŸ</div>
              <div class="event-card-title">${event.name}</div>
              <div class="event-card-info">
                <div class="event-card-info-item">
                  <span>ğŸ¢</span>
                  <span>${event.organizer}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ“</span>
                  <span>${event.distance}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ•</span>
                  <span>ç»“æŸï¼š${event.endTime}</span>
                </div>
                <div class="event-card-info-item">
                  <span>ğŸ†</span>
                  <span>å† å†›ï¼š${event.champion} (${event.championRing})</span>
                </div>
                ${event.championTime ? `
                <div class="event-card-info-item">
                  <span>â±ï¸</span>
                  <span>æˆç»©ï¼š${event.championTime}</span>
                </div>
                ` : ''}
              </div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
                <span>ğŸ“° æ¥æºï¼š${event.source || 'æœªçŸ¥'}</span>
                <span>ğŸ• æ›´æ–°ï¼š${updateTimeStr}</span>
              </div>
              ${event.sourceUrl && event.sourceUrl !== '#' ? `
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                <button class="btn btn-outline btn-sm" style="width:100%;" onclick="event.stopPropagation();window.open('${event.sourceUrl}', '_blank')">
                  ğŸ”— æŸ¥çœ‹åŸèµ›äº‹ç½‘é¡µ
                </button>
              </div>
              ` : ''}
            </div>
          `;
        }).join('');
      }
    }
    
    // æ‰“å¼€èµ›äº‹é“¾æ¥ï¼ˆæš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼‰
    window.openEventUrl = function(url) {
      if (url && url !== '#') {
        window.open(url, '_blank');
      }
    };
    
    // è‡ªåŠ¨æ›´æ–°èµ›äº‹
    async function updateEvents() {
      try {
        const events = await fetchEventsFromWeb();
        
        // å†æ¬¡éªŒè¯å’Œè¿‡æ»¤æ•°æ®
        const now = new Date();
        
        // è¿‡æ»¤è¿›è¡Œä¸­çš„èµ›äº‹
        events.ongoing = events.ongoing.filter(event => {
          if (!event.releaseTimeFull) return false;
          const releaseTime = new Date(event.releaseTimeFull);
          if (releaseTime > now) return false;
          
          if (event.endTimeFull) {
            const endTime = new Date(event.endTimeFull);
            if (endTime <= now) return false;
          }
          
          if (event.updateTime) {
            const updateTime = new Date(event.updateTime);
            const hoursSinceUpdate = (now - updateTime) / (1000 * 60 * 60);
            if (hoursSinceUpdate > 2) return false;
          }
          
          return true;
        });
        
        // è¿‡æ»¤å³å°†å¼€å§‹çš„èµ›äº‹
        events.upcoming = events.upcoming.filter(event => {
          if (!event.startTimeFull) return false;
          const startTime = new Date(event.startTimeFull);
          return startTime > now;
        });
        
        // è¿‡æ»¤å·²ç»“æŸçš„èµ›äº‹
        events.results = events.results.filter(event => {
          if (!event.endTimeFull) return false;
          const endTime = new Date(event.endTimeFull);
          return endTime <= now;
        });
        
        EVENTS_DATA = events;
        saveEventsToStorage();
        renderEventsList(currentEventTab, currentEventRegion);
        updateHomeStats();
        console.log('èµ›äº‹æ›´æ–°æˆåŠŸï¼Œå…±è·å–', 
          events.ongoing.length + events.upcoming.length + events.results.length, 
          'åœºæœ‰æ•ˆèµ›äº‹');
      } catch (error) {
        console.error('æ›´æ–°èµ›äº‹å¤±è´¥:', error);
        
        // å¦‚æœAPIæœªé…ç½®ï¼Œæ˜¾ç¤ºé…ç½®æç¤º
        if (error.message && error.message.includes('æœªé…ç½®')) {
          EVENTS_DATA = { ongoing: [], upcoming: [], results: [] };
          renderEventsList(currentEventTab, currentEventRegion);
          showApiConfigPrompt('èµ›äº‹');
          return;
        }
        
        // å¦‚æœæ›´æ–°å¤±è´¥ï¼Œå°è¯•åŠ è½½ç¼“å­˜æ•°æ®
        if (loadEventsFromStorage()) {
          renderEventsList(currentEventTab, currentEventRegion);
        } else {
          // æ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
          EVENTS_DATA = { ongoing: [], upcoming: [], results: [] };
          renderEventsList(currentEventTab, currentEventRegion);
        }
      }
    }
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°èµ›äº‹
    function checkAndUpdateEvents() {
      const lastUpdate = localStorage.getItem('pigeon_events_last_update');
      if (!lastUpdate) {
        updateEvents();
        return;
      }
      
      const lastUpdateDate = new Date(lastUpdate);
      const now = new Date();
      const minutesSinceUpdate = (now - lastUpdateDate) / (1000 * 60);
      
      const hasOngoingEvents = (EVENTS_DATA.ongoing || []).length > 0;
      
      if (hasOngoingEvents) {
        if (minutesSinceUpdate >= 5) {
          updateEvents();
        } else {
          if (loadEventsFromStorage()) {
            renderEventsList(currentEventTab, currentEventRegion);
          } else {
            updateEvents();
          }
        }
      } else {
        if (minutesSinceUpdate >= 60) {
          updateEvents();
        } else {
          if (loadEventsFromStorage()) {
            renderEventsList(currentEventTab, currentEventRegion);
          } else {
            updateEvents();
          }
        }
      }
    }
    
    // åŠ è½½ä¸»é¡µå…¬å‘Šæ 
    // å­˜å‚¨é¦–é¡µå½“å‰å…¬å‘Šæ•°æ®
    let homeCurrentAnnouncement = null;
    
    async function loadHomeAnnouncementBubble() {
      const bubbleEl = document.getElementById('homeAnnouncementBubbleText');
      const hintEl = document.getElementById('homeAnnouncementHint');
      const bubbleContainer = document.getElementById('homeAnnouncementBubble');
      if (!bubbleEl) return;
      
      const token = localStorage.getItem('adminToken');
      if (!token) {
        bubbleEl.textContent = 'æš‚æ— å…¬å‘Š';
        homeCurrentAnnouncement = null;
        if (hintEl) hintEl.style.display = 'none';
        if (bubbleContainer) bubbleContainer.style.cursor = 'default';
        return;
      }
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`${getApiUrl()}/admin/announcements`, {
          headers: {
            'Authorization': `Bearer ${token}`
          },
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error('è·å–å…¬å‘Šå¤±è´¥');
        }
        
        const result = await response.json();
        const announcements = result.data || [];
        
        // ä¿å­˜å…¬å‘Šæ•°æ®ä¾›æŸ¥çœ‹ä½¿ç”¨
        window.announcementsData = announcements;
        
        // è·å–æœ€æ–°çš„å·²å‘å¸ƒå…¬å‘Š
        const activeAnnouncements = announcements.filter(ann => ann.active);
        if (activeAnnouncements.length > 0) {
          // æŒ‰æ›´æ–°æ—¶é—´æ’åºï¼Œè·å–æœ€æ–°çš„
          activeAnnouncements.sort((a, b) => {
            const timeA = new Date(a.updatedAt || a.createdAt);
            const timeB = new Date(b.updatedAt || b.createdAt);
            return timeB - timeA;
          });
          
          const latestAnnouncement = activeAnnouncements[0];
          homeCurrentAnnouncement = latestAnnouncement;
          
          const content = latestAnnouncement.content || 'æš‚æ— å…¬å‘Š';
          
          // å¦‚æœå†…å®¹è¾ƒé•¿ï¼Œæ˜¾ç¤ºæç¤º
          if (content.length > 50) {
            if (hintEl) hintEl.style.display = 'inline';
            // é™åˆ¶æ˜¾ç¤ºé•¿åº¦
            const maxLength = 80;
            if (content.length > maxLength) {
              bubbleEl.textContent = content.substring(0, maxLength) + '...';
            } else {
              bubbleEl.textContent = content;
            }
          } else {
            bubbleEl.textContent = content;
            if (hintEl) hintEl.style.display = 'none';
          }
          
          // æ·»åŠ ç‚¹å‡»äº‹ä»¶
          if (bubbleContainer) {
            bubbleContainer.style.cursor = 'pointer';
          }
        } else {
          bubbleEl.textContent = 'æš‚æ— å…¬å‘Š';
          homeCurrentAnnouncement = null;
          if (hintEl) hintEl.style.display = 'none';
          if (bubbleContainer) bubbleContainer.style.cursor = 'default';
        }
      } catch (error) {
        console.error('åŠ è½½å…¬å‘Šå¤±è´¥:', error);
        bubbleEl.textContent = 'æš‚æ— å…¬å‘Š';
        homeCurrentAnnouncement = null;
        if (hintEl) hintEl.style.display = 'none';
      }
    }
    
    // æ˜¾ç¤ºé¦–é¡µå…¬å‘Šè¯¦æƒ…
    window.showHomeAnnouncementDetail = function() {
      if (!homeCurrentAnnouncement) {
        console.warn('æ²¡æœ‰å¯æ˜¾ç¤ºçš„å…¬å‘Š');
        return;
      }
      
      // ä½¿ç”¨å·²æœ‰çš„æŸ¥çœ‹å…¬å‘Šæ¨¡æ€æ¡†å‡½æ•°
      if (window.viewFullAnnouncement) {
        viewFullAnnouncement(homeCurrentAnnouncement.id);
      } else {
        // å¦‚æœviewFullAnnouncementä¸å­˜åœ¨ï¼Œç›´æ¥æ˜¾ç¤º
        alert('å…¬å‘Šè¯¦æƒ…åŠŸèƒ½æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢');
      }
    };
    
    // åˆå§‹åŒ–é¦–é¡µè§†å›¾
    function initHomeView() {
      // æ›´æ–°é¦–é¡µç»Ÿè®¡
      updateHomeStats();
      
      // åŠ è½½ä¸»é¡µå…¬å‘Šæ 
      loadHomeAnnouncementBubble();
      
      // æ£€æŸ¥å¹¶æ›´æ–°èµ„è®¯
      checkAndUpdateNews();
      
      // æ£€æŸ¥å¹¶æ›´æ–°èµ›äº‹
      checkAndUpdateEvents();
      
      // ç»‘å®šèµ„è®¯ç­›é€‰æŒ‰é’®äº‹ä»¶
      document.querySelectorAll('.news-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.news-filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentNewsFilter = btn.dataset.filter;
          renderNewsList(currentNewsFilter, currentNewsRegion);
        });
      });
      
      // æœ¬åœ°/å…¨å›½èµ„è®¯æ ‡ç­¾é¡µåˆ‡æ¢
      document.querySelectorAll('.news-region-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.news-region-tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentNewsRegion = btn.dataset.region;
          renderNewsList(currentNewsFilter, currentNewsRegion);
        });
      });
      
      // åˆ·æ–°èµ„è®¯æŒ‰é’®
      const btnRefreshNews = document.getElementById('btnRefreshNews');
      if (btnRefreshNews) {
        btnRefreshNews.addEventListener('click', () => {
          updateNews();
          alert('æ­£åœ¨åˆ·æ–°èµ„è®¯ï¼Œè¯·ç¨å€™...');
        });
      }
      
      // èµ„è®¯è¯¦æƒ…å¼¹çª—å…³é—­äº‹ä»¶
      const newsModalClose = document.getElementById('newsModalClose');
      const newsModalCloseBtn = document.getElementById('newsModalCloseBtn');
      const newsModal = document.getElementById('newsModal');
      
      if (newsModalClose) {
        newsModalClose.addEventListener('click', closeNewsModal);
      }
      if (newsModalCloseBtn) {
        newsModalCloseBtn.addEventListener('click', closeNewsModal);
      }
      if (newsModal) {
        newsModal.addEventListener('click', (e) => {
          if (e.target.id === 'newsModal') {
            closeNewsModal();
          }
        });
      }
      
      // èµ›äº‹åœ°åŒºæ ‡ç­¾é¡µåˆ‡æ¢
      document.querySelectorAll('.event-region-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.event-region-tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentEventRegion = btn.dataset.region;
          renderEventsList(currentEventTab, currentEventRegion);
        });
      });
      
      // èµ›äº‹æ ‡ç­¾é¡µåˆ‡æ¢
      document.querySelectorAll('.event-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.event-tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentEventTab = btn.dataset.tab;
          renderEventsList(currentEventTab, currentEventRegion);
        });
      });
      
      // åˆ·æ–°èµ›äº‹æŒ‰é’®
      const btnRefreshEvents = document.getElementById('btnRefreshEvents');
      if (btnRefreshEvents) {
        btnRefreshEvents.addEventListener('click', () => {
          updateEvents();
          alert('æ­£åœ¨åˆ·æ–°èµ›äº‹æ•°æ®ï¼Œè¯·ç¨å€™...');
        });
      }
    }
    
    // ==========================================
    // ğŸ•Šï¸ Evo æ™ºèƒ½åŠ©æ‰‹è®¾ç½®åŠŸèƒ½
    // ==========================================
    
    const EVO_SETTINGS_KEY = 'evo_settings';
    const EVO_SYNC_KEY = 'evo_settings_sync';
    
    // é»˜è®¤è®¾ç½®
    const defaultEvoSettings = {
      enabled: true,
      position: 'bottom-right',
      displayMode: 'always',
      autoClose: 5,
      iconSize: 70,
      theme: 'purple',
      showWelcome: true,
      saveHistory: true,
      showAnalytics: true,
      showRecommendations: true,
      github: {
        repo: '',
        token: '',
        apiEndpoint: ''
      },
      functionGuides: {
        'é¦–é¡µ': {
          description: 'é¦–é¡µæ˜¯ç³»ç»Ÿçš„ä¿¡æ¯ä¸­å¿ƒ',
          features: [
            'ğŸ“° èµ›é¸½èµ„è®¯ï¼šæŸ¥çœ‹æœ€æ–°çš„èµ›é¸½ç›¸å…³èµ„è®¯ï¼Œå¯ä»¥æŒ‰ç±»å‹ï¼ˆå…¨éƒ¨/èµ›äº‹/è‚²ç§/å¥åº·ï¼‰å’Œåœ°åŒºï¼ˆæœ¬åœ°/å…¨å›½ï¼‰ç­›é€‰',
            'ğŸ å®æ—¶èµ›äº‹ï¼šæŸ¥çœ‹è¿›è¡Œä¸­ã€å³å°†å¼€å§‹å’Œæœ€æ–°æˆç»©çš„èµ›äº‹ä¿¡æ¯',
            'ğŸ§  æ™ºèƒ½æ¨èï¼šç³»ç»Ÿæ ¹æ®æ‚¨çš„æ•°æ®æä¾›ä¸ªæ€§åŒ–æ¨è',
            'â­ æˆ‘çš„å…³æ³¨ï¼šç®¡ç†æ‚¨å…³æ³¨çš„èµ›åŒºã€èµ›äº‹ç±»å‹ç­‰',
            'ğŸš€ å¿«æ·å…¥å£ï¼šå¿«é€Ÿè®¿é—®å¸¸ç”¨åŠŸèƒ½ï¼ˆæ–°å¢é¸½å­ã€å½•å…¥æˆç»©ã€é…å¯¹è¯„ä¼°ã€æ™ºèƒ½åˆ†æï¼‰',
            'ğŸ”” ä»Šæ—¥æé†’ï¼šæŸ¥çœ‹ä»Šæ—¥çš„é‡è¦æé†’äº‹é¡¹'
          ]
        },
        'æ•°æ®æ¦‚è§ˆ': {
          description: 'æŸ¥çœ‹ç³»ç»Ÿçš„æ•´ä½“æ•°æ®ç»Ÿè®¡',
          features: [
            'ğŸ“Š æ ¸å¿ƒæ•°æ®å¡ç‰‡ï¼šæ˜¾ç¤ºæ€»é¸½å­æ•°ã€åœ¨ä¸–ã€å·²æ­»äº¡ã€æœ‰æˆç»©ã€æ ¸å¿ƒç§é¸½ç­‰ç»Ÿè®¡',
            'ğŸ“ˆ å¹´åº¦ç»Ÿè®¡ï¼šæŒ‰å¹´ä»½æ±‡æ€»å‡ºç”Ÿæ•°é‡ã€æ­»äº¡æ•°é‡ä»¥åŠæœ‰å‚èµ›è®°å½•çš„é¸½å­æ•°é‡'
          ]
        },
        'é¸½å­ç®¡ç†': {
          description: 'ç®¡ç†æ‚¨çš„ä¿¡é¸½æ¡£æ¡ˆ',
          features: [
            'ğŸ“‹ è¡¨æ ¼è§†å›¾ï¼šä»¥è¡¨æ ¼å½¢å¼æŸ¥çœ‹æ‰€æœ‰é¸½å­ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¶³ç¯å·ã€åç§°ã€ç±»å‹ã€çŠ¶æ€ã€çˆ¶é¸½/æ¯é¸½ã€ç°é¸½ä¸»ã€å‚èµ›è®°å½•æ•°',
            'ğŸƒ å¡ç‰‡è§†å›¾ï¼šä»¥å¡ç‰‡å½¢å¼æŸ¥çœ‹é¸½å­ä¿¡æ¯ï¼Œæ›´ç›´è§‚ç¾è§‚',
            'â• æ–°å¢é¸½å­ï¼šæ·»åŠ æ–°çš„ä¿¡é¸½æ¡£æ¡ˆ',
            'ğŸ” æŸ¥çœ‹è¯¦æƒ…ï¼šç‚¹å‡»æŸ¥çœ‹æŒ‰é’®æŸ¥çœ‹é¸½å­çš„è¯¦ç»†ä¿¡æ¯'
          ]
        },
        'è¡€ç»Ÿå…³ç³»': {
          description: 'æŸ¥çœ‹å’Œç®¡ç†ä¿¡é¸½çš„è¡€ç»Ÿå…³ç³»æ ‘',
          features: [
            'ğŸŒ³ è¡€ç»Ÿæ ‘ï¼šé€‰æ‹©é¸½å­æŸ¥çœ‹å…¶å®Œæ•´çš„è¡€ç»Ÿå…³ç³»æ ‘ï¼ˆåŒ…æ‹¬äº²ä»£å’Œå­ä»£ï¼‰',
            'ğŸ” æœç´¢åŠŸèƒ½ï¼šé€šè¿‡è¶³ç¯å·æˆ–åå­—æœç´¢é¸½å­',
            'ğŸ“Š ç§é¸½æ ‘ï¼šæ˜¾ç¤ºæ‰€æœ‰ç§é¸½çš„å…³ç³»æ ‘'
          ]
        },
        'ç»Ÿè®¡åˆ†æ': {
          description: 'æŸ¥çœ‹å¹´åº¦ç»Ÿè®¡æ•°æ®',
          features: [
            'ğŸ“ˆ å¹´åº¦ç»Ÿè®¡æ¦‚è§ˆï¼šæŒ‰å¹´ä»½æ±‡æ€»å‡ºç”Ÿæ•°é‡ã€æ­»äº¡æ•°é‡ä»¥åŠæœ‰å‚èµ›è®°å½•çš„é¸½å­æ•°é‡',
            'ğŸ“Š æ•°æ®è¡¨æ ¼ï¼šä»¥è¡¨æ ¼å½¢å¼å±•ç¤ºç»Ÿè®¡æ•°æ®'
          ]
        },
        'æ¯”èµ›ä¸æˆç»©': {
          description: 'ç®¡ç†æ¯”èµ›å’Œæˆç»©è®°å½•',
          features: [
            'ğŸ“‹ æ¯”èµ›åˆ—è¡¨ï¼šæŸ¥çœ‹æ‰€æœ‰æ¯”èµ›ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¯”èµ›åç§°ã€æ—¥æœŸã€åœ°ç‚¹ã€è·ç¦»ã€çŠ¶æ€ã€å‚èµ›æ•°',
            'ğŸ“¥ å¯¼å…¥æˆç»©ï¼šä»Excelæ–‡ä»¶å¯¼å…¥æ¯”èµ›æˆç»©',
            'ğŸ“Š æ¯”èµ›ç»Ÿè®¡ï¼šæŸ¥çœ‹æ¯”èµ›ç»Ÿè®¡æ•°æ®',
            'ğŸ§  æˆç»©åˆ†æï¼šåˆ†ææ¯”èµ›æˆç»©è¶‹åŠ¿',
            'ğŸ§¬ è¡€ç»Ÿå¯¹æ¯”ï¼šå¯¹æ¯”ä¸åŒè¡€ç»Ÿçš„é¸½å­è¡¨ç°'
          ]
        },
        'ç¹è‚²ä¸é…å¯¹': {
          description: 'ç®¡ç†ä¿¡é¸½çš„ç¹è‚²å’Œé…å¯¹',
          features: [
            'ğŸ’• é…å¯¹é€‰æ‹©ï¼šé€‰æ‹©çˆ¶é¸½å’Œæ¯é¸½è¿›è¡Œé…å¯¹',
            'ğŸ“Š é…å¯¹åˆ†æï¼šç³»ç»Ÿè‡ªåŠ¨åˆ†æé…å¯¹å¯è¡Œæ€§',
            'â• æ–°å¢é…å¯¹ï¼šæ·»åŠ æ–°çš„é…å¯¹è®°å½•'
          ]
        },
        'å¥åº·ç®¡ç†': {
          description: 'ç®¡ç†ä¿¡é¸½çš„å¥åº·è®°å½•',
          features: [
            'ğŸ“ å¥åº·è®°å½•ï¼šè®°å½•é¸½å­çš„å¥åº·çŠ¶æ€ã€æ—¥æœŸã€å¤‡æ³¨ç­‰ä¿¡æ¯',
            'â• æ–°å¢è®°å½•ï¼šæ·»åŠ æ–°çš„å¥åº·è®°å½•',
            'ğŸ“‹ è®°å½•åˆ—è¡¨ï¼šæŸ¥çœ‹æ‰€æœ‰å¥åº·è®°å½•'
          ]
        },
        'æ™ºèƒ½åˆ†æä¸­å¿ƒ': {
          description: 'ä½¿ç”¨AIè¿›è¡Œæ™ºèƒ½åˆ†æ',
          features: [
            'ğŸ“Š è¡€ç»Ÿåˆ†æï¼šåˆ†æé¸½å­çš„è¡€ç»Ÿä¼˜åŠ¿å’Œé—ä¼ ç‰¹å¾',
            'ğŸ† æˆç»©åˆ†æï¼šåˆ†æé¸½å­çš„æ¯”èµ›è¡¨ç°å’Œæˆç»©è¶‹åŠ¿',
            'ğŸ’• é…å¯¹å»ºè®®ï¼šåŸºäºAIç®—æ³•çš„æ™ºèƒ½é…å¯¹æ¨è'
          ]
        },
        'è®­ç»ƒæ¨¡å—': {
          description: 'ç®¡ç†ä¿¡é¸½çš„è®­ç»ƒè®°å½•',
          features: [
            'ğŸ“ è®­ç»ƒè®°å½•ï¼šè®°å½•è®­ç»ƒæ—¥æœŸã€é¸½å­ã€è®­ç»ƒç±»å‹ã€è·ç¦»ã€ç”¨æ—¶ç­‰ä¿¡æ¯',
            'â• æ–°å¢è®°å½•ï¼šæ·»åŠ æ–°çš„è®­ç»ƒè®°å½•',
            'ğŸ“‹ è®°å½•åˆ—è¡¨ï¼šæŸ¥çœ‹æ‰€æœ‰è®­ç»ƒè®°å½•'
          ]
        },
        'èƒ½åŠ›ç»¼åˆåˆ†æ': {
          description: 'ç»¼åˆåˆ†æé¸½å­çš„å„é¡¹èƒ½åŠ›æŒ‡æ ‡',
          features: [
            'ğŸ† æ¯”èµ›èƒ½åŠ›ï¼šè¯„ä¼°é¸½å­çš„æ¯”èµ›è¡¨ç°èƒ½åŠ›',
            'ğŸ§¬ é—ä¼ ä»·å€¼ï¼šè¯„ä¼°é¸½å­çš„é—ä¼ ä»·å€¼',
            'ğŸ’ª å¥åº·æŒ‡æ•°ï¼šè¯„ä¼°é¸½å­çš„å¥åº·çŠ¶å†µ',
            'â­ ç»¼åˆè¯„åˆ†ï¼šç»¼åˆå„é¡¹æŒ‡æ ‡ç»™å‡ºæ€»ä½“è¯„åˆ†'
          ]
        }
      }
    };
    
    // åŠ è½½Evoè®¾ç½®
    // ä»æœåŠ¡å™¨åŠ è½½Evoè®¾ç½®ï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
    async function loadEvoSettings() {
      try {
        const token = getAuthToken();
        if (!token) {
          console.warn('æœªç™»å½•ï¼Œæ— æ³•åŠ è½½Evoè®¾ç½®');
          return;
        }
        
        // ä»æœåŠ¡å™¨åŠ è½½è®¾ç½®
        const response = await fetch(`${getApiUrl()}/admin/evo-settings`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        let settings = defaultEvoSettings;
        
        if (response.ok) {
          const result = await response.json();
          if (result.success && result.data) {
            settings = result.data;
            // ä¿å­˜åˆ°localStorageä½œä¸ºç¼“å­˜
            localStorage.setItem(EVO_SETTINGS_KEY, JSON.stringify(settings));
          }
        } else {
          // å¦‚æœæœåŠ¡å™¨åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨localStorageç¼“å­˜
          const saved = localStorage.getItem(EVO_SETTINGS_KEY);
          if (saved) {
            settings = JSON.parse(saved);
          }
        }
        
        // å¡«å……è¡¨å•
        document.getElementById('evoEnabled').checked = settings.enabled !== false;
        document.getElementById('evoPosition').value = settings.position || 'bottom-right';
        document.getElementById('evoDisplayMode').value = settings.displayMode || 'always';
        document.getElementById('evoAutoClose').value = settings.autoClose || 5;
        
        // æ¸²æŸ“åŠŸèƒ½ä½¿ç”¨è¯´æ˜ï¼ˆå¦‚æœå‡½æ•°å­˜åœ¨ï¼‰
        if (typeof renderFunctionGuides === 'function') {
          renderFunctionGuides(settings.functionGuides || defaultEvoSettings.functionGuides);
        }
        document.getElementById('evoIconSize').value = settings.iconSize || 70;
        document.getElementById('evoIconSizeValue').textContent = (settings.iconSize || 70) + 'px';
        
        // è®¾ç½®ä¸»é¢˜å•é€‰æŒ‰é’®
        const themeRadios = document.querySelectorAll('input[name="evoTheme"]');
        themeRadios.forEach(radio => {
          if (radio.value === (settings.theme || 'purple')) {
            radio.checked = true;
          }
        });
        
        document.getElementById('evoShowWelcome').checked = settings.showWelcome !== false;
        document.getElementById('evoSaveHistory').checked = settings.saveHistory !== false;
        document.getElementById('evoShowAnalytics').checked = settings.showAnalytics !== false;
        document.getElementById('evoShowRecommendations').checked = settings.showRecommendations !== false;
        
        // GitHubé…ç½®
        if (settings.github) {
          document.getElementById('evoGithubRepo').value = settings.github.repo || '';
          document.getElementById('evoGithubToken').value = settings.github.token || '';
          document.getElementById('evoGithubApiEndpoint').value = settings.github.apiEndpoint || '';
        }
        
        // å›¾æ ‡å¤§å°æ»‘å—äº‹ä»¶
        const iconSizeSlider = document.getElementById('evoIconSize');
        if (iconSizeSlider) {
          iconSizeSlider.addEventListener('input', (e) => {
            document.getElementById('evoIconSizeValue').textContent = e.target.value + 'px';
          });
        }
      } catch (error) {
        console.error('åŠ è½½Evoè®¾ç½®å¤±è´¥:', error);
        // ä½¿ç”¨localStorageä½œä¸ºå¤‡ç”¨
        const saved = localStorage.getItem(EVO_SETTINGS_KEY);
        if (saved) {
          const settings = JSON.parse(saved);
          document.getElementById('evoEnabled').checked = settings.enabled !== false;
          document.getElementById('evoPosition').value = settings.position || 'bottom-right';
          // ... å…¶ä»–å­—æ®µå¡«å……ï¼ˆåŒä¸Šï¼‰
        }
      }
    }
    
    // æ¸²æŸ“åŠŸèƒ½ä½¿ç”¨è¯´æ˜
    function renderFunctionGuides(functionGuides) {
      const container = document.getElementById('functionGuidesContainer');
      if (!container) return;
      
      container.innerHTML = '';
      
      Object.entries(functionGuides).forEach(([funcName, guide]) => {
        const guideItem = document.createElement('div');
        guideItem.className = 'function-guide-item';
        guideItem.style.cssText = `
          border: 1px solid var(--border-medium);
          border-radius: 8px;
          padding: 16px;
          background: var(--bg-secondary);
        `;
        
        guideItem.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <h4 style="margin: 0; color: var(--text-primary);">${funcName}</h4>
            <button type="button" class="btn btn-sm btn-outline" onclick="editFunctionGuide('${funcName}')" style="padding: 4px 12px;">ç¼–è¾‘</button>
          </div>
          <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">${guide.description}</div>
          <div style="font-size: 13px; color: var(--text-muted);">
            <strong>åŠŸèƒ½ç‚¹ï¼š</strong>${guide.features.length} é¡¹
          </div>
        `;
        
        container.appendChild(guideItem);
      });
    }
    
    // ç¼–è¾‘åŠŸèƒ½è¯´æ˜
    window.editFunctionGuide = function(funcName) {
      const functionGuides = getFunctionGuidesFromSettings();
      const guide = functionGuides[funcName] || { description: '', features: [] };
      
      const description = prompt(`ç¼–è¾‘"${funcName}"çš„æè¿°ï¼š`, guide.description);
      if (description === null) return;
      
      const featuresStr = prompt(`ç¼–è¾‘"${funcName}"çš„åŠŸèƒ½ç‚¹ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š`, guide.features.join('\n'));
      if (featuresStr === null) return;
      
      const features = featuresStr.split('\n').filter(f => f.trim());
      
      functionGuides[funcName] = {
        description: description.trim(),
        features: features
      };
      
      renderFunctionGuides(functionGuides);
      showEvoSettingsStatus('åŠŸèƒ½è¯´æ˜å·²æ›´æ–°ï¼Œè¯·ç‚¹å‡»"ä¿å­˜è®¾ç½®"ä¿å­˜', 'info');
    };
    
    // ä»è®¾ç½®ä¸­è·å–åŠŸèƒ½è¯´æ˜
    function getFunctionGuidesFromSettings() {
      const container = document.getElementById('functionGuidesContainer');
      if (!container) return defaultEvoSettings.functionGuides;
      
      // ä»å½“å‰æ˜¾ç¤ºçš„è®¾ç½®ä¸­è·å–ï¼ˆå®é™…åº”è¯¥ä»è¡¨å•æˆ–è®¾ç½®å¯¹è±¡ä¸­è·å–ï¼‰
      // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€
      try {
        const saved = localStorage.getItem(EVO_SETTINGS_KEY);
        if (saved) {
          const settings = JSON.parse(saved);
          return settings.functionGuides || defaultEvoSettings.functionGuides;
        }
      } catch (e) {}
      
      return defaultEvoSettings.functionGuides;
    }
    
    // ä¿å­˜Evoè®¾ç½®åˆ°æœåŠ¡å™¨ï¼ˆç®¡ç†å‘˜æƒé™ï¼Œä¸»ç«™ä¼šè‡ªåŠ¨åŒæ­¥ï¼‰
    async function saveEvoSettings() {
      try {
        const settings = {
          enabled: document.getElementById('evoEnabled').checked,
          position: document.getElementById('evoPosition').value,
          displayMode: document.getElementById('evoDisplayMode').value,
          autoClose: parseInt(document.getElementById('evoAutoClose').value) || 5,
          iconSize: parseInt(document.getElementById('evoIconSize').value) || 70,
          theme: document.querySelector('input[name="evoTheme"]:checked')?.value || 'purple',
          showWelcome: document.getElementById('evoShowWelcome').checked,
          saveHistory: document.getElementById('evoSaveHistory').checked,
          showAnalytics: document.getElementById('evoShowAnalytics').checked,
          showRecommendations: document.getElementById('evoShowRecommendations').checked,
          github: {
            repo: document.getElementById('evoGithubRepo').value.trim(),
            token: document.getElementById('evoGithubToken').value.trim(),
            apiEndpoint: document.getElementById('evoGithubApiEndpoint').value.trim()
          },
          functionGuides: getFunctionGuidesFromSettings()
        };
        
        // ç›´æ¥ä¿å­˜åˆ°æœåŠ¡å™¨ï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
        const token = getAuthToken();
        if (!token) {
          throw new Error('è¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦å·');
        }
        
        const response = await fetch(`${getApiUrl()}/admin/evo-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(settings)
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            // ä¿å­˜åˆ°localStorageä½œä¸ºç¼“å­˜
            localStorage.setItem(EVO_SETTINGS_KEY, JSON.stringify(result.data));
            
            // è®¾ç½®åŒæ­¥æ ‡å¿—ï¼Œä¸»ç«™ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶åŒæ­¥
            localStorage.setItem(EVO_SYNC_KEY, 'true');
            localStorage.setItem('evo_settings_sync_timestamp', Date.now().toString());
            
            showEvoSettingsStatus('âœ… è®¾ç½®å·²ä¿å­˜åˆ°æœåŠ¡å™¨ï¼ä¸»ç«™å°†è‡ªåŠ¨æ›´æ–°ã€‚', 'success');
            console.log('âœ… Evoè®¾ç½®å·²ä¿å­˜åˆ°æœåŠ¡å™¨ï¼Œä¸»ç«™å°†è‡ªåŠ¨åŒæ­¥');
            
            return result.data;
          } else {
            throw new Error(result.error || 'ä¿å­˜å¤±è´¥');
          }
        } else {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || 'æœåŠ¡å™¨å“åº”é”™è¯¯');
        }
      } catch (error) {
        console.error('ä¿å­˜Evoè®¾ç½®å¤±è´¥:', error);
        showEvoSettingsStatus('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
        return null;
      }
    }
    
    // é‡ç½®ä¸ºé»˜è®¤è®¾ç½®
    function resetEvoSettings() {
      if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤è®¾ç½®å—ï¼Ÿ')) {
        localStorage.removeItem(EVO_SETTINGS_KEY);
        loadEvoSettings();
        showEvoSettingsStatus('å·²é‡ç½®ä¸ºé»˜è®¤è®¾ç½®', 'info');
      }
    }
    
    // åŒæ­¥åˆ°ä¸»ç«™ï¼ˆå·²é›†æˆåˆ°saveEvoSettingsä¸­ï¼Œæ­¤å‡½æ•°ä¿ç•™ç”¨äºæ‰‹åŠ¨è§¦å‘ï¼‰
    async function syncEvoSettingsToMainSite() {
      try {
        // å…ˆä¿å­˜è®¾ç½®
        const settings = await saveEvoSettings();
        if (settings) {
          showEvoSettingsStatus('âœ… è®¾ç½®å·²ä¿å­˜å¹¶åŒæ­¥ï¼ä¸»ç«™å°†è‡ªåŠ¨æ›´æ–°ã€‚', 'success');
          
          // å¯é€‰ï¼šæ‰“å¼€ä¸»ç«™æŸ¥çœ‹æ•ˆæœ
          const mainSiteUrl = window.location.origin.replace('/admin.html', '/index.html');
          if (confirm('è®¾ç½®å·²ä¿å­˜ï¼æ˜¯å¦ç°åœ¨æ‰“å¼€ä¸»ç«™æŸ¥çœ‹æ•ˆæœï¼Ÿ')) {
            window.open(mainSiteUrl, '_blank');
          }
        }
      } catch (error) {
        console.error('åŒæ­¥åˆ°ä¸»ç«™å¤±è´¥:', error);
        showEvoSettingsStatus('âŒ åŒæ­¥å¤±è´¥ï¼š' + error.message, 'error');
      }
    }
    
    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showEvoSettingsStatus(message, type = 'info') {
      const statusEl = document.getElementById('evoSettingsStatus');
      if (!statusEl) return;
      
      statusEl.style.display = 'block';
      statusEl.textContent = message;
      
      // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
      statusEl.style.background = type === 'success' ? 'var(--success-light)' : 
                                  type === 'error' ? 'var(--danger-light)' : 
                                  'var(--primary-50)';
      statusEl.style.color = type === 'success' ? 'var(--success)' : 
                             type === 'error' ? 'var(--danger)' : 
                             'var(--primary)';
      statusEl.style.border = `1px solid ${type === 'success' ? 'var(--success)' : 
                                            type === 'error' ? 'var(--danger)' : 
                                            'var(--primary)'}`;
      
      // 3ç§’åè‡ªåŠ¨éšè—
      setTimeout(() => {
        statusEl.style.display = 'none';
      }, 3000);
    }
    
    // åŠ è½½AIæ¨¡å‹ä¿¡æ¯ï¼ˆæ™ºèƒ½ç®¡ç†ï¼‰
    async function loadAdminAIModelInfo() {
      try {
        const token = getAuthToken();
        if (!token) return;
        
        const response = await fetch(`${getApiUrl()}/evo/model-info`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.data) {
            displayAdminAIModelInfo(data.data);
          }
        }
      } catch (error) {
        console.error('åŠ è½½AIæ¨¡å‹ä¿¡æ¯å¤±è´¥:', error);
        // ä½¿ç”¨é»˜è®¤ä¿¡æ¯
        displayAdminAIModelInfo({
          name: 'Zephyr-7B-Beta',
          provider: 'Hugging Face',
          source: 'https://huggingface.co/HuggingFaceH4/zephyr-7b-beta',
          free: true,
          features: ['å®Œå…¨å…è´¹ä½¿ç”¨', 'æ— éœ€ä¿¡ç”¨å¡', 'æ”¯æŒä¸­æ–‡å¯¹è¯', 'é«˜æ€§èƒ½å“åº”', 'å¼€æºæ¨¡å‹']
        });
      }
    }
    
    // æ˜¾ç¤ºAIæ¨¡å‹ä¿¡æ¯ï¼ˆæ™ºèƒ½ç®¡ç†ï¼‰
    function displayAdminAIModelInfo(modelInfo) {
      if (!modelInfo) return;
      
      const nameEl = document.getElementById('adminAIModelName');
      const providerEl = document.getElementById('adminAIProvider');
      const sourceEl = document.getElementById('adminAISource');
      const statusEl = document.getElementById('adminAIStatus');
      const featuresEl = document.getElementById('adminAIFeatures');
      
      if (nameEl) nameEl.textContent = modelInfo.name || 'æœªçŸ¥';
      if (providerEl) providerEl.textContent = modelInfo.provider || 'æœªçŸ¥';
      if (sourceEl) {
        sourceEl.href = modelInfo.source || '#';
        sourceEl.textContent = modelInfo.source ? 'æŸ¥çœ‹æ¨¡å‹è¯¦æƒ…' : 'æœªçŸ¥';
      }
      
      if (statusEl) {
        statusEl.textContent = modelInfo.free ? 'âœ… å…è´¹ä½¿ç”¨' : 'ğŸ’° ä»˜è´¹';
        statusEl.style.background = modelInfo.free ? 'rgba(76, 175, 80, 0.3)' : 'rgba(255, 152, 0, 0.3)';
      }
      
      if (featuresEl && modelInfo.features) {
        featuresEl.innerHTML = modelInfo.features.map(f => `â€¢ ${f}`).join('<br>');
      }
    }
    
    // æµ‹è¯•AIè¿æ¥ï¼ˆæ™ºèƒ½ç®¡ç†ï¼‰
    async function testAdminAIConnection() {
      const btn = document.getElementById('btnAdminTestAI');
      const statusEl = document.getElementById('adminAIStatus');
      
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'æµ‹è¯•ä¸­...';
      }
      
      if (statusEl) {
        statusEl.textContent = 'æµ‹è¯•ä¸­...';
        statusEl.style.background = 'rgba(255, 152, 0, 0.3)';
      }
      
      try {
        const token = getAuthToken();
        if (!token) {
          throw new Error('è¯·å…ˆç™»å½•');
        }
        
        const response = await fetch(`${getApiUrl()}/evo/test`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          if (statusEl) {
            statusEl.textContent = 'âœ… è¿æ¥æ­£å¸¸';
            statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
          }
          alert('AI è¿æ¥æµ‹è¯•æˆåŠŸï¼\n\næ¨¡å‹ï¼š' + (data.data?.model || 'æœªçŸ¥') + '\næä¾›å•†ï¼š' + (data.data?.provider || 'æœªçŸ¥'));
        } else {
          throw new Error(data.message || 'è¿æ¥å¤±è´¥');
        }
      } catch (error) {
        if (statusEl) {
          statusEl.textContent = 'âŒ è¿æ¥å¤±è´¥';
          statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
        }
        alert('AI è¿æ¥æµ‹è¯•å¤±è´¥ï¼š' + error.message);
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'æµ‹è¯• AI è¿æ¥';
        }
      }
    }
    
    // ç”¨æˆ·ä¿¡æ¯å’Œè®¾ç½®æ¨¡æ€æ¡†å‡½æ•°
    // åŠ è½½ç”¨æˆ·è®¾ç½®
    function loadUserSettings() {
      try {
        const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
        return {
          avatar: settings.avatar || null,
          displayName: settings.displayName || null
        };
      } catch (e) {
        console.error('åŠ è½½ç”¨æˆ·è®¾ç½®å¤±è´¥:', e);
        return { avatar: null, displayName: null };
      }
    }
    
    // ä¿å­˜ç”¨æˆ·è®¾ç½®
    function saveUserSettings(settings) {
      try {
        localStorage.setItem('userSettings', JSON.stringify(settings));
        return true;
      } catch (e) {
        console.error('ä¿å­˜ç”¨æˆ·è®¾ç½®å¤±è´¥:', e);
        return false;
      }
    }
    
    // æ›´æ–°é¡¶éƒ¨å¯¼èˆªæ çš„ç”¨æˆ·æ˜¾ç¤º
    function updateTopBarUserDisplay() {
      const settings = loadUserSettings();
      const adminUserName = document.getElementById('adminUserName');
      const btnUserAvatar = document.getElementById('btnUserAvatar');
      
      // æ›´æ–°ç”¨æˆ·åæ˜¾ç¤º
      if (adminUserName) {
        const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
        const displayName = settings.displayName || userInfo.username || 'ç®¡ç†å‘˜';
        adminUserName.textContent = `æ¬¢è¿ï¼Œ${displayName}`;
      }
      
      // æ›´æ–°è´¦æˆ·æŒ‰é’®
      if (btnUserAvatar) {
        const avatarSpan = btnUserAvatar.querySelector('span:first-child');
        const textSpan = btnUserAvatar.querySelector('span:last-child');
        
        if (settings.avatar) {
          // å¦‚æœæœ‰è‡ªå®šä¹‰å¤´åƒï¼Œæ˜¾ç¤ºå¤´åƒå›¾ç‰‡
          if (!avatarSpan || avatarSpan.textContent === 'ğŸ‘¤') {
            const img = document.createElement('img');
            img.src = settings.avatar;
            img.style.cssText = 'width:20px;height:20px;border-radius:50%;object-fit:cover;';
            if (avatarSpan) {
              avatarSpan.replaceWith(img);
            } else {
              btnUserAvatar.insertBefore(img, textSpan);
            }
          } else if (avatarSpan.tagName === 'IMG') {
            avatarSpan.src = settings.avatar;
          }
        } else {
          // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰å¤´åƒï¼Œæ˜¾ç¤ºé»˜è®¤å›¾æ ‡
          if (avatarSpan && avatarSpan.tagName === 'IMG') {
            const span = document.createElement('span');
            span.textContent = 'ğŸ‘¤';
            span.style.fontSize = '16px';
            avatarSpan.replaceWith(span);
          }
        }
        
        if (textSpan) {
          const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
          const displayName = settings.displayName || userInfo.username || 'è´¦æˆ·';
          textSpan.textContent = displayName.length > 8 ? displayName.substring(0, 8) + '...' : displayName;
        }
      }
    }
    
    window.showUserInfoModal = function() {
      const modal = document.getElementById('userInfoModal');
      if (!modal) return;
      
      // åˆ‡æ¢åˆ°æŸ¥çœ‹æ¨¡å¼
      document.getElementById('userInfoViewMode').style.display = 'block';
      document.getElementById('userInfoEditMode').style.display = 'none';
      
      // ä»localStorageæˆ–å½“å‰ç™»å½•ä¿¡æ¯è·å–ç”¨æˆ·æ•°æ®
      const adminUserName = document.getElementById('adminUserName')?.textContent || '';
      const userNameMatch = adminUserName.match(/æ¬¢è¿ï¼Œ(.+)/);
        const defaultUserName = userNameMatch ? userNameMatch[1] : 'ç®¡ç†å‘˜';
      
      // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆä»localStorageæˆ–APIï¼‰
      const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
      const userSettings = loadUserSettings();
      const userName = userSettings.displayName || defaultUserName;
      const userEmail = userInfo.email || 'admin@example.com';
      const userType = userInfo.type || 'ç®¡ç†å‘˜';
      const registerDate = userInfo.registerDate || new Date().toISOString().split('T')[0];
      const userRole = userInfo.role || 'ç®¡ç†å‘˜';
      
      // æ›´æ–°æ˜¾ç¤º
      const avatarDisplay = document.getElementById('userAvatarDisplay');
      if (userSettings.avatar) {
        avatarDisplay.style.backgroundImage = `url(${userSettings.avatar})`;
        avatarDisplay.textContent = '';
      } else {
        avatarDisplay.style.backgroundImage = '';
        avatarDisplay.textContent = 'ğŸ‘¤';
      }
      
      document.getElementById('userNameDisplay').textContent = userName;
      document.getElementById('userEmailDisplay').textContent = userEmail;
      document.getElementById('userTypeDisplay').textContent = userType;
      document.getElementById('userRegisterDate').textContent = registerDate;
      document.getElementById('userRoleDisplay').textContent = userRole;
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      modal.style.display = 'flex';
    };
    
    // è¿›å…¥ç¼–è¾‘æ¨¡å¼
    window.enterEditUserInfoMode = function() {
      document.getElementById('userInfoViewMode').style.display = 'none';
      document.getElementById('userInfoEditMode').style.display = 'block';
      
      // åŠ è½½å½“å‰è®¾ç½®
      const userSettings = loadUserSettings();
      const adminUserName = document.getElementById('adminUserName')?.textContent || '';
      const userNameMatch = adminUserName.match(/æ¬¢è¿ï¼Œ(.+)/);
        const defaultUserName = userNameMatch ? userNameMatch[1] : 'ç®¡ç†å‘˜';
      const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
      
      // è®¾ç½®å¤´åƒæ˜¾ç¤º
      const avatarEditDisplay = document.getElementById('userAvatarEditDisplay');
      if (userSettings.avatar) {
        avatarEditDisplay.style.backgroundImage = `url(${userSettings.avatar})`;
        avatarEditDisplay.textContent = '';
      } else {
        avatarEditDisplay.style.backgroundImage = '';
        avatarEditDisplay.textContent = 'ğŸ‘¤';
      }
      
      // è®¾ç½®åå­—è¾“å…¥æ¡†
      document.getElementById('userNameInput').value = userSettings.displayName || defaultUserName;
      
      // ç»‘å®šå¤´åƒä¸Šä¼ äº‹ä»¶
      const avatarInput = document.getElementById('userAvatarInput');
      if (avatarInput) {
        avatarInput.onchange = function(e) {
          const file = e.target.files[0];
          if (file) {
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º2MBï¼‰
            if (file.size > 2 * 1024 * 1024) {
              alert('å¤´åƒæ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡2MB');
              return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
              alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
              return;
            }
            
            // è¯»å–æ–‡ä»¶å¹¶è½¬æ¢ä¸ºbase64
            const reader = new FileReader();
            reader.onload = function(e) {
              const base64 = e.target.result;
              avatarEditDisplay.style.backgroundImage = `url(${base64})`;
              avatarEditDisplay.textContent = '';
            };
            reader.readAsDataURL(file);
          }
        };
      }
    };
    
    // å–æ¶ˆç¼–è¾‘
    window.cancelEditUserInfo = function() {
      document.getElementById('userInfoViewMode').style.display = 'block';
      document.getElementById('userInfoEditMode').style.display = 'none';
      showUserInfoModal(); // é‡æ–°åŠ è½½æ˜¾ç¤º
    };
    
    // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
    window.saveUserInfo = function() {
      const userNameInput = document.getElementById('userNameInput');
      const avatarInput = document.getElementById('userAvatarInput');
      const avatarEditDisplay = document.getElementById('userAvatarEditDisplay');
      
      const displayName = userNameInput.value.trim();
      if (!displayName) {
        alert('è¯·è¾“å…¥æ˜µç§°');
        return;
      }
      
      // è·å–å¤´åƒï¼ˆbase64ï¼‰
      let avatar = null;
      if (avatarEditDisplay.style.backgroundImage && avatarEditDisplay.style.backgroundImage !== 'none') {
        avatar = avatarEditDisplay.style.backgroundImage.replace('url("', '').replace('")', '').replace("url('", '').replace("')", '');
      }
      
      // ä¿å­˜è®¾ç½®
      const success = saveUserSettings({
        avatar: avatar,
        displayName: displayName
      });
      
      if (success) {
        // æ›´æ–°é¡¶éƒ¨å¯¼èˆªæ 
        updateTopBarUserDisplay();
        
        // åˆ‡æ¢å›æŸ¥çœ‹æ¨¡å¼å¹¶åˆ·æ–°
        cancelEditUserInfo();
        alert('ä¿å­˜æˆåŠŸï¼');
      } else {
        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    };
    
    window.closeUserInfoModal = function() {
      const modal = document.getElementById('userInfoModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };
    
    window.showSettingsModal = function() {
      const modal = document.getElementById('settingsModal');
      if (!modal) return;
      modal.style.display = 'flex';
      // æ›´æ–°ä¸»é¢˜æŒ‰é’®æ–‡æœ¬
      const themeBtn = document.getElementById('btnToggleThemeInModal');
      if (themeBtn) {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        themeBtn.textContent = currentTheme === 'dark' ? 'â˜€ï¸ æµ…è‰²æ¨¡å¼' : 'ğŸŒ™ å¤œé—´æ¨¡å¼';
        themeBtn.title = currentTheme === 'dark' ? 'åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼' : 'åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼';
      }
    };
    
    window.closeSettingsModal = function() {
      const modal = document.getElementById('settingsModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };
    
    // æ•°æ®å¯¼å‡ºå’Œå¯¼å…¥åŠŸèƒ½
    window.exportAllData = function() {
      try {
        // ä»localStorageè¯»å–ä¸»ç«™æ•°æ®
        const pigeonsData = JSON.parse(localStorage.getItem('pigeons') || '[]');
        const racesData = JSON.parse(localStorage.getItem('races') || '[]');
        const pairingsData = JSON.parse(localStorage.getItem('pairings') || '[]');
        const healthRecordsData = JSON.parse(localStorage.getItem('healthRecords') || '[]');
        const usedNamesData = JSON.parse(localStorage.getItem('usedNames') || '[]');
        const ownerRegionPairsData = JSON.parse(localStorage.getItem('ownerRegionPairs') || '[]');
        
        const exportData = {
          version: '2.0',
          exportDate: new Date().toISOString(),
          data: {
            pigeons: pigeonsData,
            races: racesData,
            pairings: pairingsData,
            healthRecords: healthRecordsData,
            usedNames: usedNamesData,
            ownerRegionPairs: ownerRegionPairsData
          }
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pigeon_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('æ•°æ®å¤‡ä»½å·²ä¸‹è½½ï¼\n\nå¤‡ä»½äº† ' + pigeonsData.length + ' åªé¸½å­çš„æ•°æ®ã€‚\nè¯·å¦¥å–„ä¿ç®¡å¤‡ä»½æ–‡ä»¶ã€‚');
      } catch (error) {
        console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
        alert('å¯¼å‡ºæ•°æ®å¤±è´¥ï¼š' + error.message);
      }
    };
    
    window.importBackupData = function(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const backupData = JSON.parse(e.target.result);
          
          if (!backupData.data || !backupData.data.pigeons) {
            alert('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼');
            return;
          }
          
          if (!confirm(`ç¡®å®šè¦æ¢å¤å¤‡ä»½æ•°æ®å—ï¼Ÿ\n\nå¤‡ä»½æ—¶é—´: ${backupData.exportDate}\né¸½å­æ•°é‡: ${backupData.data.pigeons.length}\næ¯”èµ›æ•°é‡: ${backupData.data.races?.length || 0}\n\nâš ï¸ è¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼`)) {
            return;
          }
          
          // æ¢å¤æ•°æ®åˆ°localStorage
          localStorage.setItem('pigeons', JSON.stringify(backupData.data.pigeons));
          
          if (backupData.data.races) {
            localStorage.setItem('races', JSON.stringify(backupData.data.races));
          }
          
          if (backupData.data.pairings) {
            localStorage.setItem('pairings', JSON.stringify(backupData.data.pairings));
          }
          
          if (backupData.data.healthRecords) {
            localStorage.setItem('healthRecords', JSON.stringify(backupData.data.healthRecords));
          }
          
          if (backupData.data.usedNames) {
            localStorage.setItem('usedNames', JSON.stringify(backupData.data.usedNames));
          }
          
          if (backupData.data.ownerRegionPairs) {
            localStorage.setItem('ownerRegionPairs', JSON.stringify(backupData.data.ownerRegionPairs));
          }
          
          alert('æ•°æ®æ¢å¤æˆåŠŸï¼\n\nå·²æ¢å¤ ' + backupData.data.pigeons.length + ' åªé¸½å­çš„æ•°æ®ã€‚\nè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹æ›´æ–°ã€‚');
        } catch (error) {
          console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
          alert('å¯¼å…¥æ•°æ®å¤±è´¥ï¼š' + error.message);
        }
      };
      reader.readAsText(file);
    };
    
    // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    function initAdminUserInfo() {
      const userInfo = localStorage.getItem('adminUserInfo');
      if (!userInfo) {
        const adminUserName = document.getElementById('adminUserName')?.textContent || '';
        const userNameMatch = adminUserName.match(/æ¬¢è¿ï¼Œ(.+)/);
        const userName = userNameMatch ? userNameMatch[1] : 'ç®¡ç†å‘˜';
        
        const defaultUserInfo = {
          name: userName,
          email: 'admin@example.com',
          type: 'ç®¡ç†å‘˜',
          role: 'ç®¡ç†å‘˜',
          registerDate: new Date().toISOString().split('T')[0]
        };
        localStorage.setItem('adminUserInfo', JSON.stringify(defaultUserInfo));
      }
    }
    
    // ç»‘å®šç”¨æˆ·å¤´åƒå’Œè®¾ç½®æŒ‰é’®äº‹ä»¶
    function bindUserButtons() {
      // ç»‘å®šç”¨æˆ·å¤´åƒæŒ‰é’®
      const btnUserAvatar = document.getElementById('btnUserAvatar');
      if (btnUserAvatar) {
        btnUserAvatar.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          showUserInfoModal();
        });
        
        // é¡µé¢åŠ è½½æ—¶æ›´æ–°é¡¶éƒ¨å¯¼èˆªæ çš„ç”¨æˆ·æ˜¾ç¤º
        updateTopBarUserDisplay();
      }
      
      // ç»‘å®šè®¾ç½®æŒ‰é’®
      const btnSettings = document.getElementById('btnSettings');
      if (btnSettings) {
        btnSettings.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          showSettingsModal();
        });
      }
      
      // ç»‘å®šè®¾ç½®æ¨¡æ€æ¡†å†…çš„æŒ‰é’®
      const btnToggleThemeInModal = document.getElementById('btnToggleThemeInModal');
      if (btnToggleThemeInModal) {
        btnToggleThemeInModal.addEventListener('click', function() {
          const themeToggle = document.getElementById('themeToggle');
          if (themeToggle) {
            themeToggle.click();
          }
          // æ›´æ–°æŒ‰é’®æ–‡æœ¬
          setTimeout(() => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            btnToggleThemeInModal.textContent = currentTheme === 'dark' ? 'â˜€ï¸ æµ…è‰²æ¨¡å¼' : 'ğŸŒ™ å¤œé—´æ¨¡å¼';
            btnToggleThemeInModal.title = currentTheme === 'dark' ? 'åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼' : 'åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼';
          }, 100);
        });
      }
      
      // ç»‘å®šæ•°æ®ç®¡ç†æŒ‰é’®
      const btnBackupDataInModal = document.getElementById('btnBackupDataInModal');
      if (btnBackupDataInModal) {
        btnBackupDataInModal.addEventListener('click', function() {
          exportAllData();
        });
      }
      
      const btnExportDataInModal = document.getElementById('btnExportDataInModal');
      if (btnExportDataInModal) {
        btnExportDataInModal.addEventListener('click', function() {
          exportAllData();
        });
      }
      
      const btnImportDataInModal = document.getElementById('btnImportDataInModal');
      if (btnImportDataInModal) {
        btnImportDataInModal.addEventListener('click', function() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
              importBackupData(file);
            }
          };
          input.click();
        });
      }
      
      // ç»‘å®šé€€å‡ºç™»å½•æŒ‰é’®ï¼ˆåœ¨è®¾ç½®æ¨¡æ€æ¡†å†…ï¼‰
      const logoutBtnInModal = document.getElementById('logoutBtnInModal');
      if (logoutBtnInModal) {
        logoutBtnInModal.addEventListener('click', function() {
          localStorage.removeItem('adminToken');
          localStorage.removeItem('adminUser');
          const loginPage = document.getElementById('loginPage');
          const adminPage = document.getElementById('adminPage');
          if (loginPage) loginPage.style.display = 'flex';
          if (adminPage) adminPage.style.display = 'none';
          const usernameInput = document.getElementById('username');
          const passwordInput = document.getElementById('password');
          if (usernameInput) usernameInput.value = '';
          if (passwordInput) passwordInput.value = '';
          closeSettingsModal();
        });
      }
      
      // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
      const userInfoModal = document.getElementById('userInfoModal');
      const settingsModal = document.getElementById('settingsModal');
      
      if (userInfoModal) {
        userInfoModal.addEventListener('click', function(e) {
          if (e.target === userInfoModal) {
            closeUserInfoModal();
          }
        });
      }
      
      if (settingsModal) {
        settingsModal.addEventListener('click', function(e) {
          if (e.target === settingsModal) {
            closeSettingsModal();
          }
        });
      }
      
      // ESCé”®å…³é—­æ¨¡æ€æ¡†
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeUserInfoModal();
          closeSettingsModal();
        }
      });
    }
    
    // ç»‘å®šEvoè®¾ç½®æŒ‰é’®äº‹ä»¶
    document.addEventListener('DOMContentLoaded', () => {
      // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
      initAdminUserInfo();
      
      // ç»‘å®šç”¨æˆ·æŒ‰é’®
      bindUserButtons();
      
      // å»¶è¿Ÿç»‘å®šï¼Œç¡®ä¿ç”¨æˆ·åå·²åŠ è½½
      setTimeout(() => {
        initAdminUserInfo();
      }, 1000);
      const btnSave = document.getElementById('btnSaveEvoSettings');
      const btnReset = document.getElementById('btnResetEvoSettings');
      const btnSync = document.getElementById('btnSyncEvoSettings');
      const btnTestAI = document.getElementById('btnAdminTestAI');
      
      if (btnSave) {
        btnSave.addEventListener('click', saveEvoSettings);
      }
      
      if (btnReset) {
        btnReset.addEventListener('click', resetEvoSettings);
      }
      
      if (btnSync) {
        btnSync.addEventListener('click', syncEvoSettingsToMainSite);
      }
      
      if (btnTestAI) {
        btnTestAI.addEventListener('click', testAdminAIConnection);
      }
      
      // å½“åˆ‡æ¢åˆ°Evoè®¾ç½®æ ‡ç­¾æ—¶ï¼ŒåŠ è½½AIæ¨¡å‹ä¿¡æ¯
      const evoSettingsTab = document.getElementById('evoSettingsTab');
      if (evoSettingsTab) {
        // ç«‹å³åŠ è½½ä¸€æ¬¡ï¼ˆå¦‚æœæ ‡ç­¾é¡µå·²ç»æ˜¾ç¤ºï¼‰
        if (evoSettingsTab.style.display !== 'none') {
          console.log('ğŸ”„ Evoè®¾ç½®é¡µé¢å·²æ˜¾ç¤ºï¼Œç«‹å³åŠ è½½AIä¿¡æ¯...');
          setTimeout(() => {
            loadAdminAIModelInfo();
            loadEvoAIModelInfo();
          }, 200);
        }
        
        const observer = new MutationObserver((mutations) => {
          if (evoSettingsTab.style.display !== 'none') {
            console.log('ğŸ”„ Evoè®¾ç½®é¡µé¢æ˜¾ç¤ºï¼ŒåŠ è½½AIä¿¡æ¯...');
            setTimeout(() => {
              loadAdminAIModelInfo();
              loadEvoAIModelInfo();
            }, 200);
          }
        });
        observer.observe(evoSettingsTab, { attributes: true, attributeFilter: ['style'] });
        
        // ç›‘å¬æ‰€æœ‰å¯èƒ½çš„æ ‡ç­¾åˆ‡æ¢æ–¹å¼
        // æ–¹å¼1ï¼šé€šè¿‡å¯¼èˆªèœå•
        document.querySelectorAll('[data-tab="evoSettings"], [onclick*="evoSettings"]').forEach(el => {
          el.addEventListener('click', () => {
            setTimeout(() => {
              if (evoSettingsTab.style.display !== 'none') {
                console.log('ğŸ”„ ç‚¹å‡»Evoè®¾ç½®æ ‡ç­¾ï¼ŒåŠ è½½AIä¿¡æ¯...');
                loadEvoAIModelInfo();
              }
            }, 300);
          });
        });
        
        // æ–¹å¼2ï¼šé€šè¿‡ä¾§è¾¹æ ç‚¹å‡»
        const sidebarLinks = document.querySelectorAll('a, .nav-item, .menu-item');
        sidebarLinks.forEach(link => {
          if (link.textContent && link.textContent.includes('Evoè®¾ç½®')) {
            link.addEventListener('click', () => {
              setTimeout(() => {
                if (evoSettingsTab.style.display !== 'none') {
                  console.log('ğŸ”„ é€šè¿‡ä¾§è¾¹æ æ‰“å¼€Evoè®¾ç½®ï¼ŒåŠ è½½AIä¿¡æ¯...');
                  loadEvoAIModelInfo();
                }
              }, 300);
            });
          }
        });
      }
      
      // é¡µé¢åŠ è½½å®Œæˆåä¹Ÿå°è¯•åŠ è½½ä¸€æ¬¡
      if (document.readyState === 'complete') {
        setTimeout(() => {
          if (evoSettingsTab && evoSettingsTab.style.display !== 'none') {
            console.log('ğŸ”„ é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥Evoè®¾ç½®é¡µé¢...');
            loadEvoAIModelInfo();
          }
        }, 1000);
      } else {
        window.addEventListener('load', () => {
          setTimeout(() => {
            if (evoSettingsTab && evoSettingsTab.style.display !== 'none') {
              console.log('ğŸ”„ çª—å£åŠ è½½å®Œæˆï¼Œæ£€æŸ¥Evoè®¾ç½®é¡µé¢...');
              loadEvoAIModelInfo();
            }
          }, 1000);
        });
      }
      
      // ç»‘å®šEvoè®¾ç½®é¡µé¢çš„AIä¿¡æ¯æŒ‰é’®
      const btnRefreshAI = document.getElementById('btnEvoRefreshAIInfo');
      const btnTestEvoAI = document.getElementById('btnEvoTestAI');
      
      if (btnRefreshAI) {
        btnRefreshAI.addEventListener('click', () => {
          console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°AIä¿¡æ¯æŒ‰é’®è¢«ç‚¹å‡»');
          loadEvoAIModelInfo();
          const statusEl = document.getElementById('evoAIInfoStatus');
          if (statusEl) {
            statusEl.style.display = 'block';
            statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
            statusEl.style.color = 'var(--text-primary)';
            statusEl.textContent = 'âœ… AIä¿¡æ¯å·²åˆ·æ–°';
            setTimeout(() => {
              statusEl.style.display = 'none';
            }, 2000);
          }
        });
      }
      
      // ç¡®ä¿é¡µé¢åŠ è½½æ—¶ä¹Ÿå°è¯•åŠ è½½AIä¿¡æ¯
      setTimeout(() => {
        const evoSettingsTab = document.getElementById('evoSettingsTab');
        if (evoSettingsTab && evoSettingsTab.style.display !== 'none') {
          console.log('ğŸ”„ Evoè®¾ç½®é¡µé¢å¯è§ï¼Œè‡ªåŠ¨åŠ è½½AIä¿¡æ¯');
          loadEvoAIModelInfo();
        }
      }, 1000);
      
      if (btnTestEvoAI) {
        btnTestEvoAI.addEventListener('click', async () => {
          btnTestEvoAI.disabled = true;
          btnTestEvoAI.textContent = 'æµ‹è¯•ä¸­...';
          
          const statusEl = document.getElementById('evoAIInfoStatus');
          if (statusEl) {
            statusEl.style.display = 'block';
            statusEl.style.background = 'rgba(255, 152, 0, 0.3)';
            statusEl.textContent = 'ğŸ”„ æ­£åœ¨æµ‹è¯•AIè¿æ¥...';
          }
          
          try {
            const token = getAuthToken();
            if (!token) {
              throw new Error('è¯·å…ˆç™»å½•');
            }
            
            const response = await fetch(`${getApiUrl()}/evo/test`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              }
            });
            
            const result = await response.json();
            
            if (statusEl) {
              if (result.success) {
                statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
                statusEl.textContent = `âœ… ${result.message || 'AIè¿æ¥æµ‹è¯•æˆåŠŸï¼'}`;
              } else {
                statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
                statusEl.textContent = `âŒ ${result.message || 'AIè¿æ¥æµ‹è¯•å¤±è´¥'}`;
              }
            }
          } catch (error) {
            if (statusEl) {
              statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
              statusEl.textContent = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
          } finally {
            btnTestEvoAI.disabled = false;
            btnTestEvoAI.textContent = 'ğŸ§ª æµ‹è¯•è¿æ¥';
          }
        });
      }
    });
    
    // è·å–tokenå‡½æ•°ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    function getAuthToken() {
      // ä¼˜å…ˆä½¿ç”¨adminTokenï¼ˆæ™ºèƒ½ç®¡ç†ç³»ç»Ÿä½¿ç”¨çš„tokenï¼‰
      const adminToken = localStorage.getItem('adminToken');
      if (adminToken) {
        return adminToken;
      }
      // å¦‚æœæ²¡æœ‰adminTokenï¼Œå°è¯•ä½¿ç”¨tokenï¼ˆä¸»ç«™ä½¿ç”¨çš„tokenï¼‰
      return localStorage.getItem('token');
    }
    
    // åŠ è½½Evoè®¾ç½®é¡µé¢çš„AIæ¨¡å‹ä¿¡æ¯
    async function loadEvoAIModelInfo() {
      // å…ˆæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
      const nameEl = document.getElementById('evoAIModelName');
      const statusInfoEl = document.getElementById('evoAIInfoStatus');
      
      if (!nameEl) {
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        if (statusInfoEl) {
          statusInfoEl.style.display = 'block';
          statusInfoEl.style.background = 'rgba(255, 152, 0, 0.3)';
          statusInfoEl.style.color = 'var(--text-primary)';
          statusInfoEl.innerHTML = 'â³ é¡µé¢æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™...';
        }
        setTimeout(() => loadEvoAIModelInfo(), 500);
        return;
      }
      
      // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
      if (statusInfoEl) {
        statusInfoEl.style.display = 'block';
        statusInfoEl.style.background = 'rgba(255, 152, 0, 0.3)';
        statusInfoEl.style.color = 'var(--text-primary)';
        statusInfoEl.innerHTML = 'ğŸ”„ æ­£åœ¨åŠ è½½AIä¿¡æ¯...';
      }
      
      const providerEl = document.getElementById('evoAIProvider');
      if (nameEl) nameEl.textContent = 'åŠ è½½ä¸­...';
      if (providerEl) providerEl.textContent = 'åŠ è½½ä¸­...';
      
      try {
        const token = getAuthToken();
        if (!token) {
          if (statusInfoEl) {
            statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
            statusInfoEl.innerHTML = 'âŒ <strong>æœªç™»å½•</strong><br>è¯·å…ˆç™»å½•ç³»ç»Ÿï¼Œç„¶åæ‰èƒ½æŸ¥çœ‹AIæ¨¡å‹ä¿¡æ¯ã€‚';
          }
          displayEvoAIModelInfo(null);
          return;
        }
        
        const apiUrl = getApiUrl();
        
        const response = await fetch(`${apiUrl}/evo/model-info`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success && result.data) {
            displayEvoAIModelInfo(result.data);
          } else {
            if (statusInfoEl) {
              statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
              statusInfoEl.innerHTML = `âŒ <strong>APIè¿”å›é”™è¯¯</strong><br>${result.error || 'æœªçŸ¥é”™è¯¯'}`;
            }
            displayEvoAIModelInfo(null);
          }
        } else {
          const errorData = await response.json().catch(() => ({ error: 'æ— æ³•è§£æé”™è¯¯ä¿¡æ¯' }));
          
          if (statusInfoEl) {
            statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
            let errorMsg = `âŒ <strong>åŠ è½½å¤±è´¥ (${response.status})</strong><br>`;
            
            if (response.status === 401) {
              errorMsg += 'è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•ï¼';
            } else if (response.status === 404) {
              errorMsg += 'APIæ¥å£ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡ï¼';
            } else if (response.status === 500) {
              errorMsg += 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æ—¥å¿—ï¼';
            } else {
              errorMsg += errorData.error || 'æœªçŸ¥é”™è¯¯';
            }
            
            statusInfoEl.innerHTML = errorMsg;
          }
          
          displayEvoAIModelInfo(null);
        }
      } catch (error) {
        if (statusInfoEl) {
          statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
          let errorMsg = 'âŒ <strong>ç½‘ç»œé”™è¯¯</strong><br>';
          
          if (error.message.includes('Failed to fetch')) {
            errorMsg += 'æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ï¼<br>è¯·ç¡®è®¤ï¼š<br>1. åç«¯æœåŠ¡å·²å¯åŠ¨ï¼ˆè¿è¡Œ npm startï¼‰<br>2. æœåŠ¡åœ°å€æ­£ç¡®ï¼ˆhttp://localhost:3000ï¼‰<br>3. ç½‘ç»œè¿æ¥æ­£å¸¸';
          } else {
            errorMsg += error.message || 'æœªçŸ¥é”™è¯¯';
          }
          
          statusInfoEl.innerHTML = errorMsg;
        }
        
        displayEvoAIModelInfo(null);
      }
    }
    
    // æ˜¾ç¤ºEvoè®¾ç½®é¡µé¢çš„AIæ¨¡å‹ä¿¡æ¯
    function displayEvoAIModelInfo(modelInfo) {
      const nameEl = document.getElementById('evoAIModelName');
      const providerEl = document.getElementById('evoAIProvider');
      const statusEl = document.getElementById('evoAIStatus');
      const sourceEl = document.getElementById('evoAISource');
      const descEl = document.getElementById('evoAIDescription');
      const featuresEl = document.getElementById('evoAIFeatures');
      const statusInfoEl = document.getElementById('evoAIInfoStatus');
      
      // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
      if (statusInfoEl) {
        statusInfoEl.style.display = 'block';
        statusInfoEl.style.padding = '12px';
        statusInfoEl.style.borderRadius = '6px';
        statusInfoEl.style.fontSize = '14px';
      }
      
      if (!modelInfo) {
        if (nameEl) nameEl.textContent = 'âŒ æœªé…ç½®';
        if (providerEl) providerEl.textContent = 'æœªçŸ¥';
        if (statusEl) {
          statusEl.textContent = 'âŒ æœªé…ç½®';
          statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
        }
        if (sourceEl) {
          sourceEl.href = '#';
          sourceEl.textContent = 'æ— ';
        }
        if (descEl) descEl.textContent = 'AIæœåŠ¡æœªé…ç½®ï¼Œè¯·æ£€æŸ¥API Keyè®¾ç½®';
        if (featuresEl) featuresEl.textContent = 'æ— å¯ç”¨åŠŸèƒ½';
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        if (statusInfoEl) {
          statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
          statusInfoEl.style.color = 'var(--text-primary)';
          statusInfoEl.innerHTML = 'âŒ <strong>AIä¿¡æ¯åŠ è½½å¤±è´¥</strong><br>è¯·ç‚¹å‡»"ğŸ”„ åˆ·æ–°ä¿¡æ¯"æŒ‰é’®é‡è¯•ï¼Œæˆ–æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚';
        }
        return;
      }
      
      // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
      if (statusInfoEl) {
        statusInfoEl.style.background = 'rgba(76, 175, 80, 0.3)';
        statusInfoEl.style.color = 'var(--text-primary)';
        statusInfoEl.innerHTML = 'âœ… <strong>AIä¿¡æ¯åŠ è½½æˆåŠŸ</strong>';
        setTimeout(() => {
          if (statusInfoEl) statusInfoEl.style.display = 'none';
        }, 3000);
      }
      
      if (nameEl) nameEl.textContent = modelInfo.name || 'æœªçŸ¥';
      if (providerEl) providerEl.textContent = modelInfo.provider || 'æœªçŸ¥';
      
      if (statusEl) {
        if (modelInfo.free) {
          statusEl.textContent = 'âœ… å…è´¹ä½¿ç”¨';
          statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
        } else {
          statusEl.textContent = 'ğŸ’° ä»˜è´¹';
          statusEl.style.background = 'rgba(255, 152, 0, 0.3)';
        }
      }
      
      if (sourceEl) {
        sourceEl.href = modelInfo.source || '#';
        sourceEl.textContent = modelInfo.source ? 'æŸ¥çœ‹æ¨¡å‹è¯¦æƒ…' : 'æ— ';
      }
      
      if (descEl) {
        descEl.textContent = modelInfo.description || 'æ™ºèƒ½å¯¹è¯æ¨¡å‹ï¼Œæ”¯æŒä¸­æ–‡å¯¹è¯';
      }
      
      if (featuresEl && modelInfo.features && Array.isArray(modelInfo.features)) {
        featuresEl.innerHTML = modelInfo.features.map(f => `â€¢ ${f}`).join('<br>');
      } else if (featuresEl) {
        featuresEl.innerHTML = 'â€¢ å®Œå…¨å…è´¹ä½¿ç”¨<br>â€¢ æ”¯æŒä¸­æ–‡å¯¹è¯<br>â€¢ é«˜æ€§èƒ½å“åº”';
      }
    }
    
    // ==========================================
    // ğŸ•Šï¸ Evo æ™ºèƒ½åŠ©æ‰‹åŠŸèƒ½
    // ==========================================
    
    const EvoAssistant = (function() {
      const CHAT_HISTORY_KEY = 'evo_chat_history';
      const USED_GREETINGS_KEY = 'evo_used_greetings_admin';
      
      // æ¬¢è¿æ¶ˆæ¯åç¼€é€‰é¡¹ï¼ˆé’ˆå¯¹æ™ºèƒ½ç®¡ç†ï¼‰
      const GREETING_SUFFIXES = [
        'ç®¡ç†å…¬å‘Š',
        'æŸ¥çœ‹ç»Ÿè®¡æ•°æ®',
        'ç®¡ç†ç³»ç»Ÿè®¾ç½®',
        'é…ç½®æ™ºèƒ½åŠ©æ‰‹',
        'åˆ†æç”¨æˆ·æ•°æ®',
        'ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½',
        'æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—',
        'ç®¡ç†æƒé™è®¾ç½®',
        'ç”Ÿæˆæ•°æ®æŠ¥è¡¨',
        'ç›‘æ§ç³»ç»ŸçŠ¶æ€',
        'é…ç½®APIæ¥å£',
        'ç®¡ç†æ•°æ®å¤‡ä»½',
        'ä¼˜åŒ–æ•°æ®åº“',
        'æŸ¥çœ‹ç³»ç»Ÿåˆ†æ',
        'ç®¡ç†åŠŸèƒ½æ¨¡å—'
      ];
      
      let isExpanded = false;
      let activeTab = 'chat';
      let messages = [];
      let isTyping = false;
      let hasShownGreetingThisPageLoad = false;
      let assistantEl, iconButton, dialog, messagesContainer, inputField, sendBtn;
      
      function init() {
        try {
          createHTML();
          bindEvents();
          ensureIconVisible();
          setTimeout(() => ensureIconVisible(), 100);
          setTimeout(() => ensureIconVisible(), 500);
          
          // å»¶è¿Ÿæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
          hasShownGreetingThisPageLoad = false;
          setTimeout(() => {
            showWelcomeGreeting();
          }, 1500);
          setTimeout(() => {
            const existingBubble = document.getElementById('evoWelcomeBubble');
            if (!existingBubble) {
              showWelcomeGreeting();
            }
          }, 3000);
        } catch (error) {
          console.error('Evoåˆå§‹åŒ–é”™è¯¯:', error);
        }
      }
      
      function ensureIconVisible() {
        try {
          let assistant = document.getElementById('evoAssistant');
          if (!assistant) {
            createHTML();
            assistant = document.getElementById('evoAssistant');
          }
          if (assistant) {
            assistant.style.cssText = `
              position: fixed !important;
              bottom: 80px !important;
              right: 20px !important;
              z-index: 99999 !important;
              display: block !important;
              visibility: visible !important;
              opacity: 1 !important;
              pointer-events: auto !important;
            `;
            assistantEl = assistant;
          }
        } catch (error) {
          console.error('ensureIconVisibleé”™è¯¯:', error);
        }
      }
      
      function createHTML() {
        const existing = document.getElementById('evoAssistant');
        if (existing) existing.remove();
        
        const html = `
          <div class="evo-assistant" id="evoAssistant">
            <div class="evo-icon-button" id="evoIconButton">
              <div class="evo-pigeon-icon">
                <span class="evo-icon">ğŸ•Šï¸</span>
                <div class="evo-pulse"></div>
              </div>
            </div>
            
            <div class="evo-dialog" id="evoDialog" style="display: none;">
              <div class="evo-header">
                <div class="evo-header-left">
                  <span class="evo-icon-large">ğŸ•Šï¸</span>
                  <div>
                    <h3 class="evo-title">Evo æ™ºèƒ½åŠ©æ‰‹</h3>
                    <p class="evo-subtitle" id="evoStatus">å‡†å¤‡å¥½ä¸ºæ‚¨æœåŠ¡</p>
                  </div>
                </div>
                <button class="evo-close-btn" id="evoCloseBtn">Ã—</button>
              </div>
              
              <div class="evo-content">
                <div class="evo-tabs">
                  <div class="evo-tab-headers">
                    <div class="evo-tab-header active" data-tab="chat">ğŸ’¬ å¯¹è¯</div>
                    <div class="evo-tab-header" data-tab="analytics">ğŸ“Š æ•°æ®</div>
                    <div class="evo-tab-header" data-tab="recommendations">âœ¨ æ¨è</div>
                  </div>
                  
                  <div class="evo-tab-content active" id="tabChat">
                    <div class="evo-chat-container">
                      <div class="evo-messages" id="evoMessages"></div>
                      <div class="evo-input-area">
                        <div class="evo-input-group">
                          <input type="text" class="evo-input" id="evoInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜...">
                          <button class="evo-send-btn" id="evoSendBtn">å‘é€</button>
                        </div>
                        <div class="evo-quick-actions">
                          <button class="evo-quick-action-btn" data-action="stats">æŸ¥çœ‹ç»Ÿè®¡æ•°æ®</button>
                          <button class="evo-quick-action-btn" data-action="help">å¸®åŠ©</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="evo-tab-content" id="tabAnalytics">
                    <div class="evo-analytics" id="evoAnalytics">
                      <div class="evo-empty">æš‚æ— åˆ†ææŠ¥å‘Š</div>
                    </div>
                  </div>
                  
                  <div class="evo-tab-content" id="tabRecommendations">
                    <div class="evo-recommendations" id="evoRecommendations">
                      <div class="evo-empty">æš‚æ— æ¨èå†…å®¹</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', html);
        
        assistantEl = document.getElementById('evoAssistant');
        iconButton = document.getElementById('evoIconButton');
        dialog = document.getElementById('evoDialog');
        messagesContainer = document.getElementById('evoMessages');
        inputField = document.getElementById('evoInput');
        sendBtn = document.getElementById('evoSendBtn');
        
        if (assistantEl) {
          assistantEl.style.cssText = `
            position: fixed !important;
            bottom: 80px !important;
            right: 20px !important;
            z-index: 99999 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
          `;
        }
      }
      
      function bindEvents() {
        if (!iconButton) return;
        
        iconButton.addEventListener('click', toggleExpanded);
        const closeBtn = document.getElementById('evoCloseBtn');
        if (closeBtn) {
          closeBtn.addEventListener('click', toggleExpanded);
        }
        
        if (sendBtn) sendBtn.addEventListener('click', sendMessage);
        if (inputField) {
          inputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isTyping) {
              sendMessage();
            }
          });
        }
        
        document.querySelectorAll('.evo-tab-header').forEach(header => {
          header.addEventListener('click', () => {
            const tab = header.dataset.tab;
            switchTab(tab);
          });
        });
        
        document.querySelectorAll('.evo-quick-action-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const action = btn.dataset.action;
            if (action === 'stats') {
              inputField.value = 'æŸ¥çœ‹ç»Ÿè®¡æ•°æ®';
              sendMessage();
            } else if (action === 'help') {
              inputField.value = 'å¸®åŠ©';
              sendMessage();
            }
          });
        });
      }
      
      function toggleExpanded() {
        isExpanded = !isExpanded;
        if (dialog) {
          dialog.style.display = isExpanded ? 'flex' : 'none';
        }
        if (isExpanded) {
          loadHistory();
        }
      }
      
      function switchTab(tab) {
        activeTab = tab;
        document.querySelectorAll('.evo-tab-header').forEach(h => {
          h.classList.toggle('active', h.dataset.tab === tab);
        });
        document.querySelectorAll('.evo-tab-content').forEach(c => {
          c.classList.toggle('active', c.id === `tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
        });
      }
      
      async function sendMessage() {
        const text = inputField.value.trim();
        if (!text || isTyping) return;
        
        addMessage('user', text);
        inputField.value = '';
        
        isTyping = true;
        updateStatus('æ­£åœ¨æ€è€ƒ...');
        
        try {
          const response = await chat(text);
          addMessage('evo', response.text);
          saveHistory();
        } catch (error) {
          addMessage('evo', 'æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å“åº”ï¼Œè¯·ç¨åå†è¯•ã€‚');
        } finally {
          isTyping = false;
          updateStatus('åœ¨çº¿');
        }
      }
      
      // è·å–tokenå‡½æ•°
      function getAuthToken() {
        // ä¼˜å…ˆä½¿ç”¨adminTokenï¼ˆæ™ºèƒ½ç®¡ç†ç³»ç»Ÿä½¿ç”¨çš„tokenï¼‰
        const adminToken = localStorage.getItem('adminToken');
        if (adminToken) {
          return adminToken;
        }
        // å¦‚æœæ²¡æœ‰adminTokenï¼Œå°è¯•ä½¿ç”¨tokenï¼ˆä¸»ç«™ä½¿ç”¨çš„tokenï¼‰
        return localStorage.getItem('token');
      }
      
      // è°ƒç”¨åç«¯AI API
      async function chatWithBackendAPI(question, history = [], context = {}) {
        try {
          // ä½¿ç”¨ç»Ÿä¸€çš„getApiUrlå‡½æ•°
          const apiBaseUrl = getApiUrl();
          
          const token = getAuthToken();
          if (!token) {
            console.warn('âŒ æœªæ‰¾åˆ°tokenï¼Œæ— æ³•è°ƒç”¨åç«¯APIã€‚è¯·å…ˆç™»å½•ï¼');
            return null;
          }
          
          console.log(`ğŸ”„ æ­£åœ¨è°ƒç”¨åç«¯AI API...`);
          console.log(`ğŸ“¡ APIåœ°å€: ${apiBaseUrl}/evo/chat`);
          console.log(`ğŸ“ é—®é¢˜: ${question.substring(0, 50)}...`);
          
          const startTime = Date.now();
          const response = await fetch(`${apiBaseUrl}/evo/chat`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              question: question,
              history: history,
              context: context
            })
          });
          
          const responseTime = Date.now() - startTime;
          console.log(`â±ï¸ å“åº”æ—¶é—´: ${responseTime}ms`);
          
          if (response.ok) {
            const data = await response.json();
            console.log('ğŸ“¥ APIå“åº”æ•°æ®:', data);
            
            if (data.success && data.data) {
              const responseText = data.data.text || data.data.response;
              if (responseText && responseText.length > 10) {
                console.log(`âœ… AI APIè°ƒç”¨æˆåŠŸï¼`);
                console.log(`ğŸ“Š å›å¤é•¿åº¦: ${responseText.length} å­—ç¬¦`);
                console.log(`ğŸ¤– ä½¿ç”¨æ¨¡å‹: ${data.data.model || 'æœªçŸ¥'}`);
                console.log(`ğŸ¢ æœåŠ¡æä¾›å•†: ${data.data.provider || 'æœªçŸ¥'}`);
                console.log(`ğŸ’¬ å›å¤é¢„è§ˆ: ${responseText.substring(0, 100)}...`);
                
                return { 
                  text: responseText, 
                  data: data.data,
                  modelInfo: data.modelInfo || null
                };
              } else {
                console.warn('âš ï¸ AIå›å¤ä¸ºç©ºæˆ–å¤ªçŸ­ï¼Œé•¿åº¦:', responseText?.length || 0);
              }
            } else {
              console.warn('âš ï¸ APIè¿”å›success=false:', data);
            }
          } else {
            const errorData = await response.json().catch(() => ({}));
            console.error('âŒ åç«¯AI APIå“åº”é”™è¯¯:', response.status);
            console.error('âŒ é”™è¯¯è¯¦æƒ…:', errorData);
            
            if (response.status === 401) {
              console.error('âŒ è®¤è¯å¤±è´¥ï¼è¯·é‡æ–°ç™»å½•ï¼');
              alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ï¼');
            } else if (response.status === 500) {
              console.error('âŒ æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼');
            } else if (response.status === 404) {
              console.error('âŒ APIæ¥å£ä¸å­˜åœ¨ï¼è¯·æ£€æŸ¥åç«¯æœåŠ¡ï¼');
            }
          }
        } catch (error) {
          console.error('âŒ Backend AI APIè°ƒç”¨å¼‚å¸¸:', error);
          console.error('âŒ é”™è¯¯ç±»å‹:', error.name);
          console.error('âŒ é”™è¯¯æ¶ˆæ¯:', error.message);
          
          if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            console.error('âŒ ç½‘ç»œé”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ï¼');
            console.error('ğŸ’¡ è¯·ç¡®è®¤ï¼š1) åç«¯æœåŠ¡å·²å¯åŠ¨ 2) æœåŠ¡åœ°å€æ­£ç¡® 3) ç½‘ç»œè¿æ¥æ­£å¸¸');
          }
        }
        
        return null;
      }
      
      async function chat(question) {
        console.log('ğŸ’¬ æ”¶åˆ°ç”¨æˆ·é—®é¢˜:', question);
        
        // è·å–å¯¹è¯å†å²
        const history = messages.map(msg => ({
          type: msg.type,
          text: msg.text,
          time: msg.time
        }));
        
        // è·å–ä¸Šä¸‹æ–‡æ•°æ®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        const context = {};
        
        // ä¼˜å…ˆçº§1ï¼šå°è¯•ä½¿ç”¨åç«¯AI APIï¼ˆå¿…é¡»ä¼˜å…ˆä½¿ç”¨AIï¼‰
        try {
          console.log('ğŸ”„ æ­£åœ¨è°ƒç”¨åç«¯AI API...');
          const apiResponse = await chatWithBackendAPI(question, history, context);
          
          if (apiResponse && apiResponse.text && apiResponse.text.length > 10) {
            console.log('âœ… AI APIè°ƒç”¨æˆåŠŸï¼Œè¿”å›æ™ºèƒ½AIå›å¤');
            return apiResponse;
          } else {
            console.warn('âš ï¸ AI APIè¿”å›çš„å›å¤ä¸ºç©ºæˆ–å¤ªçŸ­');
            console.warn('âš ï¸ å›å¤å†…å®¹:', apiResponse?.text || '(ç©º)');
            console.warn('âš ï¸ ç»§ç»­å°è¯•å…¶ä»–æ–¹å¼...');
          }
        } catch (error) {
          console.error('âŒ åç«¯AI APIè°ƒç”¨å¤±è´¥:', error);
          console.error('âŒ é”™è¯¯å †æ ˆ:', error.stack);
        }
        
        // å¦‚æœAI APIå¤±è´¥ï¼Œæ˜¾ç¤ºæ˜ç¡®çš„é”™è¯¯æç¤º
        const token = getAuthToken();
        if (!token) {
          return { 
            text: 'âŒ æ— æ³•ä½¿ç”¨AIåŠŸèƒ½ï¼šæ‚¨å°šæœªç™»å½•ã€‚\n\nè¯·å…ˆç™»å½•ç³»ç»Ÿï¼Œç„¶åæ‰èƒ½ä½¿ç”¨AIåŠ©æ‰‹åŠŸèƒ½ã€‚\n\nç™»å½•åï¼ŒAIåŠ©æ‰‹å°†ä¸ºæ‚¨æä¾›æ™ºèƒ½å›å¤ã€‚' 
          };
        }
        
        // æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯è¾¾
        try {
          const healthCheck = await fetch(`${getApiUrl()}/health`).catch(() => null);
          if (!healthCheck || !healthCheck.ok) {
            return { 
              text: 'âŒ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ã€‚\n\nè¯·ç¡®è®¤ï¼š\n1. åç«¯æœåŠ¡å·²å¯åŠ¨ï¼ˆè¿è¡Œ npm startï¼‰\n2. æœåŠ¡åœ°å€æ­£ç¡®ï¼ˆhttp://localhost:3000ï¼‰\n3. ç½‘ç»œè¿æ¥æ­£å¸¸\n\nè¿æ¥æˆåŠŸåï¼ŒAIåŠ©æ‰‹å°†æ­£å¸¸å·¥ä½œã€‚' 
            };
          }
        } catch (e) {
          return { 
            text: 'âŒ åç«¯æœåŠ¡è¿æ¥å¤±è´¥ã€‚\n\nè¯·æ£€æŸ¥ï¼š\n1. åç«¯æœåŠ¡æ˜¯å¦å·²å¯åŠ¨\n2. æœåŠ¡åœ°å€æ˜¯å¦æ­£ç¡®\n3. é˜²ç«å¢™è®¾ç½®\n\nä¿®å¤åï¼ŒAIåŠ©æ‰‹å°†è‡ªåŠ¨æ¢å¤ã€‚' 
          };
        }
        
        // å¦‚æœåç«¯æœåŠ¡æ­£å¸¸ä½†AIè°ƒç”¨å¤±è´¥ï¼Œæ˜¾ç¤ºæç¤º
        return { 
          text: `âš ï¸ AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ã€‚\n\né—®é¢˜ï¼š"${question}"\n\nå¯èƒ½çš„åŸå› ï¼š\n1. AI APIé…ç½®é—®é¢˜\n2. API Keyæ— æ•ˆæˆ–è¿‡æœŸ\n3. ç½‘ç»œè¿æ¥é—®é¢˜\n\nè¯·æ£€æŸ¥ï¼š\nâ€¢ æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯\nâ€¢ åç«¯æ—¥å¿—æ–‡ä»¶\nâ€¢ API Keyé…ç½®\n\nä¿®å¤åï¼ŒAIåŠ©æ‰‹å°†è‡ªåŠ¨æ¢å¤æ™ºèƒ½å›å¤åŠŸèƒ½ã€‚` 
        };
      }
      
      function addMessage(type, text) {
        const message = { type, text, time: new Date() };
        messages.push(message);
        renderMessages();
      }
      
      function renderMessages() {
        if (!messagesContainer) return;
        
        messagesContainer.innerHTML = messages.map(msg => {
          const timeStr = formatTime(msg.time);
          if (msg.type === 'user') {
            return `
              <div class="evo-message user">
                <div class="evo-message-avatar">ğŸ‘¤</div>
                <div class="evo-message-content">
                  <div class="evo-message-text">${formatMessage(msg.text)}</div>
                  <div class="evo-message-time">${timeStr}</div>
                </div>
              </div>
            `;
          } else {
            return `
              <div class="evo-message evo">
                <div class="evo-message-avatar">ğŸ•Šï¸</div>
                <div class="evo-message-content">
                  <div class="evo-message-text">${formatMessage(msg.text)}</div>
                  <div class="evo-message-time">${timeStr}</div>
                </div>
              </div>
            `;
          }
        }).join('');
        
        if (isTyping) {
          messagesContainer.innerHTML += `
            <div class="evo-message evo">
              <div class="evo-message-avatar">ğŸ•Šï¸</div>
              <div class="evo-message-content">
                <div class="evo-typing-indicator">
                  <span></span><span></span><span></span>
                </div>
              </div>
            </div>
          `;
        }
        
        scrollToBottom();
      }
      
      function formatMessage(text) {
        return text.replace(/\n/g, '<br>');
      }
      
      function formatTime(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        if (minutes < 1) return 'åˆšåˆš';
        if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
        return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      }
      
      function scrollToBottom() {
        if (messagesContainer) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }
      
      function updateStatus(status) {
        const statusEl = document.getElementById('evoStatus');
        if (statusEl) {
          statusEl.textContent = status;
        }
      }
      
      function saveHistory() {
        try {
          localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(messages));
        } catch (error) {
          console.error('Failed to save chat history:', error);
        }
      }
      
      function loadHistory() {
        try {
          const history = localStorage.getItem(CHAT_HISTORY_KEY);
          if (history) {
            messages = JSON.parse(history).map(msg => ({
              ...msg,
              time: new Date(msg.time)
            }));
            renderMessages();
          }
        } catch (error) {
          console.error('Failed to load chat history:', error);
        }
      }
      
      // è·å–æœªä½¿ç”¨çš„æ¬¢è¿æ¶ˆæ¯åç¼€
      function getUnusedGreetingSuffix() {
        try {
          const used = JSON.parse(localStorage.getItem(USED_GREETINGS_KEY) || '[]');
          const available = GREETING_SUFFIXES.filter(suffix => !used.includes(suffix));
          
          if (available.length === 0) {
            localStorage.setItem(USED_GREETINGS_KEY, '[]');
            return GREETING_SUFFIXES[Math.floor(Math.random() * GREETING_SUFFIXES.length)];
          }
          
          const selected = available[Math.floor(Math.random() * available.length)];
          used.push(selected);
          localStorage.setItem(USED_GREETINGS_KEY, JSON.stringify(used));
          
          return selected;
        } catch (error) {
          console.error('è·å–æ¬¢è¿æ¶ˆæ¯å¤±è´¥:', error);
          return GREETING_SUFFIXES[0];
        }
      }
      
      // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯æ°”æ³¡å¼¹çª—
      function showWelcomeGreeting() {
        const existingBubble = document.getElementById('evoWelcomeBubble');
        if (existingBubble) {
          return;
        }
        
        hasShownGreetingThisPageLoad = true;
        
        try {
          if (!document.body) {
            setTimeout(showWelcomeGreeting, 500);
            return;
          }
          
          const suffix = getUnusedGreetingSuffix();
          const greeting = `ä½ å¥½ï¼Œæˆ‘æ˜¯Evoï¼Œæˆ‘å¯ä»¥å¸®ä½ ${suffix}ã€‚`;
          
          const bubble = document.createElement('div');
          bubble.id = 'evoWelcomeBubble';
          bubble.className = 'evo-welcome-bubble';
          
          bubble.style.position = 'fixed';
          bubble.style.bottom = '160px';
          bubble.style.right = '100px';
          bubble.style.zIndex = '99998';
          bubble.style.maxWidth = '280px';
          bubble.style.pointerEvents = 'auto';
          bubble.style.display = 'block';
          bubble.style.visibility = 'visible';
          bubble.style.opacity = '1';
          
          const bubbleContent = document.createElement('div');
          bubbleContent.className = 'evo-welcome-bubble-content';
          bubbleContent.textContent = greeting;
          
          bubbleContent.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          bubbleContent.style.color = '#fff';
          bubbleContent.style.padding = '12px 16px';
          bubbleContent.style.borderRadius = '8px';
          bubbleContent.style.fontSize = '14px';
          bubbleContent.style.lineHeight = '1.5';
          bubbleContent.style.boxShadow = '0 4px 20px rgba(102, 126, 234, 0.4), 0 0 30px rgba(118, 75, 162, 0.3)';
          bubbleContent.style.position = 'relative';
          bubbleContent.style.wordWrap = 'break-word';
          bubbleContent.style.cursor = 'pointer';
          bubbleContent.style.fontWeight = '500';
          
          bubbleContent.addEventListener('click', () => {
            hideWelcomeBubble();
            if (!dialog) {
              dialog = document.getElementById('evoDialog');
            }
            if (dialog) {
              isExpanded = true;
              dialog.style.display = 'flex';
              activeTab = 'chat';
              switchTab('chat');
              
              if (!messagesContainer) {
                messagesContainer = document.getElementById('evoMessages');
              }
              if (messagesContainer) {
                messages = [];
                messagesContainer.innerHTML = '';
                addMessage('evo', greeting);
                saveHistory();
                setTimeout(() => scrollToBottom(), 100);
              }
            }
          });
          
          bubble.appendChild(bubbleContent);
          document.body.appendChild(bubble);
          
          setTimeout(() => {
            const checkBubble = document.getElementById('evoWelcomeBubble');
            if (checkBubble) {
              const rect = checkBubble.getBoundingClientRect();
              const checkComputedStyle = window.getComputedStyle(checkBubble);
              if (rect.width === 0 || rect.height === 0 || checkComputedStyle.display === 'none' || checkComputedStyle.visibility === 'hidden') {
                checkBubble.style.cssText = `
                  position: fixed !important;
                  bottom: 160px !important;
                  right: 100px !important;
                  z-index: 99998 !important;
                  max-width: 280px !important;
                  display: block !important;
                  visibility: visible !important;
                  opacity: 1 !important;
                `;
              }
            }
          }, 100);
          
          setTimeout(() => {
            hideWelcomeBubble();
          }, 3000);
          
        } catch (error) {
          console.error('æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯å¤±è´¥:', error);
        }
      }
      
      // éšè—æ¬¢è¿æ¶ˆæ¯æ°”æ³¡
      function hideWelcomeBubble() {
        const bubble = document.getElementById('evoWelcomeBubble');
        if (bubble) {
          bubble.classList.add('hiding');
          setTimeout(() => {
            if (bubble.parentNode) {
              bubble.remove();
            }
          }, 300);
        }
      }
      
      return {
        init,
        ensureIconVisible
      };
    })();
    
    // åˆå§‹åŒ–EvoåŠ©æ‰‹ï¼ˆåœ¨ç™»å½•åï¼‰
    function initEvoAssistant() {
      setTimeout(() => {
        try {
          EvoAssistant.init();
          console.log('âœ… Evo æ™ºèƒ½åŠ©æ‰‹å·²åˆå§‹åŒ–');
          
          setTimeout(() => {
            EvoAssistant.ensureIconVisible();
          }, 500);
        } catch (error) {
          console.error('âš ï¸ æ™ºèƒ½åŠ©æ‰‹åˆå§‹åŒ–å¤±è´¥:', error);
        }
      }, 500);
    }
    
    // ========================================
    // æ™ºé¸½Â·ä¸­æ¢ç®¡å®¶åŠŸèƒ½
    // ========================================
    
    // åŠ è½½ä¸­æ¢ç®¡å®¶æ•°æ®ï¼ˆä½¿ç”¨å…¨å±€ CORE_ADMIN_API_BASEï¼‰
    async function loadCoreAdminData() {
      try {
        // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®ï¼Œå³ä½¿éƒ¨åˆ†å¤±è´¥ä¹Ÿèƒ½æ˜¾ç¤ºå…¶ä»–å†…å®¹
        await Promise.allSettled([
          loadCoreAdminStatus(),
          loadCoreAdminModelInfo(),
          loadCoreAdminAdvice(),
          loadCoreAdminAnalytics(),
          loadCoreAdminApis(),
          loadCoreAdminLearning(),
          loadCoreAdminMaintenance()
        ]);
      } catch (error) {
        console.error('åŠ è½½ä¸­æ¢ç®¡å®¶æ•°æ®å¤±è´¥:', error);
      }
    }
    
    // åŠ è½½ç³»ç»ŸçŠ¶æ€
    async function loadCoreAdminStatus() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/status`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const result = await response.json();
        
        if (result.success && result.data) {
          const status = result.data;
          const healthScore = (status.metrics?.systemHealth || 0) * 100;
          
          document.getElementById('coreAdminHealthScore').textContent = healthScore.toFixed(0) + '%';
          document.getElementById('coreAdminHealthStatus').textContent = 
            status.metrics?.riskLevel === 'low' ? 'âœ… è¿è¡Œæ­£å¸¸' :
            status.metrics?.riskLevel === 'medium' ? 'âš ï¸ éœ€è¦æ³¨æ„' :
            status.metrics?.riskLevel === 'high' ? 'ğŸ”´ é£é™©è¾ƒé«˜' : 'æ£€æŸ¥ä¸­...';
        } else {
          throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
        }
      } catch (error) {
        console.error('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
        document.getElementById('coreAdminHealthScore').textContent = '--';
        document.getElementById('coreAdminHealthStatus').textContent = 'âš ï¸ æœåŠ¡æœªè¿è¡Œ';
        document.getElementById('coreAdminHealthStatus').style.color = '#f59e0b';
      }
    }
    
    // åŠ è½½æ¨¡å‹æ¥å…¥ä¿¡æ¯
    async function loadCoreAdminModelInfo() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/model/config`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const result = await response.json();
        
        if (result.success && result.data) {
          const modelInfo = result.data;
          
          // æ›´æ–°åŸºæœ¬ä¿¡æ¯
          document.getElementById('coreAdminModelProvider').textContent = modelInfo.provider || 'æœªçŸ¥';
          document.getElementById('coreAdminModelName').textContent = modelInfo.model || 'æœªçŸ¥';
          document.getElementById('coreAdminApiKeyPreview').textContent = modelInfo.apiKeyPreview || '--';
          document.getElementById('coreAdminApiBase').textContent = modelInfo.apiBase || '--';
          document.getElementById('coreAdminMaxCalls').textContent = modelInfo.maxCallsPerHour || '--';
          document.getElementById('coreAdminConfidence').textContent = (modelInfo.confidenceThreshold * 100).toFixed(0) + '%' || '--';
          
          // æ›´æ–°API KeyçŠ¶æ€
          const apiKeyStatusEl = document.getElementById('coreAdminApiKeyStatus');
          if (modelInfo.apiKeyStatus === 'configured') {
            apiKeyStatusEl.textContent = 'âœ… å·²é…ç½®';
            apiKeyStatusEl.style.background = 'rgba(76, 175, 80, 0.3)';
            apiKeyStatusEl.style.color = '#2e7d32';
          } else {
            apiKeyStatusEl.textContent = 'âŒ æœªé…ç½®';
            apiKeyStatusEl.style.background = 'rgba(244, 67, 54, 0.3)';
            apiKeyStatusEl.style.color = '#c62828';
          }
          
          // æ›´æ–°è¿æ¥çŠ¶æ€
          const connectionStatusEl = document.getElementById('coreAdminConnectionStatus');
          if (modelInfo.connectionStatus === 'connected' && modelInfo.enabled) {
            connectionStatusEl.textContent = 'âœ… å·²è¿æ¥';
            connectionStatusEl.style.background = 'rgba(76, 175, 80, 0.3)';
            connectionStatusEl.style.color = '#2e7d32';
          } else {
            connectionStatusEl.textContent = 'âŒ æœªè¿æ¥';
            connectionStatusEl.style.background = 'rgba(244, 67, 54, 0.3)';
            connectionStatusEl.style.color = '#c62828';
          }
          
          // æ›´æ–°è°ƒç”¨ç»Ÿè®¡
          if (modelInfo.stats) {
            const stats = modelInfo.stats;
            document.getElementById('coreAdminTotalCalls').textContent = stats.totalCalls || 0;
            document.getElementById('coreAdminRecentCalls').textContent = stats.recentCalls || 0;
            document.getElementById('coreAdminSuccessRate').textContent = (stats.successRate * 100).toFixed(1) + '%';
            document.getElementById('coreAdminAvgConfidence').textContent = (stats.avgConfidence * 100).toFixed(1) + '%';
          }
          
          // æ›´æ–°AIè°ƒç”¨æ¬¡æ•°ï¼ˆåœ¨é¡¶éƒ¨å¡ç‰‡ä¸­ï¼‰
          if (modelInfo.stats) {
            document.getElementById('coreAdminAICalls').textContent = modelInfo.stats.recentCalls || 0;
          }
        } else {
          throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
        }
      } catch (error) {
        console.error('åŠ è½½æ¨¡å‹æ¥å…¥ä¿¡æ¯å¤±è´¥:', error);
        const container = document.getElementById('coreAdminModelInfo');
        container.innerHTML = `
          <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:1px solid #f59e0b;">
            <p style="margin:0 0 12px 0;color:#92400e;font-weight:600;">âš ï¸ ä¸­æ¢ç®¡å®¶æœåŠ¡æœªè¿è¡Œ</p>
            <p style="margin:0;color:#78350f;font-size:14px;">è¯·å¯åŠ¨åç«¯æœåŠ¡ï¼š<code style="background:#fde68a;padding:2px 6px;border-radius:4px;">cd backend/core-admin && npm start</code></p>
          </div>
        `;
      }
    }
    
    // åŠ è½½ç®¡ç†å»ºè®®
    async function loadCoreAdminAdvice() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/advice`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const result = await response.json();
        
        if (result.success && result.data) {
          const advice = result.data.advice || {};
          const container = document.getElementById('coreAdminAdvice');
          
          let html = '';
          if (advice.summary) {
            html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;margin-bottom:12px;">`;
            html += `<div style="font-weight:600;margin-bottom:8px;color:#1f2937;">${advice.summary}</div>`;
            if (advice.actions && advice.actions.length > 0) {
              html += `<ul style="margin:8px 0;padding-left:20px;">`;
              advice.actions.forEach(action => {
                html += `<li style="margin:4px 0;color:#4b5563;">${action}</li>`;
              });
              html += `</ul>`;
            }
            html += `</div>`;
          } else {
            html = '<p class="muted" style="text-align:center;">æš‚æ— å»ºè®®</p>';
          }
          
          container.innerHTML = html;
        } else {
          throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
        }
      } catch (error) {
        console.error('åŠ è½½ç®¡ç†å»ºè®®å¤±è´¥:', error);
        const container = document.getElementById('coreAdminAdvice');
        container.innerHTML = `
          <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:1px solid #f59e0b;">
            <p style="margin:0 0 12px 0;color:#92400e;font-weight:600;">âš ï¸ ä¸­æ¢ç®¡å®¶æœåŠ¡æœªè¿è¡Œ</p>
            <p style="margin:0;color:#78350f;font-size:14px;">è¯·å¯åŠ¨åç«¯æœåŠ¡ï¼š<code style="background:#fde68a;padding:2px 6px;border-radius:4px;">cd backend/core-admin && npm start</code></p>
          </div>
        `;
      }
    }
    
    // åŠ è½½æ•°æ®åˆ†æ
    async function loadCoreAdminAnalytics() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/analytics/report`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const report = result.data;
          const container = document.getElementById('coreAdminAnalytics');
          
          let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:20px;">';
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">æ€»ç‚¹å‡»é‡</div>`;
          html += `<div style="font-size:24px;font-weight:600;color:#1f2937;">${report.clicks?.total || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">æ•°æ®ä¸Šä¼ </div>`;
          html += `<div style="font-size:24px;font-weight:600;color:#1f2937;">${report.uploads?.total || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ç”¨æˆ·è¡Œä¸º</div>`;
          html += `<div style="font-size:24px;font-weight:600;color:#1f2937;">${report.userBehaviors?.total || 0}</div>`;
          html += `</div>`;
          
          html += `</div>`;
          
          if (report.apiUsage?.topEndpoints && report.apiUsage.topEndpoints.length > 0) {
            html += `<div style="margin-top:20px;"><h4 style="margin-bottom:12px;">çƒ­é—¨API</h4>`;
            html += `<table style="width:100%;border-collapse:collapse;">`;
            html += `<thead><tr style="background:#f9fafb;"><th style="padding:8px;text-align:left;">ç«¯ç‚¹</th><th style="padding:8px;text-align:center;">è°ƒç”¨æ¬¡æ•°</th><th style="padding:8px;text-align:center;">æˆåŠŸç‡</th></tr></thead><tbody>`;
            report.apiUsage.topEndpoints.slice(0, 5).forEach(api => {
              html += `<tr><td style="padding:8px;">${api.endpoint}</td>`;
              html += `<td style="padding:8px;text-align:center;">${api.calls}</td>`;
              html += `<td style="padding:8px;text-align:center;">${(api.successRate * 100).toFixed(1)}%</td></tr>`;
            });
            html += `</tbody></table></div>`;
          }
          
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('åŠ è½½æ•°æ®åˆ†æå¤±è´¥:', error);
        const container = document.getElementById('coreAdminAnalytics');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">æ•°æ®åˆ†ææœåŠ¡æš‚ä¸å¯ç”¨</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ</p>
          </div>
        `;
      }
    }
    
    // åŠ è½½APIåˆ—è¡¨
    async function loadCoreAdminApis() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/apis`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const apis = result.data;
          const container = document.getElementById('coreAdminApiList');
          
          if (apis.length === 0) {
            container.innerHTML = '<p class="muted" style="text-align:center;">æš‚æ— API</p>';
            return;
          }
          
          let html = '<table style="width:100%;border-collapse:collapse;">';
          html += '<thead><tr style="background:#f9fafb;">';
          html += '<th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">APIåç§°</th>';
          html += '<th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">çŠ¶æ€</th>';
          html += '<th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">å“åº”æ—¶é—´</th>';
          html += '<th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">æ•°æ®çœŸå®æ€§</th>';
          html += '</tr></thead><tbody>';
          
          apis.forEach(api => {
            const statusColor = api.health.status === 'healthy' ? '#10b981' : '#ef4444';
            const statusText = api.health.status === 'healthy' ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸';
            const truthStatus = api.health.truthStatus || 'unknown';
            const truthColor = truthStatus === 'verified' ? '#10b981' : truthStatus === 'suspect' ? '#f59e0b' : '#ef4444';
            const truthText = truthStatus === 'verified' ? 'âœ… å·²éªŒè¯' : truthStatus === 'suspect' ? 'âš ï¸ å¯ç–‘' : 'âŒ æ— æ•ˆ';
            
            html += `<tr style="border-bottom:1px solid #f0f0f0;">`;
            html += `<td style="padding:12px;"><strong>${api.name}</strong><br><span style="color:#6b7280;font-size:12px;">${api.url}</span></td>`;
            html += `<td style="padding:12px;text-align:center;"><span style="color:${statusColor};font-weight:600;">${statusText}</span></td>`;
            html += `<td style="padding:12px;text-align:center;">${api.stats.avgResponseTime.toFixed(0)}ms</td>`;
            html += `<td style="padding:12px;text-align:center;"><span style="color:${truthColor};font-weight:600;">${truthText}</span></td>`;
            html += `</tr>`;
          });
          
          html += '</tbody></table>';
          container.innerHTML = html;
          
          // æ›´æ–°APIå¥åº·ç‡
          const healthyCount = apis.filter(a => a.health.status === 'healthy').length;
          const healthRate = apis.length > 0 ? (healthyCount / apis.length * 100) : 0;
          document.getElementById('coreAdminApiHealth').textContent = healthRate.toFixed(0) + '%';
        }
      } catch (error) {
        console.error('åŠ è½½APIåˆ—è¡¨å¤±è´¥:', error);
        const container = document.getElementById('coreAdminApiList');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">APIç›‘ç®¡æœåŠ¡æš‚ä¸å¯ç”¨</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ</p>
          </div>
        `;
      }
    }
    
    // åŠ è½½å­¦ä¹ ç³»ç»Ÿ
    async function loadCoreAdminLearning() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/learning/stats`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const stats = result.data;
          const container = document.getElementById('coreAdminLearning');
          
          let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">';
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">æ€»äº‹ä»¶æ•°</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalEvents || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ç­–ç•¥æ•°</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalStrategies || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">å†³ç­–æ•°</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalDecisions || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">å¹³å‡æœ‰æ•ˆæ€§</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${((stats.avgEffectiveness || 0) * 100).toFixed(1)}%</div>`;
          html += `</div>`;
          
          html += `</div>`;
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('åŠ è½½å­¦ä¹ ç³»ç»Ÿå¤±è´¥:', error);
        const container = document.getElementById('coreAdminLearning');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">å­¦ä¹ ç³»ç»ŸæœåŠ¡æš‚ä¸å¯ç”¨</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ</p>
          </div>
        `;
      }
    }
    
    // åŠ è½½è‡ªåŠ¨ç»´æŠ¤
    async function loadCoreAdminMaintenance() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/maintenance/stats`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const stats = result.data;
          const container = document.getElementById('coreAdminMaintenance');
          
          let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">';
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">æ€»Bugæ•°</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalBugs || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">å·²ä¿®å¤</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.fixedBugs || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">æ€»ä¿®å¤æ•°</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalFixes || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ç³»ç»Ÿå‡çº§</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalUpgrades || 0}</div>`;
          html += `</div>`;
          
          html += `</div>`;
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('åŠ è½½è‡ªåŠ¨ç»´æŠ¤å¤±è´¥:', error);
        const container = document.getElementById('coreAdminMaintenance');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">è‡ªåŠ¨ç»´æŠ¤æœåŠ¡æš‚ä¸å¯ç”¨</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ</p>
          </div>
        `;
      }
    }
    
    // ç»‘å®šåˆ·æ–°æŒ‰é’®
    // ==========================================
    // ç³»ç»Ÿè®¾ç½®åŠŸèƒ½
    // ==========================================
    
    let currentRssSourceEditId = null;
    
    // åŠ è½½ç³»ç»Ÿè®¾ç½®
    async function loadSystemSettings() {
      try {
        const token = localStorage.getItem('adminToken');
        if (!token) {
          showSettingsStatus('è¯·å…ˆç™»å½•', 'error');
          return;
        }
        
        const response = await fetch(`${getApiUrl()}/api/admin/system-settings`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const settings = result.data;
          
          // å¡«å……åŸºç¡€è®¾ç½®
          document.getElementById('serverPort').value = settings.server?.port || '';
          document.getElementById('serverEnv').value = settings.server?.env || 'production';
          document.getElementById('apiRateLimit').value = settings.api?.rateLimit || '';
          document.getElementById('logLevel').value = settings.logging?.level || 'info';
          
          // å¡«å……ç¼“å­˜è®¾ç½®
          document.getElementById('cacheTtlNews').value = settings.cache?.ttl?.news || '';
          document.getElementById('cacheTtlEvents').value = settings.cache?.ttl?.events || '';
          document.getElementById('cacheTtlResults').value = settings.cache?.ttl?.results || '';
          document.getElementById('updateIntervalNews').value = settings.updateInterval?.news || '';
          document.getElementById('updateIntervalEvents').value = settings.updateInterval?.events || '';
          document.getElementById('updateIntervalResults').value = settings.updateInterval?.results || '';
          
          // å¡«å……AIè®¾ç½®
          document.getElementById('zhipuApiKeyEvo').value = settings.ai?.zhipuApiKeyEvo || '';
          document.getElementById('zhipuApiKeyAdmin').value = settings.ai?.zhipuApiKeyAdmin || '';
          document.getElementById('qwenApiKey').value = settings.ai?.qwenApiKey || '';
          document.getElementById('huggingFaceApiKey').value = settings.ai?.huggingFaceApiKey || '';
          document.getElementById('aiModel').value = settings.ai?.model || 'auto';
          
          // å¡«å……æ•°æ®åº“è®¾ç½®
          document.getElementById('supabaseUrl').value = settings.supabase?.url || '';
          document.getElementById('supabaseAnonKey').value = settings.supabase?.anonKey || '';
          
          // åŠ è½½RSSæºåˆ—è¡¨
          loadRssSources();
        }
      } catch (error) {
        console.error('åŠ è½½ç³»ç»Ÿè®¾ç½®å¤±è´¥:', error);
        showSettingsStatus('åŠ è½½ç³»ç»Ÿè®¾ç½®å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // åŠ è½½RSSæºåˆ—è¡¨
    async function loadRssSources() {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const sources = result.data;
          const container = document.getElementById('rssSourcesList');
          
          if (sources.length === 0) {
            container.innerHTML = '<p class="muted" style="text-align:center;padding:20px;">æš‚æ— RSSæºï¼Œç‚¹å‡»"æ·»åŠ RSSæº"æŒ‰é’®æ·»åŠ </p>';
            return;
          }
          
          let html = '';
          sources.forEach(source => {
            const statusColor = source.active !== false ? '#10b981' : '#ef4444';
            const statusText = source.active !== false ? 'å¯ç”¨' : 'ç¦ç”¨';
            
            html += `
              <div style="padding:16px;background:var(--bg-secondary);border:1px solid var(--border-light);border-radius:var(--radius-md);">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
                  <div style="flex:1;">
                    <div style="font-weight:600;color:var(--text-primary);margin-bottom:4px;">${source.name}</div>
                    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">${source.url}</div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                      <span style="padding:4px 8px;background:var(--primary-50);color:var(--primary);border-radius:4px;font-size:12px;">${source.type === 'media' ? 'åª’ä½“' : 'åä¼š'}</span>
                      <span style="padding:4px 8px;background:var(--gray-100);color:var(--gray-700);border-radius:4px;font-size:12px;">${source.region === 'local' ? 'æœ¬åœ°' : 'å…¨å›½'}</span>
                      <span style="padding:4px 8px;background:${statusColor}20;color:${statusColor};border-radius:4px;font-size:12px;">${statusText}</span>
                    </div>
                  </div>
                  <div style="display:flex;gap:8px;">
                    <button class="btn btn-sm btn-outline" onclick="editRssSource('${source.id}')">ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-outline" onclick="toggleRssSource('${source.id}', ${source.active !== false})">${source.active !== false ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                    <button class="btn btn-sm btn-outline" style="color:var(--danger);" onclick="deleteRssSource('${source.id}')">åˆ é™¤</button>
                  </div>
                </div>
              </div>
            `;
          });
          
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('åŠ è½½RSSæºåˆ—è¡¨å¤±è´¥:', error);
      }
    }
    
    // ç³»ç»Ÿè®¾ç½®æ ‡ç­¾é¡µåˆ‡æ¢
    document.querySelectorAll('.settings-tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.settings-tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // æ˜¾ç¤ºå¯¹åº”é¢æ¿
        document.querySelectorAll('.settings-panel').forEach(p => p.style.display = 'none');
        document.getElementById(`settings${tab.charAt(0).toUpperCase() + tab.slice(1)}`).style.display = 'block';
      });
    });
    
    // ä¿å­˜åŸºç¡€è®¾ç½®
    document.getElementById('btnSaveGeneralSettings')?.addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('adminToken');
        const settings = {
          custom: {
            server: {
              port: parseInt(document.getElementById('serverPort').value) || 3000,
              env: document.getElementById('serverEnv').value
            },
            api: {
              rateLimit: parseInt(document.getElementById('apiRateLimit').value) || 100
            },
            logging: {
              level: document.getElementById('logLevel').value
            }
          }
        };
        
        const response = await fetch(`${getApiUrl()}/api/admin/system-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ settings })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('åŸºç¡€è®¾ç½®å·²ä¿å­˜ï¼ˆéƒ¨åˆ†é…ç½®éœ€è¦ä¿®æ”¹ç¯å¢ƒå˜é‡åé‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆï¼‰', 'success');
        } else {
          showSettingsStatus('ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        showSettingsStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
      }
    });
    
    // ä¿å­˜ç¼“å­˜è®¾ç½®
    document.getElementById('btnSaveCacheSettings')?.addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('adminToken');
        const settings = {
          custom: {
            cache: {
              ttl: {
                news: parseInt(document.getElementById('cacheTtlNews').value) || 3600,
                events: parseInt(document.getElementById('cacheTtlEvents').value) || 300,
                results: parseInt(document.getElementById('cacheTtlResults').value) || 7200
              }
            },
            updateInterval: {
              news: parseInt(document.getElementById('updateIntervalNews').value) || 3600,
              events: parseInt(document.getElementById('updateIntervalEvents').value) || 300,
              results: parseInt(document.getElementById('updateIntervalResults').value) || 1800
            }
          }
        };
        
        const response = await fetch(`${getApiUrl()}/api/admin/system-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ settings })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('ç¼“å­˜é…ç½®å·²ä¿å­˜ï¼ˆéœ€è¦ä¿®æ”¹ç¯å¢ƒå˜é‡åé‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆï¼‰', 'success');
        } else {
          showSettingsStatus('ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        showSettingsStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
      }
    });
    
    // æ·»åŠ RSSæº
    document.getElementById('btnAddRssSource')?.addEventListener('click', () => {
      currentRssSourceEditId = null;
      document.getElementById('rssSourceForm').style.display = 'block';
      document.getElementById('rssSourceName').value = '';
      document.getElementById('rssSourceUrl').value = '';
      document.getElementById('rssSourceType').value = 'media';
      document.getElementById('rssSourceRegion').value = 'local';
    });
    
    // ä¿å­˜RSSæº
    document.getElementById('btnSaveRssSource')?.addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('adminToken');
        const name = document.getElementById('rssSourceName').value.trim();
        const url = document.getElementById('rssSourceUrl').value.trim();
        const type = document.getElementById('rssSourceType').value;
        const region = document.getElementById('rssSourceRegion').value;
        
        if (!name || !url) {
          showSettingsStatus('è¯·å¡«å†™å®Œæ•´çš„RSSæºä¿¡æ¯', 'error');
          return;
        }
        
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ name, url, type, region })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('RSSæºå·²æ·»åŠ ', 'success');
          document.getElementById('rssSourceForm').style.display = 'none';
          loadRssSources();
        } else {
          showSettingsStatus('æ·»åŠ å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        showSettingsStatus('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
      }
    });
    
    // å–æ¶ˆRSSæºç¼–è¾‘
    document.getElementById('btnCancelRssSource')?.addEventListener('click', () => {
      document.getElementById('rssSourceForm').style.display = 'none';
      currentRssSourceEditId = null;
    });
    
    // æµ‹è¯•RSSæº
    document.getElementById('btnTestRssSource')?.addEventListener('click', async () => {
      const url = document.getElementById('rssSourceUrl').value.trim();
      if (!url) {
        showSettingsStatus('è¯·å…ˆè¾“å…¥RSS URL', 'error');
        return;
      }
      
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources/test`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ url })
        });
        
        const result = await response.json();
        const resultDiv = document.getElementById('rssSourceTestResult');
        
        if (result.success && result.data?.valid) {
          resultDiv.innerHTML = `<div style="padding:12px;background:#d1fae5;color:#047857;border-radius:6px;">âœ… è¿æ¥æˆåŠŸï¼æ‰¾åˆ° ${result.data.itemCount} æ¡å†…å®¹</div>`;
        } else {
          resultDiv.innerHTML = `<div style="padding:12px;background:#fee2e2;color:#991b1b;border-radius:6px;">âŒ è¿æ¥å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
        }
      } catch (error) {
        document.getElementById('rssSourceTestResult').innerHTML = `<div style="padding:12px;background:#fee2e2;color:#991b1b;border-radius:6px;">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
      }
    });
    
    // ç¼–è¾‘RSSæº
    window.editRssSource = async (id) => {
      // TODO: å®ç°ç¼–è¾‘åŠŸèƒ½
      alert('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...');
    };
    
    // åˆ‡æ¢RSSæºçŠ¶æ€
    window.toggleRssSource = async (id, currentStatus) => {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources/${id}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ active: !currentStatus })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('RSSæºçŠ¶æ€å·²æ›´æ–°', 'success');
          loadRssSources();
        } else {
          showSettingsStatus('æ›´æ–°å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        showSettingsStatus('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
      }
    };
    
    // åˆ é™¤RSSæº
    window.deleteRssSource = async (id) => {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªRSSæºå—ï¼Ÿ')) return;
      
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('RSSæºå·²åˆ é™¤', 'success');
          loadRssSources();
        } else {
          showSettingsStatus('åˆ é™¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        showSettingsStatus('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    };
    
    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showSettingsStatus(message, type) {
      const statusDiv = document.getElementById('settingsStatus');
      statusDiv.style.display = 'block';
      statusDiv.style.padding = '12px';
      statusDiv.style.borderRadius = 'var(--radius-md)';
      
      if (type === 'success') {
        statusDiv.style.background = '#d1fae5';
        statusDiv.style.color = '#047857';
      } else {
        statusDiv.style.background = '#fee2e2';
        statusDiv.style.color = '#991b1b';
      }
      
      statusDiv.textContent = message;
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      const btnRefreshModelInfo = document.getElementById('btnRefreshModelInfo');
      const btnRefreshAdvice = document.getElementById('btnRefreshAdvice');
      const btnRefreshAnalytics = document.getElementById('btnRefreshAnalytics');
      const btnRefreshApis = document.getElementById('btnRefreshApis');
      const btnRefreshLearning = document.getElementById('btnRefreshLearning');
      const btnRefreshMaintenance = document.getElementById('btnRefreshMaintenance');
      
      if (btnRefreshModelInfo) {
        btnRefreshModelInfo.addEventListener('click', () => {
          loadCoreAdminModelInfo();
        });
      }
      
      if (btnRefreshAdvice) {
        btnRefreshAdvice.addEventListener('click', () => {
          loadCoreAdminAdvice();
        });
      }
      
      if (btnRefreshAnalytics) {
        btnRefreshAnalytics.addEventListener('click', () => {
          loadCoreAdminAnalytics();
        });
      }
      
      if (btnRefreshApis) {
        btnRefreshApis.addEventListener('click', () => {
          loadCoreAdminApis();
        });
      }
      
      if (btnRefreshLearning) {
        btnRefreshLearning.addEventListener('click', () => {
          loadCoreAdminLearning();
        });
      }
      
      if (btnRefreshMaintenance) {
        btnRefreshMaintenance.addEventListener('click', () => {
          loadCoreAdminMaintenance();
        });
      }
    });
    
    // ç³»ç»Ÿå‡çº§åŠŸèƒ½
    async function loadUpgradeData() {
      const CORE_ADMIN_API_BASE = 'http://localhost:3001/api';
      
      try {
        // åŠ è½½å‡çº§æ¦‚è§ˆ
        const overviewResponse = await fetch(`${CORE_ADMIN_API_BASE}/upgrade/overview`);
        if (overviewResponse.ok) {
          const overviewResult = await overviewResponse.json();
          if (overviewResult.success && overviewResult.data) {
            const overview = overviewResult.data;
            document.getElementById('upgradeVersion').textContent = `v${overview.version}`;
            document.getElementById('upgradePartsCount').textContent = overview.completedCount || '--';
            document.getElementById('upgradeNewFiles').textContent = overview.statistics?.newFiles || '--';
            document.getElementById('upgradeNewCode').textContent = (overview.statistics?.newCodeLines / 1000).toFixed(1) + 'K';
            document.getElementById('upgradeAutomation').textContent = overview.capabilities?.automation || '--';
          }
        }

        // åŠ è½½å‡çº§éƒ¨åˆ†
        const partsResponse = await fetch(`${CORE_ADMIN_API_BASE}/upgrade/parts`);
        if (partsResponse.ok) {
          const partsResult = await partsResponse.json();
          if (partsResult.success && partsResult.data) {
            renderUpgradeParts(partsResult.data);
          }
        }

        // åŠ è½½èƒ½åŠ›æå‡
        const capabilitiesResponse = await fetch(`${CORE_ADMIN_API_BASE}/upgrade/capabilities`);
        if (capabilitiesResponse.ok) {
          const capabilitiesResult = await capabilitiesResponse.json();
          if (capabilitiesResult.success && capabilitiesResult.data) {
            renderCapabilities(capabilitiesResult.data);
          }
        }
      } catch (error) {
        console.error('åŠ è½½å‡çº§æ•°æ®å¤±è´¥:', error);
        document.getElementById('upgradePartsList').innerHTML = `
          <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:1px solid #f59e0b;">
            <p style="margin:0 0 12px 0;color:#92400e;font-weight:600;">âš ï¸ æ— æ³•è¿æ¥åˆ°å‡çº§æœåŠ¡</p>
            <p style="margin:0;color:#78350f;font-size:14px;">è¯·ç¡®ä¿ä¸­æ¢ç®¡å®¶æœåŠ¡æ­£åœ¨è¿è¡Œ</p>
          </div>
        `;
      }
    }

    // æ¸²æŸ“å‡çº§éƒ¨åˆ†
    function renderUpgradeParts(parts) {
      const container = document.getElementById('upgradePartsList');
      
      if (!parts || parts.length === 0) {
        container.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">æš‚æ— å‡çº§è®°å½•</p>';
        return;
      }

      const html = parts.map(part => `
        <div style="background:#f8fafc;border-radius:12px;padding:24px;margin-bottom:16px;border:2px solid #e2e8f0;transition:all 0.3s ease;" 
             onmouseover="this.style.borderColor='#3b82f6';this.style.boxShadow='0 4px 12px rgba(59,130,246,0.15)'" 
             onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
          <div style="display:flex;align-items:start;gap:16px;">
            <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;">
              ${part.id === 'frontend' ? 'ğŸ¨' : part.id === 'security' ? 'ğŸ”’' : part.id === 'database' ? 'ğŸ—„ï¸' : 'ğŸ¤–'}
            </div>
            <div style="flex:1;">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                <h4 style="margin:0;font-size:18px;font-weight:700;color:#1e293b;">${part.name}</h4>
                <span style="background:#10b981;color:#fff;padding:4px 12px;border-radius:6px;font-size:12px;font-weight:600;">âœ… ${part.status === 'completed' ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}</span>
              </div>
              <p style="margin:0 0 16px 0;color:#64748b;font-size:14px;line-height:1.6;">${part.description}</p>
              
              ${part.files && part.files.length > 0 ? `
                <div style="margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;">ç›¸å…³æ–‡ä»¶ï¼š</div>
                  <div style="display:flex;flex-wrap:wrap;gap:8px;">
                    ${part.files.map(file => `
                      <span style="background:#e2e8f0;color:#475569;padding:4px 10px;border-radius:6px;font-size:12px;font-family:monospace;">${file}</span>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              ${part.modules && part.modules.length > 0 ? `
                <div style="margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;">æ–°å¢æ¨¡å—ï¼š</div>
                  <div style="display:flex;flex-wrap:wrap;gap:8px;">
                    ${part.modules.map(module => `
                      <div style="background:#dbeafe;color:#1e40af;padding:6px 12px;border-radius:6px;font-size:12px;display:flex;align-items:center;gap:6px;">
                        <span>ğŸ“¦</span>
                        <span>${module.name}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              ${part.benefits && part.benefits.length > 0 ? `
                <div>
                  <div style="font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;">æ”¶ç›Šï¼š</div>
                  <ul style="margin:0;padding-left:20px;color:#64748b;font-size:13px;">
                    ${part.benefits.map(benefit => `<li style="margin-bottom:4px;">${benefit}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    // æ¸²æŸ“èƒ½åŠ›æå‡
    function renderCapabilities(capabilities) {
      const container = document.getElementById('upgradeCapabilities');
      
      const html = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">
          <div style="background:linear-gradient(135deg, #e6f0ff 0%, #dbeafe 100%);border-radius:12px;padding:20px;border:2px solid rgba(59,130,246,0.2);">
            <div style="font-size:14px;font-weight:600;color:#1e40af;margin-bottom:8px;">è‡ªåŠ¨åŒ–ç‡</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.automation || '--'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);border-radius:12px;padding:20px;border:2px solid rgba(16,185,129,0.2);">
            <div style="font-size:14px;font-weight:600;color:#065f46;margin-bottom:8px;">æ™ºèƒ½åŒ–ç‡</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.intelligence || '--'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border-radius:12px;padding:20px;border:2px solid rgba(245,158,11,0.2);">
            <div style="font-size:14px;font-weight:600;color:#92400e;margin-bottom:8px;">é¢„æµ‹å‡†ç¡®ç‡</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.prediction || '--'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);border-radius:12px;padding:20px;border:2px solid rgba(236,72,153,0.2);">
            <div style="font-size:14px;font-weight:600;color:#9f1239;margin-bottom:8px;">APIå®‰å…¨æ€§</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.security || '--'}</div>
          </div>
        </div>
      `;

      container.innerHTML = html;
    }

    // æ™ºèƒ½åŠŸèƒ½æ¨¡å—åŠ è½½å‡½æ•°
    const CORE_ADMIN_API_BASE = 'http://localhost:3001/api';

    // åŠ è½½æ™ºèƒ½å†³ç­–å»ºè®®
    async function loadIntelligentAdvice() {
      const preview = document.getElementById('intelligentAdvicePreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/advice`);
        const result = await response.json();
        if (result.success && result.data) {
          const advice = result.data;
          preview.innerHTML = `<strong>${advice.title || 'æ™ºèƒ½å»ºè®®'}</strong><br>${advice.description || advice.reason || 'æš‚æ— å»ºè®®'}`;
          // å¯ä»¥æ‰“å¼€è¯¦ç»†æ¨¡æ€æ¡†æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
          showIntelligentModal('å†³ç­–å¼•æ“', advice);
        } else {
          preview.innerHTML = 'æš‚æ— å»ºè®®';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½æ™ºèƒ½å»ºè®®å¤±è´¥:', error);
      }
    }

    // åŠ è½½é¢„æµ‹ç»´æŠ¤ä¿¡æ¯
    async function loadIntelligentPredictions() {
      const preview = document.getElementById('intelligentPredictionsPreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/predictions`);
        const result = await response.json();
        if (result.success && result.data) {
          const predictions = result.data;
          const count = predictions.predictions?.length || 0;
          preview.innerHTML = `å‘ç° <strong>${count}</strong> ä¸ªæ½œåœ¨é—®é¢˜<br>${predictions.summary || 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…'}`;
          showIntelligentModal('é¢„æµ‹ç»´æŠ¤', predictions);
        } else {
          preview.innerHTML = 'æš‚æ— é¢„æµ‹ä¿¡æ¯';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½é¢„æµ‹ä¿¡æ¯å¤±è´¥:', error);
      }
    }

    // åŠ è½½å·¥ä½œæµåˆ—è¡¨
    async function loadIntelligentWorkflows() {
      const preview = document.getElementById('intelligentWorkflowsPreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/workflows`);
        const result = await response.json();
        if (result.success && result.data) {
          const workflows = result.data;
          const count = workflows.workflows?.length || 0;
          preview.innerHTML = `å…±æœ‰ <strong>${count}</strong> ä¸ªå·¥ä½œæµ<br>${workflows.summary || 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…'}`;
          showIntelligentModal('å·¥ä½œæµå¼•æ“', workflows);
        } else {
          preview.innerHTML = 'æš‚æ— å·¥ä½œæµ';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½å·¥ä½œæµå¤±è´¥:', error);
      }
    }

    // åŠ è½½å‘Šè­¦åˆ—è¡¨
    async function loadIntelligentAlerts() {
      const preview = document.getElementById('intelligentAlertsPreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/alerts`);
        const result = await response.json();
        if (result.success && result.data) {
          const alerts = result.data;
          const activeCount = alerts.alerts?.filter(a => a.status === 'active').length || 0;
          preview.innerHTML = `æ´»è·ƒå‘Šè­¦: <strong style="color:#ef4444;">${activeCount}</strong><br>${alerts.summary || 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…'}`;
          showIntelligentModal('å‘Šè­¦ç³»ç»Ÿ', alerts);
        } else {
          preview.innerHTML = 'æš‚æ— å‘Šè­¦';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½å‘Šè­¦å¤±è´¥:', error);
      }
    }

    // åŠ è½½è‡ªé€‚åº”ä¼˜åŒ–çŠ¶æ€
    async function loadIntelligentOptimization() {
      const preview = document.getElementById('intelligentOptimizationPreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/optimization`);
        const result = await response.json();
        if (result.success && result.data) {
          const optimization = result.data;
          preview.innerHTML = `ä¼˜åŒ–çŠ¶æ€: <strong>${optimization.status || 'è¿è¡Œä¸­'}</strong><br>${optimization.summary || 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…'}`;
          showIntelligentModal('è‡ªé€‚åº”ä¼˜åŒ–', optimization);
        } else {
          preview.innerHTML = 'æš‚æ— ä¼˜åŒ–ä¿¡æ¯';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½ä¼˜åŒ–ä¿¡æ¯å¤±è´¥:', error);
      }
    }

    // åŠ è½½çŸ¥è¯†å›¾è°±
    async function loadIntelligentKnowledge() {
      const preview = document.getElementById('intelligentKnowledgePreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/knowledge`);
        const result = await response.json();
        if (result.success && result.data) {
          const knowledge = result.data;
          preview.innerHTML = `å®ä½“æ•°é‡: <strong>${knowledge.entities?.length || 0}</strong><br>${knowledge.summary || 'ç‚¹å‡»æŸ¥è¯¢çŸ¥è¯†å›¾è°±'}`;
          showIntelligentModal('çŸ¥è¯†å›¾è°±', knowledge);
        } else {
          preview.innerHTML = 'æš‚æ— çŸ¥è¯†æ•°æ®';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½çŸ¥è¯†å›¾è°±å¤±è´¥:', error);
      }
    }

    // åŠ è½½æ™ºèƒ½æŠ¥å‘Š
    async function loadIntelligentReports() {
      const preview = document.getElementById('intelligentReportsPreview');
      preview.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/reports`);
        const result = await response.json();
        if (result.success && result.data) {
          const reports = result.data;
          const count = reports.reports?.length || 0;
          preview.innerHTML = `å…±æœ‰ <strong>${count}</strong> ä¸ªæŠ¥å‘Š<br>${reports.summary || 'ç‚¹å‡»æŸ¥çœ‹æŠ¥å‘Š'}`;
          showIntelligentModal('æ™ºèƒ½æŠ¥å‘Š', reports);
        } else {
          preview.innerHTML = 'æš‚æ— æŠ¥å‘Š';
        }
      } catch (error) {
        preview.innerHTML = 'åŠ è½½å¤±è´¥';
        console.error('åŠ è½½æŠ¥å‘Šå¤±è´¥:', error);
      }
    }

    // æ˜¾ç¤ºæ™ºèƒ½åŠŸèƒ½è¯¦ç»†ä¿¡æ¯çš„æ¨¡æ€æ¡†
    function showIntelligentModal(title, data) {
      // åˆ›å»ºæˆ–è·å–æ¨¡æ€æ¡†
      let modal = document.getElementById('intelligentModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'intelligentModal';
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-content" style="max-width:800px;">
            <div class="modal-header">
              <h3 id="intelligentModalTitle">${title}</h3>
              <button class="btn btn-ghost btn-sm" onclick="closeIntelligentModal()">âœ•</button>
            </div>
            <div class="modal-body" id="intelligentModalBody" style="max-height:70vh;overflow-y:auto;">
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" onclick="closeIntelligentModal()">å…³é—­</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      document.getElementById('intelligentModalTitle').textContent = title;
      const body = document.getElementById('intelligentModalBody');
      
      // æ ¼å¼åŒ–æ˜¾ç¤ºæ•°æ®
      body.innerHTML = `<pre style="white-space:pre-wrap;word-wrap:break-word;font-family:inherit;font-size:14px;line-height:1.6;">${JSON.stringify(data, null, 2)}</pre>`;
      
      modal.style.display = 'flex';
    }

    function closeIntelligentModal() {
      const modal = document.getElementById('intelligentModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    // åˆå§‹åŒ–
    // å®‰å…¨ç‰ˆæœ¬çš„checkAuthè°ƒç”¨ï¼ˆæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼‰
    if (!window.__loginInProgress && !window.__justLoggedIn) {
      setTimeout(function() {
        if (!window.__loginInProgress && !window.__justLoggedIn) {
          checkAuth();
        }
      }, 2000);
    }
    
    // ========================================
    // ğŸ¤– è®­ç»ƒæ™ºèƒ½åˆ†æä¸æ€»ç»“åŠŸèƒ½ï¼ˆåå°ï¼‰
    // ========================================
    
    const TRAINING_ANALYSIS_STORAGE_KEY_ADMIN = 'pigeon_training_analysis_v1';
    let trainingAnalysisRecordsAdmin = [];
    
    // åŠ è½½è®­ç»ƒåˆ†æè®°å½•
    function loadTrainingAnalysisAdmin() {
      try {
        const raw = localStorage.getItem(TRAINING_ANALYSIS_STORAGE_KEY_ADMIN);
        if (raw) trainingAnalysisRecordsAdmin = JSON.parse(raw);
        else trainingAnalysisRecordsAdmin = [];
      } catch (e) {
        console.error('åŠ è½½è®­ç»ƒåˆ†æè®°å½•å¤±è´¥:', e);
        trainingAnalysisRecordsAdmin = [];
      }
    }
    
    // ä¿å­˜è®­ç»ƒåˆ†æè®°å½•
    function saveTrainingAnalysisAdmin() {
      try {
        localStorage.setItem(TRAINING_ANALYSIS_STORAGE_KEY_ADMIN, JSON.stringify(trainingAnalysisRecordsAdmin));
      } catch (e) {
        console.error('ä¿å­˜è®­ç»ƒåˆ†æè®°å½•å¤±è´¥:', e);
      }
    }
    
    // åˆ†æè®­ç»ƒè®°å½•ï¼ˆè°ƒç”¨AIï¼‰- åå°ç‰ˆæœ¬
    async function analyzeTrainingRecordAdmin(trainingRecord) {
      try {
        // è·å–é¸½å­ä¿¡æ¯ï¼ˆéœ€è¦ä»APIæˆ–localStorageè·å–ï¼‰
        let pigeon = null;
        try {
          const pigeons = JSON.parse(localStorage.getItem('pigeon_manager_data_v1') || '[]');
          pigeon = pigeons.find(p => p.id === trainingRecord.pigeonId);
        } catch (e) {
          console.warn('è·å–é¸½å­ä¿¡æ¯å¤±è´¥:', e);
        }
        
        if (!pigeon) {
          console.warn('é¸½å­ä¸å­˜åœ¨:', trainingRecord.pigeonId);
          return;
        }
        
        // è·å–è¯¥é¸½å­çš„æ‰€æœ‰è®­ç»ƒè®°å½•
        const TRAINING_STORAGE_KEY = 'pigeon_training_records_v1';
        let allTrainingRecords = [];
        try {
          const raw = localStorage.getItem(TRAINING_STORAGE_KEY);
          if (raw) allTrainingRecords = JSON.parse(raw);
        } catch (e) {
          console.error('åŠ è½½è®­ç»ƒè®°å½•å¤±è´¥:', e);
        }
        
        const pigeonTrainings = allTrainingRecords
          .filter(r => r.pigeonId === trainingRecord.pigeonId)
          .sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // è·å–ä¸Šä¸€æ¬¡è®­ç»ƒè®°å½•
        const previousTraining = pigeonTrainings.length > 1 ? pigeonTrainings[1] : null;
        
        // è·å–æ¯”èµ›æ•°æ®ï¼ˆç”¨äºå¯¹æ¯”ï¼‰
        let races = [];
        try {
          const RACES_STORAGE_KEY = 'pigeon_races';
          const raw = localStorage.getItem(RACES_STORAGE_KEY);
          if (raw) {
            const data = JSON.parse(raw);
            races = Array.isArray(data) ? data : [];
          }
        } catch (e) {
          console.warn('åŠ è½½æ¯”èµ›æ•°æ®å¤±è´¥:', e);
        }
        const pigeonRaces = races.flatMap(race => 
          (race.participants || []).filter(p => p.pigeonId === trainingRecord.pigeonId)
            .map(p => ({ ...race, participant: p }))
        );
        
        // æ„å»ºAIåˆ†ææç¤ºè¯ï¼ˆä½¿ç”¨ä¸PCç«¯ç›¸åŒçš„å‡½æ•°ï¼‰
        const analysisPrompt = buildTrainingAnalysisPromptAdmin(
          pigeon,
          trainingRecord,
          previousTraining,
          pigeonTrainings,
          pigeonRaces
        );
        
        // è°ƒç”¨AIåˆ†æï¼ˆä½¿ç”¨ä¸PCç«¯ç›¸åŒçš„å‡½æ•°ï¼‰
        const analysisResult = await callAIForTrainingAnalysisAdmin(analysisPrompt);
        
        if (analysisResult) {
          // ä¿å­˜åˆ†æç»“æœ
          const analysisRecord = {
            id: 'analysis_' + Date.now(),
            pigeonId: trainingRecord.pigeonId,
            trainingRecordId: trainingRecord.id,
            date: trainingRecord.date,
            analysis: analysisResult.analysis,
            summary: analysisResult.summary,
            comparison: analysisResult.comparison,
            suggestions: analysisResult.suggestions,
            createdAt: new Date().toISOString()
          };
          
          // æ£€æŸ¥æ˜¯å¦å·²æœ‰è¯¥é¸½å­çš„åˆ†æè®°å½•
          const existingIndex = trainingAnalysisRecordsAdmin.findIndex(
            a => a.pigeonId === trainingRecord.pigeonId
          );
          
          if (existingIndex >= 0) {
            // æ›´æ–°ç°æœ‰è®°å½•ï¼Œå°†æ–°åˆ†ææ·»åŠ åˆ°å†å²è®°å½•
            const existing = trainingAnalysisRecordsAdmin[existingIndex];
            if (!existing.history) existing.history = [];
            existing.history.unshift({
              ...existing,
              id: existing.id + '_history_' + Date.now()
            });
            // æ›´æ–°æœ€æ–°åˆ†æ
            trainingAnalysisRecordsAdmin[existingIndex] = {
              ...analysisRecord,
              history: existing.history,
              totalTrainings: pigeonTrainings.length
            };
          } else {
            // åˆ›å»ºæ–°è®°å½•
            trainingAnalysisRecordsAdmin.push({
              ...analysisRecord,
              history: [],
              totalTrainings: pigeonTrainings.length
            });
          }
          
          saveTrainingAnalysisAdmin();
          renderTrainingAnalysisAdmin();
          renderTrainingAnalysisTableAdmin();
          
          console.log('âœ… è®­ç»ƒåˆ†æå®Œæˆ:', analysisRecord);
        }
      } catch (error) {
        console.error('è®­ç»ƒåˆ†æå¤±è´¥:', error);
        alert('AIåˆ†æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
    }
    
    // æ„å»ºè®­ç»ƒåˆ†ææç¤ºè¯ - åå°ç‰ˆæœ¬ï¼ˆä¸PCç«¯ç›¸åŒï¼‰
    function buildTrainingAnalysisPromptAdmin(pigeon, currentTraining, previousTraining, allTrainings, races) {
      const avgSpeed = currentTraining.distance && currentTraining.duration 
        ? (currentTraining.distance / (currentTraining.duration / 60)).toFixed(1) 
        : 'æœªçŸ¥';
      
      let prompt = `è¯·ä½œä¸ºä¸“ä¸šçš„ä¿¡é¸½è®­ç»ƒåˆ†æå¸ˆï¼Œå¯¹ä»¥ä¸‹è®­ç»ƒè®°å½•è¿›è¡Œæ™ºèƒ½åˆ†æå’Œæ€»ç»“ï¼š

ã€é¸½å­ä¿¡æ¯ã€‘
- è¶³ç¯å·ï¼š${pigeon.ring}
- åå­—ï¼š${pigeon.name || 'æœªå‘½å'}
- æ€§åˆ«ï¼š${pigeon.gender || 'æœªçŸ¥'}
- ç±»å‹ï¼š${pigeon.type || 'æœªçŸ¥'}

ã€æœ¬æ¬¡è®­ç»ƒè®°å½•ã€‘
- è®­ç»ƒæ—¥æœŸï¼š${currentTraining.date}
- è®­ç»ƒè·ç¦»ï¼š${currentTraining.distance}å…¬é‡Œ
- é£è¡Œæ—¶é•¿ï¼š${currentTraining.duration}åˆ†é’Ÿ
- å¹³å‡é€Ÿåº¦ï¼š${avgSpeed}å…¬é‡Œ/å°æ—¶
- å¤©æ°”ï¼š${currentTraining.weather || 'æœªçŸ¥'}
- æ¸©åº¦ï¼š${currentTraining.temperature ? currentTraining.temperature + 'â„ƒ' : 'æœªçŸ¥'}
- å¤‡æ³¨ï¼š${currentTraining.notes || 'æ— '}

ã€å†å²è®­ç»ƒç»Ÿè®¡ã€‘
- æ€»è®­ç»ƒæ¬¡æ•°ï¼š${allTrainings.length}æ¬¡
- å¹³å‡è®­ç»ƒè·ç¦»ï¼š${(allTrainings.reduce((sum, t) => sum + (t.distance || 0), 0) / allTrainings.length).toFixed(1)}å…¬é‡Œ
- æœ€å¤§è®­ç»ƒè·ç¦»ï¼š${Math.max(...allTrainings.map(t => t.distance || 0))}å…¬é‡Œ
- æœ€è¿‘10æ¬¡è®­ç»ƒå¹³å‡é€Ÿåº¦ï¼š${calculateAvgSpeedAdmin(allTrainings.slice(0, 10))}å…¬é‡Œ/å°æ—¶

`;

      if (previousTraining) {
        const prevSpeed = previousTraining.distance && previousTraining.duration 
          ? (previousTraining.distance / (previousTraining.duration / 60)).toFixed(1) 
          : 'æœªçŸ¥';
        const speedChange = prevSpeed !== 'æœªçŸ¥' && avgSpeed !== 'æœªçŸ¥' 
          ? ((parseFloat(avgSpeed) - parseFloat(prevSpeed)) / parseFloat(prevSpeed) * 100).toFixed(1) 
          : '0';
        
        prompt += `ã€ä¸ä¸Šæ¬¡è®­ç»ƒå¯¹æ¯”ã€‘
- ä¸Šæ¬¡è®­ç»ƒæ—¥æœŸï¼š${previousTraining.date}
- ä¸Šæ¬¡è®­ç»ƒè·ç¦»ï¼š${previousTraining.distance}å…¬é‡Œ
- ä¸Šæ¬¡å¹³å‡é€Ÿåº¦ï¼š${prevSpeed}å…¬é‡Œ/å°æ—¶
- é€Ÿåº¦å˜åŒ–ï¼š${speedChange > 0 ? '+' : ''}${speedChange}%
- è·ç¦»å˜åŒ–ï¼š${previousTraining.distance ? ((currentTraining.distance - previousTraining.distance) / previousTraining.distance * 100).toFixed(1) : '0'}%

`;
      }
      
      if (races.length > 0) {
        const ranks = races.map(r => r.participant.rank || 999).filter(r => r !== 999);
        prompt += `ã€æ¯”èµ›æˆç»©å¯¹æ¯”ã€‘
- å‚èµ›æ¬¡æ•°ï¼š${races.length}æ¬¡
- æœ€ä½³åæ¬¡ï¼š${ranks.length > 0 ? Math.min(...ranks) : 'æ— '}
- å¹³å‡åæ¬¡ï¼š${ranks.length > 0 ? (ranks.reduce((sum, r) => sum + r, 0) / ranks.length).toFixed(1) : 'æ— '}
- æ¯”èµ›å¹³å‡è·ç¦»ï¼š${(races.reduce((sum, r) => sum + (r.distance || 0), 0) / races.length).toFixed(1)}å…¬é‡Œ

`;
      }
      
      prompt += `è¯·æä¾›ä»¥ä¸‹å†…å®¹ï¼š
1. **è®­ç»ƒè¡¨ç°åˆ†æ**ï¼šåˆ†ææœ¬æ¬¡è®­ç»ƒçš„è¡¨ç°ï¼ŒåŒ…æ‹¬é€Ÿåº¦ã€è€åŠ›ã€çŠ¶æ€ç­‰æ–¹é¢
2. **æ€»ç»“**ï¼šå¯¹æœ¬æ¬¡è®­ç»ƒè¿›è¡Œç®€è¦æ€»ç»“
3. **è¿›æ­¥ä¸ä¸è¶³**ï¼š${previousTraining ? 'å¯¹æ¯”ä¸Šæ¬¡è®­ç»ƒï¼ŒæŒ‡å‡ºè¿›æ­¥å’Œä¸è¶³' : 'æŒ‡å‡ºæœ¬æ¬¡è®­ç»ƒçš„äº®ç‚¹å’Œéœ€è¦æ”¹è¿›çš„åœ°æ–¹'}
4. **å»ºè®®**ï¼šç»™å‡ºé’ˆå¯¹æ€§çš„è®­ç»ƒå»ºè®®ï¼ŒåŒ…æ‹¬è·ç¦»ã€å¼ºåº¦ã€é¢‘ç‡ç­‰æ–¹é¢çš„å»ºè®®

è¯·ä»¥JSONæ ¼å¼è¿”å›ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{
  "analysis": "è¯¦ç»†çš„åˆ†æå†…å®¹",
  "summary": "ç®€è¦æ€»ç»“",
  "comparison": "ä¸ä¸Šæ¬¡è®­ç»ƒçš„å¯¹æ¯”åˆ†æ",
  "suggestions": "è®­ç»ƒå»ºè®®"
}`;
      
      return prompt;
    }
    
    // è®¡ç®—å¹³å‡é€Ÿåº¦ - åå°ç‰ˆæœ¬
    function calculateAvgSpeedAdmin(trainings) {
      if (!trainings || trainings.length === 0) return '0';
      const speeds = trainings
        .filter(t => t.distance && t.duration)
        .map(t => t.distance / (t.duration / 60));
      if (speeds.length === 0) return '0';
      return (speeds.reduce((sum, s) => sum + s, 0) / speeds.length).toFixed(1);
    }
    
    // è°ƒç”¨AIè¿›è¡Œè®­ç»ƒåˆ†æ - åå°ç‰ˆæœ¬
    async function callAIForTrainingAnalysisAdmin(prompt) {
      try {
        const adminToken = localStorage.getItem('adminToken');
        if (!adminToken) {
          console.warn('âš ï¸ ç®¡ç†å‘˜æœªç™»å½•ï¼Œæ— æ³•ä½¿ç”¨AIåˆ†æåŠŸèƒ½');
          return {
            analysis: 'AIåˆ†æåŠŸèƒ½éœ€è¦ç®¡ç†å‘˜ç™»å½•åä½¿ç”¨',
            summary: 'æ— æ³•ç”Ÿæˆåˆ†æ',
            comparison: 'æ— æ³•å¯¹æ¯”',
            suggestions: 'è¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦å·'
          };
        }

        // ä¼˜å…ˆä½¿ç”¨åç«¯APIä»£ç†ï¼ˆæ¨èæ–¹å¼ï¼‰
        try {
          const apiUrl = getApiUrl();
          const response = await fetch(`${apiUrl}/ai/analyze`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${adminToken}`
            },
            body: JSON.stringify({
              prompt: prompt,
              context: {
                system: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¿¡é¸½è®­ç»ƒåˆ†æå¸ˆï¼Œæ“…é•¿åˆ†æè®­ç»ƒæ•°æ®å¹¶æä¾›ä¸“ä¸šå»ºè®®ã€‚'
              }
            })
          });

          if (response.ok) {
            const result = await response.json();
            if (result.success && result.data && result.data.content) {
              return parseAIResponseAdmin(result.data.content);
            }
          }
        } catch (apiError) {
          console.warn('åç«¯AIä»£ç†è°ƒç”¨å¤±è´¥ï¼Œå°è¯•ç›´æ¥è°ƒç”¨:', apiError);
        }

        // å¤‡ç”¨æ–¹æ¡ˆï¼šä»åç«¯è·å–API keyåç›´æ¥è°ƒç”¨æ™ºè°±API
        try {
          const apiUrl = getApiUrl();
          const keyResponse = await fetch(`${apiUrl}/ai/api-key`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${adminToken}`
            }
          });

          if (keyResponse.ok) {
            const keyResult = await keyResponse.json();
            if (keyResult.success && keyResult.data && keyResult.data.apiKey) {
              const apiKey = keyResult.data.apiKey;
              const model = keyResult.data.model || 'glm-4';

              const response = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                  model: model,
                  messages: [
                    { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¿¡é¸½è®­ç»ƒåˆ†æå¸ˆï¼Œæ“…é•¿åˆ†æè®­ç»ƒæ•°æ®å¹¶æä¾›ä¸“ä¸šå»ºè®®ã€‚' },
                    { role: 'user', content: prompt }
                  ],
                  temperature: 0.7,
                  max_tokens: 2000
                })
              });

              if (response.ok) {
                const data = await response.json();
                const content = data.choices?.[0]?.message?.content || '';
                return parseAIResponseAdmin(content);
              }
            }
          }
        } catch (keyError) {
          console.warn('è·å–API keyå¤±è´¥:', keyError);
        }

        // å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œè¿”å›é»˜è®¤åˆ†æ
        return {
          analysis: 'AIåˆ†æåŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥APIé…ç½®',
          summary: 'æ— æ³•ç”Ÿæˆåˆ†æ',
          comparison: 'æ— æ³•å¯¹æ¯”',
          suggestions: 'è¯·ç¡®ä¿å·²åœ¨Zeaburç¯å¢ƒå˜é‡ä¸­é…ç½®ZHIPU_API_KEY_EVOæˆ–ZHIPU_API_KEY_ADMIN'
        };
      } catch (error) {
        console.error('AIåˆ†æè°ƒç”¨å¤±è´¥:', error);
        throw error;
      }
    }
    
    // è§£æAIå“åº” - åå°ç‰ˆæœ¬
    function parseAIResponseAdmin(content) {
      try {
        // å°è¯•æå–JSON
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          return JSON.parse(jsonMatch[0]);
        }
        // å¦‚æœä¸æ˜¯JSONæ ¼å¼ï¼Œè¿”å›æ–‡æœ¬å†…å®¹
        return {
          analysis: content,
          summary: content.substring(0, 100) + '...',
          comparison: 'æ— æ³•è§£æå¯¹æ¯”ä¿¡æ¯',
          suggestions: 'è¯·æŸ¥çœ‹è¯¦ç»†åˆ†æ'
        };
      } catch (e) {
        return {
          analysis: content,
          summary: content.substring(0, 100) + '...',
          comparison: 'æ— æ³•è§£æå¯¹æ¯”ä¿¡æ¯',
          suggestions: 'è¯·æŸ¥çœ‹è¯¦ç»†åˆ†æ'
        };
      }
    }
    
    // æ¸²æŸ“è®­ç»ƒåˆ†æ - åå°ç‰ˆæœ¬
    function renderTrainingAnalysisAdmin() {
      const container = document.getElementById('trainingAnalysisContainerAdmin');
      if (!container) return;
      
      if (trainingAnalysisRecordsAdmin.length === 0) {
        container.innerHTML = '<p class="muted">æš‚æ— åˆ†ææ•°æ®ï¼Œè¯·å…ˆæ·»åŠ è®­ç»ƒè®°å½•</p>';
        return;
      }
      
      // æ˜¾ç¤ºæœ€æ–°çš„å‡ æ¡åˆ†æ
      const latestAnalyses = trainingAnalysisRecordsAdmin
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 3);
      
      container.innerHTML = latestAnalyses.map(analysis => {
        let pigeon = null;
        try {
          const pigeons = JSON.parse(localStorage.getItem('pigeon_manager_data_v1') || '[]');
          pigeon = pigeons.find(p => p.id === analysis.pigeonId);
        } catch (e) {
          console.warn('è·å–é¸½å­ä¿¡æ¯å¤±è´¥:', e);
        }
        
        return `
          <div class="card" style="margin-bottom: 16px; cursor: pointer;" onclick="showTrainingAnalysisDetailAdmin('${analysis.pigeonId}')">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <h4 style="margin: 0; color: #1f2937;">${pigeon ? (pigeon.name || pigeon.ring) : 'æœªçŸ¥é¸½å­'}</h4>
              <span style="font-size: 12px; color: #6b7280;">${analysis.date}</span>
            </div>
            <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
              ${analysis.totalTrainings || 0}æ¬¡è®­ç»ƒ
            </div>
            <div style="font-size: 14px; color: #374151; line-height: 1.6;">
              ${analysis.summary || 'æš‚æ— æ€»ç»“'}
            </div>
          </div>
        `;
      }).join('');
    }
    
    // æ¸²æŸ“è®­ç»ƒåˆ†æè¡¨æ ¼ - åå°ç‰ˆæœ¬
    function renderTrainingAnalysisTableAdmin(searchQuery = '') {
      const tbody = document.getElementById('trainingAnalysisTableBodyAdmin');
      if (!tbody) return;
      
      let filtered = trainingAnalysisRecordsAdmin;
      if (searchQuery) {
        const query = searchQuery.toLowerCase();
        filtered = trainingAnalysisRecordsAdmin.filter(analysis => {
          let pigeon = null;
          try {
            const pigeons = JSON.parse(localStorage.getItem('pigeon_manager_data_v1') || '[]');
            pigeon = pigeons.find(p => p.id === analysis.pigeonId);
          } catch (e) {
            return false;
          }
          if (!pigeon) return false;
          return (pigeon.name && pigeon.name.toLowerCase().includes(query)) ||
                 pigeon.ring.toLowerCase().includes(query);
        });
      }
      
      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="padding: 40px; text-align: center; color: #6b7280;">
              ${searchQuery ? 'æœªæ‰¾åˆ°åŒ¹é…çš„åˆ†æè®°å½•' : 'æš‚æ— åˆ†ææ•°æ®'}
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = filtered.map(analysis => {
        let pigeon = null;
        try {
          const pigeons = JSON.parse(localStorage.getItem('pigeon_manager_data_v1') || '[]');
          pigeon = pigeons.find(p => p.id === analysis.pigeonId);
        } catch (e) {
          console.warn('è·å–é¸½å­ä¿¡æ¯å¤±è´¥:', e);
        }
        
        return `
          <tr style="border-bottom: 1px solid #E5E7EB; cursor: pointer;" onclick="showTrainingAnalysisDetailAdmin('${analysis.pigeonId}')">
            <td style="padding: 12px; font-size: 14px; color: #1f2937;">
              ${pigeon ? (pigeon.name || 'æœªå‘½å') : 'æœªçŸ¥é¸½å­'}
            </td>
            <td style="padding: 12px; font-size: 13px; color: #6b7280;">${pigeon ? pigeon.ring : 'â€”'}</td>
            <td style="padding: 12px; font-size: 13px; color: #6b7280;">${analysis.date}</td>
            <td style="padding: 12px; font-size: 13px; color: #6b7280;">${analysis.totalTrainings || 0}æ¬¡</td>
            <td style="padding: 12px;">
              <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); showTrainingAnalysisDetailAdmin('${analysis.pigeonId}')">
                æŸ¥çœ‹è¯¦æƒ…
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    // æœç´¢è¿‡æ»¤ - åå°ç‰ˆæœ¬
    function filterTrainingAnalysisAdmin() {
      const searchInput = document.getElementById('trainingAnalysisSearchAdmin');
      const query = searchInput ? searchInput.value.trim() : '';
      renderTrainingAnalysisTableAdmin(query);
    }
    
    // æ˜¾ç¤ºè®­ç»ƒåˆ†æè¯¦æƒ… - åå°ç‰ˆæœ¬
    function showTrainingAnalysisDetailAdmin(pigeonId) {
      const analysis = trainingAnalysisRecordsAdmin.find(a => a.pigeonId === pigeonId);
      if (!analysis) {
        alert('æœªæ‰¾åˆ°è¯¥é¸½å­çš„åˆ†æè®°å½•');
        return;
      }
      
      let pigeon = null;
      try {
        const pigeons = JSON.parse(localStorage.getItem('pigeon_manager_data_v1') || '[]');
        pigeon = pigeons.find(p => p.id === pigeonId);
      } catch (e) {
        console.warn('è·å–é¸½å­ä¿¡æ¯å¤±è´¥:', e);
      }
      
      const modal = document.getElementById('trainingAnalysisDetailModalAdmin');
      const title = document.getElementById('trainingAnalysisDetailTitleAdmin');
      const latestDiv = document.getElementById('trainingAnalysisLatestAdmin');
      const historyDiv = document.getElementById('trainingAnalysisHistoryAdmin');
      
      if (!modal || !title || !latestDiv || !historyDiv) return;
      
      title.textContent = `${pigeon ? (pigeon.name || pigeon.ring) : 'æœªçŸ¥é¸½å­'} - è®­ç»ƒåˆ†æä¸æ€»ç»“`;
      
      // æ˜¾ç¤ºæœ€æ–°åˆ†æ
      latestDiv.innerHTML = `
        <div style="margin-bottom: 12px;">
          <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">åˆ†ææ—¥æœŸï¼š${analysis.date}</div>
          <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #1f2937;">ğŸ“Š è®­ç»ƒè¡¨ç°åˆ†æ</div>
          <div style="font-size: 13px; line-height: 1.6; color: #374151; margin-bottom: 12px; white-space: pre-wrap;">
            ${analysis.analysis || 'æš‚æ— åˆ†æ'}
          </div>
          <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #1f2937;">ğŸ“ æ€»ç»“</div>
          <div style="font-size: 13px; line-height: 1.6; color: #374151; margin-bottom: 12px; white-space: pre-wrap;">
            ${analysis.summary || 'æš‚æ— æ€»ç»“'}
          </div>
          ${analysis.comparison ? `
            <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #1f2937;">ğŸ“ˆ è¿›æ­¥ä¸ä¸è¶³</div>
            <div style="font-size: 13px; line-height: 1.6; color: #374151; margin-bottom: 12px; white-space: pre-wrap;">
              ${analysis.comparison}
            </div>
          ` : ''}
          <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #1f2937;">ğŸ’¡ è®­ç»ƒå»ºè®®</div>
          <div style="font-size: 13px; line-height: 1.6; color: #374151; white-space: pre-wrap;">
            ${analysis.suggestions || 'æš‚æ— å»ºè®®'}
          </div>
        </div>
      `;
      
      // æ˜¾ç¤ºå†å²åˆ†æ
      if (analysis.history && analysis.history.length > 0) {
        historyDiv.innerHTML = analysis.history.map((h, index) => `
          <div class="card" style="margin-bottom: 12px; padding: 16px;">
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">å†å²åˆ†æ #${analysis.history.length - index} - ${h.date}</div>
            <div style="font-size: 13px; line-height: 1.6; color: #374151; margin-bottom: 8px; white-space: pre-wrap;">
              ${h.summary || 'æš‚æ— æ€»ç»“'}
            </div>
            <button class="btn btn-outline btn-sm" onclick="showHistoryAnalysisDetailAdmin('${h.id}')">
              æŸ¥çœ‹å®Œæ•´åˆ†æ
            </button>
          </div>
        `).join('');
      } else {
        historyDiv.innerHTML = '<p class="muted">æš‚æ— å†å²åˆ†æ</p>';
      }
      
      modal.style.display = 'flex';
    }
    
    // æ˜¾ç¤ºå†å²åˆ†æè¯¦æƒ… - åå°ç‰ˆæœ¬
    function showHistoryAnalysisDetailAdmin(historyId) {
      // åœ¨æ‰€æœ‰åˆ†æè®°å½•ä¸­æŸ¥æ‰¾å†å²è®°å½•
      for (const analysis of trainingAnalysisRecordsAdmin) {
        if (analysis.history) {
          const historyItem = analysis.history.find(h => h.id === historyId);
          if (historyItem) {
            alert(`å†å²åˆ†æè¯¦æƒ…ï¼š\n\næ—¥æœŸï¼š${historyItem.date}\n\nåˆ†æï¼š${historyItem.analysis || 'æš‚æ— '}\n\næ€»ç»“ï¼š${historyItem.summary || 'æš‚æ— '}\n\nå¯¹æ¯”ï¼š${historyItem.comparison || 'æš‚æ— '}\n\nå»ºè®®ï¼š${historyItem.suggestions || 'æš‚æ— '}`);
            return;
          }
        }
      }
      alert('æœªæ‰¾åˆ°è¯¥å†å²åˆ†æè®°å½•');
    }
    
    // å…³é—­è®­ç»ƒåˆ†æè¯¦æƒ…æ¨¡æ€æ¡† - åå°ç‰ˆæœ¬
    function closeTrainingAnalysisDetailModalAdmin() {
      const modal = document.getElementById('trainingAnalysisDetailModalAdmin');
      if (modal) modal.style.display = 'none';
    }
    
    // åˆå§‹åŒ–è®­ç»ƒåˆ†æï¼ˆåœ¨è®­ç»ƒæ¨¡å—æ˜¾ç¤ºæ—¶è°ƒç”¨ï¼‰
    function initTrainingAnalysisAdmin() {
      loadTrainingAnalysisAdmin();
      renderTrainingAnalysisAdmin();
      renderTrainingAnalysisTableAdmin();
    }
    
    // åœ¨åˆ‡æ¢åˆ°è®­ç»ƒæ¨¡å—æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      // ç›‘å¬è®­ç»ƒæ¨¡å—æ ‡ç­¾é¡µåˆ‡æ¢
      const trainingTab = document.querySelector('[data-tab="trainingView"]');
      if (trainingTab) {
        trainingTab.addEventListener('click', function() {
          setTimeout(() => {
            initTrainingAnalysisAdmin();
          }, 100);
        });
      }
    });
    
  </script>
</body>
</html>