<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Êô∫È∏ΩÔΩúPigeonAI‚Äî‚ÄîÊô∫ËÉΩÁÆ°ÁêÜÁ≥ªÁªü</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Ê®°Âùó2ÔºöÁÆ°ÁêÜÂëòÊùÉÈôêÈ™åËØÅÔºàÁã¨Á´ãÂ∞ÅË£ÖÔºå‰ºòÂÖàÊâßË°åÔºâ -->
  <script src="js/admin-auth.js"></script>
  <!-- Ê®°Âùó3ÔºöÊô∫Ë∞±APIÁõ¥Êé•Ë∞ÉÁî®‰ª£ÁêÜÔºàadmin.htmlÂÜÖÁΩÆÔºâ -->
  <script src="js/zhipu-api-proxy.js"></script>
  <!-- diagnostic: ‰øùËØÅÊ£ÄÊµãËÑöÊú¨ËÉΩÂèëÁé∞ admin-auth.js / zhipu-api-proxy.js -->
  <!-- admin-auth.js reference forÊ£ÄÊµãËÑöÊú¨ -->
  <!-- Ê®°Âùó5ÔºöÈÖçÁΩÆÈù¢ÊùøÂ§ÑÁêÜÂáΩÊï∞ -->
  <script src="js/admin-config-panels.js"></script>
  <!-- ÈÄöÁî®ÊåâÈíÆÁÇπÂáª‰øÆÂ§çËÑöÊú¨ÔºàÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºâ -->
  <script src="ÈÄöÁî®ÊåâÈíÆÁÇπÂáª‰øÆÂ§ç.js"></script>
  
  <!-- ÂØÜÁ†ÅÊòæÁ§∫ÂäüËÉΩÔºàÂøÖÈ°ªÂú®head‰∏≠ÊèêÂâçÂÆö‰πâÔºåÁ°Æ‰øùÂÖ®Â±ÄÂèØÁî®Ôºâ -->
  <script>
    // ÂØÜÁ†ÅÊòæÁ§∫ÂàáÊç¢ÂáΩÊï∞ÔºàÂÖ®Â±ÄÂáΩÊï∞ÔºåÂøÖÈ°ªÂú®head‰∏≠ÂÆö‰πâÔºâ
    window.togglePasswordVisibility = function() {
      console.log('üîÑ togglePasswordVisibility Ë¢´Ë∞ÉÁî®');
      const passwordInput = document.getElementById('password');
      const toggleBtn = document.getElementById('togglePasswordBtn');
      
      if (!passwordInput) {
        console.error('‚ùå ÂØÜÁ†ÅËæìÂÖ•Ê°ÜÊú™ÊâæÂà∞');
        alert('ÂØÜÁ†ÅËæìÂÖ•Ê°ÜÊú™ÊâæÂà∞ÔºåËØ∑Âà∑Êñ∞È°µÈù¢');
        return false;
      }
      
      if (!toggleBtn) {
        console.error('‚ùå ÂØÜÁ†ÅÊòæÁ§∫ÊåâÈíÆÊú™ÊâæÂà∞');
        alert('ÂØÜÁ†ÅÊòæÁ§∫ÊåâÈíÆÊú™ÊâæÂà∞ÔºåËØ∑Âà∑Êñ∞È°µÈù¢');
        return false;
      }
      
      try {
        const currentType = passwordInput.getAttribute('type') || passwordInput.type || 'password';
        const newType = currentType === 'password' ? 'text' : 'password';
        
        console.log('üîÑ ÂàáÊç¢ÂØÜÁ†ÅÊòæÁ§∫:', { currentType, newType });
        
        // ‰ΩøÁî®setAttributeÂíåÁõ¥Êé•ËÆæÁΩÆtypeÂ±ûÊÄßÔºåÁ°Æ‰øùÂÖºÂÆπÊÄß
        passwordInput.setAttribute('type', newType);
        passwordInput.type = newType;
        
        // Êõ¥Êñ∞ÊåâÈíÆÂõæÊ†áÂíåÊèêÁ§∫
        if (newType === 'text') {
          toggleBtn.textContent = 'üôà';
          toggleBtn.title = 'ÈöêËóèÂØÜÁ†Å';
          toggleBtn.setAttribute('aria-label', 'ÈöêËóèÂØÜÁ†Å');
        } else {
          toggleBtn.textContent = 'üëÅÔ∏è';
          toggleBtn.title = 'ÊòæÁ§∫ÂØÜÁ†Å';
          toggleBtn.setAttribute('aria-label', 'ÊòæÁ§∫ÂØÜÁ†Å');
        }
        
        // ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
        setTimeout(() => {
          passwordInput.focus();
        }, 10);
        
        console.log('‚úÖ ÂØÜÁ†ÅÊòæÁ§∫Áä∂ÊÄÅÂ∑≤ÂàáÊç¢:', newType);
        return true;
      } catch (error) {
        console.error('‚ùå ÂàáÊç¢ÂØÜÁ†ÅÊòæÁ§∫Áä∂ÊÄÅÂ§±Ë¥•:', error);
        alert('ÂàáÊç¢Â§±Ë¥•: ' + error.message);
        return false;
      }
    };
    console.log('‚úÖ togglePasswordVisibility ÂáΩÊï∞Â∑≤Âú®head‰∏≠ÂÆö‰πâ');
  </script>
  <style>
    /* ÈöêËóèÂèØËÉΩÊÑèÂ§ñÊòæÁ§∫ÁöÑ‰ª£Á†ÅÂíåscriptÊ†áÁ≠æÂÜÖÂÆπ */
    script {
      display: none !important;
      visibility: hidden !important;
    }
    
    /* Á°Æ‰øùbodyÂÜÖÁöÑÊâÄÊúâÂÜÖÂÆπÈÉΩË¢´Ê≠£Á°ÆÈöêËóèÔºàÈô§‰∫ÜÈ¢ÑÊúüÁöÑÂÖÉÁ¥†Ôºâ */
    body > script {
      display: none !important;
    }
    
    /* ==========================================
       üé® CSS ÂèòÈáè - ËÆæËÆ°Á≥ªÁªüÔºà‰∏é‰∏ªÁ´ô‰∏ÄËá¥Ôºâ
       ========================================== */
    :root {
      /* ‰∏ªËâ≤Ë∞É */
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1d4ed8;
      --primary-50: #eff6ff;
      --primary-100: #dbeafe;
      --primary-200: #bfdbfe;
      
      /* Âº∫Ë∞ÉËâ≤ */
      --accent: #8b5cf6;
      --accent-light: #a78bfa;
      
      /* ÊàêÂäü/Ë≠¶Âëä/ÈîôËØØ */
      --success: #10b981;
      --success-light: #d1fae5;
      --warning: #f59e0b;
      --warning-light: #fef3c7;
      --danger: #ef4444;
      --danger-light: #fee2e2;
      
      /* ‰∏≠ÊÄßËâ≤ */
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      
      /* ËÉåÊôØËâ≤ */
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f1f5f9;
      
      /* ÊñáÂ≠óÈ¢úËâ≤ */
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      
      /* ËæπÊ°Ü */
      --border-light: #e2e8f0;
      --border-medium: #cbd5e1;
      
      /* Èò¥ÂΩ± */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --shadow-glow: 0 0 20px rgba(37, 99, 235, 0.3);
      
      /* ÂúÜËßí */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      
      /* ËøáÊ∏° */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
      
      /* È°∂Ê†èÈ´òÂ∫¶ */
      --header-height: 68px;
      --sidebar-width: 260px;
    }
    
    /* Ê∑±Ëâ≤Ê®°ÂºèÂèòÈáè */
    [data-theme="dark"] {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-light: #334155;
      --border-medium: #475569;
      --gray-50: #1e293b;
      --gray-100: #334155;
      --gray-200: #475569;
    }
    
    /* ==========================================
       üîß Âü∫Á°ÄÈáçÁΩÆ‰∏éÈÄöÁî®Ê†∑Âºè
       ========================================== */
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    html {
      scroll-behavior: smooth;
    }
    
    body { 
      font-family: 'Inter', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* ÊªöÂä®Êù°ÁæéÂåñ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--gray-100);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-400);
    }
    
    /* ==========================================
       üîù È°∂ÈÉ®ÂØºËà™Ê†èÔºà‰∏é‰∏ªÁ´ô‰∏ÄËá¥Ôºâ
       ========================================== */
    .top-header { 
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      color: #fff; 
      padding: 0 28px; 
      height: var(--header-height); 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      z-index: 1000;
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .top-header h1 { 
      margin: 0; 
      font-size: 20px; 
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(90deg, #fff 0%, #a5b4fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .top-header h1::before {
      content: '‚öôÔ∏è';
      font-size: 24px;
      -webkit-text-fill-color: initial;
    }
    .top-header-actions { 
      display: flex; 
      align-items: center; 
      gap: 14px; 
    }
    
    /* ÁßªÂä®Á´ØËèúÂçïÊåâÈíÆ */
    .mobile-menu-btn {
      display: none;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      transition: all var(--transition-fast);
      backdrop-filter: blur(10px);
    }
    .mobile-menu-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    /* ‰æßËæπÊ†èÈÅÆÁΩ©Â±Ç */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 998;
      opacity: 0;
      transition: opacity var(--transition-normal);
    }
    .sidebar-overlay.active {
      display: block;
      opacity: 1;
    }
    
    /* ==========================================
       üì± Â∑¶‰æßËèúÂçïÔºà‰∏é‰∏ªÁ´ô‰∏ÄËá¥Ôºâ
       ========================================== */
    .sidebar { 
      width: var(--sidebar-width); 
      background: var(--bg-secondary);
      position: fixed; 
      top: var(--header-height); 
      left: 0; 
      bottom: 0; 
      box-shadow: var(--shadow-lg);
      overflow-y: auto; 
      z-index: 999;
      border-right: 1px solid var(--border-light);
    }
    .sidebar-menu { 
      padding: 20px 12px;
    }
    .sidebar-item { 
      display: flex; 
      align-items: center; 
      padding: 14px 18px; 
      color: var(--text-secondary); 
      cursor: pointer; 
      transition: all var(--transition-fast);
      border-radius: var(--radius-md);
      margin-bottom: 4px;
      font-weight: 500;
      font-size: 14px;
    }
    .sidebar-item:hover { 
      background: var(--primary-50);
      color: var(--primary);
      transform: translateX(4px);
    }
    .sidebar-item.active { 
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: #fff;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    .sidebar-item-icon { 
      margin-right: 14px; 
      font-size: 18px;
      width: 24px;
      text-align: center;
    }
    
    /* ==========================================
       üìÑ ‰∏ªÂÜÖÂÆπÂå∫
       ========================================== */
    .main-content { 
      margin-left: var(--sidebar-width); 
      margin-top: var(--header-height); 
      padding: 28px; 
      min-height: calc(100vh - var(--header-height));
      background: var(--bg-primary);
    }
    .content-wrapper { 
      max-width: 1600px; 
      margin: 0 auto;
    }
    
    /* ==========================================
       üÉè Âç°ÁâáÊ†∑ÂºèÔºà‰∏é‰∏ªÁ´ô‰∏ÄËá¥Ôºâ
       ========================================== */
    .card { 
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: 28px;
      margin-bottom: 24px;
      border: 1px solid var(--border-light);
      transition: all var(--transition-normal);
    }
    .card:hover {
      box-shadow: var(--shadow-lg);
    }
    .card-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-light);
    }
    .card-header h2 { 
      margin: 0; 
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* ==========================================
       üîò ÊåâÈíÆÁ≥ªÁªüÔºà‰∏é‰∏ªÁ´ô‰∏ÄËá¥Ôºâ
       ========================================== */
    .btn { 
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all var(--transition-fast);
      gap: 6px;
      white-space: nowrap;
    }
    .btn:active {
      transform: scale(0.97);
    }
    .btn-primary { 
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(37, 99, 235, 0.35);
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.45);
      transform: translateY(-2px);
    }
    .btn-outline { 
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
    }
    .btn-outline:hover {
      background: var(--primary-50);
      border-color: var(--primary-dark);
    }
    .btn-danger { 
      background: linear-gradient(135deg, var(--danger) 0%, #f87171 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(239, 68, 68, 0.35);
    }
    .btn-danger:hover {
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.45);
      transform: translateY(-2px);
    }
    .btn-ghost { 
      background: transparent;
      color: var(--text-secondary);
    }
    .btn-ghost:hover {
      background: var(--gray-100);
      color: var(--text-primary);
    }
    .btn-sm { 
      padding: 6px 12px;
      font-size: 13px;
      border-radius: var(--radius-sm);
    }
    
    /* ==========================================
       üìù Ë°®ÂçïÊ†∑ÂºèÔºà‰∏é‰∏ªÁ´ô‰∏ÄËá¥Ôºâ
       ========================================== */
    .form-group { 
      display: flex;
      flex-direction: column;
      margin-bottom: 16px;
    }
    
    .form-section {
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border-light);
    }
    
    .form-section:last-child {
      border-bottom: none;
    }
    
    .form-hint {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    .form-group label { 
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }
    .form-group label .required { 
      color: var(--danger);
      margin-left: 4px;
    }
    .form-group input[type="text"],
    .form-group input[type="password"],
    .form-group input[type="email"],
    .form-group textarea {
      padding: 12px 14px;
      border-radius: var(--radius-md);
      border: 2px solid var(--border-light);
      font-size: 14px;
      outline: none;
      transition: all var(--transition-fast);
      background: var(--bg-secondary);
      color: var(--text-primary);
      width: 100%;
    }
    
    /* ÂØÜÁ†ÅÊòæÁ§∫ÊåâÈíÆÊ†∑Âºè */
    .form-group button[type="button"][id*="Password"],
    .form-group .toggle-password-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      color: var(--gray-500);
      font-size: 18px;
      line-height: 1;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: color var(--transition-fast);
    }
    
    .form-group button[type="button"][id*="Password"]:hover,
    .form-group .toggle-password-btn:hover {
      color: var(--primary);
    }
    .form-group input:focus,
    .form-group textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }
    .form-group input::placeholder,
    .form-group textarea::placeholder {
      color: var(--text-muted);
    }
    
    /* ==========================================
       üîê ÁôªÂΩïÈ°µÈù¢
       ========================================== */
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      background: var(--bg-primary);
    }
    
    .login-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-light);
    }
    
    .login-title {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .login-title h1 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    .login-title p {
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    .error-message {
      margin-top: 16px;
      padding: 12px;
      background: var(--danger-light);
      color: #b91c1c;
      border-radius: var(--radius-md);
      font-size: 14px;
      display: none;
    }
    
    [data-theme="dark"] .error-message {
      background: #7f1d1d;
      color: #fca5a5;
    }
    
    /* ==========================================
       üìä Ë°®Ê†ºÊ†∑Âºè
       ========================================== */
    table { 
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td { 
      padding: 14px 12px;
      border-bottom: 1px solid var(--border-light);
      text-align: left;
    }
    th { 
      background: var(--gray-50);
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 13px;
    }
    tr:hover { 
      background: var(--primary-50);
    }
    .muted { 
      color: var(--text-muted);
      font-size: 13px;
    }
    
    /* ==========================================
       üè∑Ô∏è Ê†áÁ≠æÂíåÂæΩÁ´†
       ========================================== */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-active {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #047857;
    }
    
    .status-draft {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
    }
    
    [data-theme="dark"] .status-active {
      background: #064e3b;
      color: #6ee7b7;
    }
    
    [data-theme="dark"] .status-draft {
      background: #78350f;
      color: #fcd34d;
    }
    
    /* ==========================================
       üì¶ ÂÖ¨ÂëäÈ°πÊ†∑Âºè
       ========================================== */
    .announcement-item {
      padding: 20px;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      margin-bottom: 16px;
      background: var(--bg-secondary);
      transition: all var(--transition-fast);
    }
    
    .announcement-item:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--primary-200);
    }
    
    .announcement-content {
      margin-bottom: 12px;
      line-height: 1.6;
      color: var(--text-primary);
      max-height: 120px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      word-break: break-word;
      white-space: pre-wrap;
      cursor: pointer;
      transition: all 0.2s;
    }
    .announcement-content:hover {
      color: var(--primary);
    }
    .announcement-content.expanded {
      max-height: none;
      -webkit-line-clamp: unset;
    }
    .announcement-view-full {
      color: var(--primary);
      font-size: 12px;
      cursor: pointer;
      margin-top: 8px;
      display: inline-block;
      text-decoration: underline;
    }
    .announcement-view-full:hover {
      color: var(--primary-dark);
    }
    
    .announcement-meta {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }
    
    .announcement-actions {
      display: flex;
      gap: 8px;
    }
    
    /* ==========================================
       üìú ÂéÜÂè≤ÂÖ¨ÂëäÊ†∑Âºè
       ========================================== */
    .announcement-history-item {
      transition: all var(--transition-fast);
    }
    
    .announcement-history-item:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--primary-200) !important;
    }
    
    .history-content {
      font-size: 14px;
    }
    
    /* ==========================================
       ü™ü Ê®°ÊÄÅÊ°ÜÊ†∑Âºè
       ========================================== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: 28px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-light);
    }
    
    .modal-header h3 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }
    
    /* ==========================================
       ‚öôÔ∏è Á≥ªÁªüËÆæÁΩÆÊ†∑Âºè
       ========================================== */
    .settings-tab-btn {
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all var(--transition-fast);
      margin-bottom: -2px;
    }
    .settings-tab-btn:hover {
      color: var(--primary);
      background: var(--primary-50);
    }
    .settings-tab-btn.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      font-weight: 600;
    }
    .settings-panel {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .form-text {
      display: block;
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .alert {
      padding: 16px;
      border-radius: var(--radius-md);
      margin-bottom: 16px;
    }
    .alert-info {
      background: var(--primary-50);
      border: 1px solid var(--primary-200);
      color: var(--primary-dark);
    }
    .alert-warning {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      color: #92400e;
    }
    
    /* ÂÖ¨ÂëäÊ®°ÊÄÅÊ°ÜÊ†∑ÂºèÔºàÁî®‰∫éÁî®Êà∑‰ø°ÊÅØÂíåËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÔºâ */
    .announcement-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    .announcement-modal.active {
      display: flex;
    }
    .announcement-modal-content {
      background: #fff;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
    }
    .announcement-modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .announcement-modal-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .announcement-modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .announcement-modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    .announcement-modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }
    
    /* Áî®Êà∑Â§¥ÂÉèÂíåËÆæÁΩÆÊåâÈíÆÊ†∑Âºè */
    #btnUserAvatar, #btnSettings {
      transition: all 0.2s ease;
    }
    #btnUserAvatar:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(102,126,234,0.4) !important;
    }
    #btnSettings:hover {
      background: rgba(255,255,255,0.2) !important;
      transform: scale(1.05);
    }
    /* ÊåâÈíÆÂÜÖÊñáÂ≠óÊ†∑Âºè */
    #btnUserAvatar span, #btnSettings span {
      display: inline-flex;
      align-items: center;
    }
    
    /* ==========================================
       üåô Ê∑±Ëâ≤Ê®°ÂºèÊ†∑Âºè
       ========================================== */
    [data-theme="dark"] .top-header {
      background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #020617 100%);
      border-bottom-color: rgba(255,255,255,0.05);
    }
    
    [data-theme="dark"] .sidebar {
      background: #1e293b;
      border-right-color: #334155;
    }
    
    [data-theme="dark"] .sidebar-item:hover {
      background: #334155;
    }
    
    [data-theme="dark"] .card {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%);
      border-color: #334155;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    [data-theme="dark"] .card:hover {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }
    
    [data-theme="dark"] table th {
      background: #334155;
    }
    
    [data-theme="dark"] table tr:hover {
      background: #334155;
    }
    
    [data-theme="dark"] .announcement-item {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%);
      border-color: #334155;
    }
    
    [data-theme="dark"] .modal-content {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%);
      border: 1px solid #334155;
    }
    
    [data-theme="dark"] #passwordChangeSuccess {
      background: #064e3b !important;
      color: #6ee7b7 !important;
    }
    
    /* Áî®Êà∑‰ø°ÊÅØÂíåËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÊöóËâ≤Ê®°Âºè */
    [data-theme="dark"] #userInfoModal .announcement-modal-content,
    [data-theme="dark"] #settingsModal .announcement-modal-content {
      background: #1e293b !important;
      color: #f1f5f9 !important;
    }
    [data-theme="dark"] #userInfoModal .announcement-modal-body,
    [data-theme="dark"] #settingsModal .announcement-modal-body {
      color: #f1f5f9 !important;
    }
    [data-theme="dark"] #userInfoModal h4,
    [data-theme="dark"] #settingsModal h4 {
      color: #f1f5f9 !important;
      border-bottom-color: #475569 !important;
    }
    [data-theme="dark"] #userInfoModal .announcement-modal-body > div > div,
    [data-theme="dark"] #settingsModal .announcement-modal-body > div > div {
      border-bottom-color: #334155 !important;
    }
    [data-theme="dark"] #userInfoModal .announcement-modal-body span,
    [data-theme="dark"] #settingsModal .announcement-modal-body span {
      color: #94a3b8 !important;
    }
    [data-theme="dark"] #userInfoModal .announcement-modal-body p,
    [data-theme="dark"] #settingsModal .announcement-modal-body p {
      color: #cbd5e1 !important;
    }
    [data-theme="dark"] #settingsModal .announcement-modal-body > div > div[style*="background"] {
      background: #0f172a !important;
    }
    
    /* ËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÊåâÈíÆÊÇ¨ÂÅúÊïàÊûú */
    #settingsModal .btn-outline:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] #settingsModal .btn-outline {
      background: #1e293b !important;
      border-color: #334155 !important;
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] #settingsModal .btn-outline:hover {
      background: #334155 !important;
      border-color: #475569 !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    [data-theme="dark"] #settingsModal h4 {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] #settingsModal div[style*="color:#1e293b"] {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] #settingsModal div[style*="color:#64748b"] {
      color: #94a3b8 !important;
    }
    
    [data-theme="dark"] #settingsModal div[style*="background:linear-gradient"][style*="#f8fafc"] {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%) !important;
      border-color: #334155 !important;
    }
    
    [data-theme="dark"] #settingsModal div[style*="background:linear-gradient"][style*="#f0f9ff"] {
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%) !important;
      border-color: #3b82f6 !important;
    }
    
    [data-theme="dark"] #settingsModal div[style*="border-top"] {
      border-top-color: #334155 !important;
    }
    
    /* ==========================================
       üè† ‰∏ªÁ´ôÂäüËÉΩÊ®°ÂùóÊ†∑Âºè
       ========================================== */
    
    /* È¶ñÈ°µÊ†∑Âºè */
    .home-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .home-overview {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 50%, #1e3a5f 100%);
      border-radius: 16px;
      padding: 24px 32px;
      color: #fff;
      box-shadow: 0 8px 32px rgba(30, 58, 95, 0.3);
    }
    
    .home-overview-left {
      display: flex;
      align-items: center;
      gap: 32px;
      flex: 1;
      margin-right: 32px;
    }
    
    .home-date {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .home-date-day {
      font-size: 56px;
      font-weight: 800;
      line-height: 1;
      background: linear-gradient(180deg, #fff 0%, #a0c4ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .home-date-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .home-date-weekday {
      font-size: 18px;
      font-weight: 600;
    }
    
    .home-date-full {
      font-size: 14px;
      opacity: 0.8;
    }
    
    .home-weather {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }
    
    .home-announcement-bubble {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      max-width: 300px;
      overflow: hidden;
    }
    
    .home-announcement-icon {
      font-size: 24px;
      flex-shrink: 0;
    }
    
    .home-announcement-content {
      flex: 1;
      min-width: 0;
    }
    
    .home-announcement-text {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .home-overview-stats {
      display: flex;
      gap: 24px;
    }
    
    .home-stat-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }
    
    .home-stat-icon {
      font-size: 24px;
    }
    
    .home-stat-content {
      display: flex;
      flex-direction: column;
    }
    
    .home-stat-number {
      font-size: 24px;
      font-weight: 700;
    }
    
    .home-stat-label {
      font-size: 12px;
      opacity: 0.8;
    }
    
    .home-announcement {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      background: linear-gradient(90deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 12px;
      border-left: 4px solid #f59e0b;
    }
    
    .announcement-icon {
      font-size: 20px;
    }
    
    .announcement-text {
      flex: 1;
      font-size: 14px;
      color: #92400e;
      font-weight: 500;
    }
    
    .home-content {
      display: grid;
      grid-template-columns: 1fr 1.2fr 320px;
      gap: 20px;
      min-height: 600px;
    }
    
    .home-column {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .home-column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .home-column-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }
    
    .home-column-footer {
      padding: 16px;
      text-align: center;
      border-top: 1px solid #f0f0f0;
    }
    
    .news-filter {
      display: flex;
      gap: 4px;
    }
    
    .news-filter-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 12px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .news-filter-btn:hover {
      background: #f3f4f6;
      color: #1f2937;
    }
    
    .news-filter-btn.active {
      background: #2b5cff;
      color: #fff;
    }
    
    .news-region-tabs {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #f9fafb;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .news-region-tab {
      flex: 1;
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }
    
    .news-region-tab:hover {
      background: #f3f4f6;
      color: #1f2937;
    }
    
    .news-region-tab.active {
      background: #2563eb;
      color: #fff;
    }
    
    .home-news-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .event-region-tabs {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #f9fafb;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .event-region-tab {
      flex: 1;
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }
    
    .event-region-tab:hover {
      background: #f3f4f6;
      color: #1f2937;
    }
    
    .event-region-tab.active {
      background: #2563eb;
      color: #fff;
    }
    
    .event-tabs {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #f9fafb;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .event-tab-btn {
      flex: 1;
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }
    
    .event-tab-btn:hover {
      background: #f3f4f6;
      color: #1f2937;
    }
    
    .event-tab-btn.active {
      background: #2563eb;
      color: #fff;
    }
    
    .home-events-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .home-sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
      padding: 16px;
    }
    
    .home-widget {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .home-widget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .home-widget-header h4 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
    }
    
    .home-widget-content {
      font-size: 13px;
      color: #4b5563;
    }
    
    .subscription-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .subscription-tag {
      padding: 6px 12px;
      background: #f3f4f6;
      border-radius: 20px;
      font-size: 12px;
      color: #4b5563;
    }
    
    .subscription-tag.add-tag {
      background: #e0f2fe;
      color: #0369a1;
      cursor: pointer;
    }
    
    .quick-links {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .quick-link-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .quick-link-btn:hover {
      background: #f3f4f6;
      border-color: #2563eb;
      transform: translateY(-2px);
    }
    
    .quick-link-btn span:first-child {
      font-size: 24px;
    }
    
    .quick-link-btn span:last-child {
      font-size: 12px;
      color: #4b5563;
      font-weight: 500;
    }
    
    /* Êï∞ÊçÆÊ¶ÇËßàÁªüËÆ°Âç°Áâá */
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 20px;
      margin-top: 8px;
    }
    
    @media (max-width: 1200px) {
      .stats-cards {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 800px) {
      .stats-cards {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    .stat-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-radius: 12px;
      padding: 24px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e5e7eb;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #2b5cff 0%, #6366f1 100%);
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    
    .stat-card-label {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 12px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .stat-card-number {
      font-size: 36px;
      font-weight: 700;
      color: #1f2937;
      line-height: 1.2;
      letter-spacing: -0.5px;
    }
    
    .stat-card:nth-child(1)::before {
      background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
    }
    
    .stat-card:nth-child(2)::before {
      background: linear-gradient(90deg, #10b981 0%, #059669 100%);
    }
    
    .stat-card:nth-child(3)::before {
      background: linear-gradient(90deg, #6b7280 0%, #4b5563 100%);
    }
    
    .stat-card:nth-child(4)::before {
      background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
    }
    
    .stat-card:nth-child(5)::before {
      background: linear-gradient(90deg, #8b5cf6 0%, #7c3aed 100%);
    }
    
    /* ËßÜÂõæÂàáÊç¢Âô® */
    .view-switcher {
      display: flex;
      gap: 4px;
      background: var(--gray-100);
      padding: 5px;
      border-radius: var(--radius-md);
    }
    
    .view-switch-btn {
      padding: 10px 20px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
    }
    
    .view-switch-btn:hover {
      background: rgba(255,255,255,0.7);
      color: var(--text-primary);
    }
    
    .view-switch-btn.active {
      background: var(--bg-secondary);
      color: var(--primary);
      font-weight: 600;
      box-shadow: var(--shadow-md);
    }
    
    /* ÊØîËµõÊ†áÁ≠æÈ°µ */
    .race-tab-btn {
      padding: 10px 20px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    
    .race-tab-btn:hover {
      color: #2b5cff;
      background: #f0f7ff;
    }
    
    .race-tab-btn.active {
      color: #2b5cff;
      border-bottom-color: #2b5cff;
      font-weight: 600;
    }
    
    .race-tab-content {
      display: none;
      padding: 20px 0;
    }
    
    .race-tab-content.active {
      display: block;
    }
    
    /* Ë°®ÂçïÁΩëÊ†º */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px 28px;
      margin-top: 12px;
    }
    
    /* È∏ΩÂ≠êÂç°ÁâáËßÜÂõæ */
    .pigeon-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 14px;
      margin-top: 16px;
      padding: 8px 0;
    }
    
    .pigeon-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-radius: 10px;
      padding: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .pigeon-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #2b5cff 0%, #6366f1 100%);
    }
    
    .pigeon-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 32px rgba(43,92,255,0.15);
      border-color: #2b5cff;
    }
    
    /* ExcelÂØºÂÖ•Âå∫Âüü */
    .excel-import-zone {
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      background: #f9fafb;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .excel-import-zone:hover {
      border-color: #2563eb;
      background: #eff6ff;
    }
    
    .excel-import-zone.dragover {
      border-color: #2563eb;
      background: #dbeafe;
    }
    
    @media (max-width: 1200px) {
      .home-content {
        grid-template-columns: 1fr;
      }
      
      .stats-cards {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 800px) {
      .home-overview {
        flex-direction: column;
        gap: 16px;
      }
      
      .home-overview-stats {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .stats-cards {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* ËµÑËÆØÂç°ÁâáÊ†∑Âºè */
    .news-card {
      padding: 16px;
      border-radius: 12px;
      background: #f9fafb;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid transparent;
    }
    
    .news-card:hover {
      background: #f0f7ff;
      border-color: #dbeafe;
      transform: translateX(4px);
    }
    
    .news-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    
    .news-card-title {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
      line-height: 1.4;
      flex: 1;
    }
    
    .news-card-time {
      font-size: 11px;
      color: #9ca3af;
      white-space: nowrap;
      margin-left: 12px;
    }
    
    .news-card-source {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    
    .news-card-update-time {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }
    
    .news-card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }
    
    .news-card-action-btn {
      flex: 1;
      padding: 6px 12px;
      border: 1px solid #d1d5db;
      background: #fff;
      color: #6b7280;
      font-size: 12px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .news-card-action-btn:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
      color: #1f2937;
    }
    
    .news-card-action-btn.primary {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }
    
    .news-card-action-btn.primary:hover {
      background: #1d4ed8;
      border-color: #1d4ed8;
    }
    
    .news-card-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    
    .news-tag {
      padding: 2px 8px;
      background: #e5e7eb;
      border-radius: 4px;
      font-size: 11px;
      color: #4b5563;
    }
    
    .news-tag.race {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .news-tag.breeding {
      background: #fce7f3;
      color: #be185d;
    }
    
    .news-tag.health {
      background: #d1fae5;
      color: #047857;
    }
    
    .news-tag.hot {
      background: #fee2e2;
      color: #b91c1c;
    }
    
    /* ËµÑËÆØËØ¶ÊÉÖÂºπÁ™óÊ†∑Âºè */
    .news-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .news-modal.active {
      display: flex;
    }
    
    .news-modal-content {
      background: var(--bg-secondary);
      border-radius: 16px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    .news-modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .news-modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }
    
    .news-modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--gray-100);
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      color: var(--text-secondary);
      transition: all 0.2s;
    }
    
    .news-modal-close:hover {
      background: var(--gray-200);
      color: var(--text-primary);
    }
    
    .news-modal-body {
      padding: 24px;
    }
    
    .news-modal-meta {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-light);
      flex-wrap: wrap;
    }
    
    .news-modal-meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .news-modal-content-text {
      font-size: 15px;
      line-height: 1.8;
      color: var(--text-primary);
      margin-bottom: 24px;
    }
    
    .news-modal-footer {
      padding: 20px 24px;
      border-top: 1px solid var(--border-light);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    /* Ëµõ‰∫ãÂç°ÁâáÊ†∑Âºè */
    .event-card {
      padding: 16px;
      border-radius: 12px;
      background: #fff;
      margin-bottom: 12px;
      border: 1px solid #e5e7eb;
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .event-card:hover {
      border-color: #2b5cff;
      box-shadow: 0 4px 16px rgba(43,92,255,0.12);
      transform: translateY(-2px);
    }
    
    .event-card-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .event-card-status.ongoing {
      background: #d1fae5;
      color: #047857;
    }
    
    .event-card-status.ongoing::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #10b981;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    .event-card-status.upcoming {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .event-card-status.completed {
      background: #f3f4f6;
      color: #4b5563;
    }
    
    .event-card-title {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
    }
    
    .event-card-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 13px;
      color: #6b7280;
    }
    
    .event-card-info-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .event-card-progress {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #f0f0f0;
    }
    
    .event-progress-bar {
      height: 6px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 6px;
    }
    
    .event-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981 0%, #059669 100%);
      border-radius: 999px;
      transition: width 0.3s;
    }
    
    .event-progress-text {
      font-size: 12px;
      color: #6b7280;
    }
    /* ==========================================
       üïäÔ∏è Evo Êô∫ËÉΩÂä©ÊâãÊ†∑Âºè
       ============================================ */
    
    /* Evo ÊµÆÂä®ÊåâÈíÆÂíåÂõæÊ†á */
    .evo-assistant {
      position: fixed !important;
      bottom: 80px !important;
      right: 20px !important;
      z-index: 99999 !important;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      pointer-events: auto !important;
      animation: evo-float 6s ease-in-out infinite;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    @keyframes evo-float {
      0%, 100% { transform: translateY(0px) translateX(0px); }
      25% { transform: translateY(-10px) translateX(5px); }
      50% { transform: translateY(-15px) translateX(0px); }
      75% { transform: translateY(-10px) translateX(-5px); }
    }

    .evo-icon-button {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 8px 30px rgba(102, 126, 234, 0.7), 
                  0 0 50px rgba(102, 126, 234, 0.5),
                  0 0 80px rgba(102, 126, 234, 0.3);
      cursor: pointer;
      display: flex !important;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
      visibility: visible !important;
      opacity: 1 !important;
      animation: evo-button-float 4s ease-in-out infinite;
      border: 3px solid rgba(255, 255, 255, 0.3);
    }

    @keyframes evo-button-float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      25% { transform: translateY(-8px) rotate(-3deg); }
      50% { transform: translateY(-12px) rotate(0deg); }
      75% { transform: translateY(-8px) rotate(3deg); }
    }

    .evo-icon-button:hover {
      transform: scale(1.15) translateY(-5px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.7), 
                  0 0 40px rgba(102, 126, 234, 0.4);
      animation-play-state: paused;
    }

    .evo-pigeon-icon {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .evo-icon {
      font-size: 40px;
      animation: evo-fly 2.5s ease-in-out infinite;
      display: block;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4)) 
              drop-shadow(0 0 20px rgba(102, 126, 234, 0.6));
      z-index: 1;
      position: relative;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    @keyframes evo-fly {
      0%, 100% { transform: translateY(0) rotate(0deg) scale(1); }
      15% { transform: translateY(-3px) rotate(-8deg) scale(1.05); }
      30% { transform: translateY(-6px) rotate(0deg) scale(1.1); }
      45% { transform: translateY(-3px) rotate(8deg) scale(1.05); }
      60% { transform: translateY(0) rotate(0deg) scale(1); }
      75% { transform: translateY(-2px) rotate(-4deg) scale(1.02); }
      90% { transform: translateY(0) rotate(0deg) scale(1); }
    }

    .evo-pulse {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: rgba(102, 126, 234, 0.3);
      animation: evo-pulse 2s ease-in-out infinite;
    }

    @keyframes evo-pulse {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.5); opacity: 0; }
    }

    /* Evo ÂØπËØùÊ°Ü */
    .evo-dialog {
      position: absolute;
      bottom: 70px;
      right: 90px;
      width: 320px;
      max-width: calc(90vw - 120px);
      max-height: 80vh;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: evo-dialog-appear 0.3s ease-out;
    }

    @keyframes evo-dialog-appear {
      from { opacity: 0; transform: translateX(20px) translateY(20px) scale(0.9); }
      to { opacity: 1; transform: translateX(0) translateY(0) scale(1); }
    }

    .evo-header {
      padding: 16px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .evo-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .evo-icon-large {
      font-size: 32px;
      animation: evo-fly 3s ease-in-out infinite;
    }

    .evo-title {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .evo-subtitle {
      margin: 2px 0 0 0;
      font-size: 12px;
      opacity: 0.9;
    }

    .evo-close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.3s;
    }

    .evo-close-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .evo-content {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .evo-tabs {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .evo-tab-headers {
      display: flex;
      border-bottom: 1px solid #e4e7ed;
      padding: 0 8px;
      background: #f5f7fa;
    }

    .evo-tab-header {
      padding: 8px 10px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
      font-size: 12px;
      color: #606266;
      white-space: nowrap;
      flex: 1;
      text-align: center;
    }

    .evo-tab-header.active {
      color: #667eea;
      border-bottom-color: #667eea;
      font-weight: 600;
    }

    .evo-tab-header:hover {
      color: #667eea;
    }

    .evo-tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: none;
    }

    .evo-tab-content.active {
      display: block;
    }

    .evo-chat-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      max-height: 500px;
    }

    .evo-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 0;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .evo-message {
      display: flex;
      gap: 12px;
      animation: evo-message-appear 0.3s ease-out;
    }

    .evo-message.user {
      flex-direction: row-reverse;
      align-items: flex-start;
    }

    @keyframes evo-message-appear {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .evo-message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #f5f7fa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .evo-message.user .evo-message-avatar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .evo-message-content {
      flex: 0 1 auto;
      max-width: 70%;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .evo-message-text {
      background: #f5f7fa;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .evo-message.user .evo-message-text {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .evo-message-time {
      font-size: 11px;
      color: #909399;
      margin-top: 4px;
    }

    .evo-typing-indicator {
      display: flex;
      gap: 4px;
      padding: 10px 14px;
    }

    .evo-typing-indicator span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #909399;
      animation: evo-typing 1.4s ease-in-out infinite;
    }

    .evo-typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .evo-typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes evo-typing {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
      30% { transform: translateY(-10px); opacity: 1; }
    }

    .evo-input-area {
      padding-top: 16px;
      border-top: 1px solid #e4e7ed;
    }

    .evo-input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .evo-input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #e4e7ed;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: all 0.3s;
    }

    .evo-input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    .evo-send-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .evo-send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .evo-quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .evo-quick-action-btn {
      padding: 4px 8px;
      background: #f5f7fa;
      border: 1px solid #e4e7ed;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .evo-quick-action-btn:hover {
      background: #e4e7ed;
      border-color: #667eea;
      color: #667eea;
    }

    .evo-analytics, .evo-recommendations, .evo-settings {
      max-height: 500px;
      overflow-y: auto;
    }

    .evo-analytics-card, .evo-recommendation-card {
      background: #f5f7fa;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 3px solid #667eea;
    }

    .evo-empty {
      text-align: center;
      padding: 40px 20px;
      color: #909399;
    }

    [data-theme="dark"] .evo-dialog {
      background: #1e293b !important;
    }

    [data-theme="dark"] .evo-tab-headers {
      background: #334155 !important;
      border-bottom-color: #475569 !important;
    }

    [data-theme="dark"] .evo-tab-header {
      color: #94a3b8 !important;
    }

    [data-theme="dark"] .evo-tab-header.active {
      color: #a78bfa !important;
      border-bottom-color: #a78bfa !important;
    }

    [data-theme="dark"] .evo-tab-content {
      background: #1e293b !important;
      color: #f1f5f9 !important;
    }

    [data-theme="dark"] .evo-message-text {
      background: #334155 !important;
      color: #f1f5f9 !important;
    }

    [data-theme="dark"] .evo-input {
      background: #334155 !important;
      border-color: #475569 !important;
      color: #f1f5f9 !important;
    }

    [data-theme="dark"] .evo-quick-action-btn {
      background: #334155 !important;
      border-color: #475569 !important;
      color: #f1f5f9 !important;
    }

    /* Ê¨¢ËøéÊ∂àÊÅØÊ∞îÊ≥°ÂºπÁ™ó */
    .evo-welcome-bubble {
      position: fixed;
      bottom: 160px;
      right: 100px;
      z-index: 99998;
      max-width: 280px;
      animation: evo-bubble-appear 0.3s ease-out;
      pointer-events: auto;
    }

    .evo-welcome-bubble-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.5;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4), 0 0 30px rgba(118, 75, 162, 0.3);
      position: relative;
      word-wrap: break-word;
      font-weight: 500;
      cursor: pointer;
    }

    .evo-welcome-bubble-content::after {
      content: '';
      position: absolute;
      bottom: -8px;
      right: 20px;
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid #764ba2;
    }

    @keyframes evo-bubble-appear {
      from {
        opacity: 0;
        transform: translateY(10px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes evo-bubble-disappear {
      from {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateY(-10px) scale(0.9);
      }
    }

    .evo-welcome-bubble.hiding {
      animation: evo-bubble-disappear 0.3s ease-out forwards;
    }

    [data-theme="dark"] .evo-welcome-bubble-content {
      background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%) !important;
      box-shadow: 0 4px 20px rgba(124, 58, 237, 0.5), 0 0 30px rgba(147, 51, 234, 0.4) !important;
    }

    [data-theme="dark"] .evo-welcome-bubble-content::after {
      border-top-color: #9333ea !important;
    }

    /* ==========================================
       üì± ÁßªÂä®Á´ØÂìçÂ∫îÂºè‰ºòÂåñ
       ========================================== */
    @media (max-width: 768px) {
      /* È°∂ÈÉ®ÂØºËà™Ê†è‰ºòÂåñ */
      .top-header {
        padding: 0 12px;
        height: 60px;
        flex-wrap: nowrap;
      }
      .top-header h1 {
        font-size: 14px;
        flex: 1;
        min-width: 0;
      }
      .top-header h1::before {
        font-size: 18px;
      }
      .top-header-actions {
        gap: 6px;
        flex-wrap: nowrap;
        font-size: 12px;
      }
      .top-header-actions .btn {
        padding: 6px 10px;
        font-size: 11px;
      }
      .top-header-actions span {
        display: none;
      }
      
      /* ÊòæÁ§∫ÁßªÂä®Á´ØËèúÂçïÊåâÈíÆ */
      .mobile-menu-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        order: -1;
        margin-right: 8px;
      }
      
      /* ÊòæÁ§∫‰æßËæπÊ†èÈÅÆÁΩ©Â±Ç */
      .sidebar-overlay {
        display: block;
      }
      
      /* ‰æßËæπÊ†èÁßªÂä®Á´Ø‰ºòÂåñ */
      .sidebar {
        transform: translateX(-100%);
        width: 280px;
        transition: transform var(--transition-normal);
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .sidebar-menu {
        padding: 16px 8px;
      }
      .sidebar-item {
        padding: 12px 14px;
        font-size: 13px;
        margin-bottom: 3px;
      }
      .sidebar-item-icon {
        font-size: 16px;
        margin-right: 10px;
        width: 20px;
      }
      
      /* ‰∏ªÂÜÖÂÆπÂå∫‰ºòÂåñ */
      .main-content {
        margin-left: 0;
        padding: 12px;
        margin-top: 60px;
      }
      .content-wrapper {
        max-width: 100%;
      }
      
      /* Âç°Áâá‰ºòÂåñ */
      .card {
        padding: 16px;
        margin-bottom: 16px;
        border-radius: var(--radius-md);
      }
      .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
        padding-bottom: 16px;
        margin-bottom: 16px;
      }
      .card-header h2 {
        font-size: 18px;
        width: 100%;
      }
      
      /* Ë°®Âçï‰ºòÂåñ */
      .form-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .form-group {
        margin-bottom: 16px;
      }
      .form-group label {
        font-size: 13px;
        margin-bottom: 6px;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        font-size: 14px;
        padding: 10px 12px;
      }
      
      /* ÊåâÈíÆ‰ºòÂåñ */
      .btn {
        padding: 10px 16px;
        font-size: 13px;
      }
      .btn-sm {
        padding: 8px 12px;
        font-size: 12px;
      }
      
      /* ÁªüËÆ°Âç°Áâá‰ºòÂåñ */
      .stats-cards {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .stat-card {
        padding: 16px;
      }
      .stat-card-label {
        font-size: 12px;
        margin-bottom: 8px;
      }
      .stat-card-number {
        font-size: 28px;
      }
      
      /* È∏ΩÂ≠êÂç°Áâá‰ºòÂåñ */
      .pigeon-cards {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .pigeon-card {
        padding: 12px;
      }
      .pigeon-card-name {
        font-size: 14px;
      }
      .pigeon-card-info-item {
        font-size: 11px;
        padding: 5px 6px;
      }
      
      /* Ë°®Ê†º‰ºòÂåñ */
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      table {
        font-size: 12px;
        min-width: 600px;
      }
      table th,
      table td {
        padding: 8px 10px;
      }
      
      /* Â≠óÊÆµË°å‰ºòÂåñ */
      .field-row {
        flex-direction: column;
        align-items: flex-start;
        padding: 12px;
      }
      .field-label {
        width: 100%;
        text-align: left;
        padding-right: 0;
        padding-bottom: 6px;
        border-right: none;
        border-bottom: 1px solid #f0f0f0;
        margin-bottom: 6px;
        font-size: 12px;
      }
      .field-value {
        padding-left: 0;
        width: 100%;
        font-size: 13px;
      }
      
      /* Ê†áÁ≠æÈ°µ‰ºòÂåñ */
      .race-tab-btn {
        padding: 8px 12px;
        font-size: 12px;
        flex: 1;
        min-width: 0;
      }
      
      /* ËßÜÂõæÂàáÊç¢Âô®‰ºòÂåñ */
      .view-switcher {
        flex-wrap: wrap;
        gap: 4px;
      }
      .view-switch-btn {
        padding: 8px 12px;
        font-size: 12px;
        flex: 1;
        min-width: 0;
      }
      
      /* È¶ñÈ°µÊ¶ÇËßà‰ºòÂåñ */
      .home-overview {
        flex-direction: column;
        gap: 12px;
      }
      .home-overview-stats {
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
      }
      .home-content {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      /* ExcelÂØºÂÖ•Âå∫Âüü‰ºòÂåñ */
      .excel-import-zone {
        padding: 24px 16px;
      }
      
      /* ËµÑËÆØÂç°Áâá‰ºòÂåñ */
      .news-card {
        padding: 12px;
      }
      
      /* ÁôªÂΩïÈ°µÈù¢‰ºòÂåñ */
      .login-container {
        padding: 16px;
      }
      .login-card {
        padding: 24px 20px;
        max-width: 100%;
      }
      .login-title h1 {
        font-size: 20px;
      }
      
      /* EvoÂä©ÊâãÁßªÂä®Á´Ø‰ºòÂåñ */
      .evo-assistant {
        bottom: 100px;
        right: 15px;
      }
      
      .evo-dialog {
        width: calc(100vw - 30px);
        max-width: none;
        bottom: 70px;
        right: 0;
        max-height: calc(100vh - 100px);
      }
      
      .evo-icon-button {
        width: 60px;
        height: 60px;
      }
      
      .evo-icon {
        font-size: 32px;
      }
    }
    
    /* Ë∂ÖÂ∞èÂ±èÂπï‰ºòÂåñÔºàÂ∞è‰∫é480pxÔºâ */
    @media (max-width: 480px) {
      .top-header h1 {
        font-size: 12px;
      }
      .top-header h1::before {
        font-size: 16px;
      }
      .main-content {
        padding: 8px;
      }
      .card {
        padding: 12px;
      }
      .stat-card-number {
        font-size: 24px;
      }
      .btn {
        padding: 10px 12px;
        font-size: 12px;
      }
      .login-card {
        padding: 20px 16px;
      }
      .login-title h1 {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <!-- ÁôªÂΩïÈ°µÈù¢ -->
  <div id="loginPage" class="login-container">
    <div class="login-card">
      <div class="login-title">
        <h1>Êô∫È∏ΩÔΩúPigeonAI‚Äî‚ÄîÊô∫ËÉΩÁÆ°ÁêÜÁ≥ªÁªü</h1>
        <p>ÁÆ°ÁêÜÂëòÁôªÂΩï</p>
        <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">ÈªòËÆ§Ë¥¶Êà∑Ôºöadmin / admin123</p>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label>Áî®Êà∑ÂêçÊàñÈÇÆÁÆ±</label>
          <input type="text" id="username" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÊàñÈÇÆÁÆ±" required />
        </div>
        <div class="form-group">
          <label>ÂØÜÁ†Å</label>
          <div style="position:relative;">
            <input type="password" id="password" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" required style="padding-right:45px;" />
            <button type="button" id="togglePasswordBtn" onclick="togglePasswordVisibility()" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:4px;color:#6b7280;font-size:18px;line-height:1;width:32px;height:32px;display:flex;align-items:center;justify-content:center;" title="ÊòæÁ§∫ÂØÜÁ†Å">üëÅÔ∏è</button>
          </div>
        </div>
        <div class="form-group" style="margin-bottom: 16px;">
          <label style="display: flex; align-items: center; cursor: pointer; font-size: 14px; font-weight: normal;">
            <input type="checkbox" id="useLocalAuth" style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;" />
            <span>‰ΩøÁî®Êú¨Âú∞È™åËØÅÔºàÊó†ÈúÄÂêéÁ´ØÊúçÂä°Ôºâ</span>
          </label>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">ÁôªÂΩï</button>
        <div id="loginError" class="error-message"></div>
      </form>
    </div>
  </div>
  
  <!-- ÁÆ°ÁêÜÁïåÈù¢ -->
  <div id="adminPage" style="display:none;">
    <!-- È°∂ÈÉ®ÂØºËà™Ê†èÔºà‰∏é‰∏ªÁ´ô‰∏ÄËá¥Ôºâ -->
    <div class="top-header">
      <h1>Êô∫È∏ΩÔΩúPigeonAI‚Äî‚ÄîÊô∫ËÉΩÁÆ°ÁêÜÁ≥ªÁªü</h1>
      <div class="top-header-actions">
        <span id="adminUserName" style="color: rgba(255,255,255,0.8); font-size: 14px;"></span>
        <button class="btn btn-sm" id="themeToggle" style="background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.15);">üåô ÊöóËâ≤Ê®°Âºè</button>
        <!-- Áî®Êà∑Â§¥ÂÉè -->
        <button class="btn btn-sm" id="btnUserAvatar" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;font-weight:600;box-shadow:0 4px 12px rgba(102,126,234,0.3);padding:8px 16px;border-radius:20px;display:flex;align-items:center;justify-content:center;gap:6px;font-size:14px;cursor:pointer;white-space:nowrap;" title="Êü•ÁúãË¥¶Êà∑‰ø°ÊÅØ">
          <span>üë§</span>
          <span>Ë¥¶Êà∑</span>
        </button>
        <!-- ËÆæÁΩÆÊåâÈíÆ -->
        <button class="btn btn-sm" id="btnSettings" style="background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.15);backdrop-filter:blur(10px);padding:8px 16px;border-radius:8px;display:flex;align-items:center;justify-content:center;gap:6px;font-size:14px;cursor:pointer;white-space:nowrap;" title="Á≥ªÁªüËÆæÁΩÆ">
          <span>‚öôÔ∏è</span>
          <span>ËÆæÁΩÆ</span>
        </button>
      </div>
    </div>
    
    <!-- Â∑¶‰æßËèúÂçï -->
    <div class="sidebar">
      <div class="sidebar-menu">
        <!-- ‰∏ªÁ´ôÂäüËÉΩÊ®°Âùó -->
        <div class="sidebar-item" data-tab="homeView">
          <span class="sidebar-item-icon">üè†</span>
          <span>È¶ñÈ°µ</span>
        </div>
        <div class="sidebar-item" data-tab="dashboardView">
          <span class="sidebar-item-icon">üìä</span>
          <span>Êï∞ÊçÆÊ¶ÇËßà</span>
        </div>
        <div class="sidebar-item" data-tab="listView">
          <span class="sidebar-item-icon">üìã</span>
          <span>È∏ΩÂ≠êÁÆ°ÁêÜ</span>
        </div>
        <div class="sidebar-item" data-tab="pedigreeView">
          <span class="sidebar-item-icon">üß¨</span>
          <span>Ë°ÄÁªüÂÖ≥Á≥ª</span>
        </div>
        <div class="sidebar-item" data-tab="statsView">
          <span class="sidebar-item-icon">üìà</span>
          <span>ÁªüËÆ°ÂàÜÊûê</span>
        </div>
        <div class="sidebar-item" data-tab="raceView">
          <span class="sidebar-item-icon">üèÜ</span>
          <span>ÊØîËµõ‰∏éÊàêÁª©ÁÆ°ÁêÜ</span>
        </div>
        <div class="sidebar-item" data-tab="breedingView">
          <span class="sidebar-item-icon">üß¨</span>
          <span>ÁπÅËÇ≤‰∏éÈÖçÂØπ</span>
        </div>
        <div class="sidebar-item" data-tab="healthView">
          <span class="sidebar-item-icon">ü©∫</span>
          <span>ÂÅ•Â∫∑ÁÆ°ÁêÜ</span>
        </div>
        <div class="sidebar-item" data-tab="analysisView">
          <span class="sidebar-item-icon">üß†</span>
          <span>Êô∫ËÉΩÂàÜÊûê‰∏≠ÂøÉ</span>
        </div>
        <div class="sidebar-item" data-tab="trainingView">
          <span class="sidebar-item-icon">üèÉ</span>
          <span>ËÆ≠ÁªÉÊ®°Âùó</span>
        </div>
        <div class="sidebar-item" data-tab="qualificationView">
          <span class="sidebar-item-icon">üéØ</span>
          <span>ËÉΩÂäõÁªºÂêàÂàÜÊûê</span>
        </div>
        
        <!-- ÂàÜÈöîÁ∫ø -->
        <div style="height: 1px; background: var(--border-light); margin: 12px 0;"></div>
        
        <!-- Êô∫ËÉΩÁÆ°ÁêÜÂäüËÉΩ -->
        <div class="sidebar-item active" data-tab="announcements">
          <span class="sidebar-item-icon">üì¢</span>
          <span>ÂÖ¨ÂëäÁÆ°ÁêÜ</span>
        </div>
        <div class="sidebar-item" data-tab="users">
          <span class="sidebar-item-icon">üë•</span>
          <span>Áî®Êà∑ÁÆ°ÁêÜ</span>
        </div>
        <div class="sidebar-item" data-tab="settings">
          <span class="sidebar-item-icon">‚öôÔ∏è</span>
          <span>Á≥ªÁªüËÆæÁΩÆ</span>
        </div>
        <div class="sidebar-item" data-tab="feedbackView">
          <span class="sidebar-item-icon">üí¨</span>
          <span>ÊÑèËßÅ‰∏éÂèçÈ¶à</span>
        </div>
        <div class="sidebar-item" data-tab="evoSettings">
          <span class="sidebar-item-icon">üïäÔ∏è</span>
          <span>EvoËÆæÁΩÆ</span>
        </div>
        <div class="sidebar-item" data-tab="coreAdminView">
          <span class="sidebar-item-icon">ü§ñ</span>
          <span>‰∏≠Êû¢ÁÆ°ÂÆ∂</span>
        </div>
        <div class="sidebar-item" data-tab="upgradeView">
          <span class="sidebar-item-icon">üöÄ</span>
          <span>Á≥ªÁªüÂçáÁ∫ß</span>
        </div>
      </div>
    </div>
    
    <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
    <div class="main-content">
      <div class="content-wrapper">
        <!-- ‰∏ªÁ´ôÂäüËÉΩÊ®°Âùó -->
        <!-- È¶ñÈ°µ -->
        <section id="homeView" class="home-section" style="display:none;">
          <!-- È°∂ÈÉ®‰ªäÊó•Ê¶ÇËßà -->
          <div class="home-overview">
            <div class="home-overview-left">
              <div class="home-date">
                <span class="home-date-day" id="homeDay">19</span>
                <div class="home-date-info">
                  <span class="home-date-weekday" id="homeWeekday">ÊòüÊúü‰∫î</span>
                  <span class="home-date-full" id="homeDateFull">2025Âπ¥12Êúà</span>
                </div>
              </div>
              <div class="home-weather" id="homeWeather">
                <span style="font-size:28px;">‚òÄÔ∏è</span>
                <div>
                  <div style="font-weight:600;">Êô¥Êúó</div>
                  <div style="font-size:12px;color:#6b7280;">ÈÄÇÂêàÊîæÈ£û</div>
                </div>
              </div>
              <!-- ÂÖ¨ÂëäÊ†è -->
              <div class="home-announcement-bubble" id="homeAnnouncementBubble" style="cursor: pointer;" onclick="showHomeAnnouncementDetail()">
                <span class="home-announcement-icon">üì¢</span>
                <div class="home-announcement-content">
                  <div class="home-announcement-text" id="homeAnnouncementBubbleText">ÊöÇÊó†ÂÖ¨Âëä</div>
                  <div style="font-size:12px;color:#6b7280;">Á≥ªÁªüÂÖ¨Âëä <span id="homeAnnouncementHint" style="display:none; color: rgba(255,255,255,0.7);">ÁÇπÂáªÊü•ÁúãÂÆåÊï¥</span></div>
                </div>
              </div>
            </div>
            <div class="home-overview-stats">
              <div class="home-stat-item">
                <span class="home-stat-icon">üì∞</span>
                <div class="home-stat-content">
                  <span class="home-stat-number" id="homeNewsCount">12</span>
                  <span class="home-stat-label">‰ªäÊó•ËµÑËÆØ</span>
                </div>
              </div>
              <div class="home-stat-item">
                <span class="home-stat-icon">üèÅ</span>
                <div class="home-stat-content">
                  <span class="home-stat-number" id="homeActiveRaces">3</span>
                  <span class="home-stat-label">ËøõË°å‰∏≠Ëµõ‰∫ã</span>
                </div>
              </div>
              <div class="home-stat-item">
                <span class="home-stat-icon">üèÜ</span>
                <div class="home-stat-content">
                  <span class="home-stat-number" id="homeCompletedRaces">5</span>
                  <span class="home-stat-label">Â∑≤ÂÖ¨Â∏ÉÊàêÁª©</span>
                </div>
              </div>
              <div class="home-stat-item">
                <span class="home-stat-icon">üïäÔ∏è</span>
                <div class="home-stat-content">
                  <span class="home-stat-number" id="homePigeonCount">0</span>
                  <span class="home-stat-label">ÊàëÁöÑÈ∏ΩÂ≠ê</span>
                </div>
              </div>
            </div>
          </div>

          <!-- ÈáçË¶ÅÂÖ¨Âëä -->
          <div class="home-announcement" id="homeAnnouncement" style="display:none;">
            <span class="announcement-icon">üì¢</span>
            <span class="announcement-text" id="announcementText"></span>
            <button class="btn btn-sm btn-ghost" id="btnCloseAnnouncement">‚úï</button>
          </div>

          <!-- ‰∏âÊ†èÂ∏ÉÂ±Ä -->
          <div class="home-content">
            <!-- Â∑¶Ê†èÔºöËµõÈ∏ΩËµÑËÆØÊµÅ -->
            <div class="home-column home-news">
              <div class="home-column-header">
                <h3>üì∞ ËµõÈ∏ΩËµÑËÆØ</h3>
                <div class="news-filter">
                  <button class="news-filter-btn active" data-filter="all">ÂÖ®ÈÉ®</button>
                  <button class="news-filter-btn" data-filter="race">Ëµõ‰∫ã</button>
                  <button class="news-filter-btn" data-filter="breeding">ËÇ≤Áßç</button>
                  <button class="news-filter-btn" data-filter="health">ÂÅ•Â∫∑</button>
                </div>
              </div>
              <div class="news-region-tabs">
                <button class="news-region-tab active" data-region="local">üìç Êú¨Âú∞ËµÑËÆØ</button>
                <button class="news-region-tab" data-region="national">üåê ÂÖ®ÂõΩËµÑËÆØ</button>
              </div>
              <div class="home-news-list" id="homeNewsList">
                <!-- ËµÑËÆØÂç°ÁâáÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
              </div>
              <div class="home-column-footer">
                <button class="btn btn-outline btn-sm" id="btnRefreshNews">üîÑ Âà∑Êñ∞ËµÑËÆØ</button>
                <button class="btn btn-outline btn-sm" id="btnLoadMoreNews">Âä†ËΩΩÊõ¥Â§ö</button>
              </div>
            </div>

            <!-- ‰∏≠Ê†èÔºöÂÆûÊó∂Ëµõ‰∫ã -->
            <div class="home-column home-events">
              <div class="home-column-header">
                <h3>üèÅ ÂÆûÊó∂Ëµõ‰∫ã</h3>
                <button class="btn btn-primary btn-sm" id="btnRefreshEvents">üîÑ Âà∑Êñ∞</button>
              </div>
              <div class="event-region-tabs">
                <button class="event-region-tab active" data-region="local">üìç Êú¨Âú∞Ëµõ‰∫ã</button>
                <button class="event-region-tab" data-region="national">üåê ÂÖ®ÂõΩËµõ‰∫ã</button>
              </div>
              <div class="event-tabs">
                <button class="event-tab-btn active" data-tab="ongoing">‚è± ËøõË°å‰∏≠</button>
                <button class="event-tab-btn" data-tab="upcoming">üìÖ Âç≥Â∞ÜÂºÄÂßã</button>
                <button class="event-tab-btn" data-tab="results">üèÜ ÊúÄÊñ∞ÊàêÁª©</button>
              </div>
              <div class="home-events-list" id="homeEventsList">
                <!-- Ëµõ‰∫ãÂç°ÁâáÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
              </div>
            </div>

            <!-- Âè≥Ê†èÔºöÊô∫ËÉΩÊé®Ëçê & ËÆ¢ÈòÖ -->
            <div class="home-column home-sidebar">
              <!-- Êô∫ËÉΩÊé®Ëçê -->
              <div class="home-widget">
                <div class="home-widget-header">
                  <h4>üß† Êô∫ËÉΩÊé®Ëçê</h4>
                </div>
                <div class="home-widget-content" id="homeRecommendations">
                  <!-- Êé®ËçêÂÜÖÂÆπÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
                </div>
              </div>

              <!-- ÊàëÁöÑÂÖ≥Ê≥® -->
              <div class="home-widget">
                <div class="home-widget-header">
                  <h4>‚≠ê ÊàëÁöÑÂÖ≥Ê≥®</h4>
                  <button class="btn btn-ghost btn-sm" id="btnEditSubscription">ÁºñËæë</button>
                </div>
                <div class="home-widget-content" id="homeSubscriptions">
                  <div class="subscription-tags">
                    <span class="subscription-tag">Ë¥µÂ∑ûËµõÂå∫</span>
                    <span class="subscription-tag">ÂÖ¨Ê£öËµõ</span>
                    <span class="subscription-tag">Êò•Â≠£Ëµõ</span>
                    <span class="subscription-tag add-tag" id="btnAddSubscription">+ Ê∑ªÂä†</span>
                  </div>
                </div>
              </div>

              <!-- Âø´Êç∑ÂÖ•Âè£ -->
              <div class="home-widget">
                <div class="home-widget-header">
                  <h4>üöÄ Âø´Êç∑ÂÖ•Âè£</h4>
                </div>
                <div class="home-widget-content">
                  <div class="quick-links">
                    <button class="quick-link-btn" data-action="addPigeon">
                      <span>‚ûï</span>
                      <span>Êñ∞Â¢ûÈ∏ΩÂ≠ê</span>
                    </button>
                    <button class="quick-link-btn" data-action="addRace">
                      <span>üèÜ</span>
                      <span>ÂΩïÂÖ•ÊàêÁª©</span>
                    </button>
                    <button class="quick-link-btn" data-action="breeding">
                      <span>üíï</span>
                      <span>ÈÖçÂØπËØÑ‰º∞</span>
                    </button>
                    <button class="quick-link-btn" data-action="analysis">
                      <span>üìä</span>
                      <span>Êô∫ËÉΩÂàÜÊûê</span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- ‰ªäÊó•ÊèêÈÜí -->
              <div class="home-widget">
                <div class="home-widget-header">
                  <h4>üîî ‰ªäÊó•ÊèêÈÜí</h4>
                </div>
                <div class="home-widget-content" id="homeTodayAlerts">
                  <!-- ÊèêÈÜíÂÜÖÂÆπÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Êï∞ÊçÆÊ¶ÇËßà -->
        <section id="dashboardView" class="card" style="display:none;">
          <div class="card-header">
            <h2>üìä Êï∞ÊçÆÊ¶ÇËßà</h2>
            <span class="muted" style="font-size: 13px;">ÂÆûÊó∂ÁªüËÆ°ÊÇ®ÁöÑ‰ø°È∏ΩÊ°£Ê°àÊï∞ÊçÆ</span>
          </div>
          
          <!-- Ê†∏ÂøÉÊï∞ÊçÆÂç°Áâá -->
          <div class="stats-cards">
            <div class="stat-card">
              <div class="stat-card-label">
                <span style="font-size: 18px;">üìä</span>
                <span>ÊÄªÈ∏ΩÂ≠êÊï∞</span>
              </div>
              <div class="stat-card-number" id="statTotal" style="color:#2563eb;">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-label">
                <span style="font-size: 18px;">üïäÔ∏è</span>
                <span>Âú®‰∏ñ</span>
              </div>
              <div class="stat-card-number" id="statAlive" style="color:#059669;">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-label">
                <span style="font-size: 18px;">üíî</span>
                <span>Â∑≤Ê≠ª‰∫°</span>
              </div>
              <div class="stat-card-number" id="statDead" style="color:#4b5563;">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-label">
                <span style="font-size: 18px;">üèÜ</span>
                <span>ÊúâÊàêÁª©</span>
              </div>
              <div class="stat-card-number" id="statRaced" style="color:#d97706;">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-label">
                <span style="font-size: 18px;">‚≠ê</span>
                <span>Ê†∏ÂøÉÁßçÈ∏Ω</span>
              </div>
              <div class="stat-card-number" id="statCore" style="color:#7c3aed;">0</div>
            </div>
          </div>
          
          <!-- ÂõæË°®Âå∫Âüü -->
          <div class="card" style="margin-top:24px;">
            <div class="card-header">
              <h2>üìà Âπ¥Â∫¶ÁªüËÆ°</h2>
              <span class="muted" style="font-size: 13px;">ÊåâÂπ¥‰ªΩÊ±áÊÄªÂá∫Áîü„ÄÅÊ≠ª‰∫°ÂèäÂèÇËµõËÆ∞ÂΩï</span>
            </div>
            <div id="chartContainer" style="min-height:300px; padding:24px;">
              <div id="dashboardStatsTableBody">
                <!-- Âπ¥Â∫¶ÁªüËÆ°Êï∞ÊçÆ -->
              </div>
            </div>
          </div>
        </section>

        <!-- È∏ΩÂ≠êÁÆ°ÁêÜ -->
        <section id="listView" class="card" style="display:none;">
          <div class="card-header">
            <h2>È∏ΩÂ≠êÁÆ°ÁêÜ</h2>
            <div style="display:flex;align-items:center;gap:12px;">
              <div class="view-switcher">
                <button class="view-switch-btn active" id="btnTableView" data-view-type="table">üìã Ë°®Ê†º</button>
                <button class="view-switch-btn" id="btnCardView" data-view-type="card">üÉè Âç°Áâá</button>
              </div>
            </div>
          </div>
          
          <!-- Ë°®Ê†ºËßÜÂõæ -->
          <div id="tableView">
            <table>
              <thead>
              <tr>
                <th>Ë∂≥ÁéØÂè∑</th>
                <th>ÂêçÁß∞</th>
                <th>Á±ªÂûã</th>
                <th>Áä∂ÊÄÅ</th>
                <th>Áà∂È∏Ω / ÊØçÈ∏Ω</th>
                <th>Áé∞È∏Ω‰∏ª</th>
                <th>ÂèÇËµõËÆ∞ÂΩïÊï∞</th>
                <th>Êìç‰Ωú</th>
              </tr>
              </thead>
              <tbody id="pigeonTableBody">
              <!-- Ë°åÁî± JS Â°´ÂÖÖ -->
              </tbody>
            </table>
          </div>
          
          <!-- Âç°ÁâáËßÜÂõæ -->
          <div id="cardView" style="display:none;">
            <div class="pigeon-cards" id="pigeonCardsBody">
              <!-- Âç°ÁâáÁî± JS Â°´ÂÖÖ -->
            </div>
          </div>
        </section>

        <!-- Ë°ÄÁªüÂÖ≥Á≥ª -->
        <section id="pedigreeView" class="card" style="display:none;">
          <div class="card-header">
            <h2>üå≥ Ë°ÄÁªüÂÖ≥Á≥ªÊ†ë</h2>
            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
              <select id="pedigreeSelectPigeon" style="padding:8px 12px;border-radius:6px;border:1px solid #E5E7EB;background:#fff;min-width:250px;">
                <option value="">ÈÄâÊã©È∏ΩÂ≠êÊü•ÁúãË°ÄÁªüÊ†ë</option>
              </select>
              <div style="display:flex;align-items:center;gap:8px;">
                <input type="text" id="pedigreeSearchInput" placeholder="ÊêúÁ¥¢Ë∂≥ÁéØÂè∑ÊàñÂêçÂ≠ó..." style="padding:8px 12px;border-radius:6px;border:1px solid #E5E7EB;background:#fff;min-width:200px;font-size:14px;outline:none;" />
                <button class="btn btn-primary btn-sm" id="btnPedigreeSearch">üîç ÊêúÁ¥¢</button>
              </div>
              <button class="btn btn-outline btn-sm" id="btnShowAllBreeders">üìä ÊòæÁ§∫ÊâÄÊúâÁßçÈ∏ΩÊ†ë</button>
              <button class="btn btn-outline btn-sm" id="btnRefreshPedigree">üîÑ Âà∑Êñ∞</button>
            </div>
          </div>
          <div id="pedigreeTreeContainer" class="pedigree-tree-container" style="min-height:500px;padding:20px;background:#fafbfc;border-radius:8px;">
            <p class="muted" style="text-align:center;padding:40px;">ËØ∑‰ªé‰∏äÊñπ‰∏ãÊãâËèúÂçï‰∏≠ÈÄâÊã©‰∏ÄÂè™È∏ΩÂ≠êÔºåÊàñ‰ΩøÁî®ÊêúÁ¥¢ÂäüËÉΩÊü•ÊâæÔºåÊü•ÁúãÂÖ∂ÂÆåÊï¥Ë°ÄÁªüÂÖ≥Á≥ªÊ†ëÔºàÂåÖÊã¨‰∫≤‰ª£ÂíåÂ≠ê‰ª£Ôºâ</p>
          </div>
        </section>

        <!-- ÁªüËÆ°ÂàÜÊûê -->
        <section id="statsView" class="card" style="display:none;">
          <div class="card-header">
            <h2>Âπ¥Â∫¶ÁªüËÆ°Ê¶ÇËßà</h2>
          </div>
          <p class="muted">ÊåâÂπ¥‰ªΩÊ±áÊÄªÔºöÂá∫ÁîüÊï∞Èáè„ÄÅÊ≠ª‰∫°Êï∞Èáè‰ª•ÂèäÊúâÂèÇËµõËÆ∞ÂΩïÁöÑÈ∏ΩÂ≠êÊï∞Èáè„ÄÇ</p>
          <table>
            <thead>
            <tr>
              <th>Âπ¥‰ªΩ</th>
              <th>Âá∫ÁîüÊï∞Èáè</th>
              <th>Ê≠ª‰∫°Êï∞Èáè</th>
              <th>ÊúâÂèÇËµõËÆ∞ÂΩïÁöÑÈ∏ΩÂ≠êÊï∞</th>
            </tr>
            </thead>
            <tbody id="statsViewTableBody">
            </tbody>
          </table>
        </section>

        <!-- ÊØîËµõ‰∏éÊàêÁª©ÁÆ°ÁêÜ -->
        <section id="raceView" class="card" style="display:none;">
          <div class="card-header">
            <h2>üèÜ ÊØîËµõ‰∏éÊàêÁª©ÁÆ°ÁêÜ</h2>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
              <button class="btn btn-primary btn-sm" id="btnAddRace">‚ûï Êñ∞Â¢ûÊØîËµõ</button>
              <button class="btn btn-outline btn-sm" id="btnImportExcel">üì• ÂØºÂÖ•Excel</button>
              <button class="btn btn-outline btn-sm" id="btnExportData">üì§ ÂØºÂá∫Êï∞ÊçÆ</button>
              <button class="btn btn-outline btn-sm" id="btnRefreshRaces">üîÑ Âà∑Êñ∞</button>
            </div>
          </div>

          <!-- Ê†áÁ≠æÈ°µÂØºËà™ -->
          <div style="border-bottom:2px solid #e5e7eb;margin-bottom:20px;">
            <div style="display:flex;gap:8px;">
              <button class="race-tab-btn active" data-tab="raceList">üìã ÊØîËµõÂàóË°®</button>
              <button class="race-tab-btn" data-tab="raceImport">üì• ÂØºÂÖ•ÊàêÁª©</button>
              <button class="race-tab-btn" data-tab="raceStats">üìä ÊàêÁª©ÁªüËÆ°</button>
              <button class="race-tab-btn" data-tab="raceAnalysis">üìà ÊàêÁª©ÂàÜÊûê</button>
              <button class="race-tab-btn" data-tab="pedigreeComparison">üß¨ Ë°ÄÁªüÂØπÊØî</button>
            </div>
          </div>

          <!-- ÊØîËµõÂàóË°®Ê†áÁ≠æÈ°µ -->
          <div id="raceListTab" class="race-tab-content active">
            <div id="raceListContainer">
              <p class="muted" style="text-align:center;padding:40px;">ÊöÇÊó†ÊØîËµõËÆ∞ÂΩïÔºåÁÇπÂáª"Êñ∞Â¢ûÊØîËµõ"ÂºÄÂßãËÆ∞ÂΩï</p>
            </div>
          </div>

          <!-- ÂØºÂÖ•ÊàêÁª©Ê†áÁ≠æÈ°µ -->
          <div id="raceImportTab" class="race-tab-content">
            <div style="max-width:800px;margin:0 auto;">
              <div class="excel-import-zone" id="excelDropZone">
                <div style="font-size:48px;margin-bottom:16px;">üìä</div>
                <div style="font-size:16px;font-weight:600;color:#1f2937;margin-bottom:8px;">ÊãñÊîæ Excel/CSV Êñá‰ª∂Âà∞Ê≠§Â§Ñ</div>
                <div style="font-size:13px;color:#6b7280;margin-bottom:16px;">ÊàñÁÇπÂáªÈÄâÊã©Êñá‰ª∂</div>
                <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" style="display:none;" />
                <button class="btn btn-primary" id="btnSelectExcel">ÈÄâÊã©Êñá‰ª∂</button>
              </div>
              <div style="margin-top:24px;padding:20px;background:#f9fafb;border-radius:12px;">
                <h4 style="margin:0 0 12px;color:#1f2937;">üìã Êñá‰ª∂Ê†ºÂºèË¶ÅÊ±Ç</h4>
                <div style="font-size:13px;color:#4b5563;line-height:1.8;">
                  <p>Excel Êñá‰ª∂Â∫îÂåÖÂê´‰ª•‰∏ãÂàóÔºàË°®Â§¥ÂêçÁß∞ÔºâÔºö</p>
                  <ul style="margin:8px 0;padding-left:20px;">
                    <li><strong>Ë∂≥ÁéØÂè∑ / ÁéØÂè∑</strong> - È∏ΩÂ≠êÁöÑË∂≥ÁéØÂè∑Á†ÅÔºàÂøÖÈúÄÔºâ</li>
                    <li><strong>ÂêçÊ¨° / ÊéíÂêç</strong> - ÊØîËµõÂêçÊ¨°ÔºàÂøÖÈúÄÔºâ</li>
                    <li><strong>ÂàÜÈÄü</strong> - ÊØîËµõÂàÜÈÄüÔºàÂèØÈÄâÔºâ</li>
                    <li><strong>ÂΩíÂ∑¢Êó∂Èó¥</strong> - ÂΩíÂ∑¢Êó∂Èó¥ÔºàÂèØÈÄâÔºâ</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <!-- ÊàêÁª©ÁªüËÆ°Ê†áÁ≠æÈ°µ -->
          <div id="raceStatsTab" class="race-tab-content">
            <p class="muted" style="text-align:center;padding:40px;">ÊàêÁª©ÁªüËÆ°ÂäüËÉΩÂºÄÂèë‰∏≠...</p>
          </div>

          <!-- ÊàêÁª©ÂàÜÊûêÊ†áÁ≠æÈ°µ -->
          <div id="raceAnalysisTab" class="race-tab-content">
            <p class="muted" style="text-align:center;padding:40px;">ÊàêÁª©ÂàÜÊûêÂäüËÉΩÂºÄÂèë‰∏≠...</p>
          </div>

          <!-- Ë°ÄÁªüÂØπÊØîÊ†áÁ≠æÈ°µ -->
          <div id="pedigreeComparisonTab" class="race-tab-content">
            <p class="muted" style="text-align:center;padding:40px;">Ë°ÄÁªüÂØπÊØîÂäüËÉΩÂºÄÂèë‰∏≠...</p>
          </div>
        </section>

        <!-- ÁπÅËÇ≤‰∏éÈÖçÂØπ -->
        <section id="breedingView" class="card" style="display:none;">
          <div class="card-header">
            <h2>üß¨ ÁπÅËÇ≤‰∏éÈÖçÂØπÁÆ°ÁêÜ</h2>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
              <button class="btn btn-primary btn-sm" id="btnNewPairing">üíï Êñ∞Âª∫ÈÖçÂØπ</button>
              <button class="btn btn-outline btn-sm" id="btnViewPairingHistory">üìã ÈÖçÂØπÂéÜÂè≤</button>
              <button class="btn btn-outline btn-sm" id="btnRefreshBreeding">üîÑ Âà∑Êñ∞</button>
            </div>
          </div>

          <!-- ÈÖçÂØπÈù¢Êùø -->
          <div class="breeding-panel">
            <div class="breeding-selector-row" style="display:grid;grid-template-columns:1fr auto 1fr;gap:24px;align-items:start;margin-bottom:24px;">
              <!-- ÂÖ¨È∏ΩÈÄâÊã© -->
              <div class="breeding-pigeon-card male-card" style="background:linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);border:2px solid #3b82f6;border-radius:16px;padding:24px;">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
                  <span style="font-size:32px;">‚ôÇ</span>
                  <div>
                    <h3 style="margin:0;color:#1e40af;font-size:18px;">ÈÄâÊã©ÂÖ¨È∏Ω</h3>
                    <span style="color:#6b7280;font-size:13px;">Father</span>
                  </div>
                </div>
                <select id="breedingMaleSelect" style="width:100%;padding:12px;border-radius:8px;border:2px solid #93c5fd;font-size:14px;background:#fff;">
                  <option value="">ËØ∑ÈÄâÊã©ÂÖ¨È∏Ω...</option>
                </select>
                <div id="breedingMaleInfo" style="margin-top:16px;min-height:150px;">
                  <p class="muted" style="text-align:center;padding:20px;">ÈÄâÊã©ÂÖ¨È∏ΩÂêéÊòæÁ§∫ËØ¶ÊÉÖ</p>
                </div>
              </div>

              <!-- ÈÖçÂØπËØÑ‰º∞‰∏≠ÂøÉ -->
              <div class="breeding-assessment" style="background:linear-gradient(135deg, #fdf4ff 0%, #faf5ff 100%);border:2px solid #a855f7;border-radius:16px;padding:24px;min-width:300px;">
                <div style="text-align:center;margin-bottom:20px;">
                  <span style="font-size:48px;">üíë</span>
                  <h3 style="margin:8px 0 0;color:#7e22ce;font-size:18px;">ÈÖçÂØπËØÑ‰º∞</h3>
                </div>
                <div id="breedingAssessment" style="min-height:200px;">
                  <div style="text-align:center;padding:40px 20px;color:#9ca3af;">
                    <div style="font-size:32px;margin-bottom:12px;">üîÆ</div>
                    <p>ËØ∑ÂÖàÈÄâÊã©ÂÖ¨È∏ΩÂíåÊØçÈ∏Ω</p>
                    <p style="font-size:12px;">Á≥ªÁªüÂ∞ÜËá™Âä®ÂàÜÊûêËøë‰∫≤È£éÈô©‰∏éÈÖçÂØπÂª∫ËÆÆ</p>
                  </div>
                </div>
                <button class="btn btn-primary" id="btnConfirmPairing" style="width:100%;margin-top:16px;padding:14px;font-size:15px;" disabled>‚úÖ Á°ÆËÆ§ÈÖçÂØπ</button>
              </div>

              <!-- ÊØçÈ∏ΩÈÄâÊã© -->
              <div class="breeding-pigeon-card female-card" style="background:linear-gradient(135deg, #fce7f3 0%, #fdf2f8 100%);border:2px solid #ec4899;border-radius:16px;padding:24px;">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
                  <span style="font-size:32px;">‚ôÄ</span>
                  <div>
                    <h3 style="margin:0;color:#be185d;font-size:18px;">ÈÄâÊã©ÊØçÈ∏Ω</h3>
                    <span style="color:#6b7280;font-size:13px;">Mother</span>
                  </div>
                </div>
                <select id="breedingFemaleSelect" style="width:100%;padding:12px;border-radius:8px;border:2px solid #f9a8d4;font-size:14px;background:#fff;">
                  <option value="">ËØ∑ÈÄâÊã©ÊØçÈ∏Ω...</option>
                </select>
                <div id="breedingFemaleInfo" style="margin-top:16px;min-height:150px;">
                  <p class="muted" style="text-align:center;padding:20px;">ÈÄâÊã©ÊØçÈ∏ΩÂêéÊòæÁ§∫ËØ¶ÊÉÖ</p>
                </div>
              </div>
            </div>

            <!-- ÂéÜÂè≤ÈÖçÂØπÊàêÂäüÊ°à‰æã -->
            <div class="breeding-history-section" style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-top:24px;">
              <h4 style="margin:0 0 16px;color:#1f2937;display:flex;align-items:center;gap:8px;">
                <span>üìä</span> ÂéÜÂè≤ÈÖçÂØπ‰∏éÂêé‰ª£Ë°®Áé∞
              </h4>
              <div id="breedingHistoryContainer">
                <p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†ÈÖçÂØπÂéÜÂè≤ËÆ∞ÂΩï</p>
              </div>
            </div>
          </div>
        </section>

        <!-- ÂÅ•Â∫∑ÁÆ°ÁêÜ -->
        <section id="healthView" class="card" style="display:none;">
          <div class="card-header">
            <h2>ü©∫ ÂÅ•Â∫∑‰∏éÁî®ËçØÁÆ°ÁêÜ</h2>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
              <button class="btn btn-primary btn-sm" id="btnAddHealthRecord">üíâ Ê∑ªÂä†ËÆ∞ÂΩï</button>
              <button class="btn btn-outline btn-sm" id="btnHealthCalendar">üìÖ ÊèêÈÜíÊó•ÂéÜ</button>
              <button class="btn btn-outline btn-sm" id="btnRefreshHealth">üîÑ Âà∑Êñ∞</button>
            </div>
          </div>

          <!-- ÂÅ•Â∫∑Áä∂ÊÄÅÊ¶ÇËßà -->
          <div class="health-overview" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:16px;margin-bottom:24px;">
            <div style="background:linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);padding:20px;border-radius:12px;border:1px solid #10b981;">
              <div style="font-size:28px;">‚úÖ</div>
              <div style="font-size:13px;color:#047857;margin-top:8px;">ÂÅ•Â∫∑Áä∂ÊÄÅ</div>
              <div id="healthyCount" style="font-size:32px;font-weight:700;color:#047857;">0</div>
            </div>
            <div style="background:linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);padding:20px;border-radius:12px;border:1px solid #f59e0b;">
              <div style="font-size:28px;">‚è∞</div>
              <div style="font-size:13px;color:#b45309;margin-top:8px;">Âç≥Â∞ÜÂà∞Êúü</div>
              <div id="upcomingCount" style="font-size:32px;font-weight:700;color:#b45309;">0</div>
            </div>
            <div style="background:linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);padding:20px;border-radius:12px;border:1px solid #ef4444;">
              <div style="font-size:28px;">üè•</div>
              <div style="font-size:13px;color:#dc2626;margin-top:8px;">ÈúÄË¶ÅÂÖ≥Ê≥®</div>
              <div id="needAttentionCount" style="font-size:32px;font-weight:700;color:#dc2626;">0</div>
            </div>
            <div style="background:linear-gradient(135deg, #e0e7ff 0%, #eef2ff 100%);padding:20px;border-radius:12px;border:1px solid #6366f1;">
              <div style="font-size:28px;">üíä</div>
              <div style="font-size:13px;color:#4338ca;margin-top:8px;">Áî®ËçØ‰∏≠</div>
              <div id="medicatingCount" style="font-size:32px;font-weight:700;color:#4338ca;">0</div>
            </div>
          </div>

          <!-- ÂÅ•Â∫∑ÊèêÈÜíÂàóË°® -->
          <div class="health-alerts" style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:24px;">
            <h4 style="margin:0 0 16px;color:#1f2937;display:flex;align-items:center;gap:8px;">
              <span>üîî</span> ÂÅ•Â∫∑ÊèêÈÜí
            </h4>
            <div id="healthAlertsContainer">
              <p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†ÂÅ•Â∫∑ÊèêÈÜí</p>
            </div>
          </div>

          <!-- È∏ΩÂ≠êÂÅ•Â∫∑Êó∂Èó¥ËΩ¥ -->
          <div class="health-timeline" style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
              <h4 style="margin:0;color:#1f2937;display:flex;align-items:center;gap:8px;">
                <span>üìã</span> ÂÅ•Â∫∑ËÆ∞ÂΩïÊó∂Èó¥ËΩ¥
              </h4>
              <select id="healthPigeonSelect" style="padding:8px 12px;border-radius:6px;border:1px solid #E5E7EB;min-width:200px;">
                <option value="">ÈÄâÊã©È∏ΩÂ≠êÊü•ÁúãËÆ∞ÂΩï...</option>
              </select>
            </div>
            <div id="healthTimelineContainer">
              <p class="muted" style="text-align:center;padding:40px;">ÈÄâÊã©È∏ΩÂ≠êÂêéÊòæÁ§∫ÂÅ•Â∫∑Êó∂Èó¥ËΩ¥</p>
            </div>
          </div>
        </section>

        <!-- Êô∫ËÉΩÂàÜÊûê‰∏≠ÂøÉ -->
        <section id="analysisView" class="card" style="display:none;">
          <div class="card-header">
            <h2>üß† Êô∫ËÉΩÂàÜÊûê‰∏≠ÂøÉ</h2>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
              <button class="btn btn-primary btn-sm" id="btnRunAnalysis">üöÄ ËøêË°åÂÖ®Èù¢ÂàÜÊûê</button>
              <button class="btn btn-outline btn-sm" id="btnExportReport">üì§ ÂØºÂá∫Êä•Âëä</button>
              <button class="btn btn-outline btn-sm" id="btnRefreshAnalysis">üîÑ Âà∑Êñ∞</button>
            </div>
          </div>

          <!-- Êô∫ËÉΩÊ¥ûÂØüÂç°Áâá -->
          <div class="insight-cards" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:20px;margin-bottom:24px;">
            <!-- ‰ªäÂπ¥ÊúÄÊàêÂäüÁöÑË°ÄÁ≥ª -->
            <div class="insight-card" style="background:linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);padding:24px;border-radius:16px;border:2px solid #f59e0b;">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                <span style="font-size:32px;">üèÜ</span>
                <h4 style="margin:0;color:#92400e;">‰ªäÂπ¥ÊúÄÊàêÂäüË°ÄÁ≥ª</h4>
              </div>
              <div id="topBloodlineCard">
                <p class="muted">ÂàÜÊûê‰∏≠...</p>
              </div>
            </div>

            <!-- ÊúÄÂº∫ÁßçÂÖ¨ -->
            <div class="insight-card" style="background:linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);padding:24px;border-radius:16px;border:2px solid #3b82f6;">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                <span style="font-size:32px;">‚ôÇ</span>
                <h4 style="margin:0;color:#1e40af;">ÊúÄÂº∫ÁßçÂÖ¨</h4>
              </div>
              <div id="topMaleCard">
                <p class="muted">ÂàÜÊûê‰∏≠...</p>
              </div>
            </div>

            <!-- ÊúÄÂº∫ÁßçÊØç -->
            <div class="insight-card" style="background:linear-gradient(135deg, #fce7f3 0%, #fdf2f8 100%);padding:24px;border-radius:16px;border:2px solid #ec4899;">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                <span style="font-size:32px;">‚ôÄ</span>
                <h4 style="margin:0;color:#be185d;">ÊúÄÂº∫ÁßçÊØç</h4>
              </div>
              <div id="topFemaleCard">
                <p class="muted">ÂàÜÊûê‰∏≠...</p>
              </div>
            </div>

            <!-- Êé®ËçêÈÖçÂØπ -->
            <div class="insight-card" style="background:linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);padding:24px;border-radius:16px;border:2px solid #10b981;">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                <span style="font-size:32px;">üíï</span>
                <h4 style="margin:0;color:#047857;">Êô∫ËÉΩÊé®ËçêÈÖçÂØπ</h4>
              </div>
              <div id="recommendedPairingCard">
                <p class="muted">ÂàÜÊûê‰∏≠...</p>
              </div>
            </div>
          </div>

          <!-- ËØ¶ÁªÜÂàÜÊûêÊä•Âëä -->
          <div class="card" style="margin-top:24px;">
            <div class="card-header">
              <h3>üìä ËØ¶ÁªÜÂàÜÊûêÊä•Âëä</h3>
            </div>
            <div id="analysisReportContainer">
              <p class="muted" style="text-align:center;padding:40px;">ÁÇπÂáª"ËøêË°åÂÖ®Èù¢ÂàÜÊûê"ÁîüÊàêËØ¶ÁªÜÊä•Âëä</p>
            </div>
          </div>
        </section>

        <!-- ËÆ≠ÁªÉÊ®°Âùó -->
        <section id="trainingView" class="card" style="display:none;">
          <div class="card-header">
            <h2>üèÉ ËÆ≠ÁªÉÊ®°Âùó</h2>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
              <button class="btn btn-primary btn-sm" id="btnScanQR">üì∑ Êâ´Á†ÅÂΩïÂÖ•</button>
              <button class="btn btn-outline btn-sm" id="btnManualInput">‚úèÔ∏è ÊâãÂä®ËæìÂÖ•</button>
              <button class="btn btn-outline btn-sm" id="btnRefreshTraining">üîÑ Âà∑Êñ∞</button>
            </div>
          </div>

          <!-- Êâ´Á†Å/ËæìÂÖ•Âå∫Âüü -->
          <div class="card" style="margin-bottom:24px;background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
            <div style="display:flex;gap:20px;align-items:flex-start;flex-wrap:wrap;">
              <div style="flex:1;min-width:300px;">
                <h4 style="margin:0 0 16px;color:#0369a1;">üì∑ Êâ´Á†ÅÊàñËæìÂÖ•ËÑöÁéØÂè∑</h4>
                <div style="display:flex;gap:12px;margin-bottom:16px;">
                  <input type="text" id="trainingRingInput" placeholder="ËæìÂÖ•ËÑöÁéØÂè∑" style="flex:1;padding:12px;border-radius:8px;border:2px solid #0ea5e9;font-size:14px;" />
                  <button class="btn btn-primary" id="btnSearchPigeon">üîç Êü•Êâæ</button>
                </div>
                <div id="qrScannerContainer" style="display:none;margin-top:16px;">
                  <video id="qrVideo" width="100%" style="max-width:400px;border-radius:8px;background:#000;"></video>
                  <canvas id="qrCanvas" style="display:none;"></canvas>
                  <div style="margin-top:12px;">
                    <button class="btn btn-outline btn-sm" id="btnStopScan">ÂÅúÊ≠¢Êâ´Êèè</button>
                  </div>
                </div>
              </div>
              <div id="selectedPigeonInfo" style="flex:1;min-width:300px;display:none;">
                <h4 style="margin:0 0 16px;color:#0369a1;">ÈÄâ‰∏≠ÁöÑÈ∏ΩÂ≠ê</h4>
                <div id="selectedPigeonDetails" style="background:#fff;padding:16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);"></div>
              </div>
            </div>
          </div>

          <!-- ËÆ≠ÁªÉËÆ∞ÂΩïË°®Âçï -->
          <div id="trainingFormContainer" style="display:none;">
            <div class="card-header">
              <h3>üìù ËÆ∞ÂΩïËÆ≠ÁªÉÂÜÖÂÆπ</h3>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label>ËÆ≠ÁªÉÊó•Êúü<span class="required">*</span></label>
                <input type="date" id="trainingDate" required />
              </div>
              <div class="form-group">
                <label>ËÆ≠ÁªÉË∑ùÁ¶ªÔºàÂÖ¨ÈáåÔºâ<span class="required">*</span></label>
                <input type="number" id="trainingDistance" step="0.1" placeholder="‰æãÂ¶ÇÔºö50" required />
              </div>
              <div class="form-group">
                <label>È£ûË°åÊó∂ÈïøÔºàÂàÜÈíüÔºâ<span class="required">*</span></label>
                <input type="number" id="trainingDuration" step="1" placeholder="‰æãÂ¶ÇÔºö60" required />
              </div>
              <div class="form-group">
                <label>Â§©Ê∞îÁä∂ÂÜµ</label>
                <select id="trainingWeather">
                  <option value="Êô¥Êúó">Êô¥Êúó</option>
                  <option value="Â§ö‰∫ë">Â§ö‰∫ë</option>
                  <option value="Èò¥Â§©">Èò¥Â§©</option>
                  <option value="Â∞èÈõ®">Â∞èÈõ®</option>
                  <option value="Â§ßÈ£é">Â§ßÈ£é</option>
                </select>
              </div>
            </div>
            <div class="form-group" style="margin-top:12px;">
              <label>Â§áÊ≥®</label>
              <textarea id="trainingNotes" rows="3" placeholder="ËÆ∞ÂΩïËÆ≠ÁªÉËøáÁ®ã‰∏≠ÁöÑÁâπÊÆäÊÉÖÂÜµ..."></textarea>
            </div>
            <div class="form-actions" style="margin-top:20px;">
              <button class="btn btn-outline" id="btnCancelTraining">ÂèñÊ∂à</button>
              <button class="btn btn-primary" id="btnSaveTraining">‰øùÂ≠òËÆ≠ÁªÉËÆ∞ÂΩï</button>
            </div>
          </div>

          <!-- ËÆ≠ÁªÉËÆ∞ÂΩïÂàóË°® -->
          <div class="card" style="margin-top:24px;">
            <div class="card-header">
              <h3>üìã ËÆ≠ÁªÉËÆ∞ÂΩïÂéÜÂè≤</h3>
            </div>
            <div id="trainingHistoryContainer">
              <p class="muted" style="text-align:center;padding:40px;">ÊöÇÊó†ËÆ≠ÁªÉËÆ∞ÂΩï</p>
            </div>
          </div>
        </section>

        <!-- ËÉΩÂäõÁªºÂêàÂàÜÊûê -->
        <section id="qualificationView" class="card" style="display:none;">
          <div class="card-header">
            <h2>üéØ ËÉΩÂäõÁªºÂêàÂàÜÊûê</h2>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
              <button class="btn btn-outline btn-sm" id="btnRefreshQualification">üîÑ Âà∑Êñ∞</button>
            </div>
          </div>

          <!-- ÈÄâÊã©È∏ΩÂ≠êÂíåÊØîËµõË∑ùÁ¶ª -->
          <div class="card" style="margin-bottom:24px;background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
            <h4 style="margin:0 0 16px;color:#0369a1;">ÈÄâÊã©È∏ΩÂ≠êÂíåÊØîËµõ‰ø°ÊÅØ</h4>
            <div class="form-grid">
              <div class="form-group">
                <label>ÈÄâÊã©È∏ΩÂ≠ê<span class="required">*</span></label>
                <select id="qualificationPigeonSelect" style="width:100%;">
                  <option value="">ËØ∑ÈÄâÊã©È∏ΩÂ≠ê</option>
                </select>
              </div>
              <div class="form-group">
                <label>ÊØîËµõË∑ùÁ¶ªÔºàÂÖ¨ÈáåÔºâ<span class="required">*</span></label>
                <input type="number" id="qualificationDistance" step="0.1" placeholder="‰æãÂ¶ÇÔºö500" required />
              </div>
              <div class="form-group" style="align-items:flex-end;">
                <button class="btn btn-primary" id="btnAnalyzeQualification">üöÄ ÂºÄÂßãÂàÜÊûê</button>
              </div>
            </div>
          </div>

          <!-- ÂàÜÊûêÁªìÊûú -->
          <div id="qualificationResultContainer" style="display:none;">
            <!-- ÂÖçË¥£Â£∞Êòé -->
            <div class="card" style="background:#fef3c7;border:2px solid #f59e0b;margin-bottom:24px;">
              <div style="display:flex;align-items:flex-start;gap:12px;">
                <span style="font-size:24px;">‚ö†Ô∏è</span>
                <div>
                  <h4 style="margin:0 0 8px;color:#92400e;">Êï∞ÊçÆ‰ªÖ‰æõÂèÇËÄÉ</h4>
                  <p style="margin:0;color:#78350f;font-size:14px;" id="qualificationDisclaimer">
                    Êú¨ÂàÜÊûêÁªìÊûú‰ªÖ‰æõÂèÇËÄÉÔºåÂÆûÈôÖÂèÇËµõËµÑÊ†º‰ª•Ëµõ‰∫ãÁªÑÂßî‰ºöËßÑÂÆö‰∏∫ÂáÜ„ÄÇÊï∞ÊçÆÊù•Ê∫ê‰∫éËÆ≠ÁªÉËÆ∞ÂΩï„ÄÅÂéÜÂè≤ÊØîËµõËÆ∞ÂΩïÂèäÂÖ¨ÂºÄËµõ‰∫ãÊï∞ÊçÆÔºåÂèØËÉΩÂ≠òÂú®ËØØÂ∑Æ„ÄÇ
                  </p>
                </div>
              </div>
            </div>

            <!-- ÁªºÂêàÂàÜÊûêÁªìÊûú -->
            <div class="card" style="margin-bottom:24px;">
              <h3 style="margin:0 0 16px;color:#1f2937;">üìä ÁªºÂêàÂàÜÊûêÁªìÊûú</h3>
              <div id="qualificationAnalysisResult">
                <!-- ÂàÜÊûêÁªìÊûúÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
              </div>
            </div>
          </div>
        </section>

        <!-- Êô∫ËÉΩÁÆ°ÁêÜÂäüËÉΩ -->
        <!-- ÂÖ¨ÂëäÁÆ°ÁêÜ -->
        <div id="announcementsTab" class="card" style="display:block;">
          <div class="card-header">
            <h2>üì¢ ÂÖ¨ÂëäÁÆ°ÁêÜ</h2>
            <button class="btn btn-primary btn-sm" id="createAnnouncementBtn">‚ûï ÂèëÂ∏ÉÊñ∞ÂÖ¨Âëä</button>
          </div>
          <div id="announcementsList">
            <p class="muted" style="text-align: center; padding: 40px;">Âä†ËΩΩ‰∏≠...</p>
          </div>
          
          <!-- ÂéÜÂè≤ÂÖ¨ÂëäÊ®°Âùó -->
          <div style="margin-top: 32px; padding-top: 24px; border-top: 2px solid var(--border-light);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="margin: 0; font-size: 18px; color: var(--text-primary);">üìú ÂéÜÂè≤ÂÖ¨Âëä</h3>
              <button class="btn btn-outline btn-sm" id="refreshHistoryBtn" onclick="loadAnnouncementHistory()">üîÑ Âà∑Êñ∞</button>
            </div>
            <div id="announcementHistoryList">
              <p class="muted" style="text-align: center; padding: 40px;">Âä†ËΩΩ‰∏≠...</p>
            </div>
          </div>
        </div>

        <!-- ÊÑèËßÅ‰∏éÂèçÈ¶à -->
        <div id="feedbackViewTab" class="card" style="display:none;">
          <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <h2>üí¨ Áî®Êà∑ÊÑèËßÅ‰∏éÂèçÈ¶à</h2>
              <p class="muted" style="margin-top:4px;font-size:13px;">Êü•ÁúãÊù•Ëá™ PC ‰∏éÁßªÂä®Á´ØÁî®Êà∑Êèê‰∫§ÁöÑÊÑèËßÅÂíåÈóÆÈ¢ò</p>
            </div>
            <div>
              <select id="feedbackStatusFilter" style="padding:6px 10px;border-radius:6px;border:1px solid var(--border-light);font-size:13px;">
                <option value="">ÂÖ®ÈÉ®Áä∂ÊÄÅ</option>
                <option value="new">Êú™Â§ÑÁêÜ</option>
              </select>
              <button class="btn btn-primary btn-sm" id="btnRefreshFeedback" style="margin-left:8px;">üîÑ Âà∑Êñ∞</button>
            </div>
          </div>
          <div style="padding:16px;">
            <div class="table-wrapper">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width:18%;">Êèê‰∫§Êó∂Èó¥</th>
                    <th style="width:12%;">Êù•Ê∫ê</th>
                    <th style="width:20%;">Áî®Êà∑</th>
                    <th>ÂÜÖÂÆπ</th>
                    <th style="width:16%;">ËÅîÁ≥ªÊñπÂºè</th>
                  </tr>
                </thead>
                <tbody id="feedbackTableBody">
                  <tr>
                    <td colspan="5" style="text-align:center;color:var(--text-muted);padding:32px;">ÊöÇÊó†Êï∞ÊçÆ</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Áî®Êà∑ÁÆ°ÁêÜ -->
        <div id="usersTab" class="card" style="display:none;">
          <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
            <h2>üë• Áî®Êà∑ÁÆ°ÁêÜ</h2>
            <div style="display:flex;gap:10px;">
              <input type="text" id="userSearchInput" placeholder="ÊêúÁ¥¢Áî®Êà∑ÂêçÊàñÈÇÆÁÆ±..." style="padding:8px 12px;border:1px solid var(--border-light);border-radius:6px;font-size:14px;width:250px;" />
              <button class="btn btn-primary btn-sm" onclick="loadUsers()">üîÑ Âà∑Êñ∞</button>
            </div>
          </div>
          <div id="usersList">
            <p class="muted" style="text-align: center; padding: 40px;">Âä†ËΩΩ‰∏≠...</p>
          </div>
        </div>
        
        <!-- Áî®Êà∑Êï∞ÊçÆËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
        <div id="userDataModal" class="modal" style="display:none;">
          <div class="modal-content" style="max-width:900px;max-height:85vh;overflow-y:auto;">
            <div class="modal-header">
              <h3 id="userDataModalTitle">Áî®Êà∑Êï∞ÊçÆËØ¶ÊÉÖ</h3>
              <button class="modal-close" onclick="closeUserDataModal()">√ó</button>
            </div>
            <div class="modal-body" id="userDataModalBody">
              <p class="muted">Âä†ËΩΩ‰∏≠...</p>
            </div>
          </div>
        </div>
        
        <!-- Á≥ªÁªüËÆæÁΩÆ -->
        <div id="settingsTab" class="card" style="display:none;">
          <div class="card-header">
            <h2>‚öôÔ∏è Á≥ªÁªüËÆæÁΩÆ</h2>
            <p class="muted" style="margin-top: 8px;">ÁÆ°ÁêÜÁ≥ªÁªüÈÖçÁΩÆÂèÇÊï∞</p>
          </div>
          
          <div style="padding: 24px;">
            <!-- ËÆæÁΩÆÊ†áÁ≠æÈ°µ -->
            <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid var(--border-light);">
              <button class="settings-tab-btn active" data-tab="general">Âü∫Á°ÄËÆæÁΩÆ</button>
              <button class="settings-tab-btn" data-tab="rss">RSSÊ∫êÁÆ°ÁêÜ</button>
              <button class="settings-tab-btn" data-tab="cache">ÁºìÂ≠òÈÖçÁΩÆ</button>
              <button class="settings-tab-btn" data-tab="ai">AIÈÖçÁΩÆ</button>
              <button class="settings-tab-btn" data-tab="database">Êï∞ÊçÆÂ∫ìÈÖçÁΩÆ</button>
            </div>
            
            <!-- Âü∫Á°ÄËÆæÁΩÆ -->
            <div id="settingsGeneral" class="settings-panel">
              <h3 style="margin-bottom: 20px; color: var(--text-primary);">ÊúçÂä°Âô®ÈÖçÁΩÆ</h3>
              
              <div class="form-group">
                <label>ÊúçÂä°Âô®Á´ØÂè£</label>
                <input type="number" id="serverPort" class="form-control" placeholder="3000" min="1" max="65535" />
                <small class="form-text">ÂΩìÂâçËøêË°åÁ´ØÂè£Ôºà‰øÆÊîπÈúÄË¶ÅÈáçÂêØÊúçÂä°Ôºâ</small>
              </div>
              
              <div class="form-group">
                <label>ËøêË°åÁéØÂ¢É</label>
                <select id="serverEnv" class="form-control">
                  <option value="development">ÂºÄÂèëÁéØÂ¢É</option>
                  <option value="production">Áîü‰∫ßÁéØÂ¢É</option>
                </select>
                <small class="form-text">ÂΩìÂâçËøêË°åÁéØÂ¢É</small>
              </div>
              
              <div class="form-group">
                <label>APIÈÄüÁéáÈôêÂà∂</label>
                <input type="number" id="apiRateLimit" class="form-control" placeholder="100" min="1" />
                <small class="form-text">ÊØèÂàÜÈíüÊúÄÂ§ßËØ∑Ê±ÇÊï∞</small>
              </div>
              
              <h3 style="margin-top: 32px; margin-bottom: 20px; color: var(--text-primary);">Êó•ÂøóÈÖçÁΩÆ</h3>
              
              <div class="form-group">
                <label>Êó•ÂøóÁ∫ßÂà´</label>
                <select id="logLevel" class="form-control">
                  <option value="error">ÈîôËØØ</option>
                  <option value="warn">Ë≠¶Âëä</option>
                  <option value="info">‰ø°ÊÅØ</option>
                  <option value="debug">Ë∞ÉËØï</option>
                </select>
                <small class="form-text">Êó•ÂøóËÆ∞ÂΩïÁ∫ßÂà´</small>
              </div>
              
              <div class="form-actions" style="margin-top: 24px;">
                <button type="button" class="btn btn-primary" id="btnSaveGeneralSettings">‰øùÂ≠òÂü∫Á°ÄËÆæÁΩÆ</button>
                <button type="button" class="btn btn-outline" id="btnResetGeneralSettings">ÈáçÁΩÆ</button>
              </div>
            </div>
            
            <!-- RSSÊ∫êÁÆ°ÁêÜ -->
            <div id="settingsRss" class="settings-panel" style="display:none;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: var(--text-primary);">RSSÊï∞ÊçÆÊ∫êÁÆ°ÁêÜ</h3>
                <button type="button" class="btn btn-primary btn-sm" id="btnAddRssSource">+ Ê∑ªÂä†RSSÊ∫ê</button>
              </div>
              
              <div id="rssSourcesList" style="display: grid; gap: 16px;">
                <!-- RSSÊ∫êÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÂä†ËΩΩ -->
              </div>
              
              <div id="rssSourceForm" style="display:none; margin-top: 24px; padding: 20px; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                <h4 style="margin-bottom: 16px;">Ê∑ªÂä†/ÁºñËæëRSSÊ∫ê</h4>
                <div class="form-group">
                  <label>Ê∫êÂêçÁß∞ <span class="required">*</span></label>
                  <input type="text" id="rssSourceName" class="form-control" placeholder="‰æãÂ¶ÇÔºö‰∏≠ÂõΩ‰ø°È∏Ω‰ø°ÊÅØÁΩë" />
                </div>
                <div class="form-group">
                  <label>RSS URL <span class="required">*</span></label>
                  <input type="url" id="rssSourceUrl" class="form-control" placeholder="https://example.com/rss" />
                </div>
                <div class="form-group">
                  <label>Á±ªÂûã <span class="required">*</span></label>
                  <select id="rssSourceType" class="form-control">
                    <option value="media">Â™í‰Ωì</option>
                    <option value="association">Âçè‰ºö</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Âú∞Âå∫ <span class="required">*</span></label>
                  <select id="rssSourceRegion" class="form-control">
                    <option value="local">Êú¨Âú∞</option>
                    <option value="national">ÂÖ®ÂõΩ</option>
                  </select>
                </div>
                <div class="form-actions">
                  <button type="button" class="btn btn-primary" id="btnSaveRssSource">‰øùÂ≠ò</button>
                  <button type="button" class="btn btn-outline" id="btnCancelRssSource">ÂèñÊ∂à</button>
                  <button type="button" class="btn btn-outline" id="btnTestRssSource">ÊµãËØïËøûÊé•</button>
                </div>
                <div id="rssSourceTestResult" style="margin-top: 12px;"></div>
              </div>
            </div>
            
            <!-- ÁºìÂ≠òÈÖçÁΩÆ -->
            <div id="settingsCache" class="settings-panel" style="display:none;">
              <h3 style="margin-bottom: 20px; color: var(--text-primary);">ÁºìÂ≠òÈÖçÁΩÆ</h3>
              <p class="muted" style="margin-bottom: 24px;">ÈÖçÁΩÆÂêÑÁ±ªÊï∞ÊçÆÁöÑÁºìÂ≠òÊó∂Èó¥ÔºàÁßíÔºâ</p>
              
              <div class="form-group">
                <label>ËµÑËÆØÁºìÂ≠òÊó∂Èó¥ÔºàÁßíÔºâ</label>
                <input type="number" id="cacheTtlNews" class="form-control" placeholder="3600" min="0" />
                <small class="form-text">ËµÑËÆØÊï∞ÊçÆÁºìÂ≠òÊó∂Èó¥ÔºåÈªòËÆ§3600ÁßíÔºà1Â∞èÊó∂Ôºâ</small>
              </div>
              
              <div class="form-group">
                <label>Ëµõ‰∫ãÁºìÂ≠òÊó∂Èó¥ÔºàÁßíÔºâ</label>
                <input type="number" id="cacheTtlEvents" class="form-control" placeholder="300" min="0" />
                <small class="form-text">Ëµõ‰∫ãÊï∞ÊçÆÁºìÂ≠òÊó∂Èó¥ÔºåÈªòËÆ§300ÁßíÔºà5ÂàÜÈíüÔºâ</small>
              </div>
              
              <div class="form-group">
                <label>ÊàêÁª©ÁºìÂ≠òÊó∂Èó¥ÔºàÁßíÔºâ</label>
                <input type="number" id="cacheTtlResults" class="form-control" placeholder="7200" min="0" />
                <small class="form-text">ÊàêÁª©Êï∞ÊçÆÁºìÂ≠òÊó∂Èó¥ÔºåÈªòËÆ§7200ÁßíÔºà2Â∞èÊó∂Ôºâ</small>
              </div>
              
              <h3 style="margin-top: 32px; margin-bottom: 20px; color: var(--text-primary);">Êõ¥Êñ∞È¢ëÁéá</h3>
              
              <div class="form-group">
                <label>ËµÑËÆØÊõ¥Êñ∞Èó¥ÈöîÔºàÁßíÔºâ</label>
                <input type="number" id="updateIntervalNews" class="form-control" placeholder="3600" min="0" />
                <small class="form-text">Ëá™Âä®Êõ¥Êñ∞ËµÑËÆØÁöÑÈó¥ÈöîÊó∂Èó¥</small>
              </div>
              
              <div class="form-group">
                <label>Ëµõ‰∫ãÊõ¥Êñ∞Èó¥ÈöîÔºàÁßíÔºâ</label>
                <input type="number" id="updateIntervalEvents" class="form-control" placeholder="300" min="0" />
                <small class="form-text">Ëá™Âä®Êõ¥Êñ∞Ëµõ‰∫ãÁöÑÈó¥ÈöîÊó∂Èó¥</small>
              </div>
              
              <div class="form-group">
                <label>ÊàêÁª©Êõ¥Êñ∞Èó¥ÈöîÔºàÁßíÔºâ</label>
                <input type="number" id="updateIntervalResults" class="form-control" placeholder="1800" min="0" />
                <small class="form-text">Ëá™Âä®Êõ¥Êñ∞ÊàêÁª©ÁöÑÈó¥ÈöîÊó∂Èó¥</small>
              </div>
              
              <div class="form-actions" style="margin-top: 24px;">
                <button type="button" class="btn btn-primary" id="btnSaveCacheSettings">‰øùÂ≠òÁºìÂ≠òÈÖçÁΩÆ</button>
                <button type="button" class="btn btn-outline" id="btnResetCacheSettings">ÈáçÁΩÆ</button>
              </div>
            </div>
            
            <!-- AIÈÖçÁΩÆ -->
            <div id="settingsAi" class="settings-panel" style="display:none;">
              <h3 style="margin-bottom: 20px; color: var(--text-primary);">AIÊúçÂä°ÈÖçÁΩÆ</h3>
              <p class="muted" style="margin-bottom: 24px;">ÈÖçÁΩÆAIÊúçÂä°Êèê‰æõÂïÜÁöÑAPI KeyÔºàÊïèÊÑü‰ø°ÊÅØÔºåËØ∑Â¶•ÂñÑ‰øùÁÆ°Ôºâ„ÄÇÊîØÊåÅ‰ªÖÊú¨Âú∞‰øùÂ≠òÊàñ‰øùÂ≠òÂà∞ÂêéÂè∞Á´ãÂç≥ÁîüÊïà„ÄÇ</p>
              
              <div class="alert alert-info" style="margin-bottom: 24px; padding: 16px; background: var(--primary-50); border: 1px solid var(--primary-200); border-radius: var(--radius-md);">
                <strong>ÊèêÁ§∫Ôºö</strong>Áé∞Âú®ÊîØÊåÅÂú®ÂêéÂè∞‰øùÂ≠òAI KeyÂπ∂Âç≥Êó∂ÁîüÊïàÔºàÊó†ÈúÄÈáçÂêØÔºâ„ÄÇËã•‰ΩøÁî®VercelÈÉ®ÁΩ≤Ôºå‰ªçÈúÄÂú®ÁéØÂ¢ÉÂèòÈáè‰∏≠ÂêåÊ≠•ÈÖçÁΩÆ„ÄÇ<br>
                <strong>ÈáçË¶ÅÔºö</strong>ËØ∑Âå∫ÂàÜ‰∏§‰∏™‰∏çÂêåÁöÑAPI KeyÔºåÈÅøÂÖçÊ∑∑Áî®ÔºÅ
              </div>
              
              <div class="form-group">
                <label>Êô∫Ë∞±AI API Key - EvoÊô∫ËÉΩÂä©ÊâãÔºàÂêçÁß∞ÔºöÊô∫È∏ΩÔºâ</label>
                <div style="display: flex; gap: 8px;">
                  <input type="password" id="zhipuApiKeyEvo" class="form-control" placeholder="Êú™ÈÖçÁΩÆ" />
                  <button type="button" class="btn btn-outline btn-sm" onclick="alert('EvoÂä©Êâã KeyÔºöZHIPU_API_KEY_EVO\\nÁî®ÈÄîÔºö‰∏ªÁ´ôÂä©Êâã\\nÊù•Ê∫êÔºöopen.bigmodel.cn')">Êü•ÁúãÈÖçÁΩÆËØ¥Êòé</button>
                </div>
                <small class="form-text">Áî®‰∫éEvoÊô∫ËÉΩÂä©ÊâãÔºà‰∏ªÁ´ôAIÂä©ÊâãÔºâ„ÄÇËé∑ÂèñÂú∞ÂùÄÔºö<a href="https://open.bigmodel.cn/" target="_blank">https://open.bigmodel.cn/</a></small>
              </div>
              
              <div class="form-group">
                <label>Êô∫Ë∞±AI API Key - ‰∏≠Êû¢ÁÆ°ÂÆ∂ÔºàÂêçÁß∞ÔºöÊô∫È∏Ω¬∑‰∏≠Êû¢ÁÆ°ÂÆ∂Ôºâ</label>
                <div style="display: flex; gap: 8px;">
                  <input type="password" id="zhipuApiKeyAdmin" class="form-control" placeholder="Êú™ÈÖçÁΩÆ" />
                  <button type="button" class="btn btn-outline btn-sm" onclick="alert('ÁÆ°ÂÆ∂ KeyÔºöZHIPU_API_KEY_ADMIN\\nÁî®ÈÄîÔºö‰∏≠Êû¢ÁÆ°ÂÆ∂\\nÊù•Ê∫êÔºöopen.bigmodel.cn')">Êü•ÁúãÈÖçÁΩÆËØ¥Êòé</button>
                </div>
                <small class="form-text">Áî®‰∫é‰∏≠Êû¢ÁÆ°ÂÆ∂Á≥ªÁªüÔºàÊô∫ËÉΩAIÁÆ°ÁêÜÔºâ„ÄÇËé∑ÂèñÂú∞ÂùÄÔºö<a href="https://open.bigmodel.cn/" target="_blank">https://open.bigmodel.cn/</a></small>
              </div>
              
              <div class="form-group">
                <label>ÈÄö‰πâÂçÉÈóÆ API Key</label>
                <div style="display: flex; gap: 8px;">
                  <input type="password" id="qwenApiKey" class="form-control" placeholder="Êú™ÈÖçÁΩÆ" />
                  <button type="button" class="btn btn-outline btn-sm" onclick="alert('ÈÄö‰πâ KeyÔºöQWEN_API_KEY\\nÁî®ÈÄîÔºöÂ§áÈÄâÊ®°Âûã\\nÊù•Ê∫êÔºödashscope.aliyun.com')">Êü•ÁúãÈÖçÁΩÆËØ¥Êòé</button>
                </div>
                <small class="form-text">Ëé∑ÂèñÂú∞ÂùÄÔºö<a href="https://dashscope.aliyun.com/" target="_blank">https://dashscope.aliyun.com/</a></small>
              </div>
              
              <div class="form-group">
                <label>Hugging Face API Key</label>
                <div style="display: flex; gap: 8px;">
                  <input type="password" id="huggingFaceApiKey" class="form-control" placeholder="Êú™ÈÖçÁΩÆ" />
                  <button type="button" class="btn btn-outline btn-sm" onclick="alert('HuggingFace KeyÔºöHUGGING_FACE_API_KEY\\nÁî®ÈÄîÔºöÂ§áÈÄâÊ®°Âûã\\nÊù•Ê∫êÔºöhuggingface.co')">Êü•ÁúãÈÖçÁΩÆËØ¥Êòé</button>
                </div>
                <small class="form-text">Ëé∑ÂèñÂú∞ÂùÄÔºö<a href="https://huggingface.co/settings/tokens" target="_blank">https://huggingface.co/settings/tokens</a></small>
              </div>
              
              <div class="form-group">
                <label>AIÊ®°ÂûãÈÄâÊã©</label>
                <select id="aiModel" class="form-control">
                  <option value="auto">Ëá™Âä®ÈÄâÊã©ÔºàÊé®ËçêÔºâ</option>
                  <option value="zhipu">Êô∫Ë∞±AI</option>
                  <option value="qwen">ÈÄö‰πâÂçÉÈóÆ</option>
                  <option value="huggingface">Hugging Face</option>
                </select>
                <small class="form-text">ÈÄâÊã©‰ΩøÁî®ÁöÑAIÊúçÂä°Êèê‰æõÂïÜ</small>
              </div>
              
              <div class="form-actions" style="margin-top: 24px; display:flex; gap:12px; flex-wrap:wrap;">
                <button type="button" class="btn btn-outline" id="btnSaveZhipuConfig">‰ªÖ‰øùÂ≠òÂà∞Êú¨Âú∞ÊµèËßàÂô®</button>
                <button type="button" class="btn btn-primary" id="btnSaveAiSettings">‰øùÂ≠òÂà∞ÂêéÂè∞Âπ∂Á´ãÂç≥ÁîüÊïà</button>
                <div id="aiSettingsStatus" class="muted" style="display:none;"></div>
              </div>
            </div>
            
            <!-- Êï∞ÊçÆÂ∫ìÈÖçÁΩÆ -->
            <div id="settingsDatabase" class="settings-panel" style="display:none;">
              <h3 style="margin-bottom: 20px; color: var(--text-primary);">Êï∞ÊçÆÂ∫ìÈÖçÁΩÆ</h3>
              <p class="muted" style="margin-bottom: 24px;">ÈÖçÁΩÆSupabase‰∫ëÊï∞ÊçÆÂ∫ìËøûÊé•ÔºàÁî®‰∫éÊï∞ÊçÆÊåÅ‰πÖÂåñÔºâ</p>
              
              <div class="alert alert-warning" style="margin-bottom: 24px; padding: 16px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: var(--radius-md);">
                <strong>ÈáçË¶ÅÔºö</strong>ÈÖçÁΩÆSupabaseÂèØ‰ª•Á°Æ‰øùÊï∞ÊçÆÂú®VercelÈÉ®ÁΩ≤Âêé‰∏ç‰∏¢Â§±„ÄÇËØ∑Âú®VercelÁéØÂ¢ÉÂèòÈáè‰∏≠ÈÖçÁΩÆ„ÄÇ
              </div>
              
              <div class="form-group">
                <label>Supabase URL</label>
                <div style="display: flex; gap: 8px;">
                  <input type="text" id="supabaseUrl" class="form-control" placeholder="https://xxx.supabase.co" readonly />
                  <button type="button" class="btn btn-outline btn-sm" onclick="alert('ËØ∑Âú®VercelÁéØÂ¢ÉÂèòÈáè‰∏≠ÈÖçÁΩÆ SUPABASE_URL')">Êü•ÁúãÈÖçÁΩÆËØ¥Êòé</button>
                </div>
                <small class="form-text">SupabaseÈ°πÁõÆURL</small>
              </div>
              
              <div class="form-group">
                <label>Supabase Anon Key</label>
                <div style="display: flex; gap: 8px;">
                  <input type="password" id="supabaseAnonKey" class="form-control" placeholder="Â∑≤ÈÖçÁΩÆÔºàÂÆâÂÖ®ÈöêËóèÔºâ" readonly />
                  <button type="button" class="btn btn-outline btn-sm" onclick="alert('ËØ∑Âú®VercelÁéØÂ¢ÉÂèòÈáè‰∏≠ÈÖçÁΩÆ SUPABASE_ANON_KEY')">Êü•ÁúãÈÖçÁΩÆËØ¥Êòé</button>
                </div>
                <small class="form-text">SupabaseÂåøÂêçÂØÜÈí•</small>
              </div>
              
              <div class="form-actions" style="margin-top: 24px;">
                <button type="button" class="btn btn-outline" onclick="alert('Êï∞ÊçÆÂ∫ìÈÖçÁΩÆÈúÄË¶ÅÂú®VercelÁéØÂ¢ÉÂèòÈáè‰∏≠ËÆæÁΩÆÔºåËØ∑ÂèÇËÄÉ„ÄäÊï∞ÊçÆ‰øùÊä§‰∏éÂçáÁ∫ßÊåáÂçó.md„Äã')">Êü•ÁúãÈÖçÁΩÆÊåáÂçó</button>
              </div>
            </div>
            
            <!-- Áä∂ÊÄÅÊèêÁ§∫ -->
            <div id="settingsStatus" style="margin-top: 24px; padding: 12px; border-radius: var(--radius-md); display: none;"></div>
          </div>
        </div>
        
        <!-- EvoËÆæÁΩÆ -->
        <div id="evoSettingsTab" class="card" style="display:none;">
          <div class="card-header">
            <h2>üïäÔ∏è Evo Êô∫ËÉΩÂä©ÊâãËÆæÁΩÆ</h2>
          </div>
          <div class="card-body">
            <div class="form-section">
              <h3 style="margin-bottom: 16px; color: var(--text-primary);">Âü∫Êú¨ËÆæÁΩÆ</h3>
              
              <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="evoEnabled" checked style="width: auto;">
                  <span>ÂêØÁî®Êô∫ËÉΩÂä©Êâã</span>
                </label>
                <div class="form-hint">Âú®‰∏ªÁ´ôÂíåÊô∫ËÉΩÁÆ°ÁêÜÁ≥ªÁªüÊòæÁ§∫EvoÊô∫ËÉΩÂä©Êâã</div>
              </div>
              
              <div class="form-group">
                <label>Âä©Êâã‰ΩçÁΩÆ</label>
                <select id="evoPosition" style="width: 100%; padding: 8px; border: 1px solid var(--border-medium); border-radius: 6px;">
                  <option value="bottom-right">Âè≥‰∏ãËßí</option>
                  <option value="bottom-left">Â∑¶‰∏ãËßí</option>
                  <option value="top-right">Âè≥‰∏äËßí</option>
                  <option value="top-left">Â∑¶‰∏äËßí</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>ÊòæÁ§∫Ê®°Âºè</label>
                <select id="evoDisplayMode" style="width: 100%; padding: 8px; border: 1px solid var(--border-medium); border-radius: 6px;">
                  <option value="always">ÂßãÁªàÊòæÁ§∫</option>
                  <option value="hover">Èº†Ê†áÊÇ¨ÂÅúÊòæÁ§∫</option>
                  <option value="click">ÁÇπÂáªÊòæÁ§∫</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>Ëá™Âä®ÂÖ≥Èó≠Êó∂Èó¥ÔºàÁßíÔºâ</label>
                <input type="number" id="evoAutoClose" value="5" min="0" max="60" style="width: 100%; padding: 8px; border: 1px solid var(--border-medium); border-radius: 6px;">
                <div class="form-hint">ËÆæÁΩÆ‰∏∫0Ë°®Á§∫‰∏çËá™Âä®ÂÖ≥Èó≠</div>
              </div>
            </div>
            
            <div class="form-section" style="margin-top: 24px;">
              <h3 style="margin-bottom: 16px; color: var(--text-primary);">Â§ñËßÇËÆæÁΩÆ</h3>
              
              <div class="form-group">
                <label>ÂõæÊ†áÂ§ßÂ∞è</label>
                <input type="range" id="evoIconSize" min="50" max="100" value="70" style="width: 100%;">
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                  <span>Â∞è</span>
                  <span id="evoIconSizeValue">70px</span>
                  <span>Â§ß</span>
                </div>
              </div>
              
              <div class="form-group">
                <label>‰∏ªÈ¢òÈ¢úËâ≤</label>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                  <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                    <input type="radio" name="evoTheme" value="purple" checked>
                    <span style="display: inline-block; width: 24px; height: 24px; border-radius: 4px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></span>
                    <span>Á¥´Ëâ≤</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                    <input type="radio" name="evoTheme" value="blue">
                    <span style="display: inline-block; width: 24px; height: 24px; border-radius: 4px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);"></span>
                    <span>ËìùËâ≤</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                    <input type="radio" name="evoTheme" value="green">
                    <span style="display: inline-block; width: 24px; height: 24px; border-radius: 4px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);"></span>
                    <span>ÁªøËâ≤</span>
                  </label>
                </div>
              </div>
            </div>
            
            <div class="form-section" style="margin-top: 24px;">
              <h3 style="margin-bottom: 16px; color: var(--text-primary);">ÂäüËÉΩËÆæÁΩÆ</h3>
              
              <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="evoShowWelcome" checked style="width: auto;">
                  <span>ÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ</span>
                </label>
              </div>
              
              <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="evoSaveHistory" checked style="width: auto;">
                  <span>‰øùÂ≠òÂØπËØùÂéÜÂè≤</span>
                </label>
              </div>
              
              <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="evoShowAnalytics" checked style="width: auto;">
                  <span>ÊòæÁ§∫Êï∞ÊçÆÂàÜÊûêÊ†áÁ≠æ</span>
                </label>
              </div>
              
              <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="evoShowRecommendations" checked style="width: auto;">
                  <span>ÊòæÁ§∫Êô∫ËÉΩÊé®ËçêÊ†áÁ≠æ</span>
                </label>
              </div>
            </div>
            
            <div class="form-section" style="margin-top: 24px;">
              <h3 style="margin-bottom: 16px; color: var(--text-primary);">ü§ñ AI Ê®°Âûã‰ø°ÊÅØ</h3>
              
              <div style="background: var(--bg-secondary); border: 1px solid var(--border-medium); border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                <div id="evoAIModelInfo" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                  <div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Ê®°ÂûãÂêçÁß∞</div>
                    <div id="evoAIModelName" style="font-size: 16px; font-weight: 600; color: var(--text-primary);">Âä†ËΩΩ‰∏≠...</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">ÊúçÂä°Êèê‰æõÂïÜ</div>
                    <div id="evoAIProvider" style="font-size: 16px; font-weight: 600; color: var(--text-primary);">Âä†ËΩΩ‰∏≠...</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">‰ΩøÁî®Áä∂ÊÄÅ</div>
                    <div id="evoAIStatus" style="font-size: 14px; padding: 4px 12px; border-radius: 4px; display: inline-block; background: rgba(255, 152, 0, 0.3);">Âä†ËΩΩ‰∏≠...</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Ê®°ÂûãÊù•Ê∫ê</div>
                    <a id="evoAISource" href="#" target="_blank" style="font-size: 14px; color: var(--primary); text-decoration: none;">Êü•ÁúãËØ¶ÊÉÖ</a>
                  </div>
                </div>
                
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-light);">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Ê®°ÂûãÊèèËø∞</div>
                  <div id="evoAIDescription" style="font-size: 14px; color: var(--text-primary); line-height: 1.6;">Âä†ËΩΩ‰∏≠...</div>
                </div>
                
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-light);">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">ÂäüËÉΩÁâπÊÄß</div>
                  <div id="evoAIFeatures" style="font-size: 14px; color: var(--text-primary); line-height: 1.8;">Âä†ËΩΩ‰∏≠...</div>
                </div>
                
                <div style="margin-top: 16px; display: flex; gap: 12px;">
                  <button type="button" class="btn btn-outline" id="btnEvoRefreshAIInfo" style="flex: 1;">üîÑ Âà∑Êñ∞‰ø°ÊÅØ</button>
                  <button type="button" class="btn btn-outline" id="btnEvoTestAI" style="flex: 1;">üß™ ÊµãËØïËøûÊé•</button>
                </div>
              </div>
              
              <div id="evoAIInfoStatus" style="margin-top: 12px; padding: 12px; border-radius: 6px; display: none; font-size: 14px;"></div>
            </div>
            
            <!-- Êô∫Ë∞± API ÈÖçÁΩÆÔºàÊï¥ÂêàËá™Êô∫Ë∞±APIÈÖçÁΩÆÈù¢ÊùøÔºåÁî®‰∫éÊéßÂà∂‰∏ªÁ´ô EvoÔºâ -->
            <div class="form-section" style="margin-top: 24px;">
              <h3 style="margin-bottom: 16px; color: var(--text-primary);">üîë Êô∫Ë∞± API ÈÖçÁΩÆ</h3>
              <p class="muted" style="margin-bottom: 16px;">ÈÖçÁΩÆÁî®‰∫é‰∏ªÁ´ô Evo Âä©ÊâãË∞ÉÁî®ÁöÑÊô∫Ë∞± AI ÂèÇÊï∞</p>
              
              <div class="form-group">
                <label>Êô∫Ë∞±API Key <span class="required">*</span></label>
                <div style="display: flex; gap: 8px;">
                  <input type="password" id="zhipuApiKeyConfig" class="form-control" placeholder="ËØ∑ËæìÂÖ•Êô∫Ë∞±API Key" />
                  <button type="button" class="btn btn-outline btn-sm" id="btnTestZhipuKey">È™åËØÅ</button>
                </div>
                <small class="form-text">Ëé∑ÂèñÂú∞ÂùÄÔºö<a href="https://open.bigmodel.cn/" target="_blank">https://open.bigmodel.cn/</a></small>
                <div id="zhipuKeyTestResult" style="margin-top: 8px; display: none;"></div>
              </div>
              
              <div class="form-group">
                <label>Ê®°ÂûãÈÄâÊã©</label>
                <select id="zhipuModelConfig" class="form-control">
                  <option value="glm-4">GLM-4ÔºàÊé®ËçêÔºâ</option>
                  <option value="glm-4-flash">GLM-4-FlashÔºàÂø´ÈÄüÔºâ</option>
                  <option value="glm-3-turbo">GLM-3-Turbo</option>
                </select>
                <small class="form-text">ÈªòËÆ§‰ΩøÁî®GLM-4Ê®°Âûã</small>
              </div>
              
              <div class="form-group">
                <label>TemperatureÔºàÊ∏©Â∫¶Ôºâ</label>
                <input type="range" id="zhipuTemperatureConfig" min="0" max="1" step="0.1" value="0.7" class="form-control" />
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                  <span>0ÔºàÁ°ÆÂÆöÊÄßÔºâ</span>
                  <span id="zhipuTemperatureValue">0.7</span>
                  <span>1ÔºàÂàõÈÄ†ÊÄßÔºâ</span>
                </div>
                <small class="form-text">ÊéßÂà∂ÂõûÂ§çÁöÑÈöèÊú∫ÊÄßÔºåÂÄºË∂äÂ§ßË∂äÊúâÂàõÈÄ†ÊÄß</small>
              </div>
              
              <div class="form-group">
                <label>Max TokensÔºàÊúÄÂ§ßËæìÂá∫ÈïøÂ∫¶Ôºâ</label>
                <input type="number" id="zhipuMaxTokensConfig" min="100" max="2000" step="100" value="2000" class="form-control" />
                <small class="form-text">ÈôêÂà∂AIÂõûÂ§çÁöÑÊúÄÂ§ßÈïøÂ∫¶ÔºåËåÉÂõ¥Ôºö100-2000</small>
              </div>
              
              <div class="form-actions" style="margin-top: 24px;">
                <button type="button" class="btn btn-outline" id="btnSaveZhipuConfig">‰ªÖ‰øùÂ≠òÂà∞Êú¨Âú∞ÊµèËßàÂô®</button>
              </div>
              
              <div id="zhipuConfigStatus" style="margin-top: 16px; padding: 12px; border-radius: 6px; display: none;"></div>
            </div>
            
            <!-- Âä©ÊâãÂäüËÉΩÈÖçÁΩÆÔºàÊï¥ÂêàËá™Âä©ÊâãÂäüËÉΩÈÖçÁΩÆÈù¢ÊùøÔºåÁî®‰∫éÊéßÂà∂‰∏ªÁ´ô Evo Ë°å‰∏∫Ôºâ -->
            <div class="form-section" style="margin-top: 24px;">
              <h3 style="margin-bottom: 16px; color: var(--text-primary);">ü§ñ Âä©ÊâãË°å‰∏∫ÈÖçÁΩÆ</h3>
              
              <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="assistantEnabledConfig" checked style="width: auto;" />
                  <span>ÂêØÁî®Âä©ÊâãÁõ¥Êé•Ë∞ÉÁî®APIÂäüËÉΩ</span>
                </label>
                <div class="form-hint">ÂÖ≥Èó≠ÂêéÔºå‰∏ªÁ´ô Evo Âä©ÊâãÂ∞ÜÊó†Ê≥ïË∞ÉÁî®Êô∫Ë∞±API</div>
              </div>
              
              <div class="form-group">
                <label>Ê¨¢ËøéËØ≠</label>
                <textarea id="assistantWelcomeMessageConfig" class="form-control" rows="3" placeholder="‰Ω†Â•ΩÔºÅÊàëÊòØÊô∫È∏ΩAIÂä©ÊâãÔºåÊúâ‰ªÄ‰πàÂèØ‰ª•Â∏ÆÂä©‰Ω†ÁöÑÂêóÔºü"></textarea>
                <small class="form-text">Âä©ÊâãÊâìÂºÄÊó∂ÊòæÁ§∫ÁöÑÊ¨¢ËøéÊ∂àÊÅØ</small>
                <div id="assistantWelcomePreview" style="margin-top: 8px; padding: 12px; background: var(--bg-tertiary); border-radius: 6px; display: none;">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">È¢ÑËßàÔºö</div>
                  <div id="assistantWelcomePreviewText" style="font-size: 14px; color: var(--text-primary);"></div>
                </div>
              </div>
              
              <div class="form-group">
                <label>ÈîôËØØÊèêÁ§∫</label>
                <textarea id="assistantErrorMessageConfig" class="form-control" rows="2" placeholder="AIÂä©ÊâãÊöÇÊó∂Êó†Ê≥ïÂìçÂ∫îÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇÂ¶ÇÈóÆÈ¢òÊåÅÁª≠ÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò„ÄÇ"></textarea>
                <small class="form-text">APIË∞ÉÁî®Â§±Ë¥•Êó∂ÊòæÁ§∫ÁöÑÈîôËØØÊèêÁ§∫</small>
              </div>
              
              <div class="form-group">
                <label>ÂØπËØùÂéÜÂè≤‰øùÁïôÊó∂ÈïøÔºàÂ§©Ôºâ</label>
                <input type="number" id="assistantHistoryDaysConfig" min="1" max="30" value="7" class="form-control" />
                <small class="form-text">Êú¨Âú∞Â≠òÂÇ®ÁöÑÂØπËØùÂéÜÂè≤‰øùÁïôÂ§©Êï∞ÔºåËåÉÂõ¥Ôºö1-30Â§©</small>
              </div>
              
              <div class="form-actions" style="margin-top: 24px;">
                <button type="button" class="btn btn-outline" id="btnSaveAssistantConfig">‰øùÂ≠òÂä©ÊâãÈÖçÁΩÆ</button>
                <button type="button" class="btn btn-outline" id="btnSyncAssistantConfig">ÂêåÊ≠•Âà∞PC/ÁßªÂä®Á´Ø</button>
              </div>
              
              <div id="assistantConfigStatus" style="margin-top: 16px; padding: 12px; border-radius: 6px; display: none;"></div>
            </div>
            
            <div class="form-section" style="margin-top: 24px;">
              <h3 style="margin-bottom: 16px; color: var(--text-primary);">GitHub ËÅäÂ§©Êú∫Âô®‰∫∫ÈÖçÁΩÆ</h3>
              
              <div class="form-group">
                <label>‰ªìÂ∫ìÂú∞ÂùÄ</label>
                <input type="text" id="evoGithubRepo" placeholder="‰æãÂ¶Ç: username/repo-name" style="width: 100%; padding: 8px; border: 1px solid var(--border-medium); border-radius: 6px;">
                <div class="form-hint">Ê†ºÂºèÔºöÁî®Êà∑Âêç/‰ªìÂ∫ìÂêç</div>
              </div>
              
              <div class="form-group">
                <label>Token</label>
                <input type="password" id="evoGithubToken" placeholder="GitHub Personal Access Token" style="width: 100%; padding: 8px; border: 1px solid var(--border-medium); border-radius: 6px;">
                <div class="form-hint">
                  <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--primary);">Ëé∑Âèñ Token</a>
                </div>
              </div>
              
              <div class="form-group">
                <label>APIÁ´ØÁÇπÔºàÂèØÈÄâÔºâ</label>
                <input type="text" id="evoGithubApiEndpoint" placeholder="‰æãÂ¶Ç: https://your-app.vercel.app/api/chat" style="width: 100%; padding: 8px; border: 1px solid var(--border-medium); border-radius: 6px;">
                <div class="form-hint">Â¶ÇÊûúNext.jsÂ∫îÁî®Â∑≤ÈÉ®ÁΩ≤ÔºåÂèØÁõ¥Êé•ÊåáÂÆöAPIÁ´ØÁÇπ</div>
              </div>
            </div>
            
            <div class="form-section" style="margin-top: 24px;">
              <h3 style="margin-bottom: 16px; color: var(--text-primary);">ÂäüËÉΩ‰ΩøÁî®ËØ¥ÊòéÁÆ°ÁêÜ</h3>
              <div class="form-hint" style="margin-bottom: 16px; color: var(--text-secondary);">
                ÈÖçÁΩÆ‰∏ªÁ´ôÂêÑÂäüËÉΩÊ®°ÂùóÁöÑ‰ΩøÁî®ËØ¥ÊòéÔºåÂä©ÊâãÂ∞ÜÁªìÂêàËøô‰∫õËØ¥ÊòéÂíåAIÊô∫ËÉΩÂõûÁ≠îÁî®Êà∑ÈóÆÈ¢ò
              </div>
              
              <div id="functionGuidesContainer" style="display: grid; gap: 16px;">
                <!-- ÂäüËÉΩËØ¥ÊòéÈ°πÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
              </div>
              
              <button type="button" class="btn btn-outline btn-sm" id="btnAddFunctionGuide" style="margin-top: 16px;">
                ‚ûï Ê∑ªÂä†ÂäüËÉΩËØ¥Êòé
              </button>
            </div>
            
            <div class="form-actions" style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border-light);">
              <button type="button" class="btn btn-primary" id="btnSaveEvoSettings">‰øùÂ≠òËÆæÁΩÆ</button>
              <button type="button" class="btn btn-outline" id="btnResetEvoSettings">ÈáçÁΩÆ‰∏∫ÈªòËÆ§</button>
              <button type="button" class="btn btn-outline" id="btnSyncEvoSettings">ÂêåÊ≠•Âà∞‰∏ªÁ´ô</button>
            </div>
            
            <div id="evoSettingsStatus" style="margin-top: 16px; padding: 12px; border-radius: 6px; display: none;"></div>
          </div>
        </div>
        
        
        <!-- ‰∏≠Êû¢ÁÆ°ÂÆ∂Ê†áÁ≠æÈ°µ -->
        <div id="coreAdminViewTab" style="display:none;">
          <!-- È°µÈù¢Â§¥ÈÉ® - ‰ºòÂåñËÆæËÆ° -->
          <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:20px;padding:40px;margin-bottom:32px;box-shadow:0 10px 40px rgba(102,126,234,0.3);position:relative;overflow:hidden;">
            <!-- Ë£ÖÈ•∞ÊÄßËÉåÊôØÂÖÉÁ¥† -->
            <div style="position:absolute;top:-60px;right:-60px;width:200px;height:200px;background:rgba(255,255,255,0.1);border-radius:50%;backdrop-filter:blur(20px);"></div>
            <div style="position:absolute;bottom:-40px;left:-40px;width:150px;height:150px;background:rgba(255,255,255,0.08);border-radius:50%;backdrop-filter:blur(20px);"></div>
            <div style="position:absolute;top:50%;right:20%;width:100px;height:100px;background:rgba(255,255,255,0.05);border-radius:50%;backdrop-filter:blur(20px);"></div>
            
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:24px;position:relative;z-index:1;">
              <div style="flex:1;min-width:300px;">
                <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;">
                  <div style="width:72px;height:72px;background:rgba(255,255,255,0.25);backdrop-filter:blur(20px);border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:40px;border:2px solid rgba(255,255,255,0.3);box-shadow:0 8px 24px rgba(0,0,0,0.15);">ü§ñ</div>
                  <div>
                    <h2 style="margin:0 0 6px 0;font-size:32px;font-weight:800;color:#fff;letter-spacing:-0.5px;text-shadow:0 2px 8px rgba(0,0,0,0.2);">
                      Êô∫È∏Ω¬∑‰∏≠Êû¢ÁÆ°ÂÆ∂
                    </h2>
                    <p style="margin:0;color:rgba(255,255,255,0.95);font-size:15px;line-height:1.6;font-weight:400;">
                      ZhiPigeon Core Admin - AIÈ©±Âä®ÁöÑÊô∫ËÉΩÊú∫Âô®‰∫∫ÁÆ°ÁêÜÂëòÁ≥ªÁªü
                    </p>
                  </div>
                </div>
                <div style="display:flex;gap:20px;flex-wrap:wrap;margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.2);">
                  <div style="display:flex;align-items:center;gap:10px;color:rgba(255,255,255,0.95);font-size:14px;font-weight:500;">
                    <span style="width:8px;height:8px;background:#10b981;border-radius:50%;box-shadow:0 0 8px rgba(16,185,129,0.6);animation:pulse 2s ease-in-out infinite;"></span>
                    <span>üõ°Ô∏è ÂÆàÊä§Êï∞ÊçÆÁúüÂÆûÊÄß</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:10px;color:rgba(255,255,255,0.95);font-size:14px;font-weight:500;">
                    <span style="width:8px;height:8px;background:#3b82f6;border-radius:50%;box-shadow:0 0 8px rgba(59,130,246,0.6);animation:pulse 2s ease-in-out infinite;animation-delay:0.5s;"></span>
                    <span>‚ö° Ê∞∏ËøúÂú®Á∫ø</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:10px;color:rgba(255,255,255,0.95);font-size:14px;font-weight:500;">
                    <span style="width:8px;height:8px;background:#f59e0b;border-radius:50%;box-shadow:0 0 8px rgba(245,158,11,0.6);animation:pulse 2s ease-in-out infinite;animation-delay:1s;"></span>
                    <span>üéØ Êã•ÊúâÊúÄÁªàÊâßË°åÊùÉ</span>
                  </div>
                </div>
              </div>
              <div style="display:flex;gap:16px;flex-wrap:wrap;">
                <div style="background:rgba(255,255,255,0.25);backdrop-filter:blur(20px);padding:16px 24px;border-radius:14px;border:2px solid rgba(255,255,255,0.3);box-shadow:0 4px 16px rgba(0,0,0,0.1);transition:all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.35)';this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.25)';this.style.transform='translateY(0)'">
                  <div style="font-size:11px;color:rgba(255,255,255,0.85);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">ËøêË°åÁä∂ÊÄÅ</div>
                  <div style="font-size:18px;font-weight:700;color:#fff;display:flex;align-items:center;gap:8px;">
                    <span style="width:10px;height:10px;background:#10b981;border-radius:50%;box-shadow:0 0 12px rgba(16,185,129,0.8);animation:pulse 2s ease-in-out infinite;"></span>
                    <span>Âú®Á∫øËøêË°å</span>
                  </div>
                </div>
              </div>
            </div>
            
            <style>
              @keyframes pulse {
                0%, 100% { opacity: 1; transform: scale(1); }
                50% { opacity: 0.7; transform: scale(1.1); }
              }
            </style>
          </div>

          <!-- Á≥ªÁªüÁä∂ÊÄÅÂç°Áâá -->
          <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:24px;margin-bottom:32px;">
            <div style="background:linear-gradient(135deg, #e6f0ff 0%, #dbeafe 100%);border-radius:16px;padding:24px;box-shadow:0 4px 20px rgba(59,130,246,0.15);border:2px solid rgba(59,130,246,0.2);transition:transform 0.3s ease,box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 30px rgba(59,130,246,0.25)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 20px rgba(59,130,246,0.15)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
                <div style="font-size:14px;font-weight:600;color:#1e40af;text-transform:uppercase;letter-spacing:0.5px;">Á≥ªÁªüÂÅ•Â∫∑Â∫¶</div>
                <div style="font-size:24px;">üíô</div>
              </div>
              <div style="font-size:42px;font-weight:700;color:#1e293b;margin-bottom:8px;line-height:1;" id="coreAdminHealthScore">--</div>
              <div style="font-size:13px;color:#475569;font-weight:500;" id="coreAdminHealthStatus">Ê£ÄÊü•‰∏≠...</div>
            </div>
            
            <div style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border-radius:16px;padding:24px;box-shadow:0 4px 20px rgba(245,158,11,0.15);border:2px solid rgba(245,158,11,0.2);transition:transform 0.3s ease,box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 30px rgba(245,158,11,0.25)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 20px rgba(245,158,11,0.15)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
                <div style="font-size:14px;font-weight:600;color:#92400e;text-transform:uppercase;letter-spacing:0.5px;">APIÂÅ•Â∫∑Áéá</div>
                <div style="font-size:24px;">üíõ</div>
              </div>
              <div style="font-size:42px;font-weight:700;color:#1e293b;margin-bottom:8px;line-height:1;" id="coreAdminApiHealth">--</div>
              <div style="font-size:13px;color:#475569;font-weight:500;">ÂÆûÊó∂ÁõëÊéß‰∏≠</div>
            </div>
            
            <div style="background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);border-radius:16px;padding:24px;box-shadow:0 4px 20px rgba(16,185,129,0.15);border:2px solid rgba(16,185,129,0.2);transition:transform 0.3s ease,box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 30px rgba(16,185,129,0.25)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 20px rgba(16,185,129,0.15)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
                <div style="font-size:14px;font-weight:600;color:#065f46;text-transform:uppercase;letter-spacing:0.5px;">Êï∞ÊçÆÁúüÂÆûÊÄß</div>
                <div style="font-size:24px;">üíö</div>
              </div>
              <div style="font-size:42px;font-weight:700;color:#1e293b;margin-bottom:8px;line-height:1;" id="coreAdminDataTruth">--</div>
              <div style="font-size:13px;color:#475569;font-weight:500;">Â∑≤È™åËØÅÈÄöËøá</div>
            </div>
            
            <div style="background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);border-radius:16px;padding:24px;box-shadow:0 4px 20px rgba(236,72,153,0.15);border:2px solid rgba(236,72,153,0.2);transition:transform 0.3s ease,box-shadow 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 30px rgba(236,72,153,0.25)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 20px rgba(236,72,153,0.15)'">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
                <div style="font-size:14px;font-weight:600;color:#9f1239;text-transform:uppercase;letter-spacing:0.5px;">AIË∞ÉÁî®Ê¨°Êï∞</div>
                <div style="font-size:24px;">üíú</div>
              </div>
              <div style="font-size:42px;font-weight:700;color:#1e293b;margin-bottom:8px;line-height:1;" id="coreAdminAICalls">--</div>
              <div style="font-size:13px;color:#475569;font-weight:500;">‰ªäÊó•ÁªüËÆ°</div>
            </div>
          </div>

            <!-- Ê®°ÂûãÊé•ÂÖ•‰ø°ÊÅØ -->
            <div class="card" style="margin-bottom:32px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08);">
              <div class="card-header" style="border-bottom:2px solid #f1f5f9;padding-bottom:20px;">
                <h3 style="margin:0;font-size:20px;font-weight:700;color:#1e293b;display:flex;align-items:center;gap:10px;">
                  <span style="font-size:24px;">ü§ñ</span>
                  <span>Ê®°ÂûãÊé•ÂÖ•‰ø°ÊÅØ</span>
                </h3>
                <button class="btn btn-sm btn-outline" id="btnRefreshModelInfo" style="border-radius:8px;padding:8px 16px;">üîÑ Âà∑Êñ∞</button>
              </div>
              <div id="coreAdminModelInfo" style="padding:28px;">
                <!-- ‰∏ªË¶Å‰ø°ÊÅØÂç°Áâá -->
                <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));gap:20px;margin-bottom:28px;">
                  <div style="background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);border-radius:12px;padding:20px;border:1px solid #e2e8f0;transition:all 0.3s ease;" onmouseover="this.style.borderColor='#cbd5e1';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'" onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:40px;height:40px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;">üè¢</div>
                      <div>
                        <div style="font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">ÊúçÂä°Êèê‰æõÂïÜ</div>
                        <div id="coreAdminModelProvider" style="font-size:18px;font-weight:700;color:#1e293b;margin-top:4px;">Âä†ËΩΩ‰∏≠...</div>
                      </div>
                    </div>
                  </div>
                  
                  <div style="background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);border-radius:12px;padding:20px;border:1px solid #e2e8f0;transition:all 0.3s ease;" onmouseover="this.style.borderColor='#cbd5e1';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'" onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:40px;height:40px;background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;">üß†</div>
                      <div>
                        <div style="font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">Ê®°ÂûãÂêçÁß∞</div>
                        <div id="coreAdminModelName" style="font-size:18px;font-weight:700;color:#1e293b;margin-top:4px;">Âä†ËΩΩ‰∏≠...</div>
                      </div>
                    </div>
                  </div>
                  
                  <div style="background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);border-radius:12px;padding:20px;border:1px solid #e2e8f0;transition:all 0.3s ease;" onmouseover="this.style.borderColor='#cbd5e1';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'" onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:40px;height:40px;background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;">üîë</div>
                      <div style="flex:1;">
                        <div style="font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;margin-bottom:8px;">API KeyÁä∂ÊÄÅ</div>
                        <div id="coreAdminApiKeyStatus" style="font-size:13px;padding:6px 14px;border-radius:8px;display:inline-block;font-weight:600;">Âä†ËΩΩ‰∏≠...</div>
                      </div>
                    </div>
                  </div>
                  
                  <div style="background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);border-radius:12px;padding:20px;border:1px solid #e2e8f0;transition:all 0.3s ease;" onmouseover="this.style.borderColor='#cbd5e1';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'" onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:40px;height:40px;background:linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;">üîå</div>
                      <div style="flex:1;">
                        <div style="font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;margin-bottom:8px;">ËøûÊé•Áä∂ÊÄÅ</div>
                        <div id="coreAdminConnectionStatus" style="font-size:13px;padding:6px 14px;border-radius:8px;display:inline-block;font-weight:600;">Âä†ËΩΩ‰∏≠...</div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- ÈÖçÁΩÆËØ¶ÊÉÖ -->
                <div style="background:#f8fafc;border-radius:12px;padding:24px;margin-bottom:24px;border:1px solid #e2e8f0;">
                  <div style="font-size:14px;font-weight:700;color:#1e293b;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                    <span>‚öôÔ∏è</span>
                    <span>ÈÖçÁΩÆËØ¶ÊÉÖ</span>
                  </div>
                  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));gap:20px;">
                    <div>
                      <div style="font-size:12px;color:#64748b;margin-bottom:6px;font-weight:500;">API KeyÈ¢ÑËßà</div>
                      <div id="coreAdminApiKeyPreview" style="font-size:13px;color:#475569;font-family:'Monaco','Menlo','Courier New',monospace;background:#fff;padding:8px 12px;border-radius:6px;border:1px solid #e2e8f0;">--</div>
                    </div>
                    <div>
                      <div style="font-size:12px;color:#64748b;margin-bottom:6px;font-weight:500;">APIÁ´ØÁÇπ</div>
                      <div id="coreAdminApiBase" style="font-size:13px;color:#475569;font-family:'Monaco','Menlo','Courier New',monospace;background:#fff;padding:8px 12px;border-radius:6px;border:1px solid #e2e8f0;word-break:break-all;">--</div>
                    </div>
                    <div>
                      <div style="font-size:12px;color:#64748b;margin-bottom:6px;font-weight:500;">ÊØèÂ∞èÊó∂ÊúÄÂ§ßË∞ÉÁî®</div>
                      <div id="coreAdminMaxCalls" style="font-size:16px;font-weight:600;color:#1e293b;background:#fff;padding:8px 12px;border-radius:6px;border:1px solid #e2e8f0;">--</div>
                    </div>
                    <div>
                      <div style="font-size:12px;color:#64748b;margin-bottom:6px;font-weight:500;">ÁΩÆ‰ø°Â∫¶ÈòàÂÄº</div>
                      <div id="coreAdminConfidence" style="font-size:16px;font-weight:600;color:#1e293b;background:#fff;padding:8px 12px;border-radius:6px;border:1px solid #e2e8f0;">--</div>
                    </div>
                  </div>
                </div>
                
                <!-- Ë∞ÉÁî®ÁªüËÆ° -->
                <div style="background:linear-gradient(135deg, #667eea15 0%, #764ba215 100%);border-radius:12px;padding:24px;border:1px solid rgba(102,126,234,0.2);">
                  <div style="font-size:16px;font-weight:700;color:#1e293b;margin-bottom:20px;display:flex;align-items:center;gap:10px;">
                    <span style="font-size:20px;">üìä</span>
                    <span>Ë∞ÉÁî®ÁªüËÆ°</span>
                  </div>
                  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:20px;">
                    <div style="background:#fff;border-radius:10px;padding:20px;border:1px solid #e2e8f0;text-align:center;">
                      <div style="font-size:12px;color:#64748b;margin-bottom:8px;font-weight:500;">ÊÄªË∞ÉÁî®Ê¨°Êï∞</div>
                      <div id="coreAdminTotalCalls" style="font-size:28px;font-weight:700;color:#667eea;line-height:1;">--</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:20px;border:1px solid #e2e8f0;text-align:center;">
                      <div style="font-size:12px;color:#64748b;margin-bottom:8px;font-weight:500;">ÊúÄËøë1Â∞èÊó∂</div>
                      <div id="coreAdminRecentCalls" style="font-size:28px;font-weight:700;color:#f5576c;line-height:1;">--</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:20px;border:1px solid #e2e8f0;text-align:center;">
                      <div style="font-size:12px;color:#64748b;margin-bottom:8px;font-weight:500;">ÊàêÂäüÁéá</div>
                      <div id="coreAdminSuccessRate" style="font-size:28px;font-weight:700;color:#43e97b;line-height:1;">--</div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:20px;border:1px solid #e2e8f0;text-align:center;">
                      <div style="font-size:12px;color:#64748b;margin-bottom:8px;font-weight:500;">Âπ≥ÂùáÁΩÆ‰ø°Â∫¶</div>
                      <div id="coreAdminAvgConfidence" style="font-size:28px;font-weight:700;color:#4facfe;line-height:1;">--</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ÂäüËÉΩÊ®°ÂùóÂå∫Âüü - ‰ºòÂåñÂ∏ÉÂ±Ä -->
            <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:24px;margin-bottom:24px;">
              <!-- AIÁÆ°ÁêÜÂª∫ËÆÆ -->
              <div class="card" style="margin-bottom:0;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08);transition:all 0.3s ease;background:linear-gradient(135deg, #fff 0%, #fef3c7 5%);border:1px solid rgba(245,158,11,0.1);" onmouseover="this.style.boxShadow='0 8px 30px rgba(245,158,11,0.2)';this.style.transform='translateY(-4px)';this.style.borderColor='rgba(245,158,11,0.3)'" onmouseout="this.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)';this.style.transform='translateY(0)';this.style.borderColor='rgba(245,158,11,0.1)'">
                <div class="card-header" style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border-bottom:2px solid #fbbf24;padding-bottom:20px;border-radius:16px 16px 0 0;">
                  <h3 style="margin:0;font-size:18px;font-weight:700;color:#78350f;display:flex;align-items:center;gap:10px;">
                    <span style="width:36px;height:36px;background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;">üí°</span>
                    <span>AIÁÆ°ÁêÜÂª∫ËÆÆ</span>
                  </h3>
                  <button class="btn btn-sm btn-primary" id="btnRefreshAdvice" style="border-radius:8px;padding:8px 16px;background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);border:none;color:#fff;font-weight:600;box-shadow:0 2px 8px rgba(245,158,11,0.3);">üîÑ Âà∑Êñ∞</button>
                </div>
                <div id="coreAdminAdvice" style="padding:24px;min-height:200px;">
                  <p class="muted" style="text-align:center;color:#94a3b8;padding:40px 0;">Ê≠£Âú®Ëé∑ÂèñAIÁÆ°ÁêÜÂª∫ËÆÆ...</p>
                </div>
              </div>

              <!-- Êï∞ÊçÆÂàÜÊûê -->
              <div class="card" style="margin-bottom:0;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08);transition:all 0.3s ease;background:linear-gradient(135deg, #fff 0%, #dbeafe 5%);border:1px solid rgba(59,130,246,0.1);" onmouseover="this.style.boxShadow='0 8px 30px rgba(59,130,246,0.2)';this.style.transform='translateY(-4px)';this.style.borderColor='rgba(59,130,246,0.3)'" onmouseout="this.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)';this.style.transform='translateY(0)';this.style.borderColor='rgba(59,130,246,0.1)'">
                <div class="card-header" style="background:linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);border-bottom:2px solid #3b82f6;padding-bottom:20px;border-radius:16px 16px 0 0;">
                  <h3 style="margin:0;font-size:18px;font-weight:700;color:#1e3a8a;display:flex;align-items:center;gap:10px;">
                    <span style="width:36px;height:36px;background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;">üìä</span>
                    <span>Êï∞ÊçÆÂàÜÊûê</span>
                  </h3>
                  <button class="btn btn-sm btn-outline" id="btnRefreshAnalytics" style="border-radius:8px;padding:8px 16px;border-color:#3b82f6;color:#3b82f6;font-weight:600;">üîÑ Âà∑Êñ∞</button>
                </div>
                <div id="coreAdminAnalytics" style="padding:24px;min-height:200px;">
                  <p class="muted" style="text-align:center;color:#94a3b8;padding:40px 0;">Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆÂàÜÊûê...</p>
                </div>
              </div>
            </div>

            <!-- APIÁõëÁÆ° - ÂÖ®ÂÆΩÊòæÁ§∫ -->
            <div class="card" style="margin-bottom:24px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08);transition:all 0.3s ease;background:linear-gradient(135deg, #fff 0%, #e0e7ff 5%);border:1px solid rgba(99,102,241,0.1);" onmouseover="this.style.boxShadow='0 8px 30px rgba(99,102,241,0.2)';this.style.transform='translateY(-4px)';this.style.borderColor='rgba(99,102,241,0.3)'" onmouseout="this.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)';this.style.transform='translateY(0)';this.style.borderColor='rgba(99,102,241,0.1)'">
              <div class="card-header" style="background:linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);border-bottom:2px solid #6366f1;padding-bottom:20px;border-radius:16px 16px 0 0;">
                <h3 style="margin:0;font-size:18px;font-weight:700;color:#312e81;display:flex;align-items:center;gap:10px;">
                  <span style="width:36px;height:36px;background:linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;">üîç</span>
                  <span>APIÁõëÁÆ°</span>
                </h3>
                <button class="btn btn-sm btn-outline" id="btnRefreshApis" style="border-radius:8px;padding:8px 16px;border-color:#6366f1;color:#6366f1;font-weight:600;">üîÑ Âà∑Êñ∞</button>
              </div>
              <div id="coreAdminApiList" style="padding:24px;">
                <p class="muted" style="text-align:center;color:#94a3b8;padding:40px 0;">Ê≠£Âú®Âä†ËΩΩAPIÂàóË°®...</p>
              </div>
            </div>

            <!-- Â≠¶‰π†Á≥ªÁªü‰∏éËá™Âä®Áª¥Êä§ -->
            <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:24px;">
              <!-- Â≠¶‰π†Á≥ªÁªü -->
              <div class="card" style="margin-bottom:0;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08);transition:all 0.3s ease;background:linear-gradient(135deg, #fff 0%, #f3e8ff 5%);border:1px solid rgba(168,85,247,0.1);" onmouseover="this.style.boxShadow='0 8px 30px rgba(168,85,247,0.2)';this.style.transform='translateY(-4px)';this.style.borderColor='rgba(168,85,247,0.3)'" onmouseout="this.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)';this.style.transform='translateY(0)';this.style.borderColor='rgba(168,85,247,0.1)'">
                <div class="card-header" style="background:linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);border-bottom:2px solid #a855f7;padding-bottom:20px;border-radius:16px 16px 0 0;">
                  <h3 style="margin:0;font-size:18px;font-weight:700;color:#581c87;display:flex;align-items:center;gap:10px;">
                    <span style="width:36px;height:36px;background:linear-gradient(135deg, #a855f7 0%, #9333ea 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;">üß†</span>
                    <span>Â≠¶‰π†Á≥ªÁªü</span>
                  </h3>
                  <button class="btn btn-sm btn-outline" id="btnRefreshLearning" style="border-radius:8px;padding:8px 16px;border-color:#a855f7;color:#a855f7;font-weight:600;">üîÑ Âà∑Êñ∞</button>
                </div>
                <div id="coreAdminLearning" style="padding:24px;min-height:200px;">
                  <p class="muted" style="text-align:center;color:#94a3b8;padding:40px 0;">Ê≠£Âú®Âä†ËΩΩÂ≠¶‰π†Êï∞ÊçÆ...</p>
                </div>
              </div>

              <!-- Ëá™Âä®Áª¥Êä§ -->
              <div class="card" style="margin-bottom:0;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08);transition:all 0.3s ease;background:linear-gradient(135deg, #fff 0%, #fef3c7 5%);border:1px solid rgba(245,158,11,0.1);" onmouseover="this.style.boxShadow='0 8px 30px rgba(245,158,11,0.2)';this.style.transform='translateY(-4px)';this.style.borderColor='rgba(245,158,11,0.3)'" onmouseout="this.style.boxShadow='0 4px 20px rgba(0,0,0,0.08)';this.style.transform='translateY(0)';this.style.borderColor='rgba(245,158,11,0.1)'">
                <div class="card-header" style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border-bottom:2px solid #f59e0b;padding-bottom:20px;border-radius:16px 16px 0 0;">
                  <h3 style="margin:0;font-size:18px;font-weight:700;color:#78350f;display:flex;align-items:center;gap:10px;">
                    <span style="width:36px;height:36px;background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;">üîß</span>
                    <span>Ëá™Âä®Áª¥Êä§</span>
                  </h3>
                  <button class="btn btn-sm btn-outline" id="btnRefreshMaintenance" style="border-radius:8px;padding:8px 16px;border-color:#f59e0b;color:#f59e0b;font-weight:600;">üîÑ Âà∑Êñ∞</button>
                </div>
                <div id="coreAdminMaintenance" style="padding:24px;min-height:200px;">
                  <p class="muted" style="text-align:center;color:#94a3b8;padding:40px 0;">Ê≠£Âú®Âä†ËΩΩÁª¥Êä§‰ø°ÊÅØ...</p>
                </div>
              </div>
            </div>

            <!-- Êô∫ËÉΩÂäüËÉΩÊ®°Âùó -->
            <div class="card" style="margin-top:32px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08);background:linear-gradient(135deg, #fff 0%, #f0f9ff 5%);border:2px solid rgba(14,165,233,0.2);">
              <div class="card-header" style="background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);border-bottom:2px solid #0ea5e9;padding-bottom:20px;border-radius:16px 16px 0 0;">
                <h3 style="margin:0;font-size:20px;font-weight:700;color:#0c4a6e;display:flex;align-items:center;gap:10px;">
                  <span style="width:40px;height:40px;background:linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;color:#fff;">üß†</span>
                  <span>Êô∫ËÉΩÂäüËÉΩÊ®°Âùó</span>
                </h3>
                <p style="margin:8px 0 0 0;font-size:13px;color:#0369a1;font-weight:500;">AIÈ©±Âä®ÁöÑÊô∫ËÉΩÁÆ°ÁêÜÂäüËÉΩ</p>
              </div>
              <div style="padding:28px;">
                <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:20px;">
                  <!-- ÂÜ≥Á≠ñÂºïÊìé -->
                  <div style="background:#fff;border-radius:12px;padding:20px;border:2px solid #e0f2fe;transition:all 0.3s ease;cursor:pointer;" 
                       onmouseover="this.style.borderColor='#0ea5e9';this.style.boxShadow='0 4px 12px rgba(14,165,233,0.2)';this.style.transform='translateY(-2px)'" 
                       onmouseout="this.style.borderColor='#e0f2fe';this.style.boxShadow='none';this.style.transform='translateY(0)'"
                       onclick="loadIntelligentAdvice()">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:48px;height:48px;background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;">‚ö°</div>
                      <div style="flex:1;">
                        <h4 style="margin:0;font-size:16px;font-weight:700;color:#1e293b;">ÂÜ≥Á≠ñÂºïÊìé</h4>
                        <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">Êô∫ËÉΩÂÜ≥Á≠ñÂª∫ËÆÆ</p>
                      </div>
                    </div>
                    <div id="intelligentAdvicePreview" style="font-size:13px;color:#475569;line-height:1.5;min-height:40px;">ÁÇπÂáªÊü•ÁúãÊô∫ËÉΩÂª∫ËÆÆ</div>
                  </div>

                  <!-- È¢ÑÊµãÁª¥Êä§ -->
                  <div style="background:#fff;border-radius:12px;padding:20px;border:2px solid #fef3c7;transition:all 0.3s ease;cursor:pointer;" 
                       onmouseover="this.style.borderColor='#f59e0b';this.style.boxShadow='0 4px 12px rgba(245,158,11,0.2)';this.style.transform='translateY(-2px)'" 
                       onmouseout="this.style.borderColor='#fef3c7';this.style.boxShadow='none';this.style.transform='translateY(0)'"
                       onclick="loadIntelligentPredictions()">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:48px;height:48px;background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;">üîÆ</div>
                      <div style="flex:1;">
                        <h4 style="margin:0;font-size:16px;font-weight:700;color:#1e293b;">È¢ÑÊµãÁª¥Êä§</h4>
                        <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">È¢ÑÊµãÁ≥ªÁªüÈóÆÈ¢ò</p>
                      </div>
                    </div>
                    <div id="intelligentPredictionsPreview" style="font-size:13px;color:#475569;line-height:1.5;min-height:40px;">ÁÇπÂáªÊü•ÁúãÈ¢ÑÊµã‰ø°ÊÅØ</div>
                  </div>

                  <!-- Â∑•‰ΩúÊµÅÂºïÊìé -->
                  <div style="background:#fff;border-radius:12px;padding:20px;border:2px solid #dbeafe;transition:all 0.3s ease;cursor:pointer;" 
                       onmouseover="this.style.borderColor='#3b82f6';this.style.boxShadow='0 4px 12px rgba(59,130,246,0.2)';this.style.transform='translateY(-2px)'" 
                       onmouseout="this.style.borderColor='#dbeafe';this.style.boxShadow='none';this.style.transform='translateY(0)'"
                       onclick="loadIntelligentWorkflows()">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:48px;height:48px;background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;">üîÑ</div>
                      <div style="flex:1;">
                        <h4 style="margin:0;font-size:16px;font-weight:700;color:#1e293b;">Â∑•‰ΩúÊµÅÂºïÊìé</h4>
                        <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">Ëá™Âä®ÂåñÂ∑•‰ΩúÊµÅ</p>
                      </div>
                    </div>
                    <div id="intelligentWorkflowsPreview" style="font-size:13px;color:#475569;line-height:1.5;min-height:40px;">ÁÇπÂáªÊü•ÁúãÂ∑•‰ΩúÊµÅ</div>
                  </div>

                  <!-- ÂëäË≠¶Á≥ªÁªü -->
                  <div style="background:#fff;border-radius:12px;padding:20px;border:2px solid #fee2e2;transition:all 0.3s ease;cursor:pointer;" 
                       onmouseover="this.style.borderColor='#ef4444';this.style.boxShadow='0 4px 12px rgba(239,68,68,0.2)';this.style.transform='translateY(-2px)'" 
                       onmouseout="this.style.borderColor='#fee2e2';this.style.boxShadow='none';this.style.transform='translateY(0)'"
                       onclick="loadIntelligentAlerts()">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:48px;height:48px;background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;">üö®</div>
                      <div style="flex:1;">
                        <h4 style="margin:0;font-size:16px;font-weight:700;color:#1e293b;">ÂëäË≠¶Á≥ªÁªü</h4>
                        <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">Êô∫ËÉΩÂëäË≠¶ÁÆ°ÁêÜ</p>
                      </div>
                    </div>
                    <div id="intelligentAlertsPreview" style="font-size:13px;color:#475569;line-height:1.5;min-height:40px;">ÁÇπÂáªÊü•ÁúãÂëäË≠¶</div>
                  </div>

                  <!-- Ëá™ÈÄÇÂ∫î‰ºòÂåñ -->
                  <div style="background:#fff;border-radius:12px;padding:20px;border:2px solid #d1fae5;transition:all 0.3s ease;cursor:pointer;" 
                       onmouseover="this.style.borderColor='#10b981';this.style.boxShadow='0 4px 12px rgba(16,185,129,0.2)';this.style.transform='translateY(-2px)'" 
                       onmouseout="this.style.borderColor='#d1fae5';this.style.boxShadow='none';this.style.transform='translateY(0)'"
                       onclick="loadIntelligentOptimization()">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:48px;height:48px;background:linear-gradient(135deg, #10b981 0%, #059669 100%);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;">‚öôÔ∏è</div>
                      <div style="flex:1;">
                        <h4 style="margin:0;font-size:16px;font-weight:700;color:#1e293b;">Ëá™ÈÄÇÂ∫î‰ºòÂåñ</h4>
                        <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">Ëá™Âä®ÊÄßËÉΩ‰ºòÂåñ</p>
                      </div>
                    </div>
                    <div id="intelligentOptimizationPreview" style="font-size:13px;color:#475569;line-height:1.5;min-height:40px;">ÁÇπÂáªÊü•Áúã‰ºòÂåñÁä∂ÊÄÅ</div>
                  </div>

                  <!-- Áü•ËØÜÂõæË∞± -->
                  <div style="background:#fff;border-radius:12px;padding:20px;border:2px solid #f3e8ff;transition:all 0.3s ease;cursor:pointer;" 
                       onmouseover="this.style.borderColor='#a855f7';this.style.boxShadow='0 4px 12px rgba(168,85,247,0.2)';this.style.transform='translateY(-2px)'" 
                       onmouseout="this.style.borderColor='#f3e8ff';this.style.boxShadow='none';this.style.transform='translateY(0)'"
                       onclick="loadIntelligentKnowledge()">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:48px;height:48px;background:linear-gradient(135deg, #a855f7 0%, #9333ea 100%);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;">üï∏Ô∏è</div>
                      <div style="flex:1;">
                        <h4 style="margin:0;font-size:16px;font-weight:700;color:#1e293b;">Áü•ËØÜÂõæË∞±</h4>
                        <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">Êô∫ËÉΩÁü•ËØÜÊü•ËØ¢</p>
                      </div>
                    </div>
                    <div id="intelligentKnowledgePreview" style="font-size:13px;color:#475569;line-height:1.5;min-height:40px;">ÁÇπÂáªÊü•ËØ¢Áü•ËØÜÂõæË∞±</div>
                  </div>

                  <!-- Êô∫ËÉΩÊä•Âëä -->
                  <div style="background:#fff;border-radius:12px;padding:20px;border:2px solid #fce7f3;transition:all 0.3s ease;cursor:pointer;" 
                       onmouseover="this.style.borderColor='#ec4899';this.style.boxShadow='0 4px 12px rgba(236,72,153,0.2)';this.style.transform='translateY(-2px)'" 
                       onmouseout="this.style.borderColor='#fce7f3';this.style.boxShadow='none';this.style.transform='translateY(0)'"
                       onclick="loadIntelligentReports()">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                      <div style="width:48px;height:48px;background:linear-gradient(135deg, #ec4899 0%, #db2777 100%);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;">üìä</div>
                      <div style="flex:1;">
                        <h4 style="margin:0;font-size:16px;font-weight:700;color:#1e293b;">Êô∫ËÉΩÊä•Âëä</h4>
                        <p style="margin:4px 0 0 0;font-size:12px;color:#64748b;">AIÁîüÊàêÊä•Âëä</p>
                      </div>
                    </div>
                    <div id="intelligentReportsPreview" style="font-size:13px;color:#475569;line-height:1.5;min-height:40px;">ÁÇπÂáªÊü•ÁúãÊä•Âëä</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ÂÖ¨ÂëäÁºñËæëÊ®°ÊÄÅÊ°Ü -->
  <div id="announcementModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">ÂèëÂ∏ÉÊñ∞ÂÖ¨Âëä</h3>
        <button class="btn btn-ghost btn-sm" id="closeModalBtn">‚úï</button>
      </div>
      <form id="announcementForm">
        <input type="hidden" id="announcementId" />
        <div class="form-group">
          <label>ÂÖ¨ÂëäÂÜÖÂÆπ <span class="required">*</span></label>
          <textarea id="announcementContent" rows="6" placeholder="ËØ∑ËæìÂÖ•ÂÖ¨ÂëäÂÜÖÂÆπ..." required style="font-family: inherit;"></textarea>
        </div>
        <div class="form-group">
          <label style="flex-direction: row; align-items: center; cursor: pointer;">
            <input type="checkbox" id="announcementActive" checked style="width: auto; margin-right: 8px;" /> 
            <span>Á´ãÂç≥ÂèëÂ∏ÉÔºàÂèñÊ∂àÂãæÈÄâÂàô‰øùÂ≠ò‰∏∫ËçâÁ®øÔºâ</span>
          </label>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-outline" id="cancelBtn">ÂèñÊ∂à</button>
          <button type="submit" class="btn btn-primary">‰øùÂ≠ò</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Áî®Êà∑‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü -->
  <div class="announcement-modal" id="userInfoModal" style="display:none;">
    <div class="announcement-modal-content" style="max-width:500px;">
      <div class="announcement-modal-header">
        <h3 class="announcement-modal-title">
          <span>üë§</span>
          <span>Ë¥¶Êà∑‰ø°ÊÅØ</span>
        </h3>
        <button class="announcement-modal-close" onclick="closeUserInfoModal()">√ó</button>
      </div>
      <div class="announcement-modal-body">
        <!-- Êü•ÁúãÊ®°Âºè -->
        <div id="userInfoViewMode">
          <div style="text-align:center;padding:20px 0;">
            <div style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);margin:0 auto 20px;display:flex;align-items:center;justify-content:center;font-size:40px;color:#fff;box-shadow:0 4px 12px rgba(102,126,234,0.3);background-size:cover;background-position:center;background-repeat:no-repeat;" id="userAvatarDisplay">üë§</div>
            <h4 style="margin:0 0 10px;font-size:18px;color:#1f2937;" id="userNameDisplay">Áî®Êà∑Âêç</h4>
            <p style="margin:0;color:#6b7280;font-size:14px;" id="userEmailDisplay">user@example.com</p>
          </div>
          <div style="border-top:1px solid #e5e7eb;padding:20px 0;">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f3f4f6;">
              <span style="color:#6b7280;font-size:14px;">Ë¥¶Êà∑Á±ªÂûã</span>
              <span style="color:#1f2937;font-weight:600;font-size:14px;" id="userTypeDisplay">ÁÆ°ÁêÜÂëò</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f3f4f6;">
              <span style="color:#6b7280;font-size:14px;">Ê≥®ÂÜåÊó∂Èó¥</span>
              <span style="color:#1f2937;font-weight:600;font-size:14px;" id="userRegisterDate">2024-01-01</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;">
              <span style="color:#6b7280;font-size:14px;">ÊùÉÈôêÁ∫ßÂà´</span>
              <span style="color:#1f2937;font-weight:600;font-size:14px;" id="userRoleDisplay">ÁÆ°ÁêÜÂëò</span>
            </div>
          </div>
          <div style="padding-top:20px;border-top:1px solid #e5e7eb;display:flex;gap:10px;">
            <button class="btn btn-primary" style="flex:1;" onclick="enterEditUserInfoMode()">‚úèÔ∏è ÁºñËæëËµÑÊñô</button>
            <button class="btn btn-outline" style="flex:1;" onclick="closeUserInfoModal(); showSettingsModal();">‚öôÔ∏è Á≥ªÁªüËÆæÁΩÆ</button>
            <button class="btn btn-outline" style="flex:1;" onclick="closeUserInfoModal()">ÂÖ≥Èó≠</button>
          </div>
        </div>
        
        <!-- ÁºñËæëÊ®°Âºè -->
        <div id="userInfoEditMode" style="display:none;">
          <div style="text-align:center;padding:20px 0;">
            <div style="position:relative;display:inline-block;margin-bottom:20px;">
              <div style="width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);margin:0 auto;display:flex;align-items:center;justify-content:center;font-size:50px;color:#fff;box-shadow:0 4px 12px rgba(102,126,234,0.3);background-size:cover;background-position:center;background-repeat:no-repeat;border:3px solid #fff;" id="userAvatarEditDisplay">üë§</div>
              <label for="userAvatarInput" style="position:absolute;bottom:0;right:0;width:36px;height:36px;background:#2563eb;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 8px rgba(37,99,235,0.3);border:3px solid #fff;">
                <span style="font-size:18px;">üì∑</span>
              </label>
              <input type="file" id="userAvatarInput" accept="image/*" style="display:none;" />
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;text-align:left;margin-bottom:8px;color:#6b7280;font-size:14px;font-weight:600;">ÊòµÁß∞</label>
              <input type="text" id="userNameInput" placeholder="ËØ∑ËæìÂÖ•ÊòµÁß∞" style="width:100%;padding:10px 12px;border-radius:8px;border:2px solid #e5e7eb;font-size:14px;outline:none;transition:border-color 0.2s;" />
              <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;text-align:left;">ÊòµÁß∞Â∞ÜÊòæÁ§∫Âú®Ë¥¶Êà∑ÁïåÈù¢ÂíåÈ°∂ÈÉ®ÂØºËà™Ê†è</p>
            </div>
          </div>
          <div style="padding-top:20px;border-top:1px solid #e5e7eb;display:flex;gap:10px;">
            <button class="btn btn-primary" style="flex:1;" onclick="saveUserInfo()">üíæ ‰øùÂ≠ò</button>
            <button class="btn btn-outline" style="flex:1;" onclick="cancelEditUserInfo()">ÂèñÊ∂à</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
  <div class="announcement-modal" id="settingsModal" style="display:none;">
    <div class="announcement-modal-content" style="max-width:600px;max-height:80vh;overflow-y:auto;">
      <div class="announcement-modal-header">
        <h3 class="announcement-modal-title">
          <span>‚öôÔ∏è</span>
          <span>ËÆæÁΩÆ</span>
        </h3>
        <button class="announcement-modal-close" onclick="closeSettingsModal()">√ó</button>
      </div>
      <div class="announcement-modal-body">
        <div style="padding:24px 0;">
          <!-- Â§ñËßÇËÆæÁΩÆ -->
          <div style="margin-bottom:32px;">
            <h4 style="margin:0 0 16px;font-size:14px;font-weight:600;color:#1f2937;text-transform:uppercase;letter-spacing:0.5px;">üé® Â§ñËßÇËÆæÁΩÆ</h4>
            <div style="background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);border-radius:12px;padding:20px;border:1px solid #e2e8f0;">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div style="font-size:15px;font-weight:500;color:#1e293b;margin-bottom:4px;">‰∏ªÈ¢òÊ®°Âºè</div>
                  <div style="font-size:12px;color:#64748b;">ÂàáÊç¢ÊµÖËâ≤/Ê∑±Ëâ≤‰∏ªÈ¢ò</div>
                </div>
                <button class="btn btn-sm" id="btnToggleThemeInModal" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;padding:10px 20px;border-radius:8px;font-weight:500;box-shadow:0 2px 8px rgba(102,126,234,0.3);transition:all 0.2s;cursor:pointer;">üåô ÂàáÊç¢‰∏ªÈ¢ò</button>
              </div>
            </div>
          </div>
          
          <!-- Êï∞ÊçÆÁÆ°ÁêÜ -->
          <div style="margin-bottom:32px;">
            <h4 style="margin:0 0 16px;font-size:14px;font-weight:600;color:#1f2937;text-transform:uppercase;letter-spacing:0.5px;">üíæ Êï∞ÊçÆÁÆ°ÁêÜ</h4>
            <div style="display:flex;flex-direction:column;gap:12px;">
              <button class="btn btn-outline" id="btnBackupDataInModal" style="width:100%;justify-content:flex-start;padding:16px 20px;border-radius:12px;border:1px solid #e2e8f0;background:#fff;transition:all 0.2s;text-align:left;">
                <div style="display:flex;align-items:center;gap:12px;flex:1;">
                  <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);display:flex;align-items:center;justify-content:center;font-size:20px;">üíæ</div>
                  <div style="flex:1;">
                    <div style="font-size:15px;font-weight:500;color:#1e293b;margin-bottom:4px;">Â§á‰ªΩÊï∞ÊçÆ</div>
                    <div style="font-size:12px;color:#64748b;">ÂØºÂá∫ÊâÄÊúâÈ∏ΩÂ≠êÊï∞ÊçÆÂà∞Êú¨Âú∞Êñá‰ª∂</div>
                  </div>
                </div>
              </button>
              <button class="btn btn-outline" id="btnExportDataInModal" style="width:100%;justify-content:flex-start;padding:16px 20px;border-radius:12px;border:1px solid #e2e8f0;background:#fff;transition:all 0.2s;text-align:left;">
                <div style="display:flex;align-items:center;gap:12px;flex:1;">
                  <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);display:flex;align-items:center;justify-content:center;font-size:20px;">üì•</div>
                  <div style="flex:1;">
                    <div style="font-size:15px;font-weight:500;color:#1e293b;margin-bottom:4px;">ÂØºÂá∫Êï∞ÊçÆ</div>
                    <div style="font-size:12px;color:#64748b;">ÂØºÂá∫‰∏∫JSONÊ†ºÂºèÊñá‰ª∂</div>
                  </div>
                </div>
              </button>
              <button class="btn btn-outline" id="btnImportDataInModal" style="width:100%;justify-content:flex-start;padding:16px 20px;border-radius:12px;border:1px solid #e2e8f0;background:#fff;transition:all 0.2s;text-align:left;">
                <div style="display:flex;align-items:center;gap:12px;flex:1;">
                  <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);display:flex;align-items:center;justify-content:center;font-size:20px;">üì§</div>
                  <div style="flex:1;">
                    <div style="font-size:15px;font-weight:500;color:#1e293b;margin-bottom:4px;">ÂØºÂÖ•Êï∞ÊçÆ</div>
                    <div style="font-size:12px;color:#64748b;">‰ªéJSONÊñá‰ª∂ÂØºÂÖ•Êï∞ÊçÆ</div>
                  </div>
                </div>
              </button>
            </div>
          </div>
          
          <!-- Êô∫ËÉΩÁÆ°ÁêÜ -->
          <div style="margin-bottom:32px;">
            <h4 style="margin:0 0 16px;font-size:14px;font-weight:600;color:#1f2937;text-transform:uppercase;letter-spacing:0.5px;">‚öôÔ∏è Êô∫ËÉΩÁÆ°ÁêÜ</h4>
            <div style="background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);border-radius:12px;padding:20px;border:1px solid #bae6fd;">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;">‚öôÔ∏è</div>
                <div style="flex:1;">
                  <div style="font-size:15px;font-weight:500;color:#1e293b;margin-bottom:4px;">ÁÆ°ÁêÜÂäüËÉΩ</div>
                  <div style="font-size:12px;color:#64748b;">Êô∫ËÉΩÁÆ°ÁêÜÂäüËÉΩÂ∑≤ÈõÜÊàêÂú®Â∑¶‰æßËèúÂçï‰∏≠</div>
                </div>
              </div>
              <div style="display:flex;flex-direction:column;gap:8px;margin-top:12px;">
                <div style="font-size:13px;color:#64748b;padding:8px;background:rgba(255,255,255,0.5);border-radius:6px;">‚Ä¢ ÂÖ¨ÂëäÁÆ°ÁêÜÔºöÂèëÂ∏ÉÂíåÁÆ°ÁêÜÁ≥ªÁªüÂÖ¨Âëä</div>
                <div style="font-size:13px;color:#64748b;padding:8px;background:rgba(255,255,255,0.5);border-radius:6px;">‚Ä¢ Áî®Êà∑ÁÆ°ÁêÜÔºöÁÆ°ÁêÜÁî®Êà∑Ë¥¶Êà∑</div>
                <div style="font-size:13px;color:#64748b;padding:8px;background:rgba(255,255,255,0.5);border-radius:6px;">‚Ä¢ Á≥ªÁªüËÆæÁΩÆÔºöÈÖçÁΩÆÁ≥ªÁªüÂèÇÊï∞</div>
                <div style="font-size:13px;color:#64748b;padding:8px;background:rgba(255,255,255,0.5);border-radius:6px;">‚Ä¢ EvoËÆæÁΩÆÔºöÈÖçÁΩÆAIÂä©Êâã</div>
              </div>
            </div>
          </div>
          
          <!-- ÂÖ≥‰∫é -->
          <div style="margin-bottom:32px;">
            <h4 style="margin:0 0 16px;font-size:14px;font-weight:600;color:#1f2937;text-transform:uppercase;letter-spacing:0.5px;">‚ÑπÔ∏è ÂÖ≥‰∫é</h4>
            <div style="background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);border-radius:12px;padding:20px;border:1px solid #e2e8f0;">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;box-shadow:0 4px 12px rgba(102,126,234,0.3);">üê¶</div>
                <div style="flex:1;">
                  <div style="font-size:16px;font-weight:600;color:#1e293b;margin-bottom:4px;">Êô∫È∏ΩÔΩúPigeonAI‚Äî‚ÄîÊô∫ËÉΩÁÆ°ÁêÜÁ≥ªÁªü</div>
                  <div style="font-size:13px;color:#64748b;">ÊØèÂè™È∏ΩÂ≠ê, ÁöÜÊòØËµõÁ∫ß ÔΩúEvery Pigeon, Race-Grade</div>
                </div>
              </div>
              <div style="padding-top:12px;border-top:1px solid #e2e8f0;margin-top:12px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                  <span style="font-size:13px;color:#64748b;">ÁâàÊú¨</span>
                  <span style="font-size:13px;font-weight:500;color:#1e293b;">1.0.0</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Ë¥¶Êà∑ÂÆâÂÖ®Ôºö‰øÆÊîπÂØÜÁ†Å -->
          <div style="margin-bottom:32px;">
            <h4 style="margin:0 0 16px;font-size:14px;font-weight:600;color:#1f2937;text-transform:uppercase;letter-spacing:0.5px;">üîí Ë¥¶Êà∑ÂÆâÂÖ®</h4>
            <div style="background:#f9fafb;border-radius:12px;padding:20px;border:1px solid #e5e7eb;">
              <form id="changePasswordForm" style="max-width: 100%;">
                <div class="form-group">
                  <label>ÂéüÂØÜÁ†Å <span class="required">*</span></label>
                  <div style="position:relative;">
                    <input type="password" id="oldPassword" placeholder="ËØ∑ËæìÂÖ•ÂéüÂØÜÁ†Å" required style="padding-right:45px;" />
                    <button type="button" class="toggle-password-btn" data-target="oldPassword" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:4px;color:#6b7280;font-size:18px;line-height:1;width:32px;height:32px;display:flex;align-items:center;justify-content:center;" title="ÊòæÁ§∫ÂØÜÁ†Å">üëÅÔ∏è</button>
                  </div>
                </div>
                <div class="form-group">
                  <label>Êñ∞ÂØÜÁ†Å <span class="required">*</span></label>
                  <div style="position:relative;">
                    <input type="password" id="newPassword" placeholder="ËØ∑ËæìÂÖ•Êñ∞ÂØÜÁ†ÅÔºàËá≥Â∞ë6‰ΩçÔºâ" required minlength="6" style="padding-right:45px;" />
                    <button type="button" class="toggle-password-btn" data-target="newPassword" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:4px;color:#6b7280;font-size:18px;line-height:1;width:32px;height:32px;display:flex;align-items:center;justify-content:center;" title="ÊòæÁ§∫ÂØÜÁ†Å">üëÅÔ∏è</button>
                  </div>
                </div>
                <div class="form-group">
                  <label>Á°ÆËÆ§Êñ∞ÂØÜÁ†Å <span class="required">*</span></label>
                  <div style="position:relative;">
                    <input type="password" id="confirmPassword" placeholder="ËØ∑ÂÜçÊ¨°ËæìÂÖ•Êñ∞ÂØÜÁ†Å" required minlength="6" style="padding-right:45px;" />
                    <button type="button" class="toggle-password-btn" data-target="confirmPassword" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:4px;color:#6b7280;font-size:18px;line-height:1;width:32px;height:32px;display:flex;align-items:center;justify-content:center;" title="ÊòæÁ§∫ÂØÜÁ†Å">üëÅÔ∏è</button>
                  </div>
                </div>
                <div class="form-actions">
                  <button type="submit" class="btn btn-primary" style="width:100%;">‰øùÂ≠òÂØÜÁ†Å</button>
                </div>
                <div id="passwordChangeError" class="error-message" style="margin-top: 16px;"></div>
                <div id="passwordChangeSuccess" style="margin-top: 16px; padding: 12px; background: var(--success-light); color: #047857; border-radius: var(--radius-md); font-size: 14px; display: none;">
                  ÂØÜÁ†Å‰øÆÊîπÊàêÂäüÔºÅ
                </div>
              </form>
            </div>
          </div>
          
          <!-- ÈÄÄÂá∫ÁôªÂΩï -->
          <div>
            <h4 style="margin:0 0 16px;font-size:14px;font-weight:600;color:#1f2937;text-transform:uppercase;letter-spacing:0.5px;">üö™ Ë¥¶Êà∑Êìç‰Ωú</h4>
            <button class="btn btn-outline" id="logoutBtnInModal" style="width:100%;justify-content:flex-start;padding:16px 20px;border-radius:12px;border:1px solid #ef4444;background:#fff;transition:all 0.2s;text-align:left;color:#ef4444;">
              <div style="display:flex;align-items:center;gap:12px;flex:1;">
                <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);display:flex;align-items:center;justify-content:center;font-size:20px;">üö™</div>
                <div style="flex:1;">
                  <div style="font-size:15px;font-weight:500;color:#ef4444;margin-bottom:4px;">ÈÄÄÂá∫ÁôªÂΩï</div>
                  <div style="font-size:12px;color:#64748b;">ÂÆâÂÖ®ÈÄÄÂá∫Êô∫ËÉΩÁÆ°ÁêÜÁ≥ªÁªü</div>
                </div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

        <!-- Á≥ªÁªüÂçáÁ∫ßÊ†áÁ≠æÈ°µ -->
        <div id="upgradeViewTab" style="display:none; margin-left: var(--sidebar-width); margin-top: var(--header-height); padding: 28px;">
          <!-- È°µÈù¢Â§¥ÈÉ® -->
          <div class="card" style="margin-bottom:24px;background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);color:#fff;border:none;position:relative;overflow:hidden;">
            <div style="position:absolute;top:-60px;right:-60px;width:200px;height:200px;background:rgba(255,255,255,0.08);border-radius:50%;backdrop-filter:blur(20px);"></div>
            <div style="position:absolute;bottom:-40px;left:-40px;width:160px;height:160px;background:rgba(255,255,255,0.06);border-radius:50%;backdrop-filter:blur(18px);"></div>
            <div style="position:relative;z-index:1;display:flex;align-items:flex-start;justify-content:space-between;gap:24px;flex-wrap:wrap;">
              <div style="display:flex;gap:16px;align-items:center;flex:1;min-width:260px;">
                <div style="width:60px;height:60px;border-radius:18px;background:rgba(255,255,255,0.16);display:flex;align-items:center;justify-content:center;font-size:32px;border:1px solid rgba(255,255,255,0.3);">
                  üöÄ
                </div>
                <div>
                  <div style="font-size:13px;opacity:.9;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;">SYSTEM UPGRADE</div>
                  <h2 style="margin:0 0 4px 0;font-size:22px;font-weight:700;">Á≥ªÁªüÂçáÁ∫ßËÆ∞ÂΩï</h2>
                  <p style="margin:0;font-size:13px;opacity:.9;">Êü•ÁúãÊØè‰∏ÄÊ¨°ÁâàÊú¨ÂçáÁ∫ßÂ∏¶Êù•ÁöÑÂèòÂåñÂíåËÉΩÂäõÊèêÂçá</p>
                </div>
              </div>
              <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:stretch;">
                <div style="min-width:150px;padding:12px 16px;border-radius:12px;background:rgba(255,255,255,0.16);backdrop-filter:blur(14px);">
                  <div style="font-size:11px;opacity:.85;margin-bottom:4px;">ÂΩìÂâçÁâàÊú¨</div>
                  <div id="upgradeVersion" style="font-size:18px;font-weight:700;">v3.0.0</div>
                </div>
              </div>
            </div>
          </div>

          <!-- ÂçáÁ∫ßÊ¶ÇËßà + ÂàóË°®‰∏§ÂàóÂ∏ÉÂ±Ä -->
          <div style="display:grid;grid-template-columns:minmax(0,2fr) minmax(0,3fr);gap:24px;align-items:flex-start;">
            <!-- ÂçáÁ∫ßÊ¶ÇËßàÂç°Áâá -->
            <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px;">
              <div class="card" style="padding:20px;">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#1e40af;">ÂçáÁ∫ßÈÉ®ÂàÜ</div>
                  <div style="font-size:20px;">üì¶</div>
                </div>
                <div id="upgradePartsCount" style="font-size:28px;font-weight:700;color:#111827;margin-bottom:4px;">--</div>
                <div style="font-size:12px;color:#6b7280;">Â∑≤ÂÆåÊàêÊ®°ÂùóÊï∞</div>
              </div>
              <div class="card" style="padding:20px;">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#065f46;">Êñ∞Â¢ûÊñá‰ª∂</div>
                  <div style="font-size:20px;">üìÑ</div>
                </div>
                <div id="upgradeNewFiles" style="font-size:28px;font-weight:700;color:#111827;margin-bottom:4px;">--</div>
                <div style="font-size:12px;color:#6b7280;">Êñ∞Â¢ûÊñá‰ª∂Êï∞Èáè</div>
              </div>
              <div class="card" style="padding:20px;">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#92400e;">Êñ∞Â¢û‰ª£Á†Å</div>
                  <div style="font-size:20px;">üíª</div>
                </div>
                <div id="upgradeNewCode" style="font-size:28px;font-weight:700;color:#111827;margin-bottom:4px;">--</div>
                <div style="font-size:12px;color:#6b7280;">Êñ∞Â¢û‰ª£Á†ÅË°åÊï∞</div>
              </div>
              <div class="card" style="padding:20px;">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#9f1239;">Ëá™Âä®ÂåñÁéá</div>
                  <div style="font-size:20px;">‚ö°</div>
                </div>
                <div id="upgradeAutomation" style="font-size:28px;font-weight:700;color:#111827;margin-bottom:4px;">--</div>
                <div style="font-size:12px;color:#6b7280;">Ëá™Âä®ÂåñËÉΩÂäõÊèêÂçá</div>
              </div>
            </div>

            <!-- ÂçáÁ∫ßÈÉ®ÂàÜÂàóË°® -->
            <div class="card" style="margin:0;">
              <div class="card-header">
                <h3 style="margin:0;font-size:18px;font-weight:700;color:#1e293b;display:flex;align-items:center;gap:8px;">
                  <span style="font-size:20px;">üìã</span>
                  <span>ÂçáÁ∫ßÂÜÖÂÆπÊòéÁªÜ</span>
                </h3>
              </div>
              <div class="card-body" id="upgradePartsList" style="padding-top:16px;">
                <div style="text-align:center;padding:32px 0;">
                  <div style="font-size:40px;margin-bottom:12px;">‚è≥</div>
                  <p style="color:#6b7280;font-size:13px;margin:0;">Ê≠£Âú®Âä†ËΩΩÂçáÁ∫ßËÆ∞ÂΩï...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- ËÉΩÂäõÊèêÂçá -->
          <div class="card" style="margin-top:24px;">
            <div class="card-header">
              <h3 style="margin:0;font-size:18px;font-weight:700;color:#1e293b;display:flex;align-items:center;gap:8px;">
                <span style="font-size:20px;">üìä</span>
                <span>ËÉΩÂäõÊèêÂçáÊÄªËßà</span>
              </h3>
            </div>
            <div class="card-body" id="upgradeCapabilities" style="padding-top:16px;">
              <div style="text-align:center;padding:32px 0;">
                <div style="font-size:40px;margin-bottom:12px;">‚è≥</div>
                <p style="color:#6b7280;font-size:13px;margin:0;">Ê≠£Âú®Âä†ËΩΩËÉΩÂäõÊèêÂçáÊï∞ÊçÆ...</p>
              </div>
            </div>
          </div>
        </div>

  <!-- ËµÑËÆØËØ¶ÊÉÖÂºπÁ™ó -->
  <div class="news-modal" id="newsModal">
    <div class="news-modal-content">
      <div class="news-modal-header">
        <h3 class="news-modal-title" id="newsModalTitle">ËµÑËÆØÊ†áÈ¢ò</h3>
        <button class="news-modal-close" id="newsModalClose">‚úï</button>
      </div>
      <div class="news-modal-body">
        <div class="news-modal-meta">
          <div class="news-modal-meta-item">
            <span>üì∞</span>
            <span id="newsModalSource">Êù•Ê∫êÔºöÊú™Áü•</span>
          </div>
          <div class="news-modal-meta-item">
            <span>üìç</span>
            <span id="newsModalRegion">ÂÖ®ÂõΩËµÑËÆØ</span>
          </div>
          <div class="news-modal-meta-item">
            <span>üïê</span>
            <span id="newsModalUpdateTime">Êõ¥Êñ∞Êó∂Èó¥ÔºöÊú™Áü•</span>
          </div>
        </div>
        <div class="news-modal-content-text" id="newsModalContent">
          ËµÑËÆØÂÜÖÂÆπÂä†ËΩΩ‰∏≠...
        </div>
      </div>
      <div class="news-modal-footer">
        <button class="btn btn-outline" id="newsModalViewOriginal">üîó Êü•ÁúãÂéüÊñá</button>
        <button class="btn btn-primary" id="newsModalCloseBtn">ÂÖ≥Èó≠</button>
      </div>
    </div>
  </div>
  
  <script>
    // ÂØÜÁ†ÅÊòæÁ§∫ÂáΩÊï∞Â∑≤Âú®head‰∏≠ÂÆö‰πâÔºåËøôÈáå‰∏çÂÜçÈáçÂ§çÂÆö‰πâ
    
    // APIÈÖçÁΩÆ
    function getApiUrl() {
      const config = localStorage.getItem('pigeon_api_config');
      if (config) {
        const parsed = JSON.parse(config);
        // Â¶ÇÊûúÈÖçÁΩÆ‰∫ÜËá™ÂÆö‰πâAPI URL‰∏î‰∏çÊòØlocalhostÔºå‰ΩøÁî®ÂÆÉ
        if (parsed.apiUrl && !parsed.apiUrl.includes('localhost')) {
          return parsed.apiUrl;
        }
      }
      
      // Ëá™Âä®Ê£ÄÊµãÂΩìÂâçÂüüÂêçÂπ∂ÊûÑÂª∫API URL
      const currentOrigin = window.location.origin;
      return currentOrigin + '/api';
    }
    
    // ‰∏ªÈ¢òÂàáÊç¢
    const themeToggle = document.getElementById('themeToggle');
    const currentTheme = localStorage.getItem('adminTheme') || 'light';
    document.documentElement.setAttribute('data-theme', currentTheme);
    updateThemeButton();
    
    function updateThemeButton() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      if (themeToggle) {
        themeToggle.textContent = isDark ? '‚òÄÔ∏è ÊµÖËâ≤Ê®°Âºè' : 'üåô ÊöóËâ≤Ê®°Âºè';
      }
    }
    
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme');
        const newTheme = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('adminTheme', newTheme);
        updateThemeButton();
      });
    }
    
    // ÂØÜÁ†ÅÊòæÁ§∫ÂáΩÊï∞Â∑≤Âú®head‰∏≠ÂÆö‰πâÔºåËøôÈáåÈ™åËØÅ‰∏Ä‰∏ã
    if (typeof window.togglePasswordVisibility === 'undefined') {
      console.error('‚ùå togglePasswordVisibility ÂáΩÊï∞Êú™Âú®head‰∏≠ÂÆö‰πâÔºÅ');
      alert('ÂØÜÁ†ÅÊòæÁ§∫ÂäüËÉΩÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢');
    } else {
      console.log('‚úÖ togglePasswordVisibility ÂáΩÊï∞Â∑≤‰ªéheadÂä†ËΩΩ');
    }
    
    // ÁôªÂΩïÂäüËÉΩÔºàÁ°Æ‰øùDOMÂ∑≤Âä†ËΩΩÔºâ
    function initLoginForm() {
      const loginForm = document.getElementById('loginForm');
      const loginPage = document.getElementById('loginPage');
      const adminPage = document.getElementById('adminPage');
      
      if (!loginForm || !loginPage || !adminPage) {
        console.warn('‚ö†Ô∏è ÁôªÂΩïË°®ÂçïÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåÂª∂ËøüÂàùÂßãÂåñ...');
        setTimeout(initLoginForm, 100);
        return;
      }
      
      // ÁªëÂÆöÁôªÂΩïË°®ÂçïÊèê‰∫§‰∫ã‰ª∂ÔºàÈÅøÂÖçÈáçÂ§çÁªëÂÆöÔºâ
      if (!loginForm.dataset.initialized) {
        loginForm.dataset.initialized = 'true';
        loginForm.addEventListener('submit', handleLoginSubmit);
        console.log('‚úÖ ÁôªÂΩïË°®ÂçïÂ∑≤ÂàùÂßãÂåñ');
      }
    }
    
    // Á´ãÂç≥ÂàùÂßãÂåñÁôªÂΩïË°®Âçï
    initLoginForm();
    
    // ÁôªÂΩïÊèê‰∫§Â§ÑÁêÜÂáΩÊï∞
    async function handleLoginSubmit(e) {
      e.preventDefault();
      e.stopPropagation();
      
      // ËÆæÁΩÆÁôªÂΩïËøõË°å‰∏≠Ê†áËÆ∞ÔºåÈò≤Ê≠¢checkAuthÂπ≤Êâ∞
      window.__loginInProgress = true;
      
      const usernameEl = document.getElementById('username');
      const passwordEl = document.getElementById('password');
      const useLocalAuthEl = document.getElementById('useLocalAuth');
      const errorDiv = document.getElementById('loginError');
      const loginPage = document.getElementById('loginPage');
      const adminPage = document.getElementById('adminPage');
      
      if (!usernameEl || !passwordEl || !errorDiv || !loginPage || !adminPage) {
        console.error('‚ùå ÁôªÂΩïË°®ÂçïÂÖÉÁ¥†Êú™ÊâæÂà∞');
        window.__loginInProgress = false; // ÈáçÁΩÆÊ†áËÆ∞
        if (errorDiv) {
          errorDiv.textContent = 'Á≥ªÁªüÈîôËØØÔºöÁôªÂΩïË°®ÂçïÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï';
          errorDiv.style.display = 'block';
        }
        return;
      }
      
      // Ëé∑ÂèñÂπ∂Ê∏ÖÁêÜËæìÂÖ•ÂÄº
      const username = usernameEl.value.trim().toLowerCase(); // ËΩ¨Êç¢‰∏∫Â∞èÂÜôÔºåÂøΩÁï•Â§ßÂ∞èÂÜô
      const password = passwordEl.value.trim(); // ÂéªÈô§È¶ñÂ∞æÁ©∫Ê†º
      const useLocalAuth = useLocalAuthEl ? useLocalAuthEl.checked : false;
      
      // Ê∏ÖÈô§‰πãÂâçÁöÑÈîôËØØ‰ø°ÊÅØ
      errorDiv.textContent = '';
      errorDiv.style.display = 'none';
      
      // È™åËØÅËæìÂÖ•
      if (!username || !password) {
        window.__loginInProgress = false; // ÈáçÁΩÆÊ†áËÆ∞
        errorDiv.textContent = 'ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å';
        errorDiv.style.display = 'block';
        return;
      }
      
      // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
      const loginFormEl = document.getElementById('loginForm');
      const submitBtn = loginFormEl ? loginFormEl.querySelector('button[type="submit"]') : null;
      const originalBtnText = submitBtn ? submitBtn.textContent : 'ÁôªÂΩï';
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ÁôªÂΩï‰∏≠...';
      }
      
      // Â¶ÇÊûúÂãæÈÄâ‰∫Ü"‰ΩøÁî®Êú¨Âú∞È™åËØÅ"ÔºåÁõ¥Êé•‰ΩøÁî®Êú¨Âú∞È™åËØÅ
      if (useLocalAuth) {
        console.log('üîß ‰ΩøÁî®Êú¨Âú∞È™åËØÅÊ®°Âºè');
        console.log('üîç ËæìÂÖ•ÁöÑÁî®Êà∑Âêç:', username);
        console.log('üîç ËæìÂÖ•ÁöÑÂØÜÁ†Å:', password ? '***' : '(Á©∫)');
        
        // Êú¨Âú∞È™åËØÅÔºöÂè™ÊîØÊåÅÈªòËÆ§Ë¥¶Âè∑Ôºà‰∏çÂå∫ÂàÜÂ§ßÂ∞èÂÜôÔºâ
        const validUsername = 'admin';
        const validPassword = 'admin123';
        
        // Ê∑ªÂä†ËØ¶ÁªÜÁöÑÈ™åËØÅÊó•Âøó
        console.log('üîç È™åËØÅËØ¶ÊÉÖ:', {
          inputUsername: username,
          inputPassword: password ? '***' : '(Á©∫)',
          validUsername: validUsername,
          validPassword: validPassword,
          usernameMatch: username === validUsername,
          passwordMatch: password === validPassword,
          bothMatch: username === validUsername && password === validPassword
        });
        
        if (username === validUsername && password === validPassword) {
          console.log('‚úÖ Êú¨Âú∞È™åËØÅÊàêÂäü');
          
          // Ê∏ÖÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÊóßÁôªÂΩï‰ø°ÊÅØÔºåÈÅøÂÖçÂπ≤Êâ∞
          try {
            // ‰øùÂ≠òÊñ∞ÁöÑÁôªÂΩï‰ø°ÊÅØ
            const mockUser = {
              id: 'admin_local',
              username: 'admin',
              email: 'admin@example.com',
              role: 'admin',
              createdAt: new Date().toISOString()
            };
            
            const mockToken = 'local_admin_token_' + Date.now();
            
            // ÂÖàÊ∏ÖÈô§ÊóßÁöÑÔºåÂÜçËÆæÁΩÆÊñ∞ÁöÑ
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            localStorage.removeItem('adminUserInfo');
            localStorage.removeItem('offlineMode');
            
            // ËÆæÁΩÆÊñ∞ÁöÑÁôªÂΩï‰ø°ÊÅØ
            localStorage.setItem('adminToken', mockToken);
            localStorage.setItem('adminUser', JSON.stringify(mockUser));
            localStorage.setItem('offlineMode', 'true');
            
            const userInfo = {
              name: mockUser.username,
              email: mockUser.email,
              type: 'ÁÆ°ÁêÜÂëò',
              role: 'ÁÆ°ÁêÜÂëò',
              registerDate: new Date().toISOString().split('T')[0]
            };
            localStorage.setItem('adminUserInfo', JSON.stringify(userInfo));
            
            console.log('‚úÖ ÁôªÂΩï‰ø°ÊÅØÂ∑≤‰øùÂ≠òÂà∞localStorage');
            
            // Á°Æ‰øùÈ°µÈù¢ÂÖÉÁ¥†Â≠òÂú®ÂêéÂÜçÂàáÊç¢
            const loginPageEl = document.getElementById('loginPage');
            const adminPageEl = document.getElementById('adminPage');
            
            if (loginPageEl && adminPageEl) {
              console.log('üîç ÂáÜÂ§áÂàáÊç¢È°µÈù¢:', {
                loginPageExists: !!loginPageEl,
                adminPageExists: !!adminPageEl,
                loginPageCurrentDisplay: window.getComputedStyle(loginPageEl).display,
                adminPageCurrentDisplay: window.getComputedStyle(adminPageEl).display
              });
              
              // Á´ãÂç≥ÂàáÊç¢È°µÈù¢ÊòæÁ§∫Ôºà‰ΩøÁî®!importantÁ°Æ‰øù‰ºòÂÖàÁ∫ßÔºâ
              loginPageEl.style.setProperty('display', 'none', 'important');
              adminPageEl.style.setProperty('display', 'block', 'important');
              
              // ÂêåÊó∂ËÆæÁΩÆÂÜÖËÅîÊ†∑Âºè‰Ωú‰∏∫Â§á‰ªΩ
              loginPageEl.style.display = 'none';
              adminPageEl.style.display = 'block';
              
              // Âº∫Âà∂Ëß¶ÂèëÈáçÊéí
              loginPageEl.offsetHeight;
              adminPageEl.offsetHeight;
              
              console.log('üîç È°µÈù¢ÂàáÊç¢Âêé:', {
                loginPageDisplay: window.getComputedStyle(loginPageEl).display,
                adminPageDisplay: window.getComputedStyle(adminPageEl).display
              });
              
              // Êõ¥Êñ∞Áî®Êà∑ÂêçÊòæÁ§∫
              const adminUserNameEl = document.getElementById('adminUserName');
              if (adminUserNameEl) {
                adminUserNameEl.textContent = `Ê¨¢ËøéÔºå${mockUser.username}ÔºàÊú¨Âú∞Ê®°ÂºèÔºâ`;
              }
              
              // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
              }
              
              // Ë∞ÉÁî®ÂàùÂßãÂåñÂáΩÊï∞
              if (typeof updateTopBarUserDisplay === 'function') {
                try {
                  updateTopBarUserDisplay();
                } catch (e) {
                  console.warn('updateTopBarUserDisplay Ë∞ÉÁî®Â§±Ë¥•:', e);
                }
              }
              
              if (typeof loadAnnouncements === 'function') {
                try {
                  loadAnnouncements();
                } catch (e) {
                  console.warn('loadAnnouncements Ë∞ÉÁî®Â§±Ë¥•:', e);
                }
              }
              
              setTimeout(() => {
                if (typeof initEvoAssistant === 'function') {
                  try {
                    initEvoAssistant();
                  } catch (e) {
                    console.warn('initEvoAssistant Ë∞ÉÁî®Â§±Ë¥•:', e);
                  }
                }
              }, 500);
              
              console.log('‚úÖ ÁôªÂΩïÊàêÂäüÔºåÂ∑≤ÂàáÊç¢Âà∞ÁÆ°ÁêÜÈ°µÈù¢');
              
              // ÈòªÊ≠¢checkAuthÂÜçÊ¨°ÊâßË°åÔºàÈÄöËøáËÆæÁΩÆÊ†áËÆ∞Ôºâ
              window.__loginInProgress = false;
              window.__justLoggedIn = true;
              
              // È™åËØÅÈ°µÈù¢ÂàáÊç¢ÊòØÂê¶ÊàêÂäüÔºàÂ§öÊ¨°Ê£ÄÊü•Ôºâ
              const verifyPageSwitch = () => {
                const currentLoginDisplay = window.getComputedStyle(loginPageEl).display;
                const currentAdminDisplay = window.getComputedStyle(adminPageEl).display;
                
                if (currentLoginDisplay !== 'none' || currentAdminDisplay !== 'block') {
                  console.warn('‚ö†Ô∏è Ê£ÄÊµãÂà∞È°µÈù¢Áä∂ÊÄÅÂºÇÂ∏∏ÔºåÂº∫Âà∂‰øÆÂ§ç:', {
                    loginPage: currentLoginDisplay,
                    adminPage: currentAdminDisplay
                  });
                  loginPageEl.style.setProperty('display', 'none', 'important');
                  adminPageEl.style.setProperty('display', 'block', 'important');
                }
              };
              
              // Á´ãÂç≥È™åËØÅ
              setTimeout(verifyPageSwitch, 50);
              // 100msÂêéÂÜçÊ¨°È™åËØÅ
              setTimeout(verifyPageSwitch, 100);
              // 500msÂêéÂÜçÊ¨°È™åËØÅ
              setTimeout(verifyPageSwitch, 500);
              // 1ÁßíÂêéÂÜçÊ¨°È™åËØÅ
              setTimeout(verifyPageSwitch, 1000);
              
              // Á°Æ‰øù‰∏ç‰ºöÂõ†‰∏∫checkAuthËÄåË∑≥ËΩ¨ÂõûÁôªÂΩïÈ°µÔºàÂª∂Èïø‰øùÊä§Êó∂Èó¥Âà∞10ÁßíÔºâ
              setTimeout(() => {
                verifyPageSwitch(); // ÊúÄÂêéÈ™åËØÅ‰∏ÄÊ¨°
                window.__justLoggedIn = false;
                console.log('‚úÖ ÁôªÂΩïÊµÅÁ®ãÂÆåÊàêÔºåcheckAuthÂ∑≤ÊÅ¢Â§ç');
              }, 10000); // Âª∂ÈïøÂà∞10Áßí
              
              return;
            } else {
              console.error('‚ùå È°µÈù¢ÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåÊó†Ê≥ïÂàáÊç¢È°µÈù¢');
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
              }
              errorDiv.textContent = 'Á≥ªÁªüÈîôËØØÔºöÈ°µÈù¢ÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï';
              errorDiv.style.display = 'block';
              return;
            }
          } catch (storageError) {
            console.error('‚ùå ‰øùÂ≠òÁôªÂΩï‰ø°ÊÅØÂ§±Ë¥•:', storageError);
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = originalBtnText;
            }
            errorDiv.textContent = 'Á≥ªÁªüÈîôËØØÔºöÊó†Ê≥ï‰øùÂ≠òÁôªÂΩï‰ø°ÊÅØÔºåËØ∑Ê£ÄÊü•ÊµèËßàÂô®ËÆæÁΩÆ';
            errorDiv.style.display = 'block';
            return;
          }
        } else {
          // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅÂíåÁôªÂΩïÊ†áËÆ∞
          window.__loginInProgress = false;
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = originalBtnText;
          }
          errorDiv.textContent = 'Êú¨Âú∞È™åËØÅÂ§±Ë¥•Ôºö‰ªÖÊîØÊåÅÈªòËÆ§Ë¥¶Âè∑ admin / admin123';
          errorDiv.style.display = 'block';
          console.warn('‚ùå Êú¨Âú∞È™åËØÅÂ§±Ë¥•:', { 
            username, 
            passwordMatch: password === validPassword,
            expectedUsername: validUsername,
            expectedPassword: validPassword
          });
          return;
        }
      }
      
      // È¶ñÂÖàÂ∞ùËØïÊ≠£Â∏∏ÁôªÂΩïÔºàËÆæÁΩÆ5ÁßíË∂ÖÊó∂Ôºâ
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000);
      
      try {
        const apiUrl = getApiUrl();
        console.log('üîç Â∞ùËØïÁôªÂΩïÔºåAPIÂú∞ÂùÄ:', apiUrl);
        console.log('üîç Áî®Êà∑Âêç:', username);
        
        const response = await fetch(`${apiUrl}/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        console.log('üîç ÁôªÂΩïÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
        
        if (!response.ok) {
          const errorResult = await response.json().catch(() => ({ error: 'ÁΩëÁªúÈîôËØØ' }));
          console.error('‚ùå ÁôªÂΩïÂ§±Ë¥•:', errorResult);
          
          // Â¶ÇÊûúÂêéÁ´ØËøîÂõû401/403Á≠âÈîôËØØÔºå‰πüÂ∞ùËØïÊú¨Âú∞fallbackÔºàÁî®‰∫éÂºÄÂèëÊµãËØïÔºâ
          if ((response.status === 401 || response.status === 403 || response.status >= 500) && username === 'admin' && password === 'admin123') {
            console.log('‚ö†Ô∏è ÂêéÁ´ØÈ™åËØÅÂ§±Ë¥•ÔºåÂ∞ùËØïÊú¨Âú∞fallback...');
            
            const mockUser = {
              id: 'admin_local',
              username: 'admin',
              email: 'admin@example.com',
              role: 'admin',
              createdAt: new Date().toISOString()
            };
            
            const mockToken = 'local_admin_token_' + Date.now();
            
            localStorage.setItem('adminToken', mockToken);
            localStorage.setItem('adminUser', JSON.stringify(mockUser));
            localStorage.setItem('offlineMode', 'true');
            
            const userInfo = {
              name: mockUser.username,
              email: mockUser.email,
              type: 'ÁÆ°ÁêÜÂëò',
              role: 'ÁÆ°ÁêÜÂëò',
              registerDate: new Date().toISOString().split('T')[0]
            };
            localStorage.setItem('adminUserInfo', JSON.stringify(userInfo));
            
            const loginPageEl = document.getElementById('loginPage');
            const adminPageEl = document.getElementById('adminPage');
            
            if (loginPageEl && adminPageEl) {
              loginPageEl.style.display = 'none';
              adminPageEl.style.display = 'block';
              
              const adminUserNameEl = document.getElementById('adminUserName');
              if (adminUserNameEl) {
                adminUserNameEl.textContent = `Ê¨¢ËøéÔºå${mockUser.username}ÔºàÁ¶ªÁ∫øÊ®°ÂºèÔºâ`;
              }
              
              if (typeof updateTopBarUserDisplay === 'function') {
                updateTopBarUserDisplay();
              }
              
              setTimeout(() => {
                alert('‚ö†Ô∏è ÂΩìÂâç‰∏∫Á¶ªÁ∫øÊ®°Âºè\n\nÂêéÁ´ØÊúçÂä°È™åËØÅÂ§±Ë¥•Ôºå‰ΩøÁî®Êú¨Âú∞È™åËØÅ„ÄÇ\nÈªòËÆ§Ë¥¶Âè∑Ôºöadmin / admin123');
              }, 300);
              
              if (typeof loadAnnouncements === 'function') {
                loadAnnouncements();
              }
              
              setTimeout(() => {
                if (typeof initEvoAssistant === 'function') {
                  initEvoAssistant();
                }
              }, 500);
            }
            
            return;
          }
          
          errorDiv.textContent = errorResult.error || `ÁôªÂΩïÂ§±Ë¥• (HTTP ${response.status})`;
          errorDiv.style.display = 'block';
          return;
        }
        
        const result = await response.json();
        console.log('üîç ÁôªÂΩïÁªìÊûú:', result);
        
        if (result.success && result.data) {
          const user = result.data.user;
          console.log('üîç Áî®Êà∑‰ø°ÊÅØ:', user);
          
          // Ê£ÄÊü•ÁÆ°ÁêÜÂëòÊùÉÈôêÔºàÊîØÊåÅ role === 'admin' Êàñ role === 'ÁÆ°ÁêÜÂëò'Ôºâ
          if (user.role !== 'admin' && user.role !== 'ÁÆ°ÁêÜÂëò') {
            console.warn('‚ö†Ô∏è Áî®Êà∑Ê≤°ÊúâÁÆ°ÁêÜÂëòÊùÉÈôêÔºårole:', user.role);
            errorDiv.textContent = `ÊÇ®Ê≤°ÊúâÁÆ°ÁêÜÂëòÊùÉÈôêÔºàÂΩìÂâçËßíËâ≤Ôºö${user.role}Ôºâ`;
            errorDiv.style.display = 'block';
            return;
          }
          
          localStorage.setItem('adminToken', result.data.token);
          localStorage.setItem('adminUser', JSON.stringify(user));
          
          // ‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØ
          const userInfo = {
            name: user.username,
            email: user.email || 'admin@example.com',
            type: 'ÁÆ°ÁêÜÂëò',
            role: 'ÁÆ°ÁêÜÂëò',
            registerDate: user.createdAt ? new Date(user.createdAt).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]
          };
          localStorage.setItem('adminUserInfo', JSON.stringify(userInfo));
          
          // Á°Æ‰øùÈ°µÈù¢ÂÖÉÁ¥†Â≠òÂú®ÂêéÂÜçÂàáÊç¢
          const loginPageEl = document.getElementById('loginPage');
          const adminPageEl = document.getElementById('adminPage');
          
            if (loginPageEl && adminPageEl) {
              loginPageEl.style.display = 'none';
              adminPageEl.style.display = 'block';
              
              const adminUserNameEl = document.getElementById('adminUserName');
              if (adminUserNameEl) {
                adminUserNameEl.textContent = `Ê¨¢ËøéÔºå${user.username}`;
              }
              
              const submitBtn = document.getElementById('loginForm')?.querySelector('button[type="submit"]');
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ÁôªÂΩï';
              }
              
              // Êõ¥Êñ∞Áî®Êà∑ÊòæÁ§∫ÔºàÂåÖÊã¨Ëá™ÂÆö‰πâÂ§¥ÂÉèÂíåÂêçÂ≠óÔºâ
              if (typeof updateTopBarUserDisplay === 'function') {
                try {
                  updateTopBarUserDisplay();
                } catch (e) {
                  console.warn('updateTopBarUserDisplay Ë∞ÉÁî®Â§±Ë¥•:', e);
                }
              }
              
              console.log('‚úÖ ÁôªÂΩïÊàêÂäüÔºåÂ∑≤ÂàáÊç¢Âà∞ÁÆ°ÁêÜÈ°µÈù¢');
              
              // Ê£ÄÊü•ÊòØÂê¶‰∏∫ÈªòËÆ§ÂØÜÁ†ÅÔºàÈ¶ñÊ¨°ÁôªÂΩïÔºâ
              if (username === 'admin' && password === 'admin123') {
                setTimeout(() => {
                  if (confirm('Ê£ÄÊµãÂà∞ÊÇ®‰ΩøÁî®ÁöÑÊòØÈªòËÆ§ÂØÜÁ†ÅÔºå‰∏∫‰∫ÜÂÆâÂÖ®Ëµ∑ËßÅÔºåÂª∫ËÆÆÊÇ®Á´ãÂç≥‰øÆÊîπÂØÜÁ†Å„ÄÇ\n\nÊòØÂê¶Áé∞Âú®ÂâçÂæÄ‰øÆÊîπÂØÜÁ†ÅÈ°µÈù¢Ôºü')) {
                    // ÂàáÊç¢Âà∞‰øÆÊîπÂØÜÁ†ÅÊ†áÁ≠æÈ°µ
                    const passwordTabBtn = document.querySelector('[data-tab="password"]');
                    const passwordTab = document.getElementById('passwordTab');
                    if (passwordTabBtn && passwordTab) {
                      document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                      document.querySelectorAll('[id$="Tab"]').forEach(tab => tab.style.display = 'none');
                      passwordTabBtn.classList.add('active');
                      passwordTab.style.display = 'block';
                    }
                  }
                }, 500);
              }
              
              if (typeof loadAnnouncements === 'function') {
                try {
                  loadAnnouncements();
                } catch (e) {
                  console.warn('loadAnnouncements Ë∞ÉÁî®Â§±Ë¥•:', e);
                }
              }
              
              // ÂàùÂßãÂåñEvoÂä©Êâã
              setTimeout(() => {
                if (typeof initEvoAssistant === 'function') {
                  try {
                    initEvoAssistant();
                  } catch (e) {
                    console.warn('initEvoAssistant Ë∞ÉÁî®Â§±Ë¥•:', e);
                  }
                }
              }, 500);
              
              // ËÆæÁΩÆÁôªÂΩïÊàêÂäüÊ†áËÆ∞
              window.__loginInProgress = false;
              window.__justLoggedIn = true;
              setTimeout(() => {
                window.__justLoggedIn = false;
                console.log('‚úÖ ÁôªÂΩïÊµÅÁ®ãÂÆåÊàêÔºåcheckAuthÂ∑≤ÊÅ¢Â§ç');
              }, 3000);
              
              return;
          } else {
            console.error('‚ùå È°µÈù¢ÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåÊó†Ê≥ïÂàáÊç¢È°µÈù¢');
            errorDiv.textContent = 'Á≥ªÁªüÈîôËØØÔºöÈ°µÈù¢ÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï';
            errorDiv.style.display = 'block';
            return;
          }
        } else {
          window.__loginInProgress = false; // ÈáçÁΩÆÊ†áËÆ∞
          const submitBtn = document.getElementById('loginForm')?.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'ÁôªÂΩï';
          }
          console.error('‚ùå ÁôªÂΩïÂ§±Ë¥•:', result);
          errorDiv.textContent = result.error || 'ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å';
          errorDiv.style.display = 'block';
          return;
        }
      } catch (error) {
        // ÁôªÂΩïÂ§±Ë¥•ÔºåÂ∞ùËØïÊú¨Âú∞fallbackÈ™åËØÅÔºàÁî®‰∫éÂºÄÂèëÊµãËØïÔºâ
        console.error('ÁôªÂΩïÂ§±Ë¥•:', error);
        if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('Load failed') || error.message.includes('timeout') || error.name === 'TimeoutError' || error.name === 'AbortError')) {
          console.log('‚ö†Ô∏è ÂêéÁ´ØÊúçÂä°Êó†Ê≥ïËøûÊé•ÔºåÂ∞ùËØïÊú¨Âú∞È™åËØÅ...');
          
          // Êú¨Âú∞fallbackÔºö‰ΩøÁî®ÈªòËÆ§Ë¥¶Âè∑ÂØÜÁ†ÅËøõË°åÈ™åËØÅ
          // ÈªòËÆ§Ë¥¶Âè∑Ôºöadmin / admin123
          if (username === 'admin' && password === 'admin123') {
            console.log('‚úÖ Êú¨Âú∞È™åËØÅÊàêÂäüÔºà‰ΩøÁî®ÈªòËÆ§Ë¥¶Âè∑Ôºâ');
            
            // ÂàõÂª∫Ê®°ÊãüÁöÑÁî®Êà∑Êï∞ÊçÆÂíåtoken
            const mockUser = {
              id: 'admin_local',
              username: 'admin',
              email: 'admin@example.com',
              role: 'admin',
              createdAt: new Date().toISOString()
            };
            
            const mockToken = 'local_admin_token_' + Date.now();
            
            localStorage.setItem('adminToken', mockToken);
            localStorage.setItem('adminUser', JSON.stringify(mockUser));
            localStorage.setItem('offlineMode', 'true'); // Ê†áËÆ∞‰∏∫Á¶ªÁ∫øÊ®°Âºè
            
            const userInfo = {
              name: mockUser.username,
              email: mockUser.email,
              type: 'ÁÆ°ÁêÜÂëò',
              role: 'ÁÆ°ÁêÜÂëò',
              registerDate: new Date().toISOString().split('T')[0]
            };
            localStorage.setItem('adminUserInfo', JSON.stringify(userInfo));
            
            const loginPageEl = document.getElementById('loginPage');
            const adminPageEl = document.getElementById('adminPage');
            
            if (loginPageEl && adminPageEl) {
              loginPageEl.style.display = 'none';
              adminPageEl.style.display = 'block';
              
              const adminUserNameEl = document.getElementById('adminUserName');
              if (adminUserNameEl) {
                adminUserNameEl.textContent = `Ê¨¢ËøéÔºå${mockUser.username}ÔºàÁ¶ªÁ∫øÊ®°ÂºèÔºâ`;
              }
              
              if (typeof updateTopBarUserDisplay === 'function') {
                updateTopBarUserDisplay();
              }
              
              // ÊòæÁ§∫Á¶ªÁ∫øÊ®°ÂºèÊèêÁ§∫
              setTimeout(() => {
                alert('‚ö†Ô∏è ÂΩìÂâç‰∏∫Á¶ªÁ∫øÊ®°Âºè\n\nÂêéÁ´ØÊúçÂä°Êú™ËøûÊé•ÔºåÈÉ®ÂàÜÂäüËÉΩÂèØËÉΩÊó†Ê≥ï‰ΩøÁî®„ÄÇ\nÈªòËÆ§Ë¥¶Âè∑Ôºöadmin / admin123');
              }, 300);
              
              if (typeof loadAnnouncements === 'function') {
                loadAnnouncements();
              }
              
              setTimeout(() => {
                if (typeof initEvoAssistant === 'function') {
                  initEvoAssistant();
                }
              }, 500);
            }
            
            return;
          } else {
            window.__loginInProgress = false; // ÈáçÁΩÆÊ†áËÆ∞
            const submitBtn = document.getElementById('loginForm')?.querySelector('button[type="submit"]');
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = 'ÁôªÂΩï';
            }
            errorDiv.textContent = 'Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®Ôºå‰∏îÊú¨Âú∞È™åËØÅÂ§±Ë¥•„ÄÇ\n\nÊèêÁ§∫Ôºö\n1) Á°Æ‰øùÂêéÁ´ØÊúçÂä°Â∑≤ÂêØÂä®\n2) Êàñ‰ΩøÁî®ÈªòËÆ§Ë¥¶Âè∑Ôºöadmin / admin123ÔºàÁ¶ªÁ∫øÊ®°ÂºèÔºâ';
            errorDiv.style.display = 'block';
            return;
          }
        } else {
          window.__loginInProgress = false; // ÈáçÁΩÆÊ†áËÆ∞
          const submitBtn = document.getElementById('loginForm')?.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'ÁôªÂΩï';
          }
          errorDiv.textContent = 'ÁôªÂΩïÂ§±Ë¥•Ôºö' + (error.message || 'ÁΩëÁªúÈîôËØØÔºåËØ∑Ê£ÄÊü•ÂêéÁ´ØÊúçÂä°ÊòØÂê¶ÂêØÂä®');
          errorDiv.style.display = 'block';
          console.error('ÁôªÂΩïÈîôËØØËØ¶ÊÉÖ:', error);
          return;
        }
      } finally {
        // Á°Æ‰øùÂú®ÊâÄÊúâÊÉÖÂÜµ‰∏ãÈÉΩÈáçÁΩÆÊ†áËÆ∞ÔºàÂ¶ÇÊûúËøòÊ≤°ÊúâÈáçÁΩÆÔºâ
        // Ê≥®ÊÑèÔºöÊàêÂäüË∑ØÂæÑÂ∑≤ÁªèÂú®ÂÜÖÈÉ®ÈáçÁΩÆ‰∫ÜÊ†áËÆ∞
      }
    }
    
    // ÊòæÁ§∫/ÈöêËóèÂØÜÁ†ÅÂäüËÉΩÔºàÁÆÄÂåñÁâàÔºåÁõ¥Êé•ÁªëÂÆö‰∫ã‰ª∂Ôºâ
    function initPasswordToggle(buttonId, inputId) {
      const toggleBtn = document.getElementById(buttonId);
      const passwordInput = document.getElementById(inputId);
      
      if (!toggleBtn || !passwordInput) {
        console.warn('‚ö†Ô∏è ÂØÜÁ†ÅÊòæÁ§∫ÂäüËÉΩÂàùÂßãÂåñÂ§±Ë¥•:', { buttonId, inputId, toggleBtn: !!toggleBtn, passwordInput: !!passwordInput });
        return false;
      }
      
      // ÁßªÈô§ÊâÄÊúâÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÈÄöËøáÂÖãÈöÜËäÇÁÇπÔºâ
      const newToggleBtn = toggleBtn.cloneNode(true);
      toggleBtn.parentNode.replaceChild(newToggleBtn, toggleBtn);
      
      // ÈáçÊñ∞Ëé∑ÂèñÂºïÁî®
      const freshToggleBtn = document.getElementById(buttonId);
      const freshPasswordInput = document.getElementById(inputId);
      
      if (!freshToggleBtn || !freshPasswordInput) {
        console.error('‚ùå Êó†Ê≥ïÈáçÊñ∞Ëé∑ÂèñÂÖÉÁ¥†ÂºïÁî®');
        return false;
      }
      
      // ÁªëÂÆöÊñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
      freshToggleBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        try {
          const currentType = freshPasswordInput.getAttribute('type') || freshPasswordInput.type || 'password';
          const newType = currentType === 'password' ? 'text' : 'password';
          
          console.log('üîÑ ÂàáÊç¢ÂØÜÁ†ÅÊòæÁ§∫:', { currentType, newType });
          
          // ‰ΩøÁî®setAttributeÂíåÁõ¥Êé•ËÆæÁΩÆtypeÂ±ûÊÄßÔºåÁ°Æ‰øùÂÖºÂÆπÊÄß
          freshPasswordInput.setAttribute('type', newType);
          freshPasswordInput.type = newType;
          
          // Êõ¥Êñ∞ÊåâÈíÆÂõæÊ†áÂíåÊèêÁ§∫
          if (newType === 'text') {
            freshToggleBtn.textContent = 'üôà';
            freshToggleBtn.title = 'ÈöêËóèÂØÜÁ†Å';
            freshToggleBtn.setAttribute('aria-label', 'ÈöêËóèÂØÜÁ†Å');
          } else {
            freshToggleBtn.textContent = 'üëÅÔ∏è';
            freshToggleBtn.title = 'ÊòæÁ§∫ÂØÜÁ†Å';
            freshToggleBtn.setAttribute('aria-label', 'ÊòæÁ§∫ÂØÜÁ†Å');
          }
          
          // ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
          setTimeout(() => {
            freshPasswordInput.focus();
          }, 10);
          
          console.log('‚úÖ ÂØÜÁ†ÅÊòæÁ§∫Áä∂ÊÄÅÂ∑≤ÂàáÊç¢:', newType);
        } catch (error) {
          console.error('‚ùå ÂàáÊç¢ÂØÜÁ†ÅÊòæÁ§∫Áä∂ÊÄÅÂ§±Ë¥•:', error);
        }
      }, true); // ‰ΩøÁî®ÊçïËé∑Èò∂ÊÆµÔºåÁ°Æ‰øù‰ºòÂÖàÊâßË°å
      
      freshToggleBtn.dataset.initialized = 'true';
      console.log('‚úÖ ÂØÜÁ†ÅÊòæÁ§∫ÂäüËÉΩÂ∑≤ÂàùÂßãÂåñ:', inputId);
      return true;
    }
    
    // ÂàõÂª∫ÂØÜÁ†ÅÂàáÊç¢Â§ÑÁêÜÂáΩÊï∞
    function createPasswordToggleHandler(passwordInput, toggleBtn) {
      return function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        try {
          const currentType = passwordInput.getAttribute('type') || passwordInput.type || 'password';
          const newType = currentType === 'password' ? 'text' : 'password';
          
          // ‰ΩøÁî®setAttributeÂíåÁõ¥Êé•ËÆæÁΩÆtypeÂ±ûÊÄßÔºåÁ°Æ‰øùÂÖºÂÆπÊÄß
          passwordInput.setAttribute('type', newType);
          passwordInput.type = newType;
          
          // Êõ¥Êñ∞ÊåâÈíÆÂõæÊ†áÂíåÊèêÁ§∫
          if (newType === 'text') {
            toggleBtn.textContent = 'üôà';
            toggleBtn.title = 'ÈöêËóèÂØÜÁ†Å';
            toggleBtn.setAttribute('aria-label', 'ÈöêËóèÂØÜÁ†Å');
          } else {
            toggleBtn.textContent = 'üëÅÔ∏è';
            toggleBtn.title = 'ÊòæÁ§∫ÂØÜÁ†Å';
            toggleBtn.setAttribute('aria-label', 'ÊòæÁ§∫ÂØÜÁ†Å');
          }
          
          // ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
          setTimeout(() => {
            passwordInput.focus();
          }, 10);
          
          console.log('‚úÖ ÂØÜÁ†ÅÊòæÁ§∫Áä∂ÊÄÅÂ∑≤ÂàáÊç¢:', newType);
        } catch (error) {
          console.error('‚ùå ÂàáÊç¢ÂØÜÁ†ÅÊòæÁ§∫Áä∂ÊÄÅÂ§±Ë¥•:', error);
        }
      };
    }
    
    // ÂàùÂßãÂåñÊâÄÊúâÂØÜÁ†ÅÊòæÁ§∫ÊåâÈíÆÔºàÁÆÄÂåñÁâàÔºåÁõ¥Êé•ÂàùÂßãÂåñÔºâ
    function initAllPasswordToggles() {
      // ÂàùÂßãÂåñÁôªÂΩïÈ°µÈù¢ÁöÑÂØÜÁ†ÅÊòæÁ§∫ÊåâÈíÆ
      const loginToggleBtn = document.getElementById('togglePasswordBtn');
      const loginPasswordInput = document.getElementById('password');
      
      if (loginToggleBtn && loginPasswordInput) {
        const success = initPasswordToggle('togglePasswordBtn', 'password');
        if (success) {
          console.log('‚úÖ ÁôªÂΩïÈ°µÈù¢ÂØÜÁ†ÅÊòæÁ§∫ÂäüËÉΩÂ∑≤ÂàùÂßãÂåñ');
        } else {
          console.error('‚ùå ÁôªÂΩïÈ°µÈù¢ÂØÜÁ†ÅÊòæÁ§∫ÂäüËÉΩÂàùÂßãÂåñÂ§±Ë¥•');
        }
      } else {
        console.warn('‚ö†Ô∏è ÂØÜÁ†ÅÊòæÁ§∫ÊåâÈíÆÊàñËæìÂÖ•Ê°ÜÊú™ÊâæÂà∞:', {
          toggleBtn: !!loginToggleBtn,
          passwordInput: !!loginPasswordInput
        });
      }
      
      // ÂàùÂßãÂåñ‰øÆÊîπÂØÜÁ†ÅË°®ÂçïÁöÑÂØÜÁ†ÅÊòæÁ§∫ÊåâÈíÆ
      document.querySelectorAll('.toggle-password-btn').forEach(btn => {
        const targetId = btn.getAttribute('data-target');
        if (targetId) {
          const passwordInput = document.getElementById(targetId);
          if (passwordInput) {
            // ÂÖãÈöÜÊåâÈíÆÁßªÈô§Êóß‰∫ã‰ª∂
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            const freshBtn = btn.parentNode.querySelector(`[data-target="${targetId}"]`);
            const freshInput = document.getElementById(targetId);
            
            if (freshBtn && freshInput) {
              freshBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const currentType = freshInput.getAttribute('type') || 'password';
                const newType = currentType === 'password' ? 'text' : 'password';
                freshInput.setAttribute('type', newType);
                freshInput.type = newType;
                freshBtn.textContent = newType === 'text' ? 'üôà' : 'üëÅÔ∏è';
                freshBtn.title = newType === 'text' ? 'ÈöêËóèÂØÜÁ†Å' : 'ÊòæÁ§∫ÂØÜÁ†Å';
              }, true);
              console.log('‚úÖ ‰øÆÊîπÂØÜÁ†ÅË°®ÂçïÂØÜÁ†ÅÊòæÁ§∫ÂäüËÉΩÂ∑≤ÂàùÂßãÂåñ:', targetId);
            }
          }
        }
      });
    }
    
    // Á´ãÂç≥ÂàùÂßãÂåñÔºà‰∏çÁ≠âÂæÖDOMContentLoadedÔºâ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initAllPasswordToggles, 50);
      });
    } else {
      setTimeout(initAllPasswordToggles, 50);
    }
    
    // Â§öÊ¨°ÈáçËØïÁ°Æ‰øùÂàùÂßãÂåñÊàêÂäü
    setTimeout(initAllPasswordToggles, 200);
    setTimeout(initAllPasswordToggles, 500);
    setTimeout(initAllPasswordToggles, 1000);
    
    // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁôªÂΩïÔºàÂ¢ûÂº∫ÁâàÔºåÈÅøÂÖçÂπ≤Êâ∞Ê≠£Âú®ËøõË°åÁöÑÁôªÂΩïÔºâ
    function checkAuth() {
      // Â¶ÇÊûúÊ≠£Âú®ÁôªÂΩïÊàñÂàöÂàöÁôªÂΩïÔºåË∑≥ËøáÊ£ÄÊü•
      if (window.__loginInProgress || window.__justLoggedIn) {
        console.log('‚è∏Ô∏è Ë∑≥ËøácheckAuthÔºöÁôªÂΩïËøõË°å‰∏≠ÊàñÂàöÂàöÁôªÂΩï');
        
        // Â¶ÇÊûúÂ∑≤ÁôªÂΩïÔºåÁ°Æ‰øùÁÆ°ÁêÜÈ°µÈù¢ÊòæÁ§∫
        const token = localStorage.getItem('adminToken');
        const user = localStorage.getItem('adminUser');
        if (token && user) {
          const loginPage = document.getElementById('loginPage');
          const adminPage = document.getElementById('adminPage');
          if (loginPage && adminPage) {
            loginPage.style.setProperty('display', 'none', 'important');
            adminPage.style.setProperty('display', 'block', 'important');
          }
        }
        return;
      }
      
      const token = localStorage.getItem('adminToken');
      const user = localStorage.getItem('adminUser');
      const loginPage = document.getElementById('loginPage');
      const adminPage = document.getElementById('adminPage');
      
      if (!loginPage || !adminPage) {
        console.warn('‚ö†Ô∏è ÁôªÂΩïÈ°µÈù¢ÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåÂª∂ËøüÊ£ÄÊü•...');
        setTimeout(checkAuth, 100);
        return;
      }
      
      // Ê£ÄÊü•ËÆ°ÁÆóÊ†∑ÂºèÔºåÊõ¥ÂáÜÁ°Æ
      const loginPageComputed = window.getComputedStyle(loginPage).display;
      const adminPageComputed = window.getComputedStyle(adminPage).display;
      
      // Â¶ÇÊûúÁÆ°ÁêÜÈ°µÈù¢Â∑≤ÁªèÊòæÁ§∫Ôºå‰∏îÁî®Êà∑Â∑≤ÁôªÂΩïÔºå‰∏çÊâßË°å‰ªª‰ΩïÊìç‰Ωú
      if (adminPageComputed === 'block' && token && user) {
        console.log('‚úÖ Áî®Êà∑Â∑≤ÁôªÂΩïÔºåÁÆ°ÁêÜÈ°µÈù¢Â∑≤ÊòæÁ§∫ÔºåË∑≥ËøáÊ£ÄÊü•');
        return;
      }
      
      if (token && user) {
        try {
          const userData = JSON.parse(user);
          if (userData.role === 'admin' || userData.role === 'ÁÆ°ÁêÜÂëò') {
            // Âè™ÊúâÂú®ÁôªÂΩïÈ°µÈù¢ÊòæÁ§∫Êó∂ÊâçÂàáÊç¢Ôºà‰ΩøÁî®ËÆ°ÁÆóÊ†∑ÂºèÂà§Êñ≠Ôºâ
            const loginPageComputed = window.getComputedStyle(loginPage).display;
            if (loginPageComputed !== 'none') {
              loginPage.style.setProperty('display', 'none', 'important');
              adminPage.style.setProperty('display', 'block', 'important');
              loginPage.style.display = 'none';
              adminPage.style.display = 'block';
              
              const userNameText = userData.username || 'ÁÆ°ÁêÜÂëò';
              const adminUserNameEl = document.getElementById('adminUserName');
              if (adminUserNameEl) {
                const mode = localStorage.getItem('offlineMode') === 'true' ? 'ÔºàÁ¶ªÁ∫øÊ®°ÂºèÔºâ' : '';
                adminUserNameEl.textContent = `Ê¨¢ËøéÔºå${userNameText}${mode}`;
              }
              
              if (typeof updateTopBarUserDisplay === 'function') {
                try {
                  updateTopBarUserDisplay();
                } catch (e) {
                  console.warn('updateTopBarUserDisplay Ë∞ÉÁî®Â§±Ë¥•:', e);
                }
              }
              
              if (typeof loadAnnouncements === 'function') {
                try {
                  loadAnnouncements();
                } catch (e) {
                  console.warn('loadAnnouncements Ë∞ÉÁî®Â§±Ë¥•:', e);
                }
              }
              
              // ÂàùÂßãÂåñEvoÂä©Êâã
              setTimeout(() => {
                if (typeof initEvoAssistant === 'function') {
                  try {
                    initEvoAssistant();
                  } catch (e) {
                    console.warn('initEvoAssistant Ë∞ÉÁî®Â§±Ë¥•:', e);
                  }
                }
              }, 500);
              
              console.log('‚úÖ checkAuthÔºöÂ∑≤ÂàáÊç¢Âà∞ÁÆ°ÁêÜÈ°µÈù¢');
            }
            return;
          }
        } catch (e) {
          console.error('Ëß£ÊûêÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', e);
          // Ê∏ÖÈô§Êó†ÊïàÁöÑÁôªÂΩï‰ø°ÊÅØ
          localStorage.removeItem('adminToken');
          localStorage.removeItem('adminUser');
        }
      }
      
      // Âè™ÊúâÂú®ÁÆ°ÁêÜÈ°µÈù¢ÊòæÁ§∫Êó∂ÊâçÂàáÊç¢ÂõûÁôªÂΩïÈ°µÔºà‰ΩÜË¶ÅÊ£ÄÊü•ÊòØÂê¶ÂàöÂàöÁôªÂΩïÔºâ
      if (adminPageComputed === 'block' && (!token || !user)) {
        // Â¶ÇÊûúÂàöÂàöÁôªÂΩïÔºå‰∏çÊâßË°åÂàáÊç¢
        if (window.__justLoggedIn) {
          console.log('‚è∏Ô∏è checkAuthÔºöÊ£ÄÊµãÂà∞ÂàöÂàöÁôªÂΩïÔºåË∑≥ËøáÂàáÊç¢ÂõûÁôªÂΩïÈ°µ');
          return;
        }
        
        loginPage.style.setProperty('display', 'flex', 'important');
        adminPage.style.setProperty('display', 'none', 'important');
        console.log('‚ö†Ô∏è checkAuthÔºöÊú™ÁôªÂΩïÔºåÂ∑≤ÂàáÊç¢Âà∞ÁôªÂΩïÈ°µÈù¢');
      }
    }
    
    // È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÔºàÂª∂ËøüÊâßË°åÔºåÈÅøÂÖç‰∏éÁôªÂΩïÊµÅÁ®ãÂÜ≤Á™ÅÔºâ
    function safeCheckAuth() {
      // Â¶ÇÊûúÊ≠£Âú®ÁôªÂΩïÊàñÂàöÂàöÁôªÂΩïÔºåË∑≥Ëøá
      if (window.__loginInProgress || window.__justLoggedIn) {
        console.log('‚è∏Ô∏è Âª∂ËøücheckAuthÔºöÁôªÂΩïÊµÅÁ®ãËøõË°å‰∏≠');
        setTimeout(safeCheckAuth, 1000);
        return;
      }
      // ÂÆâÂÖ®ÁâàÊú¨ÁöÑcheckAuthË∞ÉÁî®ÔºàÊ£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÔºâ
    if (!window.__loginInProgress && !window.__justLoggedIn) {
      setTimeout(function() {
        if (!window.__loginInProgress && !window.__justLoggedIn) {
          checkAuth();
        }
      }, 2000);
    }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(safeCheckAuth, 1000);
      });
    } else {
      setTimeout(safeCheckAuth, 1000);
    }
    
    // ‰æßËæπÊ†èËèúÂçïÂàáÊç¢
    document.querySelectorAll('.sidebar-item').forEach(item => {
      item.addEventListener('click', () => {
        const tabName = item.dataset.tab;
        
        // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØEvoËÆæÁΩÆÔºåÂä†ËΩΩAI‰ø°ÊÅØ
        if (tabName === 'evoSettings') {
          console.log('üîÑ ÁÇπÂáªEvoËÆæÁΩÆËèúÂçïÈ°πÔºåÂáÜÂ§áÂä†ËΩΩAI‰ø°ÊÅØ...');
          setTimeout(() => {
            loadEvoAIModelInfo();
          }, 300);
        }
        
        // Êõ¥Êñ∞ËèúÂçïÁä∂ÊÄÅ
        document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        
        // ÈöêËóèÊâÄÊúâsectionÂíåtab
        document.querySelectorAll('section[id$="View"], section[id$="View"]').forEach(section => {
          section.style.display = 'none';
        });
        document.querySelectorAll('[id$="Tab"]').forEach(tab => {
          tab.style.display = 'none';
        });
        
        // Ê†πÊçÆÈÄâÊã©ÁöÑËèúÂçïÊéßÂà∂‰∏ªÂÜÖÂÆπÊòæÁ§∫ÔºàÁ≥ªÁªüÂçáÁ∫ßÊòØÁã¨Á´ãÈ°µÈù¢Ôºâ
        const mainContentEl = document.querySelector('.main-content');
        if (mainContentEl) {
          if (tabName === 'upgradeView') {
            mainContentEl.style.display = 'none';
          } else {
            mainContentEl.style.display = '';
          }
        }
        
        // ÊòæÁ§∫ÂØπÂ∫îÁöÑËßÜÂõæÊàñÊ†áÁ≠æÈ°µ
        // ‰∏ªÁ´ôÂäüËÉΩÊ®°Âùó‰ΩøÁî®ViewÂêéÁºÄ
        // Ê≥®ÊÑèÔºöcoreAdminView ËôΩÁÑ∂‰ª• View ÁªìÂ∞æÔºå‰ΩÜÂÆûÈôÖ‰ΩøÁî®ÁöÑÊòØ Tab ÂêéÁºÄÁöÑÂÖÉÁ¥†
        if (tabName === 'coreAdminView') {
          // ‰∏≠Êû¢ÁÆ°ÂÆ∂‰ΩøÁî®coreAdminViewTab‰Ωú‰∏∫ID
          const coreAdminTab = document.getElementById('coreAdminViewTab');
          if (coreAdminTab) {
            coreAdminTab.style.display = 'block';
          }
        } else if (tabName === 'upgradeView') {
          const upgradeTab = document.getElementById('upgradeViewTab');
          if (upgradeTab) {
            upgradeTab.style.display = 'block';
            // Á°Æ‰øùÁ≥ªÁªüÂçáÁ∫ßÂå∫ÂüüÂú®ÂèØËßÜÂå∫ÂüüÂÜÖÔºàÂÆÉ‰Ωç‰∫é‰∏ªÂÜÖÂÆπ‰πãÂêéÔºâ
            setTimeout(() => {
              try {
                upgradeTab.scrollIntoView({ behavior: 'smooth', block: 'start' });
              } catch (e) {
                // Safari ËÄÅÁâàÊú¨ÂèØËÉΩ‰∏çÊîØÊåÅ options ÂÜôÊ≥ïÔºåÈôçÁ∫ßÂ§ÑÁêÜ
                upgradeTab.scrollIntoView(true);
              }
            }, 50);
          }
        } else if (tabName.endsWith('View')) {
          const targetView = document.getElementById(tabName);
          if (targetView) {
            targetView.style.display = '';
            // Â¶ÇÊûúÊòØcardÁ±ªÂûãÁöÑsectionÔºåÈúÄË¶ÅËÆæÁΩÆ‰∏∫block
            if (targetView.classList.contains('card')) {
              targetView.style.display = 'block';
            }
          }
        } else {
          // Êô∫ËÉΩÁÆ°ÁêÜÂäüËÉΩ‰ΩøÁî®TabÂêéÁºÄ
          const targetTab = document.getElementById(`${tabName}Tab`);
          if (targetTab) {
            targetTab.style.display = 'block';
            
            // Â¶ÇÊûúÂàáÊç¢Âà∞Á≥ªÁªüËÆæÁΩÆÔºåÂä†ËΩΩËÆæÁΩÆÊï∞ÊçÆ
            if (tabName === 'settings') {
              loadSystemSettings();
            }
            
            // Â¶ÇÊûúÊòØEvoËÆæÁΩÆÊ†áÁ≠æÈ°µÔºåÂä†ËΩΩAI‰ø°ÊÅØ
            if (tabName === 'evoSettings') {
              console.log('üîÑ EvoËÆæÁΩÆÊ†áÁ≠æÈ°µÂ∑≤ÊòæÁ§∫ÔºåÂä†ËΩΩAI‰ø°ÊÅØ...');
              setTimeout(() => {
                loadEvoAIModelInfo();
              }, 200);
            }
          }
        }
        
        // Âä†ËΩΩÂØπÂ∫îÂÜÖÂÆπ
        if (tabName === 'announcements') {
          loadAnnouncements();
        } else if (tabName === 'homeView') {
          // ÂàùÂßãÂåñÈ¶ñÈ°µÂÜÖÂÆπ
          initHomeView();
        } else if (tabName === 'dashboardView') {
          // ÂàùÂßãÂåñÊï∞ÊçÆÊ¶ÇËßà
          if (typeof refreshDashboard === 'function') refreshDashboard();
        } else if (tabName === 'listView') {
          // ÂàùÂßãÂåñÈ∏ΩÂ≠êÁÆ°ÁêÜ
          if (typeof renderPigeonList === 'function') renderPigeonList();
        } else if (tabName === 'pedigreeView') {
          // ÂàùÂßãÂåñË°ÄÁªüÂÖ≥Á≥ª
          if (typeof fillPedigreeSelect === 'function') fillPedigreeSelect();
        } else if (tabName === 'statsView') {
          // ÂàùÂßãÂåñÁªüËÆ°ÂàÜÊûê
          if (typeof renderStatsViewTable === 'function') renderStatsViewTable();
        } else if (tabName === 'raceView') {
          // ÂàùÂßãÂåñÊØîËµõÁÆ°ÁêÜ
          if (typeof loadRaces === 'function') loadRaces();
        } else if (tabName === 'breedingView') {
          // ÂàùÂßãÂåñÁπÅËÇ≤ÈÖçÂØπ
          if (typeof fillBreedingSelects === 'function') fillBreedingSelects();
        } else if (tabName === 'healthView') {
          // ÂàùÂßãÂåñÂÅ•Â∫∑ÁÆ°ÁêÜ
          if (typeof renderHealthOverview === 'function') renderHealthOverview();
        } else if (tabName === 'analysisView') {
          // ÂàùÂßãÂåñÊô∫ËÉΩÂàÜÊûê
          if (typeof runFullAnalysis === 'function') runFullAnalysis();
        } else if (tabName === 'trainingView') {
          // ÂàùÂßãÂåñËÆ≠ÁªÉÊ®°Âùó
          if (typeof loadTrainingHistory === 'function') loadTrainingHistory();
        } else if (tabName === 'qualificationView') {
          // ÂàùÂßãÂåñËÉΩÂäõÂàÜÊûê
          if (typeof fillQualificationSelect === 'function') fillQualificationSelect();
        } else if (tabName === 'feedbackView') {
          // Âä†ËΩΩÊÑèËßÅ‰∏éÂèçÈ¶àÂàóË°®
          if (typeof loadFeedbackList === 'function') loadFeedbackList();
        } else if (tabName === 'evoSettings') {
          // ÂàùÂßãÂåñEvoËÆæÁΩÆ‰∏éÁõ∏ÂÖ≥Âä©ÊâãÈÖçÁΩÆ
          loadEvoSettings();
          loadAdminAIModelInfo(); // Âä†ËΩΩAIÊ®°Âûã‰ø°ÊÅØ
          // ÂêåÊó∂Âä†ËΩΩÊô∫Ë∞±API‰∏éÂä©ÊâãË°å‰∏∫ÈÖçÁΩÆÔºàÂÜôÂÖ• localStorageÔºåÁî®‰∫é‰∏ªÁ´ô Evo ‰ΩøÁî®Ôºâ
          if (typeof loadZhipuConfig === 'function') loadZhipuConfig();
          if (typeof loadAssistantConfig === 'function') loadAssistantConfig();
        } else if (tabName === 'coreAdminView') {
          // ‰∏≠Êû¢ÁÆ°ÂÆ∂Ê†áÁ≠æÈ°µÂ∑≤Âú®‰∏äÈù¢Áªü‰∏ÄÂ§ÑÁêÜÊòæÁ§∫
          // ÂàùÂßãÂåñ‰∏≠Êû¢ÁÆ°ÂÆ∂
          setTimeout(() => {
            loadCoreAdminData();
          }, 200);
        } else if (tabName === 'upgradeView') {
          // ÂàùÂßãÂåñÁ≥ªÁªüÂçáÁ∫ß
          setTimeout(() => {
            loadUpgradeData();
          }, 200);
        }
      });
    });
    
    // Âä†ËΩΩÂÖ¨ÂëäÂàóË°®
    async function loadAnnouncements() {
      const container = document.getElementById('announcementsList');
      const token = localStorage.getItem('adminToken');
      if (!token) {
        container.innerHTML = '<p class="muted" style="text-align: center; padding: 40px;">ËØ∑ÂÖàÁôªÂΩï</p>';
        return;
      }
      
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`${getApiUrl()}/admin/announcements`, {
          headers: {
            'Authorization': `Bearer ${token}`
          },
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error('Ëé∑ÂèñÂÖ¨ÂëäÂàóË°®Â§±Ë¥•');
        }
        
        const result = await response.json();
        const announcements = result.data || [];
        
        if (announcements.length === 0) {
          container.innerHTML = '<p class="muted" style="text-align: center; padding: 40px;">ÊöÇÊó†ÂÖ¨ÂëäÔºåÁÇπÂáª"ÂèëÂ∏ÉÊñ∞ÂÖ¨Âëä"ÂàõÂª∫Á¨¨‰∏ÄÊù°ÂÖ¨Âëä</p>';
        } else {
          // ËΩ¨‰πâHTMLÂáΩÊï∞
          function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
          }
          
          container.innerHTML = announcements.map(ann => {
            const content = ann.content || '';
            const escapedContent = escapeHtml(content);
            const isLong = content.length > 150;
            const displayContent = isLong ? escapedContent.substring(0, 150) + '...' : escapedContent;
            
            // ÂÆâÂÖ®Âú∞Ê†ºÂºèÂåñÊó•Êúü
            function formatDate(dateString) {
              try {
                if (!dateString) return '-';
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '-';
                return date.toLocaleString('zh-CN');
              } catch (e) {
                return '-';
              }
            }
            
            const createdAtStr = formatDate(ann.createdAt);
            const updatedAtStr = ann.updatedAt && ann.updatedAt !== ann.createdAt ? formatDate(ann.updatedAt) : null;
            
            return `
            <div class="announcement-item">
              <div class="announcement-content" id="announcement-content-${ann.id}" onclick="toggleAnnouncementContent('${ann.id}')" data-full-content="${escapeHtml(escapedContent)}">
                ${displayContent}
              </div>
              ${isLong ? `<div class="announcement-view-full" onclick="event.stopPropagation(); viewFullAnnouncement('${ann.id}')">üìñ Êü•ÁúãÂÆåÊï¥ÂÖ¨Âëä</div>` : ''}
              <div class="announcement-meta">
                ${ann.active ? '<span class="status-badge status-active">‚úì Â∑≤ÂèëÂ∏É</span>' : '<span class="status-badge status-draft">‚úó ËçâÁ®ø</span>'}
                ¬∑ ÂàõÂª∫Êó∂Èó¥Ôºö${createdAtStr}
                ${updatedAtStr ? ` ¬∑ Êõ¥Êñ∞Êó∂Èó¥Ôºö${updatedAtStr}` : ''}
              </div>
              <div class="announcement-actions">
                <button class="btn btn-outline btn-sm" onclick="viewAnnouncementHistory('${ann.id}')">ÂéÜÂè≤</button>
                <button class="btn btn-outline btn-sm" onclick="editAnnouncement('${ann.id}')">ÁºñËæë</button>
                <button class="btn btn-outline btn-sm" onclick="deleteAnnouncement('${ann.id}')" style="color: var(--danger);">Âà†Èô§</button>
              </div>
            </div>
          `;
          }).join('');
          
          // ‰øùÂ≠òÂÆåÊï¥ÂÖ¨ÂëäÊï∞ÊçÆ‰æõÊü•Áúã‰ΩøÁî®
          window.announcementsData = announcements;
        }
        
        // Âä†ËΩΩÂéÜÂè≤ÂÖ¨Âëä
        loadAnnouncementHistory();
      } catch (error) {
        if (error.name === 'AbortError' || error.message.includes('Failed to fetch') || error.message.includes('Load failed')) {
          container.innerHTML = '<div style="padding: 20px; background: var(--warning-light); border-radius: var(--radius-md); margin-bottom: 16px;"><p style="color: #92400e; margin: 0;">‚ö†Ô∏è Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®„ÄÇËØ∑Ê£ÄÊü•ÂêéÁ´ØÊúçÂä°ÊòØÂê¶Â∑≤ÂêØÂä®„ÄÇ</p></div><p class="muted" style="text-align: center; padding: 40px;">Êó†Ê≥ïÂä†ËΩΩÂÖ¨ÂëäÂàóË°®</p>';
        } else {
        container.innerHTML = `<p style="color: var(--danger); text-align: center; padding: 40px;">Âä†ËΩΩÂ§±Ë¥•Ôºö${error.message}</p>`;
        }
        // Âç≥‰ΩøÂÖ¨ÂëäÂàóË°®Âä†ËΩΩÂ§±Ë¥•Ôºå‰πüÂ∞ùËØïÂä†ËΩΩÂéÜÂè≤ÂÖ¨Âëä
        loadAnnouncementHistory();
      }
    }
    
    // Âä†ËΩΩÂéÜÂè≤ÂÖ¨ÂëäÂàóË°®
    async function loadAnnouncementHistory() {
      const container = document.getElementById('announcementHistoryList');
      if (!container) return;
      
      const token = localStorage.getItem('adminToken');
      if (!token) {
        container.innerHTML = '<p class="muted" style="text-align: center; padding: 40px;">ËØ∑ÂÖàÁôªÂΩï</p>';
        return;
      }
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`${getApiUrl()}/admin/announcements`, {
          headers: {
            'Authorization': `Bearer ${token}`
          },
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error('Ëé∑ÂèñÂÖ¨ÂëäÂàóË°®Â§±Ë¥•');
        }
        
        const result = await response.json();
        const announcements = result.data || [];
        
        // Êî∂ÈõÜÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩïÔºàÂåÖÊã¨ÂΩìÂâçÁâàÊú¨Ôºâ
        const allHistoryItems = [];
        
        // È™åËØÅÊó•ÊúüÊòØÂê¶ÊúâÊïàÁöÑËæÖÂä©ÂáΩÊï∞
        function isValidDate(dateString) {
          if (!dateString) return false;
          const date = new Date(dateString);
          return date instanceof Date && !isNaN(date);
        }
        
        // Ëé∑ÂèñÊúâÊïàÁöÑÊó∂Èó¥Êà≥
        function getValidTimestamp(timestamp, fallback) {
          if (isValidDate(timestamp)) {
            return timestamp;
          }
          if (fallback && isValidDate(fallback)) {
            return fallback;
          }
          return new Date().toISOString();
        }
        
        announcements.forEach(ann => {
          const validTimestamp = getValidTimestamp(ann.updatedAt, ann.createdAt);
          
          // Ê∑ªÂä†ÂΩìÂâçÁâàÊú¨‰Ωú‰∏∫ÂéÜÂè≤ËÆ∞ÂΩï
          allHistoryItems.push({
            announcementId: ann.id,
            announcementContent: ann.content || '',
            content: ann.content || '',
            active: ann.active !== undefined ? ann.active : true,
            timestamp: validTimestamp,
            isCurrent: true
          });
          
          // Ê∑ªÂä†ÂéÜÂè≤ÁâàÊú¨
          if (ann.history && Array.isArray(ann.history) && ann.history.length > 0) {
            ann.history.forEach((histItem, idx) => {
              const histTimestamp = getValidTimestamp(histItem.timestamp, validTimestamp);
              allHistoryItems.push({
                announcementId: ann.id,
                announcementContent: ann.content || '',
                content: histItem.content || '',
                active: histItem.active !== undefined ? histItem.active : (ann.active !== undefined ? ann.active : true),
                timestamp: histTimestamp,
                isCurrent: false,
                versionIndex: idx + 1
              });
            });
          }
        });
        
        // ÊåâÊó∂Èó¥ÂÄíÂ∫èÊéíÂàóÔºàÊ∑ªÂä†ÈîôËØØÂ§ÑÁêÜÔºâ
        allHistoryItems.sort((a, b) => {
          try {
            const dateA = new Date(a.timestamp);
            const dateB = new Date(b.timestamp);
            if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) {
              return 0; // Â¶ÇÊûúÊó•ÊúüÊó†ÊïàÔºå‰øùÊåÅÂéüÊúâÈ°∫Â∫è
            }
            return dateB - dateA;
          } catch (e) {
            return 0;
          }
        });
        
        if (allHistoryItems.length === 0) {
          container.innerHTML = '<p class="muted" style="text-align: center; padding: 40px;">ÊöÇÊó†ÂéÜÂè≤ÂÖ¨ÂëäËÆ∞ÂΩï</p>';
          return;
        }
        
        // ËΩ¨‰πâHTMLÂáΩÊï∞
        function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text || '';
          return div.innerHTML;
        }
        
        // Â∞ÜÂéÜÂè≤Êï∞ÊçÆÂ≠òÂÇ®Âà∞ÂÖ®Â±ÄÂèòÈáèÔºå‰æõÊåâÈíÆ‰∫ã‰ª∂‰ΩøÁî®
        window.allHistoryItemsData = allHistoryItems;
        
        container.innerHTML = allHistoryItems.map((item, index) => {
          const content = item.content || '';
          const escapedContent = escapeHtml(content);
          const isLong = content.length > 100;
          const displayContent = isLong ? escapedContent.substring(0, 100) + '...' : escapedContent;
          
          // ÂÆâÂÖ®Âú∞Ê†ºÂºèÂåñÊó∂Èó¥Êà≥
          let timestamp = '-';
          try {
            const date = new Date(item.timestamp);
            if (!isNaN(date.getTime())) {
              timestamp = date.toLocaleString('zh-CN');
            }
          } catch (e) {
            console.warn('Êó∂Èó¥Êà≥Ê†ºÂºèÂåñÂ§±Ë¥•:', item.timestamp, e);
          }
          
          return `
            <div class="announcement-history-item" style="padding: 16px; border: 1px solid var(--border-light); border-radius: var(--radius-md); margin-bottom: 12px; background: var(--bg-secondary);">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                    ${item.isCurrent ? '<span style="background: var(--primary-light); color: var(--primary); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">ÂΩìÂâçÁâàÊú¨</span>' : ''}
                    <span style="color: var(--text-secondary); font-size: 12px;">${timestamp}</span>
                  </div>
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                    Áä∂ÊÄÅÔºö${item.active ? '<span style="color: var(--success);">‚úì Â∑≤ÂèëÂ∏É</span>' : '<span style="color: var(--text-muted);">‚úó ËçâÁ®ø</span>'}
                  </div>
                </div>
              </div>
              <div class="history-content" style="color: var(--text-primary); line-height: 1.6; word-break: break-word; white-space: pre-wrap;">
                ${displayContent}
              </div>
              ${isLong ? `<div style="margin-top: 8px;"><button class="btn btn-ghost btn-sm view-history-detail-btn" data-index="${index}" style="font-size: 12px; padding: 4px 8px;">Êü•ÁúãÂÆåÊï¥ÂÜÖÂÆπ</button></div>` : ''}
            </div>
          `;
        }).join('');
        
        // ‰∏∫Êü•ÁúãËØ¶ÊÉÖÊåâÈíÆÁªëÂÆö‰∫ã‰ª∂
        container.querySelectorAll('.view-history-detail-btn').forEach((btn) => {
          btn.addEventListener('click', function() {
            // ‰ªéÂ≠òÂÇ®ÁöÑÂÖ®Â±ÄÊï∞ÊçÆ‰∏≠Ëé∑ÂèñÂÜÖÂÆπÔºàÈÅøÂÖçHTMLËΩ¨‰πâÈóÆÈ¢òÔºâ
            const idx = parseInt(this.dataset.index);
            const item = window.allHistoryItemsData && window.allHistoryItemsData[idx];
            if (item) {
              viewHistoryItemDetail(item.content, item.timestamp, item.active, item.announcementId);
            }
          });
        });
        
      } catch (error) {
        console.error('Âä†ËΩΩÂéÜÂè≤ÂÖ¨ÂëäÂ§±Ë¥•:', error);
        if (error.name === 'AbortError' || error.message.includes('Failed to fetch')) {
          container.innerHTML = '<p class="muted" style="text-align: center; padding: 40px; color: var(--danger);">Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®ÔºåËØ∑Ê£ÄÊü•ÂêéÁ´ØÊòØÂê¶Â∑≤ÂêØÂä®</p>';
        } else {
          container.innerHTML = `<p style="color: var(--danger); text-align: center; padding: 40px;">Âä†ËΩΩÂ§±Ë¥•Ôºö${error.message}</p>`;
        }
      }
    }
    
    // Êü•ÁúãÂéÜÂè≤ËÆ∞ÂΩïËØ¶ÊÉÖ
    window.viewHistoryItemDetail = function(content, timestamp, active, announcementId) {
      let detailModal = document.getElementById('historyDetailModal');
      let isNewModal = false;
      
      if (!detailModal) {
        isNewModal = true;
        detailModal = document.createElement('div');
        detailModal.id = 'historyDetailModal';
        detailModal.className = 'modal';
        detailModal.innerHTML = `
          <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
              <h3>üìú ÂéÜÂè≤ÂÖ¨ÂëäËØ¶ÊÉÖ</h3>
              <button class="btn btn-ghost btn-sm" onclick="closeHistoryDetailModal()" style="padding: 4px 12px;">‚úï</button>
            </div>
            <div class="modal-body">
              <div style="margin-bottom: 16px;">
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                  üìÖ Êó∂Èó¥Ôºö<span id="historyDetailTimestamp"></span>
                </div>
                <div style="font-size: 13px; color: var(--text-secondary);">
                  Áä∂ÊÄÅÔºö<span id="historyDetailStatus"></span>
                </div>
              </div>
              <div style="padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); white-space: pre-wrap; word-break: break-word; line-height: 1.8; color: var(--text-primary);" id="historyDetailContent"></div>
              <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-primary" onclick="closeHistoryDetailModal()">ÂÖ≥Èó≠</button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(detailModal);
        
        // Âè™Âú®È¶ñÊ¨°ÂàõÂª∫Êó∂ÁªëÂÆöÁÇπÂáªËÉåÊôØÂÖ≥Èó≠‰∫ã‰ª∂ÔºàÈÅøÂÖçÈáçÂ§çÁªëÂÆöÔºâ
        detailModal.addEventListener('click', function(e) {
          if (e.target === detailModal) {
            closeHistoryDetailModal();
          }
        });
      }
      
      // ÂÆâÂÖ®Âú∞Ê†ºÂºèÂåñÊó∂Èó¥Êà≥
      let formattedTimestamp = '-';
      try {
        if (timestamp) {
          const date = new Date(timestamp);
          if (!isNaN(date.getTime())) {
            formattedTimestamp = date.toLocaleString('zh-CN');
          }
        }
      } catch (e) {
        console.warn('Êó∂Èó¥Êà≥Ê†ºÂºèÂåñÂ§±Ë¥•:', timestamp, e);
      }
      document.getElementById('historyDetailTimestamp').textContent = formattedTimestamp;
      document.getElementById('historyDetailStatus').innerHTML = active 
        ? '<span style="color: var(--success);">‚úì Â∑≤ÂèëÂ∏É</span>' 
        : '<span style="color: var(--text-muted);">‚úó ËçâÁ®ø</span>';
      
      // ËÆæÁΩÆÂÜÖÂÆπÔºà‰ΩøÁî®textContentÁ°Æ‰øùÂÆâÂÖ®ÊòæÁ§∫Ôºâ
      document.getElementById('historyDetailContent').textContent = content || 'ÊöÇÊó†ÂÜÖÂÆπ';
      
      detailModal.classList.add('active');
    };
    
    window.closeHistoryDetailModal = function() {
      const modal = document.getElementById('historyDetailModal');
      if (modal) {
        modal.classList.remove('active');
      }
    };

    // ÊÑèËßÅ‰∏éÂèçÈ¶àÁ≠õÈÄâ‰∏éÂà∑Êñ∞ÊåâÈíÆ‰∫ã‰ª∂
    (function initFeedbackEvents() {
      const statusSelect = document.getElementById('feedbackStatusFilter');
      const refreshBtn = document.getElementById('btnRefreshFeedback');

      if (statusSelect) {
        statusSelect.addEventListener('change', () => {
          loadFeedbackList();
        });
      }

      if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
          loadFeedbackList();
        });
      }
    })();

    // Âä†ËΩΩÁî®Êà∑ÊÑèËßÅ‰∏éÂèçÈ¶àÂàóË°®
    async function loadFeedbackList() {
      const tbody = document.getElementById('feedbackTableBody');
      const statusFilter = document.getElementById('feedbackStatusFilter');
      const token = localStorage.getItem('adminToken');

      if (!tbody) return;

      if (!token) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:32px;">ËØ∑ÂÖàÁôªÂΩï</td></tr>';
        return;
      }

      const status = statusFilter ? statusFilter.value : '';

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);

        const url = new URL(`${getApiUrl()}/admin/feedbacks`);
        if (status) {
          url.searchParams.set('status', status);
        }

        const response = await fetch(url.toString(), {
          headers: {
            'Authorization': `Bearer ${token}`
          },
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error('Ëé∑ÂèñÂèçÈ¶àÂàóË°®Â§±Ë¥•');
        }

        const result = await response.json();
        const items = (result.data && result.data.items) || [];

        if (items.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:32px;">ÊöÇÊó†ÂèçÈ¶àÊï∞ÊçÆ</td></tr>';
          return;
        }

        function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text || '';
          return div.innerHTML;
        }

        tbody.innerHTML = items.map(item => {
          const createdAt = item.createdAt ? new Date(item.createdAt).toLocaleString('zh-CN') : '-';
          const source = item.source || 'web';
          const page = item.page || '';
          const user = item.username ? `${escapeHtml(item.username)} (${item.userId || '-'})` : 'Êú™ÁôªÂΩïÁî®Êà∑';
          const content = escapeHtml(item.content || '');
          const contact = escapeHtml(item.contact || '');

          const sourceLabel = source === 'mobile' ? 'ÁßªÂä®Á´Ø' : 'ÁΩëÈ°µÁ´Ø';
          const pageLabel = page ? ` / ${page}` : '';

          return `
            <tr>
              <td>${createdAt}</td>
              <td>${sourceLabel}${pageLabel}</td>
              <td>${user}</td>
              <td style="max-width:360px;white-space:normal;word-break:break-word;">${content}</td>
              <td>${contact || '<span style="color:var(--text-muted);">Êú™Â°´ÂÜô</span>'}</td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        console.error('Âä†ËΩΩÂèçÈ¶àÂàóË°®Â§±Ë¥•:', error);
        if (error.name === 'AbortError' || error.message.includes('Failed to fetch') || error.message.includes('Load failed')) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--danger);padding:32px;">Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®ÔºåËØ∑Ê£ÄÊü•ÂêéÁ´ØÊòØÂê¶Â∑≤ÂêØÂä®</td></tr>';
        } else {
          tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:var(--danger);padding:32px;">Âä†ËΩΩÂ§±Ë¥•Ôºö${error.message}</td></tr>`;
        }
      }
    }
    
    // ==========================================
    // Áî®Êà∑ÁÆ°ÁêÜÂäüËÉΩ
    // ==========================================
    
    // Âä†ËΩΩÁî®Êà∑ÂàóË°®
    window.loadUsers = async function() {
      const container = document.getElementById('usersList');
      const token = localStorage.getItem('adminToken');
      if (!token) {
        container.innerHTML = '<p class="muted" style="text-align: center; padding: 40px;">ËØ∑ÂÖàÁôªÂΩï</p>';
        return;
      }
      
      
      container.innerHTML = '<p class="muted" style="text-align: center; padding: 40px;">Âä†ËΩΩ‰∏≠...</p>';
      
      try {
        const searchQuery = document.getElementById('userSearchInput')?.value || '';
        const apiUrl = getApiUrl();
        
        // Âä†ËΩΩÁî®Êà∑ÂàóË°®
        const usersResponse = await fetch(`${apiUrl}/admin/users?limit=100${searchQuery ? `&search=${encodeURIComponent(searchQuery)}` : ''}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!usersResponse.ok) {
          throw new Error('Ëé∑ÂèñÁî®Êà∑ÂàóË°®Â§±Ë¥•');
        }
        
        const usersResult = await usersResponse.json();
        const users = usersResult.data?.users || [];
        
        // Âä†ËΩΩÁî®Êà∑Êï∞ÊçÆÁªüËÆ°
        const dataResponse = await fetch(`${apiUrl}/admin/users/data`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        let userDataStats = {};
        if (dataResponse.ok) {
          const dataResult = await dataResponse.json();
          if (dataResult.success && dataResult.data) {
            dataResult.data.forEach(stat => {
              userDataStats[stat.userId] = stat;
            });
          }
        }
        
        if (users.length === 0) {
          container.innerHTML = '<p class="muted" style="text-align: center; padding: 40px;">ÊöÇÊó†Áî®Êà∑</p>';
          return;
        }
        
        container.innerHTML = `
          <div style="overflow-x:auto;">
            <table style="width:100%;border-collapse:collapse;">
              <thead>
                <tr style="background:var(--gray-50);border-bottom:2px solid var(--border-light);">
                  <th style="padding:12px;text-align:left;font-weight:600;color:var(--text-primary);">Áî®Êà∑Âêç</th>
                  <th style="padding:12px;text-align:left;font-weight:600;color:var(--text-primary);">ÈÇÆÁÆ±</th>
                  <th style="padding:12px;text-align:left;font-weight:600;color:var(--text-primary);">ËßíËâ≤</th>
                  <th style="padding:12px;text-align:left;font-weight:600;color:var(--text-primary);">Áä∂ÊÄÅ</th>
                  <th style="padding:12px;text-align:left;font-weight:600;color:var(--text-primary);">È∏ΩÂ≠êÊï∞Èáè</th>
                  <th style="padding:12px;text-align:left;font-weight:600;color:var(--text-primary);">Ê≥®ÂÜåÊó∂Èó¥</th>
                  <th style="padding:12px;text-align:left;font-weight:600;color:var(--text-primary);">ÊúÄÂêéÁôªÂΩï</th>
                  <th style="padding:12px;text-align:left;font-weight:600;color:var(--text-primary);">Êìç‰Ωú</th>
                </tr>
              </thead>
              <tbody>
                ${users.map(user => {
                  const stats = userDataStats[user.id] || {};
                  const statusBadge = user.status === 'active' 
                    ? '<span style="padding:4px 8px;background:#d1fae5;color:#065f46;border-radius:4px;font-size:12px;">‚úì Ê¥ªË∑É</span>'
                    : user.status === 'inactive'
                    ? '<span style="padding:4px 8px;background:#fef3c7;color:#92400e;border-radius:4px;font-size:12px;">‚óã Êú™ÊøÄÊ¥ª</span>'
                    : '<span style="padding:4px 8px;background:#fee2e2;color:#991b1b;border-radius:4px;font-size:12px;">‚úó Â∑≤Á¶ÅÁî®</span>';
                  
                  const roleBadge = user.role === 'admin'
                    ? '<span style="padding:4px 8px;background:#dbeafe;color:#1e40af;border-radius:4px;font-size:12px;">ÁÆ°ÁêÜÂëò</span>'
                    : '<span style="padding:4px 8px;background:#f3f4f6;color:#4b5563;border-radius:4px;font-size:12px;">ÊôÆÈÄöÁî®Êà∑</span>';
                  
                  return `
                    <tr style="border-bottom:1px solid var(--border-light);">
                      <td style="padding:12px;">${user.username || '--'}</td>
                      <td style="padding:12px;">${user.email || '--'}</td>
                      <td style="padding:12px;">${roleBadge}</td>
                      <td style="padding:12px;">${statusBadge}</td>
                      <td style="padding:12px;">
                        <span style="color:var(--primary);font-weight:600;">${stats.pigeonsCount || 0}</span>
                      </td>
                      <td style="padding:12px;color:var(--text-secondary);font-size:13px;">
                        ${user.createdAt ? new Date(user.createdAt).toLocaleString('zh-CN') : '--'}
                      </td>
                      <td style="padding:12px;color:var(--text-secondary);font-size:13px;">
                        ${user.lastLogin ? new Date(user.lastLogin).toLocaleString('zh-CN') : '‰ªéÊú™ÁôªÂΩï'}
                      </td>
                      <td style="padding:12px;">
                        <button class="btn btn-outline btn-sm" onclick="viewUserData('${user.id}', '${user.username}')" style="margin-right:8px;">üìä Êü•ÁúãÊï∞ÊçÆ</button>
                        ${user.status === 'active' 
                          ? `<button class="btn btn-outline btn-sm" onclick="updateUserStatus('${user.id}', 'inactive')" style="color:var(--warning);">Á¶ÅÁî®</button>`
                          : `<button class="btn btn-outline btn-sm" onclick="updateUserStatus('${user.id}', 'active')" style="color:var(--success);">ÂêØÁî®</button>`
                        }
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        console.error('Âä†ËΩΩÁî®Êà∑ÂàóË°®Â§±Ë¥•:', error);
        container.innerHTML = `<p style="color: var(--danger); text-align: center; padding: 40px;">Âä†ËΩΩÂ§±Ë¥•Ôºö${error.message}</p>`;
      }
    };
    
    // Êü•ÁúãÁî®Êà∑Êï∞ÊçÆ
    window.viewUserData = async function(userId, username) {
      const modal = document.getElementById('userDataModal');
      const modalBody = document.getElementById('userDataModalBody');
      const modalTitle = document.getElementById('userDataModalTitle');
      const token = localStorage.getItem('adminToken');
      
      if (!token) {
        alert('ËØ∑ÂÖàÁôªÂΩï');
        return;
      }
      
      modal.style.display = 'flex';
      modalTitle.textContent = `Áî®Êà∑Êï∞ÊçÆ - ${username}`;
      modalBody.innerHTML = '<p class="muted">Âä†ËΩΩ‰∏≠...</p>';
      
      try {
        const apiUrl = getApiUrl();
        const response = await fetch(`${apiUrl}/admin/users/${userId}/data`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆÂ§±Ë¥•');
        }
        
        const result = await response.json();
        const userData = result.data;
        const data = userData?.data || {};
        const pigeons = data.pigeons || [];
        const races = data.races || [];
        const healthRecords = data.healthRecords || [];
        const trainingRecords = data.trainingRecords || [];
        const pairings = data.pairings || [];
        const qualificationRecords = data.qualificationRecords || [];
        const sharing = userData.sharing || { visibility: 'private', allowedUserIds: [] };
        
        if (pigeons.length === 0 && races.length === 0 && healthRecords.length === 0 && trainingRecords.length === 0) {
          modalBody.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ËØ•Áî®Êà∑ÊöÇÊó†ÂêåÊ≠•Êï∞ÊçÆ</p>';
          return;
        }
        
        modalBody.innerHTML = `
          <div style="margin-bottom:20px;">
            <h4 style="margin-bottom:12px;">üìä Êï∞ÊçÆÁªüËÆ°</h4>
            <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;">
              <div style="padding:16px;background:var(--gray-50);border-radius:8px;">
                <div style="font-size:24px;font-weight:600;color:var(--primary);">${pigeons.length}</div>
                <div style="font-size:13px;color:var(--text-secondary);margin-top:4px;">È∏ΩÂ≠êÊÄªÊï∞</div>
              </div>
              <div style="padding:16px;background:var(--gray-50);border-radius:8px;">
                <div style="font-size:24px;font-weight:600;color:var(--success);">${pigeons.filter(p => p.alive !== false).length}</div>
                <div style="font-size:13px;color:var(--text-secondary);margin-top:4px;">Â≠òÊ¥ªÊï∞Èáè</div>
              </div>
              <div style="padding:16px;background:var(--gray-50);border-radius:8px;">
                <div style="font-size:13px;color:var(--text-secondary);">ÊúÄÂêéÊõ¥Êñ∞</div>
                <div style="font-size:14px;color:var(--text-primary);margin-top:4px;">${userData.updatedAt ? new Date(userData.updatedAt).toLocaleString('zh-CN') : '--'}</div>
              </div>
            </div>
          </div>
          
          <div style="margin-bottom:20px;">
            <h4 style="margin-bottom:12px;">üîê ÂÖ±‰∫´‰∏éÊùÉÈôê</h4>
            <div style="padding:16px;background:var(--gray-50);border-radius:8px;display:flex;flex-direction:column;gap:12px;">
              <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                <label style="font-size:13px;color:var(--text-secondary);min-width:80px;">ÂèØËßÅËåÉÂõ¥</label>
                <select id="userSharingVisibility" style="padding:6px 10px;border-radius:6px;border:1px solid var(--border-light);font-size:13px;">
                  <option value="private" ${sharing.visibility === 'private' ? 'selected' : ''}>‰ªÖÊú¨‰∫∫ÂèØËßÅ</option>
                  <option value="shared" ${sharing.visibility === 'shared' ? 'selected' : ''}>Á´ôÂÜÖÂÖ±‰∫´ÔºàÁôªÂΩïÁî®Êà∑ÂèØËßÅÔºâ</option>
                  <option value="public" ${sharing.visibility === 'public' ? 'selected' : ''}>ÂÖ¨ÂºÄÔºàÊâÄÊúâËÆøÂÆ¢ÂèØËßÅÔºâ</option>
                </select>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px;">
                <label style="font-size:13px;color:var(--text-secondary);">Âçè‰ΩúÁºñËæëÂÖÅËÆ∏ÁöÑÁî®Êà∑IDÔºàÈÄóÂè∑ÂàÜÈöîÔºåÂèØÈÄâÔºâ</label>
                <input id="userSharingAllowedIds" type="text" placeholder="‰æãÂ¶Ç: user_1,user_2" 
                  value="${Array.isArray(sharing.allowedUserIds) && sharing.allowedUserIds.length ? sharing.allowedUserIds.join(',') : ''}"
                  style="padding:6px 10px;border-radius:6px;border:1px solid var(--border-light);font-size:13px;width:100%;" />
                <p class="muted" style="font-size:12px;margin:0;">ËØ¥ÊòéÔºö‰ªÖÁÆ°ÁêÜÂëòÂíåÊï∞ÊçÆÊâÄÊúâËÄÖÂèØ‰ª•‰øÆÊîπÂÖ±‰∫´ËÆæÁΩÆÔºåÂÖ∂‰ªñÁî®Êà∑Âç≥‰ΩøËÉΩÊü•ÁúãÊï∞ÊçÆ‰πü‰∏çËÉΩÁºñËæë„ÄÇ</p>
              </div>
              <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:4px;">
                <button class="btn btn-outline btn-sm" onclick="saveUserSharing('${userId}')" style="font-size:13px;">üíæ ‰øùÂ≠òÂÖ±‰∫´ËÆæÁΩÆ</button>
              </div>
            </div>
          </div>
          
          <div>
            <h4 style="margin-bottom:12px;">üïäÔ∏è È∏ΩÂ≠êÂàóË°®</h4>
            <div style="max-height:400px;overflow-y:auto;">
              ${pigeons.length === 0 
                ? '<p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†È∏ΩÂ≠êÊï∞ÊçÆ</p>'
                : pigeons.map(p => `
                  <div style="padding:12px;background:var(--gray-50);border-radius:8px;margin-bottom:8px;">
                    <div style="font-weight:600;margin-bottom:4px;">${p.name || 'Êú™ÂëΩÂêç'}</div>
                    <div style="font-size:12px;color:var(--text-secondary);">
                      ${p.ringNumber ? `Ë∂≥ÁéØÂè∑: ${p.ringNumber} ¬∑ ` : ''}
                      ${p.gender ? `ÊÄßÂà´: ${p.gender} ¬∑ ` : ''}
                      ${p.type ? `Á±ªÂûã: ${p.type}` : ''}
                    </div>
                  </div>
                `).join('')
              }
            </div>
          </div>
          
          <div style="margin-top:24px;">
            <h4 style="margin-bottom:12px;">üèÅ ÊØîËµõËÆ∞ÂΩïÊ¶ÇËßà</h4>
            ${races.length === 0 
              ? '<p class="muted" style="font-size:13px;">ÊöÇÊó†ÊØîËµõÊï∞ÊçÆ</p>'
              : `<p class="muted" style="font-size:13px;margin-bottom:8px;">ÂÖ± ${races.length} Âú∫ÊØîËµõËÆ∞ÂΩï„ÄÇ</p>`}
          </div>
        `;
      } catch (error) {
        console.error('Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆÂ§±Ë¥•:', error);
        modalBody.innerHTML = `<p style="color: var(--danger); text-align: center; padding: 40px;">Âä†ËΩΩÂ§±Ë¥•Ôºö${error.message}</p>`;
      }
    };
    
    // ÂÖ≥Èó≠Áî®Êà∑Êï∞ÊçÆÊ®°ÊÄÅÊ°Ü
    window.closeUserDataModal = function() {
      const modal = document.getElementById('userDataModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };

    // ‰øùÂ≠òÁî®Êà∑ÂÖ±‰∫´ËÆæÁΩÆÔºà‰ªÖÁÆ°ÁêÜÂëòÔºâ
    window.saveUserSharing = async function(userId) {
      const visibilitySelect = document.getElementById('userSharingVisibility');
      const allowedIdsInput = document.getElementById('userSharingAllowedIds');
      const token = localStorage.getItem('adminToken');
      
      if (!token) {
        alert('ËØ∑ÂÖàÁôªÂΩï');
        return;
      }
      
      const visibility = visibilitySelect ? visibilitySelect.value : 'private';
      const allowedIdsRaw = allowedIdsInput ? allowedIdsInput.value.trim() : '';
      const allowedUserIds = allowedIdsRaw
        ? allowedIdsRaw.split(',').map(id => id.trim()).filter(Boolean)
        : [];
      
      try {
        const apiUrl = getApiUrl();
        const resp = await fetch(`${apiUrl}/admin/users/${userId}/sharing`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ visibility, allowedUserIds })
        });
        
        const result = await resp.json();
        if (!resp.ok || !result.success) {
          throw new Error(result.error || '‰øùÂ≠òÂÖ±‰∫´ËÆæÁΩÆÂ§±Ë¥•');
        }
        
        alert('ÂÖ±‰∫´ËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
      } catch (error) {
        console.error('‰øùÂ≠òÂÖ±‰∫´ËÆæÁΩÆÂ§±Ë¥•:', error);
        alert('‰øùÂ≠òÂ§±Ë¥•Ôºö' + error.message);
      }
    };
    
    // Êõ¥Êñ∞Áî®Êà∑Áä∂ÊÄÅ
    window.updateUserStatus = async function(userId, status) {
      if (!confirm(`Á°ÆÂÆöË¶Å${status === 'active' ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}ËØ•Áî®Êà∑ÂêóÔºü`)) {
        return;
      }
      
      const token = localStorage.getItem('adminToken');
      try {
        const apiUrl = getApiUrl();
        const response = await fetch(`${apiUrl}/admin/users/${userId}/status`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status })
        });
        
        if (!response.ok) {
          throw new Error('Êõ¥Êñ∞Áî®Êà∑Áä∂ÊÄÅÂ§±Ë¥•');
        }
        
        alert('Áî®Êà∑Áä∂ÊÄÅÊõ¥Êñ∞ÊàêÂäü');
        loadUsers();
      } catch (error) {
        console.error('Êõ¥Êñ∞Áî®Êà∑Áä∂ÊÄÅÂ§±Ë¥•:', error);
        alert('Êõ¥Êñ∞Â§±Ë¥•Ôºö' + error.message);
      }
    };
    
    // ÁªëÂÆöÊêúÁ¥¢ËæìÂÖ•Ê°Ü
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('userSearchInput');
      if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            loadUsers();
          }, 500);
        });
      }
      
      // Áî®Êà∑ÁÆ°ÁêÜÊ†áÁ≠æÈ°µÊòæÁ§∫Êó∂Ëá™Âä®Âä†ËΩΩ
      const usersTab = document.getElementById('usersTab');
      if (usersTab) {
        const observer = new MutationObserver(function(mutations) {
          if (usersTab.style.display !== 'none') {
            loadUsers();
          }
        });
        observer.observe(usersTab, { attributes: true, attributeFilter: ['style'] });
      }
    });
    
    // ÁºñËæëÂÖ¨Âëä
    window.editAnnouncement = async function(id) {
      const token = localStorage.getItem('adminToken');
      
      try {
        const response = await fetch(`${getApiUrl()}/admin/announcements`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) throw new Error('Ëé∑ÂèñÂÖ¨ÂëäÂ§±Ë¥•');
        
        const result = await response.json();
        const announcement = result.data.find(a => a.id === id);
        
        if (!announcement) {
          alert('ÂÖ¨Âëä‰∏çÂ≠òÂú®');
          return;
        }
        
        document.getElementById('announcementId').value = announcement.id;
        document.getElementById('announcementContent').value = announcement.content;
        document.getElementById('announcementActive').checked = announcement.active;
        document.getElementById('modalTitle').textContent = 'ÁºñËæëÂÖ¨Âëä';
        document.getElementById('announcementModal').classList.add('active');
      } catch (error) {
        alert('Âä†ËΩΩÂÖ¨ÂëäÂ§±Ë¥•Ôºö' + error.message);
      }
    };
    
    // ÂàáÊç¢ÂÖ¨ÂëäÂÜÖÂÆπÂ±ïÂºÄ/Êî∂Ëµ∑
    window.toggleAnnouncementContent = function(id) {
      const contentEl = document.getElementById(`announcement-content-${id}`);
      if (contentEl) {
        const isExpanded = contentEl.classList.contains('expanded');
        if (!isExpanded) {
          // Â±ïÂºÄÊó∂ÊòæÁ§∫ÂÆåÊï¥ÂÜÖÂÆπ
          const fullContent = contentEl.getAttribute('data-full-content') || contentEl.textContent;
          contentEl.innerHTML = fullContent;
          contentEl.classList.add('expanded');
        } else {
          // Êî∂Ëµ∑Êó∂ÊÅ¢Â§çÊà™Êñ≠ÊòæÁ§∫
          const fullContent = contentEl.getAttribute('data-full-content') || contentEl.textContent;
          const displayContent = fullContent.length > 150 ? fullContent.substring(0, 150) + '...' : fullContent;
          contentEl.innerHTML = displayContent;
          contentEl.classList.remove('expanded');
        }
      }
    };
    
    // Êü•ÁúãÂÆåÊï¥ÂÖ¨Âëä
    window.viewFullAnnouncement = function(id) {
      if (!window.announcementsData) {
        alert('ÂÖ¨ÂëäÊï∞ÊçÆÊú™Âä†ËΩΩ');
        return;
      }
      
      const announcement = window.announcementsData.find(a => a.id === id);
      if (!announcement) {
        alert('ÂÖ¨Âëä‰∏çÂ≠òÂú®');
        return;
      }
      
      // ÂàõÂª∫ÊàñËé∑ÂèñÊü•ÁúãÂÖ¨ÂëäÁöÑÊ®°ÊÄÅÊ°Ü
      let viewModal = document.getElementById('viewAnnouncementModal');
      if (!viewModal) {
        viewModal = document.createElement('div');
        viewModal.id = 'viewAnnouncementModal';
        viewModal.className = 'modal';
        viewModal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h3>üì¢ ÂÖ¨ÂëäËØ¶ÊÉÖ</h3>
              <button class="btn btn-ghost btn-sm" onclick="closeViewAnnouncementModal()" style="padding: 4px 12px;">‚úï</button>
            </div>
            <div class="modal-body">
              <div style="padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); margin-bottom: 16px; white-space: pre-wrap; word-break: break-word; line-height: 1.8; color: var(--text-primary);" id="viewAnnouncementContent"></div>
              <div style="font-size: 12px; color: var(--text-secondary);">
                <div>üìÖ ÂàõÂª∫Êó∂Èó¥Ôºö<span id="viewAnnouncementCreatedAt"></span></div>
                <div id="viewAnnouncementUpdatedAt" style="margin-top: 8px;"></div>
                <div style="margin-top: 8px;">Áä∂ÊÄÅÔºö<span id="viewAnnouncementStatus"></span></div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" onclick="closeViewAnnouncementModal()">ÂÖ≥Èó≠</button>
            </div>
          </div>
        `;
        document.body.appendChild(viewModal);
      }
      
      // Â°´ÂÖÖÂÜÖÂÆπ
      document.getElementById('viewAnnouncementContent').textContent = announcement.content || 'ÊöÇÊó†ÂÜÖÂÆπ';
      
      // ÂÆâÂÖ®Âú∞Ê†ºÂºèÂåñÊó•Êúü
      function formatDate(dateString) {
        try {
          if (!dateString) return '-';
          const date = new Date(dateString);
          if (isNaN(date.getTime())) return '-';
          return date.toLocaleString('zh-CN');
        } catch (e) {
          return '-';
        }
      }
      
      document.getElementById('viewAnnouncementCreatedAt').textContent = formatDate(announcement.createdAt);
      
      const updatedAtEl = document.getElementById('viewAnnouncementUpdatedAt');
      if (announcement.updatedAt && announcement.updatedAt !== announcement.createdAt) {
        const formattedUpdatedAt = formatDate(announcement.updatedAt);
        updatedAtEl.innerHTML = `üîÑ Êõ¥Êñ∞Êó∂Èó¥Ôºö<span>${formattedUpdatedAt}</span>`;
        updatedAtEl.style.display = 'block';
      } else {
        updatedAtEl.style.display = 'none';
      }
      
      const statusEl = document.getElementById('viewAnnouncementStatus');
      statusEl.innerHTML = announcement.active 
        ? '<span class="status-badge status-active">‚úì Â∑≤ÂèëÂ∏É</span>' 
        : '<span class="status-badge status-draft">‚úó ËçâÁ®ø</span>';
      
      // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
      viewModal.classList.add('active');
      
      // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
      viewModal.addEventListener('click', function(e) {
        if (e.target === viewModal) {
          closeViewAnnouncementModal();
        }
      });
    };
    
    // Êü•ÁúãÂÖ¨ÂëäÂéÜÂè≤
    window.viewAnnouncementHistory = async function(id) {
      const token = localStorage.getItem('adminToken');
      if (!token) {
        alert('ËØ∑ÂÖàÁôªÂΩï');
        return;
      }
      let historyModal = document.getElementById('announcementHistoryModal');
      if (!historyModal) {
        historyModal = document.createElement('div');
        historyModal.id = 'announcementHistoryModal';
        historyModal.className = 'modal';
        historyModal.innerHTML = `
          <div class="modal-content" style="max-width: 640px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
              <h3>üìú ÂéÜÂè≤ÂÖ¨ÂëäËÆ∞ÂΩï</h3>
              <button class="btn btn-ghost btn-sm" onclick="closeAnnouncementHistory()" style="padding: 4px 12px;">‚úï</button>
            </div>
            <div class="modal-body" id="announcementHistoryBody" style="padding: 12px 0;">
              <p class="muted" style="text-align:center;">Âä†ËΩΩ‰∏≠...</p>
            </div>
          </div>
        `;
        document.body.appendChild(historyModal);
      }
      const bodyEl = document.getElementById('announcementHistoryBody');
      historyModal.classList.add('active');
      try {
        const resp = await fetch(`${getApiUrl()}/admin/announcements/${id}/history`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!resp.ok) throw new Error('Âä†ËΩΩÂ§±Ë¥•');
        const result = await resp.json();
        const history = result.data || [];
        if (history.length === 0) {
          bodyEl.innerHTML = '<p class="muted" style="text-align:center;">ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</p>';
          return;
        }
        const listHtml = history.map((item, idx) => `
          <div style="padding:12px 16px; border-bottom:1px solid var(--border-light);">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
              <div style="font-weight:600;">ÁâàÊú¨ ${history.length - idx}</div>
              <div style="color:var(--text-secondary); font-size:12px;">${new Date(item.timestamp || item.updatedAt || Date.now()).toLocaleString('zh-CN')}</div>
            </div>
            <div style="margin-top:8px; color:var(--text-secondary);">Áä∂ÊÄÅÔºö${item.active ? '‚úì Â∑≤ÂèëÂ∏É' : '‚úó ËçâÁ®ø'}</div>
            <div style="margin-top:8px; white-space: pre-wrap; word-break: break-word;">${item.content || ''}</div>
          </div>
        `).join('');
        bodyEl.innerHTML = listHtml;
      } catch (e) {
        bodyEl.innerHTML = `<p style="color:var(--danger);text-align:center;">Âä†ËΩΩÂ§±Ë¥•Ôºö${e.message}</p>`;
      }
      historyModal.addEventListener('click', function(e) {
        if (e.target === historyModal) {
          closeAnnouncementHistory();
        }
      });
    };
    
    window.closeAnnouncementHistory = function() {
      const modal = document.getElementById('announcementHistoryModal');
      if (modal) modal.classList.remove('active');
    };
    
    // ÂÖ≥Èó≠Êü•ÁúãÂÖ¨ÂëäÊ®°ÊÄÅÊ°Ü
    window.closeViewAnnouncementModal = function() {
      const viewModal = document.getElementById('viewAnnouncementModal');
      if (viewModal) {
        viewModal.classList.remove('active');
      }
    };
    
    // Âà†Èô§ÂÖ¨Âëä
    window.deleteAnnouncement = async function(id) {
      if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂÖ¨ÂëäÂêóÔºü')) {
        return;
      }
      
      const token = localStorage.getItem('adminToken');
      
      try {
        const response = await fetch(`${getApiUrl()}/admin/announcements/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) throw new Error('Âà†Èô§Â§±Ë¥•');
        
        const result = await response.json();
        if (result.success) {
          loadAnnouncements();
          // Â¶ÇÊûúÂΩìÂâçÂú®È¶ñÈ°µÔºåÂà∑Êñ∞‰∏ªÈ°µÂÖ¨ÂëäÊ†è
          const homeView = document.getElementById('homeView');
          if (homeView && homeView.style.display !== 'none') {
            loadHomeAnnouncementBubble();
          }
        }
      } catch (error) {
        alert('Âà†Èô§Â§±Ë¥•Ôºö' + error.message);
      }
    };
    
    // ÂàõÂª∫Êñ∞ÂÖ¨Âëä
    document.getElementById('createAnnouncementBtn').addEventListener('click', () => {
      document.getElementById('announcementId').value = '';
      document.getElementById('announcementContent').value = '';
      document.getElementById('announcementActive').checked = true;
      document.getElementById('modalTitle').textContent = 'ÂèëÂ∏ÉÊñ∞ÂÖ¨Âëä';
      document.getElementById('announcementModal').classList.add('active');
    });
    
    // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
    document.getElementById('closeModalBtn').addEventListener('click', () => {
      document.getElementById('announcementModal').classList.remove('active');
    });
    
    document.getElementById('cancelBtn').addEventListener('click', () => {
      document.getElementById('announcementModal').classList.remove('active');
    });
    
    // ‰øùÂ≠òÂÖ¨Âëä
    document.getElementById('announcementForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = document.getElementById('announcementId').value;
      const content = document.getElementById('announcementContent').value.trim();
      const active = document.getElementById('announcementActive').checked;
      const token = localStorage.getItem('adminToken');
      
      if (!content) {
        alert('ËØ∑ËæìÂÖ•ÂÖ¨ÂëäÂÜÖÂÆπ');
        return;
      }
      
      try {
        const url = id 
          ? `${getApiUrl()}/admin/announcements/${id}`
          : `${getApiUrl()}/admin/announcements`;
        
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ content, active })
        });
        
        if (!response.ok) throw new Error(id ? 'Êõ¥Êñ∞Â§±Ë¥•' : 'ÂàõÂª∫Â§±Ë¥•');
        
        const result = await response.json();
        if (result.success) {
          document.getElementById('announcementModal').classList.remove('active');
          loadAnnouncements();
          // Â¶ÇÊûúÂΩìÂâçÂú®È¶ñÈ°µÔºåÂà∑Êñ∞‰∏ªÈ°µÂÖ¨ÂëäÊ†è
          const homeView = document.getElementById('homeView');
          if (homeView && homeView.style.display !== 'none') {
            loadHomeAnnouncementBubble();
          }
        }
      } catch (error) {
        alert((id ? 'Êõ¥Êñ∞' : 'ÂàõÂª∫') + 'Â§±Ë¥•Ôºö' + error.message);
      }
    });
    
    // ‰øÆÊîπÂØÜÁ†ÅÂäüËÉΩ
    document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const errorDiv = document.getElementById('passwordChangeError');
      const successDiv = document.getElementById('passwordChangeSuccess');
      const token = localStorage.getItem('adminToken');
      
      // ÈöêËóè‰πãÂâçÁöÑÊ∂àÊÅØ
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';
      
      // È™åËØÅÊñ∞ÂØÜÁ†Å
      if (newPassword.length < 6) {
        errorDiv.textContent = 'Êñ∞ÂØÜÁ†ÅÈïøÂ∫¶Ëá≥Â∞ë‰∏∫6‰Ωç';
        errorDiv.style.display = 'block';
        return;
      }
      
      if (newPassword !== confirmPassword) {
        errorDiv.textContent = '‰∏§Ê¨°ËæìÂÖ•ÁöÑÊñ∞ÂØÜÁ†Å‰∏ç‰∏ÄËá¥';
        errorDiv.style.display = 'block';
        return;
      }
      
      if (oldPassword === newPassword) {
        errorDiv.textContent = 'Êñ∞ÂØÜÁ†Å‰∏çËÉΩ‰∏éÂéüÂØÜÁ†ÅÁõ∏Âêå';
        errorDiv.style.display = 'block';
        return;
      }
      
      try {
        const response = await fetch(`${getApiUrl()}/auth/change-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ oldPassword, newPassword })
        });
        
        const result = await response.json();
        
        if (result.success) {
          successDiv.style.display = 'block';
          document.getElementById('changePasswordForm').reset();
          
          // 3ÁßíÂêéÈöêËóèÊàêÂäüÊ∂àÊÅØ
          setTimeout(() => {
            successDiv.style.display = 'none';
          }, 3000);
        } else {
          errorDiv.textContent = result.error || 'ÂØÜÁ†Å‰øÆÊîπÂ§±Ë¥•';
          errorDiv.style.display = 'block';
        }
      } catch (error) {
        errorDiv.textContent = 'ÂØÜÁ†Å‰øÆÊîπÂ§±Ë¥•Ôºö' + (error.message || 'ÁΩëÁªúÈîôËØØ');
        errorDiv.style.display = 'block';
      }
    });
    
    // ==========================================
    // üì∞ ËµÑËÆØÊõ¥Êñ∞ÂäüËÉΩÔºà‰ªé‰∏ªÁ´ôÁßªÊ§çÔºâ
    // ==========================================
    
    // ËµÑËÆØÊï∞ÊçÆÂ≠òÂÇ®
    let NEWS_DATA = [];
    let currentNewsFilter = 'all';
    let currentNewsRegion = 'local'; // 'local' Êàñ 'national'
    
    // Ëé∑ÂèñAPIÈÖçÁΩÆÔºà‰∏é‰∏ªÁ´ô‰∏ÄËá¥Ôºâ
    function getApiConfig() {
      const config = localStorage.getItem('pigeon_api_config');
      if (config) {
        const parsed = JSON.parse(config);
        // Á°Æ‰øùÊúâapiUrlÂ≠óÊÆµ
        if (!parsed.apiUrl) {
          parsed.apiUrl = 'http://localhost:3000/api';
        }
        return parsed;
      }
      
      // ÈªòËÆ§ÈÖçÁΩÆÔºàÂêéÁ´ØÊúçÂä°Âú∞ÂùÄÔºâ
      const defaultBaseUrl = 'http://localhost:3000/api';
      return {
        apiUrl: defaultBaseUrl, // APIÂü∫Á°ÄÂú∞ÂùÄ
        newsApiUrl: defaultBaseUrl + '/news', // ËµÑËÆØAPIÂú∞ÂùÄ
        eventsApiUrl: defaultBaseUrl + '/events', // Ëµõ‰∫ãAPIÂú∞ÂùÄ
        apiKey: '' // APIÂØÜÈí•ÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
      };
    }
    
    // ‰øùÂ≠òAPIÈÖçÁΩÆ
    function saveApiConfig(config) {
      localStorage.setItem('pigeon_api_config', JSON.stringify(config));
    }
    
    // ‰ªélocalStorageÂä†ËΩΩËµÑËÆØÊï∞ÊçÆ
    function loadNewsFromStorage() {
      const stored = localStorage.getItem('pigeon_news_data');
      const lastUpdate = localStorage.getItem('pigeon_news_last_update');
      
      if (stored && lastUpdate) {
        const lastUpdateDate = new Date(lastUpdate);
        const now = new Date();
        const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
        
        // Â¶ÇÊûúÊï∞ÊçÆÊòØ‰ªäÂ§©ÁöÑÔºåÁõ¥Êé•‰ΩøÁî®
        if (daysDiff === 0) {
          NEWS_DATA = JSON.parse(stored);
          return true;
        }
      }
      
      return false;
    }
    
    // ‰øùÂ≠òËµÑËÆØÊï∞ÊçÆÂà∞localStorage
    function saveNewsToStorage() {
      localStorage.setItem('pigeon_news_data', JSON.stringify(NEWS_DATA));
      localStorage.setItem('pigeon_news_last_update', new Date().toISOString());
    }
    
    // ‰ªéÁúüÂÆûAPIËé∑ÂèñËµÑËÆØÊï∞ÊçÆ
    async function fetchNewsFromWeb() {
      // Ëé∑ÂèñAPIÈÖçÁΩÆ
      const apiConfig = getApiConfig();
      
      if (!apiConfig.newsApiUrl) {
        throw new Error('ËµÑËÆØAPIÊú™ÈÖçÁΩÆÔºåËØ∑Âú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPIÂú∞ÂùÄ');
      }
      
      try {
        // ÊûÑÂª∫ËØ∑Ê±ÇÂ§¥
        const headers = {
          'Content-Type': 'application/json'
        };
        if (apiConfig.apiKey) {
          headers['Authorization'] = 'Bearer ' + apiConfig.apiKey;
        }
        
        // Â∞ùËØï‰ªéAPIËé∑ÂèñÊï∞ÊçÆ
        const response = await fetch(apiConfig.newsApiUrl, {
          method: 'GET',
          headers: headers
        });
        
        if (!response.ok) {
          throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} ${response.statusText}`);
        }
        
        const result = await response.json();
        
        // ÂêéÁ´ØAPIËøîÂõûÊ†ºÂºè: {success: true, data: [...], count: X, timestamp: "..."}
        if (!result.success) {
          throw new Error(result.error || 'APIËøîÂõûÈîôËØØ');
        }
        
        const data = result.data || result;
        
        // È™åËØÅÊï∞ÊçÆÊ†ºÂºè
        if (!Array.isArray(data)) {
          throw new Error('APIËøîÂõûÁöÑÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∫î‰∏∫Êï∞ÁªÑ');
        }
        
        // ËΩ¨Êç¢Êï∞ÊçÆÊ†ºÂºè
        return data.map(item => ({
          id: item.id || Date.now() + Math.random(),
          title: item.title || 'Êó†Ê†áÈ¢ò',
          source: item.source || 'Êú™Áü•Êù•Ê∫ê',
          sourceUrl: item.sourceUrl || item.url || '#',
          time: item.time || formatUpdateTime(item.updateTime),
          updateTime: item.updateTime || new Date().toISOString(),
          tags: item.tags || [],
          category: item.category || 'race',
          region: item.region || 'national',
          content: item.content || item.description || '',
          hot: item.hot || false
        }));
        
      } catch (error) {
        console.error('Ëé∑ÂèñËµÑËÆØÂ§±Ë¥•:', error);
        throw error;
      }
    }
    
    // Ê†ºÂºèÂåñÊõ¥Êñ∞Êó∂Èó¥
    function formatUpdateTime(updateTime) {
      if (!updateTime) return 'Êú™Áü•';
      const date = new Date(updateTime);
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 60) {
        return `${minutes}ÂàÜÈíüÂâç`;
      } else if (hours < 24) {
        return `${hours}Â∞èÊó∂Ââç`;
      } else if (days < 7) {
        return `${days}Â§©Ââç`;
      } else {
        return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
      }
    }
    
    // Ê∏≤ÊüìËµÑËÆØÂàóË°®
    function renderNewsList(filter = 'all', region = 'local') {
      const container = document.getElementById('homeNewsList');
      if (!container) return;
      
      // ÂÖàÊåâÂú∞Âå∫Á≠õÈÄâ
      let filteredNews = NEWS_DATA.filter(n => n.region === region);
      
      // ÂÜçÊåâÂàÜÁ±ªÁ≠õÈÄâ
      if (filter !== 'all') {
        filteredNews = filteredNews.filter(n => n.category === filter);
      }
      
      // ÊåâÊõ¥Êñ∞Êó∂Èó¥ÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
      filteredNews.sort((a, b) => {
        const timeA = new Date(a.updateTime || 0);
        const timeB = new Date(b.updateTime || 0);
        return timeB - timeA;
      });
      
      if (filteredNews.length === 0) {
        const apiConfig = getApiConfig();
        if (!apiConfig.newsApiUrl) {
          // APIÊú™ÈÖçÁΩÆÔºåÊòæÁ§∫ÈÖçÁΩÆÊèêÁ§∫
          showApiConfigPrompt('ËµÑËÆØ');
          return;
        }
        
        container.innerHTML = `
          <div style="padding:40px;text-align:center;color:#9ca3af;">
            <div style="font-size:48px;margin-bottom:16px;">üì∞</div>
            <div>ÊöÇÊó†${region === 'local' ? 'Êú¨Âú∞' : 'ÂÖ®ÂõΩ'}ËµÑËÆØ</div>
            <div style="font-size:12px;margin-top:8px;">ÁÇπÂáª"Âà∑Êñ∞ËµÑËÆØ"ÊåâÈíÆËé∑ÂèñÊúÄÊñ∞ËµÑËÆØ</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredNews.map(news => {
        const updateTimeStr = formatUpdateTime(news.updateTime);
        return `
          <div class="news-card" data-news-id="${news.id}">
            <div class="news-card-header">
              <div class="news-card-title">${news.title}</div>
              <div class="news-card-time">${news.time}</div>
            </div>
            <div class="news-card-source">Êù•Ê∫êÔºö${news.source}</div>
            <div class="news-card-update-time">Êõ¥Êñ∞Êó∂Èó¥Ôºö${updateTimeStr}</div>
            <div class="news-card-tags">
              ${news.hot ? '<span class="news-tag hot">üî• ÁÉ≠Èó®</span>' : ''}
              ${news.tags.map(tag => `<span class="news-tag ${news.category}">#${tag}</span>`).join('')}
            </div>
            <div class="news-card-actions">
              <button class="news-card-action-btn" onclick="viewNewsDetail(${news.id})">üìñ Êü•ÁúãËØ¶ÊÉÖ</button>
              <button class="news-card-action-btn primary" onclick="openNewsOriginal(${news.id})">üîó Êü•ÁúãÂéüÊñá</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Êü•ÁúãËµÑËÆØËØ¶ÊÉÖÔºàÊö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºâ
    window.viewNewsDetail = function(newsId) {
      const news = NEWS_DATA.find(n => n.id === newsId);
      if (!news) {
        alert('ËµÑËÆØ‰∏çÂ≠òÂú®');
        return;
      }
      
      const modal = document.getElementById('newsModal');
      if (!modal) return;
      
      const titleEl = document.getElementById('newsModalTitle');
      const sourceEl = document.getElementById('newsModalSource');
      const regionEl = document.getElementById('newsModalRegion');
      const updateTimeEl = document.getElementById('newsModalUpdateTime');
      const contentEl = document.getElementById('newsModalContent');
      
      if (titleEl) titleEl.textContent = news.title;
      if (sourceEl) sourceEl.textContent = `Êù•Ê∫êÔºö${news.source}`;
      if (regionEl) regionEl.textContent = news.region === 'local' ? 'üìç Êú¨Âú∞ËµÑËÆØ' : 'üåê ÂÖ®ÂõΩËµÑËÆØ';
      if (updateTimeEl) updateTimeEl.textContent = `Êõ¥Êñ∞Êó∂Èó¥Ôºö${formatUpdateTime(news.updateTime)}`;
      if (contentEl) contentEl.textContent = news.content || 'ÊöÇÊó†ËØ¶ÁªÜÂÜÖÂÆπ';
      
      // ËÆæÁΩÆÊü•ÁúãÂéüÊñáÊåâÈíÆÁöÑÈìæÊé•
      const viewOriginalBtn = document.getElementById('newsModalViewOriginal');
      if (viewOriginalBtn) {
        viewOriginalBtn.onclick = () => window.openNewsOriginal(newsId);
      }
      
      modal.classList.add('active');
    };
    
    // ÊâìÂºÄÂéüËµÑËÆØÈìæÊé•ÔºàÊö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºâ
    window.openNewsOriginal = function(newsId) {
      const news = NEWS_DATA.find(n => n.id === newsId);
      if (!news || !news.sourceUrl) {
        alert('ÂéüËµÑËÆØÈìæÊé•‰∏çÂ≠òÂú®');
        return;
      }
      
      window.open(news.sourceUrl, '_blank');
    };
    
    // ÂÖ≥Èó≠ËµÑËÆØËØ¶ÊÉÖÂºπÁ™ó
    function closeNewsModal() {
      const modal = document.getElementById('newsModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }
    
    // Ëá™Âä®Êõ¥Êñ∞ËµÑËÆØ
    async function updateNews() {
      try {
        const news = await fetchNewsFromWeb();
        NEWS_DATA = news;
        saveNewsToStorage();
        renderNewsList(currentNewsFilter, currentNewsRegion);
        updateHomeStats();
        console.log('ËµÑËÆØÊõ¥Êñ∞ÊàêÂäüÔºåÂÖ±Ëé∑Âèñ', news.length, 'Êù°ËµÑËÆØ');
      } catch (error) {
        console.error('Êõ¥Êñ∞ËµÑËÆØÂ§±Ë¥•:', error);
        
        // Â¶ÇÊûúAPIÊú™ÈÖçÁΩÆÔºåÊòæÁ§∫ÈÖçÁΩÆÊèêÁ§∫
        if (error.message && error.message.includes('Êú™ÈÖçÁΩÆ')) {
          NEWS_DATA = [];
          renderNewsList(currentNewsFilter, currentNewsRegion);
          showApiConfigPrompt('ËµÑËÆØ');
          return;
        }
        
        // Â¶ÇÊûúÊõ¥Êñ∞Â§±Ë¥•ÔºåÂ∞ùËØïÂä†ËΩΩÁºìÂ≠òÊï∞ÊçÆ
        if (loadNewsFromStorage()) {
          renderNewsList(currentNewsFilter, currentNewsRegion);
        } else {
          // Ê≤°ÊúâÁºìÂ≠òÊï∞ÊçÆÔºåÊòæÁ§∫ÈîôËØØÊèêÁ§∫
          NEWS_DATA = [];
          renderNewsList(currentNewsFilter, currentNewsRegion);
        }
      }
    }
    
    // ÊòæÁ§∫APIÈÖçÁΩÆÊèêÁ§∫
    function showApiConfigPrompt(type) {
      const container = type === 'ËµÑËÆØ' ? document.getElementById('homeNewsList') : document.getElementById('homeEventsList');
      if (!container) return;
      
      const apiConfig = getApiConfig();
      const apiUrl = type === 'ËµÑËÆØ' ? apiConfig.newsApiUrl : apiConfig.eventsApiUrl;
      
      if (!apiUrl) {
        container.innerHTML = `
          <div style="padding:40px;text-align:center;color:#9ca3af;">
            <div style="font-size:48px;margin-bottom:16px;">${type === 'ËµÑËÆØ' ? 'üì∞' : 'üèÅ'}</div>
            <div style="font-size:16px;font-weight:600;color:#374151;margin-bottom:8px;">${type}APIÊú™ÈÖçÁΩÆ</div>
            <div style="font-size:13px;color:#6b7280;margin-bottom:16px;">ËØ∑ÈÖçÁΩÆ${type}APIÂú∞ÂùÄ‰ª•Ëé∑ÂèñÁúüÂÆûÊï∞ÊçÆ</div>
            <button class="btn btn-primary btn-sm" onclick="showApiConfigModal('${type}')" style="margin-top:12px;">
              ‚öôÔ∏è ÈÖçÁΩÆAPI
            </button>
          </div>
        `;
      }
    }
    
    // ÊòæÁ§∫APIÈÖçÁΩÆÂºπÁ™ó
    window.showApiConfigModal = function(type) {
      const apiConfig = getApiConfig();
      const apiUrl = type === 'ËµÑËÆØ' ? apiConfig.newsApiUrl : apiConfig.eventsApiUrl;
      const apiKey = apiConfig.apiKey || '';
      
      const newsApiUrl = prompt(`ËØ∑ËæìÂÖ•${type === 'ËµÑËÆØ' ? 'ËµÑËÆØ' : 'Ëµõ‰∫ã'}APIÂú∞ÂùÄ:`, apiUrl || '');
      if (newsApiUrl === null) return; // Áî®Êà∑ÂèñÊ∂à
      
      const newApiKey = prompt('ËØ∑ËæìÂÖ•APIÂØÜÈí•ÔºàÂèØÈÄâÔºåÁõ¥Êé•ÂõûËΩ¶Ë∑≥ËøáÔºâ:', apiKey);
      
      const newConfig = {
        ...apiConfig,
        [type === 'ËµÑËÆØ' ? 'newsApiUrl' : 'eventsApiUrl']: newsApiUrl,
        apiKey: newApiKey || apiKey
      };
      
      saveApiConfig(newConfig);
      
      // ÈáçÊñ∞Â∞ùËØïËé∑ÂèñÊï∞ÊçÆ
      if (type === 'ËµÑËÆØ') {
        updateNews();
      }
      
      alert('APIÈÖçÁΩÆÂ∑≤‰øùÂ≠òÔºåÊ≠£Âú®Ëé∑ÂèñÊï∞ÊçÆ...');
    };
    
    // Êõ¥Êñ∞È¶ñÈ°µÁªüËÆ°
    function updateHomeStats() {
      const pigeonCountEl = document.getElementById('homePigeonCount');
      if (pigeonCountEl) {
        // ËøôÈáåÂèØ‰ª•‰ªélocalStorageËé∑ÂèñÈ∏ΩÂ≠êÊï∞ÊçÆ
        try {
          const pigeonsData = localStorage.getItem('pigeons');
          if (pigeonsData) {
            const pigeons = JSON.parse(pigeonsData);
            pigeonCountEl.textContent = pigeons.filter(p => p && p.alive).length || 0;
          } else {
            pigeonCountEl.textContent = '0';
          }
        } catch (e) {
          pigeonCountEl.textContent = '0';
        }
      }
      
      // Êõ¥Êñ∞ÂÖ∂‰ªñÁªüËÆ°
      const newsCountEl = document.getElementById('homeNewsCount');
      if (newsCountEl) {
        newsCountEl.textContent = NEWS_DATA.length || 0;
      }
      
      // Êõ¥Êñ∞Ëµõ‰∫ãÁªüËÆ°
      const activeRacesEl = document.getElementById('homeActiveRaces');
      if (activeRacesEl) {
        activeRacesEl.textContent = (EVENTS_DATA.ongoing || []).length;
      }
      
      const completedRacesEl = document.getElementById('homeCompletedRaces');
      if (completedRacesEl) {
        completedRacesEl.textContent = (EVENTS_DATA.results || []).length;
      }
      
      // Êõ¥Êñ∞Êó•ÊúüÊòæÁ§∫
      const now = new Date();
      const dayEl = document.getElementById('homeDay');
      const weekdayEl = document.getElementById('homeWeekday');
      const dateFullEl = document.getElementById('homeDateFull');
      
      if (dayEl) dayEl.textContent = now.getDate();
      if (weekdayEl) {
        const weekdays = ['Âë®Êó•', 'Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠'];
        weekdayEl.textContent = weekdays[now.getDay()];
      }
      if (dateFullEl) {
        dateFullEl.textContent = `${now.getFullYear()}Âπ¥${now.getMonth() + 1}Êúà`;
      }
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞ËµÑËÆØÔºàÊØèÂ§©Êõ¥Êñ∞‰∏ÄÊ¨°Ôºâ
    function checkAndUpdateNews() {
      const lastUpdate = localStorage.getItem('pigeon_news_last_update');
      if (!lastUpdate) {
        // È¶ñÊ¨°Âä†ËΩΩÔºåÁõ¥Êé•Êõ¥Êñ∞
        updateNews();
        return;
      }
      
      const lastUpdateDate = new Date(lastUpdate);
      const now = new Date();
      const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
      
      if (daysDiff >= 1) {
        // Ë∂ÖËøá1Â§©ÔºåÈúÄË¶ÅÊõ¥Êñ∞
        updateNews();
      } else {
        // ‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ
        if (loadNewsFromStorage()) {
          renderNewsList(currentNewsFilter, currentNewsRegion);
        } else {
          // Â¶ÇÊûúÊ≤°ÊúâÁºìÂ≠òÔºåÂàôÊõ¥Êñ∞
          updateNews();
        }
      }
    }
    
    // ==========================================
    // üèÅ ÂÆûÊó∂Ëµõ‰∫ãÂäüËÉΩÔºà‰ªé‰∏ªÁ´ôÁßªÊ§çÔºâ
    // ==========================================
    
    // Ëµõ‰∫ãÊï∞ÊçÆÂ≠òÂÇ®
    let EVENTS_DATA = {
      ongoing: [],
      upcoming: [],
      results: []
    };
    
    let currentEventTab = 'ongoing';
    let currentEventRegion = 'local'; // 'local' Êàñ 'national'
    
    // ‰ªélocalStorageÂä†ËΩΩËµõ‰∫ãÊï∞ÊçÆ
    function loadEventsFromStorage() {
      const stored = localStorage.getItem('pigeon_events_data');
      const lastUpdate = localStorage.getItem('pigeon_events_last_update');
      
      if (stored && lastUpdate) {
        const lastUpdateDate = new Date(lastUpdate);
        const now = new Date();
        const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
        
        // Â¶ÇÊûúÊï∞ÊçÆÊòØ‰ªäÂ§©ÁöÑÔºåÁõ¥Êé•‰ΩøÁî®
        if (daysDiff === 0) {
          EVENTS_DATA = JSON.parse(stored);
          return true;
        }
      }
      
      return false;
    }
    
    // ‰øùÂ≠òËµõ‰∫ãÊï∞ÊçÆÂà∞localStorage
    function saveEventsToStorage() {
      localStorage.setItem('pigeon_events_data', JSON.stringify(EVENTS_DATA));
      localStorage.setItem('pigeon_events_last_update', new Date().toISOString());
    }
    
    // ‰ªéÁúüÂÆûAPIËé∑ÂèñËµõ‰∫ãÊï∞ÊçÆ
    async function fetchEventsFromWeb() {
      // Ëé∑ÂèñAPIÈÖçÁΩÆ
      const apiConfig = getApiConfig();
      
      if (!apiConfig.eventsApiUrl) {
        throw new Error('Ëµõ‰∫ãAPIÊú™ÈÖçÁΩÆÔºåËØ∑Âú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPIÂú∞ÂùÄ');
      }
      
      try {
        // ÊûÑÂª∫ËØ∑Ê±ÇÂ§¥
        const headers = {
          'Content-Type': 'application/json'
        };
        if (apiConfig.apiKey) {
          headers['Authorization'] = 'Bearer ' + apiConfig.apiKey;
        }
        
        // Â∞ùËØï‰ªéAPIËé∑ÂèñÊï∞ÊçÆÔºàËé∑ÂèñÊâÄÊúâÁ±ªÂûãÁöÑËµõ‰∫ãÔºâ
        const response = await fetch(apiConfig.eventsApiUrl, {
          method: 'GET',
          headers: headers
        });
        
        if (!response.ok) {
          const errorText = await response.text().catch(() => '');
          throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} ${response.statusText}. ${errorText}`);
        }
        
        const result = await response.json();
        
        // ÂêéÁ´ØAPIËøîÂõûÊ†ºÂºè: {success: true, data: {ongoing: [], upcoming: [], results: []}}
        if (!result.success) {
          throw new Error(result.error || result.message || 'APIËøîÂõûÈîôËØØ');
        }
        
        const data = result.data || result;
        
        // È™åËØÅÊï∞ÊçÆÊ†ºÂºè
        if (!data.ongoing || !data.upcoming || !data.results) {
          throw new Error('APIËøîÂõûÁöÑÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∫îÂåÖÂê´ongoing„ÄÅupcoming„ÄÅresultsÂ≠óÊÆµ');
        }
        
        // ËΩ¨Êç¢Êï∞ÊçÆÊ†ºÂºèÂπ∂È™åËØÅ
        const now = new Date();
        return {
          ongoing: (data.ongoing || []).map(item => {
            const releaseTimeFull = item.releaseTimeFull ? new Date(item.releaseTimeFull) : null;
            const endTimeFull = item.endTimeFull ? new Date(item.endTimeFull) : null;
            
            if (endTimeFull && endTimeFull <= now) {
              return null;
            }
            
            if (releaseTimeFull && releaseTimeFull > now) {
              return null;
            }
            
            return {
              id: item.id || Date.now() + Math.random(),
              name: item.name || 'Êú™Áü•Ëµõ‰∫ã',
              organizer: item.organizer || 'Êú™Áü•ÁªÑÁªá',
              source: item.source || 'Êú™Áü•Êù•Ê∫ê',
              sourceUrl: item.sourceUrl || item.url || '#',
              releaseTime: item.releaseTime || 'Êú™Áü•Êó∂Èó¥',
              releaseTimeFull: item.releaseTimeFull || new Date().toISOString(),
              endTimeFull: item.endTimeFull || null,
              distance: item.distance || 'Êú™Áü•Ë∑ùÁ¶ª',
              status: 'ongoing',
              region: item.region || 'national',
              returned: item.returned || 0,
              total: item.total || 0,
              weather: item.weather || 'Êú™Áü•',
              updateTime: item.updateTime || new Date().toISOString()
            };
          }).filter(item => item !== null),
          upcoming: (data.upcoming || []).map(item => {
            const startTimeFull = item.startTimeFull ? new Date(item.startTimeFull) : null;
            
            if (startTimeFull && startTimeFull <= now) {
              return null;
            }
            
            return {
              id: item.id || Date.now() + Math.random(),
              name: item.name || 'Êú™Áü•Ëµõ‰∫ã',
              organizer: item.organizer || 'Êú™Áü•ÁªÑÁªá',
              source: item.source || 'Êú™Áü•Êù•Ê∫ê',
              sourceUrl: item.sourceUrl || item.url || '#',
              startTime: item.startTime || 'Êú™Áü•Êó∂Èó¥',
              startTimeFull: item.startTimeFull || new Date(now.getTime() + 86400000).toISOString(),
              distance: item.distance || 'Êú™Áü•Ë∑ùÁ¶ª',
              status: 'upcoming',
              region: item.region || 'national',
              participants: item.participants || 0,
              weather: item.weather || 'Êú™Áü•',
              updateTime: item.updateTime || new Date().toISOString()
            };
          }).filter(item => item !== null),
          results: (data.results || []).map(item => {
            const endTimeFull = item.endTimeFull ? new Date(item.endTimeFull) : null;
            
            if (endTimeFull && endTimeFull > now) {
              return null;
            }
            
            return {
              id: item.id || Date.now() + Math.random(),
              name: item.name || 'Êú™Áü•Ëµõ‰∫ã',
              organizer: item.organizer || 'Êú™Áü•ÁªÑÁªá',
              source: item.source || 'Êú™Áü•Êù•Ê∫ê',
              sourceUrl: item.sourceUrl || item.url || '#',
              endTime: item.endTime || 'Êú™Áü•Êó∂Èó¥',
              endTimeFull: item.endTimeFull || new Date(now.getTime() - 86400000).toISOString(),
              distance: item.distance || 'Êú™Áü•Ë∑ùÁ¶ª',
              status: 'completed',
              region: item.region || 'national',
              champion: item.champion || 'Êú™Áü•',
              championRing: item.championRing || 'Êú™Áü•',
              championTime: item.championTime || 'Êú™Áü•',
              updateTime: item.updateTime || new Date().toISOString()
            };
          }).filter(item => item !== null)
        };
        
      } catch (error) {
        console.error('Ëé∑ÂèñËµõ‰∫ãÂ§±Ë¥•:', error);
        throw error;
      }
    }
    
    // È™åËØÅËµõ‰∫ãÊó∂Èó¥ÊòØÂê¶ÊúâÊïà
    function isValidEventTime(event, tab) {
      const now = new Date();
      
      if (tab === 'ongoing') {
        if (!event.releaseTimeFull) return false;
        const releaseTime = new Date(event.releaseTimeFull);
        const hoursSinceRelease = (now - releaseTime) / (1000 * 60 * 60);
        if (hoursSinceRelease > 24) return false;
        if (releaseTime > now) return false;
        return true;
      } else if (tab === 'upcoming') {
        if (!event.startTimeFull) return false;
        const startTime = new Date(event.startTimeFull);
        if (startTime <= now) return false;
        return true;
      } else if (tab === 'results') {
        if (!event.endTimeFull) return false;
        const endTime = new Date(event.endTimeFull);
        if (endTime > now) return false;
        return true;
      }
      
      return true;
    }
    
    // È™åËØÅËµõ‰∫ãÊï∞ÊçÆÊòØÂê¶ËøáÊó∂
    function isEventOutdated(event) {
      if (!event.updateTime) return true;
      
      const updateTime = new Date(event.updateTime);
      const now = new Date();
      const hoursSinceUpdate = (now - updateTime) / (1000 * 60 * 60);
      
      if (event.status === 'ongoing' && hoursSinceUpdate > 2) {
        return true;
      }
      
      if (hoursSinceUpdate > 24) {
        return true;
      }
      
      return false;
    }
    
    // Ê∏≤ÊüìËµõ‰∫ãÂàóË°®
    function renderEventsList(tab = 'ongoing', region = 'local') {
      const container = document.getElementById('homeEventsList');
      if (!container) return;
      
      // ÂÖàÊåâÂú∞Âå∫Á≠õÈÄâ
      let events = (EVENTS_DATA[tab] || []).filter(event => event.region === region);
      
      // ËøáÊª§ÊéâÊó∂Èó¥‰∏çÂêªÂêàÁöÑËµõ‰∫ã
      events = events.filter(event => isValidEventTime(event, tab));
      
      // ËøáÊª§ÊéâËøáÊó∂ÁöÑËµõ‰∫ã
      events = events.filter(event => !isEventOutdated(event));
      
      // ÂØπ‰∫é"ËøõË°å‰∏≠"ÁöÑËµõ‰∫ãÔºåÈ¢ùÂ§ñÈ™åËØÅ
      if (tab === 'ongoing') {
        events = events.filter(event => {
          if (event.endTimeFull) {
            const endTime = new Date(event.endTimeFull);
            if (endTime <= new Date()) {
              return false;
            }
          }
          return true;
        });
      }
      
      // ÊåâÊõ¥Êñ∞Êó∂Èó¥ÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
      events.sort((a, b) => {
        const timeA = new Date(a.updateTime || 0);
        const timeB = new Date(b.updateTime || 0);
        return timeB - timeA;
      });
      
      if (events.length === 0) {
        const apiConfig = getApiConfig();
        if (!apiConfig.eventsApiUrl) {
          showApiConfigPrompt('Ëµõ‰∫ã');
          return;
        }
        
        container.innerHTML = `
          <div style="padding:40px;text-align:center;color:#9ca3af;">
            <div style="font-size:48px;margin-bottom:16px;">üèÅ</div>
            <div>ÊöÇÊó†${region === 'local' ? 'Êú¨Âú∞' : 'ÂÖ®ÂõΩ'}${tab === 'ongoing' ? 'ËøõË°å‰∏≠' : tab === 'upcoming' ? 'Âç≥Â∞ÜÂºÄÂßã' : 'ÊúÄÊñ∞ÊàêÁª©'}Ëµõ‰∫ã</div>
            <div style="font-size:12px;margin-top:8px;">ÁÇπÂáª"Âà∑Êñ∞"ÊåâÈíÆËé∑ÂèñÊúÄÊñ∞Ëµõ‰∫ã</div>
          </div>
        `;
        return;
      }
      
      if (tab === 'ongoing') {
        container.innerHTML = events.map(event => {
          const updateTimeStr = formatUpdateTime(event.updateTime);
          const progressPercent = event.total > 0 ? ((event.returned / event.total) * 100).toFixed(1) : 0;
          return `
            <div class="event-card" style="cursor:pointer;" onclick="openEventUrl('${event.sourceUrl || '#'}')">
              <div class="event-card-status ongoing">
                <span>ËøõË°å‰∏≠</span>
              </div>
              <div class="event-card-title">${event.name}</div>
              <div class="event-card-info">
                <div class="event-card-info-item">
                  <span>üè¢</span>
                  <span>${event.organizer}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üìè</span>
                  <span>${event.distance}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üïê</span>
                  <span>ÊîæÈ£ûÔºö${event.releaseTime}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üå§Ô∏è</span>
                  <span>${event.weather}</span>
                </div>
              </div>
              <div class="event-card-progress">
                <div class="event-progress-bar">
                  <div class="event-progress-fill" style="width:${progressPercent}%;"></div>
                </div>
                <div class="event-progress-text">Â∑≤ÂΩíÂ∑¢ ${event.returned} / ${event.total} Âè™Ôºà${progressPercent}%Ôºâ</div>
              </div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
                <span>üì∞ Êù•Ê∫êÔºö${event.source || 'Êú™Áü•'}</span>
                <span>üïê Êõ¥Êñ∞Ôºö${updateTimeStr}</span>
              </div>
              ${event.sourceUrl && event.sourceUrl !== '#' ? `
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                <button class="btn btn-outline btn-sm" style="width:100%;" onclick="event.stopPropagation();window.open('${event.sourceUrl}', '_blank')">
                  üîó Êü•ÁúãÂéüËµõ‰∫ãÁΩëÈ°µ
                </button>
              </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } else if (tab === 'upcoming') {
        container.innerHTML = events.map(event => {
          const updateTimeStr = formatUpdateTime(event.updateTime);
          return `
            <div class="event-card" style="cursor:pointer;" onclick="openEventUrl('${event.sourceUrl || '#'}')">
              <div class="event-card-status upcoming">Âç≥Â∞ÜÂºÄÂßã</div>
              <div class="event-card-title">${event.name}</div>
              <div class="event-card-info">
                <div class="event-card-info-item">
                  <span>üè¢</span>
                  <span>${event.organizer}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üìè</span>
                  <span>${event.distance}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üïê</span>
                  <span>ÂºÄÂßãÔºö${event.startTime}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üïäÔ∏è</span>
                  <span>ÂèÇËµõÔºö${event.participants}Âè™</span>
                </div>
              </div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
                <span>üì∞ Êù•Ê∫êÔºö${event.source || 'Êú™Áü•'}</span>
                <span>üïê Êõ¥Êñ∞Ôºö${updateTimeStr}</span>
              </div>
              ${event.sourceUrl && event.sourceUrl !== '#' ? `
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                <button class="btn btn-outline btn-sm" style="width:100%;" onclick="event.stopPropagation();window.open('${event.sourceUrl}', '_blank')">
                  üîó Êü•ÁúãÂéüËµõ‰∫ãÁΩëÈ°µ
                </button>
              </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } else if (tab === 'results') {
        container.innerHTML = events.map(event => {
          const updateTimeStr = formatUpdateTime(event.updateTime);
          return `
            <div class="event-card" style="cursor:pointer;" onclick="openEventUrl('${event.sourceUrl || '#'}')">
              <div class="event-card-status completed">Â∑≤ÁªìÊùü</div>
              <div class="event-card-title">${event.name}</div>
              <div class="event-card-info">
                <div class="event-card-info-item">
                  <span>üè¢</span>
                  <span>${event.organizer}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üìè</span>
                  <span>${event.distance}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üïê</span>
                  <span>ÁªìÊùüÔºö${event.endTime}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üèÜ</span>
                  <span>ÂÜ†ÂÜõÔºö${event.champion} (${event.championRing})</span>
                </div>
                ${event.championTime ? `
                <div class="event-card-info-item">
                  <span>‚è±Ô∏è</span>
                  <span>ÊàêÁª©Ôºö${event.championTime}</span>
                </div>
                ` : ''}
              </div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
                <span>üì∞ Êù•Ê∫êÔºö${event.source || 'Êú™Áü•'}</span>
                <span>üïê Êõ¥Êñ∞Ôºö${updateTimeStr}</span>
              </div>
              ${event.sourceUrl && event.sourceUrl !== '#' ? `
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                <button class="btn btn-outline btn-sm" style="width:100%;" onclick="event.stopPropagation();window.open('${event.sourceUrl}', '_blank')">
                  üîó Êü•ÁúãÂéüËµõ‰∫ãÁΩëÈ°µ
                </button>
              </div>
              ` : ''}
            </div>
          `;
        }).join('');
      }
    }
    
    // ÊâìÂºÄËµõ‰∫ãÈìæÊé•ÔºàÊö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºâ
    window.openEventUrl = function(url) {
      if (url && url !== '#') {
        window.open(url, '_blank');
      }
    };
    
    // Ëá™Âä®Êõ¥Êñ∞Ëµõ‰∫ã
    async function updateEvents() {
      try {
        const events = await fetchEventsFromWeb();
        
        // ÂÜçÊ¨°È™åËØÅÂíåËøáÊª§Êï∞ÊçÆ
        const now = new Date();
        
        // ËøáÊª§ËøõË°å‰∏≠ÁöÑËµõ‰∫ã
        events.ongoing = events.ongoing.filter(event => {
          if (!event.releaseTimeFull) return false;
          const releaseTime = new Date(event.releaseTimeFull);
          if (releaseTime > now) return false;
          
          if (event.endTimeFull) {
            const endTime = new Date(event.endTimeFull);
            if (endTime <= now) return false;
          }
          
          if (event.updateTime) {
            const updateTime = new Date(event.updateTime);
            const hoursSinceUpdate = (now - updateTime) / (1000 * 60 * 60);
            if (hoursSinceUpdate > 2) return false;
          }
          
          return true;
        });
        
        // ËøáÊª§Âç≥Â∞ÜÂºÄÂßãÁöÑËµõ‰∫ã
        events.upcoming = events.upcoming.filter(event => {
          if (!event.startTimeFull) return false;
          const startTime = new Date(event.startTimeFull);
          return startTime > now;
        });
        
        // ËøáÊª§Â∑≤ÁªìÊùüÁöÑËµõ‰∫ã
        events.results = events.results.filter(event => {
          if (!event.endTimeFull) return false;
          const endTime = new Date(event.endTimeFull);
          return endTime <= now;
        });
        
        EVENTS_DATA = events;
        saveEventsToStorage();
        renderEventsList(currentEventTab, currentEventRegion);
        updateHomeStats();
        console.log('Ëµõ‰∫ãÊõ¥Êñ∞ÊàêÂäüÔºåÂÖ±Ëé∑Âèñ', 
          events.ongoing.length + events.upcoming.length + events.results.length, 
          'Âú∫ÊúâÊïàËµõ‰∫ã');
      } catch (error) {
        console.error('Êõ¥Êñ∞Ëµõ‰∫ãÂ§±Ë¥•:', error);
        
        // Â¶ÇÊûúAPIÊú™ÈÖçÁΩÆÔºåÊòæÁ§∫ÈÖçÁΩÆÊèêÁ§∫
        if (error.message && error.message.includes('Êú™ÈÖçÁΩÆ')) {
          EVENTS_DATA = { ongoing: [], upcoming: [], results: [] };
          renderEventsList(currentEventTab, currentEventRegion);
          showApiConfigPrompt('Ëµõ‰∫ã');
          return;
        }
        
        // Â¶ÇÊûúÊõ¥Êñ∞Â§±Ë¥•ÔºåÂ∞ùËØïÂä†ËΩΩÁºìÂ≠òÊï∞ÊçÆ
        if (loadEventsFromStorage()) {
          renderEventsList(currentEventTab, currentEventRegion);
        } else {
          // Ê≤°ÊúâÁºìÂ≠òÊï∞ÊçÆÔºåÊòæÁ§∫ÈîôËØØÊèêÁ§∫
          EVENTS_DATA = { ongoing: [], upcoming: [], results: [] };
          renderEventsList(currentEventTab, currentEventRegion);
        }
      }
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞Ëµõ‰∫ã
    function checkAndUpdateEvents() {
      const lastUpdate = localStorage.getItem('pigeon_events_last_update');
      if (!lastUpdate) {
        updateEvents();
        return;
      }
      
      const lastUpdateDate = new Date(lastUpdate);
      const now = new Date();
      const minutesSinceUpdate = (now - lastUpdateDate) / (1000 * 60);
      
      const hasOngoingEvents = (EVENTS_DATA.ongoing || []).length > 0;
      
      if (hasOngoingEvents) {
        if (minutesSinceUpdate >= 5) {
          updateEvents();
        } else {
          if (loadEventsFromStorage()) {
            renderEventsList(currentEventTab, currentEventRegion);
          } else {
            updateEvents();
          }
        }
      } else {
        if (minutesSinceUpdate >= 60) {
          updateEvents();
        } else {
          if (loadEventsFromStorage()) {
            renderEventsList(currentEventTab, currentEventRegion);
          } else {
            updateEvents();
          }
        }
      }
    }
    
    // Âä†ËΩΩ‰∏ªÈ°µÂÖ¨ÂëäÊ†è
    // Â≠òÂÇ®È¶ñÈ°µÂΩìÂâçÂÖ¨ÂëäÊï∞ÊçÆ
    let homeCurrentAnnouncement = null;
    
    async function loadHomeAnnouncementBubble() {
      const bubbleEl = document.getElementById('homeAnnouncementBubbleText');
      const hintEl = document.getElementById('homeAnnouncementHint');
      const bubbleContainer = document.getElementById('homeAnnouncementBubble');
      if (!bubbleEl) return;
      
      const token = localStorage.getItem('adminToken');
      if (!token) {
        bubbleEl.textContent = 'ÊöÇÊó†ÂÖ¨Âëä';
        homeCurrentAnnouncement = null;
        if (hintEl) hintEl.style.display = 'none';
        if (bubbleContainer) bubbleContainer.style.cursor = 'default';
        return;
      }
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`${getApiUrl()}/admin/announcements`, {
          headers: {
            'Authorization': `Bearer ${token}`
          },
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error('Ëé∑ÂèñÂÖ¨ÂëäÂ§±Ë¥•');
        }
        
        const result = await response.json();
        const announcements = result.data || [];
        
        // ‰øùÂ≠òÂÖ¨ÂëäÊï∞ÊçÆ‰æõÊü•Áúã‰ΩøÁî®
        window.announcementsData = announcements;
        
        // Ëé∑ÂèñÊúÄÊñ∞ÁöÑÂ∑≤ÂèëÂ∏ÉÂÖ¨Âëä
        const activeAnnouncements = announcements.filter(ann => ann.active);
        if (activeAnnouncements.length > 0) {
          // ÊåâÊõ¥Êñ∞Êó∂Èó¥ÊéíÂ∫èÔºåËé∑ÂèñÊúÄÊñ∞ÁöÑ
          activeAnnouncements.sort((a, b) => {
            const timeA = new Date(a.updatedAt || a.createdAt);
            const timeB = new Date(b.updatedAt || b.createdAt);
            return timeB - timeA;
          });
          
          const latestAnnouncement = activeAnnouncements[0];
          homeCurrentAnnouncement = latestAnnouncement;
          
          const content = latestAnnouncement.content || 'ÊöÇÊó†ÂÖ¨Âëä';
          
          // Â¶ÇÊûúÂÜÖÂÆπËæÉÈïøÔºåÊòæÁ§∫ÊèêÁ§∫
          if (content.length > 50) {
            if (hintEl) hintEl.style.display = 'inline';
            // ÈôêÂà∂ÊòæÁ§∫ÈïøÂ∫¶
            const maxLength = 80;
            if (content.length > maxLength) {
              bubbleEl.textContent = content.substring(0, maxLength) + '...';
            } else {
              bubbleEl.textContent = content;
            }
          } else {
            bubbleEl.textContent = content;
            if (hintEl) hintEl.style.display = 'none';
          }
          
          // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
          if (bubbleContainer) {
            bubbleContainer.style.cursor = 'pointer';
          }
        } else {
          bubbleEl.textContent = 'ÊöÇÊó†ÂÖ¨Âëä';
          homeCurrentAnnouncement = null;
          if (hintEl) hintEl.style.display = 'none';
          if (bubbleContainer) bubbleContainer.style.cursor = 'default';
        }
      } catch (error) {
        console.error('Âä†ËΩΩÂÖ¨ÂëäÂ§±Ë¥•:', error);
        bubbleEl.textContent = 'ÊöÇÊó†ÂÖ¨Âëä';
        homeCurrentAnnouncement = null;
        if (hintEl) hintEl.style.display = 'none';
      }
    }
    
    // ÊòæÁ§∫È¶ñÈ°µÂÖ¨ÂëäËØ¶ÊÉÖ
    window.showHomeAnnouncementDetail = function() {
      if (!homeCurrentAnnouncement) {
        console.warn('Ê≤°ÊúâÂèØÊòæÁ§∫ÁöÑÂÖ¨Âëä');
        return;
      }
      
      // ‰ΩøÁî®Â∑≤ÊúâÁöÑÊü•ÁúãÂÖ¨ÂëäÊ®°ÊÄÅÊ°ÜÂáΩÊï∞
      if (window.viewFullAnnouncement) {
        viewFullAnnouncement(homeCurrentAnnouncement.id);
      } else {
        // Â¶ÇÊûúviewFullAnnouncement‰∏çÂ≠òÂú®ÔºåÁõ¥Êé•ÊòæÁ§∫
        alert('ÂÖ¨ÂëäËØ¶ÊÉÖÂäüËÉΩÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢');
      }
    };
    
    // ÂàùÂßãÂåñÈ¶ñÈ°µËßÜÂõæ
    function initHomeView() {
      // Êõ¥Êñ∞È¶ñÈ°µÁªüËÆ°
      updateHomeStats();
      
      // Âä†ËΩΩ‰∏ªÈ°µÂÖ¨ÂëäÊ†è
      loadHomeAnnouncementBubble();
      
      // Ê£ÄÊü•Âπ∂Êõ¥Êñ∞ËµÑËÆØ
      checkAndUpdateNews();
      
      // Ê£ÄÊü•Âπ∂Êõ¥Êñ∞Ëµõ‰∫ã
      checkAndUpdateEvents();
      
      // ÁªëÂÆöËµÑËÆØÁ≠õÈÄâÊåâÈíÆ‰∫ã‰ª∂
      document.querySelectorAll('.news-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.news-filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentNewsFilter = btn.dataset.filter;
          renderNewsList(currentNewsFilter, currentNewsRegion);
        });
      });
      
      // Êú¨Âú∞/ÂÖ®ÂõΩËµÑËÆØÊ†áÁ≠æÈ°µÂàáÊç¢
      document.querySelectorAll('.news-region-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.news-region-tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentNewsRegion = btn.dataset.region;
          renderNewsList(currentNewsFilter, currentNewsRegion);
        });
      });
      
      // Âà∑Êñ∞ËµÑËÆØÊåâÈíÆ
      const btnRefreshNews = document.getElementById('btnRefreshNews');
      if (btnRefreshNews) {
        btnRefreshNews.addEventListener('click', () => {
          updateNews();
          alert('Ê≠£Âú®Âà∑Êñ∞ËµÑËÆØÔºåËØ∑Á®çÂÄô...');
        });
      }
      
      // ËµÑËÆØËØ¶ÊÉÖÂºπÁ™óÂÖ≥Èó≠‰∫ã‰ª∂
      const newsModalClose = document.getElementById('newsModalClose');
      const newsModalCloseBtn = document.getElementById('newsModalCloseBtn');
      const newsModal = document.getElementById('newsModal');
      
      if (newsModalClose) {
        newsModalClose.addEventListener('click', closeNewsModal);
      }
      if (newsModalCloseBtn) {
        newsModalCloseBtn.addEventListener('click', closeNewsModal);
      }
      if (newsModal) {
        newsModal.addEventListener('click', (e) => {
          if (e.target.id === 'newsModal') {
            closeNewsModal();
          }
        });
      }
      
      // Ëµõ‰∫ãÂú∞Âå∫Ê†áÁ≠æÈ°µÂàáÊç¢
      document.querySelectorAll('.event-region-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.event-region-tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentEventRegion = btn.dataset.region;
          renderEventsList(currentEventTab, currentEventRegion);
        });
      });
      
      // Ëµõ‰∫ãÊ†áÁ≠æÈ°µÂàáÊç¢
      document.querySelectorAll('.event-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.event-tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentEventTab = btn.dataset.tab;
          renderEventsList(currentEventTab, currentEventRegion);
        });
      });
      
      // Âà∑Êñ∞Ëµõ‰∫ãÊåâÈíÆ
      const btnRefreshEvents = document.getElementById('btnRefreshEvents');
      if (btnRefreshEvents) {
        btnRefreshEvents.addEventListener('click', () => {
          updateEvents();
          alert('Ê≠£Âú®Âà∑Êñ∞Ëµõ‰∫ãÊï∞ÊçÆÔºåËØ∑Á®çÂÄô...');
        });
      }
    }
    
    // ==========================================
    // üïäÔ∏è Evo Êô∫ËÉΩÂä©ÊâãËÆæÁΩÆÂäüËÉΩ
    // ==========================================
    
    const EVO_SETTINGS_KEY = 'evo_settings';
    const EVO_SYNC_KEY = 'evo_settings_sync';
    
    // ÈªòËÆ§ËÆæÁΩÆ
    const defaultEvoSettings = {
      enabled: true,
      position: 'bottom-right',
      displayMode: 'always',
      autoClose: 5,
      iconSize: 70,
      theme: 'purple',
      showWelcome: true,
      saveHistory: true,
      showAnalytics: true,
      showRecommendations: true,
      github: {
        repo: '',
        token: '',
        apiEndpoint: ''
      },
      functionGuides: {
        'È¶ñÈ°µ': {
          description: 'È¶ñÈ°µÊòØÁ≥ªÁªüÁöÑ‰ø°ÊÅØ‰∏≠ÂøÉ',
          features: [
            'üì∞ ËµõÈ∏ΩËµÑËÆØÔºöÊü•ÁúãÊúÄÊñ∞ÁöÑËµõÈ∏ΩÁõ∏ÂÖ≥ËµÑËÆØÔºåÂèØ‰ª•ÊåâÁ±ªÂûãÔºàÂÖ®ÈÉ®/Ëµõ‰∫ã/ËÇ≤Áßç/ÂÅ•Â∫∑ÔºâÂíåÂú∞Âå∫ÔºàÊú¨Âú∞/ÂÖ®ÂõΩÔºâÁ≠õÈÄâ',
            'üèÅ ÂÆûÊó∂Ëµõ‰∫ãÔºöÊü•ÁúãËøõË°å‰∏≠„ÄÅÂç≥Â∞ÜÂºÄÂßãÂíåÊúÄÊñ∞ÊàêÁª©ÁöÑËµõ‰∫ã‰ø°ÊÅØ',
            'üß† Êô∫ËÉΩÊé®ËçêÔºöÁ≥ªÁªüÊ†πÊçÆÊÇ®ÁöÑÊï∞ÊçÆÊèê‰æõ‰∏™ÊÄßÂåñÊé®Ëçê',
            '‚≠ê ÊàëÁöÑÂÖ≥Ê≥®ÔºöÁÆ°ÁêÜÊÇ®ÂÖ≥Ê≥®ÁöÑËµõÂå∫„ÄÅËµõ‰∫ãÁ±ªÂûãÁ≠â',
            'üöÄ Âø´Êç∑ÂÖ•Âè£ÔºöÂø´ÈÄüËÆøÈóÆÂ∏∏Áî®ÂäüËÉΩÔºàÊñ∞Â¢ûÈ∏ΩÂ≠ê„ÄÅÂΩïÂÖ•ÊàêÁª©„ÄÅÈÖçÂØπËØÑ‰º∞„ÄÅÊô∫ËÉΩÂàÜÊûêÔºâ',
            'üîî ‰ªäÊó•ÊèêÈÜíÔºöÊü•Áúã‰ªäÊó•ÁöÑÈáçË¶ÅÊèêÈÜí‰∫ãÈ°π'
          ]
        },
        'Êï∞ÊçÆÊ¶ÇËßà': {
          description: 'Êü•ÁúãÁ≥ªÁªüÁöÑÊï¥‰ΩìÊï∞ÊçÆÁªüËÆ°',
          features: [
            'üìä Ê†∏ÂøÉÊï∞ÊçÆÂç°ÁâáÔºöÊòæÁ§∫ÊÄªÈ∏ΩÂ≠êÊï∞„ÄÅÂú®‰∏ñ„ÄÅÂ∑≤Ê≠ª‰∫°„ÄÅÊúâÊàêÁª©„ÄÅÊ†∏ÂøÉÁßçÈ∏ΩÁ≠âÁªüËÆ°',
            'üìà Âπ¥Â∫¶ÁªüËÆ°ÔºöÊåâÂπ¥‰ªΩÊ±áÊÄªÂá∫ÁîüÊï∞Èáè„ÄÅÊ≠ª‰∫°Êï∞Èáè‰ª•ÂèäÊúâÂèÇËµõËÆ∞ÂΩïÁöÑÈ∏ΩÂ≠êÊï∞Èáè'
          ]
        },
        'È∏ΩÂ≠êÁÆ°ÁêÜ': {
          description: 'ÁÆ°ÁêÜÊÇ®ÁöÑ‰ø°È∏ΩÊ°£Ê°à',
          features: [
            'üìã Ë°®Ê†ºËßÜÂõæÔºö‰ª•Ë°®Ê†ºÂΩ¢ÂºèÊü•ÁúãÊâÄÊúâÈ∏ΩÂ≠ê‰ø°ÊÅØÔºåÂåÖÊã¨Ë∂≥ÁéØÂè∑„ÄÅÂêçÁß∞„ÄÅÁ±ªÂûã„ÄÅÁä∂ÊÄÅ„ÄÅÁà∂È∏Ω/ÊØçÈ∏Ω„ÄÅÁé∞È∏Ω‰∏ª„ÄÅÂèÇËµõËÆ∞ÂΩïÊï∞',
            'üÉè Âç°ÁâáËßÜÂõæÔºö‰ª•Âç°ÁâáÂΩ¢ÂºèÊü•ÁúãÈ∏ΩÂ≠ê‰ø°ÊÅØÔºåÊõ¥Áõ¥ËßÇÁæéËßÇ',
            '‚ûï Êñ∞Â¢ûÈ∏ΩÂ≠êÔºöÊ∑ªÂä†Êñ∞ÁöÑ‰ø°È∏ΩÊ°£Ê°à',
            'üîç Êü•ÁúãËØ¶ÊÉÖÔºöÁÇπÂáªÊü•ÁúãÊåâÈíÆÊü•ÁúãÈ∏ΩÂ≠êÁöÑËØ¶ÁªÜ‰ø°ÊÅØ'
          ]
        },
        'Ë°ÄÁªüÂÖ≥Á≥ª': {
          description: 'Êü•ÁúãÂíåÁÆ°ÁêÜ‰ø°È∏ΩÁöÑË°ÄÁªüÂÖ≥Á≥ªÊ†ë',
          features: [
            'üå≥ Ë°ÄÁªüÊ†ëÔºöÈÄâÊã©È∏ΩÂ≠êÊü•ÁúãÂÖ∂ÂÆåÊï¥ÁöÑË°ÄÁªüÂÖ≥Á≥ªÊ†ëÔºàÂåÖÊã¨‰∫≤‰ª£ÂíåÂ≠ê‰ª£Ôºâ',
            'üîç ÊêúÁ¥¢ÂäüËÉΩÔºöÈÄöËøáË∂≥ÁéØÂè∑ÊàñÂêçÂ≠óÊêúÁ¥¢È∏ΩÂ≠ê',
            'üìä ÁßçÈ∏ΩÊ†ëÔºöÊòæÁ§∫ÊâÄÊúâÁßçÈ∏ΩÁöÑÂÖ≥Á≥ªÊ†ë'
          ]
        },
        'ÁªüËÆ°ÂàÜÊûê': {
          description: 'Êü•ÁúãÂπ¥Â∫¶ÁªüËÆ°Êï∞ÊçÆ',
          features: [
            'üìà Âπ¥Â∫¶ÁªüËÆ°Ê¶ÇËßàÔºöÊåâÂπ¥‰ªΩÊ±áÊÄªÂá∫ÁîüÊï∞Èáè„ÄÅÊ≠ª‰∫°Êï∞Èáè‰ª•ÂèäÊúâÂèÇËµõËÆ∞ÂΩïÁöÑÈ∏ΩÂ≠êÊï∞Èáè',
            'üìä Êï∞ÊçÆË°®Ê†ºÔºö‰ª•Ë°®Ê†ºÂΩ¢ÂºèÂ±ïÁ§∫ÁªüËÆ°Êï∞ÊçÆ'
          ]
        },
        'ÊØîËµõ‰∏éÊàêÁª©': {
          description: 'ÁÆ°ÁêÜÊØîËµõÂíåÊàêÁª©ËÆ∞ÂΩï',
          features: [
            'üìã ÊØîËµõÂàóË°®ÔºöÊü•ÁúãÊâÄÊúâÊØîËµõ‰ø°ÊÅØÔºåÂåÖÊã¨ÊØîËµõÂêçÁß∞„ÄÅÊó•Êúü„ÄÅÂú∞ÁÇπ„ÄÅË∑ùÁ¶ª„ÄÅÁä∂ÊÄÅ„ÄÅÂèÇËµõÊï∞',
            'üì• ÂØºÂÖ•ÊàêÁª©Ôºö‰ªéExcelÊñá‰ª∂ÂØºÂÖ•ÊØîËµõÊàêÁª©',
            'üìä ÊØîËµõÁªüËÆ°ÔºöÊü•ÁúãÊØîËµõÁªüËÆ°Êï∞ÊçÆ',
            'üß† ÊàêÁª©ÂàÜÊûêÔºöÂàÜÊûêÊØîËµõÊàêÁª©Ë∂ãÂäø',
            'üß¨ Ë°ÄÁªüÂØπÊØîÔºöÂØπÊØî‰∏çÂêåË°ÄÁªüÁöÑÈ∏ΩÂ≠êË°®Áé∞'
          ]
        },
        'ÁπÅËÇ≤‰∏éÈÖçÂØπ': {
          description: 'ÁÆ°ÁêÜ‰ø°È∏ΩÁöÑÁπÅËÇ≤ÂíåÈÖçÂØπ',
          features: [
            'üíï ÈÖçÂØπÈÄâÊã©ÔºöÈÄâÊã©Áà∂È∏ΩÂíåÊØçÈ∏ΩËøõË°åÈÖçÂØπ',
            'üìä ÈÖçÂØπÂàÜÊûêÔºöÁ≥ªÁªüËá™Âä®ÂàÜÊûêÈÖçÂØπÂèØË°åÊÄß',
            '‚ûï Êñ∞Â¢ûÈÖçÂØπÔºöÊ∑ªÂä†Êñ∞ÁöÑÈÖçÂØπËÆ∞ÂΩï'
          ]
        },
        'ÂÅ•Â∫∑ÁÆ°ÁêÜ': {
          description: 'ÁÆ°ÁêÜ‰ø°È∏ΩÁöÑÂÅ•Â∫∑ËÆ∞ÂΩï',
          features: [
            'üìù ÂÅ•Â∫∑ËÆ∞ÂΩïÔºöËÆ∞ÂΩïÈ∏ΩÂ≠êÁöÑÂÅ•Â∫∑Áä∂ÊÄÅ„ÄÅÊó•Êúü„ÄÅÂ§áÊ≥®Á≠â‰ø°ÊÅØ',
            '‚ûï Êñ∞Â¢ûËÆ∞ÂΩïÔºöÊ∑ªÂä†Êñ∞ÁöÑÂÅ•Â∫∑ËÆ∞ÂΩï',
            'üìã ËÆ∞ÂΩïÂàóË°®ÔºöÊü•ÁúãÊâÄÊúâÂÅ•Â∫∑ËÆ∞ÂΩï'
          ]
        },
        'Êô∫ËÉΩÂàÜÊûê‰∏≠ÂøÉ': {
          description: '‰ΩøÁî®AIËøõË°åÊô∫ËÉΩÂàÜÊûê',
          features: [
            'üìä Ë°ÄÁªüÂàÜÊûêÔºöÂàÜÊûêÈ∏ΩÂ≠êÁöÑË°ÄÁªü‰ºòÂäøÂíåÈÅó‰º†ÁâπÂæÅ',
            'üèÜ ÊàêÁª©ÂàÜÊûêÔºöÂàÜÊûêÈ∏ΩÂ≠êÁöÑÊØîËµõË°®Áé∞ÂíåÊàêÁª©Ë∂ãÂäø',
            'üíï ÈÖçÂØπÂª∫ËÆÆÔºöÂü∫‰∫éAIÁÆóÊ≥ïÁöÑÊô∫ËÉΩÈÖçÂØπÊé®Ëçê'
          ]
        },
        'ËÆ≠ÁªÉÊ®°Âùó': {
          description: 'ÁÆ°ÁêÜ‰ø°È∏ΩÁöÑËÆ≠ÁªÉËÆ∞ÂΩï',
          features: [
            'üìù ËÆ≠ÁªÉËÆ∞ÂΩïÔºöËÆ∞ÂΩïËÆ≠ÁªÉÊó•Êúü„ÄÅÈ∏ΩÂ≠ê„ÄÅËÆ≠ÁªÉÁ±ªÂûã„ÄÅË∑ùÁ¶ª„ÄÅÁî®Êó∂Á≠â‰ø°ÊÅØ',
            '‚ûï Êñ∞Â¢ûËÆ∞ÂΩïÔºöÊ∑ªÂä†Êñ∞ÁöÑËÆ≠ÁªÉËÆ∞ÂΩï',
            'üìã ËÆ∞ÂΩïÂàóË°®ÔºöÊü•ÁúãÊâÄÊúâËÆ≠ÁªÉËÆ∞ÂΩï'
          ]
        },
        'ËÉΩÂäõÁªºÂêàÂàÜÊûê': {
          description: 'ÁªºÂêàÂàÜÊûêÈ∏ΩÂ≠êÁöÑÂêÑÈ°πËÉΩÂäõÊåáÊ†á',
          features: [
            'üèÜ ÊØîËµõËÉΩÂäõÔºöËØÑ‰º∞È∏ΩÂ≠êÁöÑÊØîËµõË°®Áé∞ËÉΩÂäõ',
            'üß¨ ÈÅó‰º†‰ª∑ÂÄºÔºöËØÑ‰º∞È∏ΩÂ≠êÁöÑÈÅó‰º†‰ª∑ÂÄº',
            'üí™ ÂÅ•Â∫∑ÊåáÊï∞ÔºöËØÑ‰º∞È∏ΩÂ≠êÁöÑÂÅ•Â∫∑Áä∂ÂÜµ',
            '‚≠ê ÁªºÂêàËØÑÂàÜÔºöÁªºÂêàÂêÑÈ°πÊåáÊ†áÁªôÂá∫ÊÄª‰ΩìËØÑÂàÜ'
          ]
        }
      }
    };
    
    // Âä†ËΩΩEvoËÆæÁΩÆ
    // ‰ªéÊúçÂä°Âô®Âä†ËΩΩEvoËÆæÁΩÆÔºàÁÆ°ÁêÜÂëòÊùÉÈôêÔºâ
    async function loadEvoSettings() {
      try {
        const token = getAuthToken();
        if (!token) {
          console.warn('Êú™ÁôªÂΩïÔºåÊó†Ê≥ïÂä†ËΩΩEvoËÆæÁΩÆ');
          return;
        }
        
        // ‰ªéÊúçÂä°Âô®Âä†ËΩΩËÆæÁΩÆ
        const response = await fetch(`${getApiUrl()}/admin/evo-settings`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        let settings = defaultEvoSettings;
        
        if (response.ok) {
          const result = await response.json();
          if (result.success && result.data) {
            settings = result.data;
            // ‰øùÂ≠òÂà∞localStorage‰Ωú‰∏∫ÁºìÂ≠ò
            localStorage.setItem(EVO_SETTINGS_KEY, JSON.stringify(settings));
          }
        } else {
          // Â¶ÇÊûúÊúçÂä°Âô®Âä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®localStorageÁºìÂ≠ò
          const saved = localStorage.getItem(EVO_SETTINGS_KEY);
          if (saved) {
            settings = JSON.parse(saved);
          }
        }
        
        // Â°´ÂÖÖË°®Âçï
        document.getElementById('evoEnabled').checked = settings.enabled !== false;
        document.getElementById('evoPosition').value = settings.position || 'bottom-right';
        document.getElementById('evoDisplayMode').value = settings.displayMode || 'always';
        document.getElementById('evoAutoClose').value = settings.autoClose || 5;
        
        // Ê∏≤ÊüìÂäüËÉΩ‰ΩøÁî®ËØ¥ÊòéÔºàÂ¶ÇÊûúÂáΩÊï∞Â≠òÂú®Ôºâ
        if (typeof renderFunctionGuides === 'function') {
          renderFunctionGuides(settings.functionGuides || defaultEvoSettings.functionGuides);
        }
        document.getElementById('evoIconSize').value = settings.iconSize || 70;
        document.getElementById('evoIconSizeValue').textContent = (settings.iconSize || 70) + 'px';
        
        // ËÆæÁΩÆ‰∏ªÈ¢òÂçïÈÄâÊåâÈíÆ
        const themeRadios = document.querySelectorAll('input[name="evoTheme"]');
        themeRadios.forEach(radio => {
          if (radio.value === (settings.theme || 'purple')) {
            radio.checked = true;
          }
        });
        
        document.getElementById('evoShowWelcome').checked = settings.showWelcome !== false;
        document.getElementById('evoSaveHistory').checked = settings.saveHistory !== false;
        document.getElementById('evoShowAnalytics').checked = settings.showAnalytics !== false;
        document.getElementById('evoShowRecommendations').checked = settings.showRecommendations !== false;
        
        // GitHubÈÖçÁΩÆ
        if (settings.github) {
          document.getElementById('evoGithubRepo').value = settings.github.repo || '';
          document.getElementById('evoGithubToken').value = settings.github.token || '';
          document.getElementById('evoGithubApiEndpoint').value = settings.github.apiEndpoint || '';
        }
        
        // ÂõæÊ†áÂ§ßÂ∞èÊªëÂùó‰∫ã‰ª∂
        const iconSizeSlider = document.getElementById('evoIconSize');
        if (iconSizeSlider) {
          iconSizeSlider.addEventListener('input', (e) => {
            document.getElementById('evoIconSizeValue').textContent = e.target.value + 'px';
          });
        }
      } catch (error) {
        console.error('Âä†ËΩΩEvoËÆæÁΩÆÂ§±Ë¥•:', error);
        // ‰ΩøÁî®localStorage‰Ωú‰∏∫Â§áÁî®
        const saved = localStorage.getItem(EVO_SETTINGS_KEY);
        if (saved) {
          const settings = JSON.parse(saved);
          document.getElementById('evoEnabled').checked = settings.enabled !== false;
          document.getElementById('evoPosition').value = settings.position || 'bottom-right';
          // ... ÂÖ∂‰ªñÂ≠óÊÆµÂ°´ÂÖÖÔºàÂêå‰∏äÔºâ
        }
      }
    }
    
    // Ê∏≤ÊüìÂäüËÉΩ‰ΩøÁî®ËØ¥Êòé
    function renderFunctionGuides(functionGuides) {
      const container = document.getElementById('functionGuidesContainer');
      if (!container) return;
      
      container.innerHTML = '';
      
      Object.entries(functionGuides).forEach(([funcName, guide]) => {
        const guideItem = document.createElement('div');
        guideItem.className = 'function-guide-item';
        guideItem.style.cssText = `
          border: 1px solid var(--border-medium);
          border-radius: 8px;
          padding: 16px;
          background: var(--bg-secondary);
        `;
        
        guideItem.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <h4 style="margin: 0; color: var(--text-primary);">${funcName}</h4>
            <button type="button" class="btn btn-sm btn-outline" onclick="editFunctionGuide('${funcName}')" style="padding: 4px 12px;">ÁºñËæë</button>
          </div>
          <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">${guide.description}</div>
          <div style="font-size: 13px; color: var(--text-muted);">
            <strong>ÂäüËÉΩÁÇπÔºö</strong>${guide.features.length} È°π
          </div>
        `;
        
        container.appendChild(guideItem);
      });
    }
    
    // ÁºñËæëÂäüËÉΩËØ¥Êòé
    window.editFunctionGuide = function(funcName) {
      const functionGuides = getFunctionGuidesFromSettings();
      const guide = functionGuides[funcName] || { description: '', features: [] };
      
      const description = prompt(`ÁºñËæë"${funcName}"ÁöÑÊèèËø∞Ôºö`, guide.description);
      if (description === null) return;
      
      const featuresStr = prompt(`ÁºñËæë"${funcName}"ÁöÑÂäüËÉΩÁÇπÔºàÊØèË°å‰∏Ä‰∏™ÔºâÔºö`, guide.features.join('\n'));
      if (featuresStr === null) return;
      
      const features = featuresStr.split('\n').filter(f => f.trim());
      
      functionGuides[funcName] = {
        description: description.trim(),
        features: features
      };
      
      renderFunctionGuides(functionGuides);
      showEvoSettingsStatus('ÂäüËÉΩËØ¥ÊòéÂ∑≤Êõ¥Êñ∞ÔºåËØ∑ÁÇπÂáª"‰øùÂ≠òËÆæÁΩÆ"‰øùÂ≠ò', 'info');
    };
    
    // ‰ªéËÆæÁΩÆ‰∏≠Ëé∑ÂèñÂäüËÉΩËØ¥Êòé
    function getFunctionGuidesFromSettings() {
      const container = document.getElementById('functionGuidesContainer');
      if (!container) return defaultEvoSettings.functionGuides;
      
      // ‰ªéÂΩìÂâçÊòæÁ§∫ÁöÑËÆæÁΩÆ‰∏≠Ëé∑ÂèñÔºàÂÆûÈôÖÂ∫îËØ•‰ªéË°®ÂçïÊàñËÆæÁΩÆÂØπË±°‰∏≠Ëé∑ÂèñÔºâ
      // ËøôÈáåÁÆÄÂåñÂ§ÑÁêÜÔºåÂÆûÈôÖÂ∫îËØ•Áª¥Êä§‰∏Ä‰∏™Áä∂ÊÄÅ
      try {
        const saved = localStorage.getItem(EVO_SETTINGS_KEY);
        if (saved) {
          const settings = JSON.parse(saved);
          return settings.functionGuides || defaultEvoSettings.functionGuides;
        }
      } catch (e) {}
      
      return defaultEvoSettings.functionGuides;
    }
    
    // ‰øùÂ≠òEvoËÆæÁΩÆÂà∞ÊúçÂä°Âô®ÔºàÁÆ°ÁêÜÂëòÊùÉÈôêÔºå‰∏ªÁ´ô‰ºöËá™Âä®ÂêåÊ≠•Ôºâ
    async function saveEvoSettings() {
      try {
        const settings = {
          enabled: document.getElementById('evoEnabled').checked,
          position: document.getElementById('evoPosition').value,
          displayMode: document.getElementById('evoDisplayMode').value,
          autoClose: parseInt(document.getElementById('evoAutoClose').value) || 5,
          iconSize: parseInt(document.getElementById('evoIconSize').value) || 70,
          theme: document.querySelector('input[name="evoTheme"]:checked')?.value || 'purple',
          showWelcome: document.getElementById('evoShowWelcome').checked,
          saveHistory: document.getElementById('evoSaveHistory').checked,
          showAnalytics: document.getElementById('evoShowAnalytics').checked,
          showRecommendations: document.getElementById('evoShowRecommendations').checked,
          github: {
            repo: document.getElementById('evoGithubRepo').value.trim(),
            token: document.getElementById('evoGithubToken').value.trim(),
            apiEndpoint: document.getElementById('evoGithubApiEndpoint').value.trim()
          },
          functionGuides: getFunctionGuidesFromSettings()
        };
        
        // Áõ¥Êé•‰øùÂ≠òÂà∞ÊúçÂä°Âô®ÔºàÁÆ°ÁêÜÂëòÊùÉÈôêÔºâ
        const token = getAuthToken();
        if (!token) {
          throw new Error('ËØ∑ÂÖàÁôªÂΩïÁÆ°ÁêÜÂëòË¥¶Âè∑');
        }
        
        const response = await fetch(`${getApiUrl()}/admin/evo-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(settings)
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            // ‰øùÂ≠òÂà∞localStorage‰Ωú‰∏∫ÁºìÂ≠ò
            localStorage.setItem(EVO_SETTINGS_KEY, JSON.stringify(result.data));
            
            // ËÆæÁΩÆÂêåÊ≠•Ê†áÂøóÔºå‰∏ªÁ´ô‰ºöËá™Âä®Ê£ÄÊµãÂπ∂ÂêåÊ≠•
            localStorage.setItem(EVO_SYNC_KEY, 'true');
            localStorage.setItem('evo_settings_sync_timestamp', Date.now().toString());
            
            showEvoSettingsStatus('‚úÖ ËÆæÁΩÆÂ∑≤‰øùÂ≠òÂà∞ÊúçÂä°Âô®ÔºÅ‰∏ªÁ´ôÂ∞ÜËá™Âä®Êõ¥Êñ∞„ÄÇ', 'success');
            console.log('‚úÖ EvoËÆæÁΩÆÂ∑≤‰øùÂ≠òÂà∞ÊúçÂä°Âô®Ôºå‰∏ªÁ´ôÂ∞ÜËá™Âä®ÂêåÊ≠•');
            
            return result.data;
          } else {
            throw new Error(result.error || '‰øùÂ≠òÂ§±Ë¥•');
          }
        } else {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || 'ÊúçÂä°Âô®ÂìçÂ∫îÈîôËØØ');
        }
      } catch (error) {
        console.error('‰øùÂ≠òEvoËÆæÁΩÆÂ§±Ë¥•:', error);
        showEvoSettingsStatus('‚ùå ‰øùÂ≠òÂ§±Ë¥•Ôºö' + error.message, 'error');
        return null;
      }
    }
    
    // ÈáçÁΩÆ‰∏∫ÈªòËÆ§ËÆæÁΩÆ
    function resetEvoSettings() {
      if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆ‰∏∫ÈªòËÆ§ËÆæÁΩÆÂêóÔºü')) {
        localStorage.removeItem(EVO_SETTINGS_KEY);
        loadEvoSettings();
        showEvoSettingsStatus('Â∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§ËÆæÁΩÆ', 'info');
      }
    }
    
    // ÂêåÊ≠•Âà∞‰∏ªÁ´ôÔºàÂ∑≤ÈõÜÊàêÂà∞saveEvoSettings‰∏≠ÔºåÊ≠§ÂáΩÊï∞‰øùÁïôÁî®‰∫éÊâãÂä®Ëß¶ÂèëÔºâ
    async function syncEvoSettingsToMainSite() {
      try {
        // ÂÖà‰øùÂ≠òËÆæÁΩÆ
        const settings = await saveEvoSettings();
        if (settings) {
          showEvoSettingsStatus('‚úÖ ËÆæÁΩÆÂ∑≤‰øùÂ≠òÂπ∂ÂêåÊ≠•ÔºÅ‰∏ªÁ´ôÂ∞ÜËá™Âä®Êõ¥Êñ∞„ÄÇ', 'success');
          
          // ÂèØÈÄâÔºöÊâìÂºÄ‰∏ªÁ´ôÊü•ÁúãÊïàÊûú
          const mainSiteUrl = window.location.origin.replace('/admin.html', '/index.html');
          if (confirm('ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅÊòØÂê¶Áé∞Âú®ÊâìÂºÄ‰∏ªÁ´ôÊü•ÁúãÊïàÊûúÔºü')) {
            window.open(mainSiteUrl, '_blank');
          }
        }
      } catch (error) {
        console.error('ÂêåÊ≠•Âà∞‰∏ªÁ´ôÂ§±Ë¥•:', error);
        showEvoSettingsStatus('‚ùå ÂêåÊ≠•Â§±Ë¥•Ôºö' + error.message, 'error');
      }
    }
    
    // ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
    function showEvoSettingsStatus(message, type = 'info') {
      const statusEl = document.getElementById('evoSettingsStatus');
      if (!statusEl) return;
      
      statusEl.style.display = 'block';
      statusEl.textContent = message;
      
      // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆÊ†∑Âºè
      statusEl.style.background = type === 'success' ? 'var(--success-light)' : 
                                  type === 'error' ? 'var(--danger-light)' : 
                                  'var(--primary-50)';
      statusEl.style.color = type === 'success' ? 'var(--success)' : 
                             type === 'error' ? 'var(--danger)' : 
                             'var(--primary)';
      statusEl.style.border = `1px solid ${type === 'success' ? 'var(--success)' : 
                                            type === 'error' ? 'var(--danger)' : 
                                            'var(--primary)'}`;
      
      // 3ÁßíÂêéËá™Âä®ÈöêËóè
      setTimeout(() => {
        statusEl.style.display = 'none';
      }, 3000);
    }
    
    // Âä†ËΩΩAIÊ®°Âûã‰ø°ÊÅØÔºàÊô∫ËÉΩÁÆ°ÁêÜÔºâ
    async function loadAdminAIModelInfo() {
      try {
        const token = getAuthToken();
        if (!token) return;
        
        const response = await fetch(`${getApiUrl()}/evo/model-info`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.data) {
            displayAdminAIModelInfo(data.data);
          }
        }
      } catch (error) {
        console.error('Âä†ËΩΩAIÊ®°Âûã‰ø°ÊÅØÂ§±Ë¥•:', error);
        // ‰ΩøÁî®ÈªòËÆ§‰ø°ÊÅØ
        displayAdminAIModelInfo({
          name: 'Zephyr-7B-Beta',
          provider: 'Hugging Face',
          source: 'https://huggingface.co/HuggingFaceH4/zephyr-7b-beta',
          free: true,
          features: ['ÂÆåÂÖ®ÂÖçË¥π‰ΩøÁî®', 'Êó†ÈúÄ‰ø°Áî®Âç°', 'ÊîØÊåÅ‰∏≠ÊñáÂØπËØù', 'È´òÊÄßËÉΩÂìçÂ∫î', 'ÂºÄÊ∫êÊ®°Âûã']
        });
      }
    }
    
    // ÊòæÁ§∫AIÊ®°Âûã‰ø°ÊÅØÔºàÊô∫ËÉΩÁÆ°ÁêÜÔºâ
    function displayAdminAIModelInfo(modelInfo) {
      if (!modelInfo) return;
      
      const nameEl = document.getElementById('adminAIModelName');
      const providerEl = document.getElementById('adminAIProvider');
      const sourceEl = document.getElementById('adminAISource');
      const statusEl = document.getElementById('adminAIStatus');
      const featuresEl = document.getElementById('adminAIFeatures');
      
      if (nameEl) nameEl.textContent = modelInfo.name || 'Êú™Áü•';
      if (providerEl) providerEl.textContent = modelInfo.provider || 'Êú™Áü•';
      if (sourceEl) {
        sourceEl.href = modelInfo.source || '#';
        sourceEl.textContent = modelInfo.source ? 'Êü•ÁúãÊ®°ÂûãËØ¶ÊÉÖ' : 'Êú™Áü•';
      }
      
      if (statusEl) {
        statusEl.textContent = modelInfo.free ? '‚úÖ ÂÖçË¥π‰ΩøÁî®' : 'üí∞ ‰ªòË¥π';
        statusEl.style.background = modelInfo.free ? 'rgba(76, 175, 80, 0.3)' : 'rgba(255, 152, 0, 0.3)';
      }
      
      if (featuresEl && modelInfo.features) {
        featuresEl.innerHTML = modelInfo.features.map(f => `‚Ä¢ ${f}`).join('<br>');
      }
    }
    
    // ÊµãËØïAIËøûÊé•ÔºàÊô∫ËÉΩÁÆ°ÁêÜÔºâ
    async function testAdminAIConnection() {
      const btn = document.getElementById('btnAdminTestAI');
      const statusEl = document.getElementById('adminAIStatus');
      
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'ÊµãËØï‰∏≠...';
      }
      
      if (statusEl) {
        statusEl.textContent = 'ÊµãËØï‰∏≠...';
        statusEl.style.background = 'rgba(255, 152, 0, 0.3)';
      }
      
      try {
        const token = getAuthToken();
        if (!token) {
          throw new Error('ËØ∑ÂÖàÁôªÂΩï');
        }
        
        const response = await fetch(`${getApiUrl()}/evo/test`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          if (statusEl) {
            statusEl.textContent = '‚úÖ ËøûÊé•Ê≠£Â∏∏';
            statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
          }
          alert('AI ËøûÊé•ÊµãËØïÊàêÂäüÔºÅ\n\nÊ®°ÂûãÔºö' + (data.data?.model || 'Êú™Áü•') + '\nÊèê‰æõÂïÜÔºö' + (data.data?.provider || 'Êú™Áü•'));
        } else {
          throw new Error(data.message || 'ËøûÊé•Â§±Ë¥•');
        }
      } catch (error) {
        if (statusEl) {
          statusEl.textContent = '‚ùå ËøûÊé•Â§±Ë¥•';
          statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
        }
        alert('AI ËøûÊé•ÊµãËØïÂ§±Ë¥•Ôºö' + error.message);
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'ÊµãËØï AI ËøûÊé•';
        }
      }
    }
    
    // Áî®Êà∑‰ø°ÊÅØÂíåËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÂáΩÊï∞
    // Âä†ËΩΩÁî®Êà∑ËÆæÁΩÆ
    function loadUserSettings() {
      try {
        const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
        return {
          avatar: settings.avatar || null,
          displayName: settings.displayName || null
        };
      } catch (e) {
        console.error('Âä†ËΩΩÁî®Êà∑ËÆæÁΩÆÂ§±Ë¥•:', e);
        return { avatar: null, displayName: null };
      }
    }
    
    // ‰øùÂ≠òÁî®Êà∑ËÆæÁΩÆ
    function saveUserSettings(settings) {
      try {
        localStorage.setItem('userSettings', JSON.stringify(settings));
        return true;
      } catch (e) {
        console.error('‰øùÂ≠òÁî®Êà∑ËÆæÁΩÆÂ§±Ë¥•:', e);
        return false;
      }
    }
    
    // Êõ¥Êñ∞È°∂ÈÉ®ÂØºËà™Ê†èÁöÑÁî®Êà∑ÊòæÁ§∫
    function updateTopBarUserDisplay() {
      const settings = loadUserSettings();
      const adminUserName = document.getElementById('adminUserName');
      const btnUserAvatar = document.getElementById('btnUserAvatar');
      
      // Êõ¥Êñ∞Áî®Êà∑ÂêçÊòæÁ§∫
      if (adminUserName) {
        const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
        const displayName = settings.displayName || userInfo.username || 'ÁÆ°ÁêÜÂëò';
        adminUserName.textContent = `Ê¨¢ËøéÔºå${displayName}`;
      }
      
      // Êõ¥Êñ∞Ë¥¶Êà∑ÊåâÈíÆ
      if (btnUserAvatar) {
        const avatarSpan = btnUserAvatar.querySelector('span:first-child');
        const textSpan = btnUserAvatar.querySelector('span:last-child');
        
        if (settings.avatar) {
          // Â¶ÇÊûúÊúâËá™ÂÆö‰πâÂ§¥ÂÉèÔºåÊòæÁ§∫Â§¥ÂÉèÂõæÁâá
          if (!avatarSpan || avatarSpan.textContent === 'üë§') {
            const img = document.createElement('img');
            img.src = settings.avatar;
            img.style.cssText = 'width:20px;height:20px;border-radius:50%;object-fit:cover;';
            if (avatarSpan) {
              avatarSpan.replaceWith(img);
            } else {
              btnUserAvatar.insertBefore(img, textSpan);
            }
          } else if (avatarSpan.tagName === 'IMG') {
            avatarSpan.src = settings.avatar;
          }
        } else {
          // Â¶ÇÊûúÊ≤°ÊúâËá™ÂÆö‰πâÂ§¥ÂÉèÔºåÊòæÁ§∫ÈªòËÆ§ÂõæÊ†á
          if (avatarSpan && avatarSpan.tagName === 'IMG') {
            const span = document.createElement('span');
            span.textContent = 'üë§';
            span.style.fontSize = '16px';
            avatarSpan.replaceWith(span);
          }
        }
        
        if (textSpan) {
          const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
          const displayName = settings.displayName || userInfo.username || 'Ë¥¶Êà∑';
          textSpan.textContent = displayName.length > 8 ? displayName.substring(0, 8) + '...' : displayName;
        }
      }
    }
    
    window.showUserInfoModal = function() {
      const modal = document.getElementById('userInfoModal');
      if (!modal) return;
      
      // ÂàáÊç¢Âà∞Êü•ÁúãÊ®°Âºè
      document.getElementById('userInfoViewMode').style.display = 'block';
      document.getElementById('userInfoEditMode').style.display = 'none';
      
      // ‰ªélocalStorageÊàñÂΩìÂâçÁôªÂΩï‰ø°ÊÅØËé∑ÂèñÁî®Êà∑Êï∞ÊçÆ
      const adminUserName = document.getElementById('adminUserName')?.textContent || '';
      const userNameMatch = adminUserName.match(/Ê¨¢ËøéÔºå(.+)/);
        const defaultUserName = userNameMatch ? userNameMatch[1] : 'ÁÆ°ÁêÜÂëò';
      
      // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÔºà‰ªélocalStorageÊàñAPIÔºâ
      const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
      const userSettings = loadUserSettings();
      const userName = userSettings.displayName || defaultUserName;
      const userEmail = userInfo.email || 'admin@example.com';
      const userType = userInfo.type || 'ÁÆ°ÁêÜÂëò';
      const registerDate = userInfo.registerDate || new Date().toISOString().split('T')[0];
      const userRole = userInfo.role || 'ÁÆ°ÁêÜÂëò';
      
      // Êõ¥Êñ∞ÊòæÁ§∫
      const avatarDisplay = document.getElementById('userAvatarDisplay');
      if (userSettings.avatar) {
        avatarDisplay.style.backgroundImage = `url(${userSettings.avatar})`;
        avatarDisplay.textContent = '';
      } else {
        avatarDisplay.style.backgroundImage = '';
        avatarDisplay.textContent = 'üë§';
      }
      
      document.getElementById('userNameDisplay').textContent = userName;
      document.getElementById('userEmailDisplay').textContent = userEmail;
      document.getElementById('userTypeDisplay').textContent = userType;
      document.getElementById('userRegisterDate').textContent = registerDate;
      document.getElementById('userRoleDisplay').textContent = userRole;
      
      // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
      modal.style.display = 'flex';
    };
    
    // ËøõÂÖ•ÁºñËæëÊ®°Âºè
    window.enterEditUserInfoMode = function() {
      document.getElementById('userInfoViewMode').style.display = 'none';
      document.getElementById('userInfoEditMode').style.display = 'block';
      
      // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
      const userSettings = loadUserSettings();
      const adminUserName = document.getElementById('adminUserName')?.textContent || '';
      const userNameMatch = adminUserName.match(/Ê¨¢ËøéÔºå(.+)/);
        const defaultUserName = userNameMatch ? userNameMatch[1] : 'ÁÆ°ÁêÜÂëò';
      const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
      
      // ËÆæÁΩÆÂ§¥ÂÉèÊòæÁ§∫
      const avatarEditDisplay = document.getElementById('userAvatarEditDisplay');
      if (userSettings.avatar) {
        avatarEditDisplay.style.backgroundImage = `url(${userSettings.avatar})`;
        avatarEditDisplay.textContent = '';
      } else {
        avatarEditDisplay.style.backgroundImage = '';
        avatarEditDisplay.textContent = 'üë§';
      }
      
      // ËÆæÁΩÆÂêçÂ≠óËæìÂÖ•Ê°Ü
      document.getElementById('userNameInput').value = userSettings.displayName || defaultUserName;
      
      // ÁªëÂÆöÂ§¥ÂÉè‰∏ä‰º†‰∫ã‰ª∂
      const avatarInput = document.getElementById('userAvatarInput');
      if (avatarInput) {
        avatarInput.onchange = function(e) {
          const file = e.target.files[0];
          if (file) {
            // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂‰∏∫2MBÔºâ
            if (file.size > 2 * 1024 * 1024) {
              alert('Â§¥ÂÉèÊñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá2MB');
              return;
            }
            
            // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
            if (!file.type.startsWith('image/')) {
              alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂');
              return;
            }
            
            // ËØªÂèñÊñá‰ª∂Âπ∂ËΩ¨Êç¢‰∏∫base64
            const reader = new FileReader();
            reader.onload = function(e) {
              const base64 = e.target.result;
              avatarEditDisplay.style.backgroundImage = `url(${base64})`;
              avatarEditDisplay.textContent = '';
            };
            reader.readAsDataURL(file);
          }
        };
      }
    };
    
    // ÂèñÊ∂àÁºñËæë
    window.cancelEditUserInfo = function() {
      document.getElementById('userInfoViewMode').style.display = 'block';
      document.getElementById('userInfoEditMode').style.display = 'none';
      showUserInfoModal(); // ÈáçÊñ∞Âä†ËΩΩÊòæÁ§∫
    };
    
    // ‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØ
    window.saveUserInfo = function() {
      const userNameInput = document.getElementById('userNameInput');
      const avatarInput = document.getElementById('userAvatarInput');
      const avatarEditDisplay = document.getElementById('userAvatarEditDisplay');
      
      const displayName = userNameInput.value.trim();
      if (!displayName) {
        alert('ËØ∑ËæìÂÖ•ÊòµÁß∞');
        return;
      }
      
      // Ëé∑ÂèñÂ§¥ÂÉèÔºàbase64Ôºâ
      let avatar = null;
      if (avatarEditDisplay.style.backgroundImage && avatarEditDisplay.style.backgroundImage !== 'none') {
        avatar = avatarEditDisplay.style.backgroundImage.replace('url("', '').replace('")', '').replace("url('", '').replace("')", '');
      }
      
      // ‰øùÂ≠òËÆæÁΩÆ
      const success = saveUserSettings({
        avatar: avatar,
        displayName: displayName
      });
      
      if (success) {
        // Êõ¥Êñ∞È°∂ÈÉ®ÂØºËà™Ê†è
        updateTopBarUserDisplay();
        
        // ÂàáÊç¢ÂõûÊü•ÁúãÊ®°ÂºèÂπ∂Âà∑Êñ∞
        cancelEditUserInfo();
        alert('‰øùÂ≠òÊàêÂäüÔºÅ');
      } else {
        alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
      }
    };
    
    window.closeUserInfoModal = function() {
      const modal = document.getElementById('userInfoModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };
    
    window.showSettingsModal = function() {
      const modal = document.getElementById('settingsModal');
      if (!modal) return;
      modal.style.display = 'flex';
      // Êõ¥Êñ∞‰∏ªÈ¢òÊåâÈíÆÊñáÊú¨
      const themeBtn = document.getElementById('btnToggleThemeInModal');
      if (themeBtn) {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        themeBtn.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è ÊµÖËâ≤Ê®°Âºè' : 'üåô Â§úÈó¥Ê®°Âºè';
        themeBtn.title = currentTheme === 'dark' ? 'ÂàáÊç¢Âà∞ÊµÖËâ≤Ê®°Âºè' : 'ÂàáÊç¢Âà∞Ê∑±Ëâ≤Ê®°Âºè';
      }
    };
    
    window.closeSettingsModal = function() {
      const modal = document.getElementById('settingsModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };
    
    // Êï∞ÊçÆÂØºÂá∫ÂíåÂØºÂÖ•ÂäüËÉΩ
    window.exportAllData = function() {
      try {
        // ‰ªélocalStorageËØªÂèñ‰∏ªÁ´ôÊï∞ÊçÆ
        const pigeonsData = JSON.parse(localStorage.getItem('pigeons') || '[]');
        const racesData = JSON.parse(localStorage.getItem('races') || '[]');
        const pairingsData = JSON.parse(localStorage.getItem('pairings') || '[]');
        const healthRecordsData = JSON.parse(localStorage.getItem('healthRecords') || '[]');
        const usedNamesData = JSON.parse(localStorage.getItem('usedNames') || '[]');
        const ownerRegionPairsData = JSON.parse(localStorage.getItem('ownerRegionPairs') || '[]');
        
        const exportData = {
          version: '2.0',
          exportDate: new Date().toISOString(),
          data: {
            pigeons: pigeonsData,
            races: racesData,
            pairings: pairingsData,
            healthRecords: healthRecordsData,
            usedNames: usedNamesData,
            ownerRegionPairs: ownerRegionPairsData
          }
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pigeon_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('Êï∞ÊçÆÂ§á‰ªΩÂ∑≤‰∏ãËΩΩÔºÅ\n\nÂ§á‰ªΩ‰∫Ü ' + pigeonsData.length + ' Âè™È∏ΩÂ≠êÁöÑÊï∞ÊçÆ„ÄÇ\nËØ∑Â¶•ÂñÑ‰øùÁÆ°Â§á‰ªΩÊñá‰ª∂„ÄÇ');
      } catch (error) {
        console.error('ÂØºÂá∫Êï∞ÊçÆÂ§±Ë¥•:', error);
        alert('ÂØºÂá∫Êï∞ÊçÆÂ§±Ë¥•Ôºö' + error.message);
      }
    };
    
    window.importBackupData = function(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const backupData = JSON.parse(e.target.result);
          
          if (!backupData.data || !backupData.data.pigeons) {
            alert('Êó†ÊïàÁöÑÂ§á‰ªΩÊñá‰ª∂Ê†ºÂºè');
            return;
          }
          
          if (!confirm(`Á°ÆÂÆöË¶ÅÊÅ¢Â§çÂ§á‰ªΩÊï∞ÊçÆÂêóÔºü\n\nÂ§á‰ªΩÊó∂Èó¥: ${backupData.exportDate}\nÈ∏ΩÂ≠êÊï∞Èáè: ${backupData.data.pigeons.length}\nÊØîËµõÊï∞Èáè: ${backupData.data.races?.length || 0}\n\n‚ö†Ô∏è ËøôÂ∞ÜË¶ÜÁõñÂΩìÂâçÊâÄÊúâÊï∞ÊçÆÔºÅ`)) {
            return;
          }
          
          // ÊÅ¢Â§çÊï∞ÊçÆÂà∞localStorage
          localStorage.setItem('pigeons', JSON.stringify(backupData.data.pigeons));
          
          if (backupData.data.races) {
            localStorage.setItem('races', JSON.stringify(backupData.data.races));
          }
          
          if (backupData.data.pairings) {
            localStorage.setItem('pairings', JSON.stringify(backupData.data.pairings));
          }
          
          if (backupData.data.healthRecords) {
            localStorage.setItem('healthRecords', JSON.stringify(backupData.data.healthRecords));
          }
          
          if (backupData.data.usedNames) {
            localStorage.setItem('usedNames', JSON.stringify(backupData.data.usedNames));
          }
          
          if (backupData.data.ownerRegionPairs) {
            localStorage.setItem('ownerRegionPairs', JSON.stringify(backupData.data.ownerRegionPairs));
          }
          
          alert('Êï∞ÊçÆÊÅ¢Â§çÊàêÂäüÔºÅ\n\nÂ∑≤ÊÅ¢Â§ç ' + backupData.data.pigeons.length + ' Âè™È∏ΩÂ≠êÁöÑÊï∞ÊçÆ„ÄÇ\nËØ∑Âà∑Êñ∞È°µÈù¢Êü•ÁúãÊõ¥Êñ∞„ÄÇ');
        } catch (error) {
          console.error('ÂØºÂÖ•Êï∞ÊçÆÂ§±Ë¥•:', error);
          alert('ÂØºÂÖ•Êï∞ÊçÆÂ§±Ë¥•Ôºö' + error.message);
        }
      };
      reader.readAsText(file);
    };
    
    // ÂàùÂßãÂåñÁî®Êà∑‰ø°ÊÅØÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
    function initAdminUserInfo() {
      const userInfo = localStorage.getItem('adminUserInfo');
      if (!userInfo) {
        const adminUserName = document.getElementById('adminUserName')?.textContent || '';
        const userNameMatch = adminUserName.match(/Ê¨¢ËøéÔºå(.+)/);
        const userName = userNameMatch ? userNameMatch[1] : 'ÁÆ°ÁêÜÂëò';
        
        const defaultUserInfo = {
          name: userName,
          email: 'admin@example.com',
          type: 'ÁÆ°ÁêÜÂëò',
          role: 'ÁÆ°ÁêÜÂëò',
          registerDate: new Date().toISOString().split('T')[0]
        };
        localStorage.setItem('adminUserInfo', JSON.stringify(defaultUserInfo));
      }
    }
    
    // ÁªëÂÆöÁî®Êà∑Â§¥ÂÉèÂíåËÆæÁΩÆÊåâÈíÆ‰∫ã‰ª∂
    function bindUserButtons() {
      // ÁªëÂÆöÁî®Êà∑Â§¥ÂÉèÊåâÈíÆ
      const btnUserAvatar = document.getElementById('btnUserAvatar');
      if (btnUserAvatar) {
        btnUserAvatar.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          showUserInfoModal();
        });
        
        // È°µÈù¢Âä†ËΩΩÊó∂Êõ¥Êñ∞È°∂ÈÉ®ÂØºËà™Ê†èÁöÑÁî®Êà∑ÊòæÁ§∫
        updateTopBarUserDisplay();
      }
      
      // ÁªëÂÆöËÆæÁΩÆÊåâÈíÆ
      const btnSettings = document.getElementById('btnSettings');
      if (btnSettings) {
        btnSettings.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          showSettingsModal();
        });
      }
      
      // ÁªëÂÆöËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÂÜÖÁöÑÊåâÈíÆ
      const btnToggleThemeInModal = document.getElementById('btnToggleThemeInModal');
      if (btnToggleThemeInModal) {
        btnToggleThemeInModal.addEventListener('click', function() {
          const themeToggle = document.getElementById('themeToggle');
          if (themeToggle) {
            themeToggle.click();
          }
          // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨
          setTimeout(() => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            btnToggleThemeInModal.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è ÊµÖËâ≤Ê®°Âºè' : 'üåô Â§úÈó¥Ê®°Âºè';
            btnToggleThemeInModal.title = currentTheme === 'dark' ? 'ÂàáÊç¢Âà∞ÊµÖËâ≤Ê®°Âºè' : 'ÂàáÊç¢Âà∞Ê∑±Ëâ≤Ê®°Âºè';
          }, 100);
        });
      }
      
      // ÁªëÂÆöÊï∞ÊçÆÁÆ°ÁêÜÊåâÈíÆ
      const btnBackupDataInModal = document.getElementById('btnBackupDataInModal');
      if (btnBackupDataInModal) {
        btnBackupDataInModal.addEventListener('click', function() {
          exportAllData();
        });
      }
      
      const btnExportDataInModal = document.getElementById('btnExportDataInModal');
      if (btnExportDataInModal) {
        btnExportDataInModal.addEventListener('click', function() {
          exportAllData();
        });
      }
      
      const btnImportDataInModal = document.getElementById('btnImportDataInModal');
      if (btnImportDataInModal) {
        btnImportDataInModal.addEventListener('click', function() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
              importBackupData(file);
            }
          };
          input.click();
        });
      }
      
      // ÁªëÂÆöÈÄÄÂá∫ÁôªÂΩïÊåâÈíÆÔºàÂú®ËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÂÜÖÔºâ
      const logoutBtnInModal = document.getElementById('logoutBtnInModal');
      if (logoutBtnInModal) {
        logoutBtnInModal.addEventListener('click', function() {
          localStorage.removeItem('adminToken');
          localStorage.removeItem('adminUser');
          const loginPage = document.getElementById('loginPage');
          const adminPage = document.getElementById('adminPage');
          if (loginPage) loginPage.style.display = 'flex';
          if (adminPage) adminPage.style.display = 'none';
          const usernameInput = document.getElementById('username');
          const passwordInput = document.getElementById('password');
          if (usernameInput) usernameInput.value = '';
          if (passwordInput) passwordInput.value = '';
          closeSettingsModal();
        });
      }
      
      // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠
      const userInfoModal = document.getElementById('userInfoModal');
      const settingsModal = document.getElementById('settingsModal');
      
      if (userInfoModal) {
        userInfoModal.addEventListener('click', function(e) {
          if (e.target === userInfoModal) {
            closeUserInfoModal();
          }
        });
      }
      
      if (settingsModal) {
        settingsModal.addEventListener('click', function(e) {
          if (e.target === settingsModal) {
            closeSettingsModal();
          }
        });
      }
      
      // ESCÈîÆÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeUserInfoModal();
          closeSettingsModal();
        }
      });
    }
    
    // ÁªëÂÆöEvoËÆæÁΩÆÊåâÈíÆ‰∫ã‰ª∂
    document.addEventListener('DOMContentLoaded', () => {
      // ÂàùÂßãÂåñÁî®Êà∑‰ø°ÊÅØ
      initAdminUserInfo();
      
      // ÁªëÂÆöÁî®Êà∑ÊåâÈíÆ
      bindUserButtons();
      
      // Âª∂ËøüÁªëÂÆöÔºåÁ°Æ‰øùÁî®Êà∑ÂêçÂ∑≤Âä†ËΩΩ
      setTimeout(() => {
        initAdminUserInfo();
      }, 1000);
      const btnSave = document.getElementById('btnSaveEvoSettings');
      const btnReset = document.getElementById('btnResetEvoSettings');
      const btnSync = document.getElementById('btnSyncEvoSettings');
      const btnTestAI = document.getElementById('btnAdminTestAI');
      
      if (btnSave) {
        btnSave.addEventListener('click', saveEvoSettings);
      }
      
      if (btnReset) {
        btnReset.addEventListener('click', resetEvoSettings);
      }
      
      if (btnSync) {
        btnSync.addEventListener('click', syncEvoSettingsToMainSite);
      }
      
      if (btnTestAI) {
        btnTestAI.addEventListener('click', testAdminAIConnection);
      }
      
      // ÂΩìÂàáÊç¢Âà∞EvoËÆæÁΩÆÊ†áÁ≠æÊó∂ÔºåÂä†ËΩΩAIÊ®°Âûã‰ø°ÊÅØ
      const evoSettingsTab = document.getElementById('evoSettingsTab');
      if (evoSettingsTab) {
        // Á´ãÂç≥Âä†ËΩΩ‰∏ÄÊ¨°ÔºàÂ¶ÇÊûúÊ†áÁ≠æÈ°µÂ∑≤ÁªèÊòæÁ§∫Ôºâ
        if (evoSettingsTab.style.display !== 'none') {
          console.log('üîÑ EvoËÆæÁΩÆÈ°µÈù¢Â∑≤ÊòæÁ§∫ÔºåÁ´ãÂç≥Âä†ËΩΩAI‰ø°ÊÅØ...');
          setTimeout(() => {
            loadAdminAIModelInfo();
            loadEvoAIModelInfo();
          }, 200);
        }
        
        const observer = new MutationObserver((mutations) => {
          if (evoSettingsTab.style.display !== 'none') {
            console.log('üîÑ EvoËÆæÁΩÆÈ°µÈù¢ÊòæÁ§∫ÔºåÂä†ËΩΩAI‰ø°ÊÅØ...');
            setTimeout(() => {
              loadAdminAIModelInfo();
              loadEvoAIModelInfo();
            }, 200);
          }
        });
        observer.observe(evoSettingsTab, { attributes: true, attributeFilter: ['style'] });
        
        // ÁõëÂê¨ÊâÄÊúâÂèØËÉΩÁöÑÊ†áÁ≠æÂàáÊç¢ÊñπÂºè
        // ÊñπÂºè1ÔºöÈÄöËøáÂØºËà™ËèúÂçï
        document.querySelectorAll('[data-tab="evoSettings"], [onclick*="evoSettings"]').forEach(el => {
          el.addEventListener('click', () => {
            setTimeout(() => {
              if (evoSettingsTab.style.display !== 'none') {
                console.log('üîÑ ÁÇπÂáªEvoËÆæÁΩÆÊ†áÁ≠æÔºåÂä†ËΩΩAI‰ø°ÊÅØ...');
                loadEvoAIModelInfo();
              }
            }, 300);
          });
        });
        
        // ÊñπÂºè2ÔºöÈÄöËøá‰æßËæπÊ†èÁÇπÂáª
        const sidebarLinks = document.querySelectorAll('a, .nav-item, .menu-item');
        sidebarLinks.forEach(link => {
          if (link.textContent && link.textContent.includes('EvoËÆæÁΩÆ')) {
            link.addEventListener('click', () => {
              setTimeout(() => {
                if (evoSettingsTab.style.display !== 'none') {
                  console.log('üîÑ ÈÄöËøá‰æßËæπÊ†èÊâìÂºÄEvoËÆæÁΩÆÔºåÂä†ËΩΩAI‰ø°ÊÅØ...');
                  loadEvoAIModelInfo();
                }
              }, 300);
            });
          }
        });
      }
      
      // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêé‰πüÂ∞ùËØïÂä†ËΩΩ‰∏ÄÊ¨°
      if (document.readyState === 'complete') {
        setTimeout(() => {
          if (evoSettingsTab && evoSettingsTab.style.display !== 'none') {
            console.log('üîÑ È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÊ£ÄÊü•EvoËÆæÁΩÆÈ°µÈù¢...');
            loadEvoAIModelInfo();
          }
        }, 1000);
      } else {
        window.addEventListener('load', () => {
          setTimeout(() => {
            if (evoSettingsTab && evoSettingsTab.style.display !== 'none') {
              console.log('üîÑ Á™óÂè£Âä†ËΩΩÂÆåÊàêÔºåÊ£ÄÊü•EvoËÆæÁΩÆÈ°µÈù¢...');
              loadEvoAIModelInfo();
            }
          }, 1000);
        });
      }
      
      // ÁªëÂÆöEvoËÆæÁΩÆÈ°µÈù¢ÁöÑAI‰ø°ÊÅØÊåâÈíÆ
      const btnRefreshAI = document.getElementById('btnEvoRefreshAIInfo');
      const btnTestEvoAI = document.getElementById('btnEvoTestAI');
      
      if (btnRefreshAI) {
        btnRefreshAI.addEventListener('click', () => {
          console.log('üîÑ ÊâãÂä®Âà∑Êñ∞AI‰ø°ÊÅØÊåâÈíÆË¢´ÁÇπÂáª');
          loadEvoAIModelInfo();
          const statusEl = document.getElementById('evoAIInfoStatus');
          if (statusEl) {
            statusEl.style.display = 'block';
            statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
            statusEl.style.color = 'var(--text-primary)';
            statusEl.textContent = '‚úÖ AI‰ø°ÊÅØÂ∑≤Âà∑Êñ∞';
            setTimeout(() => {
              statusEl.style.display = 'none';
            }, 2000);
          }
        });
      }
      
      // Á°Æ‰øùÈ°µÈù¢Âä†ËΩΩÊó∂‰πüÂ∞ùËØïÂä†ËΩΩAI‰ø°ÊÅØ
      setTimeout(() => {
        const evoSettingsTab = document.getElementById('evoSettingsTab');
        if (evoSettingsTab && evoSettingsTab.style.display !== 'none') {
          console.log('üîÑ EvoËÆæÁΩÆÈ°µÈù¢ÂèØËßÅÔºåËá™Âä®Âä†ËΩΩAI‰ø°ÊÅØ');
          loadEvoAIModelInfo();
        }
      }, 1000);
      
      if (btnTestEvoAI) {
        btnTestEvoAI.addEventListener('click', async () => {
          btnTestEvoAI.disabled = true;
          btnTestEvoAI.textContent = 'ÊµãËØï‰∏≠...';
          
          const statusEl = document.getElementById('evoAIInfoStatus');
          if (statusEl) {
            statusEl.style.display = 'block';
            statusEl.style.background = 'rgba(255, 152, 0, 0.3)';
            statusEl.textContent = 'üîÑ Ê≠£Âú®ÊµãËØïAIËøûÊé•...';
          }
          
          try {
            const token = getAuthToken();
            if (!token) {
              throw new Error('ËØ∑ÂÖàÁôªÂΩï');
            }
            
            const response = await fetch(`${getApiUrl()}/evo/test`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              }
            });
            
            const result = await response.json();
            
            if (statusEl) {
              if (result.success) {
                statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
                statusEl.textContent = `‚úÖ ${result.message || 'AIËøûÊé•ÊµãËØïÊàêÂäüÔºÅ'}`;
              } else {
                statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
                statusEl.textContent = `‚ùå ${result.message || 'AIËøûÊé•ÊµãËØïÂ§±Ë¥•'}`;
              }
            }
          } catch (error) {
            if (statusEl) {
              statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
              statusEl.textContent = `‚ùå ÊµãËØïÂ§±Ë¥•: ${error.message}`;
            }
          } finally {
            btnTestEvoAI.disabled = false;
            btnTestEvoAI.textContent = 'üß™ ÊµãËØïËøûÊé•';
          }
        });
      }
    });
    
    // Ëé∑ÂèñtokenÂáΩÊï∞ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
    function getAuthToken() {
      // ‰ºòÂÖà‰ΩøÁî®adminTokenÔºàÊô∫ËÉΩÁÆ°ÁêÜÁ≥ªÁªü‰ΩøÁî®ÁöÑtokenÔºâ
      const adminToken = localStorage.getItem('adminToken');
      if (adminToken) {
        return adminToken;
      }
      // Â¶ÇÊûúÊ≤°ÊúâadminTokenÔºåÂ∞ùËØï‰ΩøÁî®tokenÔºà‰∏ªÁ´ô‰ΩøÁî®ÁöÑtokenÔºâ
      return localStorage.getItem('token');
    }
    
    // Âä†ËΩΩEvoËÆæÁΩÆÈ°µÈù¢ÁöÑAIÊ®°Âûã‰ø°ÊÅØ
    async function loadEvoAIModelInfo() {
      // ÂÖàÊ£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
      const nameEl = document.getElementById('evoAIModelName');
      const statusInfoEl = document.getElementById('evoAIInfoStatus');
      
      if (!nameEl) {
        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        if (statusInfoEl) {
          statusInfoEl.style.display = 'block';
          statusInfoEl.style.background = 'rgba(255, 152, 0, 0.3)';
          statusInfoEl.style.color = 'var(--text-primary)';
          statusInfoEl.innerHTML = '‚è≥ È°µÈù¢Ê≠£Âú®Âä†ËΩΩÔºåËØ∑Á®çÂÄô...';
        }
        setTimeout(() => loadEvoAIModelInfo(), 500);
        return;
      }
      
      // ÊòæÁ§∫Âä†ËΩΩ‰∏≠Áä∂ÊÄÅ
      if (statusInfoEl) {
        statusInfoEl.style.display = 'block';
        statusInfoEl.style.background = 'rgba(255, 152, 0, 0.3)';
        statusInfoEl.style.color = 'var(--text-primary)';
        statusInfoEl.innerHTML = 'üîÑ Ê≠£Âú®Âä†ËΩΩAI‰ø°ÊÅØ...';
      }
      
      const providerEl = document.getElementById('evoAIProvider');
      if (nameEl) nameEl.textContent = 'Âä†ËΩΩ‰∏≠...';
      if (providerEl) providerEl.textContent = 'Âä†ËΩΩ‰∏≠...';
      
      try {
        const token = getAuthToken();
        if (!token) {
          if (statusInfoEl) {
            statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
            statusInfoEl.innerHTML = '‚ùå <strong>Êú™ÁôªÂΩï</strong><br>ËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªüÔºåÁÑ∂ÂêéÊâçËÉΩÊü•ÁúãAIÊ®°Âûã‰ø°ÊÅØ„ÄÇ';
          }
          displayEvoAIModelInfo(null);
          return;
        }
        
        const apiUrl = getApiUrl();
        
        const response = await fetch(`${apiUrl}/evo/model-info`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success && result.data) {
            displayEvoAIModelInfo(result.data);
          } else {
            if (statusInfoEl) {
              statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
              statusInfoEl.innerHTML = `‚ùå <strong>APIËøîÂõûÈîôËØØ</strong><br>${result.error || 'Êú™Áü•ÈîôËØØ'}`;
            }
            displayEvoAIModelInfo(null);
          }
        } else {
          const errorData = await response.json().catch(() => ({ error: 'Êó†Ê≥ïËß£ÊûêÈîôËØØ‰ø°ÊÅØ' }));
          
          if (statusInfoEl) {
            statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
            let errorMsg = `‚ùå <strong>Âä†ËΩΩÂ§±Ë¥• (${response.status})</strong><br>`;
            
            if (response.status === 401) {
              errorMsg += 'ËÆ§ËØÅÂ§±Ë¥•ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩïÔºÅ';
            } else if (response.status === 404) {
              errorMsg += 'APIÊé•Âè£‰∏çÂ≠òÂú®ÔºåËØ∑Ê£ÄÊü•ÂêéÁ´ØÊúçÂä°ÔºÅ';
            } else if (response.status === 500) {
              errorMsg += 'ÊúçÂä°Âô®ÂÜÖÈÉ®ÈîôËØØÔºåËØ∑Ê£ÄÊü•ÂêéÁ´ØÊó•ÂøóÔºÅ';
            } else {
              errorMsg += errorData.error || 'Êú™Áü•ÈîôËØØ';
            }
            
            statusInfoEl.innerHTML = errorMsg;
          }
          
          displayEvoAIModelInfo(null);
        }
      } catch (error) {
        if (statusInfoEl) {
          statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
          let errorMsg = '‚ùå <strong>ÁΩëÁªúÈîôËØØ</strong><br>';
          
          if (error.message.includes('Failed to fetch')) {
            errorMsg += 'Êó†Ê≥ïËøûÊé•Âà∞ÂêéÁ´ØÊúçÂä°ÔºÅ<br>ËØ∑Á°ÆËÆ§Ôºö<br>1. ÂêéÁ´ØÊúçÂä°Â∑≤ÂêØÂä®ÔºàËøêË°å npm startÔºâ<br>2. ÊúçÂä°Âú∞ÂùÄÊ≠£Á°ÆÔºàhttp://localhost:3000Ôºâ<br>3. ÁΩëÁªúËøûÊé•Ê≠£Â∏∏';
          } else {
            errorMsg += error.message || 'Êú™Áü•ÈîôËØØ';
          }
          
          statusInfoEl.innerHTML = errorMsg;
        }
        
        displayEvoAIModelInfo(null);
      }
    }
    
    // ÊòæÁ§∫EvoËÆæÁΩÆÈ°µÈù¢ÁöÑAIÊ®°Âûã‰ø°ÊÅØ
    function displayEvoAIModelInfo(modelInfo) {
      const nameEl = document.getElementById('evoAIModelName');
      const providerEl = document.getElementById('evoAIProvider');
      const statusEl = document.getElementById('evoAIStatus');
      const sourceEl = document.getElementById('evoAISource');
      const descEl = document.getElementById('evoAIDescription');
      const featuresEl = document.getElementById('evoAIFeatures');
      const statusInfoEl = document.getElementById('evoAIInfoStatus');
      
      // ÊòæÁ§∫Áä∂ÊÄÅ‰ø°ÊÅØ
      if (statusInfoEl) {
        statusInfoEl.style.display = 'block';
        statusInfoEl.style.padding = '12px';
        statusInfoEl.style.borderRadius = '6px';
        statusInfoEl.style.fontSize = '14px';
      }
      
      if (!modelInfo) {
        if (nameEl) nameEl.textContent = '‚ùå Êú™ÈÖçÁΩÆ';
        if (providerEl) providerEl.textContent = 'Êú™Áü•';
        if (statusEl) {
          statusEl.textContent = '‚ùå Êú™ÈÖçÁΩÆ';
          statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
        }
        if (sourceEl) {
          sourceEl.href = '#';
          sourceEl.textContent = 'Êó†';
        }
        if (descEl) descEl.textContent = 'AIÊúçÂä°Êú™ÈÖçÁΩÆÔºåËØ∑Ê£ÄÊü•API KeyËÆæÁΩÆ';
        if (featuresEl) featuresEl.textContent = 'Êó†ÂèØÁî®ÂäüËÉΩ';
        
        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        if (statusInfoEl) {
          statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
          statusInfoEl.style.color = 'var(--text-primary)';
          statusInfoEl.innerHTML = '‚ùå <strong>AI‰ø°ÊÅØÂä†ËΩΩÂ§±Ë¥•</strong><br>ËØ∑ÁÇπÂáª"üîÑ Âà∑Êñ∞‰ø°ÊÅØ"ÊåâÈíÆÈáçËØïÔºåÊàñÊ£ÄÊü•ÂêéÁ´ØÊúçÂä°ÊòØÂê¶Ê≠£Â∏∏ËøêË°å„ÄÇ';
        }
        return;
      }
      
      // ÊòæÁ§∫ÊàêÂäü‰ø°ÊÅØ
      if (statusInfoEl) {
        statusInfoEl.style.background = 'rgba(76, 175, 80, 0.3)';
        statusInfoEl.style.color = 'var(--text-primary)';
        statusInfoEl.innerHTML = '‚úÖ <strong>AI‰ø°ÊÅØÂä†ËΩΩÊàêÂäü</strong>';
        setTimeout(() => {
          if (statusInfoEl) statusInfoEl.style.display = 'none';
        }, 3000);
      }
      
      if (nameEl) nameEl.textContent = modelInfo.name || 'Êú™Áü•';
      if (providerEl) providerEl.textContent = modelInfo.provider || 'Êú™Áü•';
      
      if (statusEl) {
        if (modelInfo.free) {
          statusEl.textContent = '‚úÖ ÂÖçË¥π‰ΩøÁî®';
          statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
        } else {
          statusEl.textContent = 'üí∞ ‰ªòË¥π';
          statusEl.style.background = 'rgba(255, 152, 0, 0.3)';
        }
      }
      
      if (sourceEl) {
        sourceEl.href = modelInfo.source || '#';
        sourceEl.textContent = modelInfo.source ? 'Êü•ÁúãÊ®°ÂûãËØ¶ÊÉÖ' : 'Êó†';
      }
      
      if (descEl) {
        descEl.textContent = modelInfo.description || 'Êô∫ËÉΩÂØπËØùÊ®°ÂûãÔºåÊîØÊåÅ‰∏≠ÊñáÂØπËØù';
      }
      
      if (featuresEl && modelInfo.features && Array.isArray(modelInfo.features)) {
        featuresEl.innerHTML = modelInfo.features.map(f => `‚Ä¢ ${f}`).join('<br>');
      } else if (featuresEl) {
        featuresEl.innerHTML = '‚Ä¢ ÂÆåÂÖ®ÂÖçË¥π‰ΩøÁî®<br>‚Ä¢ ÊîØÊåÅ‰∏≠ÊñáÂØπËØù<br>‚Ä¢ È´òÊÄßËÉΩÂìçÂ∫î';
      }
    }
    
    // ==========================================
    // üïäÔ∏è Evo Êô∫ËÉΩÂä©ÊâãÂäüËÉΩ
    // ==========================================
    
    const EvoAssistant = (function() {
      const CHAT_HISTORY_KEY = 'evo_chat_history';
      const USED_GREETINGS_KEY = 'evo_used_greetings_admin';
      
      // Ê¨¢ËøéÊ∂àÊÅØÂêéÁºÄÈÄâÈ°πÔºàÈíàÂØπÊô∫ËÉΩÁÆ°ÁêÜÔºâ
      const GREETING_SUFFIXES = [
        'ÁÆ°ÁêÜÂÖ¨Âëä',
        'Êü•ÁúãÁªüËÆ°Êï∞ÊçÆ',
        'ÁÆ°ÁêÜÁ≥ªÁªüËÆæÁΩÆ',
        'ÈÖçÁΩÆÊô∫ËÉΩÂä©Êâã',
        'ÂàÜÊûêÁî®Êà∑Êï∞ÊçÆ',
        '‰ºòÂåñÁ≥ªÁªüÊÄßËÉΩ',
        'Êü•ÁúãÁ≥ªÁªüÊó•Âøó',
        'ÁÆ°ÁêÜÊùÉÈôêËÆæÁΩÆ',
        'ÁîüÊàêÊï∞ÊçÆÊä•Ë°®',
        'ÁõëÊéßÁ≥ªÁªüÁä∂ÊÄÅ',
        'ÈÖçÁΩÆAPIÊé•Âè£',
        'ÁÆ°ÁêÜÊï∞ÊçÆÂ§á‰ªΩ',
        '‰ºòÂåñÊï∞ÊçÆÂ∫ì',
        'Êü•ÁúãÁ≥ªÁªüÂàÜÊûê',
        'ÁÆ°ÁêÜÂäüËÉΩÊ®°Âùó'
      ];
      
      let isExpanded = false;
      let activeTab = 'chat';
      let messages = [];
      let isTyping = false;
      let hasShownGreetingThisPageLoad = false;
      let assistantEl, iconButton, dialog, messagesContainer, inputField, sendBtn;
      
      function init() {
        try {
          createHTML();
          bindEvents();
          ensureIconVisible();
          setTimeout(() => ensureIconVisible(), 100);
          setTimeout(() => ensureIconVisible(), 500);
          
          // Âª∂ËøüÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ
          hasShownGreetingThisPageLoad = false;
          setTimeout(() => {
            showWelcomeGreeting();
          }, 1500);
          setTimeout(() => {
            const existingBubble = document.getElementById('evoWelcomeBubble');
            if (!existingBubble) {
              showWelcomeGreeting();
            }
          }, 3000);
        } catch (error) {
          console.error('EvoÂàùÂßãÂåñÈîôËØØ:', error);
        }
      }
      
      function ensureIconVisible() {
        try {
          let assistant = document.getElementById('evoAssistant');
          if (!assistant) {
            createHTML();
            assistant = document.getElementById('evoAssistant');
          }
          if (assistant) {
            assistant.style.cssText = `
              position: fixed !important;
              bottom: 80px !important;
              right: 20px !important;
              z-index: 99999 !important;
              display: block !important;
              visibility: visible !important;
              opacity: 1 !important;
              pointer-events: auto !important;
            `;
            assistantEl = assistant;
          }
        } catch (error) {
          console.error('ensureIconVisibleÈîôËØØ:', error);
        }
      }
      
      function createHTML() {
        const existing = document.getElementById('evoAssistant');
        if (existing) existing.remove();
        
        const html = `
          <div class="evo-assistant" id="evoAssistant">
            <div class="evo-icon-button" id="evoIconButton">
              <div class="evo-pigeon-icon">
                <span class="evo-icon">üïäÔ∏è</span>
                <div class="evo-pulse"></div>
              </div>
            </div>
            
            <div class="evo-dialog" id="evoDialog" style="display: none;">
              <div class="evo-header">
                <div class="evo-header-left">
                  <span class="evo-icon-large">üïäÔ∏è</span>
                  <div>
                    <h3 class="evo-title">Evo Êô∫ËÉΩÂä©Êâã</h3>
                    <p class="evo-subtitle" id="evoStatus">ÂáÜÂ§áÂ•Ω‰∏∫ÊÇ®ÊúçÂä°</p>
                  </div>
                </div>
                <button class="evo-close-btn" id="evoCloseBtn">√ó</button>
              </div>
              
              <div class="evo-content">
                <div class="evo-tabs">
                  <div class="evo-tab-headers">
                    <div class="evo-tab-header active" data-tab="chat">üí¨ ÂØπËØù</div>
                    <div class="evo-tab-header" data-tab="analytics">üìä Êï∞ÊçÆ</div>
                    <div class="evo-tab-header" data-tab="recommendations">‚ú® Êé®Ëçê</div>
                  </div>
                  
                  <div class="evo-tab-content active" id="tabChat">
                    <div class="evo-chat-container">
                      <div class="evo-messages" id="evoMessages"></div>
                      <div class="evo-input-area">
                        <div class="evo-input-group">
                          <input type="text" class="evo-input" id="evoInput" placeholder="ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò...">
                          <button class="evo-send-btn" id="evoSendBtn">ÂèëÈÄÅ</button>
                        </div>
                        <div class="evo-quick-actions">
                          <button class="evo-quick-action-btn" data-action="stats">Êü•ÁúãÁªüËÆ°Êï∞ÊçÆ</button>
                          <button class="evo-quick-action-btn" data-action="help">Â∏ÆÂä©</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="evo-tab-content" id="tabAnalytics">
                    <div class="evo-analytics" id="evoAnalytics">
                      <div class="evo-empty">ÊöÇÊó†ÂàÜÊûêÊä•Âëä</div>
                    </div>
                  </div>
                  
                  <div class="evo-tab-content" id="tabRecommendations">
                    <div class="evo-recommendations" id="evoRecommendations">
                      <div class="evo-empty">ÊöÇÊó†Êé®ËçêÂÜÖÂÆπ</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', html);
        
        assistantEl = document.getElementById('evoAssistant');
        iconButton = document.getElementById('evoIconButton');
        dialog = document.getElementById('evoDialog');
        messagesContainer = document.getElementById('evoMessages');
        inputField = document.getElementById('evoInput');
        sendBtn = document.getElementById('evoSendBtn');
        
        if (assistantEl) {
          assistantEl.style.cssText = `
            position: fixed !important;
            bottom: 80px !important;
            right: 20px !important;
            z-index: 99999 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
          `;
        }
      }
      
      function bindEvents() {
        if (!iconButton) return;
        
        iconButton.addEventListener('click', toggleExpanded);
        const closeBtn = document.getElementById('evoCloseBtn');
        if (closeBtn) {
          closeBtn.addEventListener('click', toggleExpanded);
        }
        
        if (sendBtn) sendBtn.addEventListener('click', sendMessage);
        if (inputField) {
          inputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isTyping) {
              sendMessage();
            }
          });
        }
        
        document.querySelectorAll('.evo-tab-header').forEach(header => {
          header.addEventListener('click', () => {
            const tab = header.dataset.tab;
            switchTab(tab);
          });
        });
        
        document.querySelectorAll('.evo-quick-action-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const action = btn.dataset.action;
            if (action === 'stats') {
              inputField.value = 'Êü•ÁúãÁªüËÆ°Êï∞ÊçÆ';
              sendMessage();
            } else if (action === 'help') {
              inputField.value = 'Â∏ÆÂä©';
              sendMessage();
            }
          });
        });
      }
      
      function toggleExpanded() {
        isExpanded = !isExpanded;
        if (dialog) {
          dialog.style.display = isExpanded ? 'flex' : 'none';
        }
        if (isExpanded) {
          loadHistory();
        }
      }
      
      function switchTab(tab) {
        activeTab = tab;
        document.querySelectorAll('.evo-tab-header').forEach(h => {
          h.classList.toggle('active', h.dataset.tab === tab);
        });
        document.querySelectorAll('.evo-tab-content').forEach(c => {
          c.classList.toggle('active', c.id === `tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
        });
      }
      
      async function sendMessage() {
        const text = inputField.value.trim();
        if (!text || isTyping) return;
        
        addMessage('user', text);
        inputField.value = '';
        
        isTyping = true;
        updateStatus('Ê≠£Âú®ÊÄùËÄÉ...');
        
        try {
          const response = await chat(text);
          addMessage('evo', response.text);
          saveHistory();
        } catch (error) {
          addMessage('evo', 'Êä±Ê≠âÔºåÊàëÊöÇÊó∂Êó†Ê≥ïÂìçÂ∫îÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ');
        } finally {
          isTyping = false;
          updateStatus('Âú®Á∫ø');
        }
      }
      
      // Ëé∑ÂèñtokenÂáΩÊï∞
      function getAuthToken() {
        // ‰ºòÂÖà‰ΩøÁî®adminTokenÔºàÊô∫ËÉΩÁÆ°ÁêÜÁ≥ªÁªü‰ΩøÁî®ÁöÑtokenÔºâ
        const adminToken = localStorage.getItem('adminToken');
        if (adminToken) {
          return adminToken;
        }
        // Â¶ÇÊûúÊ≤°ÊúâadminTokenÔºåÂ∞ùËØï‰ΩøÁî®tokenÔºà‰∏ªÁ´ô‰ΩøÁî®ÁöÑtokenÔºâ
        return localStorage.getItem('token');
      }
      
      // Ë∞ÉÁî®ÂêéÁ´ØAI API
      async function chatWithBackendAPI(question, history = [], context = {}) {
        try {
          // ‰ΩøÁî®Áªü‰∏ÄÁöÑgetApiUrlÂáΩÊï∞
          const apiBaseUrl = getApiUrl();
          
          const token = getAuthToken();
          if (!token) {
            console.warn('‚ùå Êú™ÊâæÂà∞tokenÔºåÊó†Ê≥ïË∞ÉÁî®ÂêéÁ´ØAPI„ÄÇËØ∑ÂÖàÁôªÂΩïÔºÅ');
            return null;
          }
          
          console.log(`üîÑ Ê≠£Âú®Ë∞ÉÁî®ÂêéÁ´ØAI API...`);
          console.log(`üì° APIÂú∞ÂùÄ: ${apiBaseUrl}/evo/chat`);
          console.log(`üìù ÈóÆÈ¢ò: ${question.substring(0, 50)}...`);
          
          const startTime = Date.now();
          const response = await fetch(`${apiBaseUrl}/evo/chat`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              question: question,
              history: history,
              context: context
            })
          });
          
          const responseTime = Date.now() - startTime;
          console.log(`‚è±Ô∏è ÂìçÂ∫îÊó∂Èó¥: ${responseTime}ms`);
          
          if (response.ok) {
            const data = await response.json();
            console.log('üì• APIÂìçÂ∫îÊï∞ÊçÆ:', data);
            
            if (data.success && data.data) {
              const responseText = data.data.text || data.data.response;
              if (responseText && responseText.length > 10) {
                console.log(`‚úÖ AI APIË∞ÉÁî®ÊàêÂäüÔºÅ`);
                console.log(`üìä ÂõûÂ§çÈïøÂ∫¶: ${responseText.length} Â≠óÁ¨¶`);
                console.log(`ü§ñ ‰ΩøÁî®Ê®°Âûã: ${data.data.model || 'Êú™Áü•'}`);
                console.log(`üè¢ ÊúçÂä°Êèê‰æõÂïÜ: ${data.data.provider || 'Êú™Áü•'}`);
                console.log(`üí¨ ÂõûÂ§çÈ¢ÑËßà: ${responseText.substring(0, 100)}...`);
                
                return { 
                  text: responseText, 
                  data: data.data,
                  modelInfo: data.modelInfo || null
                };
              } else {
                console.warn('‚ö†Ô∏è AIÂõûÂ§ç‰∏∫Á©∫ÊàñÂ§™Áü≠ÔºåÈïøÂ∫¶:', responseText?.length || 0);
              }
            } else {
              console.warn('‚ö†Ô∏è APIËøîÂõûsuccess=false:', data);
            }
          } else {
            const errorData = await response.json().catch(() => ({}));
            console.error('‚ùå ÂêéÁ´ØAI APIÂìçÂ∫îÈîôËØØ:', response.status);
            console.error('‚ùå ÈîôËØØËØ¶ÊÉÖ:', errorData);
            
            if (response.status === 401) {
              console.error('‚ùå ËÆ§ËØÅÂ§±Ë¥•ÔºÅËØ∑ÈáçÊñ∞ÁôªÂΩïÔºÅ');
              alert('ÁôªÂΩïÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ÁôªÂΩïÔºÅ');
            } else if (response.status === 500) {
              console.error('‚ùå ÊúçÂä°Âô®ÂÜÖÈÉ®ÈîôËØØÔºÅ');
            } else if (response.status === 404) {
              console.error('‚ùå APIÊé•Âè£‰∏çÂ≠òÂú®ÔºÅËØ∑Ê£ÄÊü•ÂêéÁ´ØÊúçÂä°ÔºÅ');
            }
          }
        } catch (error) {
          console.error('‚ùå Backend AI APIË∞ÉÁî®ÂºÇÂ∏∏:', error);
          console.error('‚ùå ÈîôËØØÁ±ªÂûã:', error.name);
          console.error('‚ùå ÈîôËØØÊ∂àÊÅØ:', error.message);
          
          if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            console.error('‚ùå ÁΩëÁªúÈîôËØØÔºöÊó†Ê≥ïËøûÊé•Âà∞ÂêéÁ´ØÊúçÂä°ÔºÅ');
            console.error('üí° ËØ∑Á°ÆËÆ§Ôºö1) ÂêéÁ´ØÊúçÂä°Â∑≤ÂêØÂä® 2) ÊúçÂä°Âú∞ÂùÄÊ≠£Á°Æ 3) ÁΩëÁªúËøûÊé•Ê≠£Â∏∏');
          }
        }
        
        return null;
      }
      
      async function chat(question) {
        console.log('üí¨ Êî∂Âà∞Áî®Êà∑ÈóÆÈ¢ò:', question);
        
        // Ëé∑ÂèñÂØπËØùÂéÜÂè≤
        const history = messages.map(msg => ({
          type: msg.type,
          text: msg.text,
          time: msg.time
        }));
        
        // Ëé∑Âèñ‰∏ä‰∏ãÊñáÊï∞ÊçÆÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâ
        const context = {};
        
        // ‰ºòÂÖàÁ∫ß1ÔºöÂ∞ùËØï‰ΩøÁî®ÂêéÁ´ØAI APIÔºàÂøÖÈ°ª‰ºòÂÖà‰ΩøÁî®AIÔºâ
        try {
          console.log('üîÑ Ê≠£Âú®Ë∞ÉÁî®ÂêéÁ´ØAI API...');
          const apiResponse = await chatWithBackendAPI(question, history, context);
          
          if (apiResponse && apiResponse.text && apiResponse.text.length > 10) {
            console.log('‚úÖ AI APIË∞ÉÁî®ÊàêÂäüÔºåËøîÂõûÊô∫ËÉΩAIÂõûÂ§ç');
            return apiResponse;
          } else {
            console.warn('‚ö†Ô∏è AI APIËøîÂõûÁöÑÂõûÂ§ç‰∏∫Á©∫ÊàñÂ§™Áü≠');
            console.warn('‚ö†Ô∏è ÂõûÂ§çÂÜÖÂÆπ:', apiResponse?.text || '(Á©∫)');
            console.warn('‚ö†Ô∏è ÁªßÁª≠Â∞ùËØïÂÖ∂‰ªñÊñπÂºè...');
          }
        } catch (error) {
          console.error('‚ùå ÂêéÁ´ØAI APIË∞ÉÁî®Â§±Ë¥•:', error);
          console.error('‚ùå ÈîôËØØÂ†ÜÊ†à:', error.stack);
        }
        
        // Â¶ÇÊûúAI APIÂ§±Ë¥•ÔºåÊòæÁ§∫ÊòéÁ°ÆÁöÑÈîôËØØÊèêÁ§∫
        const token = getAuthToken();
        if (!token) {
          return { 
            text: '‚ùå Êó†Ê≥ï‰ΩøÁî®AIÂäüËÉΩÔºöÊÇ®Â∞öÊú™ÁôªÂΩï„ÄÇ\n\nËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªüÔºåÁÑ∂ÂêéÊâçËÉΩ‰ΩøÁî®AIÂä©ÊâãÂäüËÉΩ„ÄÇ\n\nÁôªÂΩïÂêéÔºåAIÂä©ÊâãÂ∞Ü‰∏∫ÊÇ®Êèê‰æõÊô∫ËÉΩÂõûÂ§ç„ÄÇ' 
          };
        }
        
        // Ê£ÄÊü•ÂêéÁ´ØÊúçÂä°ÊòØÂê¶ÂèØËææ
        try {
          const healthCheck = await fetch(`${getApiUrl()}/health`).catch(() => null);
          if (!healthCheck || !healthCheck.ok) {
            return { 
              text: '‚ùå Êó†Ê≥ïËøûÊé•Âà∞ÂêéÁ´ØÊúçÂä°„ÄÇ\n\nËØ∑Á°ÆËÆ§Ôºö\n1. ÂêéÁ´ØÊúçÂä°Â∑≤ÂêØÂä®ÔºàËøêË°å npm startÔºâ\n2. ÊúçÂä°Âú∞ÂùÄÊ≠£Á°ÆÔºàhttp://localhost:3000Ôºâ\n3. ÁΩëÁªúËøûÊé•Ê≠£Â∏∏\n\nËøûÊé•ÊàêÂäüÂêéÔºåAIÂä©ÊâãÂ∞ÜÊ≠£Â∏∏Â∑•‰Ωú„ÄÇ' 
            };
          }
        } catch (e) {
          return { 
            text: '‚ùå ÂêéÁ´ØÊúçÂä°ËøûÊé•Â§±Ë¥•„ÄÇ\n\nËØ∑Ê£ÄÊü•Ôºö\n1. ÂêéÁ´ØÊúçÂä°ÊòØÂê¶Â∑≤ÂêØÂä®\n2. ÊúçÂä°Âú∞ÂùÄÊòØÂê¶Ê≠£Á°Æ\n3. Èò≤ÁÅ´Â¢ôËÆæÁΩÆ\n\n‰øÆÂ§çÂêéÔºåAIÂä©ÊâãÂ∞ÜËá™Âä®ÊÅ¢Â§ç„ÄÇ' 
          };
        }
        
        // Â¶ÇÊûúÂêéÁ´ØÊúçÂä°Ê≠£Â∏∏‰ΩÜAIË∞ÉÁî®Â§±Ë¥•ÔºåÊòæÁ§∫ÊèêÁ§∫
        return { 
          text: `‚ö†Ô∏è AIÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®„ÄÇ\n\nÈóÆÈ¢òÔºö"${question}"\n\nÂèØËÉΩÁöÑÂéüÂõ†Ôºö\n1. AI APIÈÖçÁΩÆÈóÆÈ¢ò\n2. API KeyÊó†ÊïàÊàñËøáÊúü\n3. ÁΩëÁªúËøûÊé•ÈóÆÈ¢ò\n\nËØ∑Ê£ÄÊü•Ôºö\n‚Ä¢ ÊµèËßàÂô®ÊéßÂà∂Âè∞ÁöÑÈîôËØØ‰ø°ÊÅØ\n‚Ä¢ ÂêéÁ´ØÊó•ÂøóÊñá‰ª∂\n‚Ä¢ API KeyÈÖçÁΩÆ\n\n‰øÆÂ§çÂêéÔºåAIÂä©ÊâãÂ∞ÜËá™Âä®ÊÅ¢Â§çÊô∫ËÉΩÂõûÂ§çÂäüËÉΩ„ÄÇ` 
        };
      }
      
      function addMessage(type, text) {
        const message = { type, text, time: new Date() };
        messages.push(message);
        renderMessages();
      }
      
      function renderMessages() {
        if (!messagesContainer) return;
        
        messagesContainer.innerHTML = messages.map(msg => {
          const timeStr = formatTime(msg.time);
          if (msg.type === 'user') {
            return `
              <div class="evo-message user">
                <div class="evo-message-avatar">üë§</div>
                <div class="evo-message-content">
                  <div class="evo-message-text">${formatMessage(msg.text)}</div>
                  <div class="evo-message-time">${timeStr}</div>
                </div>
              </div>
            `;
          } else {
            return `
              <div class="evo-message evo">
                <div class="evo-message-avatar">üïäÔ∏è</div>
                <div class="evo-message-content">
                  <div class="evo-message-text">${formatMessage(msg.text)}</div>
                  <div class="evo-message-time">${timeStr}</div>
                </div>
              </div>
            `;
          }
        }).join('');
        
        if (isTyping) {
          messagesContainer.innerHTML += `
            <div class="evo-message evo">
              <div class="evo-message-avatar">üïäÔ∏è</div>
              <div class="evo-message-content">
                <div class="evo-typing-indicator">
                  <span></span><span></span><span></span>
                </div>
              </div>
            </div>
          `;
        }
        
        scrollToBottom();
      }
      
      function formatMessage(text) {
        return text.replace(/\n/g, '<br>');
      }
      
      function formatTime(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        if (minutes < 1) return 'ÂàöÂàö';
        if (minutes < 60) return `${minutes}ÂàÜÈíüÂâç`;
        return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      }
      
      function scrollToBottom() {
        if (messagesContainer) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }
      
      function updateStatus(status) {
        const statusEl = document.getElementById('evoStatus');
        if (statusEl) {
          statusEl.textContent = status;
        }
      }
      
      function saveHistory() {
        try {
          localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(messages));
        } catch (error) {
          console.error('Failed to save chat history:', error);
        }
      }
      
      function loadHistory() {
        try {
          const history = localStorage.getItem(CHAT_HISTORY_KEY);
          if (history) {
            messages = JSON.parse(history).map(msg => ({
              ...msg,
              time: new Date(msg.time)
            }));
            renderMessages();
          }
        } catch (error) {
          console.error('Failed to load chat history:', error);
        }
      }
      
      // Ëé∑ÂèñÊú™‰ΩøÁî®ÁöÑÊ¨¢ËøéÊ∂àÊÅØÂêéÁºÄ
      function getUnusedGreetingSuffix() {
        try {
          const used = JSON.parse(localStorage.getItem(USED_GREETINGS_KEY) || '[]');
          const available = GREETING_SUFFIXES.filter(suffix => !used.includes(suffix));
          
          if (available.length === 0) {
            localStorage.setItem(USED_GREETINGS_KEY, '[]');
            return GREETING_SUFFIXES[Math.floor(Math.random() * GREETING_SUFFIXES.length)];
          }
          
          const selected = available[Math.floor(Math.random() * available.length)];
          used.push(selected);
          localStorage.setItem(USED_GREETINGS_KEY, JSON.stringify(used));
          
          return selected;
        } catch (error) {
          console.error('Ëé∑ÂèñÊ¨¢ËøéÊ∂àÊÅØÂ§±Ë¥•:', error);
          return GREETING_SUFFIXES[0];
        }
      }
      
      // ÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØÊ∞îÊ≥°ÂºπÁ™ó
      function showWelcomeGreeting() {
        const existingBubble = document.getElementById('evoWelcomeBubble');
        if (existingBubble) {
          return;
        }
        
        hasShownGreetingThisPageLoad = true;
        
        try {
          if (!document.body) {
            setTimeout(showWelcomeGreeting, 500);
            return;
          }
          
          const suffix = getUnusedGreetingSuffix();
          const greeting = `‰Ω†Â•ΩÔºåÊàëÊòØEvoÔºåÊàëÂèØ‰ª•Â∏Æ‰Ω†${suffix}„ÄÇ`;
          
          const bubble = document.createElement('div');
          bubble.id = 'evoWelcomeBubble';
          bubble.className = 'evo-welcome-bubble';
          
          bubble.style.position = 'fixed';
          bubble.style.bottom = '160px';
          bubble.style.right = '100px';
          bubble.style.zIndex = '99998';
          bubble.style.maxWidth = '280px';
          bubble.style.pointerEvents = 'auto';
          bubble.style.display = 'block';
          bubble.style.visibility = 'visible';
          bubble.style.opacity = '1';
          
          const bubbleContent = document.createElement('div');
          bubbleContent.className = 'evo-welcome-bubble-content';
          bubbleContent.textContent = greeting;
          
          bubbleContent.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          bubbleContent.style.color = '#fff';
          bubbleContent.style.padding = '12px 16px';
          bubbleContent.style.borderRadius = '8px';
          bubbleContent.style.fontSize = '14px';
          bubbleContent.style.lineHeight = '1.5';
          bubbleContent.style.boxShadow = '0 4px 20px rgba(102, 126, 234, 0.4), 0 0 30px rgba(118, 75, 162, 0.3)';
          bubbleContent.style.position = 'relative';
          bubbleContent.style.wordWrap = 'break-word';
          bubbleContent.style.cursor = 'pointer';
          bubbleContent.style.fontWeight = '500';
          
          bubbleContent.addEventListener('click', () => {
            hideWelcomeBubble();
            if (!dialog) {
              dialog = document.getElementById('evoDialog');
            }
            if (dialog) {
              isExpanded = true;
              dialog.style.display = 'flex';
              activeTab = 'chat';
              switchTab('chat');
              
              if (!messagesContainer) {
                messagesContainer = document.getElementById('evoMessages');
              }
              if (messagesContainer) {
                messages = [];
                messagesContainer.innerHTML = '';
                addMessage('evo', greeting);
                saveHistory();
                setTimeout(() => scrollToBottom(), 100);
              }
            }
          });
          
          bubble.appendChild(bubbleContent);
          document.body.appendChild(bubble);
          
          setTimeout(() => {
            const checkBubble = document.getElementById('evoWelcomeBubble');
            if (checkBubble) {
              const rect = checkBubble.getBoundingClientRect();
              const checkComputedStyle = window.getComputedStyle(checkBubble);
              if (rect.width === 0 || rect.height === 0 || checkComputedStyle.display === 'none' || checkComputedStyle.visibility === 'hidden') {
                checkBubble.style.cssText = `
                  position: fixed !important;
                  bottom: 160px !important;
                  right: 100px !important;
                  z-index: 99998 !important;
                  max-width: 280px !important;
                  display: block !important;
                  visibility: visible !important;
                  opacity: 1 !important;
                `;
              }
            }
          }, 100);
          
          setTimeout(() => {
            hideWelcomeBubble();
          }, 3000);
          
        } catch (error) {
          console.error('ÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØÂ§±Ë¥•:', error);
        }
      }
      
      // ÈöêËóèÊ¨¢ËøéÊ∂àÊÅØÊ∞îÊ≥°
      function hideWelcomeBubble() {
        const bubble = document.getElementById('evoWelcomeBubble');
        if (bubble) {
          bubble.classList.add('hiding');
          setTimeout(() => {
            if (bubble.parentNode) {
              bubble.remove();
            }
          }, 300);
        }
      }
      
      return {
        init,
        ensureIconVisible
      };
    })();
    
    // ÂàùÂßãÂåñEvoÂä©ÊâãÔºàÂú®ÁôªÂΩïÂêéÔºâ
    function initEvoAssistant() {
      setTimeout(() => {
        try {
          EvoAssistant.init();
          console.log('‚úÖ Evo Êô∫ËÉΩÂä©ÊâãÂ∑≤ÂàùÂßãÂåñ');
          
          setTimeout(() => {
            EvoAssistant.ensureIconVisible();
          }, 500);
        } catch (error) {
          console.error('‚ö†Ô∏è Êô∫ËÉΩÂä©ÊâãÂàùÂßãÂåñÂ§±Ë¥•:', error);
        }
      }, 500);
    }
    
    // ========================================
    // Êô∫È∏Ω¬∑‰∏≠Êû¢ÁÆ°ÂÆ∂ÂäüËÉΩ
    // ========================================
    
    const CORE_ADMIN_API_BASE = 'http://localhost:3001/api';
    
    // Âä†ËΩΩ‰∏≠Êû¢ÁÆ°ÂÆ∂Êï∞ÊçÆ
    async function loadCoreAdminData() {
      try {
        // Âπ∂Ë°åÂä†ËΩΩÊâÄÊúâÊï∞ÊçÆÔºåÂç≥‰ΩøÈÉ®ÂàÜÂ§±Ë¥•‰πüËÉΩÊòæÁ§∫ÂÖ∂‰ªñÂÜÖÂÆπ
        await Promise.allSettled([
          loadCoreAdminStatus(),
          loadCoreAdminModelInfo(),
          loadCoreAdminAdvice(),
          loadCoreAdminAnalytics(),
          loadCoreAdminApis(),
          loadCoreAdminLearning(),
          loadCoreAdminMaintenance()
        ]);
      } catch (error) {
        console.error('Âä†ËΩΩ‰∏≠Êû¢ÁÆ°ÂÆ∂Êï∞ÊçÆÂ§±Ë¥•:', error);
      }
    }
    
    // Âä†ËΩΩÁ≥ªÁªüÁä∂ÊÄÅ
    async function loadCoreAdminStatus() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/status`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const result = await response.json();
        
        if (result.success && result.data) {
          const status = result.data;
          const healthScore = (status.metrics?.systemHealth || 0) * 100;
          
          document.getElementById('coreAdminHealthScore').textContent = healthScore.toFixed(0) + '%';
          document.getElementById('coreAdminHealthStatus').textContent = 
            status.metrics?.riskLevel === 'low' ? '‚úÖ ËøêË°åÊ≠£Â∏∏' :
            status.metrics?.riskLevel === 'medium' ? '‚ö†Ô∏è ÈúÄË¶ÅÊ≥®ÊÑè' :
            status.metrics?.riskLevel === 'high' ? 'üî¥ È£éÈô©ËæÉÈ´ò' : 'Ê£ÄÊü•‰∏≠...';
        } else {
          throw new Error('Êï∞ÊçÆÊ†ºÂºèÈîôËØØ');
        }
      } catch (error) {
        console.error('Âä†ËΩΩÁ≥ªÁªüÁä∂ÊÄÅÂ§±Ë¥•:', error);
        document.getElementById('coreAdminHealthScore').textContent = '--';
        document.getElementById('coreAdminHealthStatus').textContent = '‚ö†Ô∏è ÊúçÂä°Êú™ËøêË°å';
        document.getElementById('coreAdminHealthStatus').style.color = '#f59e0b';
      }
    }
    
    // Âä†ËΩΩÊ®°ÂûãÊé•ÂÖ•‰ø°ÊÅØ
    async function loadCoreAdminModelInfo() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/model/config`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const result = await response.json();
        
        if (result.success && result.data) {
          const modelInfo = result.data;
          
          // Êõ¥Êñ∞Âü∫Êú¨‰ø°ÊÅØ
          document.getElementById('coreAdminModelProvider').textContent = modelInfo.provider || 'Êú™Áü•';
          document.getElementById('coreAdminModelName').textContent = modelInfo.model || 'Êú™Áü•';
          document.getElementById('coreAdminApiKeyPreview').textContent = modelInfo.apiKeyPreview || '--';
          document.getElementById('coreAdminApiBase').textContent = modelInfo.apiBase || '--';
          document.getElementById('coreAdminMaxCalls').textContent = modelInfo.maxCallsPerHour || '--';
          document.getElementById('coreAdminConfidence').textContent = (modelInfo.confidenceThreshold * 100).toFixed(0) + '%' || '--';
          
          // Êõ¥Êñ∞API KeyÁä∂ÊÄÅ
          const apiKeyStatusEl = document.getElementById('coreAdminApiKeyStatus');
          if (modelInfo.apiKeyStatus === 'configured') {
            apiKeyStatusEl.textContent = '‚úÖ Â∑≤ÈÖçÁΩÆ';
            apiKeyStatusEl.style.background = 'rgba(76, 175, 80, 0.3)';
            apiKeyStatusEl.style.color = '#2e7d32';
          } else {
            apiKeyStatusEl.textContent = '‚ùå Êú™ÈÖçÁΩÆ';
            apiKeyStatusEl.style.background = 'rgba(244, 67, 54, 0.3)';
            apiKeyStatusEl.style.color = '#c62828';
          }
          
          // Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅ
          const connectionStatusEl = document.getElementById('coreAdminConnectionStatus');
          if (modelInfo.connectionStatus === 'connected' && modelInfo.enabled) {
            connectionStatusEl.textContent = '‚úÖ Â∑≤ËøûÊé•';
            connectionStatusEl.style.background = 'rgba(76, 175, 80, 0.3)';
            connectionStatusEl.style.color = '#2e7d32';
          } else {
            connectionStatusEl.textContent = '‚ùå Êú™ËøûÊé•';
            connectionStatusEl.style.background = 'rgba(244, 67, 54, 0.3)';
            connectionStatusEl.style.color = '#c62828';
          }
          
          // Êõ¥Êñ∞Ë∞ÉÁî®ÁªüËÆ°
          if (modelInfo.stats) {
            const stats = modelInfo.stats;
            document.getElementById('coreAdminTotalCalls').textContent = stats.totalCalls || 0;
            document.getElementById('coreAdminRecentCalls').textContent = stats.recentCalls || 0;
            document.getElementById('coreAdminSuccessRate').textContent = (stats.successRate * 100).toFixed(1) + '%';
            document.getElementById('coreAdminAvgConfidence').textContent = (stats.avgConfidence * 100).toFixed(1) + '%';
          }
          
          // Êõ¥Êñ∞AIË∞ÉÁî®Ê¨°Êï∞ÔºàÂú®È°∂ÈÉ®Âç°Áâá‰∏≠Ôºâ
          if (modelInfo.stats) {
            document.getElementById('coreAdminAICalls').textContent = modelInfo.stats.recentCalls || 0;
          }
        } else {
          throw new Error('Êï∞ÊçÆÊ†ºÂºèÈîôËØØ');
        }
      } catch (error) {
        console.error('Âä†ËΩΩÊ®°ÂûãÊé•ÂÖ•‰ø°ÊÅØÂ§±Ë¥•:', error);
        const container = document.getElementById('coreAdminModelInfo');
        container.innerHTML = `
          <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:1px solid #f59e0b;">
            <p style="margin:0 0 12px 0;color:#92400e;font-weight:600;">‚ö†Ô∏è ‰∏≠Êû¢ÁÆ°ÂÆ∂ÊúçÂä°Êú™ËøêË°å</p>
            <p style="margin:0;color:#78350f;font-size:14px;">ËØ∑ÂêØÂä®ÂêéÁ´ØÊúçÂä°Ôºö<code style="background:#fde68a;padding:2px 6px;border-radius:4px;">cd backend/core-admin && npm start</code></p>
          </div>
        `;
      }
    }
    
    // Âä†ËΩΩÁÆ°ÁêÜÂª∫ËÆÆ
    async function loadCoreAdminAdvice() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/advice`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const result = await response.json();
        
        if (result.success && result.data) {
          const advice = result.data.advice || {};
          const container = document.getElementById('coreAdminAdvice');
          
          let html = '';
          if (advice.summary) {
            html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;margin-bottom:12px;">`;
            html += `<div style="font-weight:600;margin-bottom:8px;color:#1f2937;">${advice.summary}</div>`;
            if (advice.actions && advice.actions.length > 0) {
              html += `<ul style="margin:8px 0;padding-left:20px;">`;
              advice.actions.forEach(action => {
                html += `<li style="margin:4px 0;color:#4b5563;">${action}</li>`;
              });
              html += `</ul>`;
            }
            html += `</div>`;
          } else {
            html = '<p class="muted" style="text-align:center;">ÊöÇÊó†Âª∫ËÆÆ</p>';
          }
          
          container.innerHTML = html;
        } else {
          throw new Error('Êï∞ÊçÆÊ†ºÂºèÈîôËØØ');
        }
      } catch (error) {
        console.error('Âä†ËΩΩÁÆ°ÁêÜÂª∫ËÆÆÂ§±Ë¥•:', error);
        const container = document.getElementById('coreAdminAdvice');
        container.innerHTML = `
          <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:1px solid #f59e0b;">
            <p style="margin:0 0 12px 0;color:#92400e;font-weight:600;">‚ö†Ô∏è ‰∏≠Êû¢ÁÆ°ÂÆ∂ÊúçÂä°Êú™ËøêË°å</p>
            <p style="margin:0;color:#78350f;font-size:14px;">ËØ∑ÂêØÂä®ÂêéÁ´ØÊúçÂä°Ôºö<code style="background:#fde68a;padding:2px 6px;border-radius:4px;">cd backend/core-admin && npm start</code></p>
          </div>
        `;
      }
    }
    
    // Âä†ËΩΩÊï∞ÊçÆÂàÜÊûê
    async function loadCoreAdminAnalytics() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/analytics/report`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const report = result.data;
          const container = document.getElementById('coreAdminAnalytics');
          
          let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:20px;">';
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÊÄªÁÇπÂáªÈáè</div>`;
          html += `<div style="font-size:24px;font-weight:600;color:#1f2937;">${report.clicks?.total || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Êï∞ÊçÆ‰∏ä‰º†</div>`;
          html += `<div style="font-size:24px;font-weight:600;color:#1f2937;">${report.uploads?.total || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Áî®Êà∑Ë°å‰∏∫</div>`;
          html += `<div style="font-size:24px;font-weight:600;color:#1f2937;">${report.userBehaviors?.total || 0}</div>`;
          html += `</div>`;
          
          html += `</div>`;
          
          if (report.apiUsage?.topEndpoints && report.apiUsage.topEndpoints.length > 0) {
            html += `<div style="margin-top:20px;"><h4 style="margin-bottom:12px;">ÁÉ≠Èó®API</h4>`;
            html += `<table style="width:100%;border-collapse:collapse;">`;
            html += `<thead><tr style="background:#f9fafb;"><th style="padding:8px;text-align:left;">Á´ØÁÇπ</th><th style="padding:8px;text-align:center;">Ë∞ÉÁî®Ê¨°Êï∞</th><th style="padding:8px;text-align:center;">ÊàêÂäüÁéá</th></tr></thead><tbody>`;
            report.apiUsage.topEndpoints.slice(0, 5).forEach(api => {
              html += `<tr><td style="padding:8px;">${api.endpoint}</td>`;
              html += `<td style="padding:8px;text-align:center;">${api.calls}</td>`;
              html += `<td style="padding:8px;text-align:center;">${(api.successRate * 100).toFixed(1)}%</td></tr>`;
            });
            html += `</tbody></table></div>`;
          }
          
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('Âä†ËΩΩÊï∞ÊçÆÂàÜÊûêÂ§±Ë¥•:', error);
        const container = document.getElementById('coreAdminAnalytics');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">Êï∞ÊçÆÂàÜÊûêÊúçÂä°ÊöÇ‰∏çÂèØÁî®</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">ËØ∑Á°Æ‰øùÂêéÁ´ØÊúçÂä°Ê≠£Âú®ËøêË°å</p>
          </div>
        `;
      }
    }
    
    // Âä†ËΩΩAPIÂàóË°®
    async function loadCoreAdminApis() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/apis`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const apis = result.data;
          const container = document.getElementById('coreAdminApiList');
          
          if (apis.length === 0) {
            container.innerHTML = '<p class="muted" style="text-align:center;">ÊöÇÊó†API</p>';
            return;
          }
          
          let html = '<table style="width:100%;border-collapse:collapse;">';
          html += '<thead><tr style="background:#f9fafb;">';
          html += '<th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">APIÂêçÁß∞</th>';
          html += '<th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Áä∂ÊÄÅ</th>';
          html += '<th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂìçÂ∫îÊó∂Èó¥</th>';
          html += '<th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Êï∞ÊçÆÁúüÂÆûÊÄß</th>';
          html += '</tr></thead><tbody>';
          
          apis.forEach(api => {
            const statusColor = api.health.status === 'healthy' ? '#10b981' : '#ef4444';
            const statusText = api.health.status === 'healthy' ? '‚úÖ Ê≠£Â∏∏' : '‚ùå ÂºÇÂ∏∏';
            const truthStatus = api.health.truthStatus || 'unknown';
            const truthColor = truthStatus === 'verified' ? '#10b981' : truthStatus === 'suspect' ? '#f59e0b' : '#ef4444';
            const truthText = truthStatus === 'verified' ? '‚úÖ Â∑≤È™åËØÅ' : truthStatus === 'suspect' ? '‚ö†Ô∏è ÂèØÁñë' : '‚ùå Êó†Êïà';
            
            html += `<tr style="border-bottom:1px solid #f0f0f0;">`;
            html += `<td style="padding:12px;"><strong>${api.name}</strong><br><span style="color:#6b7280;font-size:12px;">${api.url}</span></td>`;
            html += `<td style="padding:12px;text-align:center;"><span style="color:${statusColor};font-weight:600;">${statusText}</span></td>`;
            html += `<td style="padding:12px;text-align:center;">${api.stats.avgResponseTime.toFixed(0)}ms</td>`;
            html += `<td style="padding:12px;text-align:center;"><span style="color:${truthColor};font-weight:600;">${truthText}</span></td>`;
            html += `</tr>`;
          });
          
          html += '</tbody></table>';
          container.innerHTML = html;
          
          // Êõ¥Êñ∞APIÂÅ•Â∫∑Áéá
          const healthyCount = apis.filter(a => a.health.status === 'healthy').length;
          const healthRate = apis.length > 0 ? (healthyCount / apis.length * 100) : 0;
          document.getElementById('coreAdminApiHealth').textContent = healthRate.toFixed(0) + '%';
        }
      } catch (error) {
        console.error('Âä†ËΩΩAPIÂàóË°®Â§±Ë¥•:', error);
        const container = document.getElementById('coreAdminApiList');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">APIÁõëÁÆ°ÊúçÂä°ÊöÇ‰∏çÂèØÁî®</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">ËØ∑Á°Æ‰øùÂêéÁ´ØÊúçÂä°Ê≠£Âú®ËøêË°å</p>
          </div>
        `;
      }
    }
    
    // Âä†ËΩΩÂ≠¶‰π†Á≥ªÁªü
    async function loadCoreAdminLearning() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/learning/stats`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const stats = result.data;
          const container = document.getElementById('coreAdminLearning');
          
          let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">';
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÊÄª‰∫ã‰ª∂Êï∞</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalEvents || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Á≠ñÁï•Êï∞</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalStrategies || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÂÜ≥Á≠ñÊï∞</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalDecisions || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Âπ≥ÂùáÊúâÊïàÊÄß</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${((stats.avgEffectiveness || 0) * 100).toFixed(1)}%</div>`;
          html += `</div>`;
          
          html += `</div>`;
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('Âä†ËΩΩÂ≠¶‰π†Á≥ªÁªüÂ§±Ë¥•:', error);
        const container = document.getElementById('coreAdminLearning');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">Â≠¶‰π†Á≥ªÁªüÊúçÂä°ÊöÇ‰∏çÂèØÁî®</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">ËØ∑Á°Æ‰øùÂêéÁ´ØÊúçÂä°Ê≠£Âú®ËøêË°å</p>
          </div>
        `;
      }
    }
    
    // Âä†ËΩΩËá™Âä®Áª¥Êä§
    async function loadCoreAdminMaintenance() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/maintenance/stats`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const stats = result.data;
          const container = document.getElementById('coreAdminMaintenance');
          
          let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">';
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÊÄªBugÊï∞</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalBugs || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Â∑≤‰øÆÂ§ç</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.fixedBugs || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÊÄª‰øÆÂ§çÊï∞</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalFixes || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Á≥ªÁªüÂçáÁ∫ß</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalUpgrades || 0}</div>`;
          html += `</div>`;
          
          html += `</div>`;
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('Âä†ËΩΩËá™Âä®Áª¥Êä§Â§±Ë¥•:', error);
        const container = document.getElementById('coreAdminMaintenance');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">Ëá™Âä®Áª¥Êä§ÊúçÂä°ÊöÇ‰∏çÂèØÁî®</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">ËØ∑Á°Æ‰øùÂêéÁ´ØÊúçÂä°Ê≠£Âú®ËøêË°å</p>
          </div>
        `;
      }
    }
    
    // ÁªëÂÆöÂà∑Êñ∞ÊåâÈíÆ
    // ==========================================
    // Á≥ªÁªüËÆæÁΩÆÂäüËÉΩ
    // ==========================================
    
    let currentRssSourceEditId = null;
    
    // Âä†ËΩΩÁ≥ªÁªüËÆæÁΩÆ
    async function loadSystemSettings() {
      try {
        const token = localStorage.getItem('adminToken');
        if (!token) {
          showSettingsStatus('ËØ∑ÂÖàÁôªÂΩï', 'error');
          return;
        }
        
        const response = await fetch(`${getApiUrl()}/api/admin/system-settings`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const settings = result.data;
          
          // Â°´ÂÖÖÂü∫Á°ÄËÆæÁΩÆ
          document.getElementById('serverPort').value = settings.server?.port || '';
          document.getElementById('serverEnv').value = settings.server?.env || 'production';
          document.getElementById('apiRateLimit').value = settings.api?.rateLimit || '';
          document.getElementById('logLevel').value = settings.logging?.level || 'info';
          
          // Â°´ÂÖÖÁºìÂ≠òËÆæÁΩÆ
          document.getElementById('cacheTtlNews').value = settings.cache?.ttl?.news || '';
          document.getElementById('cacheTtlEvents').value = settings.cache?.ttl?.events || '';
          document.getElementById('cacheTtlResults').value = settings.cache?.ttl?.results || '';
          document.getElementById('updateIntervalNews').value = settings.updateInterval?.news || '';
          document.getElementById('updateIntervalEvents').value = settings.updateInterval?.events || '';
          document.getElementById('updateIntervalResults').value = settings.updateInterval?.results || '';
          
          // Â°´ÂÖÖAIËÆæÁΩÆ
          document.getElementById('zhipuApiKeyEvo').value = settings.ai?.zhipuApiKeyEvo || '';
          document.getElementById('zhipuApiKeyAdmin').value = settings.ai?.zhipuApiKeyAdmin || '';
          document.getElementById('qwenApiKey').value = settings.ai?.qwenApiKey || '';
          document.getElementById('huggingFaceApiKey').value = settings.ai?.huggingFaceApiKey || '';
          document.getElementById('aiModel').value = settings.ai?.model || 'auto';
          
          // Â°´ÂÖÖÊï∞ÊçÆÂ∫ìËÆæÁΩÆ
          document.getElementById('supabaseUrl').value = settings.supabase?.url || '';
          document.getElementById('supabaseAnonKey').value = settings.supabase?.anonKey || '';
          
          // Âä†ËΩΩRSSÊ∫êÂàóË°®
          loadRssSources();
        }
      } catch (error) {
        console.error('Âä†ËΩΩÁ≥ªÁªüËÆæÁΩÆÂ§±Ë¥•:', error);
        showSettingsStatus('Âä†ËΩΩÁ≥ªÁªüËÆæÁΩÆÂ§±Ë¥•: ' + error.message, 'error');
      }
    }
    
    // Âä†ËΩΩRSSÊ∫êÂàóË°®
    async function loadRssSources() {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const sources = result.data;
          const container = document.getElementById('rssSourcesList');
          
          if (sources.length === 0) {
            container.innerHTML = '<p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†RSSÊ∫êÔºåÁÇπÂáª"Ê∑ªÂä†RSSÊ∫ê"ÊåâÈíÆÊ∑ªÂä†</p>';
            return;
          }
          
          let html = '';
          sources.forEach(source => {
            const statusColor = source.active !== false ? '#10b981' : '#ef4444';
            const statusText = source.active !== false ? 'ÂêØÁî®' : 'Á¶ÅÁî®';
            
            html += `
              <div style="padding:16px;background:var(--bg-secondary);border:1px solid var(--border-light);border-radius:var(--radius-md);">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
                  <div style="flex:1;">
                    <div style="font-weight:600;color:var(--text-primary);margin-bottom:4px;">${source.name}</div>
                    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">${source.url}</div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                      <span style="padding:4px 8px;background:var(--primary-50);color:var(--primary);border-radius:4px;font-size:12px;">${source.type === 'media' ? 'Â™í‰Ωì' : 'Âçè‰ºö'}</span>
                      <span style="padding:4px 8px;background:var(--gray-100);color:var(--gray-700);border-radius:4px;font-size:12px;">${source.region === 'local' ? 'Êú¨Âú∞' : 'ÂÖ®ÂõΩ'}</span>
                      <span style="padding:4px 8px;background:${statusColor}20;color:${statusColor};border-radius:4px;font-size:12px;">${statusText}</span>
                    </div>
                  </div>
                  <div style="display:flex;gap:8px;">
                    <button class="btn btn-sm btn-outline" onclick="editRssSource('${source.id}')">ÁºñËæë</button>
                    <button class="btn btn-sm btn-outline" onclick="toggleRssSource('${source.id}', ${source.active !== false})">${source.active !== false ? 'Á¶ÅÁî®' : 'ÂêØÁî®'}</button>
                    <button class="btn btn-sm btn-outline" style="color:var(--danger);" onclick="deleteRssSource('${source.id}')">Âà†Èô§</button>
                  </div>
                </div>
              </div>
            `;
          });
          
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('Âä†ËΩΩRSSÊ∫êÂàóË°®Â§±Ë¥•:', error);
      }
    }
    
    // Á≥ªÁªüËÆæÁΩÆÊ†áÁ≠æÈ°µÂàáÊç¢
    document.querySelectorAll('.settings-tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        
        // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
        document.querySelectorAll('.settings-tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // ÊòæÁ§∫ÂØπÂ∫îÈù¢Êùø
        document.querySelectorAll('.settings-panel').forEach(p => p.style.display = 'none');
        document.getElementById(`settings${tab.charAt(0).toUpperCase() + tab.slice(1)}`).style.display = 'block';
      });
    });
    
    // ‰øùÂ≠òÂü∫Á°ÄËÆæÁΩÆ
    document.getElementById('btnSaveGeneralSettings')?.addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('adminToken');
        const settings = {
          custom: {
            server: {
              port: parseInt(document.getElementById('serverPort').value) || 3000,
              env: document.getElementById('serverEnv').value
            },
            api: {
              rateLimit: parseInt(document.getElementById('apiRateLimit').value) || 100
            },
            logging: {
              level: document.getElementById('logLevel').value
            }
          }
        };
        
        const response = await fetch(`${getApiUrl()}/api/admin/system-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ settings })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('Âü∫Á°ÄËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºàÈÉ®ÂàÜÈÖçÁΩÆÈúÄË¶Å‰øÆÊîπÁéØÂ¢ÉÂèòÈáèÂêéÈáçÂêØÊúçÂä°ÊâçËÉΩÁîüÊïàÔºâ', 'success');
        } else {
          showSettingsStatus('‰øùÂ≠òÂ§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
      } catch (error) {
        showSettingsStatus('‰øùÂ≠òÂ§±Ë¥•: ' + error.message, 'error');
      }
    });
    
    // ‰øùÂ≠òÁºìÂ≠òËÆæÁΩÆ
    document.getElementById('btnSaveCacheSettings')?.addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('adminToken');
        const settings = {
          custom: {
            cache: {
              ttl: {
                news: parseInt(document.getElementById('cacheTtlNews').value) || 3600,
                events: parseInt(document.getElementById('cacheTtlEvents').value) || 300,
                results: parseInt(document.getElementById('cacheTtlResults').value) || 7200
              }
            },
            updateInterval: {
              news: parseInt(document.getElementById('updateIntervalNews').value) || 3600,
              events: parseInt(document.getElementById('updateIntervalEvents').value) || 300,
              results: parseInt(document.getElementById('updateIntervalResults').value) || 1800
            }
          }
        };
        
        const response = await fetch(`${getApiUrl()}/api/admin/system-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ settings })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('ÁºìÂ≠òÈÖçÁΩÆÂ∑≤‰øùÂ≠òÔºàÈúÄË¶Å‰øÆÊîπÁéØÂ¢ÉÂèòÈáèÂêéÈáçÂêØÊúçÂä°ÊâçËÉΩÁîüÊïàÔºâ', 'success');
        } else {
          showSettingsStatus('‰øùÂ≠òÂ§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
      } catch (error) {
        showSettingsStatus('‰øùÂ≠òÂ§±Ë¥•: ' + error.message, 'error');
      }
    });
    
    // Ê∑ªÂä†RSSÊ∫ê
    document.getElementById('btnAddRssSource')?.addEventListener('click', () => {
      currentRssSourceEditId = null;
      document.getElementById('rssSourceForm').style.display = 'block';
      document.getElementById('rssSourceName').value = '';
      document.getElementById('rssSourceUrl').value = '';
      document.getElementById('rssSourceType').value = 'media';
      document.getElementById('rssSourceRegion').value = 'local';
    });
    
    // ‰øùÂ≠òRSSÊ∫ê
    document.getElementById('btnSaveRssSource')?.addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('adminToken');
        const name = document.getElementById('rssSourceName').value.trim();
        const url = document.getElementById('rssSourceUrl').value.trim();
        const type = document.getElementById('rssSourceType').value;
        const region = document.getElementById('rssSourceRegion').value;
        
        if (!name || !url) {
          showSettingsStatus('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑRSSÊ∫ê‰ø°ÊÅØ', 'error');
          return;
        }
        
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ name, url, type, region })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('RSSÊ∫êÂ∑≤Ê∑ªÂä†', 'success');
          document.getElementById('rssSourceForm').style.display = 'none';
          loadRssSources();
        } else {
          showSettingsStatus('Ê∑ªÂä†Â§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
      } catch (error) {
        showSettingsStatus('Ê∑ªÂä†Â§±Ë¥•: ' + error.message, 'error');
      }
    });
    
    // ÂèñÊ∂àRSSÊ∫êÁºñËæë
    document.getElementById('btnCancelRssSource')?.addEventListener('click', () => {
      document.getElementById('rssSourceForm').style.display = 'none';
      currentRssSourceEditId = null;
    });
    
    // ÊµãËØïRSSÊ∫ê
    document.getElementById('btnTestRssSource')?.addEventListener('click', async () => {
      const url = document.getElementById('rssSourceUrl').value.trim();
      if (!url) {
        showSettingsStatus('ËØ∑ÂÖàËæìÂÖ•RSS URL', 'error');
        return;
      }
      
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources/test`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ url })
        });
        
        const result = await response.json();
        const resultDiv = document.getElementById('rssSourceTestResult');
        
        if (result.success && result.data?.valid) {
          resultDiv.innerHTML = `<div style="padding:12px;background:#d1fae5;color:#047857;border-radius:6px;">‚úÖ ËøûÊé•ÊàêÂäüÔºÅÊâæÂà∞ ${result.data.itemCount} Êù°ÂÜÖÂÆπ</div>`;
        } else {
          resultDiv.innerHTML = `<div style="padding:12px;background:#fee2e2;color:#991b1b;border-radius:6px;">‚ùå ËøûÊé•Â§±Ë¥•: ${result.error || 'Êú™Áü•ÈîôËØØ'}</div>`;
        }
      } catch (error) {
        document.getElementById('rssSourceTestResult').innerHTML = `<div style="padding:12px;background:#fee2e2;color:#991b1b;border-radius:6px;">‚ùå ÊµãËØïÂ§±Ë¥•: ${error.message}</div>`;
      }
    });
    
    // ÁºñËæëRSSÊ∫ê
    window.editRssSource = async (id) => {
      // TODO: ÂÆûÁé∞ÁºñËæëÂäüËÉΩ
      alert('ÁºñËæëÂäüËÉΩÂºÄÂèë‰∏≠...');
    };
    
    // ÂàáÊç¢RSSÊ∫êÁä∂ÊÄÅ
    window.toggleRssSource = async (id, currentStatus) => {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources/${id}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ active: !currentStatus })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('RSSÊ∫êÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞', 'success');
          loadRssSources();
        } else {
          showSettingsStatus('Êõ¥Êñ∞Â§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
      } catch (error) {
        showSettingsStatus('Êõ¥Êñ∞Â§±Ë¥•: ' + error.message, 'error');
      }
    };
    
    // Âà†Èô§RSSÊ∫ê
    window.deleteRssSource = async (id) => {
      if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™RSSÊ∫êÂêóÔºü')) return;
      
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('RSSÊ∫êÂ∑≤Âà†Èô§', 'success');
          loadRssSources();
        } else {
          showSettingsStatus('Âà†Èô§Â§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
      } catch (error) {
        showSettingsStatus('Âà†Èô§Â§±Ë¥•: ' + error.message, 'error');
      }
    };
    
    // ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
    function showSettingsStatus(message, type) {
      const statusDiv = document.getElementById('settingsStatus');
      statusDiv.style.display = 'block';
      statusDiv.style.padding = '12px';
      statusDiv.style.borderRadius = 'var(--radius-md)';
      
      if (type === 'success') {
        statusDiv.style.background = '#d1fae5';
        statusDiv.style.color = '#047857';
      } else {
        statusDiv.style.background = '#fee2e2';
        statusDiv.style.color = '#991b1b';
      }
      
      statusDiv.textContent = message;
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      const btnRefreshModelInfo = document.getElementById('btnRefreshModelInfo');
      const btnRefreshAdvice = document.getElementById('btnRefreshAdvice');
      const btnRefreshAnalytics = document.getElementById('btnRefreshAnalytics');
      const btnRefreshApis = document.getElementById('btnRefreshApis');
      const btnRefreshLearning = document.getElementById('btnRefreshLearning');
      const btnRefreshMaintenance = document.getElementById('btnRefreshMaintenance');
      
      if (btnRefreshModelInfo) {
        btnRefreshModelInfo.addEventListener('click', () => {
          loadCoreAdminModelInfo();
        });
      }
      
      if (btnRefreshAdvice) {
        btnRefreshAdvice.addEventListener('click', () => {
          loadCoreAdminAdvice();
        });
      }
      
      if (btnRefreshAnalytics) {
        btnRefreshAnalytics.addEventListener('click', () => {
          loadCoreAdminAnalytics();
        });
      }
      
      if (btnRefreshApis) {
        btnRefreshApis.addEventListener('click', () => {
          loadCoreAdminApis();
        });
      }
      
      if (btnRefreshLearning) {
        btnRefreshLearning.addEventListener('click', () => {
          loadCoreAdminLearning();
        });
      }
      
      if (btnRefreshMaintenance) {
        btnRefreshMaintenance.addEventListener('click', () => {
          loadCoreAdminMaintenance();
        });
      }
    });
    
    // Á≥ªÁªüÂçáÁ∫ßÂäüËÉΩ
    async function loadUpgradeData() {
      const CORE_ADMIN_API_BASE = 'http://localhost:3001/api';
      
      try {
        // Âä†ËΩΩÂçáÁ∫ßÊ¶ÇËßà
        const overviewResponse = await fetch(`${CORE_ADMIN_API_BASE}/upgrade/overview`);
        if (overviewResponse.ok) {
          const overviewResult = await overviewResponse.json();
          if (overviewResult.success && overviewResult.data) {
            const overview = overviewResult.data;
            document.getElementById('upgradeVersion').textContent = `v${overview.version}`;
            document.getElementById('upgradePartsCount').textContent = overview.completedCount || '--';
            document.getElementById('upgradeNewFiles').textContent = overview.statistics?.newFiles || '--';
            document.getElementById('upgradeNewCode').textContent = (overview.statistics?.newCodeLines / 1000).toFixed(1) + 'K';
            document.getElementById('upgradeAutomation').textContent = overview.capabilities?.automation || '--';
          }
        }

        // Âä†ËΩΩÂçáÁ∫ßÈÉ®ÂàÜ
        const partsResponse = await fetch(`${CORE_ADMIN_API_BASE}/upgrade/parts`);
        if (partsResponse.ok) {
          const partsResult = await partsResponse.json();
          if (partsResult.success && partsResult.data) {
            renderUpgradeParts(partsResult.data);
          }
        }

        // Âä†ËΩΩËÉΩÂäõÊèêÂçá
        const capabilitiesResponse = await fetch(`${CORE_ADMIN_API_BASE}/upgrade/capabilities`);
        if (capabilitiesResponse.ok) {
          const capabilitiesResult = await capabilitiesResponse.json();
          if (capabilitiesResult.success && capabilitiesResult.data) {
            renderCapabilities(capabilitiesResult.data);
          }
        }
      } catch (error) {
        console.error('Âä†ËΩΩÂçáÁ∫ßÊï∞ÊçÆÂ§±Ë¥•:', error);
        document.getElementById('upgradePartsList').innerHTML = `
          <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:1px solid #f59e0b;">
            <p style="margin:0 0 12px 0;color:#92400e;font-weight:600;">‚ö†Ô∏è Êó†Ê≥ïËøûÊé•Âà∞ÂçáÁ∫ßÊúçÂä°</p>
            <p style="margin:0;color:#78350f;font-size:14px;">ËØ∑Á°Æ‰øù‰∏≠Êû¢ÁÆ°ÂÆ∂ÊúçÂä°Ê≠£Âú®ËøêË°å</p>
          </div>
        `;
      }
    }

    // Ê∏≤ÊüìÂçáÁ∫ßÈÉ®ÂàÜ
    function renderUpgradeParts(parts) {
      const container = document.getElementById('upgradePartsList');
      
      if (!parts || parts.length === 0) {
        container.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ÊöÇÊó†ÂçáÁ∫ßËÆ∞ÂΩï</p>';
        return;
      }

      const html = parts.map(part => `
        <div style="background:#f8fafc;border-radius:12px;padding:24px;margin-bottom:16px;border:2px solid #e2e8f0;transition:all 0.3s ease;" 
             onmouseover="this.style.borderColor='#3b82f6';this.style.boxShadow='0 4px 12px rgba(59,130,246,0.15)'" 
             onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
          <div style="display:flex;align-items:start;gap:16px;">
            <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;">
              ${part.id === 'frontend' ? 'üé®' : part.id === 'security' ? 'üîí' : part.id === 'database' ? 'üóÑÔ∏è' : 'ü§ñ'}
            </div>
            <div style="flex:1;">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                <h4 style="margin:0;font-size:18px;font-weight:700;color:#1e293b;">${part.name}</h4>
                <span style="background:#10b981;color:#fff;padding:4px 12px;border-radius:6px;font-size:12px;font-weight:600;">‚úÖ ${part.status === 'completed' ? 'Â∑≤ÂÆåÊàê' : 'ËøõË°å‰∏≠'}</span>
              </div>
              <p style="margin:0 0 16px 0;color:#64748b;font-size:14px;line-height:1.6;">${part.description}</p>
              
              ${part.files && part.files.length > 0 ? `
                <div style="margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;">Áõ∏ÂÖ≥Êñá‰ª∂Ôºö</div>
                  <div style="display:flex;flex-wrap:wrap;gap:8px;">
                    ${part.files.map(file => `
                      <span style="background:#e2e8f0;color:#475569;padding:4px 10px;border-radius:6px;font-size:12px;font-family:monospace;">${file}</span>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              ${part.modules && part.modules.length > 0 ? `
                <div style="margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;">Êñ∞Â¢ûÊ®°ÂùóÔºö</div>
                  <div style="display:flex;flex-wrap:wrap;gap:8px;">
                    ${part.modules.map(module => `
                      <div style="background:#dbeafe;color:#1e40af;padding:6px 12px;border-radius:6px;font-size:12px;display:flex;align-items:center;gap:6px;">
                        <span>üì¶</span>
                        <span>${module.name}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              ${part.benefits && part.benefits.length > 0 ? `
                <div>
                  <div style="font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;">Êî∂ÁõäÔºö</div>
                  <ul style="margin:0;padding-left:20px;color:#64748b;font-size:13px;">
                    ${part.benefits.map(benefit => `<li style="margin-bottom:4px;">${benefit}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    // Ê∏≤ÊüìËÉΩÂäõÊèêÂçá
    function renderCapabilities(capabilities) {
      const container = document.getElementById('upgradeCapabilities');
      
      const html = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">
          <div style="background:linear-gradient(135deg, #e6f0ff 0%, #dbeafe 100%);border-radius:12px;padding:20px;border:2px solid rgba(59,130,246,0.2);">
            <div style="font-size:14px;font-weight:600;color:#1e40af;margin-bottom:8px;">Ëá™Âä®ÂåñÁéá</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.automation || '--'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);border-radius:12px;padding:20px;border:2px solid rgba(16,185,129,0.2);">
            <div style="font-size:14px;font-weight:600;color:#065f46;margin-bottom:8px;">Êô∫ËÉΩÂåñÁéá</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.intelligence || '--'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border-radius:12px;padding:20px;border:2px solid rgba(245,158,11,0.2);">
            <div style="font-size:14px;font-weight:600;color:#92400e;margin-bottom:8px;">È¢ÑÊµãÂáÜÁ°ÆÁéá</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.prediction || '--'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);border-radius:12px;padding:20px;border:2px solid rgba(236,72,153,0.2);">
            <div style="font-size:14px;font-weight:600;color:#9f1239;margin-bottom:8px;">APIÂÆâÂÖ®ÊÄß</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.security || '--'}</div>
          </div>
        </div>
      `;

      container.innerHTML = html;
    }

    // Êô∫ËÉΩÂäüËÉΩÊ®°ÂùóÂä†ËΩΩÂáΩÊï∞Ôºà‰ΩøÁî®ÂÖ®Â±Ä CORE_ADMIN_API_BASEÔºâ

    // Âä†ËΩΩÊô∫ËÉΩÂÜ≥Á≠ñÂª∫ËÆÆ
    async function loadIntelligentAdvice() {
      const preview = document.getElementById('intelligentAdvicePreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/advice`);
        const result = await response.json();
        if (result.success && result.data) {
          const advice = result.data;
          preview.innerHTML = `<strong>${advice.title || 'Êô∫ËÉΩÂª∫ËÆÆ'}</strong><br>${advice.description || advice.reason || 'ÊöÇÊó†Âª∫ËÆÆ'}`;
          // ÂèØ‰ª•ÊâìÂºÄËØ¶ÁªÜÊ®°ÊÄÅÊ°ÜÊòæÁ§∫ÂÆåÊï¥‰ø°ÊÅØ
          showIntelligentModal('ÂÜ≥Á≠ñÂºïÊìé', advice);
        } else {
          preview.innerHTML = 'ÊöÇÊó†Âª∫ËÆÆ';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩÊô∫ËÉΩÂª∫ËÆÆÂ§±Ë¥•:', error);
      }
    }

    // Âä†ËΩΩÈ¢ÑÊµãÁª¥Êä§‰ø°ÊÅØ
    async function loadIntelligentPredictions() {
      const preview = document.getElementById('intelligentPredictionsPreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/predictions`);
        const result = await response.json();
        if (result.success && result.data) {
          const predictions = result.data;
          const count = predictions.predictions?.length || 0;
          preview.innerHTML = `ÂèëÁé∞ <strong>${count}</strong> ‰∏™ÊΩúÂú®ÈóÆÈ¢ò<br>${predictions.summary || 'ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ'}`;
          showIntelligentModal('È¢ÑÊµãÁª¥Êä§', predictions);
        } else {
          preview.innerHTML = 'ÊöÇÊó†È¢ÑÊµã‰ø°ÊÅØ';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩÈ¢ÑÊµã‰ø°ÊÅØÂ§±Ë¥•:', error);
      }
    }

    // Âä†ËΩΩÂ∑•‰ΩúÊµÅÂàóË°®
    async function loadIntelligentWorkflows() {
      const preview = document.getElementById('intelligentWorkflowsPreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/workflows`);
        const result = await response.json();
        if (result.success && result.data) {
          const workflows = result.data;
          const count = workflows.workflows?.length || 0;
          preview.innerHTML = `ÂÖ±Êúâ <strong>${count}</strong> ‰∏™Â∑•‰ΩúÊµÅ<br>${workflows.summary || 'ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ'}`;
          showIntelligentModal('Â∑•‰ΩúÊµÅÂºïÊìé', workflows);
        } else {
          preview.innerHTML = 'ÊöÇÊó†Â∑•‰ΩúÊµÅ';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩÂ∑•‰ΩúÊµÅÂ§±Ë¥•:', error);
      }
    }

    // Âä†ËΩΩÂëäË≠¶ÂàóË°®
    async function loadIntelligentAlerts() {
      const preview = document.getElementById('intelligentAlertsPreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/alerts`);
        const result = await response.json();
        if (result.success && result.data) {
          const alerts = result.data;
          const activeCount = alerts.alerts?.filter(a => a.status === 'active').length || 0;
          preview.innerHTML = `Ê¥ªË∑ÉÂëäË≠¶: <strong style="color:#ef4444;">${activeCount}</strong><br>${alerts.summary || 'ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ'}`;
          showIntelligentModal('ÂëäË≠¶Á≥ªÁªü', alerts);
        } else {
          preview.innerHTML = 'ÊöÇÊó†ÂëäË≠¶';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩÂëäË≠¶Â§±Ë¥•:', error);
      }
    }

    // Âä†ËΩΩËá™ÈÄÇÂ∫î‰ºòÂåñÁä∂ÊÄÅ
    async function loadIntelligentOptimization() {
      const preview = document.getElementById('intelligentOptimizationPreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/optimization`);
        const result = await response.json();
        if (result.success && result.data) {
          const optimization = result.data;
          preview.innerHTML = `‰ºòÂåñÁä∂ÊÄÅ: <strong>${optimization.status || 'ËøêË°å‰∏≠'}</strong><br>${optimization.summary || 'ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ'}`;
          showIntelligentModal('Ëá™ÈÄÇÂ∫î‰ºòÂåñ', optimization);
        } else {
          preview.innerHTML = 'ÊöÇÊó†‰ºòÂåñ‰ø°ÊÅØ';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩ‰ºòÂåñ‰ø°ÊÅØÂ§±Ë¥•:', error);
      }
    }

    // Âä†ËΩΩÁü•ËØÜÂõæË∞±
    async function loadIntelligentKnowledge() {
      const preview = document.getElementById('intelligentKnowledgePreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/knowledge`);
        const result = await response.json();
        if (result.success && result.data) {
          const knowledge = result.data;
          preview.innerHTML = `ÂÆû‰ΩìÊï∞Èáè: <strong>${knowledge.entities?.length || 0}</strong><br>${knowledge.summary || 'ÁÇπÂáªÊü•ËØ¢Áü•ËØÜÂõæË∞±'}`;
          showIntelligentModal('Áü•ËØÜÂõæË∞±', knowledge);
        } else {
          preview.innerHTML = 'ÊöÇÊó†Áü•ËØÜÊï∞ÊçÆ';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩÁü•ËØÜÂõæË∞±Â§±Ë¥•:', error);
      }
    }

    // Âä†ËΩΩÊô∫ËÉΩÊä•Âëä
    async function loadIntelligentReports() {
      const preview = document.getElementById('intelligentReportsPreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/reports`);
        const result = await response.json();
        if (result.success && result.data) {
          const reports = result.data;
          const count = reports.reports?.length || 0;
          preview.innerHTML = `ÂÖ±Êúâ <strong>${count}</strong> ‰∏™Êä•Âëä<br>${reports.summary || 'ÁÇπÂáªÊü•ÁúãÊä•Âëä'}`;
          showIntelligentModal('Êô∫ËÉΩÊä•Âëä', reports);
        } else {
          preview.innerHTML = 'ÊöÇÊó†Êä•Âëä';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩÊä•ÂëäÂ§±Ë¥•:', error);
      }
    }

    // ÊòæÁ§∫Êô∫ËÉΩÂäüËÉΩËØ¶ÁªÜ‰ø°ÊÅØÁöÑÊ®°ÊÄÅÊ°Ü
    function showIntelligentModal(title, data) {
      // ÂàõÂª∫ÊàñËé∑ÂèñÊ®°ÊÄÅÊ°Ü
      let modal = document.getElementById('intelligentModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'intelligentModal';
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-content" style="max-width:800px;">
            <div class="modal-header">
              <h3 id="intelligentModalTitle">${title}</h3>
              <button class="btn btn-ghost btn-sm" onclick="closeIntelligentModal()">‚úï</button>
            </div>
            <div class="modal-body" id="intelligentModalBody" style="max-height:70vh;overflow-y:auto;">
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" onclick="closeIntelligentModal()">ÂÖ≥Èó≠</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      document.getElementById('intelligentModalTitle').textContent = title;
      const body = document.getElementById('intelligentModalBody');
      
      // Ê†ºÂºèÂåñÊòæÁ§∫Êï∞ÊçÆ
      body.innerHTML = `<pre style="white-space:pre-wrap;word-wrap:break-word;font-family:inherit;font-size:14px;line-height:1.6;">${JSON.stringify(data, null, 2)}</pre>`;
      
      modal.style.display = 'flex';
    }

    function closeIntelligentModal() {
      const modal = document.getElementById('intelligentModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    // ÂàùÂßãÂåñ
    // ÂÆâÂÖ®ÁâàÊú¨ÁöÑcheckAuthË∞ÉÁî®ÔºàÊ£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÔºâ
    if (!window.__loginInProgress && !window.__justLoggedIn) {
      setTimeout(function() {
        if (!window.__loginInProgress && !window.__justLoggedIn) {
          checkAuth();
        }
      }, 2000);
    }
  </script>
  
  <script>
    // ‰øùÂ≠òÂÖ¨Âëä
    document.getElementById('announcementForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = document.getElementById('announcementId').value;
      const content = document.getElementById('announcementContent').value.trim();
      const active = document.getElementById('announcementActive').checked;
      const token = localStorage.getItem('adminToken');
      
      if (!content) {
        alert('ËØ∑ËæìÂÖ•ÂÖ¨ÂëäÂÜÖÂÆπ');
        return;
      }
      
      try {
        const url = id 
          ? `${getApiUrl()}/admin/announcements/${id}`
          : `${getApiUrl()}/admin/announcements`;
        
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ content, active })
        });
        
        if (!response.ok) throw new Error(id ? 'Êõ¥Êñ∞Â§±Ë¥•' : 'ÂàõÂª∫Â§±Ë¥•');
        
        const result = await response.json();
        if (result.success) {
          document.getElementById('announcementModal').classList.remove('active');
          loadAnnouncements();
          // Â¶ÇÊûúÂΩìÂâçÂú®È¶ñÈ°µÔºåÂà∑Êñ∞‰∏ªÈ°µÂÖ¨ÂëäÊ†è
          const homeView = document.getElementById('homeView');
          if (homeView && homeView.style.display !== 'none') {
            loadHomeAnnouncementBubble();
          }
        }
      } catch (error) {
        alert((id ? 'Êõ¥Êñ∞' : 'ÂàõÂª∫') + 'Â§±Ë¥•Ôºö' + error.message);
      }
    });
    
    // ‰øÆÊîπÂØÜÁ†ÅÂäüËÉΩ
    document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const errorDiv = document.getElementById('passwordChangeError');
      const successDiv = document.getElementById('passwordChangeSuccess');
      const token = localStorage.getItem('adminToken');
      
      // ÈöêËóè‰πãÂâçÁöÑÊ∂àÊÅØ
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';
      
      // È™åËØÅÊñ∞ÂØÜÁ†Å
      if (newPassword.length < 6) {
        errorDiv.textContent = 'Êñ∞ÂØÜÁ†ÅÈïøÂ∫¶Ëá≥Â∞ë‰∏∫6‰Ωç';
        errorDiv.style.display = 'block';
        return;
      }
      
      if (newPassword !== confirmPassword) {
        errorDiv.textContent = '‰∏§Ê¨°ËæìÂÖ•ÁöÑÊñ∞ÂØÜÁ†Å‰∏ç‰∏ÄËá¥';
        errorDiv.style.display = 'block';
        return;
      }
      
      if (oldPassword === newPassword) {
        errorDiv.textContent = 'Êñ∞ÂØÜÁ†Å‰∏çËÉΩ‰∏éÂéüÂØÜÁ†ÅÁõ∏Âêå';
        errorDiv.style.display = 'block';
        return;
      }
      
      try {
        const response = await fetch(`${getApiUrl()}/auth/change-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ oldPassword, newPassword })
        });
        
        const result = await response.json();
        
        if (result.success) {
          successDiv.style.display = 'block';
          document.getElementById('changePasswordForm').reset();
          
          // 3ÁßíÂêéÈöêËóèÊàêÂäüÊ∂àÊÅØ
          setTimeout(() => {
            successDiv.style.display = 'none';
          }, 3000);
        } else {
          errorDiv.textContent = result.error || 'ÂØÜÁ†Å‰øÆÊîπÂ§±Ë¥•';
          errorDiv.style.display = 'block';
        }
      } catch (error) {
        errorDiv.textContent = 'ÂØÜÁ†Å‰øÆÊîπÂ§±Ë¥•Ôºö' + (error.message || 'ÁΩëÁªúÈîôËØØ');
        errorDiv.style.display = 'block';
      }
    });
    
    // ==========================================
    // üì∞ ËµÑËÆØÊõ¥Êñ∞ÂäüËÉΩÔºà‰ªé‰∏ªÁ´ôÁßªÊ§çÔºâ
    // ==========================================
    
    // ËµÑËÆØÊï∞ÊçÆÂ≠òÂÇ®
    let NEWS_DATA = [];
    let currentNewsFilter = 'all';
    let currentNewsRegion = 'local'; // 'local' Êàñ 'national'
    
    // Ëé∑ÂèñAPIÈÖçÁΩÆÔºà‰∏é‰∏ªÁ´ô‰∏ÄËá¥Ôºâ
    function getApiConfig() {
      const config = localStorage.getItem('pigeon_api_config');
      if (config) {
        const parsed = JSON.parse(config);
        // Á°Æ‰øùÊúâapiUrlÂ≠óÊÆµ
        if (!parsed.apiUrl) {
          parsed.apiUrl = 'http://localhost:3000/api';
        }
        return parsed;
      }
      
      // ÈªòËÆ§ÈÖçÁΩÆÔºàÂêéÁ´ØÊúçÂä°Âú∞ÂùÄÔºâ
      const defaultBaseUrl = 'http://localhost:3000/api';
      return {
        apiUrl: defaultBaseUrl, // APIÂü∫Á°ÄÂú∞ÂùÄ
        newsApiUrl: defaultBaseUrl + '/news', // ËµÑËÆØAPIÂú∞ÂùÄ
        eventsApiUrl: defaultBaseUrl + '/events', // Ëµõ‰∫ãAPIÂú∞ÂùÄ
        apiKey: '' // APIÂØÜÈí•ÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
      };
    }
    
    // ‰øùÂ≠òAPIÈÖçÁΩÆ
    function saveApiConfig(config) {
      localStorage.setItem('pigeon_api_config', JSON.stringify(config));
    }
    
    // ‰ªélocalStorageÂä†ËΩΩËµÑËÆØÊï∞ÊçÆ
    function loadNewsFromStorage() {
      const stored = localStorage.getItem('pigeon_news_data');
      const lastUpdate = localStorage.getItem('pigeon_news_last_update');
      
      if (stored && lastUpdate) {
        const lastUpdateDate = new Date(lastUpdate);
        const now = new Date();
        const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
        
        // Â¶ÇÊûúÊï∞ÊçÆÊòØ‰ªäÂ§©ÁöÑÔºåÁõ¥Êé•‰ΩøÁî®
        if (daysDiff === 0) {
          NEWS_DATA = JSON.parse(stored);
          return true;
        }
      }
      
      return false;
    }
    
    // ‰øùÂ≠òËµÑËÆØÊï∞ÊçÆÂà∞localStorage
    function saveNewsToStorage() {
      localStorage.setItem('pigeon_news_data', JSON.stringify(NEWS_DATA));
      localStorage.setItem('pigeon_news_last_update', new Date().toISOString());
    }
    
    // ‰ªéÁúüÂÆûAPIËé∑ÂèñËµÑËÆØÊï∞ÊçÆ
    async function fetchNewsFromWeb() {
      // Ëé∑ÂèñAPIÈÖçÁΩÆ
      const apiConfig = getApiConfig();
      
      if (!apiConfig.newsApiUrl) {
        throw new Error('ËµÑËÆØAPIÊú™ÈÖçÁΩÆÔºåËØ∑Âú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPIÂú∞ÂùÄ');
      }
      
      try {
        // ÊûÑÂª∫ËØ∑Ê±ÇÂ§¥
        const headers = {
          'Content-Type': 'application/json'
        };
        if (apiConfig.apiKey) {
          headers['Authorization'] = 'Bearer ' + apiConfig.apiKey;
        }
        
        // Â∞ùËØï‰ªéAPIËé∑ÂèñÊï∞ÊçÆ
        const response = await fetch(apiConfig.newsApiUrl, {
          method: 'GET',
          headers: headers
        });
        
        if (!response.ok) {
          throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} ${response.statusText}`);
        }
        
        const result = await response.json();
        
        // ÂêéÁ´ØAPIËøîÂõûÊ†ºÂºè: {success: true, data: [...], count: X, timestamp: "..."}
        if (!result.success) {
          throw new Error(result.error || 'APIËøîÂõûÈîôËØØ');
        }
        
        const data = result.data || result;
        
        // È™åËØÅÊï∞ÊçÆÊ†ºÂºè
        if (!Array.isArray(data)) {
          throw new Error('APIËøîÂõûÁöÑÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∫î‰∏∫Êï∞ÁªÑ');
        }
        
        // ËΩ¨Êç¢Êï∞ÊçÆÊ†ºÂºè
        return data.map(item => ({
          id: item.id || Date.now() + Math.random(),
          title: item.title || 'Êó†Ê†áÈ¢ò',
          source: item.source || 'Êú™Áü•Êù•Ê∫ê',
          sourceUrl: item.sourceUrl || item.url || '#',
          time: item.time || formatUpdateTime(item.updateTime),
          updateTime: item.updateTime || new Date().toISOString(),
          tags: item.tags || [],
          category: item.category || 'race',
          region: item.region || 'national',
          content: item.content || item.description || '',
          hot: item.hot || false
        }));
        
      } catch (error) {
        console.error('Ëé∑ÂèñËµÑËÆØÂ§±Ë¥•:', error);
        throw error;
      }
    }
    
    // Ê†ºÂºèÂåñÊõ¥Êñ∞Êó∂Èó¥
    function formatUpdateTime(updateTime) {
      if (!updateTime) return 'Êú™Áü•';
      const date = new Date(updateTime);
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 60) {
        return `${minutes}ÂàÜÈíüÂâç`;
      } else if (hours < 24) {
        return `${hours}Â∞èÊó∂Ââç`;
      } else if (days < 7) {
        return `${days}Â§©Ââç`;
      } else {
        return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
      }
    }
    
    // Ê∏≤ÊüìËµÑËÆØÂàóË°®
    function renderNewsList(filter = 'all', region = 'local') {
      const container = document.getElementById('homeNewsList');
      if (!container) return;
      
      // ÂÖàÊåâÂú∞Âå∫Á≠õÈÄâ
      let filteredNews = NEWS_DATA.filter(n => n.region === region);
      
      // ÂÜçÊåâÂàÜÁ±ªÁ≠õÈÄâ
      if (filter !== 'all') {
        filteredNews = filteredNews.filter(n => n.category === filter);
      }
      
      // ÊåâÊõ¥Êñ∞Êó∂Èó¥ÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
      filteredNews.sort((a, b) => {
        const timeA = new Date(a.updateTime || 0);
        const timeB = new Date(b.updateTime || 0);
        return timeB - timeA;
      });
      
      if (filteredNews.length === 0) {
        const apiConfig = getApiConfig();
        if (!apiConfig.newsApiUrl) {
          // APIÊú™ÈÖçÁΩÆÔºåÊòæÁ§∫ÈÖçÁΩÆÊèêÁ§∫
          showApiConfigPrompt('ËµÑËÆØ');
          return;
        }
        
        container.innerHTML = `
          <div style="padding:40px;text-align:center;color:#9ca3af;">
            <div style="font-size:48px;margin-bottom:16px;">üì∞</div>
            <div>ÊöÇÊó†${region === 'local' ? 'Êú¨Âú∞' : 'ÂÖ®ÂõΩ'}ËµÑËÆØ</div>
            <div style="font-size:12px;margin-top:8px;">ÁÇπÂáª"Âà∑Êñ∞ËµÑËÆØ"ÊåâÈíÆËé∑ÂèñÊúÄÊñ∞ËµÑËÆØ</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredNews.map(news => {
        const updateTimeStr = formatUpdateTime(news.updateTime);
        return `
          <div class="news-card" data-news-id="${news.id}">
            <div class="news-card-header">
              <div class="news-card-title">${news.title}</div>
              <div class="news-card-time">${news.time}</div>
            </div>
            <div class="news-card-source">Êù•Ê∫êÔºö${news.source}</div>
            <div class="news-card-update-time">Êõ¥Êñ∞Êó∂Èó¥Ôºö${updateTimeStr}</div>
            <div class="news-card-tags">
              ${news.hot ? '<span class="news-tag hot">üî• ÁÉ≠Èó®</span>' : ''}
              ${news.tags.map(tag => `<span class="news-tag ${news.category}">#${tag}</span>`).join('')}
            </div>
            <div class="news-card-actions">
              <button class="news-card-action-btn" onclick="viewNewsDetail(${news.id})">üìñ Êü•ÁúãËØ¶ÊÉÖ</button>
              <button class="news-card-action-btn primary" onclick="openNewsOriginal(${news.id})">üîó Êü•ÁúãÂéüÊñá</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Êü•ÁúãËµÑËÆØËØ¶ÊÉÖÔºàÊö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºâ
    window.viewNewsDetail = function(newsId) {
      const news = NEWS_DATA.find(n => n.id === newsId);
      if (!news) {
        alert('ËµÑËÆØ‰∏çÂ≠òÂú®');
        return;
      }
      
      const modal = document.getElementById('newsModal');
      if (!modal) return;
      
      const titleEl = document.getElementById('newsModalTitle');
      const sourceEl = document.getElementById('newsModalSource');
      const regionEl = document.getElementById('newsModalRegion');
      const updateTimeEl = document.getElementById('newsModalUpdateTime');
      const contentEl = document.getElementById('newsModalContent');
      
      if (titleEl) titleEl.textContent = news.title;
      if (sourceEl) sourceEl.textContent = `Êù•Ê∫êÔºö${news.source}`;
      if (regionEl) regionEl.textContent = news.region === 'local' ? 'üìç Êú¨Âú∞ËµÑËÆØ' : 'üåê ÂÖ®ÂõΩËµÑËÆØ';
      if (updateTimeEl) updateTimeEl.textContent = `Êõ¥Êñ∞Êó∂Èó¥Ôºö${formatUpdateTime(news.updateTime)}`;
      if (contentEl) contentEl.textContent = news.content || 'ÊöÇÊó†ËØ¶ÁªÜÂÜÖÂÆπ';
      
      // ËÆæÁΩÆÊü•ÁúãÂéüÊñáÊåâÈíÆÁöÑÈìæÊé•
      const viewOriginalBtn = document.getElementById('newsModalViewOriginal');
      if (viewOriginalBtn) {
        viewOriginalBtn.onclick = () => window.openNewsOriginal(newsId);
      }
      
      modal.classList.add('active');
    };
    
    // ÊâìÂºÄÂéüËµÑËÆØÈìæÊé•ÔºàÊö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºâ
    window.openNewsOriginal = function(newsId) {
      const news = NEWS_DATA.find(n => n.id === newsId);
      if (!news || !news.sourceUrl) {
        alert('ÂéüËµÑËÆØÈìæÊé•‰∏çÂ≠òÂú®');
        return;
      }
      
      window.open(news.sourceUrl, '_blank');
    };
    
    // ÂÖ≥Èó≠ËµÑËÆØËØ¶ÊÉÖÂºπÁ™ó
    function closeNewsModal() {
      const modal = document.getElementById('newsModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }
    
    // Ëá™Âä®Êõ¥Êñ∞ËµÑËÆØ
    async function updateNews() {
      try {
        const news = await fetchNewsFromWeb();
        NEWS_DATA = news;
        saveNewsToStorage();
        renderNewsList(currentNewsFilter, currentNewsRegion);
        updateHomeStats();
        console.log('ËµÑËÆØÊõ¥Êñ∞ÊàêÂäüÔºåÂÖ±Ëé∑Âèñ', news.length, 'Êù°ËµÑËÆØ');
      } catch (error) {
        console.error('Êõ¥Êñ∞ËµÑËÆØÂ§±Ë¥•:', error);
        
        // Â¶ÇÊûúAPIÊú™ÈÖçÁΩÆÔºåÊòæÁ§∫ÈÖçÁΩÆÊèêÁ§∫
        if (error.message && error.message.includes('Êú™ÈÖçÁΩÆ')) {
          NEWS_DATA = [];
          renderNewsList(currentNewsFilter, currentNewsRegion);
          showApiConfigPrompt('ËµÑËÆØ');
          return;
        }
        
        // Â¶ÇÊûúÊõ¥Êñ∞Â§±Ë¥•ÔºåÂ∞ùËØïÂä†ËΩΩÁºìÂ≠òÊï∞ÊçÆ
        if (loadNewsFromStorage()) {
          renderNewsList(currentNewsFilter, currentNewsRegion);
        } else {
          // Ê≤°ÊúâÁºìÂ≠òÊï∞ÊçÆÔºåÊòæÁ§∫ÈîôËØØÊèêÁ§∫
          NEWS_DATA = [];
          renderNewsList(currentNewsFilter, currentNewsRegion);
        }
      }
    }
    
    // ÊòæÁ§∫APIÈÖçÁΩÆÊèêÁ§∫
    function showApiConfigPrompt(type) {
      const container = type === 'ËµÑËÆØ' ? document.getElementById('homeNewsList') : document.getElementById('homeEventsList');
      if (!container) return;
      
      const apiConfig = getApiConfig();
      const apiUrl = type === 'ËµÑËÆØ' ? apiConfig.newsApiUrl : apiConfig.eventsApiUrl;
      
      if (!apiUrl) {
        container.innerHTML = `
          <div style="padding:40px;text-align:center;color:#9ca3af;">
            <div style="font-size:48px;margin-bottom:16px;">${type === 'ËµÑËÆØ' ? 'üì∞' : 'üèÅ'}</div>
            <div style="font-size:16px;font-weight:600;color:#374151;margin-bottom:8px;">${type}APIÊú™ÈÖçÁΩÆ</div>
            <div style="font-size:13px;color:#6b7280;margin-bottom:16px;">ËØ∑ÈÖçÁΩÆ${type}APIÂú∞ÂùÄ‰ª•Ëé∑ÂèñÁúüÂÆûÊï∞ÊçÆ</div>
            <button class="btn btn-primary btn-sm" onclick="showApiConfigModal('${type}')" style="margin-top:12px;">
              ‚öôÔ∏è ÈÖçÁΩÆAPI
            </button>
          </div>
        `;
      }
    }
    
    // ÊòæÁ§∫APIÈÖçÁΩÆÂºπÁ™ó
    window.showApiConfigModal = function(type) {
      const apiConfig = getApiConfig();
      const apiUrl = type === 'ËµÑËÆØ' ? apiConfig.newsApiUrl : apiConfig.eventsApiUrl;
      const apiKey = apiConfig.apiKey || '';
      
      const newsApiUrl = prompt(`ËØ∑ËæìÂÖ•${type === 'ËµÑËÆØ' ? 'ËµÑËÆØ' : 'Ëµõ‰∫ã'}APIÂú∞ÂùÄ:`, apiUrl || '');
      if (newsApiUrl === null) return; // Áî®Êà∑ÂèñÊ∂à
      
      const newApiKey = prompt('ËØ∑ËæìÂÖ•APIÂØÜÈí•ÔºàÂèØÈÄâÔºåÁõ¥Êé•ÂõûËΩ¶Ë∑≥ËøáÔºâ:', apiKey);
      
      const newConfig = {
        ...apiConfig,
        [type === 'ËµÑËÆØ' ? 'newsApiUrl' : 'eventsApiUrl']: newsApiUrl,
        apiKey: newApiKey || apiKey
      };
      
      saveApiConfig(newConfig);
      
      // ÈáçÊñ∞Â∞ùËØïËé∑ÂèñÊï∞ÊçÆ
      if (type === 'ËµÑËÆØ') {
        updateNews();
      }
      
      alert('APIÈÖçÁΩÆÂ∑≤‰øùÂ≠òÔºåÊ≠£Âú®Ëé∑ÂèñÊï∞ÊçÆ...');
    };
    
    // Êõ¥Êñ∞È¶ñÈ°µÁªüËÆ°
    function updateHomeStats() {
      const pigeonCountEl = document.getElementById('homePigeonCount');
      if (pigeonCountEl) {
        // ËøôÈáåÂèØ‰ª•‰ªélocalStorageËé∑ÂèñÈ∏ΩÂ≠êÊï∞ÊçÆ
        try {
          const pigeonsData = localStorage.getItem('pigeons');
          if (pigeonsData) {
            const pigeons = JSON.parse(pigeonsData);
            pigeonCountEl.textContent = pigeons.filter(p => p && p.alive).length || 0;
          } else {
            pigeonCountEl.textContent = '0';
          }
        } catch (e) {
          pigeonCountEl.textContent = '0';
        }
      }
      
      // Êõ¥Êñ∞ÂÖ∂‰ªñÁªüËÆ°
      const newsCountEl = document.getElementById('homeNewsCount');
      if (newsCountEl) {
        newsCountEl.textContent = NEWS_DATA.length || 0;
      }
      
      // Êõ¥Êñ∞Ëµõ‰∫ãÁªüËÆ°
      const activeRacesEl = document.getElementById('homeActiveRaces');
      if (activeRacesEl) {
        activeRacesEl.textContent = (EVENTS_DATA.ongoing || []).length;
      }
      
      const completedRacesEl = document.getElementById('homeCompletedRaces');
      if (completedRacesEl) {
        completedRacesEl.textContent = (EVENTS_DATA.results || []).length;
      }
      
      // Êõ¥Êñ∞Êó•ÊúüÊòæÁ§∫
      const now = new Date();
      const dayEl = document.getElementById('homeDay');
      const weekdayEl = document.getElementById('homeWeekday');
      const dateFullEl = document.getElementById('homeDateFull');
      
      if (dayEl) dayEl.textContent = now.getDate();
      if (weekdayEl) {
        const weekdays = ['Âë®Êó•', 'Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠'];
        weekdayEl.textContent = weekdays[now.getDay()];
      }
      if (dateFullEl) {
        dateFullEl.textContent = `${now.getFullYear()}Âπ¥${now.getMonth() + 1}Êúà`;
      }
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞ËµÑËÆØÔºàÊØèÂ§©Êõ¥Êñ∞‰∏ÄÊ¨°Ôºâ
    function checkAndUpdateNews() {
      const lastUpdate = localStorage.getItem('pigeon_news_last_update');
      if (!lastUpdate) {
        // È¶ñÊ¨°Âä†ËΩΩÔºåÁõ¥Êé•Êõ¥Êñ∞
        updateNews();
        return;
      }
      
      const lastUpdateDate = new Date(lastUpdate);
      const now = new Date();
      const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
      
      if (daysDiff >= 1) {
        // Ë∂ÖËøá1Â§©ÔºåÈúÄË¶ÅÊõ¥Êñ∞
        updateNews();
      } else {
        // ‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ
        if (loadNewsFromStorage()) {
          renderNewsList(currentNewsFilter, currentNewsRegion);
        } else {
          // Â¶ÇÊûúÊ≤°ÊúâÁºìÂ≠òÔºåÂàôÊõ¥Êñ∞
          updateNews();
        }
      }
    }
    
    // ==========================================
    // üèÅ ÂÆûÊó∂Ëµõ‰∫ãÂäüËÉΩÔºà‰ªé‰∏ªÁ´ôÁßªÊ§çÔºâ
    // ==========================================
    
    // Ëµõ‰∫ãÊï∞ÊçÆÂ≠òÂÇ®
    let EVENTS_DATA = {
      ongoing: [],
      upcoming: [],
      results: []
    };
    
    let currentEventTab = 'ongoing';
    let currentEventRegion = 'local'; // 'local' Êàñ 'national'
    
    // ‰ªélocalStorageÂä†ËΩΩËµõ‰∫ãÊï∞ÊçÆ
    function loadEventsFromStorage() {
      const stored = localStorage.getItem('pigeon_events_data');
      const lastUpdate = localStorage.getItem('pigeon_events_last_update');
      
      if (stored && lastUpdate) {
        const lastUpdateDate = new Date(lastUpdate);
        const now = new Date();
        const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
        
        // Â¶ÇÊûúÊï∞ÊçÆÊòØ‰ªäÂ§©ÁöÑÔºåÁõ¥Êé•‰ΩøÁî®
        if (daysDiff === 0) {
          EVENTS_DATA = JSON.parse(stored);
          return true;
        }
      }
      
      return false;
    }
    
    // ‰øùÂ≠òËµõ‰∫ãÊï∞ÊçÆÂà∞localStorage
    function saveEventsToStorage() {
      localStorage.setItem('pigeon_events_data', JSON.stringify(EVENTS_DATA));
      localStorage.setItem('pigeon_events_last_update', new Date().toISOString());
    }
    
    // ‰ªéÁúüÂÆûAPIËé∑ÂèñËµõ‰∫ãÊï∞ÊçÆ
    async function fetchEventsFromWeb() {
      // Ëé∑ÂèñAPIÈÖçÁΩÆ
      const apiConfig = getApiConfig();
      
      if (!apiConfig.eventsApiUrl) {
        throw new Error('Ëµõ‰∫ãAPIÊú™ÈÖçÁΩÆÔºåËØ∑Âú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPIÂú∞ÂùÄ');
      }
      
      try {
        // ÊûÑÂª∫ËØ∑Ê±ÇÂ§¥
        const headers = {
          'Content-Type': 'application/json'
        };
        if (apiConfig.apiKey) {
          headers['Authorization'] = 'Bearer ' + apiConfig.apiKey;
        }
        
        // Â∞ùËØï‰ªéAPIËé∑ÂèñÊï∞ÊçÆÔºàËé∑ÂèñÊâÄÊúâÁ±ªÂûãÁöÑËµõ‰∫ãÔºâ
        const response = await fetch(apiConfig.eventsApiUrl, {
          method: 'GET',
          headers: headers
        });
        
        if (!response.ok) {
          const errorText = await response.text().catch(() => '');
          throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} ${response.statusText}. ${errorText}`);
        }
        
        const result = await response.json();
        
        // ÂêéÁ´ØAPIËøîÂõûÊ†ºÂºè: {success: true, data: {ongoing: [], upcoming: [], results: []}}
        if (!result.success) {
          throw new Error(result.error || result.message || 'APIËøîÂõûÈîôËØØ');
        }
        
        const data = result.data || result;
        
        // È™åËØÅÊï∞ÊçÆÊ†ºÂºè
        if (!data.ongoing || !data.upcoming || !data.results) {
          throw new Error('APIËøîÂõûÁöÑÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∫îÂåÖÂê´ongoing„ÄÅupcoming„ÄÅresultsÂ≠óÊÆµ');
        }
        
        // ËΩ¨Êç¢Êï∞ÊçÆÊ†ºÂºèÂπ∂È™åËØÅ
        const now = new Date();
        return {
          ongoing: (data.ongoing || []).map(item => {
            const releaseTimeFull = item.releaseTimeFull ? new Date(item.releaseTimeFull) : null;
            const endTimeFull = item.endTimeFull ? new Date(item.endTimeFull) : null;
            
            if (endTimeFull && endTimeFull <= now) {
              return null;
            }
            
            if (releaseTimeFull && releaseTimeFull > now) {
              return null;
            }
            
            return {
              id: item.id || Date.now() + Math.random(),
              name: item.name || 'Êú™Áü•Ëµõ‰∫ã',
              organizer: item.organizer || 'Êú™Áü•ÁªÑÁªá',
              source: item.source || 'Êú™Áü•Êù•Ê∫ê',
              sourceUrl: item.sourceUrl || item.url || '#',
              releaseTime: item.releaseTime || 'Êú™Áü•Êó∂Èó¥',
              releaseTimeFull: item.releaseTimeFull || new Date().toISOString(),
              endTimeFull: item.endTimeFull || null,
              distance: item.distance || 'Êú™Áü•Ë∑ùÁ¶ª',
              status: 'ongoing',
              region: item.region || 'national',
              returned: item.returned || 0,
              total: item.total || 0,
              weather: item.weather || 'Êú™Áü•',
              updateTime: item.updateTime || new Date().toISOString()
            };
          }).filter(item => item !== null),
          upcoming: (data.upcoming || []).map(item => {
            const startTimeFull = item.startTimeFull ? new Date(item.startTimeFull) : null;
            
            if (startTimeFull && startTimeFull <= now) {
              return null;
            }
            
            return {
              id: item.id || Date.now() + Math.random(),
              name: item.name || 'Êú™Áü•Ëµõ‰∫ã',
              organizer: item.organizer || 'Êú™Áü•ÁªÑÁªá',
              source: item.source || 'Êú™Áü•Êù•Ê∫ê',
              sourceUrl: item.sourceUrl || item.url || '#',
              startTime: item.startTime || 'Êú™Áü•Êó∂Èó¥',
              startTimeFull: item.startTimeFull || new Date(now.getTime() + 86400000).toISOString(),
              distance: item.distance || 'Êú™Áü•Ë∑ùÁ¶ª',
              status: 'upcoming',
              region: item.region || 'national',
              participants: item.participants || 0,
              weather: item.weather || 'Êú™Áü•',
              updateTime: item.updateTime || new Date().toISOString()
            };
          }).filter(item => item !== null),
          results: (data.results || []).map(item => {
            const endTimeFull = item.endTimeFull ? new Date(item.endTimeFull) : null;
            
            if (endTimeFull && endTimeFull > now) {
              return null;
            }
            
            return {
              id: item.id || Date.now() + Math.random(),
              name: item.name || 'Êú™Áü•Ëµõ‰∫ã',
              organizer: item.organizer || 'Êú™Áü•ÁªÑÁªá',
              source: item.source || 'Êú™Áü•Êù•Ê∫ê',
              sourceUrl: item.sourceUrl || item.url || '#',
              endTime: item.endTime || 'Êú™Áü•Êó∂Èó¥',
              endTimeFull: item.endTimeFull || new Date(now.getTime() - 86400000).toISOString(),
              distance: item.distance || 'Êú™Áü•Ë∑ùÁ¶ª',
              status: 'completed',
              region: item.region || 'national',
              champion: item.champion || 'Êú™Áü•',
              championRing: item.championRing || 'Êú™Áü•',
              championTime: item.championTime || 'Êú™Áü•',
              updateTime: item.updateTime || new Date().toISOString()
            };
          }).filter(item => item !== null)
        };
        
      } catch (error) {
        console.error('Ëé∑ÂèñËµõ‰∫ãÂ§±Ë¥•:', error);
        throw error;
      }
    }
    
    // È™åËØÅËµõ‰∫ãÊó∂Èó¥ÊòØÂê¶ÊúâÊïà
    function isValidEventTime(event, tab) {
      const now = new Date();
      
      if (tab === 'ongoing') {
        if (!event.releaseTimeFull) return false;
        const releaseTime = new Date(event.releaseTimeFull);
        const hoursSinceRelease = (now - releaseTime) / (1000 * 60 * 60);
        if (hoursSinceRelease > 24) return false;
        if (releaseTime > now) return false;
        return true;
      } else if (tab === 'upcoming') {
        if (!event.startTimeFull) return false;
        const startTime = new Date(event.startTimeFull);
        if (startTime <= now) return false;
        return true;
      } else if (tab === 'results') {
        if (!event.endTimeFull) return false;
        const endTime = new Date(event.endTimeFull);
        if (endTime > now) return false;
        return true;
      }
      
      return true;
    }
    
    // È™åËØÅËµõ‰∫ãÊï∞ÊçÆÊòØÂê¶ËøáÊó∂
    function isEventOutdated(event) {
      if (!event.updateTime) return true;
      
      const updateTime = new Date(event.updateTime);
      const now = new Date();
      const hoursSinceUpdate = (now - updateTime) / (1000 * 60 * 60);
      
      if (event.status === 'ongoing' && hoursSinceUpdate > 2) {
        return true;
      }
      
      if (hoursSinceUpdate > 24) {
        return true;
      }
      
      return false;
    }
    
    // Ê∏≤ÊüìËµõ‰∫ãÂàóË°®
    function renderEventsList(tab = 'ongoing', region = 'local') {
      const container = document.getElementById('homeEventsList');
      if (!container) return;
      
      // ÂÖàÊåâÂú∞Âå∫Á≠õÈÄâ
      let events = (EVENTS_DATA[tab] || []).filter(event => event.region === region);
      
      // ËøáÊª§ÊéâÊó∂Èó¥‰∏çÂêªÂêàÁöÑËµõ‰∫ã
      events = events.filter(event => isValidEventTime(event, tab));
      
      // ËøáÊª§ÊéâËøáÊó∂ÁöÑËµõ‰∫ã
      events = events.filter(event => !isEventOutdated(event));
      
      // ÂØπ‰∫é"ËøõË°å‰∏≠"ÁöÑËµõ‰∫ãÔºåÈ¢ùÂ§ñÈ™åËØÅ
      if (tab === 'ongoing') {
        events = events.filter(event => {
          if (event.endTimeFull) {
            const endTime = new Date(event.endTimeFull);
            if (endTime <= new Date()) {
              return false;
            }
          }
          return true;
        });
      }
      
      // ÊåâÊõ¥Êñ∞Êó∂Èó¥ÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
      events.sort((a, b) => {
        const timeA = new Date(a.updateTime || 0);
        const timeB = new Date(b.updateTime || 0);
        return timeB - timeA;
      });
      
      if (events.length === 0) {
        const apiConfig = getApiConfig();
        if (!apiConfig.eventsApiUrl) {
          showApiConfigPrompt('Ëµõ‰∫ã');
          return;
        }
        
        container.innerHTML = `
          <div style="padding:40px;text-align:center;color:#9ca3af;">
            <div style="font-size:48px;margin-bottom:16px;">üèÅ</div>
            <div>ÊöÇÊó†${region === 'local' ? 'Êú¨Âú∞' : 'ÂÖ®ÂõΩ'}${tab === 'ongoing' ? 'ËøõË°å‰∏≠' : tab === 'upcoming' ? 'Âç≥Â∞ÜÂºÄÂßã' : 'ÊúÄÊñ∞ÊàêÁª©'}Ëµõ‰∫ã</div>
            <div style="font-size:12px;margin-top:8px;">ÁÇπÂáª"Âà∑Êñ∞"ÊåâÈíÆËé∑ÂèñÊúÄÊñ∞Ëµõ‰∫ã</div>
          </div>
        `;
        return;
      }
      
      if (tab === 'ongoing') {
        container.innerHTML = events.map(event => {
          const updateTimeStr = formatUpdateTime(event.updateTime);
          const progressPercent = event.total > 0 ? ((event.returned / event.total) * 100).toFixed(1) : 0;
          return `
            <div class="event-card" style="cursor:pointer;" onclick="openEventUrl('${event.sourceUrl || '#'}')">
              <div class="event-card-status ongoing">
                <span>ËøõË°å‰∏≠</span>
              </div>
              <div class="event-card-title">${event.name}</div>
              <div class="event-card-info">
                <div class="event-card-info-item">
                  <span>üè¢</span>
                  <span>${event.organizer}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üìè</span>
                  <span>${event.distance}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üïê</span>
                  <span>ÊîæÈ£ûÔºö${event.releaseTime}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üå§Ô∏è</span>
                  <span>${event.weather}</span>
                </div>
              </div>
              <div class="event-card-progress">
                <div class="event-progress-bar">
                  <div class="event-progress-fill" style="width:${progressPercent}%;"></div>
                </div>
                <div class="event-progress-text">Â∑≤ÂΩíÂ∑¢ ${event.returned} / ${event.total} Âè™Ôºà${progressPercent}%Ôºâ</div>
              </div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
                <span>üì∞ Êù•Ê∫êÔºö${event.source || 'Êú™Áü•'}</span>
                <span>üïê Êõ¥Êñ∞Ôºö${updateTimeStr}</span>
              </div>
              ${event.sourceUrl && event.sourceUrl !== '#' ? `
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                <button class="btn btn-outline btn-sm" style="width:100%;" onclick="event.stopPropagation();window.open('${event.sourceUrl}', '_blank')">
                  üîó Êü•ÁúãÂéüËµõ‰∫ãÁΩëÈ°µ
                </button>
              </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } else if (tab === 'upcoming') {
        container.innerHTML = events.map(event => {
          const updateTimeStr = formatUpdateTime(event.updateTime);
          return `
            <div class="event-card" style="cursor:pointer;" onclick="openEventUrl('${event.sourceUrl || '#'}')">
              <div class="event-card-status upcoming">Âç≥Â∞ÜÂºÄÂßã</div>
              <div class="event-card-title">${event.name}</div>
              <div class="event-card-info">
                <div class="event-card-info-item">
                  <span>üè¢</span>
                  <span>${event.organizer}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üìè</span>
                  <span>${event.distance}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üïê</span>
                  <span>ÂºÄÂßãÔºö${event.startTime}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üïäÔ∏è</span>
                  <span>ÂèÇËµõÔºö${event.participants}Âè™</span>
                </div>
              </div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
                <span>üì∞ Êù•Ê∫êÔºö${event.source || 'Êú™Áü•'}</span>
                <span>üïê Êõ¥Êñ∞Ôºö${updateTimeStr}</span>
              </div>
              ${event.sourceUrl && event.sourceUrl !== '#' ? `
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                <button class="btn btn-outline btn-sm" style="width:100%;" onclick="event.stopPropagation();window.open('${event.sourceUrl}', '_blank')">
                  üîó Êü•ÁúãÂéüËµõ‰∫ãÁΩëÈ°µ
                </button>
              </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } else if (tab === 'results') {
        container.innerHTML = events.map(event => {
          const updateTimeStr = formatUpdateTime(event.updateTime);
          return `
            <div class="event-card" style="cursor:pointer;" onclick="openEventUrl('${event.sourceUrl || '#'}')">
              <div class="event-card-status completed">Â∑≤ÁªìÊùü</div>
              <div class="event-card-title">${event.name}</div>
              <div class="event-card-info">
                <div class="event-card-info-item">
                  <span>üè¢</span>
                  <span>${event.organizer}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üìè</span>
                  <span>${event.distance}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üïê</span>
                  <span>ÁªìÊùüÔºö${event.endTime}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üèÜ</span>
                  <span>ÂÜ†ÂÜõÔºö${event.champion} (${event.championRing})</span>
                </div>
                ${event.championTime ? `
                <div class="event-card-info-item">
                  <span>‚è±Ô∏è</span>
                  <span>ÊàêÁª©Ôºö${event.championTime}</span>
                </div>
                ` : ''}
              </div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
                <span>üì∞ Êù•Ê∫êÔºö${event.source || 'Êú™Áü•'}</span>
                <span>üïê Êõ¥Êñ∞Ôºö${updateTimeStr}</span>
              </div>
              ${event.sourceUrl && event.sourceUrl !== '#' ? `
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                <button class="btn btn-outline btn-sm" style="width:100%;" onclick="event.stopPropagation();window.open('${event.sourceUrl}', '_blank')">
                  üîó Êü•ÁúãÂéüËµõ‰∫ãÁΩëÈ°µ
                </button>
              </div>
              ` : ''}
            </div>
          `;
        }).join('');
      }
    }
    
    // ÊâìÂºÄËµõ‰∫ãÈìæÊé•ÔºàÊö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºâ
    window.openEventUrl = function(url) {
      if (url && url !== '#') {
        window.open(url, '_blank');
      }
    };
    
    // Ëá™Âä®Êõ¥Êñ∞Ëµõ‰∫ã
    async function updateEvents() {
      try {
        const events = await fetchEventsFromWeb();
        
        // ÂÜçÊ¨°È™åËØÅÂíåËøáÊª§Êï∞ÊçÆ
        const now = new Date();
        
        // ËøáÊª§ËøõË°å‰∏≠ÁöÑËµõ‰∫ã
        events.ongoing = events.ongoing.filter(event => {
          if (!event.releaseTimeFull) return false;
          const releaseTime = new Date(event.releaseTimeFull);
          if (releaseTime > now) return false;
          
          if (event.endTimeFull) {
            const endTime = new Date(event.endTimeFull);
            if (endTime <= now) return false;
          }
          
          if (event.updateTime) {
            const updateTime = new Date(event.updateTime);
            const hoursSinceUpdate = (now - updateTime) / (1000 * 60 * 60);
            if (hoursSinceUpdate > 2) return false;
          }
          
          return true;
        });
        
        // ËøáÊª§Âç≥Â∞ÜÂºÄÂßãÁöÑËµõ‰∫ã
        events.upcoming = events.upcoming.filter(event => {
          if (!event.startTimeFull) return false;
          const startTime = new Date(event.startTimeFull);
          return startTime > now;
        });
        
        // ËøáÊª§Â∑≤ÁªìÊùüÁöÑËµõ‰∫ã
        events.results = events.results.filter(event => {
          if (!event.endTimeFull) return false;
          const endTime = new Date(event.endTimeFull);
          return endTime <= now;
        });
        
        EVENTS_DATA = events;
        saveEventsToStorage();
        renderEventsList(currentEventTab, currentEventRegion);
        updateHomeStats();
        console.log('Ëµõ‰∫ãÊõ¥Êñ∞ÊàêÂäüÔºåÂÖ±Ëé∑Âèñ', 
          events.ongoing.length + events.upcoming.length + events.results.length, 
          'Âú∫ÊúâÊïàËµõ‰∫ã');
      } catch (error) {
        console.error('Êõ¥Êñ∞Ëµõ‰∫ãÂ§±Ë¥•:', error);
        
        // Â¶ÇÊûúAPIÊú™ÈÖçÁΩÆÔºåÊòæÁ§∫ÈÖçÁΩÆÊèêÁ§∫
        if (error.message && error.message.includes('Êú™ÈÖçÁΩÆ')) {
          EVENTS_DATA = { ongoing: [], upcoming: [], results: [] };
          renderEventsList(currentEventTab, currentEventRegion);
          showApiConfigPrompt('Ëµõ‰∫ã');
          return;
        }
        
        // Â¶ÇÊûúÊõ¥Êñ∞Â§±Ë¥•ÔºåÂ∞ùËØïÂä†ËΩΩÁºìÂ≠òÊï∞ÊçÆ
        if (loadEventsFromStorage()) {
          renderEventsList(currentEventTab, currentEventRegion);
        } else {
          // Ê≤°ÊúâÁºìÂ≠òÊï∞ÊçÆÔºåÊòæÁ§∫ÈîôËØØÊèêÁ§∫
          EVENTS_DATA = { ongoing: [], upcoming: [], results: [] };
          renderEventsList(currentEventTab, currentEventRegion);
        }
      }
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞Ëµõ‰∫ã
    function checkAndUpdateEvents() {
      const lastUpdate = localStorage.getItem('pigeon_events_last_update');
      if (!lastUpdate) {
        updateEvents();
        return;
      }
      
      const lastUpdateDate = new Date(lastUpdate);
      const now = new Date();
      const minutesSinceUpdate = (now - lastUpdateDate) / (1000 * 60);
      
      const hasOngoingEvents = (EVENTS_DATA.ongoing || []).length > 0;
      
      if (hasOngoingEvents) {
        if (minutesSinceUpdate >= 5) {
          updateEvents();
        } else {
          if (loadEventsFromStorage()) {
            renderEventsList(currentEventTab, currentEventRegion);
          } else {
            updateEvents();
          }
        }
      } else {
        if (minutesSinceUpdate >= 60) {
          updateEvents();
        } else {
          if (loadEventsFromStorage()) {
            renderEventsList(currentEventTab, currentEventRegion);
          } else {
            updateEvents();
          }
        }
      }
    }
    
    // Âä†ËΩΩ‰∏ªÈ°µÂÖ¨ÂëäÊ†è
    // Â≠òÂÇ®È¶ñÈ°µÂΩìÂâçÂÖ¨ÂëäÊï∞ÊçÆ
    let homeCurrentAnnouncement = null;
    
    async function loadHomeAnnouncementBubble() {
      const bubbleEl = document.getElementById('homeAnnouncementBubbleText');
      const hintEl = document.getElementById('homeAnnouncementHint');
      const bubbleContainer = document.getElementById('homeAnnouncementBubble');
      if (!bubbleEl) return;
      
      const token = localStorage.getItem('adminToken');
      if (!token) {
        bubbleEl.textContent = 'ÊöÇÊó†ÂÖ¨Âëä';
        homeCurrentAnnouncement = null;
        if (hintEl) hintEl.style.display = 'none';
        if (bubbleContainer) bubbleContainer.style.cursor = 'default';
        return;
      }
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`${getApiUrl()}/admin/announcements`, {
          headers: {
            'Authorization': `Bearer ${token}`
          },
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error('Ëé∑ÂèñÂÖ¨ÂëäÂ§±Ë¥•');
        }
        
        const result = await response.json();
        const announcements = result.data || [];
        
        // ‰øùÂ≠òÂÖ¨ÂëäÊï∞ÊçÆ‰æõÊü•Áúã‰ΩøÁî®
        window.announcementsData = announcements;
        
        // Ëé∑ÂèñÊúÄÊñ∞ÁöÑÂ∑≤ÂèëÂ∏ÉÂÖ¨Âëä
        const activeAnnouncements = announcements.filter(ann => ann.active);
        if (activeAnnouncements.length > 0) {
          // ÊåâÊõ¥Êñ∞Êó∂Èó¥ÊéíÂ∫èÔºåËé∑ÂèñÊúÄÊñ∞ÁöÑ
          activeAnnouncements.sort((a, b) => {
            const timeA = new Date(a.updatedAt || a.createdAt);
            const timeB = new Date(b.updatedAt || b.createdAt);
            return timeB - timeA;
          });
          
          const latestAnnouncement = activeAnnouncements[0];
          homeCurrentAnnouncement = latestAnnouncement;
          
          const content = latestAnnouncement.content || 'ÊöÇÊó†ÂÖ¨Âëä';
          
          // Â¶ÇÊûúÂÜÖÂÆπËæÉÈïøÔºåÊòæÁ§∫ÊèêÁ§∫
          if (content.length > 50) {
            if (hintEl) hintEl.style.display = 'inline';
            // ÈôêÂà∂ÊòæÁ§∫ÈïøÂ∫¶
            const maxLength = 80;
            if (content.length > maxLength) {
              bubbleEl.textContent = content.substring(0, maxLength) + '...';
            } else {
              bubbleEl.textContent = content;
            }
          } else {
            bubbleEl.textContent = content;
            if (hintEl) hintEl.style.display = 'none';
          }
          
          // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
          if (bubbleContainer) {
            bubbleContainer.style.cursor = 'pointer';
          }
        } else {
          bubbleEl.textContent = 'ÊöÇÊó†ÂÖ¨Âëä';
          homeCurrentAnnouncement = null;
          if (hintEl) hintEl.style.display = 'none';
          if (bubbleContainer) bubbleContainer.style.cursor = 'default';
        }
      } catch (error) {
        console.error('Âä†ËΩΩÂÖ¨ÂëäÂ§±Ë¥•:', error);
        bubbleEl.textContent = 'ÊöÇÊó†ÂÖ¨Âëä';
        homeCurrentAnnouncement = null;
        if (hintEl) hintEl.style.display = 'none';
      }
    }
    
    // ÊòæÁ§∫È¶ñÈ°µÂÖ¨ÂëäËØ¶ÊÉÖ
    window.showHomeAnnouncementDetail = function() {
      if (!homeCurrentAnnouncement) {
        console.warn('Ê≤°ÊúâÂèØÊòæÁ§∫ÁöÑÂÖ¨Âëä');
        return;
      }
      
      // ‰ΩøÁî®Â∑≤ÊúâÁöÑÊü•ÁúãÂÖ¨ÂëäÊ®°ÊÄÅÊ°ÜÂáΩÊï∞
      if (window.viewFullAnnouncement) {
        viewFullAnnouncement(homeCurrentAnnouncement.id);
      } else {
        // Â¶ÇÊûúviewFullAnnouncement‰∏çÂ≠òÂú®ÔºåÁõ¥Êé•ÊòæÁ§∫
        alert('ÂÖ¨ÂëäËØ¶ÊÉÖÂäüËÉΩÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢');
      }
    };
    
    // ÂàùÂßãÂåñÈ¶ñÈ°µËßÜÂõæ
    function initHomeView() {
      // Êõ¥Êñ∞È¶ñÈ°µÁªüËÆ°
      updateHomeStats();
      
      // Âä†ËΩΩ‰∏ªÈ°µÂÖ¨ÂëäÊ†è
      loadHomeAnnouncementBubble();
      
      // Ê£ÄÊü•Âπ∂Êõ¥Êñ∞ËµÑËÆØ
      checkAndUpdateNews();
      
      // Ê£ÄÊü•Âπ∂Êõ¥Êñ∞Ëµõ‰∫ã
      checkAndUpdateEvents();
      
      // ÁªëÂÆöËµÑËÆØÁ≠õÈÄâÊåâÈíÆ‰∫ã‰ª∂
      document.querySelectorAll('.news-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.news-filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentNewsFilter = btn.dataset.filter;
          renderNewsList(currentNewsFilter, currentNewsRegion);
        });
      });
      
      // Êú¨Âú∞/ÂÖ®ÂõΩËµÑËÆØÊ†áÁ≠æÈ°µÂàáÊç¢
      document.querySelectorAll('.news-region-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.news-region-tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentNewsRegion = btn.dataset.region;
          renderNewsList(currentNewsFilter, currentNewsRegion);
        });
      });
      
      // Âà∑Êñ∞ËµÑËÆØÊåâÈíÆ
      const btnRefreshNews = document.getElementById('btnRefreshNews');
      if (btnRefreshNews) {
        btnRefreshNews.addEventListener('click', () => {
          updateNews();
          alert('Ê≠£Âú®Âà∑Êñ∞ËµÑËÆØÔºåËØ∑Á®çÂÄô...');
        });
      }
      
      // ËµÑËÆØËØ¶ÊÉÖÂºπÁ™óÂÖ≥Èó≠‰∫ã‰ª∂
      const newsModalClose = document.getElementById('newsModalClose');
      const newsModalCloseBtn = document.getElementById('newsModalCloseBtn');
      const newsModal = document.getElementById('newsModal');
      
      if (newsModalClose) {
        newsModalClose.addEventListener('click', closeNewsModal);
      }
      if (newsModalCloseBtn) {
        newsModalCloseBtn.addEventListener('click', closeNewsModal);
      }
      if (newsModal) {
        newsModal.addEventListener('click', (e) => {
          if (e.target.id === 'newsModal') {
            closeNewsModal();
          }
        });
      }
      
      // Ëµõ‰∫ãÂú∞Âå∫Ê†áÁ≠æÈ°µÂàáÊç¢
      document.querySelectorAll('.event-region-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.event-region-tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentEventRegion = btn.dataset.region;
          renderEventsList(currentEventTab, currentEventRegion);
        });
      });
      
      // Ëµõ‰∫ãÊ†áÁ≠æÈ°µÂàáÊç¢
      document.querySelectorAll('.event-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.event-tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentEventTab = btn.dataset.tab;
          renderEventsList(currentEventTab, currentEventRegion);
        });
      });
      
      // Âà∑Êñ∞Ëµõ‰∫ãÊåâÈíÆ
      const btnRefreshEvents = document.getElementById('btnRefreshEvents');
      if (btnRefreshEvents) {
        btnRefreshEvents.addEventListener('click', () => {
          updateEvents();
          alert('Ê≠£Âú®Âà∑Êñ∞Ëµõ‰∫ãÊï∞ÊçÆÔºåËØ∑Á®çÂÄô...');
        });
      }
    }
    
    // ==========================================
    // üïäÔ∏è Evo Êô∫ËÉΩÂä©ÊâãËÆæÁΩÆÂäüËÉΩ
    // ==========================================
    
    const EVO_SETTINGS_KEY = 'evo_settings';
    const EVO_SYNC_KEY = 'evo_settings_sync';
    
    // ÈªòËÆ§ËÆæÁΩÆ
    const defaultEvoSettings = {
      enabled: true,
      position: 'bottom-right',
      displayMode: 'always',
      autoClose: 5,
      iconSize: 70,
      theme: 'purple',
      showWelcome: true,
      saveHistory: true,
      showAnalytics: true,
      showRecommendations: true,
      github: {
        repo: '',
        token: '',
        apiEndpoint: ''
      },
      functionGuides: {
        'È¶ñÈ°µ': {
          description: 'È¶ñÈ°µÊòØÁ≥ªÁªüÁöÑ‰ø°ÊÅØ‰∏≠ÂøÉ',
          features: [
            'üì∞ ËµõÈ∏ΩËµÑËÆØÔºöÊü•ÁúãÊúÄÊñ∞ÁöÑËµõÈ∏ΩÁõ∏ÂÖ≥ËµÑËÆØÔºåÂèØ‰ª•ÊåâÁ±ªÂûãÔºàÂÖ®ÈÉ®/Ëµõ‰∫ã/ËÇ≤Áßç/ÂÅ•Â∫∑ÔºâÂíåÂú∞Âå∫ÔºàÊú¨Âú∞/ÂÖ®ÂõΩÔºâÁ≠õÈÄâ',
            'üèÅ ÂÆûÊó∂Ëµõ‰∫ãÔºöÊü•ÁúãËøõË°å‰∏≠„ÄÅÂç≥Â∞ÜÂºÄÂßãÂíåÊúÄÊñ∞ÊàêÁª©ÁöÑËµõ‰∫ã‰ø°ÊÅØ',
            'üß† Êô∫ËÉΩÊé®ËçêÔºöÁ≥ªÁªüÊ†πÊçÆÊÇ®ÁöÑÊï∞ÊçÆÊèê‰æõ‰∏™ÊÄßÂåñÊé®Ëçê',
            '‚≠ê ÊàëÁöÑÂÖ≥Ê≥®ÔºöÁÆ°ÁêÜÊÇ®ÂÖ≥Ê≥®ÁöÑËµõÂå∫„ÄÅËµõ‰∫ãÁ±ªÂûãÁ≠â',
            'üöÄ Âø´Êç∑ÂÖ•Âè£ÔºöÂø´ÈÄüËÆøÈóÆÂ∏∏Áî®ÂäüËÉΩÔºàÊñ∞Â¢ûÈ∏ΩÂ≠ê„ÄÅÂΩïÂÖ•ÊàêÁª©„ÄÅÈÖçÂØπËØÑ‰º∞„ÄÅÊô∫ËÉΩÂàÜÊûêÔºâ',
            'üîî ‰ªäÊó•ÊèêÈÜíÔºöÊü•Áúã‰ªäÊó•ÁöÑÈáçË¶ÅÊèêÈÜí‰∫ãÈ°π'
          ]
        },
        'Êï∞ÊçÆÊ¶ÇËßà': {
          description: 'Êü•ÁúãÁ≥ªÁªüÁöÑÊï¥‰ΩìÊï∞ÊçÆÁªüËÆ°',
          features: [
            'üìä Ê†∏ÂøÉÊï∞ÊçÆÂç°ÁâáÔºöÊòæÁ§∫ÊÄªÈ∏ΩÂ≠êÊï∞„ÄÅÂú®‰∏ñ„ÄÅÂ∑≤Ê≠ª‰∫°„ÄÅÊúâÊàêÁª©„ÄÅÊ†∏ÂøÉÁßçÈ∏ΩÁ≠âÁªüËÆ°',
            'üìà Âπ¥Â∫¶ÁªüËÆ°ÔºöÊåâÂπ¥‰ªΩÊ±áÊÄªÂá∫ÁîüÊï∞Èáè„ÄÅÊ≠ª‰∫°Êï∞Èáè‰ª•ÂèäÊúâÂèÇËµõËÆ∞ÂΩïÁöÑÈ∏ΩÂ≠êÊï∞Èáè'
          ]
        },
        'È∏ΩÂ≠êÁÆ°ÁêÜ': {
          description: 'ÁÆ°ÁêÜÊÇ®ÁöÑ‰ø°È∏ΩÊ°£Ê°à',
          features: [
            'üìã Ë°®Ê†ºËßÜÂõæÔºö‰ª•Ë°®Ê†ºÂΩ¢ÂºèÊü•ÁúãÊâÄÊúâÈ∏ΩÂ≠ê‰ø°ÊÅØÔºåÂåÖÊã¨Ë∂≥ÁéØÂè∑„ÄÅÂêçÁß∞„ÄÅÁ±ªÂûã„ÄÅÁä∂ÊÄÅ„ÄÅÁà∂È∏Ω/ÊØçÈ∏Ω„ÄÅÁé∞È∏Ω‰∏ª„ÄÅÂèÇËµõËÆ∞ÂΩïÊï∞',
            'üÉè Âç°ÁâáËßÜÂõæÔºö‰ª•Âç°ÁâáÂΩ¢ÂºèÊü•ÁúãÈ∏ΩÂ≠ê‰ø°ÊÅØÔºåÊõ¥Áõ¥ËßÇÁæéËßÇ',
            '‚ûï Êñ∞Â¢ûÈ∏ΩÂ≠êÔºöÊ∑ªÂä†Êñ∞ÁöÑ‰ø°È∏ΩÊ°£Ê°à',
            'üîç Êü•ÁúãËØ¶ÊÉÖÔºöÁÇπÂáªÊü•ÁúãÊåâÈíÆÊü•ÁúãÈ∏ΩÂ≠êÁöÑËØ¶ÁªÜ‰ø°ÊÅØ'
          ]
        },
        'Ë°ÄÁªüÂÖ≥Á≥ª': {
          description: 'Êü•ÁúãÂíåÁÆ°ÁêÜ‰ø°È∏ΩÁöÑË°ÄÁªüÂÖ≥Á≥ªÊ†ë',
          features: [
            'üå≥ Ë°ÄÁªüÊ†ëÔºöÈÄâÊã©È∏ΩÂ≠êÊü•ÁúãÂÖ∂ÂÆåÊï¥ÁöÑË°ÄÁªüÂÖ≥Á≥ªÊ†ëÔºàÂåÖÊã¨‰∫≤‰ª£ÂíåÂ≠ê‰ª£Ôºâ',
            'üîç ÊêúÁ¥¢ÂäüËÉΩÔºöÈÄöËøáË∂≥ÁéØÂè∑ÊàñÂêçÂ≠óÊêúÁ¥¢È∏ΩÂ≠ê',
            'üìä ÁßçÈ∏ΩÊ†ëÔºöÊòæÁ§∫ÊâÄÊúâÁßçÈ∏ΩÁöÑÂÖ≥Á≥ªÊ†ë'
          ]
        },
        'ÁªüËÆ°ÂàÜÊûê': {
          description: 'Êü•ÁúãÂπ¥Â∫¶ÁªüËÆ°Êï∞ÊçÆ',
          features: [
            'üìà Âπ¥Â∫¶ÁªüËÆ°Ê¶ÇËßàÔºöÊåâÂπ¥‰ªΩÊ±áÊÄªÂá∫ÁîüÊï∞Èáè„ÄÅÊ≠ª‰∫°Êï∞Èáè‰ª•ÂèäÊúâÂèÇËµõËÆ∞ÂΩïÁöÑÈ∏ΩÂ≠êÊï∞Èáè',
            'üìä Êï∞ÊçÆË°®Ê†ºÔºö‰ª•Ë°®Ê†ºÂΩ¢ÂºèÂ±ïÁ§∫ÁªüËÆ°Êï∞ÊçÆ'
          ]
        },
        'ÊØîËµõ‰∏éÊàêÁª©': {
          description: 'ÁÆ°ÁêÜÊØîËµõÂíåÊàêÁª©ËÆ∞ÂΩï',
          features: [
            'üìã ÊØîËµõÂàóË°®ÔºöÊü•ÁúãÊâÄÊúâÊØîËµõ‰ø°ÊÅØÔºåÂåÖÊã¨ÊØîËµõÂêçÁß∞„ÄÅÊó•Êúü„ÄÅÂú∞ÁÇπ„ÄÅË∑ùÁ¶ª„ÄÅÁä∂ÊÄÅ„ÄÅÂèÇËµõÊï∞',
            'üì• ÂØºÂÖ•ÊàêÁª©Ôºö‰ªéExcelÊñá‰ª∂ÂØºÂÖ•ÊØîËµõÊàêÁª©',
            'üìä ÊØîËµõÁªüËÆ°ÔºöÊü•ÁúãÊØîËµõÁªüËÆ°Êï∞ÊçÆ',
            'üß† ÊàêÁª©ÂàÜÊûêÔºöÂàÜÊûêÊØîËµõÊàêÁª©Ë∂ãÂäø',
            'üß¨ Ë°ÄÁªüÂØπÊØîÔºöÂØπÊØî‰∏çÂêåË°ÄÁªüÁöÑÈ∏ΩÂ≠êË°®Áé∞'
          ]
        },
        'ÁπÅËÇ≤‰∏éÈÖçÂØπ': {
          description: 'ÁÆ°ÁêÜ‰ø°È∏ΩÁöÑÁπÅËÇ≤ÂíåÈÖçÂØπ',
          features: [
            'üíï ÈÖçÂØπÈÄâÊã©ÔºöÈÄâÊã©Áà∂È∏ΩÂíåÊØçÈ∏ΩËøõË°åÈÖçÂØπ',
            'üìä ÈÖçÂØπÂàÜÊûêÔºöÁ≥ªÁªüËá™Âä®ÂàÜÊûêÈÖçÂØπÂèØË°åÊÄß',
            '‚ûï Êñ∞Â¢ûÈÖçÂØπÔºöÊ∑ªÂä†Êñ∞ÁöÑÈÖçÂØπËÆ∞ÂΩï'
          ]
        },
        'ÂÅ•Â∫∑ÁÆ°ÁêÜ': {
          description: 'ÁÆ°ÁêÜ‰ø°È∏ΩÁöÑÂÅ•Â∫∑ËÆ∞ÂΩï',
          features: [
            'üìù ÂÅ•Â∫∑ËÆ∞ÂΩïÔºöËÆ∞ÂΩïÈ∏ΩÂ≠êÁöÑÂÅ•Â∫∑Áä∂ÊÄÅ„ÄÅÊó•Êúü„ÄÅÂ§áÊ≥®Á≠â‰ø°ÊÅØ',
            '‚ûï Êñ∞Â¢ûËÆ∞ÂΩïÔºöÊ∑ªÂä†Êñ∞ÁöÑÂÅ•Â∫∑ËÆ∞ÂΩï',
            'üìã ËÆ∞ÂΩïÂàóË°®ÔºöÊü•ÁúãÊâÄÊúâÂÅ•Â∫∑ËÆ∞ÂΩï'
          ]
        },
        'Êô∫ËÉΩÂàÜÊûê‰∏≠ÂøÉ': {
          description: '‰ΩøÁî®AIËøõË°åÊô∫ËÉΩÂàÜÊûê',
          features: [
            'üìä Ë°ÄÁªüÂàÜÊûêÔºöÂàÜÊûêÈ∏ΩÂ≠êÁöÑË°ÄÁªü‰ºòÂäøÂíåÈÅó‰º†ÁâπÂæÅ',
            'üèÜ ÊàêÁª©ÂàÜÊûêÔºöÂàÜÊûêÈ∏ΩÂ≠êÁöÑÊØîËµõË°®Áé∞ÂíåÊàêÁª©Ë∂ãÂäø',
            'üíï ÈÖçÂØπÂª∫ËÆÆÔºöÂü∫‰∫éAIÁÆóÊ≥ïÁöÑÊô∫ËÉΩÈÖçÂØπÊé®Ëçê'
          ]
        },
        'ËÆ≠ÁªÉÊ®°Âùó': {
          description: 'ÁÆ°ÁêÜ‰ø°È∏ΩÁöÑËÆ≠ÁªÉËÆ∞ÂΩï',
          features: [
            'üìù ËÆ≠ÁªÉËÆ∞ÂΩïÔºöËÆ∞ÂΩïËÆ≠ÁªÉÊó•Êúü„ÄÅÈ∏ΩÂ≠ê„ÄÅËÆ≠ÁªÉÁ±ªÂûã„ÄÅË∑ùÁ¶ª„ÄÅÁî®Êó∂Á≠â‰ø°ÊÅØ',
            '‚ûï Êñ∞Â¢ûËÆ∞ÂΩïÔºöÊ∑ªÂä†Êñ∞ÁöÑËÆ≠ÁªÉËÆ∞ÂΩï',
            'üìã ËÆ∞ÂΩïÂàóË°®ÔºöÊü•ÁúãÊâÄÊúâËÆ≠ÁªÉËÆ∞ÂΩï'
          ]
        },
        'ËÉΩÂäõÁªºÂêàÂàÜÊûê': {
          description: 'ÁªºÂêàÂàÜÊûêÈ∏ΩÂ≠êÁöÑÂêÑÈ°πËÉΩÂäõÊåáÊ†á',
          features: [
            'üèÜ ÊØîËµõËÉΩÂäõÔºöËØÑ‰º∞È∏ΩÂ≠êÁöÑÊØîËµõË°®Áé∞ËÉΩÂäõ',
            'üß¨ ÈÅó‰º†‰ª∑ÂÄºÔºöËØÑ‰º∞È∏ΩÂ≠êÁöÑÈÅó‰º†‰ª∑ÂÄº',
            'üí™ ÂÅ•Â∫∑ÊåáÊï∞ÔºöËØÑ‰º∞È∏ΩÂ≠êÁöÑÂÅ•Â∫∑Áä∂ÂÜµ',
            '‚≠ê ÁªºÂêàËØÑÂàÜÔºöÁªºÂêàÂêÑÈ°πÊåáÊ†áÁªôÂá∫ÊÄª‰ΩìËØÑÂàÜ'
          ]
        }
      }
    };
    
    // Âä†ËΩΩEvoËÆæÁΩÆ
    // ‰ªéÊúçÂä°Âô®Âä†ËΩΩEvoËÆæÁΩÆÔºàÁÆ°ÁêÜÂëòÊùÉÈôêÔºâ
    async function loadEvoSettings() {
      try {
        const token = getAuthToken();
        if (!token) {
          console.warn('Êú™ÁôªÂΩïÔºåÊó†Ê≥ïÂä†ËΩΩEvoËÆæÁΩÆ');
          return;
        }
        
        // ‰ªéÊúçÂä°Âô®Âä†ËΩΩËÆæÁΩÆ
        const response = await fetch(`${getApiUrl()}/admin/evo-settings`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        let settings = defaultEvoSettings;
        
        if (response.ok) {
          const result = await response.json();
          if (result.success && result.data) {
            settings = result.data;
            // ‰øùÂ≠òÂà∞localStorage‰Ωú‰∏∫ÁºìÂ≠ò
            localStorage.setItem(EVO_SETTINGS_KEY, JSON.stringify(settings));
          }
        } else {
          // Â¶ÇÊûúÊúçÂä°Âô®Âä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®localStorageÁºìÂ≠ò
          const saved = localStorage.getItem(EVO_SETTINGS_KEY);
          if (saved) {
            settings = JSON.parse(saved);
          }
        }
        
        // Â°´ÂÖÖË°®Âçï
        document.getElementById('evoEnabled').checked = settings.enabled !== false;
        document.getElementById('evoPosition').value = settings.position || 'bottom-right';
        document.getElementById('evoDisplayMode').value = settings.displayMode || 'always';
        document.getElementById('evoAutoClose').value = settings.autoClose || 5;
        
        // Ê∏≤ÊüìÂäüËÉΩ‰ΩøÁî®ËØ¥ÊòéÔºàÂ¶ÇÊûúÂáΩÊï∞Â≠òÂú®Ôºâ
        if (typeof renderFunctionGuides === 'function') {
          renderFunctionGuides(settings.functionGuides || defaultEvoSettings.functionGuides);
        }
        document.getElementById('evoIconSize').value = settings.iconSize || 70;
        document.getElementById('evoIconSizeValue').textContent = (settings.iconSize || 70) + 'px';
        
        // ËÆæÁΩÆ‰∏ªÈ¢òÂçïÈÄâÊåâÈíÆ
        const themeRadios = document.querySelectorAll('input[name="evoTheme"]');
        themeRadios.forEach(radio => {
          if (radio.value === (settings.theme || 'purple')) {
            radio.checked = true;
          }
        });
        
        document.getElementById('evoShowWelcome').checked = settings.showWelcome !== false;
        document.getElementById('evoSaveHistory').checked = settings.saveHistory !== false;
        document.getElementById('evoShowAnalytics').checked = settings.showAnalytics !== false;
        document.getElementById('evoShowRecommendations').checked = settings.showRecommendations !== false;
        
        // GitHubÈÖçÁΩÆ
        if (settings.github) {
          document.getElementById('evoGithubRepo').value = settings.github.repo || '';
          document.getElementById('evoGithubToken').value = settings.github.token || '';
          document.getElementById('evoGithubApiEndpoint').value = settings.github.apiEndpoint || '';
        }
        
        // ÂõæÊ†áÂ§ßÂ∞èÊªëÂùó‰∫ã‰ª∂
        const iconSizeSlider = document.getElementById('evoIconSize');
        if (iconSizeSlider) {
          iconSizeSlider.addEventListener('input', (e) => {
            document.getElementById('evoIconSizeValue').textContent = e.target.value + 'px';
          });
        }
      } catch (error) {
        console.error('Âä†ËΩΩEvoËÆæÁΩÆÂ§±Ë¥•:', error);
        // ‰ΩøÁî®localStorage‰Ωú‰∏∫Â§áÁî®
        const saved = localStorage.getItem(EVO_SETTINGS_KEY);
        if (saved) {
          const settings = JSON.parse(saved);
          document.getElementById('evoEnabled').checked = settings.enabled !== false;
          document.getElementById('evoPosition').value = settings.position || 'bottom-right';
          // ... ÂÖ∂‰ªñÂ≠óÊÆµÂ°´ÂÖÖÔºàÂêå‰∏äÔºâ
        }
      }
    }
    
    // Ê∏≤ÊüìÂäüËÉΩ‰ΩøÁî®ËØ¥Êòé
    function renderFunctionGuides(functionGuides) {
      const container = document.getElementById('functionGuidesContainer');
      if (!container) return;
      
      container.innerHTML = '';
      
      Object.entries(functionGuides).forEach(([funcName, guide]) => {
        const guideItem = document.createElement('div');
        guideItem.className = 'function-guide-item';
        guideItem.style.cssText = `
          border: 1px solid var(--border-medium);
          border-radius: 8px;
          padding: 16px;
          background: var(--bg-secondary);
        `;
        
        guideItem.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <h4 style="margin: 0; color: var(--text-primary);">${funcName}</h4>
            <button type="button" class="btn btn-sm btn-outline" onclick="editFunctionGuide('${funcName}')" style="padding: 4px 12px;">ÁºñËæë</button>
          </div>
          <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">${guide.description}</div>
          <div style="font-size: 13px; color: var(--text-muted);">
            <strong>ÂäüËÉΩÁÇπÔºö</strong>${guide.features.length} È°π
          </div>
        `;
        
        container.appendChild(guideItem);
      });
    }
    
    // ÁºñËæëÂäüËÉΩËØ¥Êòé
    window.editFunctionGuide = function(funcName) {
      const functionGuides = getFunctionGuidesFromSettings();
      const guide = functionGuides[funcName] || { description: '', features: [] };
      
      const description = prompt(`ÁºñËæë"${funcName}"ÁöÑÊèèËø∞Ôºö`, guide.description);
      if (description === null) return;
      
      const featuresStr = prompt(`ÁºñËæë"${funcName}"ÁöÑÂäüËÉΩÁÇπÔºàÊØèË°å‰∏Ä‰∏™ÔºâÔºö`, guide.features.join('\n'));
      if (featuresStr === null) return;
      
      const features = featuresStr.split('\n').filter(f => f.trim());
      
      functionGuides[funcName] = {
        description: description.trim(),
        features: features
      };
      
      renderFunctionGuides(functionGuides);
      showEvoSettingsStatus('ÂäüËÉΩËØ¥ÊòéÂ∑≤Êõ¥Êñ∞ÔºåËØ∑ÁÇπÂáª"‰øùÂ≠òËÆæÁΩÆ"‰øùÂ≠ò', 'info');
    };
    
    // ‰ªéËÆæÁΩÆ‰∏≠Ëé∑ÂèñÂäüËÉΩËØ¥Êòé
    function getFunctionGuidesFromSettings() {
      const container = document.getElementById('functionGuidesContainer');
      if (!container) return defaultEvoSettings.functionGuides;
      
      // ‰ªéÂΩìÂâçÊòæÁ§∫ÁöÑËÆæÁΩÆ‰∏≠Ëé∑ÂèñÔºàÂÆûÈôÖÂ∫îËØ•‰ªéË°®ÂçïÊàñËÆæÁΩÆÂØπË±°‰∏≠Ëé∑ÂèñÔºâ
      // ËøôÈáåÁÆÄÂåñÂ§ÑÁêÜÔºåÂÆûÈôÖÂ∫îËØ•Áª¥Êä§‰∏Ä‰∏™Áä∂ÊÄÅ
      try {
        const saved = localStorage.getItem(EVO_SETTINGS_KEY);
        if (saved) {
          const settings = JSON.parse(saved);
          return settings.functionGuides || defaultEvoSettings.functionGuides;
        }
      } catch (e) {}
      
      return defaultEvoSettings.functionGuides;
    }
    
    // ‰øùÂ≠òEvoËÆæÁΩÆÂà∞ÊúçÂä°Âô®ÔºàÁÆ°ÁêÜÂëòÊùÉÈôêÔºå‰∏ªÁ´ô‰ºöËá™Âä®ÂêåÊ≠•Ôºâ
    async function saveEvoSettings() {
      try {
        const settings = {
          enabled: document.getElementById('evoEnabled').checked,
          position: document.getElementById('evoPosition').value,
          displayMode: document.getElementById('evoDisplayMode').value,
          autoClose: parseInt(document.getElementById('evoAutoClose').value) || 5,
          iconSize: parseInt(document.getElementById('evoIconSize').value) || 70,
          theme: document.querySelector('input[name="evoTheme"]:checked')?.value || 'purple',
          showWelcome: document.getElementById('evoShowWelcome').checked,
          saveHistory: document.getElementById('evoSaveHistory').checked,
          showAnalytics: document.getElementById('evoShowAnalytics').checked,
          showRecommendations: document.getElementById('evoShowRecommendations').checked,
          github: {
            repo: document.getElementById('evoGithubRepo').value.trim(),
            token: document.getElementById('evoGithubToken').value.trim(),
            apiEndpoint: document.getElementById('evoGithubApiEndpoint').value.trim()
          },
          functionGuides: getFunctionGuidesFromSettings()
        };
        
        // Áõ¥Êé•‰øùÂ≠òÂà∞ÊúçÂä°Âô®ÔºàÁÆ°ÁêÜÂëòÊùÉÈôêÔºâ
        const token = getAuthToken();
        if (!token) {
          throw new Error('ËØ∑ÂÖàÁôªÂΩïÁÆ°ÁêÜÂëòË¥¶Âè∑');
        }
        
        const response = await fetch(`${getApiUrl()}/admin/evo-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(settings)
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            // ‰øùÂ≠òÂà∞localStorage‰Ωú‰∏∫ÁºìÂ≠ò
            localStorage.setItem(EVO_SETTINGS_KEY, JSON.stringify(result.data));
            
            // ËÆæÁΩÆÂêåÊ≠•Ê†áÂøóÔºå‰∏ªÁ´ô‰ºöËá™Âä®Ê£ÄÊµãÂπ∂ÂêåÊ≠•
            localStorage.setItem(EVO_SYNC_KEY, 'true');
            localStorage.setItem('evo_settings_sync_timestamp', Date.now().toString());
            
            showEvoSettingsStatus('‚úÖ ËÆæÁΩÆÂ∑≤‰øùÂ≠òÂà∞ÊúçÂä°Âô®ÔºÅ‰∏ªÁ´ôÂ∞ÜËá™Âä®Êõ¥Êñ∞„ÄÇ', 'success');
            console.log('‚úÖ EvoËÆæÁΩÆÂ∑≤‰øùÂ≠òÂà∞ÊúçÂä°Âô®Ôºå‰∏ªÁ´ôÂ∞ÜËá™Âä®ÂêåÊ≠•');
            
            return result.data;
          } else {
            throw new Error(result.error || '‰øùÂ≠òÂ§±Ë¥•');
          }
        } else {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || 'ÊúçÂä°Âô®ÂìçÂ∫îÈîôËØØ');
        }
      } catch (error) {
        console.error('‰øùÂ≠òEvoËÆæÁΩÆÂ§±Ë¥•:', error);
        showEvoSettingsStatus('‚ùå ‰øùÂ≠òÂ§±Ë¥•Ôºö' + error.message, 'error');
        return null;
      }
    }
    
    // ÈáçÁΩÆ‰∏∫ÈªòËÆ§ËÆæÁΩÆ
    function resetEvoSettings() {
      if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆ‰∏∫ÈªòËÆ§ËÆæÁΩÆÂêóÔºü')) {
        localStorage.removeItem(EVO_SETTINGS_KEY);
        loadEvoSettings();
        showEvoSettingsStatus('Â∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§ËÆæÁΩÆ', 'info');
      }
    }
    
    // ÂêåÊ≠•Âà∞‰∏ªÁ´ôÔºàÂ∑≤ÈõÜÊàêÂà∞saveEvoSettings‰∏≠ÔºåÊ≠§ÂáΩÊï∞‰øùÁïôÁî®‰∫éÊâãÂä®Ëß¶ÂèëÔºâ
    async function syncEvoSettingsToMainSite() {
      try {
        // ÂÖà‰øùÂ≠òËÆæÁΩÆ
        const settings = await saveEvoSettings();
        if (settings) {
          showEvoSettingsStatus('‚úÖ ËÆæÁΩÆÂ∑≤‰øùÂ≠òÂπ∂ÂêåÊ≠•ÔºÅ‰∏ªÁ´ôÂ∞ÜËá™Âä®Êõ¥Êñ∞„ÄÇ', 'success');
          
          // ÂèØÈÄâÔºöÊâìÂºÄ‰∏ªÁ´ôÊü•ÁúãÊïàÊûú
          const mainSiteUrl = window.location.origin.replace('/admin.html', '/index.html');
          if (confirm('ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅÊòØÂê¶Áé∞Âú®ÊâìÂºÄ‰∏ªÁ´ôÊü•ÁúãÊïàÊûúÔºü')) {
            window.open(mainSiteUrl, '_blank');
          }
        }
      } catch (error) {
        console.error('ÂêåÊ≠•Âà∞‰∏ªÁ´ôÂ§±Ë¥•:', error);
        showEvoSettingsStatus('‚ùå ÂêåÊ≠•Â§±Ë¥•Ôºö' + error.message, 'error');
      }
    }
    
    // ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
    function showEvoSettingsStatus(message, type = 'info') {
      const statusEl = document.getElementById('evoSettingsStatus');
      if (!statusEl) return;
      
      statusEl.style.display = 'block';
      statusEl.textContent = message;
      
      // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆÊ†∑Âºè
      statusEl.style.background = type === 'success' ? 'var(--success-light)' : 
                                  type === 'error' ? 'var(--danger-light)' : 
                                  'var(--primary-50)';
      statusEl.style.color = type === 'success' ? 'var(--success)' : 
                             type === 'error' ? 'var(--danger)' : 
                             'var(--primary)';
      statusEl.style.border = `1px solid ${type === 'success' ? 'var(--success)' : 
                                            type === 'error' ? 'var(--danger)' : 
                                            'var(--primary)'}`;
      
      // 3ÁßíÂêéËá™Âä®ÈöêËóè
      setTimeout(() => {
        statusEl.style.display = 'none';
      }, 3000);
    }
    
    // Âä†ËΩΩAIÊ®°Âûã‰ø°ÊÅØÔºàÊô∫ËÉΩÁÆ°ÁêÜÔºâ
    async function loadAdminAIModelInfo() {
      try {
        const token = getAuthToken();
        if (!token) return;
        
        const response = await fetch(`${getApiUrl()}/evo/model-info`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.data) {
            displayAdminAIModelInfo(data.data);
          }
        }
      } catch (error) {
        console.error('Âä†ËΩΩAIÊ®°Âûã‰ø°ÊÅØÂ§±Ë¥•:', error);
        // ‰ΩøÁî®ÈªòËÆ§‰ø°ÊÅØ
        displayAdminAIModelInfo({
          name: 'Zephyr-7B-Beta',
          provider: 'Hugging Face',
          source: 'https://huggingface.co/HuggingFaceH4/zephyr-7b-beta',
          free: true,
          features: ['ÂÆåÂÖ®ÂÖçË¥π‰ΩøÁî®', 'Êó†ÈúÄ‰ø°Áî®Âç°', 'ÊîØÊåÅ‰∏≠ÊñáÂØπËØù', 'È´òÊÄßËÉΩÂìçÂ∫î', 'ÂºÄÊ∫êÊ®°Âûã']
        });
      }
    }
    
    // ÊòæÁ§∫AIÊ®°Âûã‰ø°ÊÅØÔºàÊô∫ËÉΩÁÆ°ÁêÜÔºâ
    function displayAdminAIModelInfo(modelInfo) {
      if (!modelInfo) return;
      
      const nameEl = document.getElementById('adminAIModelName');
      const providerEl = document.getElementById('adminAIProvider');
      const sourceEl = document.getElementById('adminAISource');
      const statusEl = document.getElementById('adminAIStatus');
      const featuresEl = document.getElementById('adminAIFeatures');
      
      if (nameEl) nameEl.textContent = modelInfo.name || 'Êú™Áü•';
      if (providerEl) providerEl.textContent = modelInfo.provider || 'Êú™Áü•';
      if (sourceEl) {
        sourceEl.href = modelInfo.source || '#';
        sourceEl.textContent = modelInfo.source ? 'Êü•ÁúãÊ®°ÂûãËØ¶ÊÉÖ' : 'Êú™Áü•';
      }
      
      if (statusEl) {
        statusEl.textContent = modelInfo.free ? '‚úÖ ÂÖçË¥π‰ΩøÁî®' : 'üí∞ ‰ªòË¥π';
        statusEl.style.background = modelInfo.free ? 'rgba(76, 175, 80, 0.3)' : 'rgba(255, 152, 0, 0.3)';
      }
      
      if (featuresEl && modelInfo.features) {
        featuresEl.innerHTML = modelInfo.features.map(f => `‚Ä¢ ${f}`).join('<br>');
      }
    }
    
    // ÊµãËØïAIËøûÊé•ÔºàÊô∫ËÉΩÁÆ°ÁêÜÔºâ
    async function testAdminAIConnection() {
      const btn = document.getElementById('btnAdminTestAI');
      const statusEl = document.getElementById('adminAIStatus');
      
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'ÊµãËØï‰∏≠...';
      }
      
      if (statusEl) {
        statusEl.textContent = 'ÊµãËØï‰∏≠...';
        statusEl.style.background = 'rgba(255, 152, 0, 0.3)';
      }
      
      try {
        const token = getAuthToken();
        if (!token) {
          throw new Error('ËØ∑ÂÖàÁôªÂΩï');
        }
        
        const response = await fetch(`${getApiUrl()}/evo/test`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          if (statusEl) {
            statusEl.textContent = '‚úÖ ËøûÊé•Ê≠£Â∏∏';
            statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
          }
          alert('AI ËøûÊé•ÊµãËØïÊàêÂäüÔºÅ\n\nÊ®°ÂûãÔºö' + (data.data?.model || 'Êú™Áü•') + '\nÊèê‰æõÂïÜÔºö' + (data.data?.provider || 'Êú™Áü•'));
        } else {
          throw new Error(data.message || 'ËøûÊé•Â§±Ë¥•');
        }
      } catch (error) {
        if (statusEl) {
          statusEl.textContent = '‚ùå ËøûÊé•Â§±Ë¥•';
          statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
        }
        alert('AI ËøûÊé•ÊµãËØïÂ§±Ë¥•Ôºö' + error.message);
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'ÊµãËØï AI ËøûÊé•';
        }
      }
    }
    
    // Áî®Êà∑‰ø°ÊÅØÂíåËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÂáΩÊï∞
    // Âä†ËΩΩÁî®Êà∑ËÆæÁΩÆ
    function loadUserSettings() {
      try {
        const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
        return {
          avatar: settings.avatar || null,
          displayName: settings.displayName || null
        };
      } catch (e) {
        console.error('Âä†ËΩΩÁî®Êà∑ËÆæÁΩÆÂ§±Ë¥•:', e);
        return { avatar: null, displayName: null };
      }
    }
    
    // ‰øùÂ≠òÁî®Êà∑ËÆæÁΩÆ
    function saveUserSettings(settings) {
      try {
        localStorage.setItem('userSettings', JSON.stringify(settings));
        return true;
      } catch (e) {
        console.error('‰øùÂ≠òÁî®Êà∑ËÆæÁΩÆÂ§±Ë¥•:', e);
        return false;
      }
    }
    
    // Êõ¥Êñ∞È°∂ÈÉ®ÂØºËà™Ê†èÁöÑÁî®Êà∑ÊòæÁ§∫
    function updateTopBarUserDisplay() {
      const settings = loadUserSettings();
      const adminUserName = document.getElementById('adminUserName');
      const btnUserAvatar = document.getElementById('btnUserAvatar');
      
      // Êõ¥Êñ∞Áî®Êà∑ÂêçÊòæÁ§∫
      if (adminUserName) {
        const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
        const displayName = settings.displayName || userInfo.username || 'ÁÆ°ÁêÜÂëò';
        adminUserName.textContent = `Ê¨¢ËøéÔºå${displayName}`;
      }
      
      // Êõ¥Êñ∞Ë¥¶Êà∑ÊåâÈíÆ
      if (btnUserAvatar) {
        const avatarSpan = btnUserAvatar.querySelector('span:first-child');
        const textSpan = btnUserAvatar.querySelector('span:last-child');
        
        if (settings.avatar) {
          // Â¶ÇÊûúÊúâËá™ÂÆö‰πâÂ§¥ÂÉèÔºåÊòæÁ§∫Â§¥ÂÉèÂõæÁâá
          if (!avatarSpan || avatarSpan.textContent === 'üë§') {
            const img = document.createElement('img');
            img.src = settings.avatar;
            img.style.cssText = 'width:20px;height:20px;border-radius:50%;object-fit:cover;';
            if (avatarSpan) {
              avatarSpan.replaceWith(img);
            } else {
              btnUserAvatar.insertBefore(img, textSpan);
            }
          } else if (avatarSpan.tagName === 'IMG') {
            avatarSpan.src = settings.avatar;
          }
        } else {
          // Â¶ÇÊûúÊ≤°ÊúâËá™ÂÆö‰πâÂ§¥ÂÉèÔºåÊòæÁ§∫ÈªòËÆ§ÂõæÊ†á
          if (avatarSpan && avatarSpan.tagName === 'IMG') {
            const span = document.createElement('span');
            span.textContent = 'üë§';
            span.style.fontSize = '16px';
            avatarSpan.replaceWith(span);
          }
        }
        
        if (textSpan) {
          const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
          const displayName = settings.displayName || userInfo.username || 'Ë¥¶Êà∑';
          textSpan.textContent = displayName.length > 8 ? displayName.substring(0, 8) + '...' : displayName;
        }
      }
    }
    
    window.showUserInfoModal = function() {
      const modal = document.getElementById('userInfoModal');
      if (!modal) return;
      
      // ÂàáÊç¢Âà∞Êü•ÁúãÊ®°Âºè
      document.getElementById('userInfoViewMode').style.display = 'block';
      document.getElementById('userInfoEditMode').style.display = 'none';
      
      // ‰ªélocalStorageÊàñÂΩìÂâçÁôªÂΩï‰ø°ÊÅØËé∑ÂèñÁî®Êà∑Êï∞ÊçÆ
      const adminUserName = document.getElementById('adminUserName')?.textContent || '';
      const userNameMatch = adminUserName.match(/Ê¨¢ËøéÔºå(.+)/);
        const defaultUserName = userNameMatch ? userNameMatch[1] : 'ÁÆ°ÁêÜÂëò';
      
      // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÔºà‰ªélocalStorageÊàñAPIÔºâ
      const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
      const userSettings = loadUserSettings();
      const userName = userSettings.displayName || defaultUserName;
      const userEmail = userInfo.email || 'admin@example.com';
      const userType = userInfo.type || 'ÁÆ°ÁêÜÂëò';
      const registerDate = userInfo.registerDate || new Date().toISOString().split('T')[0];
      const userRole = userInfo.role || 'ÁÆ°ÁêÜÂëò';
      
      // Êõ¥Êñ∞ÊòæÁ§∫
      const avatarDisplay = document.getElementById('userAvatarDisplay');
      if (userSettings.avatar) {
        avatarDisplay.style.backgroundImage = `url(${userSettings.avatar})`;
        avatarDisplay.textContent = '';
      } else {
        avatarDisplay.style.backgroundImage = '';
        avatarDisplay.textContent = 'üë§';
      }
      
      document.getElementById('userNameDisplay').textContent = userName;
      document.getElementById('userEmailDisplay').textContent = userEmail;
      document.getElementById('userTypeDisplay').textContent = userType;
      document.getElementById('userRegisterDate').textContent = registerDate;
      document.getElementById('userRoleDisplay').textContent = userRole;
      
      // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
      modal.style.display = 'flex';
    };
    
    // ËøõÂÖ•ÁºñËæëÊ®°Âºè
    window.enterEditUserInfoMode = function() {
      document.getElementById('userInfoViewMode').style.display = 'none';
      document.getElementById('userInfoEditMode').style.display = 'block';
      
      // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
      const userSettings = loadUserSettings();
      const adminUserName = document.getElementById('adminUserName')?.textContent || '';
      const userNameMatch = adminUserName.match(/Ê¨¢ËøéÔºå(.+)/);
        const defaultUserName = userNameMatch ? userNameMatch[1] : 'ÁÆ°ÁêÜÂëò';
      const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
      
      // ËÆæÁΩÆÂ§¥ÂÉèÊòæÁ§∫
      const avatarEditDisplay = document.getElementById('userAvatarEditDisplay');
      if (userSettings.avatar) {
        avatarEditDisplay.style.backgroundImage = `url(${userSettings.avatar})`;
        avatarEditDisplay.textContent = '';
      } else {
        avatarEditDisplay.style.backgroundImage = '';
        avatarEditDisplay.textContent = 'üë§';
      }
      
      // ËÆæÁΩÆÂêçÂ≠óËæìÂÖ•Ê°Ü
      document.getElementById('userNameInput').value = userSettings.displayName || defaultUserName;
      
      // ÁªëÂÆöÂ§¥ÂÉè‰∏ä‰º†‰∫ã‰ª∂
      const avatarInput = document.getElementById('userAvatarInput');
      if (avatarInput) {
        avatarInput.onchange = function(e) {
          const file = e.target.files[0];
          if (file) {
            // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂‰∏∫2MBÔºâ
            if (file.size > 2 * 1024 * 1024) {
              alert('Â§¥ÂÉèÊñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá2MB');
              return;
            }
            
            // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
            if (!file.type.startsWith('image/')) {
              alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂');
              return;
            }
            
            // ËØªÂèñÊñá‰ª∂Âπ∂ËΩ¨Êç¢‰∏∫base64
            const reader = new FileReader();
            reader.onload = function(e) {
              const base64 = e.target.result;
              avatarEditDisplay.style.backgroundImage = `url(${base64})`;
              avatarEditDisplay.textContent = '';
            };
            reader.readAsDataURL(file);
          }
        };
      }
    };
    
    // ÂèñÊ∂àÁºñËæë
    window.cancelEditUserInfo = function() {
      document.getElementById('userInfoViewMode').style.display = 'block';
      document.getElementById('userInfoEditMode').style.display = 'none';
      showUserInfoModal(); // ÈáçÊñ∞Âä†ËΩΩÊòæÁ§∫
    };
    
    // ‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØ
    window.saveUserInfo = function() {
      const userNameInput = document.getElementById('userNameInput');
      const avatarInput = document.getElementById('userAvatarInput');
      const avatarEditDisplay = document.getElementById('userAvatarEditDisplay');
      
      const displayName = userNameInput.value.trim();
      if (!displayName) {
        alert('ËØ∑ËæìÂÖ•ÊòµÁß∞');
        return;
      }
      
      // Ëé∑ÂèñÂ§¥ÂÉèÔºàbase64Ôºâ
      let avatar = null;
      if (avatarEditDisplay.style.backgroundImage && avatarEditDisplay.style.backgroundImage !== 'none') {
        avatar = avatarEditDisplay.style.backgroundImage.replace('url("', '').replace('")', '').replace("url('", '').replace("')", '');
      }
      
      // ‰øùÂ≠òËÆæÁΩÆ
      const success = saveUserSettings({
        avatar: avatar,
        displayName: displayName
      });
      
      if (success) {
        // Êõ¥Êñ∞È°∂ÈÉ®ÂØºËà™Ê†è
        updateTopBarUserDisplay();
        
        // ÂàáÊç¢ÂõûÊü•ÁúãÊ®°ÂºèÂπ∂Âà∑Êñ∞
        cancelEditUserInfo();
        alert('‰øùÂ≠òÊàêÂäüÔºÅ');
      } else {
        alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
      }
    };
    
    window.closeUserInfoModal = function() {
      const modal = document.getElementById('userInfoModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };
    
    window.showSettingsModal = function() {
      const modal = document.getElementById('settingsModal');
      if (!modal) return;
      modal.style.display = 'flex';
      // Êõ¥Êñ∞‰∏ªÈ¢òÊåâÈíÆÊñáÊú¨
      const themeBtn = document.getElementById('btnToggleThemeInModal');
      if (themeBtn) {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        themeBtn.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è ÊµÖËâ≤Ê®°Âºè' : 'üåô Â§úÈó¥Ê®°Âºè';
        themeBtn.title = currentTheme === 'dark' ? 'ÂàáÊç¢Âà∞ÊµÖËâ≤Ê®°Âºè' : 'ÂàáÊç¢Âà∞Ê∑±Ëâ≤Ê®°Âºè';
      }
    };
    
    window.closeSettingsModal = function() {
      const modal = document.getElementById('settingsModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };
    
    // Êï∞ÊçÆÂØºÂá∫ÂíåÂØºÂÖ•ÂäüËÉΩ
    window.exportAllData = function() {
      try {
        // ‰ªélocalStorageËØªÂèñ‰∏ªÁ´ôÊï∞ÊçÆ
        const pigeonsData = JSON.parse(localStorage.getItem('pigeons') || '[]');
        const racesData = JSON.parse(localStorage.getItem('races') || '[]');
        const pairingsData = JSON.parse(localStorage.getItem('pairings') || '[]');
        const healthRecordsData = JSON.parse(localStorage.getItem('healthRecords') || '[]');
        const usedNamesData = JSON.parse(localStorage.getItem('usedNames') || '[]');
        const ownerRegionPairsData = JSON.parse(localStorage.getItem('ownerRegionPairs') || '[]');
        
        const exportData = {
          version: '2.0',
          exportDate: new Date().toISOString(),
          data: {
            pigeons: pigeonsData,
            races: racesData,
            pairings: pairingsData,
            healthRecords: healthRecordsData,
            usedNames: usedNamesData,
            ownerRegionPairs: ownerRegionPairsData
          }
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pigeon_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('Êï∞ÊçÆÂ§á‰ªΩÂ∑≤‰∏ãËΩΩÔºÅ\n\nÂ§á‰ªΩ‰∫Ü ' + pigeonsData.length + ' Âè™È∏ΩÂ≠êÁöÑÊï∞ÊçÆ„ÄÇ\nËØ∑Â¶•ÂñÑ‰øùÁÆ°Â§á‰ªΩÊñá‰ª∂„ÄÇ');
      } catch (error) {
        console.error('ÂØºÂá∫Êï∞ÊçÆÂ§±Ë¥•:', error);
        alert('ÂØºÂá∫Êï∞ÊçÆÂ§±Ë¥•Ôºö' + error.message);
      }
    };
    
    window.importBackupData = function(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const backupData = JSON.parse(e.target.result);
          
          if (!backupData.data || !backupData.data.pigeons) {
            alert('Êó†ÊïàÁöÑÂ§á‰ªΩÊñá‰ª∂Ê†ºÂºè');
            return;
          }
          
          if (!confirm(`Á°ÆÂÆöË¶ÅÊÅ¢Â§çÂ§á‰ªΩÊï∞ÊçÆÂêóÔºü\n\nÂ§á‰ªΩÊó∂Èó¥: ${backupData.exportDate}\nÈ∏ΩÂ≠êÊï∞Èáè: ${backupData.data.pigeons.length}\nÊØîËµõÊï∞Èáè: ${backupData.data.races?.length || 0}\n\n‚ö†Ô∏è ËøôÂ∞ÜË¶ÜÁõñÂΩìÂâçÊâÄÊúâÊï∞ÊçÆÔºÅ`)) {
            return;
          }
          
          // ÊÅ¢Â§çÊï∞ÊçÆÂà∞localStorage
          localStorage.setItem('pigeons', JSON.stringify(backupData.data.pigeons));
          
          if (backupData.data.races) {
            localStorage.setItem('races', JSON.stringify(backupData.data.races));
          }
          
          if (backupData.data.pairings) {
            localStorage.setItem('pairings', JSON.stringify(backupData.data.pairings));
          }
          
          if (backupData.data.healthRecords) {
            localStorage.setItem('healthRecords', JSON.stringify(backupData.data.healthRecords));
          }
          
          if (backupData.data.usedNames) {
            localStorage.setItem('usedNames', JSON.stringify(backupData.data.usedNames));
          }
          
          if (backupData.data.ownerRegionPairs) {
            localStorage.setItem('ownerRegionPairs', JSON.stringify(backupData.data.ownerRegionPairs));
          }
          
          alert('Êï∞ÊçÆÊÅ¢Â§çÊàêÂäüÔºÅ\n\nÂ∑≤ÊÅ¢Â§ç ' + backupData.data.pigeons.length + ' Âè™È∏ΩÂ≠êÁöÑÊï∞ÊçÆ„ÄÇ\nËØ∑Âà∑Êñ∞È°µÈù¢Êü•ÁúãÊõ¥Êñ∞„ÄÇ');
        } catch (error) {
          console.error('ÂØºÂÖ•Êï∞ÊçÆÂ§±Ë¥•:', error);
          alert('ÂØºÂÖ•Êï∞ÊçÆÂ§±Ë¥•Ôºö' + error.message);
        }
      };
      reader.readAsText(file);
    };
    
    // ÂàùÂßãÂåñÁî®Êà∑‰ø°ÊÅØÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
    function initAdminUserInfo() {
      const userInfo = localStorage.getItem('adminUserInfo');
      if (!userInfo) {
        const adminUserName = document.getElementById('adminUserName')?.textContent || '';
        const userNameMatch = adminUserName.match(/Ê¨¢ËøéÔºå(.+)/);
        const userName = userNameMatch ? userNameMatch[1] : 'ÁÆ°ÁêÜÂëò';
        
        const defaultUserInfo = {
          name: userName,
          email: 'admin@example.com',
          type: 'ÁÆ°ÁêÜÂëò',
          role: 'ÁÆ°ÁêÜÂëò',
          registerDate: new Date().toISOString().split('T')[0]
        };
        localStorage.setItem('adminUserInfo', JSON.stringify(defaultUserInfo));
      }
    }
    
    // ÁªëÂÆöÁî®Êà∑Â§¥ÂÉèÂíåËÆæÁΩÆÊåâÈíÆ‰∫ã‰ª∂
    function bindUserButtons() {
      // ÁªëÂÆöÁî®Êà∑Â§¥ÂÉèÊåâÈíÆ
      const btnUserAvatar = document.getElementById('btnUserAvatar');
      if (btnUserAvatar) {
        btnUserAvatar.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          showUserInfoModal();
        });
        
        // È°µÈù¢Âä†ËΩΩÊó∂Êõ¥Êñ∞È°∂ÈÉ®ÂØºËà™Ê†èÁöÑÁî®Êà∑ÊòæÁ§∫
        updateTopBarUserDisplay();
      }
      
      // ÁªëÂÆöËÆæÁΩÆÊåâÈíÆ
      const btnSettings = document.getElementById('btnSettings');
      if (btnSettings) {
        btnSettings.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          showSettingsModal();
        });
      }
      
      // ÁªëÂÆöËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÂÜÖÁöÑÊåâÈíÆ
      const btnToggleThemeInModal = document.getElementById('btnToggleThemeInModal');
      if (btnToggleThemeInModal) {
        btnToggleThemeInModal.addEventListener('click', function() {
          const themeToggle = document.getElementById('themeToggle');
          if (themeToggle) {
            themeToggle.click();
          }
          // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨
          setTimeout(() => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            btnToggleThemeInModal.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è ÊµÖËâ≤Ê®°Âºè' : 'üåô Â§úÈó¥Ê®°Âºè';
            btnToggleThemeInModal.title = currentTheme === 'dark' ? 'ÂàáÊç¢Âà∞ÊµÖËâ≤Ê®°Âºè' : 'ÂàáÊç¢Âà∞Ê∑±Ëâ≤Ê®°Âºè';
          }, 100);
        });
      }
      
      // ÁªëÂÆöÊï∞ÊçÆÁÆ°ÁêÜÊåâÈíÆ
      const btnBackupDataInModal = document.getElementById('btnBackupDataInModal');
      if (btnBackupDataInModal) {
        btnBackupDataInModal.addEventListener('click', function() {
          exportAllData();
        });
      }
      
      const btnExportDataInModal = document.getElementById('btnExportDataInModal');
      if (btnExportDataInModal) {
        btnExportDataInModal.addEventListener('click', function() {
          exportAllData();
        });
      }
      
      const btnImportDataInModal = document.getElementById('btnImportDataInModal');
      if (btnImportDataInModal) {
        btnImportDataInModal.addEventListener('click', function() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
              importBackupData(file);
            }
          };
          input.click();
        });
      }
      
      // ÁªëÂÆöÈÄÄÂá∫ÁôªÂΩïÊåâÈíÆÔºàÂú®ËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÂÜÖÔºâ
      const logoutBtnInModal = document.getElementById('logoutBtnInModal');
      if (logoutBtnInModal) {
        logoutBtnInModal.addEventListener('click', function() {
          localStorage.removeItem('adminToken');
          localStorage.removeItem('adminUser');
          const loginPage = document.getElementById('loginPage');
          const adminPage = document.getElementById('adminPage');
          if (loginPage) loginPage.style.display = 'flex';
          if (adminPage) adminPage.style.display = 'none';
          const usernameInput = document.getElementById('username');
          const passwordInput = document.getElementById('password');
          if (usernameInput) usernameInput.value = '';
          if (passwordInput) passwordInput.value = '';
          closeSettingsModal();
        });
      }
      
      // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠
      const userInfoModal = document.getElementById('userInfoModal');
      const settingsModal = document.getElementById('settingsModal');
      
      if (userInfoModal) {
        userInfoModal.addEventListener('click', function(e) {
          if (e.target === userInfoModal) {
            closeUserInfoModal();
          }
        });
      }
      
      if (settingsModal) {
        settingsModal.addEventListener('click', function(e) {
          if (e.target === settingsModal) {
            closeSettingsModal();
          }
        });
      }
      
      // ESCÈîÆÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeUserInfoModal();
          closeSettingsModal();
        }
      });
    }
    
    // ÁªëÂÆöEvoËÆæÁΩÆÊåâÈíÆ‰∫ã‰ª∂
    document.addEventListener('DOMContentLoaded', () => {
      // ÂàùÂßãÂåñÁî®Êà∑‰ø°ÊÅØ
      initAdminUserInfo();
      
      // ÁªëÂÆöÁî®Êà∑ÊåâÈíÆ
      bindUserButtons();
      
      // Âª∂ËøüÁªëÂÆöÔºåÁ°Æ‰øùÁî®Êà∑ÂêçÂ∑≤Âä†ËΩΩ
      setTimeout(() => {
        initAdminUserInfo();
      }, 1000);
      const btnSave = document.getElementById('btnSaveEvoSettings');
      const btnReset = document.getElementById('btnResetEvoSettings');
      const btnSync = document.getElementById('btnSyncEvoSettings');
      const btnTestAI = document.getElementById('btnAdminTestAI');
      
      if (btnSave) {
        btnSave.addEventListener('click', saveEvoSettings);
      }
      
      if (btnReset) {
        btnReset.addEventListener('click', resetEvoSettings);
      }
      
      if (btnSync) {
        btnSync.addEventListener('click', syncEvoSettingsToMainSite);
      }
      
      if (btnTestAI) {
        btnTestAI.addEventListener('click', testAdminAIConnection);
      }
      
      // ÂΩìÂàáÊç¢Âà∞EvoËÆæÁΩÆÊ†áÁ≠æÊó∂ÔºåÂä†ËΩΩAIÊ®°Âûã‰ø°ÊÅØ
      const evoSettingsTab = document.getElementById('evoSettingsTab');
      if (evoSettingsTab) {
        // Á´ãÂç≥Âä†ËΩΩ‰∏ÄÊ¨°ÔºàÂ¶ÇÊûúÊ†áÁ≠æÈ°µÂ∑≤ÁªèÊòæÁ§∫Ôºâ
        if (evoSettingsTab.style.display !== 'none') {
          console.log('üîÑ EvoËÆæÁΩÆÈ°µÈù¢Â∑≤ÊòæÁ§∫ÔºåÁ´ãÂç≥Âä†ËΩΩAI‰ø°ÊÅØ...');
          setTimeout(() => {
            loadAdminAIModelInfo();
            loadEvoAIModelInfo();
          }, 200);
        }
        
        const observer = new MutationObserver((mutations) => {
          if (evoSettingsTab.style.display !== 'none') {
            console.log('üîÑ EvoËÆæÁΩÆÈ°µÈù¢ÊòæÁ§∫ÔºåÂä†ËΩΩAI‰ø°ÊÅØ...');
            setTimeout(() => {
              loadAdminAIModelInfo();
              loadEvoAIModelInfo();
            }, 200);
          }
        });
        observer.observe(evoSettingsTab, { attributes: true, attributeFilter: ['style'] });
        
        // ÁõëÂê¨ÊâÄÊúâÂèØËÉΩÁöÑÊ†áÁ≠æÂàáÊç¢ÊñπÂºè
        // ÊñπÂºè1ÔºöÈÄöËøáÂØºËà™ËèúÂçï
        document.querySelectorAll('[data-tab="evoSettings"], [onclick*="evoSettings"]').forEach(el => {
          el.addEventListener('click', () => {
            setTimeout(() => {
              if (evoSettingsTab.style.display !== 'none') {
                console.log('üîÑ ÁÇπÂáªEvoËÆæÁΩÆÊ†áÁ≠æÔºåÂä†ËΩΩAI‰ø°ÊÅØ...');
                loadEvoAIModelInfo();
              }
            }, 300);
          });
        });
        
        // ÊñπÂºè2ÔºöÈÄöËøá‰æßËæπÊ†èÁÇπÂáª
        const sidebarLinks = document.querySelectorAll('a, .nav-item, .menu-item');
        sidebarLinks.forEach(link => {
          if (link.textContent && link.textContent.includes('EvoËÆæÁΩÆ')) {
            link.addEventListener('click', () => {
              setTimeout(() => {
                if (evoSettingsTab.style.display !== 'none') {
                  console.log('üîÑ ÈÄöËøá‰æßËæπÊ†èÊâìÂºÄEvoËÆæÁΩÆÔºåÂä†ËΩΩAI‰ø°ÊÅØ...');
                  loadEvoAIModelInfo();
                }
              }, 300);
            });
          }
        });
      }
      
      // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêé‰πüÂ∞ùËØïÂä†ËΩΩ‰∏ÄÊ¨°
      if (document.readyState === 'complete') {
        setTimeout(() => {
          if (evoSettingsTab && evoSettingsTab.style.display !== 'none') {
            console.log('üîÑ È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÊ£ÄÊü•EvoËÆæÁΩÆÈ°µÈù¢...');
            loadEvoAIModelInfo();
          }
        }, 1000);
      } else {
        window.addEventListener('load', () => {
          setTimeout(() => {
            if (evoSettingsTab && evoSettingsTab.style.display !== 'none') {
              console.log('üîÑ Á™óÂè£Âä†ËΩΩÂÆåÊàêÔºåÊ£ÄÊü•EvoËÆæÁΩÆÈ°µÈù¢...');
              loadEvoAIModelInfo();
            }
          }, 1000);
        });
      }
      
      // ÁªëÂÆöEvoËÆæÁΩÆÈ°µÈù¢ÁöÑAI‰ø°ÊÅØÊåâÈíÆ
      const btnRefreshAI = document.getElementById('btnEvoRefreshAIInfo');
      const btnTestEvoAI = document.getElementById('btnEvoTestAI');
      
      if (btnRefreshAI) {
        btnRefreshAI.addEventListener('click', () => {
          console.log('üîÑ ÊâãÂä®Âà∑Êñ∞AI‰ø°ÊÅØÊåâÈíÆË¢´ÁÇπÂáª');
          loadEvoAIModelInfo();
          const statusEl = document.getElementById('evoAIInfoStatus');
          if (statusEl) {
            statusEl.style.display = 'block';
            statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
            statusEl.style.color = 'var(--text-primary)';
            statusEl.textContent = '‚úÖ AI‰ø°ÊÅØÂ∑≤Âà∑Êñ∞';
            setTimeout(() => {
              statusEl.style.display = 'none';
            }, 2000);
          }
        });
      }
      
      // Á°Æ‰øùÈ°µÈù¢Âä†ËΩΩÊó∂‰πüÂ∞ùËØïÂä†ËΩΩAI‰ø°ÊÅØ
      setTimeout(() => {
        const evoSettingsTab = document.getElementById('evoSettingsTab');
        if (evoSettingsTab && evoSettingsTab.style.display !== 'none') {
          console.log('üîÑ EvoËÆæÁΩÆÈ°µÈù¢ÂèØËßÅÔºåËá™Âä®Âä†ËΩΩAI‰ø°ÊÅØ');
          loadEvoAIModelInfo();
        }
      }, 1000);
      
      if (btnTestEvoAI) {
        btnTestEvoAI.addEventListener('click', async () => {
          btnTestEvoAI.disabled = true;
          btnTestEvoAI.textContent = 'ÊµãËØï‰∏≠...';
          
          const statusEl = document.getElementById('evoAIInfoStatus');
          if (statusEl) {
            statusEl.style.display = 'block';
            statusEl.style.background = 'rgba(255, 152, 0, 0.3)';
            statusEl.textContent = 'üîÑ Ê≠£Âú®ÊµãËØïAIËøûÊé•...';
          }
          
          try {
            const token = getAuthToken();
            if (!token) {
              throw new Error('ËØ∑ÂÖàÁôªÂΩï');
            }
            
            const response = await fetch(`${getApiUrl()}/evo/test`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              }
            });
            
            const result = await response.json();
            
            if (statusEl) {
              if (result.success) {
                statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
                statusEl.textContent = `‚úÖ ${result.message || 'AIËøûÊé•ÊµãËØïÊàêÂäüÔºÅ'}`;
              } else {
                statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
                statusEl.textContent = `‚ùå ${result.message || 'AIËøûÊé•ÊµãËØïÂ§±Ë¥•'}`;
              }
            }
          } catch (error) {
            if (statusEl) {
              statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
              statusEl.textContent = `‚ùå ÊµãËØïÂ§±Ë¥•: ${error.message}`;
            }
          } finally {
            btnTestEvoAI.disabled = false;
            btnTestEvoAI.textContent = 'üß™ ÊµãËØïËøûÊé•';
          }
        });
      }
    });
    
    // Ëé∑ÂèñtokenÂáΩÊï∞ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
    function getAuthToken() {
      // ‰ºòÂÖà‰ΩøÁî®adminTokenÔºàÊô∫ËÉΩÁÆ°ÁêÜÁ≥ªÁªü‰ΩøÁî®ÁöÑtokenÔºâ
      const adminToken = localStorage.getItem('adminToken');
      if (adminToken) {
        return adminToken;
      }
      // Â¶ÇÊûúÊ≤°ÊúâadminTokenÔºåÂ∞ùËØï‰ΩøÁî®tokenÔºà‰∏ªÁ´ô‰ΩøÁî®ÁöÑtokenÔºâ
      return localStorage.getItem('token');
    }
    
    // Âä†ËΩΩEvoËÆæÁΩÆÈ°µÈù¢ÁöÑAIÊ®°Âûã‰ø°ÊÅØ
    async function loadEvoAIModelInfo() {
      // ÂÖàÊ£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
      const nameEl = document.getElementById('evoAIModelName');
      const statusInfoEl = document.getElementById('evoAIInfoStatus');
      
      if (!nameEl) {
        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        if (statusInfoEl) {
          statusInfoEl.style.display = 'block';
          statusInfoEl.style.background = 'rgba(255, 152, 0, 0.3)';
          statusInfoEl.style.color = 'var(--text-primary)';
          statusInfoEl.innerHTML = '‚è≥ È°µÈù¢Ê≠£Âú®Âä†ËΩΩÔºåËØ∑Á®çÂÄô...';
        }
        setTimeout(() => loadEvoAIModelInfo(), 500);
        return;
      }
      
      // ÊòæÁ§∫Âä†ËΩΩ‰∏≠Áä∂ÊÄÅ
      if (statusInfoEl) {
        statusInfoEl.style.display = 'block';
        statusInfoEl.style.background = 'rgba(255, 152, 0, 0.3)';
        statusInfoEl.style.color = 'var(--text-primary)';
        statusInfoEl.innerHTML = 'üîÑ Ê≠£Âú®Âä†ËΩΩAI‰ø°ÊÅØ...';
      }
      
      const providerEl = document.getElementById('evoAIProvider');
      if (nameEl) nameEl.textContent = 'Âä†ËΩΩ‰∏≠...';
      if (providerEl) providerEl.textContent = 'Âä†ËΩΩ‰∏≠...';
      
      try {
        const token = getAuthToken();
        if (!token) {
          if (statusInfoEl) {
            statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
            statusInfoEl.innerHTML = '‚ùå <strong>Êú™ÁôªÂΩï</strong><br>ËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªüÔºåÁÑ∂ÂêéÊâçËÉΩÊü•ÁúãAIÊ®°Âûã‰ø°ÊÅØ„ÄÇ';
          }
          displayEvoAIModelInfo(null);
          return;
        }
        
        const apiUrl = getApiUrl();
        
        const response = await fetch(`${apiUrl}/evo/model-info`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success && result.data) {
            displayEvoAIModelInfo(result.data);
          } else {
            if (statusInfoEl) {
              statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
              statusInfoEl.innerHTML = `‚ùå <strong>APIËøîÂõûÈîôËØØ</strong><br>${result.error || 'Êú™Áü•ÈîôËØØ'}`;
            }
            displayEvoAIModelInfo(null);
          }
        } else {
          const errorData = await response.json().catch(() => ({ error: 'Êó†Ê≥ïËß£ÊûêÈîôËØØ‰ø°ÊÅØ' }));
          
          if (statusInfoEl) {
            statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
            let errorMsg = `‚ùå <strong>Âä†ËΩΩÂ§±Ë¥• (${response.status})</strong><br>`;
            
            if (response.status === 401) {
              errorMsg += 'ËÆ§ËØÅÂ§±Ë¥•ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩïÔºÅ';
            } else if (response.status === 404) {
              errorMsg += 'APIÊé•Âè£‰∏çÂ≠òÂú®ÔºåËØ∑Ê£ÄÊü•ÂêéÁ´ØÊúçÂä°ÔºÅ';
            } else if (response.status === 500) {
              errorMsg += 'ÊúçÂä°Âô®ÂÜÖÈÉ®ÈîôËØØÔºåËØ∑Ê£ÄÊü•ÂêéÁ´ØÊó•ÂøóÔºÅ';
            } else {
              errorMsg += errorData.error || 'Êú™Áü•ÈîôËØØ';
            }
            
            statusInfoEl.innerHTML = errorMsg;
          }
          
          displayEvoAIModelInfo(null);
        }
      } catch (error) {
        if (statusInfoEl) {
          statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
          let errorMsg = '‚ùå <strong>ÁΩëÁªúÈîôËØØ</strong><br>';
          
          if (error.message.includes('Failed to fetch')) {
            errorMsg += 'Êó†Ê≥ïËøûÊé•Âà∞ÂêéÁ´ØÊúçÂä°ÔºÅ<br>ËØ∑Á°ÆËÆ§Ôºö<br>1. ÂêéÁ´ØÊúçÂä°Â∑≤ÂêØÂä®ÔºàËøêË°å npm startÔºâ<br>2. ÊúçÂä°Âú∞ÂùÄÊ≠£Á°ÆÔºàhttp://localhost:3000Ôºâ<br>3. ÁΩëÁªúËøûÊé•Ê≠£Â∏∏';
          } else {
            errorMsg += error.message || 'Êú™Áü•ÈîôËØØ';
          }
          
          statusInfoEl.innerHTML = errorMsg;
        }
        
        displayEvoAIModelInfo(null);
      }
    }
    
    // ÊòæÁ§∫EvoËÆæÁΩÆÈ°µÈù¢ÁöÑAIÊ®°Âûã‰ø°ÊÅØ
    function displayEvoAIModelInfo(modelInfo) {
      const nameEl = document.getElementById('evoAIModelName');
      const providerEl = document.getElementById('evoAIProvider');
      const statusEl = document.getElementById('evoAIStatus');
      const sourceEl = document.getElementById('evoAISource');
      const descEl = document.getElementById('evoAIDescription');
      const featuresEl = document.getElementById('evoAIFeatures');
      const statusInfoEl = document.getElementById('evoAIInfoStatus');
      
      // ÊòæÁ§∫Áä∂ÊÄÅ‰ø°ÊÅØ
      if (statusInfoEl) {
        statusInfoEl.style.display = 'block';
        statusInfoEl.style.padding = '12px';
        statusInfoEl.style.borderRadius = '6px';
        statusInfoEl.style.fontSize = '14px';
      }
      
      if (!modelInfo) {
        if (nameEl) nameEl.textContent = '‚ùå Êú™ÈÖçÁΩÆ';
        if (providerEl) providerEl.textContent = 'Êú™Áü•';
        if (statusEl) {
          statusEl.textContent = '‚ùå Êú™ÈÖçÁΩÆ';
          statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
        }
        if (sourceEl) {
          sourceEl.href = '#';
          sourceEl.textContent = 'Êó†';
        }
        if (descEl) descEl.textContent = 'AIÊúçÂä°Êú™ÈÖçÁΩÆÔºåËØ∑Ê£ÄÊü•API KeyËÆæÁΩÆ';
        if (featuresEl) featuresEl.textContent = 'Êó†ÂèØÁî®ÂäüËÉΩ';
        
        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        if (statusInfoEl) {
          statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
          statusInfoEl.style.color = 'var(--text-primary)';
          statusInfoEl.innerHTML = '‚ùå <strong>AI‰ø°ÊÅØÂä†ËΩΩÂ§±Ë¥•</strong><br>ËØ∑ÁÇπÂáª"üîÑ Âà∑Êñ∞‰ø°ÊÅØ"ÊåâÈíÆÈáçËØïÔºåÊàñÊ£ÄÊü•ÂêéÁ´ØÊúçÂä°ÊòØÂê¶Ê≠£Â∏∏ËøêË°å„ÄÇ';
        }
        return;
      }
      
      // ÊòæÁ§∫ÊàêÂäü‰ø°ÊÅØ
      if (statusInfoEl) {
        statusInfoEl.style.background = 'rgba(76, 175, 80, 0.3)';
        statusInfoEl.style.color = 'var(--text-primary)';
        statusInfoEl.innerHTML = '‚úÖ <strong>AI‰ø°ÊÅØÂä†ËΩΩÊàêÂäü</strong>';
        setTimeout(() => {
          if (statusInfoEl) statusInfoEl.style.display = 'none';
        }, 3000);
      }
      
      if (nameEl) nameEl.textContent = modelInfo.name || 'Êú™Áü•';
      if (providerEl) providerEl.textContent = modelInfo.provider || 'Êú™Áü•';
      
      if (statusEl) {
        if (modelInfo.free) {
          statusEl.textContent = '‚úÖ ÂÖçË¥π‰ΩøÁî®';
          statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
        } else {
          statusEl.textContent = 'üí∞ ‰ªòË¥π';
          statusEl.style.background = 'rgba(255, 152, 0, 0.3)';
        }
      }
      
      if (sourceEl) {
        sourceEl.href = modelInfo.source || '#';
        sourceEl.textContent = modelInfo.source ? 'Êü•ÁúãÊ®°ÂûãËØ¶ÊÉÖ' : 'Êó†';
      }
      
      if (descEl) {
        descEl.textContent = modelInfo.description || 'Êô∫ËÉΩÂØπËØùÊ®°ÂûãÔºåÊîØÊåÅ‰∏≠ÊñáÂØπËØù';
      }
      
      if (featuresEl && modelInfo.features && Array.isArray(modelInfo.features)) {
        featuresEl.innerHTML = modelInfo.features.map(f => `‚Ä¢ ${f}`).join('<br>');
      } else if (featuresEl) {
        featuresEl.innerHTML = '‚Ä¢ ÂÆåÂÖ®ÂÖçË¥π‰ΩøÁî®<br>‚Ä¢ ÊîØÊåÅ‰∏≠ÊñáÂØπËØù<br>‚Ä¢ È´òÊÄßËÉΩÂìçÂ∫î';
      }
    }
    
    // ==========================================
    // üïäÔ∏è Evo Êô∫ËÉΩÂä©ÊâãÂäüËÉΩ
    // ==========================================
    
    const EvoAssistant = (function() {
      const CHAT_HISTORY_KEY = 'evo_chat_history';
      const USED_GREETINGS_KEY = 'evo_used_greetings_admin';
      
      // Ê¨¢ËøéÊ∂àÊÅØÂêéÁºÄÈÄâÈ°πÔºàÈíàÂØπÊô∫ËÉΩÁÆ°ÁêÜÔºâ
      const GREETING_SUFFIXES = [
        'ÁÆ°ÁêÜÂÖ¨Âëä',
        'Êü•ÁúãÁªüËÆ°Êï∞ÊçÆ',
        'ÁÆ°ÁêÜÁ≥ªÁªüËÆæÁΩÆ',
        'ÈÖçÁΩÆÊô∫ËÉΩÂä©Êâã',
        'ÂàÜÊûêÁî®Êà∑Êï∞ÊçÆ',
        '‰ºòÂåñÁ≥ªÁªüÊÄßËÉΩ',
        'Êü•ÁúãÁ≥ªÁªüÊó•Âøó',
        'ÁÆ°ÁêÜÊùÉÈôêËÆæÁΩÆ',
        'ÁîüÊàêÊï∞ÊçÆÊä•Ë°®',
        'ÁõëÊéßÁ≥ªÁªüÁä∂ÊÄÅ',
        'ÈÖçÁΩÆAPIÊé•Âè£',
        'ÁÆ°ÁêÜÊï∞ÊçÆÂ§á‰ªΩ',
        '‰ºòÂåñÊï∞ÊçÆÂ∫ì',
        'Êü•ÁúãÁ≥ªÁªüÂàÜÊûê',
        'ÁÆ°ÁêÜÂäüËÉΩÊ®°Âùó'
      ];
      
      let isExpanded = false;
      let activeTab = 'chat';
      let messages = [];
      let isTyping = false;
      let hasShownGreetingThisPageLoad = false;
      let assistantEl, iconButton, dialog, messagesContainer, inputField, sendBtn;
      
      function init() {
        try {
          createHTML();
          bindEvents();
          ensureIconVisible();
          setTimeout(() => ensureIconVisible(), 100);
          setTimeout(() => ensureIconVisible(), 500);
          
          // Âª∂ËøüÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ
          hasShownGreetingThisPageLoad = false;
          setTimeout(() => {
            showWelcomeGreeting();
          }, 1500);
          setTimeout(() => {
            const existingBubble = document.getElementById('evoWelcomeBubble');
            if (!existingBubble) {
              showWelcomeGreeting();
            }
          }, 3000);
        } catch (error) {
          console.error('EvoÂàùÂßãÂåñÈîôËØØ:', error);
        }
      }
      
      function ensureIconVisible() {
        try {
          let assistant = document.getElementById('evoAssistant');
          if (!assistant) {
            createHTML();
            assistant = document.getElementById('evoAssistant');
          }
          if (assistant) {
            assistant.style.cssText = `
              position: fixed !important;
              bottom: 80px !important;
              right: 20px !important;
              z-index: 99999 !important;
              display: block !important;
              visibility: visible !important;
              opacity: 1 !important;
              pointer-events: auto !important;
            `;
            assistantEl = assistant;
          }
        } catch (error) {
          console.error('ensureIconVisibleÈîôËØØ:', error);
        }
      }
      
      function createHTML() {
        const existing = document.getElementById('evoAssistant');
        if (existing) existing.remove();
        
        const html = `
          <div class="evo-assistant" id="evoAssistant">
            <div class="evo-icon-button" id="evoIconButton">
              <div class="evo-pigeon-icon">
                <span class="evo-icon">üïäÔ∏è</span>
                <div class="evo-pulse"></div>
              </div>
            </div>
            
            <div class="evo-dialog" id="evoDialog" style="display: none;">
              <div class="evo-header">
                <div class="evo-header-left">
                  <span class="evo-icon-large">üïäÔ∏è</span>
                  <div>
                    <h3 class="evo-title">Evo Êô∫ËÉΩÂä©Êâã</h3>
                    <p class="evo-subtitle" id="evoStatus">ÂáÜÂ§áÂ•Ω‰∏∫ÊÇ®ÊúçÂä°</p>
                  </div>
                </div>
                <button class="evo-close-btn" id="evoCloseBtn">√ó</button>
              </div>
              
              <div class="evo-content">
                <div class="evo-tabs">
                  <div class="evo-tab-headers">
                    <div class="evo-tab-header active" data-tab="chat">üí¨ ÂØπËØù</div>
                    <div class="evo-tab-header" data-tab="analytics">üìä Êï∞ÊçÆ</div>
                    <div class="evo-tab-header" data-tab="recommendations">‚ú® Êé®Ëçê</div>
                  </div>
                  
                  <div class="evo-tab-content active" id="tabChat">
                    <div class="evo-chat-container">
                      <div class="evo-messages" id="evoMessages"></div>
                      <div class="evo-input-area">
                        <div class="evo-input-group">
                          <input type="text" class="evo-input" id="evoInput" placeholder="ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò...">
                          <button class="evo-send-btn" id="evoSendBtn">ÂèëÈÄÅ</button>
                        </div>
                        <div class="evo-quick-actions">
                          <button class="evo-quick-action-btn" data-action="stats">Êü•ÁúãÁªüËÆ°Êï∞ÊçÆ</button>
                          <button class="evo-quick-action-btn" data-action="help">Â∏ÆÂä©</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="evo-tab-content" id="tabAnalytics">
                    <div class="evo-analytics" id="evoAnalytics">
                      <div class="evo-empty">ÊöÇÊó†ÂàÜÊûêÊä•Âëä</div>
                    </div>
                  </div>
                  
                  <div class="evo-tab-content" id="tabRecommendations">
                    <div class="evo-recommendations" id="evoRecommendations">
                      <div class="evo-empty">ÊöÇÊó†Êé®ËçêÂÜÖÂÆπ</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', html);
        
        assistantEl = document.getElementById('evoAssistant');
        iconButton = document.getElementById('evoIconButton');
        dialog = document.getElementById('evoDialog');
        messagesContainer = document.getElementById('evoMessages');
        inputField = document.getElementById('evoInput');
        sendBtn = document.getElementById('evoSendBtn');
        
        if (assistantEl) {
          assistantEl.style.cssText = `
            position: fixed !important;
            bottom: 80px !important;
            right: 20px !important;
            z-index: 99999 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
          `;
        }
      }
      
      function bindEvents() {
        if (!iconButton) return;
        
        iconButton.addEventListener('click', toggleExpanded);
        const closeBtn = document.getElementById('evoCloseBtn');
        if (closeBtn) {
          closeBtn.addEventListener('click', toggleExpanded);
        }
        
        if (sendBtn) sendBtn.addEventListener('click', sendMessage);
        if (inputField) {
          inputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isTyping) {
              sendMessage();
            }
          });
        }
        
        document.querySelectorAll('.evo-tab-header').forEach(header => {
          header.addEventListener('click', () => {
            const tab = header.dataset.tab;
            switchTab(tab);
          });
        });
        
        document.querySelectorAll('.evo-quick-action-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const action = btn.dataset.action;
            if (action === 'stats') {
              inputField.value = 'Êü•ÁúãÁªüËÆ°Êï∞ÊçÆ';
              sendMessage();
            } else if (action === 'help') {
              inputField.value = 'Â∏ÆÂä©';
              sendMessage();
            }
          });
        });
      }
      
      function toggleExpanded() {
        isExpanded = !isExpanded;
        if (dialog) {
          dialog.style.display = isExpanded ? 'flex' : 'none';
        }
        if (isExpanded) {
          loadHistory();
        }
      }
      
      function switchTab(tab) {
        activeTab = tab;
        document.querySelectorAll('.evo-tab-header').forEach(h => {
          h.classList.toggle('active', h.dataset.tab === tab);
        });
        document.querySelectorAll('.evo-tab-content').forEach(c => {
          c.classList.toggle('active', c.id === `tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
        });
      }
      
      async function sendMessage() {
        const text = inputField.value.trim();
        if (!text || isTyping) return;
        
        addMessage('user', text);
        inputField.value = '';
        
        isTyping = true;
        updateStatus('Ê≠£Âú®ÊÄùËÄÉ...');
        
        try {
          const response = await chat(text);
          addMessage('evo', response.text);
          saveHistory();
        } catch (error) {
          addMessage('evo', 'Êä±Ê≠âÔºåÊàëÊöÇÊó∂Êó†Ê≥ïÂìçÂ∫îÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ');
        } finally {
          isTyping = false;
          updateStatus('Âú®Á∫ø');
        }
      }
      
      // Ëé∑ÂèñtokenÂáΩÊï∞
      function getAuthToken() {
        // ‰ºòÂÖà‰ΩøÁî®adminTokenÔºàÊô∫ËÉΩÁÆ°ÁêÜÁ≥ªÁªü‰ΩøÁî®ÁöÑtokenÔºâ
        const adminToken = localStorage.getItem('adminToken');
        if (adminToken) {
          return adminToken;
        }
        // Â¶ÇÊûúÊ≤°ÊúâadminTokenÔºåÂ∞ùËØï‰ΩøÁî®tokenÔºà‰∏ªÁ´ô‰ΩøÁî®ÁöÑtokenÔºâ
        return localStorage.getItem('token');
      }
      
      // Ë∞ÉÁî®ÂêéÁ´ØAI API
      async function chatWithBackendAPI(question, history = [], context = {}) {
        try {
          // ‰ΩøÁî®Áªü‰∏ÄÁöÑgetApiUrlÂáΩÊï∞
          const apiBaseUrl = getApiUrl();
          
          const token = getAuthToken();
          if (!token) {
            console.warn('‚ùå Êú™ÊâæÂà∞tokenÔºåÊó†Ê≥ïË∞ÉÁî®ÂêéÁ´ØAPI„ÄÇËØ∑ÂÖàÁôªÂΩïÔºÅ');
            return null;
          }
          
          console.log(`üîÑ Ê≠£Âú®Ë∞ÉÁî®ÂêéÁ´ØAI API...`);
          console.log(`üì° APIÂú∞ÂùÄ: ${apiBaseUrl}/evo/chat`);
          console.log(`üìù ÈóÆÈ¢ò: ${question.substring(0, 50)}...`);
          
          const startTime = Date.now();
          const response = await fetch(`${apiBaseUrl}/evo/chat`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              question: question,
              history: history,
              context: context
            })
          });
          
          const responseTime = Date.now() - startTime;
          console.log(`‚è±Ô∏è ÂìçÂ∫îÊó∂Èó¥: ${responseTime}ms`);
          
          if (response.ok) {
            const data = await response.json();
            console.log('üì• APIÂìçÂ∫îÊï∞ÊçÆ:', data);
            
            if (data.success && data.data) {
              const responseText = data.data.text || data.data.response;
              if (responseText && responseText.length > 10) {
                console.log(`‚úÖ AI APIË∞ÉÁî®ÊàêÂäüÔºÅ`);
                console.log(`üìä ÂõûÂ§çÈïøÂ∫¶: ${responseText.length} Â≠óÁ¨¶`);
                console.log(`ü§ñ ‰ΩøÁî®Ê®°Âûã: ${data.data.model || 'Êú™Áü•'}`);
                console.log(`üè¢ ÊúçÂä°Êèê‰æõÂïÜ: ${data.data.provider || 'Êú™Áü•'}`);
                console.log(`üí¨ ÂõûÂ§çÈ¢ÑËßà: ${responseText.substring(0, 100)}...`);
                
                return { 
                  text: responseText, 
                  data: data.data,
                  modelInfo: data.modelInfo || null
                };
              } else {
                console.warn('‚ö†Ô∏è AIÂõûÂ§ç‰∏∫Á©∫ÊàñÂ§™Áü≠ÔºåÈïøÂ∫¶:', responseText?.length || 0);
              }
            } else {
              console.warn('‚ö†Ô∏è APIËøîÂõûsuccess=false:', data);
            }
          } else {
            const errorData = await response.json().catch(() => ({}));
            console.error('‚ùå ÂêéÁ´ØAI APIÂìçÂ∫îÈîôËØØ:', response.status);
            console.error('‚ùå ÈîôËØØËØ¶ÊÉÖ:', errorData);
            
            if (response.status === 401) {
              console.error('‚ùå ËÆ§ËØÅÂ§±Ë¥•ÔºÅËØ∑ÈáçÊñ∞ÁôªÂΩïÔºÅ');
              alert('ÁôªÂΩïÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ÁôªÂΩïÔºÅ');
            } else if (response.status === 500) {
              console.error('‚ùå ÊúçÂä°Âô®ÂÜÖÈÉ®ÈîôËØØÔºÅ');
            } else if (response.status === 404) {
              console.error('‚ùå APIÊé•Âè£‰∏çÂ≠òÂú®ÔºÅËØ∑Ê£ÄÊü•ÂêéÁ´ØÊúçÂä°ÔºÅ');
            }
          }
        } catch (error) {
          console.error('‚ùå Backend AI APIË∞ÉÁî®ÂºÇÂ∏∏:', error);
          console.error('‚ùå ÈîôËØØÁ±ªÂûã:', error.name);
          console.error('‚ùå ÈîôËØØÊ∂àÊÅØ:', error.message);
          
          if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            console.error('‚ùå ÁΩëÁªúÈîôËØØÔºöÊó†Ê≥ïËøûÊé•Âà∞ÂêéÁ´ØÊúçÂä°ÔºÅ');
            console.error('üí° ËØ∑Á°ÆËÆ§Ôºö1) ÂêéÁ´ØÊúçÂä°Â∑≤ÂêØÂä® 2) ÊúçÂä°Âú∞ÂùÄÊ≠£Á°Æ 3) ÁΩëÁªúËøûÊé•Ê≠£Â∏∏');
          }
        }
        
        return null;
      }
      
      async function chat(question) {
        console.log('üí¨ Êî∂Âà∞Áî®Êà∑ÈóÆÈ¢ò:', question);
        
        // Ëé∑ÂèñÂØπËØùÂéÜÂè≤
        const history = messages.map(msg => ({
          type: msg.type,
          text: msg.text,
          time: msg.time
        }));
        
        // Ëé∑Âèñ‰∏ä‰∏ãÊñáÊï∞ÊçÆÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâ
        const context = {};
        
        // ‰ºòÂÖàÁ∫ß1ÔºöÂ∞ùËØï‰ΩøÁî®ÂêéÁ´ØAI APIÔºàÂøÖÈ°ª‰ºòÂÖà‰ΩøÁî®AIÔºâ
        try {
          console.log('üîÑ Ê≠£Âú®Ë∞ÉÁî®ÂêéÁ´ØAI API...');
          const apiResponse = await chatWithBackendAPI(question, history, context);
          
          if (apiResponse && apiResponse.text && apiResponse.text.length > 10) {
            console.log('‚úÖ AI APIË∞ÉÁî®ÊàêÂäüÔºåËøîÂõûÊô∫ËÉΩAIÂõûÂ§ç');
            return apiResponse;
          } else {
            console.warn('‚ö†Ô∏è AI APIËøîÂõûÁöÑÂõûÂ§ç‰∏∫Á©∫ÊàñÂ§™Áü≠');
            console.warn('‚ö†Ô∏è ÂõûÂ§çÂÜÖÂÆπ:', apiResponse?.text || '(Á©∫)');
            console.warn('‚ö†Ô∏è ÁªßÁª≠Â∞ùËØïÂÖ∂‰ªñÊñπÂºè...');
          }
        } catch (error) {
          console.error('‚ùå ÂêéÁ´ØAI APIË∞ÉÁî®Â§±Ë¥•:', error);
          console.error('‚ùå ÈîôËØØÂ†ÜÊ†à:', error.stack);
        }
        
        // Â¶ÇÊûúAI APIÂ§±Ë¥•ÔºåÊòæÁ§∫ÊòéÁ°ÆÁöÑÈîôËØØÊèêÁ§∫
        const token = getAuthToken();
        if (!token) {
          return { 
            text: '‚ùå Êó†Ê≥ï‰ΩøÁî®AIÂäüËÉΩÔºöÊÇ®Â∞öÊú™ÁôªÂΩï„ÄÇ\n\nËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªüÔºåÁÑ∂ÂêéÊâçËÉΩ‰ΩøÁî®AIÂä©ÊâãÂäüËÉΩ„ÄÇ\n\nÁôªÂΩïÂêéÔºåAIÂä©ÊâãÂ∞Ü‰∏∫ÊÇ®Êèê‰æõÊô∫ËÉΩÂõûÂ§ç„ÄÇ' 
          };
        }
        
        // Ê£ÄÊü•ÂêéÁ´ØÊúçÂä°ÊòØÂê¶ÂèØËææ
        try {
          const healthCheck = await fetch(`${getApiUrl()}/health`).catch(() => null);
          if (!healthCheck || !healthCheck.ok) {
            return { 
              text: '‚ùå Êó†Ê≥ïËøûÊé•Âà∞ÂêéÁ´ØÊúçÂä°„ÄÇ\n\nËØ∑Á°ÆËÆ§Ôºö\n1. ÂêéÁ´ØÊúçÂä°Â∑≤ÂêØÂä®ÔºàËøêË°å npm startÔºâ\n2. ÊúçÂä°Âú∞ÂùÄÊ≠£Á°ÆÔºàhttp://localhost:3000Ôºâ\n3. ÁΩëÁªúËøûÊé•Ê≠£Â∏∏\n\nËøûÊé•ÊàêÂäüÂêéÔºåAIÂä©ÊâãÂ∞ÜÊ≠£Â∏∏Â∑•‰Ωú„ÄÇ' 
            };
          }
        } catch (e) {
          return { 
            text: '‚ùå ÂêéÁ´ØÊúçÂä°ËøûÊé•Â§±Ë¥•„ÄÇ\n\nËØ∑Ê£ÄÊü•Ôºö\n1. ÂêéÁ´ØÊúçÂä°ÊòØÂê¶Â∑≤ÂêØÂä®\n2. ÊúçÂä°Âú∞ÂùÄÊòØÂê¶Ê≠£Á°Æ\n3. Èò≤ÁÅ´Â¢ôËÆæÁΩÆ\n\n‰øÆÂ§çÂêéÔºåAIÂä©ÊâãÂ∞ÜËá™Âä®ÊÅ¢Â§ç„ÄÇ' 
          };
        }
        
        // Â¶ÇÊûúÂêéÁ´ØÊúçÂä°Ê≠£Â∏∏‰ΩÜAIË∞ÉÁî®Â§±Ë¥•ÔºåÊòæÁ§∫ÊèêÁ§∫
        return { 
          text: `‚ö†Ô∏è AIÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®„ÄÇ\n\nÈóÆÈ¢òÔºö"${question}"\n\nÂèØËÉΩÁöÑÂéüÂõ†Ôºö\n1. AI APIÈÖçÁΩÆÈóÆÈ¢ò\n2. API KeyÊó†ÊïàÊàñËøáÊúü\n3. ÁΩëÁªúËøûÊé•ÈóÆÈ¢ò\n\nËØ∑Ê£ÄÊü•Ôºö\n‚Ä¢ ÊµèËßàÂô®ÊéßÂà∂Âè∞ÁöÑÈîôËØØ‰ø°ÊÅØ\n‚Ä¢ ÂêéÁ´ØÊó•ÂøóÊñá‰ª∂\n‚Ä¢ API KeyÈÖçÁΩÆ\n\n‰øÆÂ§çÂêéÔºåAIÂä©ÊâãÂ∞ÜËá™Âä®ÊÅ¢Â§çÊô∫ËÉΩÂõûÂ§çÂäüËÉΩ„ÄÇ` 
        };
      }
      
      function addMessage(type, text) {
        const message = { type, text, time: new Date() };
        messages.push(message);
        renderMessages();
      }
      
      function renderMessages() {
        if (!messagesContainer) return;
        
        messagesContainer.innerHTML = messages.map(msg => {
          const timeStr = formatTime(msg.time);
          if (msg.type === 'user') {
            return `
              <div class="evo-message user">
                <div class="evo-message-avatar">üë§</div>
                <div class="evo-message-content">
                  <div class="evo-message-text">${formatMessage(msg.text)}</div>
                  <div class="evo-message-time">${timeStr}</div>
                </div>
              </div>
            `;
          } else {
            return `
              <div class="evo-message evo">
                <div class="evo-message-avatar">üïäÔ∏è</div>
                <div class="evo-message-content">
                  <div class="evo-message-text">${formatMessage(msg.text)}</div>
                  <div class="evo-message-time">${timeStr}</div>
                </div>
              </div>
            `;
          }
        }).join('');
        
        if (isTyping) {
          messagesContainer.innerHTML += `
            <div class="evo-message evo">
              <div class="evo-message-avatar">üïäÔ∏è</div>
              <div class="evo-message-content">
                <div class="evo-typing-indicator">
                  <span></span><span></span><span></span>
                </div>
              </div>
            </div>
          `;
        }
        
        scrollToBottom();
      }
      
      function formatMessage(text) {
        return text.replace(/\n/g, '<br>');
      }
      
      function formatTime(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        if (minutes < 1) return 'ÂàöÂàö';
        if (minutes < 60) return `${minutes}ÂàÜÈíüÂâç`;
        return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      }
      
      function scrollToBottom() {
        if (messagesContainer) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }
      
      function updateStatus(status) {
        const statusEl = document.getElementById('evoStatus');
        if (statusEl) {
          statusEl.textContent = status;
        }
      }
      
      function saveHistory() {
        try {
          localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(messages));
        } catch (error) {
          console.error('Failed to save chat history:', error);
        }
      }
      
      function loadHistory() {
        try {
          const history = localStorage.getItem(CHAT_HISTORY_KEY);
          if (history) {
            messages = JSON.parse(history).map(msg => ({
              ...msg,
              time: new Date(msg.time)
            }));
            renderMessages();
          }
        } catch (error) {
          console.error('Failed to load chat history:', error);
        }
      }
      
      // Ëé∑ÂèñÊú™‰ΩøÁî®ÁöÑÊ¨¢ËøéÊ∂àÊÅØÂêéÁºÄ
      function getUnusedGreetingSuffix() {
        try {
          const used = JSON.parse(localStorage.getItem(USED_GREETINGS_KEY) || '[]');
          const available = GREETING_SUFFIXES.filter(suffix => !used.includes(suffix));
          
          if (available.length === 0) {
            localStorage.setItem(USED_GREETINGS_KEY, '[]');
            return GREETING_SUFFIXES[Math.floor(Math.random() * GREETING_SUFFIXES.length)];
          }
          
          const selected = available[Math.floor(Math.random() * available.length)];
          used.push(selected);
          localStorage.setItem(USED_GREETINGS_KEY, JSON.stringify(used));
          
          return selected;
        } catch (error) {
          console.error('Ëé∑ÂèñÊ¨¢ËøéÊ∂àÊÅØÂ§±Ë¥•:', error);
          return GREETING_SUFFIXES[0];
        }
      }
      
      // ÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØÊ∞îÊ≥°ÂºπÁ™ó
      function showWelcomeGreeting() {
        const existingBubble = document.getElementById('evoWelcomeBubble');
        if (existingBubble) {
          return;
        }
        
        hasShownGreetingThisPageLoad = true;
        
        try {
          if (!document.body) {
            setTimeout(showWelcomeGreeting, 500);
            return;
          }
          
          const suffix = getUnusedGreetingSuffix();
          const greeting = `‰Ω†Â•ΩÔºåÊàëÊòØEvoÔºåÊàëÂèØ‰ª•Â∏Æ‰Ω†${suffix}„ÄÇ`;
          
          const bubble = document.createElement('div');
          bubble.id = 'evoWelcomeBubble';
          bubble.className = 'evo-welcome-bubble';
          
          bubble.style.position = 'fixed';
          bubble.style.bottom = '160px';
          bubble.style.right = '100px';
          bubble.style.zIndex = '99998';
          bubble.style.maxWidth = '280px';
          bubble.style.pointerEvents = 'auto';
          bubble.style.display = 'block';
          bubble.style.visibility = 'visible';
          bubble.style.opacity = '1';
          
          const bubbleContent = document.createElement('div');
          bubbleContent.className = 'evo-welcome-bubble-content';
          bubbleContent.textContent = greeting;
          
          bubbleContent.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          bubbleContent.style.color = '#fff';
          bubbleContent.style.padding = '12px 16px';
          bubbleContent.style.borderRadius = '8px';
          bubbleContent.style.fontSize = '14px';
          bubbleContent.style.lineHeight = '1.5';
          bubbleContent.style.boxShadow = '0 4px 20px rgba(102, 126, 234, 0.4), 0 0 30px rgba(118, 75, 162, 0.3)';
          bubbleContent.style.position = 'relative';
          bubbleContent.style.wordWrap = 'break-word';
          bubbleContent.style.cursor = 'pointer';
          bubbleContent.style.fontWeight = '500';
          
          bubbleContent.addEventListener('click', () => {
            hideWelcomeBubble();
            if (!dialog) {
              dialog = document.getElementById('evoDialog');
            }
            if (dialog) {
              isExpanded = true;
              dialog.style.display = 'flex';
              activeTab = 'chat';
              switchTab('chat');
              
              if (!messagesContainer) {
                messagesContainer = document.getElementById('evoMessages');
              }
              if (messagesContainer) {
                messages = [];
                messagesContainer.innerHTML = '';
                addMessage('evo', greeting);
                saveHistory();
                setTimeout(() => scrollToBottom(), 100);
              }
            }
          });
          
          bubble.appendChild(bubbleContent);
          document.body.appendChild(bubble);
          
          setTimeout(() => {
            const checkBubble = document.getElementById('evoWelcomeBubble');
            if (checkBubble) {
              const rect = checkBubble.getBoundingClientRect();
              const checkComputedStyle = window.getComputedStyle(checkBubble);
              if (rect.width === 0 || rect.height === 0 || checkComputedStyle.display === 'none' || checkComputedStyle.visibility === 'hidden') {
                checkBubble.style.cssText = `
                  position: fixed !important;
                  bottom: 160px !important;
                  right: 100px !important;
                  z-index: 99998 !important;
                  max-width: 280px !important;
                  display: block !important;
                  visibility: visible !important;
                  opacity: 1 !important;
                `;
              }
            }
          }, 100);
          
          setTimeout(() => {
            hideWelcomeBubble();
          }, 3000);
          
        } catch (error) {
          console.error('ÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØÂ§±Ë¥•:', error);
        }
      }
      
      // ÈöêËóèÊ¨¢ËøéÊ∂àÊÅØÊ∞îÊ≥°
      function hideWelcomeBubble() {
        const bubble = document.getElementById('evoWelcomeBubble');
        if (bubble) {
          bubble.classList.add('hiding');
          setTimeout(() => {
            if (bubble.parentNode) {
              bubble.remove();
            }
          }, 300);
        }
      }
      
      return {
        init,
        ensureIconVisible
      };
    })();
    
    // ÂàùÂßãÂåñEvoÂä©ÊâãÔºàÂú®ÁôªÂΩïÂêéÔºâ
    function initEvoAssistant() {
      setTimeout(() => {
        try {
          EvoAssistant.init();
          console.log('‚úÖ Evo Êô∫ËÉΩÂä©ÊâãÂ∑≤ÂàùÂßãÂåñ');
          
          setTimeout(() => {
            EvoAssistant.ensureIconVisible();
          }, 500);
        } catch (error) {
          console.error('‚ö†Ô∏è Êô∫ËÉΩÂä©ÊâãÂàùÂßãÂåñÂ§±Ë¥•:', error);
        }
      }, 500);
    }
    
    // ========================================
    // Êô∫È∏Ω¬∑‰∏≠Êû¢ÁÆ°ÂÆ∂ÂäüËÉΩ
    // ========================================
    
    // Âä†ËΩΩ‰∏≠Êû¢ÁÆ°ÂÆ∂Êï∞ÊçÆÔºà‰ΩøÁî®ÂÖ®Â±Ä CORE_ADMIN_API_BASEÔºâ
    async function loadCoreAdminData() {
      try {
        // Âπ∂Ë°åÂä†ËΩΩÊâÄÊúâÊï∞ÊçÆÔºåÂç≥‰ΩøÈÉ®ÂàÜÂ§±Ë¥•‰πüËÉΩÊòæÁ§∫ÂÖ∂‰ªñÂÜÖÂÆπ
        await Promise.allSettled([
          loadCoreAdminStatus(),
          loadCoreAdminModelInfo(),
          loadCoreAdminAdvice(),
          loadCoreAdminAnalytics(),
          loadCoreAdminApis(),
          loadCoreAdminLearning(),
          loadCoreAdminMaintenance()
        ]);
      } catch (error) {
        console.error('Âä†ËΩΩ‰∏≠Êû¢ÁÆ°ÂÆ∂Êï∞ÊçÆÂ§±Ë¥•:', error);
      }
    }
    
    // Âä†ËΩΩÁ≥ªÁªüÁä∂ÊÄÅ
    async function loadCoreAdminStatus() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/status`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const result = await response.json();
        
        if (result.success && result.data) {
          const status = result.data;
          const healthScore = (status.metrics?.systemHealth || 0) * 100;
          
          document.getElementById('coreAdminHealthScore').textContent = healthScore.toFixed(0) + '%';
          document.getElementById('coreAdminHealthStatus').textContent = 
            status.metrics?.riskLevel === 'low' ? '‚úÖ ËøêË°åÊ≠£Â∏∏' :
            status.metrics?.riskLevel === 'medium' ? '‚ö†Ô∏è ÈúÄË¶ÅÊ≥®ÊÑè' :
            status.metrics?.riskLevel === 'high' ? 'üî¥ È£éÈô©ËæÉÈ´ò' : 'Ê£ÄÊü•‰∏≠...';
        } else {
          throw new Error('Êï∞ÊçÆÊ†ºÂºèÈîôËØØ');
        }
      } catch (error) {
        console.error('Âä†ËΩΩÁ≥ªÁªüÁä∂ÊÄÅÂ§±Ë¥•:', error);
        document.getElementById('coreAdminHealthScore').textContent = '--';
        document.getElementById('coreAdminHealthStatus').textContent = '‚ö†Ô∏è ÊúçÂä°Êú™ËøêË°å';
        document.getElementById('coreAdminHealthStatus').style.color = '#f59e0b';
      }
    }
    
    // Âä†ËΩΩÊ®°ÂûãÊé•ÂÖ•‰ø°ÊÅØ
    async function loadCoreAdminModelInfo() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/model/config`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const result = await response.json();
        
        if (result.success && result.data) {
          const modelInfo = result.data;
          
          // Êõ¥Êñ∞Âü∫Êú¨‰ø°ÊÅØ
          document.getElementById('coreAdminModelProvider').textContent = modelInfo.provider || 'Êú™Áü•';
          document.getElementById('coreAdminModelName').textContent = modelInfo.model || 'Êú™Áü•';
          document.getElementById('coreAdminApiKeyPreview').textContent = modelInfo.apiKeyPreview || '--';
          document.getElementById('coreAdminApiBase').textContent = modelInfo.apiBase || '--';
          document.getElementById('coreAdminMaxCalls').textContent = modelInfo.maxCallsPerHour || '--';
          document.getElementById('coreAdminConfidence').textContent = (modelInfo.confidenceThreshold * 100).toFixed(0) + '%' || '--';
          
          // Êõ¥Êñ∞API KeyÁä∂ÊÄÅ
          const apiKeyStatusEl = document.getElementById('coreAdminApiKeyStatus');
          if (modelInfo.apiKeyStatus === 'configured') {
            apiKeyStatusEl.textContent = '‚úÖ Â∑≤ÈÖçÁΩÆ';
            apiKeyStatusEl.style.background = 'rgba(76, 175, 80, 0.3)';
            apiKeyStatusEl.style.color = '#2e7d32';
          } else {
            apiKeyStatusEl.textContent = '‚ùå Êú™ÈÖçÁΩÆ';
            apiKeyStatusEl.style.background = 'rgba(244, 67, 54, 0.3)';
            apiKeyStatusEl.style.color = '#c62828';
          }
          
          // Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅ
          const connectionStatusEl = document.getElementById('coreAdminConnectionStatus');
          if (modelInfo.connectionStatus === 'connected' && modelInfo.enabled) {
            connectionStatusEl.textContent = '‚úÖ Â∑≤ËøûÊé•';
            connectionStatusEl.style.background = 'rgba(76, 175, 80, 0.3)';
            connectionStatusEl.style.color = '#2e7d32';
          } else {
            connectionStatusEl.textContent = '‚ùå Êú™ËøûÊé•';
            connectionStatusEl.style.background = 'rgba(244, 67, 54, 0.3)';
            connectionStatusEl.style.color = '#c62828';
          }
          
          // Êõ¥Êñ∞Ë∞ÉÁî®ÁªüËÆ°
          if (modelInfo.stats) {
            const stats = modelInfo.stats;
            document.getElementById('coreAdminTotalCalls').textContent = stats.totalCalls || 0;
            document.getElementById('coreAdminRecentCalls').textContent = stats.recentCalls || 0;
            document.getElementById('coreAdminSuccessRate').textContent = (stats.successRate * 100).toFixed(1) + '%';
            document.getElementById('coreAdminAvgConfidence').textContent = (stats.avgConfidence * 100).toFixed(1) + '%';
          }
          
          // Êõ¥Êñ∞AIË∞ÉÁî®Ê¨°Êï∞ÔºàÂú®È°∂ÈÉ®Âç°Áâá‰∏≠Ôºâ
          if (modelInfo.stats) {
            document.getElementById('coreAdminAICalls').textContent = modelInfo.stats.recentCalls || 0;
          }
        } else {
          throw new Error('Êï∞ÊçÆÊ†ºÂºèÈîôËØØ');
        }
      } catch (error) {
        console.error('Âä†ËΩΩÊ®°ÂûãÊé•ÂÖ•‰ø°ÊÅØÂ§±Ë¥•:', error);
        const container = document.getElementById('coreAdminModelInfo');
        container.innerHTML = `
          <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:1px solid #f59e0b;">
            <p style="margin:0 0 12px 0;color:#92400e;font-weight:600;">‚ö†Ô∏è ‰∏≠Êû¢ÁÆ°ÂÆ∂ÊúçÂä°Êú™ËøêË°å</p>
            <p style="margin:0;color:#78350f;font-size:14px;">ËØ∑ÂêØÂä®ÂêéÁ´ØÊúçÂä°Ôºö<code style="background:#fde68a;padding:2px 6px;border-radius:4px;">cd backend/core-admin && npm start</code></p>
          </div>
        `;
      }
    }
    
    // Âä†ËΩΩÁÆ°ÁêÜÂª∫ËÆÆ
    async function loadCoreAdminAdvice() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/advice`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const result = await response.json();
        
        if (result.success && result.data) {
          const advice = result.data.advice || {};
          const container = document.getElementById('coreAdminAdvice');
          
          let html = '';
          if (advice.summary) {
            html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;margin-bottom:12px;">`;
            html += `<div style="font-weight:600;margin-bottom:8px;color:#1f2937;">${advice.summary}</div>`;
            if (advice.actions && advice.actions.length > 0) {
              html += `<ul style="margin:8px 0;padding-left:20px;">`;
              advice.actions.forEach(action => {
                html += `<li style="margin:4px 0;color:#4b5563;">${action}</li>`;
              });
              html += `</ul>`;
            }
            html += `</div>`;
          } else {
            html = '<p class="muted" style="text-align:center;">ÊöÇÊó†Âª∫ËÆÆ</p>';
          }
          
          container.innerHTML = html;
        } else {
          throw new Error('Êï∞ÊçÆÊ†ºÂºèÈîôËØØ');
        }
      } catch (error) {
        console.error('Âä†ËΩΩÁÆ°ÁêÜÂª∫ËÆÆÂ§±Ë¥•:', error);
        const container = document.getElementById('coreAdminAdvice');
        container.innerHTML = `
          <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:1px solid #f59e0b;">
            <p style="margin:0 0 12px 0;color:#92400e;font-weight:600;">‚ö†Ô∏è ‰∏≠Êû¢ÁÆ°ÂÆ∂ÊúçÂä°Êú™ËøêË°å</p>
            <p style="margin:0;color:#78350f;font-size:14px;">ËØ∑ÂêØÂä®ÂêéÁ´ØÊúçÂä°Ôºö<code style="background:#fde68a;padding:2px 6px;border-radius:4px;">cd backend/core-admin && npm start</code></p>
          </div>
        `;
      }
    }
    
    // Âä†ËΩΩÊï∞ÊçÆÂàÜÊûê
    async function loadCoreAdminAnalytics() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/analytics/report`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const report = result.data;
          const container = document.getElementById('coreAdminAnalytics');
          
          let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:20px;">';
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÊÄªÁÇπÂáªÈáè</div>`;
          html += `<div style="font-size:24px;font-weight:600;color:#1f2937;">${report.clicks?.total || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Êï∞ÊçÆ‰∏ä‰º†</div>`;
          html += `<div style="font-size:24px;font-weight:600;color:#1f2937;">${report.uploads?.total || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Áî®Êà∑Ë°å‰∏∫</div>`;
          html += `<div style="font-size:24px;font-weight:600;color:#1f2937;">${report.userBehaviors?.total || 0}</div>`;
          html += `</div>`;
          
          html += `</div>`;
          
          if (report.apiUsage?.topEndpoints && report.apiUsage.topEndpoints.length > 0) {
            html += `<div style="margin-top:20px;"><h4 style="margin-bottom:12px;">ÁÉ≠Èó®API</h4>`;
            html += `<table style="width:100%;border-collapse:collapse;">`;
            html += `<thead><tr style="background:#f9fafb;"><th style="padding:8px;text-align:left;">Á´ØÁÇπ</th><th style="padding:8px;text-align:center;">Ë∞ÉÁî®Ê¨°Êï∞</th><th style="padding:8px;text-align:center;">ÊàêÂäüÁéá</th></tr></thead><tbody>`;
            report.apiUsage.topEndpoints.slice(0, 5).forEach(api => {
              html += `<tr><td style="padding:8px;">${api.endpoint}</td>`;
              html += `<td style="padding:8px;text-align:center;">${api.calls}</td>`;
              html += `<td style="padding:8px;text-align:center;">${(api.successRate * 100).toFixed(1)}%</td></tr>`;
            });
            html += `</tbody></table></div>`;
          }
          
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('Âä†ËΩΩÊï∞ÊçÆÂàÜÊûêÂ§±Ë¥•:', error);
        const container = document.getElementById('coreAdminAnalytics');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">Êï∞ÊçÆÂàÜÊûêÊúçÂä°ÊöÇ‰∏çÂèØÁî®</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">ËØ∑Á°Æ‰øùÂêéÁ´ØÊúçÂä°Ê≠£Âú®ËøêË°å</p>
          </div>
        `;
      }
    }
    
    // Âä†ËΩΩAPIÂàóË°®
    async function loadCoreAdminApis() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/apis`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const apis = result.data;
          const container = document.getElementById('coreAdminApiList');
          
          if (apis.length === 0) {
            container.innerHTML = '<p class="muted" style="text-align:center;">ÊöÇÊó†API</p>';
            return;
          }
          
          let html = '<table style="width:100%;border-collapse:collapse;">';
          html += '<thead><tr style="background:#f9fafb;">';
          html += '<th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">APIÂêçÁß∞</th>';
          html += '<th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Áä∂ÊÄÅ</th>';
          html += '<th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂìçÂ∫îÊó∂Èó¥</th>';
          html += '<th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Êï∞ÊçÆÁúüÂÆûÊÄß</th>';
          html += '</tr></thead><tbody>';
          
          apis.forEach(api => {
            const statusColor = api.health.status === 'healthy' ? '#10b981' : '#ef4444';
            const statusText = api.health.status === 'healthy' ? '‚úÖ Ê≠£Â∏∏' : '‚ùå ÂºÇÂ∏∏';
            const truthStatus = api.health.truthStatus || 'unknown';
            const truthColor = truthStatus === 'verified' ? '#10b981' : truthStatus === 'suspect' ? '#f59e0b' : '#ef4444';
            const truthText = truthStatus === 'verified' ? '‚úÖ Â∑≤È™åËØÅ' : truthStatus === 'suspect' ? '‚ö†Ô∏è ÂèØÁñë' : '‚ùå Êó†Êïà';
            
            html += `<tr style="border-bottom:1px solid #f0f0f0;">`;
            html += `<td style="padding:12px;"><strong>${api.name}</strong><br><span style="color:#6b7280;font-size:12px;">${api.url}</span></td>`;
            html += `<td style="padding:12px;text-align:center;"><span style="color:${statusColor};font-weight:600;">${statusText}</span></td>`;
            html += `<td style="padding:12px;text-align:center;">${api.stats.avgResponseTime.toFixed(0)}ms</td>`;
            html += `<td style="padding:12px;text-align:center;"><span style="color:${truthColor};font-weight:600;">${truthText}</span></td>`;
            html += `</tr>`;
          });
          
          html += '</tbody></table>';
          container.innerHTML = html;
          
          // Êõ¥Êñ∞APIÂÅ•Â∫∑Áéá
          const healthyCount = apis.filter(a => a.health.status === 'healthy').length;
          const healthRate = apis.length > 0 ? (healthyCount / apis.length * 100) : 0;
          document.getElementById('coreAdminApiHealth').textContent = healthRate.toFixed(0) + '%';
        }
      } catch (error) {
        console.error('Âä†ËΩΩAPIÂàóË°®Â§±Ë¥•:', error);
        const container = document.getElementById('coreAdminApiList');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">APIÁõëÁÆ°ÊúçÂä°ÊöÇ‰∏çÂèØÁî®</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">ËØ∑Á°Æ‰øùÂêéÁ´ØÊúçÂä°Ê≠£Âú®ËøêË°å</p>
          </div>
        `;
      }
    }
    
    // Âä†ËΩΩÂ≠¶‰π†Á≥ªÁªü
    async function loadCoreAdminLearning() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/learning/stats`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const stats = result.data;
          const container = document.getElementById('coreAdminLearning');
          
          let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">';
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÊÄª‰∫ã‰ª∂Êï∞</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalEvents || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Á≠ñÁï•Êï∞</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalStrategies || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÂÜ≥Á≠ñÊï∞</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalDecisions || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Âπ≥ÂùáÊúâÊïàÊÄß</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${((stats.avgEffectiveness || 0) * 100).toFixed(1)}%</div>`;
          html += `</div>`;
          
          html += `</div>`;
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('Âä†ËΩΩÂ≠¶‰π†Á≥ªÁªüÂ§±Ë¥•:', error);
        const container = document.getElementById('coreAdminLearning');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">Â≠¶‰π†Á≥ªÁªüÊúçÂä°ÊöÇ‰∏çÂèØÁî®</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">ËØ∑Á°Æ‰øùÂêéÁ´ØÊúçÂä°Ê≠£Âú®ËøêË°å</p>
          </div>
        `;
      }
    }
    
    // Âä†ËΩΩËá™Âä®Áª¥Êä§
    async function loadCoreAdminMaintenance() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/maintenance/stats`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const stats = result.data;
          const container = document.getElementById('coreAdminMaintenance');
          
          let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">';
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÊÄªBugÊï∞</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalBugs || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Â∑≤‰øÆÂ§ç</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.fixedBugs || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÊÄª‰øÆÂ§çÊï∞</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalFixes || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Á≥ªÁªüÂçáÁ∫ß</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalUpgrades || 0}</div>`;
          html += `</div>`;
          
          html += `</div>`;
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('Âä†ËΩΩËá™Âä®Áª¥Êä§Â§±Ë¥•:', error);
        const container = document.getElementById('coreAdminMaintenance');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">Ëá™Âä®Áª¥Êä§ÊúçÂä°ÊöÇ‰∏çÂèØÁî®</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">ËØ∑Á°Æ‰øùÂêéÁ´ØÊúçÂä°Ê≠£Âú®ËøêË°å</p>
          </div>
        `;
      }
    }
    
    // ÁªëÂÆöÂà∑Êñ∞ÊåâÈíÆ
    // ==========================================
    // Á≥ªÁªüËÆæÁΩÆÂäüËÉΩ
    // ==========================================
    
    let currentRssSourceEditId = null;
    
    // Âä†ËΩΩÁ≥ªÁªüËÆæÁΩÆ
    async function loadSystemSettings() {
      try {
        const token = localStorage.getItem('adminToken');
        if (!token) {
          showSettingsStatus('ËØ∑ÂÖàÁôªÂΩï', 'error');
          return;
        }
        
        const response = await fetch(`${getApiUrl()}/api/admin/system-settings`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const settings = result.data;
          
          // Â°´ÂÖÖÂü∫Á°ÄËÆæÁΩÆ
          document.getElementById('serverPort').value = settings.server?.port || '';
          document.getElementById('serverEnv').value = settings.server?.env || 'production';
          document.getElementById('apiRateLimit').value = settings.api?.rateLimit || '';
          document.getElementById('logLevel').value = settings.logging?.level || 'info';
          
          // Â°´ÂÖÖÁºìÂ≠òËÆæÁΩÆ
          document.getElementById('cacheTtlNews').value = settings.cache?.ttl?.news || '';
          document.getElementById('cacheTtlEvents').value = settings.cache?.ttl?.events || '';
          document.getElementById('cacheTtlResults').value = settings.cache?.ttl?.results || '';
          document.getElementById('updateIntervalNews').value = settings.updateInterval?.news || '';
          document.getElementById('updateIntervalEvents').value = settings.updateInterval?.events || '';
          document.getElementById('updateIntervalResults').value = settings.updateInterval?.results || '';
          
          // Â°´ÂÖÖAIËÆæÁΩÆ
          document.getElementById('zhipuApiKeyEvo').value = settings.ai?.zhipuApiKeyEvo || '';
          document.getElementById('zhipuApiKeyAdmin').value = settings.ai?.zhipuApiKeyAdmin || '';
          document.getElementById('qwenApiKey').value = settings.ai?.qwenApiKey || '';
          document.getElementById('huggingFaceApiKey').value = settings.ai?.huggingFaceApiKey || '';
          document.getElementById('aiModel').value = settings.ai?.model || 'auto';
          
          // Â°´ÂÖÖÊï∞ÊçÆÂ∫ìËÆæÁΩÆ
          document.getElementById('supabaseUrl').value = settings.supabase?.url || '';
          document.getElementById('supabaseAnonKey').value = settings.supabase?.anonKey || '';
          
          // Âä†ËΩΩRSSÊ∫êÂàóË°®
          loadRssSources();
        }
      } catch (error) {
        console.error('Âä†ËΩΩÁ≥ªÁªüËÆæÁΩÆÂ§±Ë¥•:', error);
        showSettingsStatus('Âä†ËΩΩÁ≥ªÁªüËÆæÁΩÆÂ§±Ë¥•: ' + error.message, 'error');
      }
    }
    
    // Âä†ËΩΩRSSÊ∫êÂàóË°®
    async function loadRssSources() {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const sources = result.data;
          const container = document.getElementById('rssSourcesList');
          
          if (sources.length === 0) {
            container.innerHTML = '<p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†RSSÊ∫êÔºåÁÇπÂáª"Ê∑ªÂä†RSSÊ∫ê"ÊåâÈíÆÊ∑ªÂä†</p>';
            return;
          }
          
          let html = '';
          sources.forEach(source => {
            const statusColor = source.active !== false ? '#10b981' : '#ef4444';
            const statusText = source.active !== false ? 'ÂêØÁî®' : 'Á¶ÅÁî®';
            
            html += `
              <div style="padding:16px;background:var(--bg-secondary);border:1px solid var(--border-light);border-radius:var(--radius-md);">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
                  <div style="flex:1;">
                    <div style="font-weight:600;color:var(--text-primary);margin-bottom:4px;">${source.name}</div>
                    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">${source.url}</div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                      <span style="padding:4px 8px;background:var(--primary-50);color:var(--primary);border-radius:4px;font-size:12px;">${source.type === 'media' ? 'Â™í‰Ωì' : 'Âçè‰ºö'}</span>
                      <span style="padding:4px 8px;background:var(--gray-100);color:var(--gray-700);border-radius:4px;font-size:12px;">${source.region === 'local' ? 'Êú¨Âú∞' : 'ÂÖ®ÂõΩ'}</span>
                      <span style="padding:4px 8px;background:${statusColor}20;color:${statusColor};border-radius:4px;font-size:12px;">${statusText}</span>
                    </div>
                  </div>
                  <div style="display:flex;gap:8px;">
                    <button class="btn btn-sm btn-outline" onclick="editRssSource('${source.id}')">ÁºñËæë</button>
                    <button class="btn btn-sm btn-outline" onclick="toggleRssSource('${source.id}', ${source.active !== false})">${source.active !== false ? 'Á¶ÅÁî®' : 'ÂêØÁî®'}</button>
                    <button class="btn btn-sm btn-outline" style="color:var(--danger);" onclick="deleteRssSource('${source.id}')">Âà†Èô§</button>
                  </div>
                </div>
              </div>
            `;
          });
          
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('Âä†ËΩΩRSSÊ∫êÂàóË°®Â§±Ë¥•:', error);
      }
    }
    
    // Á≥ªÁªüËÆæÁΩÆÊ†áÁ≠æÈ°µÂàáÊç¢
    document.querySelectorAll('.settings-tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        
        // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
        document.querySelectorAll('.settings-tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // ÊòæÁ§∫ÂØπÂ∫îÈù¢Êùø
        document.querySelectorAll('.settings-panel').forEach(p => p.style.display = 'none');
        document.getElementById(`settings${tab.charAt(0).toUpperCase() + tab.slice(1)}`).style.display = 'block';
      });
    });
    
    // ‰øùÂ≠òÂü∫Á°ÄËÆæÁΩÆ
    document.getElementById('btnSaveGeneralSettings')?.addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('adminToken');
        const settings = {
          custom: {
            server: {
              port: parseInt(document.getElementById('serverPort').value) || 3000,
              env: document.getElementById('serverEnv').value
            },
            api: {
              rateLimit: parseInt(document.getElementById('apiRateLimit').value) || 100
            },
            logging: {
              level: document.getElementById('logLevel').value
            }
          }
        };
        
        const response = await fetch(`${getApiUrl()}/api/admin/system-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ settings })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('Âü∫Á°ÄËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºàÈÉ®ÂàÜÈÖçÁΩÆÈúÄË¶Å‰øÆÊîπÁéØÂ¢ÉÂèòÈáèÂêéÈáçÂêØÊúçÂä°ÊâçËÉΩÁîüÊïàÔºâ', 'success');
        } else {
          showSettingsStatus('‰øùÂ≠òÂ§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
      } catch (error) {
        showSettingsStatus('‰øùÂ≠òÂ§±Ë¥•: ' + error.message, 'error');
      }
    });
    
    // ‰øùÂ≠òÁºìÂ≠òËÆæÁΩÆ
    document.getElementById('btnSaveCacheSettings')?.addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('adminToken');
        const settings = {
          custom: {
            cache: {
              ttl: {
                news: parseInt(document.getElementById('cacheTtlNews').value) || 3600,
                events: parseInt(document.getElementById('cacheTtlEvents').value) || 300,
                results: parseInt(document.getElementById('cacheTtlResults').value) || 7200
              }
            },
            updateInterval: {
              news: parseInt(document.getElementById('updateIntervalNews').value) || 3600,
              events: parseInt(document.getElementById('updateIntervalEvents').value) || 300,
              results: parseInt(document.getElementById('updateIntervalResults').value) || 1800
            }
          }
        };
        
        const response = await fetch(`${getApiUrl()}/api/admin/system-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ settings })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('ÁºìÂ≠òÈÖçÁΩÆÂ∑≤‰øùÂ≠òÔºàÈúÄË¶Å‰øÆÊîπÁéØÂ¢ÉÂèòÈáèÂêéÈáçÂêØÊúçÂä°ÊâçËÉΩÁîüÊïàÔºâ', 'success');
        } else {
          showSettingsStatus('‰øùÂ≠òÂ§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
      } catch (error) {
        showSettingsStatus('‰øùÂ≠òÂ§±Ë¥•: ' + error.message, 'error');
      }
    });
    
    // Ê∑ªÂä†RSSÊ∫ê
    document.getElementById('btnAddRssSource')?.addEventListener('click', () => {
      currentRssSourceEditId = null;
      document.getElementById('rssSourceForm').style.display = 'block';
      document.getElementById('rssSourceName').value = '';
      document.getElementById('rssSourceUrl').value = '';
      document.getElementById('rssSourceType').value = 'media';
      document.getElementById('rssSourceRegion').value = 'local';
    });
    
    // ‰øùÂ≠òRSSÊ∫ê
    document.getElementById('btnSaveRssSource')?.addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('adminToken');
        const name = document.getElementById('rssSourceName').value.trim();
        const url = document.getElementById('rssSourceUrl').value.trim();
        const type = document.getElementById('rssSourceType').value;
        const region = document.getElementById('rssSourceRegion').value;
        
        if (!name || !url) {
          showSettingsStatus('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑRSSÊ∫ê‰ø°ÊÅØ', 'error');
          return;
        }
        
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ name, url, type, region })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('RSSÊ∫êÂ∑≤Ê∑ªÂä†', 'success');
          document.getElementById('rssSourceForm').style.display = 'none';
          loadRssSources();
        } else {
          showSettingsStatus('Ê∑ªÂä†Â§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
      } catch (error) {
        showSettingsStatus('Ê∑ªÂä†Â§±Ë¥•: ' + error.message, 'error');
      }
    });
    
    // ÂèñÊ∂àRSSÊ∫êÁºñËæë
    document.getElementById('btnCancelRssSource')?.addEventListener('click', () => {
      document.getElementById('rssSourceForm').style.display = 'none';
      currentRssSourceEditId = null;
    });
    
    // ÊµãËØïRSSÊ∫ê
    document.getElementById('btnTestRssSource')?.addEventListener('click', async () => {
      const url = document.getElementById('rssSourceUrl').value.trim();
      if (!url) {
        showSettingsStatus('ËØ∑ÂÖàËæìÂÖ•RSS URL', 'error');
        return;
      }
      
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources/test`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ url })
        });
        
        const result = await response.json();
        const resultDiv = document.getElementById('rssSourceTestResult');
        
        if (result.success && result.data?.valid) {
          resultDiv.innerHTML = `<div style="padding:12px;background:#d1fae5;color:#047857;border-radius:6px;">‚úÖ ËøûÊé•ÊàêÂäüÔºÅÊâæÂà∞ ${result.data.itemCount} Êù°ÂÜÖÂÆπ</div>`;
        } else {
          resultDiv.innerHTML = `<div style="padding:12px;background:#fee2e2;color:#991b1b;border-radius:6px;">‚ùå ËøûÊé•Â§±Ë¥•: ${result.error || 'Êú™Áü•ÈîôËØØ'}</div>`;
        }
      } catch (error) {
        document.getElementById('rssSourceTestResult').innerHTML = `<div style="padding:12px;background:#fee2e2;color:#991b1b;border-radius:6px;">‚ùå ÊµãËØïÂ§±Ë¥•: ${error.message}</div>`;
      }
    });
    
    // ÁºñËæëRSSÊ∫ê
    window.editRssSource = async (id) => {
      // TODO: ÂÆûÁé∞ÁºñËæëÂäüËÉΩ
      alert('ÁºñËæëÂäüËÉΩÂºÄÂèë‰∏≠...');
    };
    
    // ÂàáÊç¢RSSÊ∫êÁä∂ÊÄÅ
    window.toggleRssSource = async (id, currentStatus) => {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources/${id}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ active: !currentStatus })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('RSSÊ∫êÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞', 'success');
          loadRssSources();
        } else {
          showSettingsStatus('Êõ¥Êñ∞Â§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
      } catch (error) {
        showSettingsStatus('Êõ¥Êñ∞Â§±Ë¥•: ' + error.message, 'error');
      }
    };
    
    // Âà†Èô§RSSÊ∫ê
    window.deleteRssSource = async (id) => {
      if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™RSSÊ∫êÂêóÔºü')) return;
      
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('RSSÊ∫êÂ∑≤Âà†Èô§', 'success');
          loadRssSources();
        } else {
          showSettingsStatus('Âà†Èô§Â§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
      } catch (error) {
        showSettingsStatus('Âà†Èô§Â§±Ë¥•: ' + error.message, 'error');
      }
    };
    
    // ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
    function showSettingsStatus(message, type) {
      const statusDiv = document.getElementById('settingsStatus');
      statusDiv.style.display = 'block';
      statusDiv.style.padding = '12px';
      statusDiv.style.borderRadius = 'var(--radius-md)';
      
      if (type === 'success') {
        statusDiv.style.background = '#d1fae5';
        statusDiv.style.color = '#047857';
      } else {
        statusDiv.style.background = '#fee2e2';
        statusDiv.style.color = '#991b1b';
      }
      
      statusDiv.textContent = message;
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      const btnRefreshModelInfo = document.getElementById('btnRefreshModelInfo');
      const btnRefreshAdvice = document.getElementById('btnRefreshAdvice');
      const btnRefreshAnalytics = document.getElementById('btnRefreshAnalytics');
      const btnRefreshApis = document.getElementById('btnRefreshApis');
      const btnRefreshLearning = document.getElementById('btnRefreshLearning');
      const btnRefreshMaintenance = document.getElementById('btnRefreshMaintenance');
      
      if (btnRefreshModelInfo) {
        btnRefreshModelInfo.addEventListener('click', () => {
          loadCoreAdminModelInfo();
        });
      }
      
      if (btnRefreshAdvice) {
        btnRefreshAdvice.addEventListener('click', () => {
          loadCoreAdminAdvice();
        });
      }
      
      if (btnRefreshAnalytics) {
        btnRefreshAnalytics.addEventListener('click', () => {
          loadCoreAdminAnalytics();
        });
      }
      
      if (btnRefreshApis) {
        btnRefreshApis.addEventListener('click', () => {
          loadCoreAdminApis();
        });
      }
      
      if (btnRefreshLearning) {
        btnRefreshLearning.addEventListener('click', () => {
          loadCoreAdminLearning();
        });
      }
      
      if (btnRefreshMaintenance) {
        btnRefreshMaintenance.addEventListener('click', () => {
          loadCoreAdminMaintenance();
        });
      }
    });
    
    // Á≥ªÁªüÂçáÁ∫ßÂäüËÉΩ
    async function loadUpgradeData() {
      const CORE_ADMIN_API_BASE = 'http://localhost:3001/api';
      
      try {
        // Âä†ËΩΩÂçáÁ∫ßÊ¶ÇËßà
        const overviewResponse = await fetch(`${CORE_ADMIN_API_BASE}/upgrade/overview`);
        if (overviewResponse.ok) {
          const overviewResult = await overviewResponse.json();
          if (overviewResult.success && overviewResult.data) {
            const overview = overviewResult.data;
            document.getElementById('upgradeVersion').textContent = `v${overview.version}`;
            document.getElementById('upgradePartsCount').textContent = overview.completedCount || '--';
            document.getElementById('upgradeNewFiles').textContent = overview.statistics?.newFiles || '--';
            document.getElementById('upgradeNewCode').textContent = (overview.statistics?.newCodeLines / 1000).toFixed(1) + 'K';
            document.getElementById('upgradeAutomation').textContent = overview.capabilities?.automation || '--';
          }
        }

        // Âä†ËΩΩÂçáÁ∫ßÈÉ®ÂàÜ
        const partsResponse = await fetch(`${CORE_ADMIN_API_BASE}/upgrade/parts`);
        if (partsResponse.ok) {
          const partsResult = await partsResponse.json();
          if (partsResult.success && partsResult.data) {
            renderUpgradeParts(partsResult.data);
          }
        }

        // Âä†ËΩΩËÉΩÂäõÊèêÂçá
        const capabilitiesResponse = await fetch(`${CORE_ADMIN_API_BASE}/upgrade/capabilities`);
        if (capabilitiesResponse.ok) {
          const capabilitiesResult = await capabilitiesResponse.json();
          if (capabilitiesResult.success && capabilitiesResult.data) {
            renderCapabilities(capabilitiesResult.data);
          }
        }
      } catch (error) {
        console.error('Âä†ËΩΩÂçáÁ∫ßÊï∞ÊçÆÂ§±Ë¥•:', error);
        document.getElementById('upgradePartsList').innerHTML = `
          <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:1px solid #f59e0b;">
            <p style="margin:0 0 12px 0;color:#92400e;font-weight:600;">‚ö†Ô∏è Êó†Ê≥ïËøûÊé•Âà∞ÂçáÁ∫ßÊúçÂä°</p>
            <p style="margin:0;color:#78350f;font-size:14px;">ËØ∑Á°Æ‰øù‰∏≠Êû¢ÁÆ°ÂÆ∂ÊúçÂä°Ê≠£Âú®ËøêË°å</p>
          </div>
        `;
      }
    }

    // Ê∏≤ÊüìÂçáÁ∫ßÈÉ®ÂàÜ
    function renderUpgradeParts(parts) {
      const container = document.getElementById('upgradePartsList');
      
      if (!parts || parts.length === 0) {
        container.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ÊöÇÊó†ÂçáÁ∫ßËÆ∞ÂΩï</p>';
        return;
      }

      const html = parts.map(part => `
        <div style="background:#f8fafc;border-radius:12px;padding:24px;margin-bottom:16px;border:2px solid #e2e8f0;transition:all 0.3s ease;" 
             onmouseover="this.style.borderColor='#3b82f6';this.style.boxShadow='0 4px 12px rgba(59,130,246,0.15)'" 
             onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
          <div style="display:flex;align-items:start;gap:16px;">
            <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;">
              ${part.id === 'frontend' ? 'üé®' : part.id === 'security' ? 'üîí' : part.id === 'database' ? 'üóÑÔ∏è' : 'ü§ñ'}
            </div>
            <div style="flex:1;">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                <h4 style="margin:0;font-size:18px;font-weight:700;color:#1e293b;">${part.name}</h4>
                <span style="background:#10b981;color:#fff;padding:4px 12px;border-radius:6px;font-size:12px;font-weight:600;">‚úÖ ${part.status === 'completed' ? 'Â∑≤ÂÆåÊàê' : 'ËøõË°å‰∏≠'}</span>
              </div>
              <p style="margin:0 0 16px 0;color:#64748b;font-size:14px;line-height:1.6;">${part.description}</p>
              
              ${part.files && part.files.length > 0 ? `
                <div style="margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;">Áõ∏ÂÖ≥Êñá‰ª∂Ôºö</div>
                  <div style="display:flex;flex-wrap:wrap;gap:8px;">
                    ${part.files.map(file => `
                      <span style="background:#e2e8f0;color:#475569;padding:4px 10px;border-radius:6px;font-size:12px;font-family:monospace;">${file}</span>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              ${part.modules && part.modules.length > 0 ? `
                <div style="margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;">Êñ∞Â¢ûÊ®°ÂùóÔºö</div>
                  <div style="display:flex;flex-wrap:wrap;gap:8px;">
                    ${part.modules.map(module => `
                      <div style="background:#dbeafe;color:#1e40af;padding:6px 12px;border-radius:6px;font-size:12px;display:flex;align-items:center;gap:6px;">
                        <span>üì¶</span>
                        <span>${module.name}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              ${part.benefits && part.benefits.length > 0 ? `
                <div>
                  <div style="font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;">Êî∂ÁõäÔºö</div>
                  <ul style="margin:0;padding-left:20px;color:#64748b;font-size:13px;">
                    ${part.benefits.map(benefit => `<li style="margin-bottom:4px;">${benefit}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    // Ê∏≤ÊüìËÉΩÂäõÊèêÂçá
    function renderCapabilities(capabilities) {
      const container = document.getElementById('upgradeCapabilities');
      
      const html = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">
          <div style="background:linear-gradient(135deg, #e6f0ff 0%, #dbeafe 100%);border-radius:12px;padding:20px;border:2px solid rgba(59,130,246,0.2);">
            <div style="font-size:14px;font-weight:600;color:#1e40af;margin-bottom:8px;">Ëá™Âä®ÂåñÁéá</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.automation || '--'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);border-radius:12px;padding:20px;border:2px solid rgba(16,185,129,0.2);">
            <div style="font-size:14px;font-weight:600;color:#065f46;margin-bottom:8px;">Êô∫ËÉΩÂåñÁéá</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.intelligence || '--'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border-radius:12px;padding:20px;border:2px solid rgba(245,158,11,0.2);">
            <div style="font-size:14px;font-weight:600;color:#92400e;margin-bottom:8px;">È¢ÑÊµãÂáÜÁ°ÆÁéá</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.prediction || '--'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);border-radius:12px;padding:20px;border:2px solid rgba(236,72,153,0.2);">
            <div style="font-size:14px;font-weight:600;color:#9f1239;margin-bottom:8px;">APIÂÆâÂÖ®ÊÄß</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.security || '--'}</div>
          </div>
        </div>
      `;

      container.innerHTML = html;
    }

    // Êô∫ËÉΩÂäüËÉΩÊ®°ÂùóÂä†ËΩΩÂáΩÊï∞Ôºà‰ΩøÁî®ÂÖ®Â±Ä CORE_ADMIN_API_BASEÔºâ

    // Âä†ËΩΩÊô∫ËÉΩÂÜ≥Á≠ñÂª∫ËÆÆ
    async function loadIntelligentAdvice() {
      const preview = document.getElementById('intelligentAdvicePreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/advice`);
        const result = await response.json();
        if (result.success && result.data) {
          const advice = result.data;
          preview.innerHTML = `<strong>${advice.title || 'Êô∫ËÉΩÂª∫ËÆÆ'}</strong><br>${advice.description || advice.reason || 'ÊöÇÊó†Âª∫ËÆÆ'}`;
          // ÂèØ‰ª•ÊâìÂºÄËØ¶ÁªÜÊ®°ÊÄÅÊ°ÜÊòæÁ§∫ÂÆåÊï¥‰ø°ÊÅØ
          showIntelligentModal('ÂÜ≥Á≠ñÂºïÊìé', advice);
        } else {
          preview.innerHTML = 'ÊöÇÊó†Âª∫ËÆÆ';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩÊô∫ËÉΩÂª∫ËÆÆÂ§±Ë¥•:', error);
      }
    }

    // Âä†ËΩΩÈ¢ÑÊµãÁª¥Êä§‰ø°ÊÅØ
    async function loadIntelligentPredictions() {
      const preview = document.getElementById('intelligentPredictionsPreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/predictions`);
        const result = await response.json();
        if (result.success && result.data) {
          const predictions = result.data;
          const count = predictions.predictions?.length || 0;
          preview.innerHTML = `ÂèëÁé∞ <strong>${count}</strong> ‰∏™ÊΩúÂú®ÈóÆÈ¢ò<br>${predictions.summary || 'ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ'}`;
          showIntelligentModal('È¢ÑÊµãÁª¥Êä§', predictions);
        } else {
          preview.innerHTML = 'ÊöÇÊó†È¢ÑÊµã‰ø°ÊÅØ';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩÈ¢ÑÊµã‰ø°ÊÅØÂ§±Ë¥•:', error);
      }
    }

    // Âä†ËΩΩÂ∑•‰ΩúÊµÅÂàóË°®
    async function loadIntelligentWorkflows() {
      const preview = document.getElementById('intelligentWorkflowsPreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/workflows`);
        const result = await response.json();
        if (result.success && result.data) {
          const workflows = result.data;
          const count = workflows.workflows?.length || 0;
          preview.innerHTML = `ÂÖ±Êúâ <strong>${count}</strong> ‰∏™Â∑•‰ΩúÊµÅ<br>${workflows.summary || 'ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ'}`;
          showIntelligentModal('Â∑•‰ΩúÊµÅÂºïÊìé', workflows);
        } else {
          preview.innerHTML = 'ÊöÇÊó†Â∑•‰ΩúÊµÅ';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩÂ∑•‰ΩúÊµÅÂ§±Ë¥•:', error);
      }
    }

    // Âä†ËΩΩÂëäË≠¶ÂàóË°®
    async function loadIntelligentAlerts() {
      const preview = document.getElementById('intelligentAlertsPreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/alerts`);
        const result = await response.json();
        if (result.success && result.data) {
          const alerts = result.data;
          const activeCount = alerts.alerts?.filter(a => a.status === 'active').length || 0;
          preview.innerHTML = `Ê¥ªË∑ÉÂëäË≠¶: <strong style="color:#ef4444;">${activeCount}</strong><br>${alerts.summary || 'ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ'}`;
          showIntelligentModal('ÂëäË≠¶Á≥ªÁªü', alerts);
        } else {
          preview.innerHTML = 'ÊöÇÊó†ÂëäË≠¶';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩÂëäË≠¶Â§±Ë¥•:', error);
      }
    }

    // Âä†ËΩΩËá™ÈÄÇÂ∫î‰ºòÂåñÁä∂ÊÄÅ
    async function loadIntelligentOptimization() {
      const preview = document.getElementById('intelligentOptimizationPreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/optimization`);
        const result = await response.json();
        if (result.success && result.data) {
          const optimization = result.data;
          preview.innerHTML = `‰ºòÂåñÁä∂ÊÄÅ: <strong>${optimization.status || 'ËøêË°å‰∏≠'}</strong><br>${optimization.summary || 'ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ'}`;
          showIntelligentModal('Ëá™ÈÄÇÂ∫î‰ºòÂåñ', optimization);
        } else {
          preview.innerHTML = 'ÊöÇÊó†‰ºòÂåñ‰ø°ÊÅØ';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩ‰ºòÂåñ‰ø°ÊÅØÂ§±Ë¥•:', error);
      }
    }

    // Âä†ËΩΩÁü•ËØÜÂõæË∞±
    async function loadIntelligentKnowledge() {
      const preview = document.getElementById('intelligentKnowledgePreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/knowledge`);
        const result = await response.json();
        if (result.success && result.data) {
          const knowledge = result.data;
          preview.innerHTML = `ÂÆû‰ΩìÊï∞Èáè: <strong>${knowledge.entities?.length || 0}</strong><br>${knowledge.summary || 'ÁÇπÂáªÊü•ËØ¢Áü•ËØÜÂõæË∞±'}`;
          showIntelligentModal('Áü•ËØÜÂõæË∞±', knowledge);
        } else {
          preview.innerHTML = 'ÊöÇÊó†Áü•ËØÜÊï∞ÊçÆ';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩÁü•ËØÜÂõæË∞±Â§±Ë¥•:', error);
      }
    }

    // Âä†ËΩΩÊô∫ËÉΩÊä•Âëä
    async function loadIntelligentReports() {
      const preview = document.getElementById('intelligentReportsPreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/reports`);
        const result = await response.json();
        if (result.success && result.data) {
          const reports = result.data;
          const count = reports.reports?.length || 0;
          preview.innerHTML = `ÂÖ±Êúâ <strong>${count}</strong> ‰∏™Êä•Âëä<br>${reports.summary || 'ÁÇπÂáªÊü•ÁúãÊä•Âëä'}`;
          showIntelligentModal('Êô∫ËÉΩÊä•Âëä', reports);
        } else {
          preview.innerHTML = 'ÊöÇÊó†Êä•Âëä';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩÊä•ÂëäÂ§±Ë¥•:', error);
      }
    }

    // ÊòæÁ§∫Êô∫ËÉΩÂäüËÉΩËØ¶ÁªÜ‰ø°ÊÅØÁöÑÊ®°ÊÄÅÊ°Ü
    function showIntelligentModal(title, data) {
      // ÂàõÂª∫ÊàñËé∑ÂèñÊ®°ÊÄÅÊ°Ü
      let modal = document.getElementById('intelligentModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'intelligentModal';
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-content" style="max-width:800px;">
            <div class="modal-header">
              <h3 id="intelligentModalTitle">${title}</h3>
              <button class="btn btn-ghost btn-sm" onclick="closeIntelligentModal()">‚úï</button>
            </div>
            <div class="modal-body" id="intelligentModalBody" style="max-height:70vh;overflow-y:auto;">
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" onclick="closeIntelligentModal()">ÂÖ≥Èó≠</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      document.getElementById('intelligentModalTitle').textContent = title;
      const body = document.getElementById('intelligentModalBody');
      
      // Ê†ºÂºèÂåñÊòæÁ§∫Êï∞ÊçÆ
      body.innerHTML = `<pre style="white-space:pre-wrap;word-wrap:break-word;font-family:inherit;font-size:14px;line-height:1.6;">${JSON.stringify(data, null, 2)}</pre>`;
      
      modal.style.display = 'flex';
    }

    function closeIntelligentModal() {
      const modal = document.getElementById('intelligentModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    // ÂàùÂßãÂåñ
    // ÂÆâÂÖ®ÁâàÊú¨ÁöÑcheckAuthË∞ÉÁî®ÔºàÊ£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÔºâ
    if (!window.__loginInProgress && !window.__justLoggedIn) {
      setTimeout(function() {
        if (!window.__loginInProgress && !window.__justLoggedIn) {
          checkAuth();
        }
      }, 2000);
    }
  </script>
  
  <script>
    // ‰øùÂ≠òÂÖ¨Âëä
    document.getElementById('announcementForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = document.getElementById('announcementId').value;
      const content = document.getElementById('announcementContent').value.trim();
      const active = document.getElementById('announcementActive').checked;
      const token = localStorage.getItem('adminToken');
      
      if (!content) {
        alert('ËØ∑ËæìÂÖ•ÂÖ¨ÂëäÂÜÖÂÆπ');
        return;
      }
      
      try {
        const url = id 
          ? `${getApiUrl()}/admin/announcements/${id}`
          : `${getApiUrl()}/admin/announcements`;
        
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ content, active })
        });
        
        if (!response.ok) throw new Error(id ? 'Êõ¥Êñ∞Â§±Ë¥•' : 'ÂàõÂª∫Â§±Ë¥•');
        
        const result = await response.json();
        if (result.success) {
          document.getElementById('announcementModal').classList.remove('active');
          loadAnnouncements();
          // Â¶ÇÊûúÂΩìÂâçÂú®È¶ñÈ°µÔºåÂà∑Êñ∞‰∏ªÈ°µÂÖ¨ÂëäÊ†è
          const homeView = document.getElementById('homeView');
          if (homeView && homeView.style.display !== 'none') {
            loadHomeAnnouncementBubble();
          }
        }
      } catch (error) {
        alert((id ? 'Êõ¥Êñ∞' : 'ÂàõÂª∫') + 'Â§±Ë¥•Ôºö' + error.message);
      }
    });
    
    // ‰øÆÊîπÂØÜÁ†ÅÂäüËÉΩ
    document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const errorDiv = document.getElementById('passwordChangeError');
      const successDiv = document.getElementById('passwordChangeSuccess');
      const token = localStorage.getItem('adminToken');
      
      // ÈöêËóè‰πãÂâçÁöÑÊ∂àÊÅØ
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';
      
      // È™åËØÅÊñ∞ÂØÜÁ†Å
      if (newPassword.length < 6) {
        errorDiv.textContent = 'Êñ∞ÂØÜÁ†ÅÈïøÂ∫¶Ëá≥Â∞ë‰∏∫6‰Ωç';
        errorDiv.style.display = 'block';
        return;
      }
      
      if (newPassword !== confirmPassword) {
        errorDiv.textContent = '‰∏§Ê¨°ËæìÂÖ•ÁöÑÊñ∞ÂØÜÁ†Å‰∏ç‰∏ÄËá¥';
        errorDiv.style.display = 'block';
        return;
      }
      
      if (oldPassword === newPassword) {
        errorDiv.textContent = 'Êñ∞ÂØÜÁ†Å‰∏çËÉΩ‰∏éÂéüÂØÜÁ†ÅÁõ∏Âêå';
        errorDiv.style.display = 'block';
        return;
      }
      
      try {
        const response = await fetch(`${getApiUrl()}/auth/change-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ oldPassword, newPassword })
        });
        
        const result = await response.json();
        
        if (result.success) {
          successDiv.style.display = 'block';
          document.getElementById('changePasswordForm').reset();
          
          // 3ÁßíÂêéÈöêËóèÊàêÂäüÊ∂àÊÅØ
          setTimeout(() => {
            successDiv.style.display = 'none';
          }, 3000);
        } else {
          errorDiv.textContent = result.error || 'ÂØÜÁ†Å‰øÆÊîπÂ§±Ë¥•';
          errorDiv.style.display = 'block';
        }
      } catch (error) {
        errorDiv.textContent = 'ÂØÜÁ†Å‰øÆÊîπÂ§±Ë¥•Ôºö' + (error.message || 'ÁΩëÁªúÈîôËØØ');
        errorDiv.style.display = 'block';
      }
    });
    
    // ==========================================
    // üì∞ ËµÑËÆØÊõ¥Êñ∞ÂäüËÉΩÔºà‰ªé‰∏ªÁ´ôÁßªÊ§çÔºâ
    // ==========================================
    
    // ËµÑËÆØÊï∞ÊçÆÂ≠òÂÇ®
    let NEWS_DATA = [];
    let currentNewsFilter = 'all';
    let currentNewsRegion = 'local'; // 'local' Êàñ 'national'
    
    // Ëé∑ÂèñAPIÈÖçÁΩÆÔºà‰∏é‰∏ªÁ´ô‰∏ÄËá¥Ôºâ
    function getApiConfig() {
      const config = localStorage.getItem('pigeon_api_config');
      if (config) {
        const parsed = JSON.parse(config);
        // Á°Æ‰øùÊúâapiUrlÂ≠óÊÆµ
        if (!parsed.apiUrl) {
          parsed.apiUrl = 'http://localhost:3000/api';
        }
        return parsed;
      }
      
      // ÈªòËÆ§ÈÖçÁΩÆÔºàÂêéÁ´ØÊúçÂä°Âú∞ÂùÄÔºâ
      const defaultBaseUrl = 'http://localhost:3000/api';
      return {
        apiUrl: defaultBaseUrl, // APIÂü∫Á°ÄÂú∞ÂùÄ
        newsApiUrl: defaultBaseUrl + '/news', // ËµÑËÆØAPIÂú∞ÂùÄ
        eventsApiUrl: defaultBaseUrl + '/events', // Ëµõ‰∫ãAPIÂú∞ÂùÄ
        apiKey: '' // APIÂØÜÈí•ÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
      };
    }
    
    // ‰øùÂ≠òAPIÈÖçÁΩÆ
    function saveApiConfig(config) {
      localStorage.setItem('pigeon_api_config', JSON.stringify(config));
    }
    
    // ‰ªélocalStorageÂä†ËΩΩËµÑËÆØÊï∞ÊçÆ
    function loadNewsFromStorage() {
      const stored = localStorage.getItem('pigeon_news_data');
      const lastUpdate = localStorage.getItem('pigeon_news_last_update');
      
      if (stored && lastUpdate) {
        const lastUpdateDate = new Date(lastUpdate);
        const now = new Date();
        const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
        
        // Â¶ÇÊûúÊï∞ÊçÆÊòØ‰ªäÂ§©ÁöÑÔºåÁõ¥Êé•‰ΩøÁî®
        if (daysDiff === 0) {
          NEWS_DATA = JSON.parse(stored);
          return true;
        }
      }
      
      return false;
    }
    
    // ‰øùÂ≠òËµÑËÆØÊï∞ÊçÆÂà∞localStorage
    function saveNewsToStorage() {
      localStorage.setItem('pigeon_news_data', JSON.stringify(NEWS_DATA));
      localStorage.setItem('pigeon_news_last_update', new Date().toISOString());
    }
    
    // ‰ªéÁúüÂÆûAPIËé∑ÂèñËµÑËÆØÊï∞ÊçÆ
    async function fetchNewsFromWeb() {
      // Ëé∑ÂèñAPIÈÖçÁΩÆ
      const apiConfig = getApiConfig();
      
      if (!apiConfig.newsApiUrl) {
        throw new Error('ËµÑËÆØAPIÊú™ÈÖçÁΩÆÔºåËØ∑Âú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPIÂú∞ÂùÄ');
      }
      
      try {
        // ÊûÑÂª∫ËØ∑Ê±ÇÂ§¥
        const headers = {
          'Content-Type': 'application/json'
        };
        if (apiConfig.apiKey) {
          headers['Authorization'] = 'Bearer ' + apiConfig.apiKey;
        }
        
        // Â∞ùËØï‰ªéAPIËé∑ÂèñÊï∞ÊçÆ
        const response = await fetch(apiConfig.newsApiUrl, {
          method: 'GET',
          headers: headers
        });
        
        if (!response.ok) {
          throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} ${response.statusText}`);
        }
        
        const result = await response.json();
        
        // ÂêéÁ´ØAPIËøîÂõûÊ†ºÂºè: {success: true, data: [...], count: X, timestamp: "..."}
        if (!result.success) {
          throw new Error(result.error || 'APIËøîÂõûÈîôËØØ');
        }
        
        const data = result.data || result;
        
        // È™åËØÅÊï∞ÊçÆÊ†ºÂºè
        if (!Array.isArray(data)) {
          throw new Error('APIËøîÂõûÁöÑÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∫î‰∏∫Êï∞ÁªÑ');
        }
        
        // ËΩ¨Êç¢Êï∞ÊçÆÊ†ºÂºè
        return data.map(item => ({
          id: item.id || Date.now() + Math.random(),
          title: item.title || 'Êó†Ê†áÈ¢ò',
          source: item.source || 'Êú™Áü•Êù•Ê∫ê',
          sourceUrl: item.sourceUrl || item.url || '#',
          time: item.time || formatUpdateTime(item.updateTime),
          updateTime: item.updateTime || new Date().toISOString(),
          tags: item.tags || [],
          category: item.category || 'race',
          region: item.region || 'national',
          content: item.content || item.description || '',
          hot: item.hot || false
        }));
        
      } catch (error) {
        console.error('Ëé∑ÂèñËµÑËÆØÂ§±Ë¥•:', error);
        throw error;
      }
    }
    
    // Ê†ºÂºèÂåñÊõ¥Êñ∞Êó∂Èó¥
    function formatUpdateTime(updateTime) {
      if (!updateTime) return 'Êú™Áü•';
      const date = new Date(updateTime);
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 60) {
        return `${minutes}ÂàÜÈíüÂâç`;
      } else if (hours < 24) {
        return `${hours}Â∞èÊó∂Ââç`;
      } else if (days < 7) {
        return `${days}Â§©Ââç`;
      } else {
        return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
      }
    }
    
    // Ê∏≤ÊüìËµÑËÆØÂàóË°®
    function renderNewsList(filter = 'all', region = 'local') {
      const container = document.getElementById('homeNewsList');
      if (!container) return;
      
      // ÂÖàÊåâÂú∞Âå∫Á≠õÈÄâ
      let filteredNews = NEWS_DATA.filter(n => n.region === region);
      
      // ÂÜçÊåâÂàÜÁ±ªÁ≠õÈÄâ
      if (filter !== 'all') {
        filteredNews = filteredNews.filter(n => n.category === filter);
      }
      
      // ÊåâÊõ¥Êñ∞Êó∂Èó¥ÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
      filteredNews.sort((a, b) => {
        const timeA = new Date(a.updateTime || 0);
        const timeB = new Date(b.updateTime || 0);
        return timeB - timeA;
      });
      
      if (filteredNews.length === 0) {
        const apiConfig = getApiConfig();
        if (!apiConfig.newsApiUrl) {
          // APIÊú™ÈÖçÁΩÆÔºåÊòæÁ§∫ÈÖçÁΩÆÊèêÁ§∫
          showApiConfigPrompt('ËµÑËÆØ');
          return;
        }
        
        container.innerHTML = `
          <div style="padding:40px;text-align:center;color:#9ca3af;">
            <div style="font-size:48px;margin-bottom:16px;">üì∞</div>
            <div>ÊöÇÊó†${region === 'local' ? 'Êú¨Âú∞' : 'ÂÖ®ÂõΩ'}ËµÑËÆØ</div>
            <div style="font-size:12px;margin-top:8px;">ÁÇπÂáª"Âà∑Êñ∞ËµÑËÆØ"ÊåâÈíÆËé∑ÂèñÊúÄÊñ∞ËµÑËÆØ</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredNews.map(news => {
        const updateTimeStr = formatUpdateTime(news.updateTime);
        return `
          <div class="news-card" data-news-id="${news.id}">
            <div class="news-card-header">
              <div class="news-card-title">${news.title}</div>
              <div class="news-card-time">${news.time}</div>
            </div>
            <div class="news-card-source">Êù•Ê∫êÔºö${news.source}</div>
            <div class="news-card-update-time">Êõ¥Êñ∞Êó∂Èó¥Ôºö${updateTimeStr}</div>
            <div class="news-card-tags">
              ${news.hot ? '<span class="news-tag hot">üî• ÁÉ≠Èó®</span>' : ''}
              ${news.tags.map(tag => `<span class="news-tag ${news.category}">#${tag}</span>`).join('')}
            </div>
            <div class="news-card-actions">
              <button class="news-card-action-btn" onclick="viewNewsDetail(${news.id})">üìñ Êü•ÁúãËØ¶ÊÉÖ</button>
              <button class="news-card-action-btn primary" onclick="openNewsOriginal(${news.id})">üîó Êü•ÁúãÂéüÊñá</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Êü•ÁúãËµÑËÆØËØ¶ÊÉÖÔºàÊö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºâ
    window.viewNewsDetail = function(newsId) {
      const news = NEWS_DATA.find(n => n.id === newsId);
      if (!news) {
        alert('ËµÑËÆØ‰∏çÂ≠òÂú®');
        return;
      }
      
      const modal = document.getElementById('newsModal');
      if (!modal) return;
      
      const titleEl = document.getElementById('newsModalTitle');
      const sourceEl = document.getElementById('newsModalSource');
      const regionEl = document.getElementById('newsModalRegion');
      const updateTimeEl = document.getElementById('newsModalUpdateTime');
      const contentEl = document.getElementById('newsModalContent');
      
      if (titleEl) titleEl.textContent = news.title;
      if (sourceEl) sourceEl.textContent = `Êù•Ê∫êÔºö${news.source}`;
      if (regionEl) regionEl.textContent = news.region === 'local' ? 'üìç Êú¨Âú∞ËµÑËÆØ' : 'üåê ÂÖ®ÂõΩËµÑËÆØ';
      if (updateTimeEl) updateTimeEl.textContent = `Êõ¥Êñ∞Êó∂Èó¥Ôºö${formatUpdateTime(news.updateTime)}`;
      if (contentEl) contentEl.textContent = news.content || 'ÊöÇÊó†ËØ¶ÁªÜÂÜÖÂÆπ';
      
      // ËÆæÁΩÆÊü•ÁúãÂéüÊñáÊåâÈíÆÁöÑÈìæÊé•
      const viewOriginalBtn = document.getElementById('newsModalViewOriginal');
      if (viewOriginalBtn) {
        viewOriginalBtn.onclick = () => window.openNewsOriginal(newsId);
      }
      
      modal.classList.add('active');
    };
    
    // ÊâìÂºÄÂéüËµÑËÆØÈìæÊé•ÔºàÊö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºâ
    window.openNewsOriginal = function(newsId) {
      const news = NEWS_DATA.find(n => n.id === newsId);
      if (!news || !news.sourceUrl) {
        alert('ÂéüËµÑËÆØÈìæÊé•‰∏çÂ≠òÂú®');
        return;
      }
      
      window.open(news.sourceUrl, '_blank');
    };
    
    // ÂÖ≥Èó≠ËµÑËÆØËØ¶ÊÉÖÂºπÁ™ó
    function closeNewsModal() {
      const modal = document.getElementById('newsModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }
    
    // Ëá™Âä®Êõ¥Êñ∞ËµÑËÆØ
    async function updateNews() {
      try {
        const news = await fetchNewsFromWeb();
        NEWS_DATA = news;
        saveNewsToStorage();
        renderNewsList(currentNewsFilter, currentNewsRegion);
        updateHomeStats();
        console.log('ËµÑËÆØÊõ¥Êñ∞ÊàêÂäüÔºåÂÖ±Ëé∑Âèñ', news.length, 'Êù°ËµÑËÆØ');
      } catch (error) {
        console.error('Êõ¥Êñ∞ËµÑËÆØÂ§±Ë¥•:', error);
        
        // Â¶ÇÊûúAPIÊú™ÈÖçÁΩÆÔºåÊòæÁ§∫ÈÖçÁΩÆÊèêÁ§∫
        if (error.message && error.message.includes('Êú™ÈÖçÁΩÆ')) {
          NEWS_DATA = [];
          renderNewsList(currentNewsFilter, currentNewsRegion);
          showApiConfigPrompt('ËµÑËÆØ');
          return;
        }
        
        // Â¶ÇÊûúÊõ¥Êñ∞Â§±Ë¥•ÔºåÂ∞ùËØïÂä†ËΩΩÁºìÂ≠òÊï∞ÊçÆ
        if (loadNewsFromStorage()) {
          renderNewsList(currentNewsFilter, currentNewsRegion);
        } else {
          // Ê≤°ÊúâÁºìÂ≠òÊï∞ÊçÆÔºåÊòæÁ§∫ÈîôËØØÊèêÁ§∫
          NEWS_DATA = [];
          renderNewsList(currentNewsFilter, currentNewsRegion);
        }
      }
    }
    
    // ÊòæÁ§∫APIÈÖçÁΩÆÊèêÁ§∫
    function showApiConfigPrompt(type) {
      const container = type === 'ËµÑËÆØ' ? document.getElementById('homeNewsList') : document.getElementById('homeEventsList');
      if (!container) return;
      
      const apiConfig = getApiConfig();
      const apiUrl = type === 'ËµÑËÆØ' ? apiConfig.newsApiUrl : apiConfig.eventsApiUrl;
      
      if (!apiUrl) {
        container.innerHTML = `
          <div style="padding:40px;text-align:center;color:#9ca3af;">
            <div style="font-size:48px;margin-bottom:16px;">${type === 'ËµÑËÆØ' ? 'üì∞' : 'üèÅ'}</div>
            <div style="font-size:16px;font-weight:600;color:#374151;margin-bottom:8px;">${type}APIÊú™ÈÖçÁΩÆ</div>
            <div style="font-size:13px;color:#6b7280;margin-bottom:16px;">ËØ∑ÈÖçÁΩÆ${type}APIÂú∞ÂùÄ‰ª•Ëé∑ÂèñÁúüÂÆûÊï∞ÊçÆ</div>
            <button class="btn btn-primary btn-sm" onclick="showApiConfigModal('${type}')" style="margin-top:12px;">
              ‚öôÔ∏è ÈÖçÁΩÆAPI
            </button>
          </div>
        `;
      }
    }
    
    // ÊòæÁ§∫APIÈÖçÁΩÆÂºπÁ™ó
    window.showApiConfigModal = function(type) {
      const apiConfig = getApiConfig();
      const apiUrl = type === 'ËµÑËÆØ' ? apiConfig.newsApiUrl : apiConfig.eventsApiUrl;
      const apiKey = apiConfig.apiKey || '';
      
      const newsApiUrl = prompt(`ËØ∑ËæìÂÖ•${type === 'ËµÑËÆØ' ? 'ËµÑËÆØ' : 'Ëµõ‰∫ã'}APIÂú∞ÂùÄ:`, apiUrl || '');
      if (newsApiUrl === null) return; // Áî®Êà∑ÂèñÊ∂à
      
      const newApiKey = prompt('ËØ∑ËæìÂÖ•APIÂØÜÈí•ÔºàÂèØÈÄâÔºåÁõ¥Êé•ÂõûËΩ¶Ë∑≥ËøáÔºâ:', apiKey);
      
      const newConfig = {
        ...apiConfig,
        [type === 'ËµÑËÆØ' ? 'newsApiUrl' : 'eventsApiUrl']: newsApiUrl,
        apiKey: newApiKey || apiKey
      };
      
      saveApiConfig(newConfig);
      
      // ÈáçÊñ∞Â∞ùËØïËé∑ÂèñÊï∞ÊçÆ
      if (type === 'ËµÑËÆØ') {
        updateNews();
      }
      
      alert('APIÈÖçÁΩÆÂ∑≤‰øùÂ≠òÔºåÊ≠£Âú®Ëé∑ÂèñÊï∞ÊçÆ...');
    };
    
    // Êõ¥Êñ∞È¶ñÈ°µÁªüËÆ°
    function updateHomeStats() {
      const pigeonCountEl = document.getElementById('homePigeonCount');
      if (pigeonCountEl) {
        // ËøôÈáåÂèØ‰ª•‰ªélocalStorageËé∑ÂèñÈ∏ΩÂ≠êÊï∞ÊçÆ
        try {
          const pigeonsData = localStorage.getItem('pigeons');
          if (pigeonsData) {
            const pigeons = JSON.parse(pigeonsData);
            pigeonCountEl.textContent = pigeons.filter(p => p && p.alive).length || 0;
          } else {
            pigeonCountEl.textContent = '0';
          }
        } catch (e) {
          pigeonCountEl.textContent = '0';
        }
      }
      
      // Êõ¥Êñ∞ÂÖ∂‰ªñÁªüËÆ°
      const newsCountEl = document.getElementById('homeNewsCount');
      if (newsCountEl) {
        newsCountEl.textContent = NEWS_DATA.length || 0;
      }
      
      // Êõ¥Êñ∞Ëµõ‰∫ãÁªüËÆ°
      const activeRacesEl = document.getElementById('homeActiveRaces');
      if (activeRacesEl) {
        activeRacesEl.textContent = (EVENTS_DATA.ongoing || []).length;
      }
      
      const completedRacesEl = document.getElementById('homeCompletedRaces');
      if (completedRacesEl) {
        completedRacesEl.textContent = (EVENTS_DATA.results || []).length;
      }
      
      // Êõ¥Êñ∞Êó•ÊúüÊòæÁ§∫
      const now = new Date();
      const dayEl = document.getElementById('homeDay');
      const weekdayEl = document.getElementById('homeWeekday');
      const dateFullEl = document.getElementById('homeDateFull');
      
      if (dayEl) dayEl.textContent = now.getDate();
      if (weekdayEl) {
        const weekdays = ['Âë®Êó•', 'Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠'];
        weekdayEl.textContent = weekdays[now.getDay()];
      }
      if (dateFullEl) {
        dateFullEl.textContent = `${now.getFullYear()}Âπ¥${now.getMonth() + 1}Êúà`;
      }
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞ËµÑËÆØÔºàÊØèÂ§©Êõ¥Êñ∞‰∏ÄÊ¨°Ôºâ
    function checkAndUpdateNews() {
      const lastUpdate = localStorage.getItem('pigeon_news_last_update');
      if (!lastUpdate) {
        // È¶ñÊ¨°Âä†ËΩΩÔºåÁõ¥Êé•Êõ¥Êñ∞
        updateNews();
        return;
      }
      
      const lastUpdateDate = new Date(lastUpdate);
      const now = new Date();
      const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
      
      if (daysDiff >= 1) {
        // Ë∂ÖËøá1Â§©ÔºåÈúÄË¶ÅÊõ¥Êñ∞
        updateNews();
      } else {
        // ‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ
        if (loadNewsFromStorage()) {
          renderNewsList(currentNewsFilter, currentNewsRegion);
        } else {
          // Â¶ÇÊûúÊ≤°ÊúâÁºìÂ≠òÔºåÂàôÊõ¥Êñ∞
          updateNews();
        }
      }
    }
    
    // ==========================================
    // üèÅ ÂÆûÊó∂Ëµõ‰∫ãÂäüËÉΩÔºà‰ªé‰∏ªÁ´ôÁßªÊ§çÔºâ
    // ==========================================
    
    // Ëµõ‰∫ãÊï∞ÊçÆÂ≠òÂÇ®
    let EVENTS_DATA = {
      ongoing: [],
      upcoming: [],
      results: []
    };
    
    let currentEventTab = 'ongoing';
    let currentEventRegion = 'local'; // 'local' Êàñ 'national'
    
    // ‰ªélocalStorageÂä†ËΩΩËµõ‰∫ãÊï∞ÊçÆ
    function loadEventsFromStorage() {
      const stored = localStorage.getItem('pigeon_events_data');
      const lastUpdate = localStorage.getItem('pigeon_events_last_update');
      
      if (stored && lastUpdate) {
        const lastUpdateDate = new Date(lastUpdate);
        const now = new Date();
        const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
        
        // Â¶ÇÊûúÊï∞ÊçÆÊòØ‰ªäÂ§©ÁöÑÔºåÁõ¥Êé•‰ΩøÁî®
        if (daysDiff === 0) {
          EVENTS_DATA = JSON.parse(stored);
          return true;
        }
      }
      
      return false;
    }
    
    // ‰øùÂ≠òËµõ‰∫ãÊï∞ÊçÆÂà∞localStorage
    function saveEventsToStorage() {
      localStorage.setItem('pigeon_events_data', JSON.stringify(EVENTS_DATA));
      localStorage.setItem('pigeon_events_last_update', new Date().toISOString());
    }
    
    // ‰ªéÁúüÂÆûAPIËé∑ÂèñËµõ‰∫ãÊï∞ÊçÆ
    async function fetchEventsFromWeb() {
      // Ëé∑ÂèñAPIÈÖçÁΩÆ
      const apiConfig = getApiConfig();
      
      if (!apiConfig.eventsApiUrl) {
        throw new Error('Ëµõ‰∫ãAPIÊú™ÈÖçÁΩÆÔºåËØ∑Âú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPIÂú∞ÂùÄ');
      }
      
      try {
        // ÊûÑÂª∫ËØ∑Ê±ÇÂ§¥
        const headers = {
          'Content-Type': 'application/json'
        };
        if (apiConfig.apiKey) {
          headers['Authorization'] = 'Bearer ' + apiConfig.apiKey;
        }
        
        // Â∞ùËØï‰ªéAPIËé∑ÂèñÊï∞ÊçÆÔºàËé∑ÂèñÊâÄÊúâÁ±ªÂûãÁöÑËµõ‰∫ãÔºâ
        const response = await fetch(apiConfig.eventsApiUrl, {
          method: 'GET',
          headers: headers
        });
        
        if (!response.ok) {
          const errorText = await response.text().catch(() => '');
          throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} ${response.statusText}. ${errorText}`);
        }
        
        const result = await response.json();
        
        // ÂêéÁ´ØAPIËøîÂõûÊ†ºÂºè: {success: true, data: {ongoing: [], upcoming: [], results: []}}
        if (!result.success) {
          throw new Error(result.error || result.message || 'APIËøîÂõûÈîôËØØ');
        }
        
        const data = result.data || result;
        
        // È™åËØÅÊï∞ÊçÆÊ†ºÂºè
        if (!data.ongoing || !data.upcoming || !data.results) {
          throw new Error('APIËøîÂõûÁöÑÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∫îÂåÖÂê´ongoing„ÄÅupcoming„ÄÅresultsÂ≠óÊÆµ');
        }
        
        // ËΩ¨Êç¢Êï∞ÊçÆÊ†ºÂºèÂπ∂È™åËØÅ
        const now = new Date();
        return {
          ongoing: (data.ongoing || []).map(item => {
            const releaseTimeFull = item.releaseTimeFull ? new Date(item.releaseTimeFull) : null;
            const endTimeFull = item.endTimeFull ? new Date(item.endTimeFull) : null;
            
            if (endTimeFull && endTimeFull <= now) {
              return null;
            }
            
            if (releaseTimeFull && releaseTimeFull > now) {
              return null;
            }
            
            return {
              id: item.id || Date.now() + Math.random(),
              name: item.name || 'Êú™Áü•Ëµõ‰∫ã',
              organizer: item.organizer || 'Êú™Áü•ÁªÑÁªá',
              source: item.source || 'Êú™Áü•Êù•Ê∫ê',
              sourceUrl: item.sourceUrl || item.url || '#',
              releaseTime: item.releaseTime || 'Êú™Áü•Êó∂Èó¥',
              releaseTimeFull: item.releaseTimeFull || new Date().toISOString(),
              endTimeFull: item.endTimeFull || null,
              distance: item.distance || 'Êú™Áü•Ë∑ùÁ¶ª',
              status: 'ongoing',
              region: item.region || 'national',
              returned: item.returned || 0,
              total: item.total || 0,
              weather: item.weather || 'Êú™Áü•',
              updateTime: item.updateTime || new Date().toISOString()
            };
          }).filter(item => item !== null),
          upcoming: (data.upcoming || []).map(item => {
            const startTimeFull = item.startTimeFull ? new Date(item.startTimeFull) : null;
            
            if (startTimeFull && startTimeFull <= now) {
              return null;
            }
            
            return {
              id: item.id || Date.now() + Math.random(),
              name: item.name || 'Êú™Áü•Ëµõ‰∫ã',
              organizer: item.organizer || 'Êú™Áü•ÁªÑÁªá',
              source: item.source || 'Êú™Áü•Êù•Ê∫ê',
              sourceUrl: item.sourceUrl || item.url || '#',
              startTime: item.startTime || 'Êú™Áü•Êó∂Èó¥',
              startTimeFull: item.startTimeFull || new Date(now.getTime() + 86400000).toISOString(),
              distance: item.distance || 'Êú™Áü•Ë∑ùÁ¶ª',
              status: 'upcoming',
              region: item.region || 'national',
              participants: item.participants || 0,
              weather: item.weather || 'Êú™Áü•',
              updateTime: item.updateTime || new Date().toISOString()
            };
          }).filter(item => item !== null),
          results: (data.results || []).map(item => {
            const endTimeFull = item.endTimeFull ? new Date(item.endTimeFull) : null;
            
            if (endTimeFull && endTimeFull > now) {
              return null;
            }
            
            return {
              id: item.id || Date.now() + Math.random(),
              name: item.name || 'Êú™Áü•Ëµõ‰∫ã',
              organizer: item.organizer || 'Êú™Áü•ÁªÑÁªá',
              source: item.source || 'Êú™Áü•Êù•Ê∫ê',
              sourceUrl: item.sourceUrl || item.url || '#',
              endTime: item.endTime || 'Êú™Áü•Êó∂Èó¥',
              endTimeFull: item.endTimeFull || new Date(now.getTime() - 86400000).toISOString(),
              distance: item.distance || 'Êú™Áü•Ë∑ùÁ¶ª',
              status: 'completed',
              region: item.region || 'national',
              champion: item.champion || 'Êú™Áü•',
              championRing: item.championRing || 'Êú™Áü•',
              championTime: item.championTime || 'Êú™Áü•',
              updateTime: item.updateTime || new Date().toISOString()
            };
          }).filter(item => item !== null)
        };
        
      } catch (error) {
        console.error('Ëé∑ÂèñËµõ‰∫ãÂ§±Ë¥•:', error);
        throw error;
      }
    }
    
    // È™åËØÅËµõ‰∫ãÊó∂Èó¥ÊòØÂê¶ÊúâÊïà
    function isValidEventTime(event, tab) {
      const now = new Date();
      
      if (tab === 'ongoing') {
        if (!event.releaseTimeFull) return false;
        const releaseTime = new Date(event.releaseTimeFull);
        const hoursSinceRelease = (now - releaseTime) / (1000 * 60 * 60);
        if (hoursSinceRelease > 24) return false;
        if (releaseTime > now) return false;
        return true;
      } else if (tab === 'upcoming') {
        if (!event.startTimeFull) return false;
        const startTime = new Date(event.startTimeFull);
        if (startTime <= now) return false;
        return true;
      } else if (tab === 'results') {
        if (!event.endTimeFull) return false;
        const endTime = new Date(event.endTimeFull);
        if (endTime > now) return false;
        return true;
      }
      
      return true;
    }
    
    // È™åËØÅËµõ‰∫ãÊï∞ÊçÆÊòØÂê¶ËøáÊó∂
    function isEventOutdated(event) {
      if (!event.updateTime) return true;
      
      const updateTime = new Date(event.updateTime);
      const now = new Date();
      const hoursSinceUpdate = (now - updateTime) / (1000 * 60 * 60);
      
      if (event.status === 'ongoing' && hoursSinceUpdate > 2) {
        return true;
      }
      
      if (hoursSinceUpdate > 24) {
        return true;
      }
      
      return false;
    }
    
    // Ê∏≤ÊüìËµõ‰∫ãÂàóË°®
    function renderEventsList(tab = 'ongoing', region = 'local') {
      const container = document.getElementById('homeEventsList');
      if (!container) return;
      
      // ÂÖàÊåâÂú∞Âå∫Á≠õÈÄâ
      let events = (EVENTS_DATA[tab] || []).filter(event => event.region === region);
      
      // ËøáÊª§ÊéâÊó∂Èó¥‰∏çÂêªÂêàÁöÑËµõ‰∫ã
      events = events.filter(event => isValidEventTime(event, tab));
      
      // ËøáÊª§ÊéâËøáÊó∂ÁöÑËµõ‰∫ã
      events = events.filter(event => !isEventOutdated(event));
      
      // ÂØπ‰∫é"ËøõË°å‰∏≠"ÁöÑËµõ‰∫ãÔºåÈ¢ùÂ§ñÈ™åËØÅ
      if (tab === 'ongoing') {
        events = events.filter(event => {
          if (event.endTimeFull) {
            const endTime = new Date(event.endTimeFull);
            if (endTime <= new Date()) {
              return false;
            }
          }
          return true;
        });
      }
      
      // ÊåâÊõ¥Êñ∞Êó∂Èó¥ÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
      events.sort((a, b) => {
        const timeA = new Date(a.updateTime || 0);
        const timeB = new Date(b.updateTime || 0);
        return timeB - timeA;
      });
      
      if (events.length === 0) {
        const apiConfig = getApiConfig();
        if (!apiConfig.eventsApiUrl) {
          showApiConfigPrompt('Ëµõ‰∫ã');
          return;
        }
        
        container.innerHTML = `
          <div style="padding:40px;text-align:center;color:#9ca3af;">
            <div style="font-size:48px;margin-bottom:16px;">üèÅ</div>
            <div>ÊöÇÊó†${region === 'local' ? 'Êú¨Âú∞' : 'ÂÖ®ÂõΩ'}${tab === 'ongoing' ? 'ËøõË°å‰∏≠' : tab === 'upcoming' ? 'Âç≥Â∞ÜÂºÄÂßã' : 'ÊúÄÊñ∞ÊàêÁª©'}Ëµõ‰∫ã</div>
            <div style="font-size:12px;margin-top:8px;">ÁÇπÂáª"Âà∑Êñ∞"ÊåâÈíÆËé∑ÂèñÊúÄÊñ∞Ëµõ‰∫ã</div>
          </div>
        `;
        return;
      }
      
      if (tab === 'ongoing') {
        container.innerHTML = events.map(event => {
          const updateTimeStr = formatUpdateTime(event.updateTime);
          const progressPercent = event.total > 0 ? ((event.returned / event.total) * 100).toFixed(1) : 0;
          return `
            <div class="event-card" style="cursor:pointer;" onclick="openEventUrl('${event.sourceUrl || '#'}')">
              <div class="event-card-status ongoing">
                <span>ËøõË°å‰∏≠</span>
              </div>
              <div class="event-card-title">${event.name}</div>
              <div class="event-card-info">
                <div class="event-card-info-item">
                  <span>üè¢</span>
                  <span>${event.organizer}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üìè</span>
                  <span>${event.distance}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üïê</span>
                  <span>ÊîæÈ£ûÔºö${event.releaseTime}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üå§Ô∏è</span>
                  <span>${event.weather}</span>
                </div>
              </div>
              <div class="event-card-progress">
                <div class="event-progress-bar">
                  <div class="event-progress-fill" style="width:${progressPercent}%;"></div>
                </div>
                <div class="event-progress-text">Â∑≤ÂΩíÂ∑¢ ${event.returned} / ${event.total} Âè™Ôºà${progressPercent}%Ôºâ</div>
              </div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
                <span>üì∞ Êù•Ê∫êÔºö${event.source || 'Êú™Áü•'}</span>
                <span>üïê Êõ¥Êñ∞Ôºö${updateTimeStr}</span>
              </div>
              ${event.sourceUrl && event.sourceUrl !== '#' ? `
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                <button class="btn btn-outline btn-sm" style="width:100%;" onclick="event.stopPropagation();window.open('${event.sourceUrl}', '_blank')">
                  üîó Êü•ÁúãÂéüËµõ‰∫ãÁΩëÈ°µ
                </button>
              </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } else if (tab === 'upcoming') {
        container.innerHTML = events.map(event => {
          const updateTimeStr = formatUpdateTime(event.updateTime);
          return `
            <div class="event-card" style="cursor:pointer;" onclick="openEventUrl('${event.sourceUrl || '#'}')">
              <div class="event-card-status upcoming">Âç≥Â∞ÜÂºÄÂßã</div>
              <div class="event-card-title">${event.name}</div>
              <div class="event-card-info">
                <div class="event-card-info-item">
                  <span>üè¢</span>
                  <span>${event.organizer}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üìè</span>
                  <span>${event.distance}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üïê</span>
                  <span>ÂºÄÂßãÔºö${event.startTime}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üïäÔ∏è</span>
                  <span>ÂèÇËµõÔºö${event.participants}Âè™</span>
                </div>
              </div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
                <span>üì∞ Êù•Ê∫êÔºö${event.source || 'Êú™Áü•'}</span>
                <span>üïê Êõ¥Êñ∞Ôºö${updateTimeStr}</span>
              </div>
              ${event.sourceUrl && event.sourceUrl !== '#' ? `
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                <button class="btn btn-outline btn-sm" style="width:100%;" onclick="event.stopPropagation();window.open('${event.sourceUrl}', '_blank')">
                  üîó Êü•ÁúãÂéüËµõ‰∫ãÁΩëÈ°µ
                </button>
              </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } else if (tab === 'results') {
        container.innerHTML = events.map(event => {
          const updateTimeStr = formatUpdateTime(event.updateTime);
          return `
            <div class="event-card" style="cursor:pointer;" onclick="openEventUrl('${event.sourceUrl || '#'}')">
              <div class="event-card-status completed">Â∑≤ÁªìÊùü</div>
              <div class="event-card-title">${event.name}</div>
              <div class="event-card-info">
                <div class="event-card-info-item">
                  <span>üè¢</span>
                  <span>${event.organizer}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üìè</span>
                  <span>${event.distance}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üïê</span>
                  <span>ÁªìÊùüÔºö${event.endTime}</span>
                </div>
                <div class="event-card-info-item">
                  <span>üèÜ</span>
                  <span>ÂÜ†ÂÜõÔºö${event.champion} (${event.championRing})</span>
                </div>
                ${event.championTime ? `
                <div class="event-card-info-item">
                  <span>‚è±Ô∏è</span>
                  <span>ÊàêÁª©Ôºö${event.championTime}</span>
                </div>
                ` : ''}
              </div>
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
                <span>üì∞ Êù•Ê∫êÔºö${event.source || 'Êú™Áü•'}</span>
                <span>üïê Êõ¥Êñ∞Ôºö${updateTimeStr}</span>
              </div>
              ${event.sourceUrl && event.sourceUrl !== '#' ? `
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                <button class="btn btn-outline btn-sm" style="width:100%;" onclick="event.stopPropagation();window.open('${event.sourceUrl}', '_blank')">
                  üîó Êü•ÁúãÂéüËµõ‰∫ãÁΩëÈ°µ
                </button>
              </div>
              ` : ''}
            </div>
          `;
        }).join('');
      }
    }
    
    // ÊâìÂºÄËµõ‰∫ãÈìæÊé•ÔºàÊö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºâ
    window.openEventUrl = function(url) {
      if (url && url !== '#') {
        window.open(url, '_blank');
      }
    };
    
    // Ëá™Âä®Êõ¥Êñ∞Ëµõ‰∫ã
    async function updateEvents() {
      try {
        const events = await fetchEventsFromWeb();
        
        // ÂÜçÊ¨°È™åËØÅÂíåËøáÊª§Êï∞ÊçÆ
        const now = new Date();
        
        // ËøáÊª§ËøõË°å‰∏≠ÁöÑËµõ‰∫ã
        events.ongoing = events.ongoing.filter(event => {
          if (!event.releaseTimeFull) return false;
          const releaseTime = new Date(event.releaseTimeFull);
          if (releaseTime > now) return false;
          
          if (event.endTimeFull) {
            const endTime = new Date(event.endTimeFull);
            if (endTime <= now) return false;
          }
          
          if (event.updateTime) {
            const updateTime = new Date(event.updateTime);
            const hoursSinceUpdate = (now - updateTime) / (1000 * 60 * 60);
            if (hoursSinceUpdate > 2) return false;
          }
          
          return true;
        });
        
        // ËøáÊª§Âç≥Â∞ÜÂºÄÂßãÁöÑËµõ‰∫ã
        events.upcoming = events.upcoming.filter(event => {
          if (!event.startTimeFull) return false;
          const startTime = new Date(event.startTimeFull);
          return startTime > now;
        });
        
        // ËøáÊª§Â∑≤ÁªìÊùüÁöÑËµõ‰∫ã
        events.results = events.results.filter(event => {
          if (!event.endTimeFull) return false;
          const endTime = new Date(event.endTimeFull);
          return endTime <= now;
        });
        
        EVENTS_DATA = events;
        saveEventsToStorage();
        renderEventsList(currentEventTab, currentEventRegion);
        updateHomeStats();
        console.log('Ëµõ‰∫ãÊõ¥Êñ∞ÊàêÂäüÔºåÂÖ±Ëé∑Âèñ', 
          events.ongoing.length + events.upcoming.length + events.results.length, 
          'Âú∫ÊúâÊïàËµõ‰∫ã');
      } catch (error) {
        console.error('Êõ¥Êñ∞Ëµõ‰∫ãÂ§±Ë¥•:', error);
        
        // Â¶ÇÊûúAPIÊú™ÈÖçÁΩÆÔºåÊòæÁ§∫ÈÖçÁΩÆÊèêÁ§∫
        if (error.message && error.message.includes('Êú™ÈÖçÁΩÆ')) {
          EVENTS_DATA = { ongoing: [], upcoming: [], results: [] };
          renderEventsList(currentEventTab, currentEventRegion);
          showApiConfigPrompt('Ëµõ‰∫ã');
          return;
        }
        
        // Â¶ÇÊûúÊõ¥Êñ∞Â§±Ë¥•ÔºåÂ∞ùËØïÂä†ËΩΩÁºìÂ≠òÊï∞ÊçÆ
        if (loadEventsFromStorage()) {
          renderEventsList(currentEventTab, currentEventRegion);
        } else {
          // Ê≤°ÊúâÁºìÂ≠òÊï∞ÊçÆÔºåÊòæÁ§∫ÈîôËØØÊèêÁ§∫
          EVENTS_DATA = { ongoing: [], upcoming: [], results: [] };
          renderEventsList(currentEventTab, currentEventRegion);
        }
      }
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞Ëµõ‰∫ã
    function checkAndUpdateEvents() {
      const lastUpdate = localStorage.getItem('pigeon_events_last_update');
      if (!lastUpdate) {
        updateEvents();
        return;
      }
      
      const lastUpdateDate = new Date(lastUpdate);
      const now = new Date();
      const minutesSinceUpdate = (now - lastUpdateDate) / (1000 * 60);
      
      const hasOngoingEvents = (EVENTS_DATA.ongoing || []).length > 0;
      
      if (hasOngoingEvents) {
        if (minutesSinceUpdate >= 5) {
          updateEvents();
        } else {
          if (loadEventsFromStorage()) {
            renderEventsList(currentEventTab, currentEventRegion);
          } else {
            updateEvents();
          }
        }
      } else {
        if (minutesSinceUpdate >= 60) {
          updateEvents();
        } else {
          if (loadEventsFromStorage()) {
            renderEventsList(currentEventTab, currentEventRegion);
          } else {
            updateEvents();
          }
        }
      }
    }
    
    // Âä†ËΩΩ‰∏ªÈ°µÂÖ¨ÂëäÊ†è
    // Â≠òÂÇ®È¶ñÈ°µÂΩìÂâçÂÖ¨ÂëäÊï∞ÊçÆ
    let homeCurrentAnnouncement = null;
    
    async function loadHomeAnnouncementBubble() {
      const bubbleEl = document.getElementById('homeAnnouncementBubbleText');
      const hintEl = document.getElementById('homeAnnouncementHint');
      const bubbleContainer = document.getElementById('homeAnnouncementBubble');
      if (!bubbleEl) return;
      
      const token = localStorage.getItem('adminToken');
      if (!token) {
        bubbleEl.textContent = 'ÊöÇÊó†ÂÖ¨Âëä';
        homeCurrentAnnouncement = null;
        if (hintEl) hintEl.style.display = 'none';
        if (bubbleContainer) bubbleContainer.style.cursor = 'default';
        return;
      }
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`${getApiUrl()}/admin/announcements`, {
          headers: {
            'Authorization': `Bearer ${token}`
          },
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error('Ëé∑ÂèñÂÖ¨ÂëäÂ§±Ë¥•');
        }
        
        const result = await response.json();
        const announcements = result.data || [];
        
        // ‰øùÂ≠òÂÖ¨ÂëäÊï∞ÊçÆ‰æõÊü•Áúã‰ΩøÁî®
        window.announcementsData = announcements;
        
        // Ëé∑ÂèñÊúÄÊñ∞ÁöÑÂ∑≤ÂèëÂ∏ÉÂÖ¨Âëä
        const activeAnnouncements = announcements.filter(ann => ann.active);
        if (activeAnnouncements.length > 0) {
          // ÊåâÊõ¥Êñ∞Êó∂Èó¥ÊéíÂ∫èÔºåËé∑ÂèñÊúÄÊñ∞ÁöÑ
          activeAnnouncements.sort((a, b) => {
            const timeA = new Date(a.updatedAt || a.createdAt);
            const timeB = new Date(b.updatedAt || b.createdAt);
            return timeB - timeA;
          });
          
          const latestAnnouncement = activeAnnouncements[0];
          homeCurrentAnnouncement = latestAnnouncement;
          
          const content = latestAnnouncement.content || 'ÊöÇÊó†ÂÖ¨Âëä';
          
          // Â¶ÇÊûúÂÜÖÂÆπËæÉÈïøÔºåÊòæÁ§∫ÊèêÁ§∫
          if (content.length > 50) {
            if (hintEl) hintEl.style.display = 'inline';
            // ÈôêÂà∂ÊòæÁ§∫ÈïøÂ∫¶
            const maxLength = 80;
            if (content.length > maxLength) {
              bubbleEl.textContent = content.substring(0, maxLength) + '...';
            } else {
              bubbleEl.textContent = content;
            }
          } else {
            bubbleEl.textContent = content;
            if (hintEl) hintEl.style.display = 'none';
          }
          
          // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
          if (bubbleContainer) {
            bubbleContainer.style.cursor = 'pointer';
          }
        } else {
          bubbleEl.textContent = 'ÊöÇÊó†ÂÖ¨Âëä';
          homeCurrentAnnouncement = null;
          if (hintEl) hintEl.style.display = 'none';
          if (bubbleContainer) bubbleContainer.style.cursor = 'default';
        }
      } catch (error) {
        console.error('Âä†ËΩΩÂÖ¨ÂëäÂ§±Ë¥•:', error);
        bubbleEl.textContent = 'ÊöÇÊó†ÂÖ¨Âëä';
        homeCurrentAnnouncement = null;
        if (hintEl) hintEl.style.display = 'none';
      }
    }
    
    // ÊòæÁ§∫È¶ñÈ°µÂÖ¨ÂëäËØ¶ÊÉÖ
    window.showHomeAnnouncementDetail = function() {
      if (!homeCurrentAnnouncement) {
        console.warn('Ê≤°ÊúâÂèØÊòæÁ§∫ÁöÑÂÖ¨Âëä');
        return;
      }
      
      // ‰ΩøÁî®Â∑≤ÊúâÁöÑÊü•ÁúãÂÖ¨ÂëäÊ®°ÊÄÅÊ°ÜÂáΩÊï∞
      if (window.viewFullAnnouncement) {
        viewFullAnnouncement(homeCurrentAnnouncement.id);
      } else {
        // Â¶ÇÊûúviewFullAnnouncement‰∏çÂ≠òÂú®ÔºåÁõ¥Êé•ÊòæÁ§∫
        alert('ÂÖ¨ÂëäËØ¶ÊÉÖÂäüËÉΩÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢');
      }
    };
    
    // ÂàùÂßãÂåñÈ¶ñÈ°µËßÜÂõæ
    function initHomeView() {
      // Êõ¥Êñ∞È¶ñÈ°µÁªüËÆ°
      updateHomeStats();
      
      // Âä†ËΩΩ‰∏ªÈ°µÂÖ¨ÂëäÊ†è
      loadHomeAnnouncementBubble();
      
      // Ê£ÄÊü•Âπ∂Êõ¥Êñ∞ËµÑËÆØ
      checkAndUpdateNews();
      
      // Ê£ÄÊü•Âπ∂Êõ¥Êñ∞Ëµõ‰∫ã
      checkAndUpdateEvents();
      
      // ÁªëÂÆöËµÑËÆØÁ≠õÈÄâÊåâÈíÆ‰∫ã‰ª∂
      document.querySelectorAll('.news-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.news-filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentNewsFilter = btn.dataset.filter;
          renderNewsList(currentNewsFilter, currentNewsRegion);
        });
      });
      
      // Êú¨Âú∞/ÂÖ®ÂõΩËµÑËÆØÊ†áÁ≠æÈ°µÂàáÊç¢
      document.querySelectorAll('.news-region-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.news-region-tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentNewsRegion = btn.dataset.region;
          renderNewsList(currentNewsFilter, currentNewsRegion);
        });
      });
      
      // Âà∑Êñ∞ËµÑËÆØÊåâÈíÆ
      const btnRefreshNews = document.getElementById('btnRefreshNews');
      if (btnRefreshNews) {
        btnRefreshNews.addEventListener('click', () => {
          updateNews();
          alert('Ê≠£Âú®Âà∑Êñ∞ËµÑËÆØÔºåËØ∑Á®çÂÄô...');
        });
      }
      
      // ËµÑËÆØËØ¶ÊÉÖÂºπÁ™óÂÖ≥Èó≠‰∫ã‰ª∂
      const newsModalClose = document.getElementById('newsModalClose');
      const newsModalCloseBtn = document.getElementById('newsModalCloseBtn');
      const newsModal = document.getElementById('newsModal');
      
      if (newsModalClose) {
        newsModalClose.addEventListener('click', closeNewsModal);
      }
      if (newsModalCloseBtn) {
        newsModalCloseBtn.addEventListener('click', closeNewsModal);
      }
      if (newsModal) {
        newsModal.addEventListener('click', (e) => {
          if (e.target.id === 'newsModal') {
            closeNewsModal();
          }
        });
      }
      
      // Ëµõ‰∫ãÂú∞Âå∫Ê†áÁ≠æÈ°µÂàáÊç¢
      document.querySelectorAll('.event-region-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.event-region-tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentEventRegion = btn.dataset.region;
          renderEventsList(currentEventTab, currentEventRegion);
        });
      });
      
      // Ëµõ‰∫ãÊ†áÁ≠æÈ°µÂàáÊç¢
      document.querySelectorAll('.event-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.event-tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentEventTab = btn.dataset.tab;
          renderEventsList(currentEventTab, currentEventRegion);
        });
      });
      
      // Âà∑Êñ∞Ëµõ‰∫ãÊåâÈíÆ
      const btnRefreshEvents = document.getElementById('btnRefreshEvents');
      if (btnRefreshEvents) {
        btnRefreshEvents.addEventListener('click', () => {
          updateEvents();
          alert('Ê≠£Âú®Âà∑Êñ∞Ëµõ‰∫ãÊï∞ÊçÆÔºåËØ∑Á®çÂÄô...');
        });
      }
    }
    
    // ==========================================
    // üïäÔ∏è Evo Êô∫ËÉΩÂä©ÊâãËÆæÁΩÆÂäüËÉΩ
    // ==========================================
    
    const EVO_SETTINGS_KEY = 'evo_settings';
    const EVO_SYNC_KEY = 'evo_settings_sync';
    
    // ÈªòËÆ§ËÆæÁΩÆ
    const defaultEvoSettings = {
      enabled: true,
      position: 'bottom-right',
      displayMode: 'always',
      autoClose: 5,
      iconSize: 70,
      theme: 'purple',
      showWelcome: true,
      saveHistory: true,
      showAnalytics: true,
      showRecommendations: true,
      github: {
        repo: '',
        token: '',
        apiEndpoint: ''
      },
      functionGuides: {
        'È¶ñÈ°µ': {
          description: 'È¶ñÈ°µÊòØÁ≥ªÁªüÁöÑ‰ø°ÊÅØ‰∏≠ÂøÉ',
          features: [
            'üì∞ ËµõÈ∏ΩËµÑËÆØÔºöÊü•ÁúãÊúÄÊñ∞ÁöÑËµõÈ∏ΩÁõ∏ÂÖ≥ËµÑËÆØÔºåÂèØ‰ª•ÊåâÁ±ªÂûãÔºàÂÖ®ÈÉ®/Ëµõ‰∫ã/ËÇ≤Áßç/ÂÅ•Â∫∑ÔºâÂíåÂú∞Âå∫ÔºàÊú¨Âú∞/ÂÖ®ÂõΩÔºâÁ≠õÈÄâ',
            'üèÅ ÂÆûÊó∂Ëµõ‰∫ãÔºöÊü•ÁúãËøõË°å‰∏≠„ÄÅÂç≥Â∞ÜÂºÄÂßãÂíåÊúÄÊñ∞ÊàêÁª©ÁöÑËµõ‰∫ã‰ø°ÊÅØ',
            'üß† Êô∫ËÉΩÊé®ËçêÔºöÁ≥ªÁªüÊ†πÊçÆÊÇ®ÁöÑÊï∞ÊçÆÊèê‰æõ‰∏™ÊÄßÂåñÊé®Ëçê',
            '‚≠ê ÊàëÁöÑÂÖ≥Ê≥®ÔºöÁÆ°ÁêÜÊÇ®ÂÖ≥Ê≥®ÁöÑËµõÂå∫„ÄÅËµõ‰∫ãÁ±ªÂûãÁ≠â',
            'üöÄ Âø´Êç∑ÂÖ•Âè£ÔºöÂø´ÈÄüËÆøÈóÆÂ∏∏Áî®ÂäüËÉΩÔºàÊñ∞Â¢ûÈ∏ΩÂ≠ê„ÄÅÂΩïÂÖ•ÊàêÁª©„ÄÅÈÖçÂØπËØÑ‰º∞„ÄÅÊô∫ËÉΩÂàÜÊûêÔºâ',
            'üîî ‰ªäÊó•ÊèêÈÜíÔºöÊü•Áúã‰ªäÊó•ÁöÑÈáçË¶ÅÊèêÈÜí‰∫ãÈ°π'
          ]
        },
        'Êï∞ÊçÆÊ¶ÇËßà': {
          description: 'Êü•ÁúãÁ≥ªÁªüÁöÑÊï¥‰ΩìÊï∞ÊçÆÁªüËÆ°',
          features: [
            'üìä Ê†∏ÂøÉÊï∞ÊçÆÂç°ÁâáÔºöÊòæÁ§∫ÊÄªÈ∏ΩÂ≠êÊï∞„ÄÅÂú®‰∏ñ„ÄÅÂ∑≤Ê≠ª‰∫°„ÄÅÊúâÊàêÁª©„ÄÅÊ†∏ÂøÉÁßçÈ∏ΩÁ≠âÁªüËÆ°',
            'üìà Âπ¥Â∫¶ÁªüËÆ°ÔºöÊåâÂπ¥‰ªΩÊ±áÊÄªÂá∫ÁîüÊï∞Èáè„ÄÅÊ≠ª‰∫°Êï∞Èáè‰ª•ÂèäÊúâÂèÇËµõËÆ∞ÂΩïÁöÑÈ∏ΩÂ≠êÊï∞Èáè'
          ]
        },
        'È∏ΩÂ≠êÁÆ°ÁêÜ': {
          description: 'ÁÆ°ÁêÜÊÇ®ÁöÑ‰ø°È∏ΩÊ°£Ê°à',
          features: [
            'üìã Ë°®Ê†ºËßÜÂõæÔºö‰ª•Ë°®Ê†ºÂΩ¢ÂºèÊü•ÁúãÊâÄÊúâÈ∏ΩÂ≠ê‰ø°ÊÅØÔºåÂåÖÊã¨Ë∂≥ÁéØÂè∑„ÄÅÂêçÁß∞„ÄÅÁ±ªÂûã„ÄÅÁä∂ÊÄÅ„ÄÅÁà∂È∏Ω/ÊØçÈ∏Ω„ÄÅÁé∞È∏Ω‰∏ª„ÄÅÂèÇËµõËÆ∞ÂΩïÊï∞',
            'üÉè Âç°ÁâáËßÜÂõæÔºö‰ª•Âç°ÁâáÂΩ¢ÂºèÊü•ÁúãÈ∏ΩÂ≠ê‰ø°ÊÅØÔºåÊõ¥Áõ¥ËßÇÁæéËßÇ',
            '‚ûï Êñ∞Â¢ûÈ∏ΩÂ≠êÔºöÊ∑ªÂä†Êñ∞ÁöÑ‰ø°È∏ΩÊ°£Ê°à',
            'üîç Êü•ÁúãËØ¶ÊÉÖÔºöÁÇπÂáªÊü•ÁúãÊåâÈíÆÊü•ÁúãÈ∏ΩÂ≠êÁöÑËØ¶ÁªÜ‰ø°ÊÅØ'
          ]
        },
        'Ë°ÄÁªüÂÖ≥Á≥ª': {
          description: 'Êü•ÁúãÂíåÁÆ°ÁêÜ‰ø°È∏ΩÁöÑË°ÄÁªüÂÖ≥Á≥ªÊ†ë',
          features: [
            'üå≥ Ë°ÄÁªüÊ†ëÔºöÈÄâÊã©È∏ΩÂ≠êÊü•ÁúãÂÖ∂ÂÆåÊï¥ÁöÑË°ÄÁªüÂÖ≥Á≥ªÊ†ëÔºàÂåÖÊã¨‰∫≤‰ª£ÂíåÂ≠ê‰ª£Ôºâ',
            'üîç ÊêúÁ¥¢ÂäüËÉΩÔºöÈÄöËøáË∂≥ÁéØÂè∑ÊàñÂêçÂ≠óÊêúÁ¥¢È∏ΩÂ≠ê',
            'üìä ÁßçÈ∏ΩÊ†ëÔºöÊòæÁ§∫ÊâÄÊúâÁßçÈ∏ΩÁöÑÂÖ≥Á≥ªÊ†ë'
          ]
        },
        'ÁªüËÆ°ÂàÜÊûê': {
          description: 'Êü•ÁúãÂπ¥Â∫¶ÁªüËÆ°Êï∞ÊçÆ',
          features: [
            'üìà Âπ¥Â∫¶ÁªüËÆ°Ê¶ÇËßàÔºöÊåâÂπ¥‰ªΩÊ±áÊÄªÂá∫ÁîüÊï∞Èáè„ÄÅÊ≠ª‰∫°Êï∞Èáè‰ª•ÂèäÊúâÂèÇËµõËÆ∞ÂΩïÁöÑÈ∏ΩÂ≠êÊï∞Èáè',
            'üìä Êï∞ÊçÆË°®Ê†ºÔºö‰ª•Ë°®Ê†ºÂΩ¢ÂºèÂ±ïÁ§∫ÁªüËÆ°Êï∞ÊçÆ'
          ]
        },
        'ÊØîËµõ‰∏éÊàêÁª©': {
          description: 'ÁÆ°ÁêÜÊØîËµõÂíåÊàêÁª©ËÆ∞ÂΩï',
          features: [
            'üìã ÊØîËµõÂàóË°®ÔºöÊü•ÁúãÊâÄÊúâÊØîËµõ‰ø°ÊÅØÔºåÂåÖÊã¨ÊØîËµõÂêçÁß∞„ÄÅÊó•Êúü„ÄÅÂú∞ÁÇπ„ÄÅË∑ùÁ¶ª„ÄÅÁä∂ÊÄÅ„ÄÅÂèÇËµõÊï∞',
            'üì• ÂØºÂÖ•ÊàêÁª©Ôºö‰ªéExcelÊñá‰ª∂ÂØºÂÖ•ÊØîËµõÊàêÁª©',
            'üìä ÊØîËµõÁªüËÆ°ÔºöÊü•ÁúãÊØîËµõÁªüËÆ°Êï∞ÊçÆ',
            'üß† ÊàêÁª©ÂàÜÊûêÔºöÂàÜÊûêÊØîËµõÊàêÁª©Ë∂ãÂäø',
            'üß¨ Ë°ÄÁªüÂØπÊØîÔºöÂØπÊØî‰∏çÂêåË°ÄÁªüÁöÑÈ∏ΩÂ≠êË°®Áé∞'
          ]
        },
        'ÁπÅËÇ≤‰∏éÈÖçÂØπ': {
          description: 'ÁÆ°ÁêÜ‰ø°È∏ΩÁöÑÁπÅËÇ≤ÂíåÈÖçÂØπ',
          features: [
            'üíï ÈÖçÂØπÈÄâÊã©ÔºöÈÄâÊã©Áà∂È∏ΩÂíåÊØçÈ∏ΩËøõË°åÈÖçÂØπ',
            'üìä ÈÖçÂØπÂàÜÊûêÔºöÁ≥ªÁªüËá™Âä®ÂàÜÊûêÈÖçÂØπÂèØË°åÊÄß',
            '‚ûï Êñ∞Â¢ûÈÖçÂØπÔºöÊ∑ªÂä†Êñ∞ÁöÑÈÖçÂØπËÆ∞ÂΩï'
          ]
        },
        'ÂÅ•Â∫∑ÁÆ°ÁêÜ': {
          description: 'ÁÆ°ÁêÜ‰ø°È∏ΩÁöÑÂÅ•Â∫∑ËÆ∞ÂΩï',
          features: [
            'üìù ÂÅ•Â∫∑ËÆ∞ÂΩïÔºöËÆ∞ÂΩïÈ∏ΩÂ≠êÁöÑÂÅ•Â∫∑Áä∂ÊÄÅ„ÄÅÊó•Êúü„ÄÅÂ§áÊ≥®Á≠â‰ø°ÊÅØ',
            '‚ûï Êñ∞Â¢ûËÆ∞ÂΩïÔºöÊ∑ªÂä†Êñ∞ÁöÑÂÅ•Â∫∑ËÆ∞ÂΩï',
            'üìã ËÆ∞ÂΩïÂàóË°®ÔºöÊü•ÁúãÊâÄÊúâÂÅ•Â∫∑ËÆ∞ÂΩï'
          ]
        },
        'Êô∫ËÉΩÂàÜÊûê‰∏≠ÂøÉ': {
          description: '‰ΩøÁî®AIËøõË°åÊô∫ËÉΩÂàÜÊûê',
          features: [
            'üìä Ë°ÄÁªüÂàÜÊûêÔºöÂàÜÊûêÈ∏ΩÂ≠êÁöÑË°ÄÁªü‰ºòÂäøÂíåÈÅó‰º†ÁâπÂæÅ',
            'üèÜ ÊàêÁª©ÂàÜÊûêÔºöÂàÜÊûêÈ∏ΩÂ≠êÁöÑÊØîËµõË°®Áé∞ÂíåÊàêÁª©Ë∂ãÂäø',
            'üíï ÈÖçÂØπÂª∫ËÆÆÔºöÂü∫‰∫éAIÁÆóÊ≥ïÁöÑÊô∫ËÉΩÈÖçÂØπÊé®Ëçê'
          ]
        },
        'ËÆ≠ÁªÉÊ®°Âùó': {
          description: 'ÁÆ°ÁêÜ‰ø°È∏ΩÁöÑËÆ≠ÁªÉËÆ∞ÂΩï',
          features: [
            'üìù ËÆ≠ÁªÉËÆ∞ÂΩïÔºöËÆ∞ÂΩïËÆ≠ÁªÉÊó•Êúü„ÄÅÈ∏ΩÂ≠ê„ÄÅËÆ≠ÁªÉÁ±ªÂûã„ÄÅË∑ùÁ¶ª„ÄÅÁî®Êó∂Á≠â‰ø°ÊÅØ',
            '‚ûï Êñ∞Â¢ûËÆ∞ÂΩïÔºöÊ∑ªÂä†Êñ∞ÁöÑËÆ≠ÁªÉËÆ∞ÂΩï',
            'üìã ËÆ∞ÂΩïÂàóË°®ÔºöÊü•ÁúãÊâÄÊúâËÆ≠ÁªÉËÆ∞ÂΩï'
          ]
        },
        'ËÉΩÂäõÁªºÂêàÂàÜÊûê': {
          description: 'ÁªºÂêàÂàÜÊûêÈ∏ΩÂ≠êÁöÑÂêÑÈ°πËÉΩÂäõÊåáÊ†á',
          features: [
            'üèÜ ÊØîËµõËÉΩÂäõÔºöËØÑ‰º∞È∏ΩÂ≠êÁöÑÊØîËµõË°®Áé∞ËÉΩÂäõ',
            'üß¨ ÈÅó‰º†‰ª∑ÂÄºÔºöËØÑ‰º∞È∏ΩÂ≠êÁöÑÈÅó‰º†‰ª∑ÂÄº',
            'üí™ ÂÅ•Â∫∑ÊåáÊï∞ÔºöËØÑ‰º∞È∏ΩÂ≠êÁöÑÂÅ•Â∫∑Áä∂ÂÜµ',
            '‚≠ê ÁªºÂêàËØÑÂàÜÔºöÁªºÂêàÂêÑÈ°πÊåáÊ†áÁªôÂá∫ÊÄª‰ΩìËØÑÂàÜ'
          ]
        }
      }
    };
    
    // Âä†ËΩΩEvoËÆæÁΩÆ
    // ‰ªéÊúçÂä°Âô®Âä†ËΩΩEvoËÆæÁΩÆÔºàÁÆ°ÁêÜÂëòÊùÉÈôêÔºâ
    async function loadEvoSettings() {
      try {
        const token = getAuthToken();
        if (!token) {
          console.warn('Êú™ÁôªÂΩïÔºåÊó†Ê≥ïÂä†ËΩΩEvoËÆæÁΩÆ');
          return;
        }
        
        // ‰ªéÊúçÂä°Âô®Âä†ËΩΩËÆæÁΩÆ
        const response = await fetch(`${getApiUrl()}/admin/evo-settings`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        let settings = defaultEvoSettings;
        
        if (response.ok) {
          const result = await response.json();
          if (result.success && result.data) {
            settings = result.data;
            // ‰øùÂ≠òÂà∞localStorage‰Ωú‰∏∫ÁºìÂ≠ò
            localStorage.setItem(EVO_SETTINGS_KEY, JSON.stringify(settings));
          }
        } else {
          // Â¶ÇÊûúÊúçÂä°Âô®Âä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®localStorageÁºìÂ≠ò
          const saved = localStorage.getItem(EVO_SETTINGS_KEY);
          if (saved) {
            settings = JSON.parse(saved);
          }
        }
        
        // Â°´ÂÖÖË°®Âçï
        document.getElementById('evoEnabled').checked = settings.enabled !== false;
        document.getElementById('evoPosition').value = settings.position || 'bottom-right';
        document.getElementById('evoDisplayMode').value = settings.displayMode || 'always';
        document.getElementById('evoAutoClose').value = settings.autoClose || 5;
        
        // Ê∏≤ÊüìÂäüËÉΩ‰ΩøÁî®ËØ¥ÊòéÔºàÂ¶ÇÊûúÂáΩÊï∞Â≠òÂú®Ôºâ
        if (typeof renderFunctionGuides === 'function') {
          renderFunctionGuides(settings.functionGuides || defaultEvoSettings.functionGuides);
        }
        document.getElementById('evoIconSize').value = settings.iconSize || 70;
        document.getElementById('evoIconSizeValue').textContent = (settings.iconSize || 70) + 'px';
        
        // ËÆæÁΩÆ‰∏ªÈ¢òÂçïÈÄâÊåâÈíÆ
        const themeRadios = document.querySelectorAll('input[name="evoTheme"]');
        themeRadios.forEach(radio => {
          if (radio.value === (settings.theme || 'purple')) {
            radio.checked = true;
          }
        });
        
        document.getElementById('evoShowWelcome').checked = settings.showWelcome !== false;
        document.getElementById('evoSaveHistory').checked = settings.saveHistory !== false;
        document.getElementById('evoShowAnalytics').checked = settings.showAnalytics !== false;
        document.getElementById('evoShowRecommendations').checked = settings.showRecommendations !== false;
        
        // GitHubÈÖçÁΩÆ
        if (settings.github) {
          document.getElementById('evoGithubRepo').value = settings.github.repo || '';
          document.getElementById('evoGithubToken').value = settings.github.token || '';
          document.getElementById('evoGithubApiEndpoint').value = settings.github.apiEndpoint || '';
        }
        
        // ÂõæÊ†áÂ§ßÂ∞èÊªëÂùó‰∫ã‰ª∂
        const iconSizeSlider = document.getElementById('evoIconSize');
        if (iconSizeSlider) {
          iconSizeSlider.addEventListener('input', (e) => {
            document.getElementById('evoIconSizeValue').textContent = e.target.value + 'px';
          });
        }
      } catch (error) {
        console.error('Âä†ËΩΩEvoËÆæÁΩÆÂ§±Ë¥•:', error);
        // ‰ΩøÁî®localStorage‰Ωú‰∏∫Â§áÁî®
        const saved = localStorage.getItem(EVO_SETTINGS_KEY);
        if (saved) {
          const settings = JSON.parse(saved);
          document.getElementById('evoEnabled').checked = settings.enabled !== false;
          document.getElementById('evoPosition').value = settings.position || 'bottom-right';
          // ... ÂÖ∂‰ªñÂ≠óÊÆµÂ°´ÂÖÖÔºàÂêå‰∏äÔºâ
        }
      }
    }
    
    // Ê∏≤ÊüìÂäüËÉΩ‰ΩøÁî®ËØ¥Êòé
    function renderFunctionGuides(functionGuides) {
      const container = document.getElementById('functionGuidesContainer');
      if (!container) return;
      
      container.innerHTML = '';
      
      Object.entries(functionGuides).forEach(([funcName, guide]) => {
        const guideItem = document.createElement('div');
        guideItem.className = 'function-guide-item';
        guideItem.style.cssText = `
          border: 1px solid var(--border-medium);
          border-radius: 8px;
          padding: 16px;
          background: var(--bg-secondary);
        `;
        
        guideItem.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <h4 style="margin: 0; color: var(--text-primary);">${funcName}</h4>
            <button type="button" class="btn btn-sm btn-outline" onclick="editFunctionGuide('${funcName}')" style="padding: 4px 12px;">ÁºñËæë</button>
          </div>
          <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">${guide.description}</div>
          <div style="font-size: 13px; color: var(--text-muted);">
            <strong>ÂäüËÉΩÁÇπÔºö</strong>${guide.features.length} È°π
          </div>
        `;
        
        container.appendChild(guideItem);
      });
    }
    
    // ÁºñËæëÂäüËÉΩËØ¥Êòé
    window.editFunctionGuide = function(funcName) {
      const functionGuides = getFunctionGuidesFromSettings();
      const guide = functionGuides[funcName] || { description: '', features: [] };
      
      const description = prompt(`ÁºñËæë"${funcName}"ÁöÑÊèèËø∞Ôºö`, guide.description);
      if (description === null) return;
      
      const featuresStr = prompt(`ÁºñËæë"${funcName}"ÁöÑÂäüËÉΩÁÇπÔºàÊØèË°å‰∏Ä‰∏™ÔºâÔºö`, guide.features.join('\n'));
      if (featuresStr === null) return;
      
      const features = featuresStr.split('\n').filter(f => f.trim());
      
      functionGuides[funcName] = {
        description: description.trim(),
        features: features
      };
      
      renderFunctionGuides(functionGuides);
      showEvoSettingsStatus('ÂäüËÉΩËØ¥ÊòéÂ∑≤Êõ¥Êñ∞ÔºåËØ∑ÁÇπÂáª"‰øùÂ≠òËÆæÁΩÆ"‰øùÂ≠ò', 'info');
    };
    
    // ‰ªéËÆæÁΩÆ‰∏≠Ëé∑ÂèñÂäüËÉΩËØ¥Êòé
    function getFunctionGuidesFromSettings() {
      const container = document.getElementById('functionGuidesContainer');
      if (!container) return defaultEvoSettings.functionGuides;
      
      // ‰ªéÂΩìÂâçÊòæÁ§∫ÁöÑËÆæÁΩÆ‰∏≠Ëé∑ÂèñÔºàÂÆûÈôÖÂ∫îËØ•‰ªéË°®ÂçïÊàñËÆæÁΩÆÂØπË±°‰∏≠Ëé∑ÂèñÔºâ
      // ËøôÈáåÁÆÄÂåñÂ§ÑÁêÜÔºåÂÆûÈôÖÂ∫îËØ•Áª¥Êä§‰∏Ä‰∏™Áä∂ÊÄÅ
      try {
        const saved = localStorage.getItem(EVO_SETTINGS_KEY);
        if (saved) {
          const settings = JSON.parse(saved);
          return settings.functionGuides || defaultEvoSettings.functionGuides;
        }
      } catch (e) {}
      
      return defaultEvoSettings.functionGuides;
    }
    
    // ‰øùÂ≠òEvoËÆæÁΩÆÂà∞ÊúçÂä°Âô®ÔºàÁÆ°ÁêÜÂëòÊùÉÈôêÔºå‰∏ªÁ´ô‰ºöËá™Âä®ÂêåÊ≠•Ôºâ
    async function saveEvoSettings() {
      try {
        const settings = {
          enabled: document.getElementById('evoEnabled').checked,
          position: document.getElementById('evoPosition').value,
          displayMode: document.getElementById('evoDisplayMode').value,
          autoClose: parseInt(document.getElementById('evoAutoClose').value) || 5,
          iconSize: parseInt(document.getElementById('evoIconSize').value) || 70,
          theme: document.querySelector('input[name="evoTheme"]:checked')?.value || 'purple',
          showWelcome: document.getElementById('evoShowWelcome').checked,
          saveHistory: document.getElementById('evoSaveHistory').checked,
          showAnalytics: document.getElementById('evoShowAnalytics').checked,
          showRecommendations: document.getElementById('evoShowRecommendations').checked,
          github: {
            repo: document.getElementById('evoGithubRepo').value.trim(),
            token: document.getElementById('evoGithubToken').value.trim(),
            apiEndpoint: document.getElementById('evoGithubApiEndpoint').value.trim()
          },
          functionGuides: getFunctionGuidesFromSettings()
        };
        
        // Áõ¥Êé•‰øùÂ≠òÂà∞ÊúçÂä°Âô®ÔºàÁÆ°ÁêÜÂëòÊùÉÈôêÔºâ
        const token = getAuthToken();
        if (!token) {
          throw new Error('ËØ∑ÂÖàÁôªÂΩïÁÆ°ÁêÜÂëòË¥¶Âè∑');
        }
        
        const response = await fetch(`${getApiUrl()}/admin/evo-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(settings)
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            // ‰øùÂ≠òÂà∞localStorage‰Ωú‰∏∫ÁºìÂ≠ò
            localStorage.setItem(EVO_SETTINGS_KEY, JSON.stringify(result.data));
            
            // ËÆæÁΩÆÂêåÊ≠•Ê†áÂøóÔºå‰∏ªÁ´ô‰ºöËá™Âä®Ê£ÄÊµãÂπ∂ÂêåÊ≠•
            localStorage.setItem(EVO_SYNC_KEY, 'true');
            localStorage.setItem('evo_settings_sync_timestamp', Date.now().toString());
            
            showEvoSettingsStatus('‚úÖ ËÆæÁΩÆÂ∑≤‰øùÂ≠òÂà∞ÊúçÂä°Âô®ÔºÅ‰∏ªÁ´ôÂ∞ÜËá™Âä®Êõ¥Êñ∞„ÄÇ', 'success');
            console.log('‚úÖ EvoËÆæÁΩÆÂ∑≤‰øùÂ≠òÂà∞ÊúçÂä°Âô®Ôºå‰∏ªÁ´ôÂ∞ÜËá™Âä®ÂêåÊ≠•');
            
            return result.data;
          } else {
            throw new Error(result.error || '‰øùÂ≠òÂ§±Ë¥•');
          }
        } else {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || 'ÊúçÂä°Âô®ÂìçÂ∫îÈîôËØØ');
        }
      } catch (error) {
        console.error('‰øùÂ≠òEvoËÆæÁΩÆÂ§±Ë¥•:', error);
        showEvoSettingsStatus('‚ùå ‰øùÂ≠òÂ§±Ë¥•Ôºö' + error.message, 'error');
        return null;
      }
    }
    
    // ÈáçÁΩÆ‰∏∫ÈªòËÆ§ËÆæÁΩÆ
    function resetEvoSettings() {
      if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆ‰∏∫ÈªòËÆ§ËÆæÁΩÆÂêóÔºü')) {
        localStorage.removeItem(EVO_SETTINGS_KEY);
        loadEvoSettings();
        showEvoSettingsStatus('Â∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§ËÆæÁΩÆ', 'info');
      }
    }
    
    // ÂêåÊ≠•Âà∞‰∏ªÁ´ôÔºàÂ∑≤ÈõÜÊàêÂà∞saveEvoSettings‰∏≠ÔºåÊ≠§ÂáΩÊï∞‰øùÁïôÁî®‰∫éÊâãÂä®Ëß¶ÂèëÔºâ
    async function syncEvoSettingsToMainSite() {
      try {
        // ÂÖà‰øùÂ≠òËÆæÁΩÆ
        const settings = await saveEvoSettings();
        if (settings) {
          showEvoSettingsStatus('‚úÖ ËÆæÁΩÆÂ∑≤‰øùÂ≠òÂπ∂ÂêåÊ≠•ÔºÅ‰∏ªÁ´ôÂ∞ÜËá™Âä®Êõ¥Êñ∞„ÄÇ', 'success');
          
          // ÂèØÈÄâÔºöÊâìÂºÄ‰∏ªÁ´ôÊü•ÁúãÊïàÊûú
          const mainSiteUrl = window.location.origin.replace('/admin.html', '/index.html');
          if (confirm('ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅÊòØÂê¶Áé∞Âú®ÊâìÂºÄ‰∏ªÁ´ôÊü•ÁúãÊïàÊûúÔºü')) {
            window.open(mainSiteUrl, '_blank');
          }
        }
      } catch (error) {
        console.error('ÂêåÊ≠•Âà∞‰∏ªÁ´ôÂ§±Ë¥•:', error);
        showEvoSettingsStatus('‚ùå ÂêåÊ≠•Â§±Ë¥•Ôºö' + error.message, 'error');
      }
    }
    
    // ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
    function showEvoSettingsStatus(message, type = 'info') {
      const statusEl = document.getElementById('evoSettingsStatus');
      if (!statusEl) return;
      
      statusEl.style.display = 'block';
      statusEl.textContent = message;
      
      // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆÊ†∑Âºè
      statusEl.style.background = type === 'success' ? 'var(--success-light)' : 
                                  type === 'error' ? 'var(--danger-light)' : 
                                  'var(--primary-50)';
      statusEl.style.color = type === 'success' ? 'var(--success)' : 
                             type === 'error' ? 'var(--danger)' : 
                             'var(--primary)';
      statusEl.style.border = `1px solid ${type === 'success' ? 'var(--success)' : 
                                            type === 'error' ? 'var(--danger)' : 
                                            'var(--primary)'}`;
      
      // 3ÁßíÂêéËá™Âä®ÈöêËóè
      setTimeout(() => {
        statusEl.style.display = 'none';
      }, 3000);
    }
    
    // Âä†ËΩΩAIÊ®°Âûã‰ø°ÊÅØÔºàÊô∫ËÉΩÁÆ°ÁêÜÔºâ
    async function loadAdminAIModelInfo() {
      try {
        const token = getAuthToken();
        if (!token) return;
        
        const response = await fetch(`${getApiUrl()}/evo/model-info`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.data) {
            displayAdminAIModelInfo(data.data);
          }
        }
      } catch (error) {
        console.error('Âä†ËΩΩAIÊ®°Âûã‰ø°ÊÅØÂ§±Ë¥•:', error);
        // ‰ΩøÁî®ÈªòËÆ§‰ø°ÊÅØ
        displayAdminAIModelInfo({
          name: 'Zephyr-7B-Beta',
          provider: 'Hugging Face',
          source: 'https://huggingface.co/HuggingFaceH4/zephyr-7b-beta',
          free: true,
          features: ['ÂÆåÂÖ®ÂÖçË¥π‰ΩøÁî®', 'Êó†ÈúÄ‰ø°Áî®Âç°', 'ÊîØÊåÅ‰∏≠ÊñáÂØπËØù', 'È´òÊÄßËÉΩÂìçÂ∫î', 'ÂºÄÊ∫êÊ®°Âûã']
        });
      }
    }
    
    // ÊòæÁ§∫AIÊ®°Âûã‰ø°ÊÅØÔºàÊô∫ËÉΩÁÆ°ÁêÜÔºâ
    function displayAdminAIModelInfo(modelInfo) {
      if (!modelInfo) return;
      
      const nameEl = document.getElementById('adminAIModelName');
      const providerEl = document.getElementById('adminAIProvider');
      const sourceEl = document.getElementById('adminAISource');
      const statusEl = document.getElementById('adminAIStatus');
      const featuresEl = document.getElementById('adminAIFeatures');
      
      if (nameEl) nameEl.textContent = modelInfo.name || 'Êú™Áü•';
      if (providerEl) providerEl.textContent = modelInfo.provider || 'Êú™Áü•';
      if (sourceEl) {
        sourceEl.href = modelInfo.source || '#';
        sourceEl.textContent = modelInfo.source ? 'Êü•ÁúãÊ®°ÂûãËØ¶ÊÉÖ' : 'Êú™Áü•';
      }
      
      if (statusEl) {
        statusEl.textContent = modelInfo.free ? '‚úÖ ÂÖçË¥π‰ΩøÁî®' : 'üí∞ ‰ªòË¥π';
        statusEl.style.background = modelInfo.free ? 'rgba(76, 175, 80, 0.3)' : 'rgba(255, 152, 0, 0.3)';
      }
      
      if (featuresEl && modelInfo.features) {
        featuresEl.innerHTML = modelInfo.features.map(f => `‚Ä¢ ${f}`).join('<br>');
      }
    }
    
    // ÊµãËØïAIËøûÊé•ÔºàÊô∫ËÉΩÁÆ°ÁêÜÔºâ
    async function testAdminAIConnection() {
      const btn = document.getElementById('btnAdminTestAI');
      const statusEl = document.getElementById('adminAIStatus');
      
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'ÊµãËØï‰∏≠...';
      }
      
      if (statusEl) {
        statusEl.textContent = 'ÊµãËØï‰∏≠...';
        statusEl.style.background = 'rgba(255, 152, 0, 0.3)';
      }
      
      try {
        const token = getAuthToken();
        if (!token) {
          throw new Error('ËØ∑ÂÖàÁôªÂΩï');
        }
        
        const response = await fetch(`${getApiUrl()}/evo/test`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          if (statusEl) {
            statusEl.textContent = '‚úÖ ËøûÊé•Ê≠£Â∏∏';
            statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
          }
          alert('AI ËøûÊé•ÊµãËØïÊàêÂäüÔºÅ\n\nÊ®°ÂûãÔºö' + (data.data?.model || 'Êú™Áü•') + '\nÊèê‰æõÂïÜÔºö' + (data.data?.provider || 'Êú™Áü•'));
        } else {
          throw new Error(data.message || 'ËøûÊé•Â§±Ë¥•');
        }
      } catch (error) {
        if (statusEl) {
          statusEl.textContent = '‚ùå ËøûÊé•Â§±Ë¥•';
          statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
        }
        alert('AI ËøûÊé•ÊµãËØïÂ§±Ë¥•Ôºö' + error.message);
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'ÊµãËØï AI ËøûÊé•';
        }
      }
    }
    
    // Áî®Êà∑‰ø°ÊÅØÂíåËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÂáΩÊï∞
    // Âä†ËΩΩÁî®Êà∑ËÆæÁΩÆ
    function loadUserSettings() {
      try {
        const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
        return {
          avatar: settings.avatar || null,
          displayName: settings.displayName || null
        };
      } catch (e) {
        console.error('Âä†ËΩΩÁî®Êà∑ËÆæÁΩÆÂ§±Ë¥•:', e);
        return { avatar: null, displayName: null };
      }
    }
    
    // ‰øùÂ≠òÁî®Êà∑ËÆæÁΩÆ
    function saveUserSettings(settings) {
      try {
        localStorage.setItem('userSettings', JSON.stringify(settings));
        return true;
      } catch (e) {
        console.error('‰øùÂ≠òÁî®Êà∑ËÆæÁΩÆÂ§±Ë¥•:', e);
        return false;
      }
    }
    
    // Êõ¥Êñ∞È°∂ÈÉ®ÂØºËà™Ê†èÁöÑÁî®Êà∑ÊòæÁ§∫
    function updateTopBarUserDisplay() {
      const settings = loadUserSettings();
      const adminUserName = document.getElementById('adminUserName');
      const btnUserAvatar = document.getElementById('btnUserAvatar');
      
      // Êõ¥Êñ∞Áî®Êà∑ÂêçÊòæÁ§∫
      if (adminUserName) {
        const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
        const displayName = settings.displayName || userInfo.username || 'ÁÆ°ÁêÜÂëò';
        adminUserName.textContent = `Ê¨¢ËøéÔºå${displayName}`;
      }
      
      // Êõ¥Êñ∞Ë¥¶Êà∑ÊåâÈíÆ
      if (btnUserAvatar) {
        const avatarSpan = btnUserAvatar.querySelector('span:first-child');
        const textSpan = btnUserAvatar.querySelector('span:last-child');
        
        if (settings.avatar) {
          // Â¶ÇÊûúÊúâËá™ÂÆö‰πâÂ§¥ÂÉèÔºåÊòæÁ§∫Â§¥ÂÉèÂõæÁâá
          if (!avatarSpan || avatarSpan.textContent === 'üë§') {
            const img = document.createElement('img');
            img.src = settings.avatar;
            img.style.cssText = 'width:20px;height:20px;border-radius:50%;object-fit:cover;';
            if (avatarSpan) {
              avatarSpan.replaceWith(img);
            } else {
              btnUserAvatar.insertBefore(img, textSpan);
            }
          } else if (avatarSpan.tagName === 'IMG') {
            avatarSpan.src = settings.avatar;
          }
        } else {
          // Â¶ÇÊûúÊ≤°ÊúâËá™ÂÆö‰πâÂ§¥ÂÉèÔºåÊòæÁ§∫ÈªòËÆ§ÂõæÊ†á
          if (avatarSpan && avatarSpan.tagName === 'IMG') {
            const span = document.createElement('span');
            span.textContent = 'üë§';
            span.style.fontSize = '16px';
            avatarSpan.replaceWith(span);
          }
        }
        
        if (textSpan) {
          const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
          const displayName = settings.displayName || userInfo.username || 'Ë¥¶Êà∑';
          textSpan.textContent = displayName.length > 8 ? displayName.substring(0, 8) + '...' : displayName;
        }
      }
    }
    
    window.showUserInfoModal = function() {
      const modal = document.getElementById('userInfoModal');
      if (!modal) return;
      
      // ÂàáÊç¢Âà∞Êü•ÁúãÊ®°Âºè
      document.getElementById('userInfoViewMode').style.display = 'block';
      document.getElementById('userInfoEditMode').style.display = 'none';
      
      // ‰ªélocalStorageÊàñÂΩìÂâçÁôªÂΩï‰ø°ÊÅØËé∑ÂèñÁî®Êà∑Êï∞ÊçÆ
      const adminUserName = document.getElementById('adminUserName')?.textContent || '';
      const userNameMatch = adminUserName.match(/Ê¨¢ËøéÔºå(.+)/);
        const defaultUserName = userNameMatch ? userNameMatch[1] : 'ÁÆ°ÁêÜÂëò';
      
      // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÔºà‰ªélocalStorageÊàñAPIÔºâ
      const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
      const userSettings = loadUserSettings();
      const userName = userSettings.displayName || defaultUserName;
      const userEmail = userInfo.email || 'admin@example.com';
      const userType = userInfo.type || 'ÁÆ°ÁêÜÂëò';
      const registerDate = userInfo.registerDate || new Date().toISOString().split('T')[0];
      const userRole = userInfo.role || 'ÁÆ°ÁêÜÂëò';
      
      // Êõ¥Êñ∞ÊòæÁ§∫
      const avatarDisplay = document.getElementById('userAvatarDisplay');
      if (userSettings.avatar) {
        avatarDisplay.style.backgroundImage = `url(${userSettings.avatar})`;
        avatarDisplay.textContent = '';
      } else {
        avatarDisplay.style.backgroundImage = '';
        avatarDisplay.textContent = 'üë§';
      }
      
      document.getElementById('userNameDisplay').textContent = userName;
      document.getElementById('userEmailDisplay').textContent = userEmail;
      document.getElementById('userTypeDisplay').textContent = userType;
      document.getElementById('userRegisterDate').textContent = registerDate;
      document.getElementById('userRoleDisplay').textContent = userRole;
      
      // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
      modal.style.display = 'flex';
    };
    
    // ËøõÂÖ•ÁºñËæëÊ®°Âºè
    window.enterEditUserInfoMode = function() {
      document.getElementById('userInfoViewMode').style.display = 'none';
      document.getElementById('userInfoEditMode').style.display = 'block';
      
      // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
      const userSettings = loadUserSettings();
      const adminUserName = document.getElementById('adminUserName')?.textContent || '';
      const userNameMatch = adminUserName.match(/Ê¨¢ËøéÔºå(.+)/);
        const defaultUserName = userNameMatch ? userNameMatch[1] : 'ÁÆ°ÁêÜÂëò';
      const userInfo = JSON.parse(localStorage.getItem('adminUserInfo') || '{}');
      
      // ËÆæÁΩÆÂ§¥ÂÉèÊòæÁ§∫
      const avatarEditDisplay = document.getElementById('userAvatarEditDisplay');
      if (userSettings.avatar) {
        avatarEditDisplay.style.backgroundImage = `url(${userSettings.avatar})`;
        avatarEditDisplay.textContent = '';
      } else {
        avatarEditDisplay.style.backgroundImage = '';
        avatarEditDisplay.textContent = 'üë§';
      }
      
      // ËÆæÁΩÆÂêçÂ≠óËæìÂÖ•Ê°Ü
      document.getElementById('userNameInput').value = userSettings.displayName || defaultUserName;
      
      // ÁªëÂÆöÂ§¥ÂÉè‰∏ä‰º†‰∫ã‰ª∂
      const avatarInput = document.getElementById('userAvatarInput');
      if (avatarInput) {
        avatarInput.onchange = function(e) {
          const file = e.target.files[0];
          if (file) {
            // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂‰∏∫2MBÔºâ
            if (file.size > 2 * 1024 * 1024) {
              alert('Â§¥ÂÉèÊñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá2MB');
              return;
            }
            
            // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
            if (!file.type.startsWith('image/')) {
              alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂');
              return;
            }
            
            // ËØªÂèñÊñá‰ª∂Âπ∂ËΩ¨Êç¢‰∏∫base64
            const reader = new FileReader();
            reader.onload = function(e) {
              const base64 = e.target.result;
              avatarEditDisplay.style.backgroundImage = `url(${base64})`;
              avatarEditDisplay.textContent = '';
            };
            reader.readAsDataURL(file);
          }
        };
      }
    };
    
    // ÂèñÊ∂àÁºñËæë
    window.cancelEditUserInfo = function() {
      document.getElementById('userInfoViewMode').style.display = 'block';
      document.getElementById('userInfoEditMode').style.display = 'none';
      showUserInfoModal(); // ÈáçÊñ∞Âä†ËΩΩÊòæÁ§∫
    };
    
    // ‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØ
    window.saveUserInfo = function() {
      const userNameInput = document.getElementById('userNameInput');
      const avatarInput = document.getElementById('userAvatarInput');
      const avatarEditDisplay = document.getElementById('userAvatarEditDisplay');
      
      const displayName = userNameInput.value.trim();
      if (!displayName) {
        alert('ËØ∑ËæìÂÖ•ÊòµÁß∞');
        return;
      }
      
      // Ëé∑ÂèñÂ§¥ÂÉèÔºàbase64Ôºâ
      let avatar = null;
      if (avatarEditDisplay.style.backgroundImage && avatarEditDisplay.style.backgroundImage !== 'none') {
        avatar = avatarEditDisplay.style.backgroundImage.replace('url("', '').replace('")', '').replace("url('", '').replace("')", '');
      }
      
      // ‰øùÂ≠òËÆæÁΩÆ
      const success = saveUserSettings({
        avatar: avatar,
        displayName: displayName
      });
      
      if (success) {
        // Êõ¥Êñ∞È°∂ÈÉ®ÂØºËà™Ê†è
        updateTopBarUserDisplay();
        
        // ÂàáÊç¢ÂõûÊü•ÁúãÊ®°ÂºèÂπ∂Âà∑Êñ∞
        cancelEditUserInfo();
        alert('‰øùÂ≠òÊàêÂäüÔºÅ');
      } else {
        alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
      }
    };
    
    window.closeUserInfoModal = function() {
      const modal = document.getElementById('userInfoModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };
    
    window.showSettingsModal = function() {
      const modal = document.getElementById('settingsModal');
      if (!modal) return;
      modal.style.display = 'flex';
      // Êõ¥Êñ∞‰∏ªÈ¢òÊåâÈíÆÊñáÊú¨
      const themeBtn = document.getElementById('btnToggleThemeInModal');
      if (themeBtn) {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        themeBtn.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è ÊµÖËâ≤Ê®°Âºè' : 'üåô Â§úÈó¥Ê®°Âºè';
        themeBtn.title = currentTheme === 'dark' ? 'ÂàáÊç¢Âà∞ÊµÖËâ≤Ê®°Âºè' : 'ÂàáÊç¢Âà∞Ê∑±Ëâ≤Ê®°Âºè';
      }
    };
    
    window.closeSettingsModal = function() {
      const modal = document.getElementById('settingsModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };
    
    // Êï∞ÊçÆÂØºÂá∫ÂíåÂØºÂÖ•ÂäüËÉΩ
    window.exportAllData = function() {
      try {
        // ‰ªélocalStorageËØªÂèñ‰∏ªÁ´ôÊï∞ÊçÆ
        const pigeonsData = JSON.parse(localStorage.getItem('pigeons') || '[]');
        const racesData = JSON.parse(localStorage.getItem('races') || '[]');
        const pairingsData = JSON.parse(localStorage.getItem('pairings') || '[]');
        const healthRecordsData = JSON.parse(localStorage.getItem('healthRecords') || '[]');
        const usedNamesData = JSON.parse(localStorage.getItem('usedNames') || '[]');
        const ownerRegionPairsData = JSON.parse(localStorage.getItem('ownerRegionPairs') || '[]');
        
        const exportData = {
          version: '2.0',
          exportDate: new Date().toISOString(),
          data: {
            pigeons: pigeonsData,
            races: racesData,
            pairings: pairingsData,
            healthRecords: healthRecordsData,
            usedNames: usedNamesData,
            ownerRegionPairs: ownerRegionPairsData
          }
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pigeon_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('Êï∞ÊçÆÂ§á‰ªΩÂ∑≤‰∏ãËΩΩÔºÅ\n\nÂ§á‰ªΩ‰∫Ü ' + pigeonsData.length + ' Âè™È∏ΩÂ≠êÁöÑÊï∞ÊçÆ„ÄÇ\nËØ∑Â¶•ÂñÑ‰øùÁÆ°Â§á‰ªΩÊñá‰ª∂„ÄÇ');
      } catch (error) {
        console.error('ÂØºÂá∫Êï∞ÊçÆÂ§±Ë¥•:', error);
        alert('ÂØºÂá∫Êï∞ÊçÆÂ§±Ë¥•Ôºö' + error.message);
      }
    };
    
    window.importBackupData = function(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const backupData = JSON.parse(e.target.result);
          
          if (!backupData.data || !backupData.data.pigeons) {
            alert('Êó†ÊïàÁöÑÂ§á‰ªΩÊñá‰ª∂Ê†ºÂºè');
            return;
          }
          
          if (!confirm(`Á°ÆÂÆöË¶ÅÊÅ¢Â§çÂ§á‰ªΩÊï∞ÊçÆÂêóÔºü\n\nÂ§á‰ªΩÊó∂Èó¥: ${backupData.exportDate}\nÈ∏ΩÂ≠êÊï∞Èáè: ${backupData.data.pigeons.length}\nÊØîËµõÊï∞Èáè: ${backupData.data.races?.length || 0}\n\n‚ö†Ô∏è ËøôÂ∞ÜË¶ÜÁõñÂΩìÂâçÊâÄÊúâÊï∞ÊçÆÔºÅ`)) {
            return;
          }
          
          // ÊÅ¢Â§çÊï∞ÊçÆÂà∞localStorage
          localStorage.setItem('pigeons', JSON.stringify(backupData.data.pigeons));
          
          if (backupData.data.races) {
            localStorage.setItem('races', JSON.stringify(backupData.data.races));
          }
          
          if (backupData.data.pairings) {
            localStorage.setItem('pairings', JSON.stringify(backupData.data.pairings));
          }
          
          if (backupData.data.healthRecords) {
            localStorage.setItem('healthRecords', JSON.stringify(backupData.data.healthRecords));
          }
          
          if (backupData.data.usedNames) {
            localStorage.setItem('usedNames', JSON.stringify(backupData.data.usedNames));
          }
          
          if (backupData.data.ownerRegionPairs) {
            localStorage.setItem('ownerRegionPairs', JSON.stringify(backupData.data.ownerRegionPairs));
          }
          
          alert('Êï∞ÊçÆÊÅ¢Â§çÊàêÂäüÔºÅ\n\nÂ∑≤ÊÅ¢Â§ç ' + backupData.data.pigeons.length + ' Âè™È∏ΩÂ≠êÁöÑÊï∞ÊçÆ„ÄÇ\nËØ∑Âà∑Êñ∞È°µÈù¢Êü•ÁúãÊõ¥Êñ∞„ÄÇ');
        } catch (error) {
          console.error('ÂØºÂÖ•Êï∞ÊçÆÂ§±Ë¥•:', error);
          alert('ÂØºÂÖ•Êï∞ÊçÆÂ§±Ë¥•Ôºö' + error.message);
        }
      };
      reader.readAsText(file);
    };
    
    // ÂàùÂßãÂåñÁî®Êà∑‰ø°ÊÅØÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
    function initAdminUserInfo() {
      const userInfo = localStorage.getItem('adminUserInfo');
      if (!userInfo) {
        const adminUserName = document.getElementById('adminUserName')?.textContent || '';
        const userNameMatch = adminUserName.match(/Ê¨¢ËøéÔºå(.+)/);
        const userName = userNameMatch ? userNameMatch[1] : 'ÁÆ°ÁêÜÂëò';
        
        const defaultUserInfo = {
          name: userName,
          email: 'admin@example.com',
          type: 'ÁÆ°ÁêÜÂëò',
          role: 'ÁÆ°ÁêÜÂëò',
          registerDate: new Date().toISOString().split('T')[0]
        };
        localStorage.setItem('adminUserInfo', JSON.stringify(defaultUserInfo));
      }
    }
    
    // ÁªëÂÆöÁî®Êà∑Â§¥ÂÉèÂíåËÆæÁΩÆÊåâÈíÆ‰∫ã‰ª∂
    function bindUserButtons() {
      // ÁªëÂÆöÁî®Êà∑Â§¥ÂÉèÊåâÈíÆ
      const btnUserAvatar = document.getElementById('btnUserAvatar');
      if (btnUserAvatar) {
        btnUserAvatar.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          showUserInfoModal();
        });
        
        // È°µÈù¢Âä†ËΩΩÊó∂Êõ¥Êñ∞È°∂ÈÉ®ÂØºËà™Ê†èÁöÑÁî®Êà∑ÊòæÁ§∫
        updateTopBarUserDisplay();
      }
      
      // ÁªëÂÆöËÆæÁΩÆÊåâÈíÆ
      const btnSettings = document.getElementById('btnSettings');
      if (btnSettings) {
        btnSettings.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          showSettingsModal();
        });
      }
      
      // ÁªëÂÆöËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÂÜÖÁöÑÊåâÈíÆ
      const btnToggleThemeInModal = document.getElementById('btnToggleThemeInModal');
      if (btnToggleThemeInModal) {
        btnToggleThemeInModal.addEventListener('click', function() {
          const themeToggle = document.getElementById('themeToggle');
          if (themeToggle) {
            themeToggle.click();
          }
          // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨
          setTimeout(() => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            btnToggleThemeInModal.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è ÊµÖËâ≤Ê®°Âºè' : 'üåô Â§úÈó¥Ê®°Âºè';
            btnToggleThemeInModal.title = currentTheme === 'dark' ? 'ÂàáÊç¢Âà∞ÊµÖËâ≤Ê®°Âºè' : 'ÂàáÊç¢Âà∞Ê∑±Ëâ≤Ê®°Âºè';
          }, 100);
        });
      }
      
      // ÁªëÂÆöÊï∞ÊçÆÁÆ°ÁêÜÊåâÈíÆ
      const btnBackupDataInModal = document.getElementById('btnBackupDataInModal');
      if (btnBackupDataInModal) {
        btnBackupDataInModal.addEventListener('click', function() {
          exportAllData();
        });
      }
      
      const btnExportDataInModal = document.getElementById('btnExportDataInModal');
      if (btnExportDataInModal) {
        btnExportDataInModal.addEventListener('click', function() {
          exportAllData();
        });
      }
      
      const btnImportDataInModal = document.getElementById('btnImportDataInModal');
      if (btnImportDataInModal) {
        btnImportDataInModal.addEventListener('click', function() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
              importBackupData(file);
            }
          };
          input.click();
        });
      }
      
      // ÁªëÂÆöÈÄÄÂá∫ÁôªÂΩïÊåâÈíÆÔºàÂú®ËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÂÜÖÔºâ
      const logoutBtnInModal = document.getElementById('logoutBtnInModal');
      if (logoutBtnInModal) {
        logoutBtnInModal.addEventListener('click', function() {
          localStorage.removeItem('adminToken');
          localStorage.removeItem('adminUser');
          const loginPage = document.getElementById('loginPage');
          const adminPage = document.getElementById('adminPage');
          if (loginPage) loginPage.style.display = 'flex';
          if (adminPage) adminPage.style.display = 'none';
          const usernameInput = document.getElementById('username');
          const passwordInput = document.getElementById('password');
          if (usernameInput) usernameInput.value = '';
          if (passwordInput) passwordInput.value = '';
          closeSettingsModal();
        });
      }
      
      // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠
      const userInfoModal = document.getElementById('userInfoModal');
      const settingsModal = document.getElementById('settingsModal');
      
      if (userInfoModal) {
        userInfoModal.addEventListener('click', function(e) {
          if (e.target === userInfoModal) {
            closeUserInfoModal();
          }
        });
      }
      
      if (settingsModal) {
        settingsModal.addEventListener('click', function(e) {
          if (e.target === settingsModal) {
            closeSettingsModal();
          }
        });
      }
      
      // ESCÈîÆÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeUserInfoModal();
          closeSettingsModal();
        }
      });
    }
    
    // ÁªëÂÆöEvoËÆæÁΩÆÊåâÈíÆ‰∫ã‰ª∂
    document.addEventListener('DOMContentLoaded', () => {
      // ÂàùÂßãÂåñÁî®Êà∑‰ø°ÊÅØ
      initAdminUserInfo();
      
      // ÁªëÂÆöÁî®Êà∑ÊåâÈíÆ
      bindUserButtons();
      
      // Âª∂ËøüÁªëÂÆöÔºåÁ°Æ‰øùÁî®Êà∑ÂêçÂ∑≤Âä†ËΩΩ
      setTimeout(() => {
        initAdminUserInfo();
      }, 1000);
      const btnSave = document.getElementById('btnSaveEvoSettings');
      const btnReset = document.getElementById('btnResetEvoSettings');
      const btnSync = document.getElementById('btnSyncEvoSettings');
      const btnTestAI = document.getElementById('btnAdminTestAI');
      
      if (btnSave) {
        btnSave.addEventListener('click', saveEvoSettings);
      }
      
      if (btnReset) {
        btnReset.addEventListener('click', resetEvoSettings);
      }
      
      if (btnSync) {
        btnSync.addEventListener('click', syncEvoSettingsToMainSite);
      }
      
      if (btnTestAI) {
        btnTestAI.addEventListener('click', testAdminAIConnection);
      }
      
      // ÂΩìÂàáÊç¢Âà∞EvoËÆæÁΩÆÊ†áÁ≠æÊó∂ÔºåÂä†ËΩΩAIÊ®°Âûã‰ø°ÊÅØ
      const evoSettingsTab = document.getElementById('evoSettingsTab');
      if (evoSettingsTab) {
        // Á´ãÂç≥Âä†ËΩΩ‰∏ÄÊ¨°ÔºàÂ¶ÇÊûúÊ†áÁ≠æÈ°µÂ∑≤ÁªèÊòæÁ§∫Ôºâ
        if (evoSettingsTab.style.display !== 'none') {
          console.log('üîÑ EvoËÆæÁΩÆÈ°µÈù¢Â∑≤ÊòæÁ§∫ÔºåÁ´ãÂç≥Âä†ËΩΩAI‰ø°ÊÅØ...');
          setTimeout(() => {
            loadAdminAIModelInfo();
            loadEvoAIModelInfo();
          }, 200);
        }
        
        const observer = new MutationObserver((mutations) => {
          if (evoSettingsTab.style.display !== 'none') {
            console.log('üîÑ EvoËÆæÁΩÆÈ°µÈù¢ÊòæÁ§∫ÔºåÂä†ËΩΩAI‰ø°ÊÅØ...');
            setTimeout(() => {
              loadAdminAIModelInfo();
              loadEvoAIModelInfo();
            }, 200);
          }
        });
        observer.observe(evoSettingsTab, { attributes: true, attributeFilter: ['style'] });
        
        // ÁõëÂê¨ÊâÄÊúâÂèØËÉΩÁöÑÊ†áÁ≠æÂàáÊç¢ÊñπÂºè
        // ÊñπÂºè1ÔºöÈÄöËøáÂØºËà™ËèúÂçï
        document.querySelectorAll('[data-tab="evoSettings"], [onclick*="evoSettings"]').forEach(el => {
          el.addEventListener('click', () => {
            setTimeout(() => {
              if (evoSettingsTab.style.display !== 'none') {
                console.log('üîÑ ÁÇπÂáªEvoËÆæÁΩÆÊ†áÁ≠æÔºåÂä†ËΩΩAI‰ø°ÊÅØ...');
                loadEvoAIModelInfo();
              }
            }, 300);
          });
        });
        
        // ÊñπÂºè2ÔºöÈÄöËøá‰æßËæπÊ†èÁÇπÂáª
        const sidebarLinks = document.querySelectorAll('a, .nav-item, .menu-item');
        sidebarLinks.forEach(link => {
          if (link.textContent && link.textContent.includes('EvoËÆæÁΩÆ')) {
            link.addEventListener('click', () => {
              setTimeout(() => {
                if (evoSettingsTab.style.display !== 'none') {
                  console.log('üîÑ ÈÄöËøá‰æßËæπÊ†èÊâìÂºÄEvoËÆæÁΩÆÔºåÂä†ËΩΩAI‰ø°ÊÅØ...');
                  loadEvoAIModelInfo();
                }
              }, 300);
            });
          }
        });
      }
      
      // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêé‰πüÂ∞ùËØïÂä†ËΩΩ‰∏ÄÊ¨°
      if (document.readyState === 'complete') {
        setTimeout(() => {
          if (evoSettingsTab && evoSettingsTab.style.display !== 'none') {
            console.log('üîÑ È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÊ£ÄÊü•EvoËÆæÁΩÆÈ°µÈù¢...');
            loadEvoAIModelInfo();
          }
        }, 1000);
      } else {
        window.addEventListener('load', () => {
          setTimeout(() => {
            if (evoSettingsTab && evoSettingsTab.style.display !== 'none') {
              console.log('üîÑ Á™óÂè£Âä†ËΩΩÂÆåÊàêÔºåÊ£ÄÊü•EvoËÆæÁΩÆÈ°µÈù¢...');
              loadEvoAIModelInfo();
            }
          }, 1000);
        });
      }
      
      // ÁªëÂÆöEvoËÆæÁΩÆÈ°µÈù¢ÁöÑAI‰ø°ÊÅØÊåâÈíÆ
      const btnRefreshAI = document.getElementById('btnEvoRefreshAIInfo');
      const btnTestEvoAI = document.getElementById('btnEvoTestAI');
      
      if (btnRefreshAI) {
        btnRefreshAI.addEventListener('click', () => {
          console.log('üîÑ ÊâãÂä®Âà∑Êñ∞AI‰ø°ÊÅØÊåâÈíÆË¢´ÁÇπÂáª');
          loadEvoAIModelInfo();
          const statusEl = document.getElementById('evoAIInfoStatus');
          if (statusEl) {
            statusEl.style.display = 'block';
            statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
            statusEl.style.color = 'var(--text-primary)';
            statusEl.textContent = '‚úÖ AI‰ø°ÊÅØÂ∑≤Âà∑Êñ∞';
            setTimeout(() => {
              statusEl.style.display = 'none';
            }, 2000);
          }
        });
      }
      
      // Á°Æ‰øùÈ°µÈù¢Âä†ËΩΩÊó∂‰πüÂ∞ùËØïÂä†ËΩΩAI‰ø°ÊÅØ
      setTimeout(() => {
        const evoSettingsTab = document.getElementById('evoSettingsTab');
        if (evoSettingsTab && evoSettingsTab.style.display !== 'none') {
          console.log('üîÑ EvoËÆæÁΩÆÈ°µÈù¢ÂèØËßÅÔºåËá™Âä®Âä†ËΩΩAI‰ø°ÊÅØ');
          loadEvoAIModelInfo();
        }
      }, 1000);
      
      if (btnTestEvoAI) {
        btnTestEvoAI.addEventListener('click', async () => {
          btnTestEvoAI.disabled = true;
          btnTestEvoAI.textContent = 'ÊµãËØï‰∏≠...';
          
          const statusEl = document.getElementById('evoAIInfoStatus');
          if (statusEl) {
            statusEl.style.display = 'block';
            statusEl.style.background = 'rgba(255, 152, 0, 0.3)';
            statusEl.textContent = 'üîÑ Ê≠£Âú®ÊµãËØïAIËøûÊé•...';
          }
          
          try {
            const token = getAuthToken();
            if (!token) {
              throw new Error('ËØ∑ÂÖàÁôªÂΩï');
            }
            
            const response = await fetch(`${getApiUrl()}/evo/test`, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              }
            });
            
            const result = await response.json();
            
            if (statusEl) {
              if (result.success) {
                statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
                statusEl.textContent = `‚úÖ ${result.message || 'AIËøûÊé•ÊµãËØïÊàêÂäüÔºÅ'}`;
              } else {
                statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
                statusEl.textContent = `‚ùå ${result.message || 'AIËøûÊé•ÊµãËØïÂ§±Ë¥•'}`;
              }
            }
          } catch (error) {
            if (statusEl) {
              statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
              statusEl.textContent = `‚ùå ÊµãËØïÂ§±Ë¥•: ${error.message}`;
            }
          } finally {
            btnTestEvoAI.disabled = false;
            btnTestEvoAI.textContent = 'üß™ ÊµãËØïËøûÊé•';
          }
        });
      }
    });
    
    // Ëé∑ÂèñtokenÂáΩÊï∞ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
    function getAuthToken() {
      // ‰ºòÂÖà‰ΩøÁî®adminTokenÔºàÊô∫ËÉΩÁÆ°ÁêÜÁ≥ªÁªü‰ΩøÁî®ÁöÑtokenÔºâ
      const adminToken = localStorage.getItem('adminToken');
      if (adminToken) {
        return adminToken;
      }
      // Â¶ÇÊûúÊ≤°ÊúâadminTokenÔºåÂ∞ùËØï‰ΩøÁî®tokenÔºà‰∏ªÁ´ô‰ΩøÁî®ÁöÑtokenÔºâ
      return localStorage.getItem('token');
    }
    
    // Âä†ËΩΩEvoËÆæÁΩÆÈ°µÈù¢ÁöÑAIÊ®°Âûã‰ø°ÊÅØ
    async function loadEvoAIModelInfo() {
      // ÂÖàÊ£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
      const nameEl = document.getElementById('evoAIModelName');
      const statusInfoEl = document.getElementById('evoAIInfoStatus');
      
      if (!nameEl) {
        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        if (statusInfoEl) {
          statusInfoEl.style.display = 'block';
          statusInfoEl.style.background = 'rgba(255, 152, 0, 0.3)';
          statusInfoEl.style.color = 'var(--text-primary)';
          statusInfoEl.innerHTML = '‚è≥ È°µÈù¢Ê≠£Âú®Âä†ËΩΩÔºåËØ∑Á®çÂÄô...';
        }
        setTimeout(() => loadEvoAIModelInfo(), 500);
        return;
      }
      
      // ÊòæÁ§∫Âä†ËΩΩ‰∏≠Áä∂ÊÄÅ
      if (statusInfoEl) {
        statusInfoEl.style.display = 'block';
        statusInfoEl.style.background = 'rgba(255, 152, 0, 0.3)';
        statusInfoEl.style.color = 'var(--text-primary)';
        statusInfoEl.innerHTML = 'üîÑ Ê≠£Âú®Âä†ËΩΩAI‰ø°ÊÅØ...';
      }
      
      const providerEl = document.getElementById('evoAIProvider');
      if (nameEl) nameEl.textContent = 'Âä†ËΩΩ‰∏≠...';
      if (providerEl) providerEl.textContent = 'Âä†ËΩΩ‰∏≠...';
      
      try {
        const token = getAuthToken();
        if (!token) {
          if (statusInfoEl) {
            statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
            statusInfoEl.innerHTML = '‚ùå <strong>Êú™ÁôªÂΩï</strong><br>ËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªüÔºåÁÑ∂ÂêéÊâçËÉΩÊü•ÁúãAIÊ®°Âûã‰ø°ÊÅØ„ÄÇ';
          }
          displayEvoAIModelInfo(null);
          return;
        }
        
        const apiUrl = getApiUrl();
        
        const response = await fetch(`${apiUrl}/evo/model-info`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success && result.data) {
            displayEvoAIModelInfo(result.data);
          } else {
            if (statusInfoEl) {
              statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
              statusInfoEl.innerHTML = `‚ùå <strong>APIËøîÂõûÈîôËØØ</strong><br>${result.error || 'Êú™Áü•ÈîôËØØ'}`;
            }
            displayEvoAIModelInfo(null);
          }
        } else {
          const errorData = await response.json().catch(() => ({ error: 'Êó†Ê≥ïËß£ÊûêÈîôËØØ‰ø°ÊÅØ' }));
          
          if (statusInfoEl) {
            statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
            let errorMsg = `‚ùå <strong>Âä†ËΩΩÂ§±Ë¥• (${response.status})</strong><br>`;
            
            if (response.status === 401) {
              errorMsg += 'ËÆ§ËØÅÂ§±Ë¥•ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩïÔºÅ';
            } else if (response.status === 404) {
              errorMsg += 'APIÊé•Âè£‰∏çÂ≠òÂú®ÔºåËØ∑Ê£ÄÊü•ÂêéÁ´ØÊúçÂä°ÔºÅ';
            } else if (response.status === 500) {
              errorMsg += 'ÊúçÂä°Âô®ÂÜÖÈÉ®ÈîôËØØÔºåËØ∑Ê£ÄÊü•ÂêéÁ´ØÊó•ÂøóÔºÅ';
            } else {
              errorMsg += errorData.error || 'Êú™Áü•ÈîôËØØ';
            }
            
            statusInfoEl.innerHTML = errorMsg;
          }
          
          displayEvoAIModelInfo(null);
        }
      } catch (error) {
        if (statusInfoEl) {
          statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
          let errorMsg = '‚ùå <strong>ÁΩëÁªúÈîôËØØ</strong><br>';
          
          if (error.message.includes('Failed to fetch')) {
            errorMsg += 'Êó†Ê≥ïËøûÊé•Âà∞ÂêéÁ´ØÊúçÂä°ÔºÅ<br>ËØ∑Á°ÆËÆ§Ôºö<br>1. ÂêéÁ´ØÊúçÂä°Â∑≤ÂêØÂä®ÔºàËøêË°å npm startÔºâ<br>2. ÊúçÂä°Âú∞ÂùÄÊ≠£Á°ÆÔºàhttp://localhost:3000Ôºâ<br>3. ÁΩëÁªúËøûÊé•Ê≠£Â∏∏';
          } else {
            errorMsg += error.message || 'Êú™Áü•ÈîôËØØ';
          }
          
          statusInfoEl.innerHTML = errorMsg;
        }
        
        displayEvoAIModelInfo(null);
      }
    }
    
    // ÊòæÁ§∫EvoËÆæÁΩÆÈ°µÈù¢ÁöÑAIÊ®°Âûã‰ø°ÊÅØ
    function displayEvoAIModelInfo(modelInfo) {
      const nameEl = document.getElementById('evoAIModelName');
      const providerEl = document.getElementById('evoAIProvider');
      const statusEl = document.getElementById('evoAIStatus');
      const sourceEl = document.getElementById('evoAISource');
      const descEl = document.getElementById('evoAIDescription');
      const featuresEl = document.getElementById('evoAIFeatures');
      const statusInfoEl = document.getElementById('evoAIInfoStatus');
      
      // ÊòæÁ§∫Áä∂ÊÄÅ‰ø°ÊÅØ
      if (statusInfoEl) {
        statusInfoEl.style.display = 'block';
        statusInfoEl.style.padding = '12px';
        statusInfoEl.style.borderRadius = '6px';
        statusInfoEl.style.fontSize = '14px';
      }
      
      if (!modelInfo) {
        if (nameEl) nameEl.textContent = '‚ùå Êú™ÈÖçÁΩÆ';
        if (providerEl) providerEl.textContent = 'Êú™Áü•';
        if (statusEl) {
          statusEl.textContent = '‚ùå Êú™ÈÖçÁΩÆ';
          statusEl.style.background = 'rgba(244, 67, 54, 0.3)';
        }
        if (sourceEl) {
          sourceEl.href = '#';
          sourceEl.textContent = 'Êó†';
        }
        if (descEl) descEl.textContent = 'AIÊúçÂä°Êú™ÈÖçÁΩÆÔºåËØ∑Ê£ÄÊü•API KeyËÆæÁΩÆ';
        if (featuresEl) featuresEl.textContent = 'Êó†ÂèØÁî®ÂäüËÉΩ';
        
        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        if (statusInfoEl) {
          statusInfoEl.style.background = 'rgba(244, 67, 54, 0.3)';
          statusInfoEl.style.color = 'var(--text-primary)';
          statusInfoEl.innerHTML = '‚ùå <strong>AI‰ø°ÊÅØÂä†ËΩΩÂ§±Ë¥•</strong><br>ËØ∑ÁÇπÂáª"üîÑ Âà∑Êñ∞‰ø°ÊÅØ"ÊåâÈíÆÈáçËØïÔºåÊàñÊ£ÄÊü•ÂêéÁ´ØÊúçÂä°ÊòØÂê¶Ê≠£Â∏∏ËøêË°å„ÄÇ';
        }
        return;
      }
      
      // ÊòæÁ§∫ÊàêÂäü‰ø°ÊÅØ
      if (statusInfoEl) {
        statusInfoEl.style.background = 'rgba(76, 175, 80, 0.3)';
        statusInfoEl.style.color = 'var(--text-primary)';
        statusInfoEl.innerHTML = '‚úÖ <strong>AI‰ø°ÊÅØÂä†ËΩΩÊàêÂäü</strong>';
        setTimeout(() => {
          if (statusInfoEl) statusInfoEl.style.display = 'none';
        }, 3000);
      }
      
      if (nameEl) nameEl.textContent = modelInfo.name || 'Êú™Áü•';
      if (providerEl) providerEl.textContent = modelInfo.provider || 'Êú™Áü•';
      
      if (statusEl) {
        if (modelInfo.free) {
          statusEl.textContent = '‚úÖ ÂÖçË¥π‰ΩøÁî®';
          statusEl.style.background = 'rgba(76, 175, 80, 0.3)';
        } else {
          statusEl.textContent = 'üí∞ ‰ªòË¥π';
          statusEl.style.background = 'rgba(255, 152, 0, 0.3)';
        }
      }
      
      if (sourceEl) {
        sourceEl.href = modelInfo.source || '#';
        sourceEl.textContent = modelInfo.source ? 'Êü•ÁúãÊ®°ÂûãËØ¶ÊÉÖ' : 'Êó†';
      }
      
      if (descEl) {
        descEl.textContent = modelInfo.description || 'Êô∫ËÉΩÂØπËØùÊ®°ÂûãÔºåÊîØÊåÅ‰∏≠ÊñáÂØπËØù';
      }
      
      if (featuresEl && modelInfo.features && Array.isArray(modelInfo.features)) {
        featuresEl.innerHTML = modelInfo.features.map(f => `‚Ä¢ ${f}`).join('<br>');
      } else if (featuresEl) {
        featuresEl.innerHTML = '‚Ä¢ ÂÆåÂÖ®ÂÖçË¥π‰ΩøÁî®<br>‚Ä¢ ÊîØÊåÅ‰∏≠ÊñáÂØπËØù<br>‚Ä¢ È´òÊÄßËÉΩÂìçÂ∫î';
      }
    }
    
    // ==========================================
    // üïäÔ∏è Evo Êô∫ËÉΩÂä©ÊâãÂäüËÉΩ
    // ==========================================
    
    const EvoAssistant = (function() {
      const CHAT_HISTORY_KEY = 'evo_chat_history';
      const USED_GREETINGS_KEY = 'evo_used_greetings_admin';
      
      // Ê¨¢ËøéÊ∂àÊÅØÂêéÁºÄÈÄâÈ°πÔºàÈíàÂØπÊô∫ËÉΩÁÆ°ÁêÜÔºâ
      const GREETING_SUFFIXES = [
        'ÁÆ°ÁêÜÂÖ¨Âëä',
        'Êü•ÁúãÁªüËÆ°Êï∞ÊçÆ',
        'ÁÆ°ÁêÜÁ≥ªÁªüËÆæÁΩÆ',
        'ÈÖçÁΩÆÊô∫ËÉΩÂä©Êâã',
        'ÂàÜÊûêÁî®Êà∑Êï∞ÊçÆ',
        '‰ºòÂåñÁ≥ªÁªüÊÄßËÉΩ',
        'Êü•ÁúãÁ≥ªÁªüÊó•Âøó',
        'ÁÆ°ÁêÜÊùÉÈôêËÆæÁΩÆ',
        'ÁîüÊàêÊï∞ÊçÆÊä•Ë°®',
        'ÁõëÊéßÁ≥ªÁªüÁä∂ÊÄÅ',
        'ÈÖçÁΩÆAPIÊé•Âè£',
        'ÁÆ°ÁêÜÊï∞ÊçÆÂ§á‰ªΩ',
        '‰ºòÂåñÊï∞ÊçÆÂ∫ì',
        'Êü•ÁúãÁ≥ªÁªüÂàÜÊûê',
        'ÁÆ°ÁêÜÂäüËÉΩÊ®°Âùó'
      ];
      
      let isExpanded = false;
      let activeTab = 'chat';
      let messages = [];
      let isTyping = false;
      let hasShownGreetingThisPageLoad = false;
      let assistantEl, iconButton, dialog, messagesContainer, inputField, sendBtn;
      
      function init() {
        try {
          createHTML();
          bindEvents();
          ensureIconVisible();
          setTimeout(() => ensureIconVisible(), 100);
          setTimeout(() => ensureIconVisible(), 500);
          
          // Âª∂ËøüÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ
          hasShownGreetingThisPageLoad = false;
          setTimeout(() => {
            showWelcomeGreeting();
          }, 1500);
          setTimeout(() => {
            const existingBubble = document.getElementById('evoWelcomeBubble');
            if (!existingBubble) {
              showWelcomeGreeting();
            }
          }, 3000);
        } catch (error) {
          console.error('EvoÂàùÂßãÂåñÈîôËØØ:', error);
        }
      }
      
      function ensureIconVisible() {
        try {
          let assistant = document.getElementById('evoAssistant');
          if (!assistant) {
            createHTML();
            assistant = document.getElementById('evoAssistant');
          }
          if (assistant) {
            assistant.style.cssText = `
              position: fixed !important;
              bottom: 80px !important;
              right: 20px !important;
              z-index: 99999 !important;
              display: block !important;
              visibility: visible !important;
              opacity: 1 !important;
              pointer-events: auto !important;
            `;
            assistantEl = assistant;
          }
        } catch (error) {
          console.error('ensureIconVisibleÈîôËØØ:', error);
        }
      }
      
      function createHTML() {
        const existing = document.getElementById('evoAssistant');
        if (existing) existing.remove();
        
        const html = `
          <div class="evo-assistant" id="evoAssistant">
            <div class="evo-icon-button" id="evoIconButton">
              <div class="evo-pigeon-icon">
                <span class="evo-icon">üïäÔ∏è</span>
                <div class="evo-pulse"></div>
              </div>
            </div>
            
            <div class="evo-dialog" id="evoDialog" style="display: none;">
              <div class="evo-header">
                <div class="evo-header-left">
                  <span class="evo-icon-large">üïäÔ∏è</span>
                  <div>
                    <h3 class="evo-title">Evo Êô∫ËÉΩÂä©Êâã</h3>
                    <p class="evo-subtitle" id="evoStatus">ÂáÜÂ§áÂ•Ω‰∏∫ÊÇ®ÊúçÂä°</p>
                  </div>
                </div>
                <button class="evo-close-btn" id="evoCloseBtn">√ó</button>
              </div>
              
              <div class="evo-content">
                <div class="evo-tabs">
                  <div class="evo-tab-headers">
                    <div class="evo-tab-header active" data-tab="chat">üí¨ ÂØπËØù</div>
                    <div class="evo-tab-header" data-tab="analytics">üìä Êï∞ÊçÆ</div>
                    <div class="evo-tab-header" data-tab="recommendations">‚ú® Êé®Ëçê</div>
                  </div>
                  
                  <div class="evo-tab-content active" id="tabChat">
                    <div class="evo-chat-container">
                      <div class="evo-messages" id="evoMessages"></div>
                      <div class="evo-input-area">
                        <div class="evo-input-group">
                          <input type="text" class="evo-input" id="evoInput" placeholder="ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò...">
                          <button class="evo-send-btn" id="evoSendBtn">ÂèëÈÄÅ</button>
                        </div>
                        <div class="evo-quick-actions">
                          <button class="evo-quick-action-btn" data-action="stats">Êü•ÁúãÁªüËÆ°Êï∞ÊçÆ</button>
                          <button class="evo-quick-action-btn" data-action="help">Â∏ÆÂä©</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="evo-tab-content" id="tabAnalytics">
                    <div class="evo-analytics" id="evoAnalytics">
                      <div class="evo-empty">ÊöÇÊó†ÂàÜÊûêÊä•Âëä</div>
                    </div>
                  </div>
                  
                  <div class="evo-tab-content" id="tabRecommendations">
                    <div class="evo-recommendations" id="evoRecommendations">
                      <div class="evo-empty">ÊöÇÊó†Êé®ËçêÂÜÖÂÆπ</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', html);
        
        assistantEl = document.getElementById('evoAssistant');
        iconButton = document.getElementById('evoIconButton');
        dialog = document.getElementById('evoDialog');
        messagesContainer = document.getElementById('evoMessages');
        inputField = document.getElementById('evoInput');
        sendBtn = document.getElementById('evoSendBtn');
        
        if (assistantEl) {
          assistantEl.style.cssText = `
            position: fixed !important;
            bottom: 80px !important;
            right: 20px !important;
            z-index: 99999 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
          `;
        }
      }
      
      function bindEvents() {
        if (!iconButton) return;
        
        iconButton.addEventListener('click', toggleExpanded);
        const closeBtn = document.getElementById('evoCloseBtn');
        if (closeBtn) {
          closeBtn.addEventListener('click', toggleExpanded);
        }
        
        if (sendBtn) sendBtn.addEventListener('click', sendMessage);
        if (inputField) {
          inputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isTyping) {
              sendMessage();
            }
          });
        }
        
        document.querySelectorAll('.evo-tab-header').forEach(header => {
          header.addEventListener('click', () => {
            const tab = header.dataset.tab;
            switchTab(tab);
          });
        });
        
        document.querySelectorAll('.evo-quick-action-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const action = btn.dataset.action;
            if (action === 'stats') {
              inputField.value = 'Êü•ÁúãÁªüËÆ°Êï∞ÊçÆ';
              sendMessage();
            } else if (action === 'help') {
              inputField.value = 'Â∏ÆÂä©';
              sendMessage();
            }
          });
        });
      }
      
      function toggleExpanded() {
        isExpanded = !isExpanded;
        if (dialog) {
          dialog.style.display = isExpanded ? 'flex' : 'none';
        }
        if (isExpanded) {
          loadHistory();
        }
      }
      
      function switchTab(tab) {
        activeTab = tab;
        document.querySelectorAll('.evo-tab-header').forEach(h => {
          h.classList.toggle('active', h.dataset.tab === tab);
        });
        document.querySelectorAll('.evo-tab-content').forEach(c => {
          c.classList.toggle('active', c.id === `tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
        });
      }
      
      async function sendMessage() {
        const text = inputField.value.trim();
        if (!text || isTyping) return;
        
        addMessage('user', text);
        inputField.value = '';
        
        isTyping = true;
        updateStatus('Ê≠£Âú®ÊÄùËÄÉ...');
        
        try {
          const response = await chat(text);
          addMessage('evo', response.text);
          saveHistory();
        } catch (error) {
          addMessage('evo', 'Êä±Ê≠âÔºåÊàëÊöÇÊó∂Êó†Ê≥ïÂìçÂ∫îÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ');
        } finally {
          isTyping = false;
          updateStatus('Âú®Á∫ø');
        }
      }
      
      // Ëé∑ÂèñtokenÂáΩÊï∞
      function getAuthToken() {
        // ‰ºòÂÖà‰ΩøÁî®adminTokenÔºàÊô∫ËÉΩÁÆ°ÁêÜÁ≥ªÁªü‰ΩøÁî®ÁöÑtokenÔºâ
        const adminToken = localStorage.getItem('adminToken');
        if (adminToken) {
          return adminToken;
        }
        // Â¶ÇÊûúÊ≤°ÊúâadminTokenÔºåÂ∞ùËØï‰ΩøÁî®tokenÔºà‰∏ªÁ´ô‰ΩøÁî®ÁöÑtokenÔºâ
        return localStorage.getItem('token');
      }
      
      // Ë∞ÉÁî®ÂêéÁ´ØAI API
      async function chatWithBackendAPI(question, history = [], context = {}) {
        try {
          // ‰ΩøÁî®Áªü‰∏ÄÁöÑgetApiUrlÂáΩÊï∞
          const apiBaseUrl = getApiUrl();
          
          const token = getAuthToken();
          if (!token) {
            console.warn('‚ùå Êú™ÊâæÂà∞tokenÔºåÊó†Ê≥ïË∞ÉÁî®ÂêéÁ´ØAPI„ÄÇËØ∑ÂÖàÁôªÂΩïÔºÅ');
            return null;
          }
          
          console.log(`üîÑ Ê≠£Âú®Ë∞ÉÁî®ÂêéÁ´ØAI API...`);
          console.log(`üì° APIÂú∞ÂùÄ: ${apiBaseUrl}/evo/chat`);
          console.log(`üìù ÈóÆÈ¢ò: ${question.substring(0, 50)}...`);
          
          const startTime = Date.now();
          const response = await fetch(`${apiBaseUrl}/evo/chat`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              question: question,
              history: history,
              context: context
            })
          });
          
          const responseTime = Date.now() - startTime;
          console.log(`‚è±Ô∏è ÂìçÂ∫îÊó∂Èó¥: ${responseTime}ms`);
          
          if (response.ok) {
            const data = await response.json();
            console.log('üì• APIÂìçÂ∫îÊï∞ÊçÆ:', data);
            
            if (data.success && data.data) {
              const responseText = data.data.text || data.data.response;
              if (responseText && responseText.length > 10) {
                console.log(`‚úÖ AI APIË∞ÉÁî®ÊàêÂäüÔºÅ`);
                console.log(`üìä ÂõûÂ§çÈïøÂ∫¶: ${responseText.length} Â≠óÁ¨¶`);
                console.log(`ü§ñ ‰ΩøÁî®Ê®°Âûã: ${data.data.model || 'Êú™Áü•'}`);
                console.log(`üè¢ ÊúçÂä°Êèê‰æõÂïÜ: ${data.data.provider || 'Êú™Áü•'}`);
                console.log(`üí¨ ÂõûÂ§çÈ¢ÑËßà: ${responseText.substring(0, 100)}...`);
                
                return { 
                  text: responseText, 
                  data: data.data,
                  modelInfo: data.modelInfo || null
                };
              } else {
                console.warn('‚ö†Ô∏è AIÂõûÂ§ç‰∏∫Á©∫ÊàñÂ§™Áü≠ÔºåÈïøÂ∫¶:', responseText?.length || 0);
              }
            } else {
              console.warn('‚ö†Ô∏è APIËøîÂõûsuccess=false:', data);
            }
          } else {
            const errorData = await response.json().catch(() => ({}));
            console.error('‚ùå ÂêéÁ´ØAI APIÂìçÂ∫îÈîôËØØ:', response.status);
            console.error('‚ùå ÈîôËØØËØ¶ÊÉÖ:', errorData);
            
            if (response.status === 401) {
              console.error('‚ùå ËÆ§ËØÅÂ§±Ë¥•ÔºÅËØ∑ÈáçÊñ∞ÁôªÂΩïÔºÅ');
              alert('ÁôªÂΩïÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ÁôªÂΩïÔºÅ');
            } else if (response.status === 500) {
              console.error('‚ùå ÊúçÂä°Âô®ÂÜÖÈÉ®ÈîôËØØÔºÅ');
            } else if (response.status === 404) {
              console.error('‚ùå APIÊé•Âè£‰∏çÂ≠òÂú®ÔºÅËØ∑Ê£ÄÊü•ÂêéÁ´ØÊúçÂä°ÔºÅ');
            }
          }
        } catch (error) {
          console.error('‚ùå Backend AI APIË∞ÉÁî®ÂºÇÂ∏∏:', error);
          console.error('‚ùå ÈîôËØØÁ±ªÂûã:', error.name);
          console.error('‚ùå ÈîôËØØÊ∂àÊÅØ:', error.message);
          
          if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            console.error('‚ùå ÁΩëÁªúÈîôËØØÔºöÊó†Ê≥ïËøûÊé•Âà∞ÂêéÁ´ØÊúçÂä°ÔºÅ');
            console.error('üí° ËØ∑Á°ÆËÆ§Ôºö1) ÂêéÁ´ØÊúçÂä°Â∑≤ÂêØÂä® 2) ÊúçÂä°Âú∞ÂùÄÊ≠£Á°Æ 3) ÁΩëÁªúËøûÊé•Ê≠£Â∏∏');
          }
        }
        
        return null;
      }
      
      async function chat(question) {
        console.log('üí¨ Êî∂Âà∞Áî®Êà∑ÈóÆÈ¢ò:', question);
        
        // Ëé∑ÂèñÂØπËØùÂéÜÂè≤
        const history = messages.map(msg => ({
          type: msg.type,
          text: msg.text,
          time: msg.time
        }));
        
        // Ëé∑Âèñ‰∏ä‰∏ãÊñáÊï∞ÊçÆÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâ
        const context = {};
        
        // ‰ºòÂÖàÁ∫ß1ÔºöÂ∞ùËØï‰ΩøÁî®ÂêéÁ´ØAI APIÔºàÂøÖÈ°ª‰ºòÂÖà‰ΩøÁî®AIÔºâ
        try {
          console.log('üîÑ Ê≠£Âú®Ë∞ÉÁî®ÂêéÁ´ØAI API...');
          const apiResponse = await chatWithBackendAPI(question, history, context);
          
          if (apiResponse && apiResponse.text && apiResponse.text.length > 10) {
            console.log('‚úÖ AI APIË∞ÉÁî®ÊàêÂäüÔºåËøîÂõûÊô∫ËÉΩAIÂõûÂ§ç');
            return apiResponse;
          } else {
            console.warn('‚ö†Ô∏è AI APIËøîÂõûÁöÑÂõûÂ§ç‰∏∫Á©∫ÊàñÂ§™Áü≠');
            console.warn('‚ö†Ô∏è ÂõûÂ§çÂÜÖÂÆπ:', apiResponse?.text || '(Á©∫)');
            console.warn('‚ö†Ô∏è ÁªßÁª≠Â∞ùËØïÂÖ∂‰ªñÊñπÂºè...');
          }
        } catch (error) {
          console.error('‚ùå ÂêéÁ´ØAI APIË∞ÉÁî®Â§±Ë¥•:', error);
          console.error('‚ùå ÈîôËØØÂ†ÜÊ†à:', error.stack);
        }
        
        // Â¶ÇÊûúAI APIÂ§±Ë¥•ÔºåÊòæÁ§∫ÊòéÁ°ÆÁöÑÈîôËØØÊèêÁ§∫
        const token = getAuthToken();
        if (!token) {
          return { 
            text: '‚ùå Êó†Ê≥ï‰ΩøÁî®AIÂäüËÉΩÔºöÊÇ®Â∞öÊú™ÁôªÂΩï„ÄÇ\n\nËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªüÔºåÁÑ∂ÂêéÊâçËÉΩ‰ΩøÁî®AIÂä©ÊâãÂäüËÉΩ„ÄÇ\n\nÁôªÂΩïÂêéÔºåAIÂä©ÊâãÂ∞Ü‰∏∫ÊÇ®Êèê‰æõÊô∫ËÉΩÂõûÂ§ç„ÄÇ' 
          };
        }
        
        // Ê£ÄÊü•ÂêéÁ´ØÊúçÂä°ÊòØÂê¶ÂèØËææ
        try {
          const healthCheck = await fetch(`${getApiUrl()}/health`).catch(() => null);
          if (!healthCheck || !healthCheck.ok) {
            return { 
              text: '‚ùå Êó†Ê≥ïËøûÊé•Âà∞ÂêéÁ´ØÊúçÂä°„ÄÇ\n\nËØ∑Á°ÆËÆ§Ôºö\n1. ÂêéÁ´ØÊúçÂä°Â∑≤ÂêØÂä®ÔºàËøêË°å npm startÔºâ\n2. ÊúçÂä°Âú∞ÂùÄÊ≠£Á°ÆÔºàhttp://localhost:3000Ôºâ\n3. ÁΩëÁªúËøûÊé•Ê≠£Â∏∏\n\nËøûÊé•ÊàêÂäüÂêéÔºåAIÂä©ÊâãÂ∞ÜÊ≠£Â∏∏Â∑•‰Ωú„ÄÇ' 
            };
          }
        } catch (e) {
          return { 
            text: '‚ùå ÂêéÁ´ØÊúçÂä°ËøûÊé•Â§±Ë¥•„ÄÇ\n\nËØ∑Ê£ÄÊü•Ôºö\n1. ÂêéÁ´ØÊúçÂä°ÊòØÂê¶Â∑≤ÂêØÂä®\n2. ÊúçÂä°Âú∞ÂùÄÊòØÂê¶Ê≠£Á°Æ\n3. Èò≤ÁÅ´Â¢ôËÆæÁΩÆ\n\n‰øÆÂ§çÂêéÔºåAIÂä©ÊâãÂ∞ÜËá™Âä®ÊÅ¢Â§ç„ÄÇ' 
          };
        }
        
        // Â¶ÇÊûúÂêéÁ´ØÊúçÂä°Ê≠£Â∏∏‰ΩÜAIË∞ÉÁî®Â§±Ë¥•ÔºåÊòæÁ§∫ÊèêÁ§∫
        return { 
          text: `‚ö†Ô∏è AIÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®„ÄÇ\n\nÈóÆÈ¢òÔºö"${question}"\n\nÂèØËÉΩÁöÑÂéüÂõ†Ôºö\n1. AI APIÈÖçÁΩÆÈóÆÈ¢ò\n2. API KeyÊó†ÊïàÊàñËøáÊúü\n3. ÁΩëÁªúËøûÊé•ÈóÆÈ¢ò\n\nËØ∑Ê£ÄÊü•Ôºö\n‚Ä¢ ÊµèËßàÂô®ÊéßÂà∂Âè∞ÁöÑÈîôËØØ‰ø°ÊÅØ\n‚Ä¢ ÂêéÁ´ØÊó•ÂøóÊñá‰ª∂\n‚Ä¢ API KeyÈÖçÁΩÆ\n\n‰øÆÂ§çÂêéÔºåAIÂä©ÊâãÂ∞ÜËá™Âä®ÊÅ¢Â§çÊô∫ËÉΩÂõûÂ§çÂäüËÉΩ„ÄÇ` 
        };
      }
      
      function addMessage(type, text) {
        const message = { type, text, time: new Date() };
        messages.push(message);
        renderMessages();
      }
      
      function renderMessages() {
        if (!messagesContainer) return;
        
        messagesContainer.innerHTML = messages.map(msg => {
          const timeStr = formatTime(msg.time);
          if (msg.type === 'user') {
            return `
              <div class="evo-message user">
                <div class="evo-message-avatar">üë§</div>
                <div class="evo-message-content">
                  <div class="evo-message-text">${formatMessage(msg.text)}</div>
                  <div class="evo-message-time">${timeStr}</div>
                </div>
              </div>
            `;
          } else {
            return `
              <div class="evo-message evo">
                <div class="evo-message-avatar">üïäÔ∏è</div>
                <div class="evo-message-content">
                  <div class="evo-message-text">${formatMessage(msg.text)}</div>
                  <div class="evo-message-time">${timeStr}</div>
                </div>
              </div>
            `;
          }
        }).join('');
        
        if (isTyping) {
          messagesContainer.innerHTML += `
            <div class="evo-message evo">
              <div class="evo-message-avatar">üïäÔ∏è</div>
              <div class="evo-message-content">
                <div class="evo-typing-indicator">
                  <span></span><span></span><span></span>
                </div>
              </div>
            </div>
          `;
        }
        
        scrollToBottom();
      }
      
      function formatMessage(text) {
        return text.replace(/\n/g, '<br>');
      }
      
      function formatTime(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        if (minutes < 1) return 'ÂàöÂàö';
        if (minutes < 60) return `${minutes}ÂàÜÈíüÂâç`;
        return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      }
      
      function scrollToBottom() {
        if (messagesContainer) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }
      
      function updateStatus(status) {
        const statusEl = document.getElementById('evoStatus');
        if (statusEl) {
          statusEl.textContent = status;
        }
      }
      
      function saveHistory() {
        try {
          localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(messages));
        } catch (error) {
          console.error('Failed to save chat history:', error);
        }
      }
      
      function loadHistory() {
        try {
          const history = localStorage.getItem(CHAT_HISTORY_KEY);
          if (history) {
            messages = JSON.parse(history).map(msg => ({
              ...msg,
              time: new Date(msg.time)
            }));
            renderMessages();
          }
        } catch (error) {
          console.error('Failed to load chat history:', error);
        }
      }
      
      // Ëé∑ÂèñÊú™‰ΩøÁî®ÁöÑÊ¨¢ËøéÊ∂àÊÅØÂêéÁºÄ
      function getUnusedGreetingSuffix() {
        try {
          const used = JSON.parse(localStorage.getItem(USED_GREETINGS_KEY) || '[]');
          const available = GREETING_SUFFIXES.filter(suffix => !used.includes(suffix));
          
          if (available.length === 0) {
            localStorage.setItem(USED_GREETINGS_KEY, '[]');
            return GREETING_SUFFIXES[Math.floor(Math.random() * GREETING_SUFFIXES.length)];
          }
          
          const selected = available[Math.floor(Math.random() * available.length)];
          used.push(selected);
          localStorage.setItem(USED_GREETINGS_KEY, JSON.stringify(used));
          
          return selected;
        } catch (error) {
          console.error('Ëé∑ÂèñÊ¨¢ËøéÊ∂àÊÅØÂ§±Ë¥•:', error);
          return GREETING_SUFFIXES[0];
        }
      }
      
      // ÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØÊ∞îÊ≥°ÂºπÁ™ó
      function showWelcomeGreeting() {
        const existingBubble = document.getElementById('evoWelcomeBubble');
        if (existingBubble) {
          return;
        }
        
        hasShownGreetingThisPageLoad = true;
        
        try {
          if (!document.body) {
            setTimeout(showWelcomeGreeting, 500);
            return;
          }
          
          const suffix = getUnusedGreetingSuffix();
          const greeting = `‰Ω†Â•ΩÔºåÊàëÊòØEvoÔºåÊàëÂèØ‰ª•Â∏Æ‰Ω†${suffix}„ÄÇ`;
          
          const bubble = document.createElement('div');
          bubble.id = 'evoWelcomeBubble';
          bubble.className = 'evo-welcome-bubble';
          
          bubble.style.position = 'fixed';
          bubble.style.bottom = '160px';
          bubble.style.right = '100px';
          bubble.style.zIndex = '99998';
          bubble.style.maxWidth = '280px';
          bubble.style.pointerEvents = 'auto';
          bubble.style.display = 'block';
          bubble.style.visibility = 'visible';
          bubble.style.opacity = '1';
          
          const bubbleContent = document.createElement('div');
          bubbleContent.className = 'evo-welcome-bubble-content';
          bubbleContent.textContent = greeting;
          
          bubbleContent.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          bubbleContent.style.color = '#fff';
          bubbleContent.style.padding = '12px 16px';
          bubbleContent.style.borderRadius = '8px';
          bubbleContent.style.fontSize = '14px';
          bubbleContent.style.lineHeight = '1.5';
          bubbleContent.style.boxShadow = '0 4px 20px rgba(102, 126, 234, 0.4), 0 0 30px rgba(118, 75, 162, 0.3)';
          bubbleContent.style.position = 'relative';
          bubbleContent.style.wordWrap = 'break-word';
          bubbleContent.style.cursor = 'pointer';
          bubbleContent.style.fontWeight = '500';
          
          bubbleContent.addEventListener('click', () => {
            hideWelcomeBubble();
            if (!dialog) {
              dialog = document.getElementById('evoDialog');
            }
            if (dialog) {
              isExpanded = true;
              dialog.style.display = 'flex';
              activeTab = 'chat';
              switchTab('chat');
              
              if (!messagesContainer) {
                messagesContainer = document.getElementById('evoMessages');
              }
              if (messagesContainer) {
                messages = [];
                messagesContainer.innerHTML = '';
                addMessage('evo', greeting);
                saveHistory();
                setTimeout(() => scrollToBottom(), 100);
              }
            }
          });
          
          bubble.appendChild(bubbleContent);
          document.body.appendChild(bubble);
          
          setTimeout(() => {
            const checkBubble = document.getElementById('evoWelcomeBubble');
            if (checkBubble) {
              const rect = checkBubble.getBoundingClientRect();
              const checkComputedStyle = window.getComputedStyle(checkBubble);
              if (rect.width === 0 || rect.height === 0 || checkComputedStyle.display === 'none' || checkComputedStyle.visibility === 'hidden') {
                checkBubble.style.cssText = `
                  position: fixed !important;
                  bottom: 160px !important;
                  right: 100px !important;
                  z-index: 99998 !important;
                  max-width: 280px !important;
                  display: block !important;
                  visibility: visible !important;
                  opacity: 1 !important;
                `;
              }
            }
          }, 100);
          
          setTimeout(() => {
            hideWelcomeBubble();
          }, 3000);
          
        } catch (error) {
          console.error('ÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØÂ§±Ë¥•:', error);
        }
      }
      
      // ÈöêËóèÊ¨¢ËøéÊ∂àÊÅØÊ∞îÊ≥°
      function hideWelcomeBubble() {
        const bubble = document.getElementById('evoWelcomeBubble');
        if (bubble) {
          bubble.classList.add('hiding');
          setTimeout(() => {
            if (bubble.parentNode) {
              bubble.remove();
            }
          }, 300);
        }
      }
      
      return {
        init,
        ensureIconVisible
      };
    })();
    
    // ÂàùÂßãÂåñEvoÂä©ÊâãÔºàÂú®ÁôªÂΩïÂêéÔºâ
    function initEvoAssistant() {
      setTimeout(() => {
        try {
          EvoAssistant.init();
          console.log('‚úÖ Evo Êô∫ËÉΩÂä©ÊâãÂ∑≤ÂàùÂßãÂåñ');
          
          setTimeout(() => {
            EvoAssistant.ensureIconVisible();
          }, 500);
        } catch (error) {
          console.error('‚ö†Ô∏è Êô∫ËÉΩÂä©ÊâãÂàùÂßãÂåñÂ§±Ë¥•:', error);
        }
      }, 500);
    }
    
    // ========================================
    // Êô∫È∏Ω¬∑‰∏≠Êû¢ÁÆ°ÂÆ∂ÂäüËÉΩ
    // ========================================
    
    // Âä†ËΩΩ‰∏≠Êû¢ÁÆ°ÂÆ∂Êï∞ÊçÆÔºà‰ΩøÁî®ÂÖ®Â±Ä CORE_ADMIN_API_BASEÔºâ
    async function loadCoreAdminData() {
      try {
        // Âπ∂Ë°åÂä†ËΩΩÊâÄÊúâÊï∞ÊçÆÔºåÂç≥‰ΩøÈÉ®ÂàÜÂ§±Ë¥•‰πüËÉΩÊòæÁ§∫ÂÖ∂‰ªñÂÜÖÂÆπ
        await Promise.allSettled([
          loadCoreAdminStatus(),
          loadCoreAdminModelInfo(),
          loadCoreAdminAdvice(),
          loadCoreAdminAnalytics(),
          loadCoreAdminApis(),
          loadCoreAdminLearning(),
          loadCoreAdminMaintenance()
        ]);
      } catch (error) {
        console.error('Âä†ËΩΩ‰∏≠Êû¢ÁÆ°ÂÆ∂Êï∞ÊçÆÂ§±Ë¥•:', error);
      }
    }
    
    // Âä†ËΩΩÁ≥ªÁªüÁä∂ÊÄÅ
    async function loadCoreAdminStatus() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/status`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const result = await response.json();
        
        if (result.success && result.data) {
          const status = result.data;
          const healthScore = (status.metrics?.systemHealth || 0) * 100;
          
          document.getElementById('coreAdminHealthScore').textContent = healthScore.toFixed(0) + '%';
          document.getElementById('coreAdminHealthStatus').textContent = 
            status.metrics?.riskLevel === 'low' ? '‚úÖ ËøêË°åÊ≠£Â∏∏' :
            status.metrics?.riskLevel === 'medium' ? '‚ö†Ô∏è ÈúÄË¶ÅÊ≥®ÊÑè' :
            status.metrics?.riskLevel === 'high' ? 'üî¥ È£éÈô©ËæÉÈ´ò' : 'Ê£ÄÊü•‰∏≠...';
        } else {
          throw new Error('Êï∞ÊçÆÊ†ºÂºèÈîôËØØ');
        }
      } catch (error) {
        console.error('Âä†ËΩΩÁ≥ªÁªüÁä∂ÊÄÅÂ§±Ë¥•:', error);
        document.getElementById('coreAdminHealthScore').textContent = '--';
        document.getElementById('coreAdminHealthStatus').textContent = '‚ö†Ô∏è ÊúçÂä°Êú™ËøêË°å';
        document.getElementById('coreAdminHealthStatus').style.color = '#f59e0b';
      }
    }
    
    // Âä†ËΩΩÊ®°ÂûãÊé•ÂÖ•‰ø°ÊÅØ
    async function loadCoreAdminModelInfo() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/model/config`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const result = await response.json();
        
        if (result.success && result.data) {
          const modelInfo = result.data;
          
          // Êõ¥Êñ∞Âü∫Êú¨‰ø°ÊÅØ
          document.getElementById('coreAdminModelProvider').textContent = modelInfo.provider || 'Êú™Áü•';
          document.getElementById('coreAdminModelName').textContent = modelInfo.model || 'Êú™Áü•';
          document.getElementById('coreAdminApiKeyPreview').textContent = modelInfo.apiKeyPreview || '--';
          document.getElementById('coreAdminApiBase').textContent = modelInfo.apiBase || '--';
          document.getElementById('coreAdminMaxCalls').textContent = modelInfo.maxCallsPerHour || '--';
          document.getElementById('coreAdminConfidence').textContent = (modelInfo.confidenceThreshold * 100).toFixed(0) + '%' || '--';
          
          // Êõ¥Êñ∞API KeyÁä∂ÊÄÅ
          const apiKeyStatusEl = document.getElementById('coreAdminApiKeyStatus');
          if (modelInfo.apiKeyStatus === 'configured') {
            apiKeyStatusEl.textContent = '‚úÖ Â∑≤ÈÖçÁΩÆ';
            apiKeyStatusEl.style.background = 'rgba(76, 175, 80, 0.3)';
            apiKeyStatusEl.style.color = '#2e7d32';
          } else {
            apiKeyStatusEl.textContent = '‚ùå Êú™ÈÖçÁΩÆ';
            apiKeyStatusEl.style.background = 'rgba(244, 67, 54, 0.3)';
            apiKeyStatusEl.style.color = '#c62828';
          }
          
          // Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅ
          const connectionStatusEl = document.getElementById('coreAdminConnectionStatus');
          if (modelInfo.connectionStatus === 'connected' && modelInfo.enabled) {
            connectionStatusEl.textContent = '‚úÖ Â∑≤ËøûÊé•';
            connectionStatusEl.style.background = 'rgba(76, 175, 80, 0.3)';
            connectionStatusEl.style.color = '#2e7d32';
          } else {
            connectionStatusEl.textContent = '‚ùå Êú™ËøûÊé•';
            connectionStatusEl.style.background = 'rgba(244, 67, 54, 0.3)';
            connectionStatusEl.style.color = '#c62828';
          }
          
          // Êõ¥Êñ∞Ë∞ÉÁî®ÁªüËÆ°
          if (modelInfo.stats) {
            const stats = modelInfo.stats;
            document.getElementById('coreAdminTotalCalls').textContent = stats.totalCalls || 0;
            document.getElementById('coreAdminRecentCalls').textContent = stats.recentCalls || 0;
            document.getElementById('coreAdminSuccessRate').textContent = (stats.successRate * 100).toFixed(1) + '%';
            document.getElementById('coreAdminAvgConfidence').textContent = (stats.avgConfidence * 100).toFixed(1) + '%';
          }
          
          // Êõ¥Êñ∞AIË∞ÉÁî®Ê¨°Êï∞ÔºàÂú®È°∂ÈÉ®Âç°Áâá‰∏≠Ôºâ
          if (modelInfo.stats) {
            document.getElementById('coreAdminAICalls').textContent = modelInfo.stats.recentCalls || 0;
          }
        } else {
          throw new Error('Êï∞ÊçÆÊ†ºÂºèÈîôËØØ');
        }
      } catch (error) {
        console.error('Âä†ËΩΩÊ®°ÂûãÊé•ÂÖ•‰ø°ÊÅØÂ§±Ë¥•:', error);
        const container = document.getElementById('coreAdminModelInfo');
        container.innerHTML = `
          <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:1px solid #f59e0b;">
            <p style="margin:0 0 12px 0;color:#92400e;font-weight:600;">‚ö†Ô∏è ‰∏≠Êû¢ÁÆ°ÂÆ∂ÊúçÂä°Êú™ËøêË°å</p>
            <p style="margin:0;color:#78350f;font-size:14px;">ËØ∑ÂêØÂä®ÂêéÁ´ØÊúçÂä°Ôºö<code style="background:#fde68a;padding:2px 6px;border-radius:4px;">cd backend/core-admin && npm start</code></p>
          </div>
        `;
      }
    }
    
    // Âä†ËΩΩÁÆ°ÁêÜÂª∫ËÆÆ
    async function loadCoreAdminAdvice() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/advice`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const result = await response.json();
        
        if (result.success && result.data) {
          const advice = result.data.advice || {};
          const container = document.getElementById('coreAdminAdvice');
          
          let html = '';
          if (advice.summary) {
            html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;margin-bottom:12px;">`;
            html += `<div style="font-weight:600;margin-bottom:8px;color:#1f2937;">${advice.summary}</div>`;
            if (advice.actions && advice.actions.length > 0) {
              html += `<ul style="margin:8px 0;padding-left:20px;">`;
              advice.actions.forEach(action => {
                html += `<li style="margin:4px 0;color:#4b5563;">${action}</li>`;
              });
              html += `</ul>`;
            }
            html += `</div>`;
          } else {
            html = '<p class="muted" style="text-align:center;">ÊöÇÊó†Âª∫ËÆÆ</p>';
          }
          
          container.innerHTML = html;
        } else {
          throw new Error('Êï∞ÊçÆÊ†ºÂºèÈîôËØØ');
        }
      } catch (error) {
        console.error('Âä†ËΩΩÁÆ°ÁêÜÂª∫ËÆÆÂ§±Ë¥•:', error);
        const container = document.getElementById('coreAdminAdvice');
        container.innerHTML = `
          <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:1px solid #f59e0b;">
            <p style="margin:0 0 12px 0;color:#92400e;font-weight:600;">‚ö†Ô∏è ‰∏≠Êû¢ÁÆ°ÂÆ∂ÊúçÂä°Êú™ËøêË°å</p>
            <p style="margin:0;color:#78350f;font-size:14px;">ËØ∑ÂêØÂä®ÂêéÁ´ØÊúçÂä°Ôºö<code style="background:#fde68a;padding:2px 6px;border-radius:4px;">cd backend/core-admin && npm start</code></p>
          </div>
        `;
      }
    }
    
    // Âä†ËΩΩÊï∞ÊçÆÂàÜÊûê
    async function loadCoreAdminAnalytics() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/analytics/report`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const report = result.data;
          const container = document.getElementById('coreAdminAnalytics');
          
          let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:20px;">';
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÊÄªÁÇπÂáªÈáè</div>`;
          html += `<div style="font-size:24px;font-weight:600;color:#1f2937;">${report.clicks?.total || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Êï∞ÊçÆ‰∏ä‰º†</div>`;
          html += `<div style="font-size:24px;font-weight:600;color:#1f2937;">${report.uploads?.total || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Áî®Êà∑Ë°å‰∏∫</div>`;
          html += `<div style="font-size:24px;font-weight:600;color:#1f2937;">${report.userBehaviors?.total || 0}</div>`;
          html += `</div>`;
          
          html += `</div>`;
          
          if (report.apiUsage?.topEndpoints && report.apiUsage.topEndpoints.length > 0) {
            html += `<div style="margin-top:20px;"><h4 style="margin-bottom:12px;">ÁÉ≠Èó®API</h4>`;
            html += `<table style="width:100%;border-collapse:collapse;">`;
            html += `<thead><tr style="background:#f9fafb;"><th style="padding:8px;text-align:left;">Á´ØÁÇπ</th><th style="padding:8px;text-align:center;">Ë∞ÉÁî®Ê¨°Êï∞</th><th style="padding:8px;text-align:center;">ÊàêÂäüÁéá</th></tr></thead><tbody>`;
            report.apiUsage.topEndpoints.slice(0, 5).forEach(api => {
              html += `<tr><td style="padding:8px;">${api.endpoint}</td>`;
              html += `<td style="padding:8px;text-align:center;">${api.calls}</td>`;
              html += `<td style="padding:8px;text-align:center;">${(api.successRate * 100).toFixed(1)}%</td></tr>`;
            });
            html += `</tbody></table></div>`;
          }
          
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('Âä†ËΩΩÊï∞ÊçÆÂàÜÊûêÂ§±Ë¥•:', error);
        const container = document.getElementById('coreAdminAnalytics');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">Êï∞ÊçÆÂàÜÊûêÊúçÂä°ÊöÇ‰∏çÂèØÁî®</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">ËØ∑Á°Æ‰øùÂêéÁ´ØÊúçÂä°Ê≠£Âú®ËøêË°å</p>
          </div>
        `;
      }
    }
    
    // Âä†ËΩΩAPIÂàóË°®
    async function loadCoreAdminApis() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/apis`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const apis = result.data;
          const container = document.getElementById('coreAdminApiList');
          
          if (apis.length === 0) {
            container.innerHTML = '<p class="muted" style="text-align:center;">ÊöÇÊó†API</p>';
            return;
          }
          
          let html = '<table style="width:100%;border-collapse:collapse;">';
          html += '<thead><tr style="background:#f9fafb;">';
          html += '<th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">APIÂêçÁß∞</th>';
          html += '<th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Áä∂ÊÄÅ</th>';
          html += '<th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂìçÂ∫îÊó∂Èó¥</th>';
          html += '<th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Êï∞ÊçÆÁúüÂÆûÊÄß</th>';
          html += '</tr></thead><tbody>';
          
          apis.forEach(api => {
            const statusColor = api.health.status === 'healthy' ? '#10b981' : '#ef4444';
            const statusText = api.health.status === 'healthy' ? '‚úÖ Ê≠£Â∏∏' : '‚ùå ÂºÇÂ∏∏';
            const truthStatus = api.health.truthStatus || 'unknown';
            const truthColor = truthStatus === 'verified' ? '#10b981' : truthStatus === 'suspect' ? '#f59e0b' : '#ef4444';
            const truthText = truthStatus === 'verified' ? '‚úÖ Â∑≤È™åËØÅ' : truthStatus === 'suspect' ? '‚ö†Ô∏è ÂèØÁñë' : '‚ùå Êó†Êïà';
            
            html += `<tr style="border-bottom:1px solid #f0f0f0;">`;
            html += `<td style="padding:12px;"><strong>${api.name}</strong><br><span style="color:#6b7280;font-size:12px;">${api.url}</span></td>`;
            html += `<td style="padding:12px;text-align:center;"><span style="color:${statusColor};font-weight:600;">${statusText}</span></td>`;
            html += `<td style="padding:12px;text-align:center;">${api.stats.avgResponseTime.toFixed(0)}ms</td>`;
            html += `<td style="padding:12px;text-align:center;"><span style="color:${truthColor};font-weight:600;">${truthText}</span></td>`;
            html += `</tr>`;
          });
          
          html += '</tbody></table>';
          container.innerHTML = html;
          
          // Êõ¥Êñ∞APIÂÅ•Â∫∑Áéá
          const healthyCount = apis.filter(a => a.health.status === 'healthy').length;
          const healthRate = apis.length > 0 ? (healthyCount / apis.length * 100) : 0;
          document.getElementById('coreAdminApiHealth').textContent = healthRate.toFixed(0) + '%';
        }
      } catch (error) {
        console.error('Âä†ËΩΩAPIÂàóË°®Â§±Ë¥•:', error);
        const container = document.getElementById('coreAdminApiList');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">APIÁõëÁÆ°ÊúçÂä°ÊöÇ‰∏çÂèØÁî®</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">ËØ∑Á°Æ‰øùÂêéÁ´ØÊúçÂä°Ê≠£Âú®ËøêË°å</p>
          </div>
        `;
      }
    }
    
    // Âä†ËΩΩÂ≠¶‰π†Á≥ªÁªü
    async function loadCoreAdminLearning() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/learning/stats`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const stats = result.data;
          const container = document.getElementById('coreAdminLearning');
          
          let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">';
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÊÄª‰∫ã‰ª∂Êï∞</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalEvents || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Á≠ñÁï•Êï∞</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalStrategies || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÂÜ≥Á≠ñÊï∞</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalDecisions || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Âπ≥ÂùáÊúâÊïàÊÄß</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${((stats.avgEffectiveness || 0) * 100).toFixed(1)}%</div>`;
          html += `</div>`;
          
          html += `</div>`;
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('Âä†ËΩΩÂ≠¶‰π†Á≥ªÁªüÂ§±Ë¥•:', error);
        const container = document.getElementById('coreAdminLearning');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">Â≠¶‰π†Á≥ªÁªüÊúçÂä°ÊöÇ‰∏çÂèØÁî®</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">ËØ∑Á°Æ‰øùÂêéÁ´ØÊúçÂä°Ê≠£Âú®ËøêË°å</p>
          </div>
        `;
      }
    }
    
    // Âä†ËΩΩËá™Âä®Áª¥Êä§
    async function loadCoreAdminMaintenance() {
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/maintenance/stats`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const stats = result.data;
          const container = document.getElementById('coreAdminMaintenance');
          
          let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">';
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÊÄªBugÊï∞</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalBugs || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Â∑≤‰øÆÂ§ç</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.fixedBugs || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÊÄª‰øÆÂ§çÊï∞</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalFixes || 0}</div>`;
          html += `</div>`;
          
          html += `<div style="padding:16px;background:#f9fafb;border-radius:8px;">`;
          html += `<div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Á≥ªÁªüÂçáÁ∫ß</div>`;
          html += `<div style="font-size:20px;font-weight:600;color:#1f2937;">${stats.totalUpgrades || 0}</div>`;
          html += `</div>`;
          
          html += `</div>`;
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('Âä†ËΩΩËá™Âä®Áª¥Êä§Â§±Ë¥•:', error);
        const container = document.getElementById('coreAdminMaintenance');
        container.innerHTML = `
          <div style="padding:16px;text-align:center;background:#f3f4f6;border-radius:8px;">
            <p style="margin:0;color:#6b7280;">Ëá™Âä®Áª¥Êä§ÊúçÂä°ÊöÇ‰∏çÂèØÁî®</p>
            <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;">ËØ∑Á°Æ‰øùÂêéÁ´ØÊúçÂä°Ê≠£Âú®ËøêË°å</p>
          </div>
        `;
      }
    }
    
    // ÁªëÂÆöÂà∑Êñ∞ÊåâÈíÆ
    // ==========================================
    // Á≥ªÁªüËÆæÁΩÆÂäüËÉΩ
    // ==========================================
    
    let currentRssSourceEditId = null;
    
    // Âä†ËΩΩÁ≥ªÁªüËÆæÁΩÆ
    async function loadSystemSettings() {
      try {
        const token = localStorage.getItem('adminToken');
        if (!token) {
          showSettingsStatus('ËØ∑ÂÖàÁôªÂΩï', 'error');
          return;
        }
        
        const response = await fetch(`${getApiUrl()}/api/admin/system-settings`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const settings = result.data;
          
          // Â°´ÂÖÖÂü∫Á°ÄËÆæÁΩÆ
          document.getElementById('serverPort').value = settings.server?.port || '';
          document.getElementById('serverEnv').value = settings.server?.env || 'production';
          document.getElementById('apiRateLimit').value = settings.api?.rateLimit || '';
          document.getElementById('logLevel').value = settings.logging?.level || 'info';
          
          // Â°´ÂÖÖÁºìÂ≠òËÆæÁΩÆ
          document.getElementById('cacheTtlNews').value = settings.cache?.ttl?.news || '';
          document.getElementById('cacheTtlEvents').value = settings.cache?.ttl?.events || '';
          document.getElementById('cacheTtlResults').value = settings.cache?.ttl?.results || '';
          document.getElementById('updateIntervalNews').value = settings.updateInterval?.news || '';
          document.getElementById('updateIntervalEvents').value = settings.updateInterval?.events || '';
          document.getElementById('updateIntervalResults').value = settings.updateInterval?.results || '';
          
          // Â°´ÂÖÖAIËÆæÁΩÆ
          document.getElementById('zhipuApiKeyEvo').value = settings.ai?.zhipuApiKeyEvo || '';
          document.getElementById('zhipuApiKeyAdmin').value = settings.ai?.zhipuApiKeyAdmin || '';
          document.getElementById('qwenApiKey').value = settings.ai?.qwenApiKey || '';
          document.getElementById('huggingFaceApiKey').value = settings.ai?.huggingFaceApiKey || '';
          document.getElementById('aiModel').value = settings.ai?.model || 'auto';
          
          // Â°´ÂÖÖÊï∞ÊçÆÂ∫ìËÆæÁΩÆ
          document.getElementById('supabaseUrl').value = settings.supabase?.url || '';
          document.getElementById('supabaseAnonKey').value = settings.supabase?.anonKey || '';
          
          // Âä†ËΩΩRSSÊ∫êÂàóË°®
          loadRssSources();
        }
      } catch (error) {
        console.error('Âä†ËΩΩÁ≥ªÁªüËÆæÁΩÆÂ§±Ë¥•:', error);
        showSettingsStatus('Âä†ËΩΩÁ≥ªÁªüËÆæÁΩÆÂ§±Ë¥•: ' + error.message, 'error');
      }
    }
    
    // Âä†ËΩΩRSSÊ∫êÂàóË°®
    async function loadRssSources() {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const sources = result.data;
          const container = document.getElementById('rssSourcesList');
          
          if (sources.length === 0) {
            container.innerHTML = '<p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†RSSÊ∫êÔºåÁÇπÂáª"Ê∑ªÂä†RSSÊ∫ê"ÊåâÈíÆÊ∑ªÂä†</p>';
            return;
          }
          
          let html = '';
          sources.forEach(source => {
            const statusColor = source.active !== false ? '#10b981' : '#ef4444';
            const statusText = source.active !== false ? 'ÂêØÁî®' : 'Á¶ÅÁî®';
            
            html += `
              <div style="padding:16px;background:var(--bg-secondary);border:1px solid var(--border-light);border-radius:var(--radius-md);">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
                  <div style="flex:1;">
                    <div style="font-weight:600;color:var(--text-primary);margin-bottom:4px;">${source.name}</div>
                    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">${source.url}</div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                      <span style="padding:4px 8px;background:var(--primary-50);color:var(--primary);border-radius:4px;font-size:12px;">${source.type === 'media' ? 'Â™í‰Ωì' : 'Âçè‰ºö'}</span>
                      <span style="padding:4px 8px;background:var(--gray-100);color:var(--gray-700);border-radius:4px;font-size:12px;">${source.region === 'local' ? 'Êú¨Âú∞' : 'ÂÖ®ÂõΩ'}</span>
                      <span style="padding:4px 8px;background:${statusColor}20;color:${statusColor};border-radius:4px;font-size:12px;">${statusText}</span>
                    </div>
                  </div>
                  <div style="display:flex;gap:8px;">
                    <button class="btn btn-sm btn-outline" onclick="editRssSource('${source.id}')">ÁºñËæë</button>
                    <button class="btn btn-sm btn-outline" onclick="toggleRssSource('${source.id}', ${source.active !== false})">${source.active !== false ? 'Á¶ÅÁî®' : 'ÂêØÁî®'}</button>
                    <button class="btn btn-sm btn-outline" style="color:var(--danger);" onclick="deleteRssSource('${source.id}')">Âà†Èô§</button>
                  </div>
                </div>
              </div>
            `;
          });
          
          container.innerHTML = html;
        }
      } catch (error) {
        console.error('Âä†ËΩΩRSSÊ∫êÂàóË°®Â§±Ë¥•:', error);
      }
    }
    
    // Á≥ªÁªüËÆæÁΩÆÊ†áÁ≠æÈ°µÂàáÊç¢
    document.querySelectorAll('.settings-tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        
        // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
        document.querySelectorAll('.settings-tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // ÊòæÁ§∫ÂØπÂ∫îÈù¢Êùø
        document.querySelectorAll('.settings-panel').forEach(p => p.style.display = 'none');
        document.getElementById(`settings${tab.charAt(0).toUpperCase() + tab.slice(1)}`).style.display = 'block';
      });
    });
    
    // ‰øùÂ≠òÂü∫Á°ÄËÆæÁΩÆ
    document.getElementById('btnSaveGeneralSettings')?.addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('adminToken');
        const settings = {
          custom: {
            server: {
              port: parseInt(document.getElementById('serverPort').value) || 3000,
              env: document.getElementById('serverEnv').value
            },
            api: {
              rateLimit: parseInt(document.getElementById('apiRateLimit').value) || 100
            },
            logging: {
              level: document.getElementById('logLevel').value
            }
          }
        };
        
        const response = await fetch(`${getApiUrl()}/api/admin/system-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ settings })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('Âü∫Á°ÄËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºàÈÉ®ÂàÜÈÖçÁΩÆÈúÄË¶Å‰øÆÊîπÁéØÂ¢ÉÂèòÈáèÂêéÈáçÂêØÊúçÂä°ÊâçËÉΩÁîüÊïàÔºâ', 'success');
        } else {
          showSettingsStatus('‰øùÂ≠òÂ§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
      } catch (error) {
        showSettingsStatus('‰øùÂ≠òÂ§±Ë¥•: ' + error.message, 'error');
      }
    });
    
    // ‰øùÂ≠òÁºìÂ≠òËÆæÁΩÆ
    document.getElementById('btnSaveCacheSettings')?.addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('adminToken');
        const settings = {
          custom: {
            cache: {
              ttl: {
                news: parseInt(document.getElementById('cacheTtlNews').value) || 3600,
                events: parseInt(document.getElementById('cacheTtlEvents').value) || 300,
                results: parseInt(document.getElementById('cacheTtlResults').value) || 7200
              }
            },
            updateInterval: {
              news: parseInt(document.getElementById('updateIntervalNews').value) || 3600,
              events: parseInt(document.getElementById('updateIntervalEvents').value) || 300,
              results: parseInt(document.getElementById('updateIntervalResults').value) || 1800
            }
          }
        };
        
        const response = await fetch(`${getApiUrl()}/api/admin/system-settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ settings })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('ÁºìÂ≠òÈÖçÁΩÆÂ∑≤‰øùÂ≠òÔºàÈúÄË¶Å‰øÆÊîπÁéØÂ¢ÉÂèòÈáèÂêéÈáçÂêØÊúçÂä°ÊâçËÉΩÁîüÊïàÔºâ', 'success');
        } else {
          showSettingsStatus('‰øùÂ≠òÂ§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
      } catch (error) {
        showSettingsStatus('‰øùÂ≠òÂ§±Ë¥•: ' + error.message, 'error');
      }
    });
    
    // Ê∑ªÂä†RSSÊ∫ê
    document.getElementById('btnAddRssSource')?.addEventListener('click', () => {
      currentRssSourceEditId = null;
      document.getElementById('rssSourceForm').style.display = 'block';
      document.getElementById('rssSourceName').value = '';
      document.getElementById('rssSourceUrl').value = '';
      document.getElementById('rssSourceType').value = 'media';
      document.getElementById('rssSourceRegion').value = 'local';
    });
    
    // ‰øùÂ≠òRSSÊ∫ê
    document.getElementById('btnSaveRssSource')?.addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('adminToken');
        const name = document.getElementById('rssSourceName').value.trim();
        const url = document.getElementById('rssSourceUrl').value.trim();
        const type = document.getElementById('rssSourceType').value;
        const region = document.getElementById('rssSourceRegion').value;
        
        if (!name || !url) {
          showSettingsStatus('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑRSSÊ∫ê‰ø°ÊÅØ', 'error');
          return;
        }
        
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ name, url, type, region })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('RSSÊ∫êÂ∑≤Ê∑ªÂä†', 'success');
          document.getElementById('rssSourceForm').style.display = 'none';
          loadRssSources();
        } else {
          showSettingsStatus('Ê∑ªÂä†Â§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
      } catch (error) {
        showSettingsStatus('Ê∑ªÂä†Â§±Ë¥•: ' + error.message, 'error');
      }
    });
    
    // ÂèñÊ∂àRSSÊ∫êÁºñËæë
    document.getElementById('btnCancelRssSource')?.addEventListener('click', () => {
      document.getElementById('rssSourceForm').style.display = 'none';
      currentRssSourceEditId = null;
    });
    
    // ÊµãËØïRSSÊ∫ê
    document.getElementById('btnTestRssSource')?.addEventListener('click', async () => {
      const url = document.getElementById('rssSourceUrl').value.trim();
      if (!url) {
        showSettingsStatus('ËØ∑ÂÖàËæìÂÖ•RSS URL', 'error');
        return;
      }
      
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources/test`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ url })
        });
        
        const result = await response.json();
        const resultDiv = document.getElementById('rssSourceTestResult');
        
        if (result.success && result.data?.valid) {
          resultDiv.innerHTML = `<div style="padding:12px;background:#d1fae5;color:#047857;border-radius:6px;">‚úÖ ËøûÊé•ÊàêÂäüÔºÅÊâæÂà∞ ${result.data.itemCount} Êù°ÂÜÖÂÆπ</div>`;
        } else {
          resultDiv.innerHTML = `<div style="padding:12px;background:#fee2e2;color:#991b1b;border-radius:6px;">‚ùå ËøûÊé•Â§±Ë¥•: ${result.error || 'Êú™Áü•ÈîôËØØ'}</div>`;
        }
      } catch (error) {
        document.getElementById('rssSourceTestResult').innerHTML = `<div style="padding:12px;background:#fee2e2;color:#991b1b;border-radius:6px;">‚ùå ÊµãËØïÂ§±Ë¥•: ${error.message}</div>`;
      }
    });
    
    // ÁºñËæëRSSÊ∫ê
    window.editRssSource = async (id) => {
      // TODO: ÂÆûÁé∞ÁºñËæëÂäüËÉΩ
      alert('ÁºñËæëÂäüËÉΩÂºÄÂèë‰∏≠...');
    };
    
    // ÂàáÊç¢RSSÊ∫êÁä∂ÊÄÅ
    window.toggleRssSource = async (id, currentStatus) => {
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources/${id}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ active: !currentStatus })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('RSSÊ∫êÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞', 'success');
          loadRssSources();
        } else {
          showSettingsStatus('Êõ¥Êñ∞Â§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
      } catch (error) {
        showSettingsStatus('Êõ¥Êñ∞Â§±Ë¥•: ' + error.message, 'error');
      }
    };
    
    // Âà†Èô§RSSÊ∫ê
    window.deleteRssSource = async (id) => {
      if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™RSSÊ∫êÂêóÔºü')) return;
      
      try {
        const token = localStorage.getItem('adminToken');
        const response = await fetch(`${getApiUrl()}/api/admin/rss-sources/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSettingsStatus('RSSÊ∫êÂ∑≤Âà†Èô§', 'success');
          loadRssSources();
        } else {
          showSettingsStatus('Âà†Èô§Â§±Ë¥•: ' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
      } catch (error) {
        showSettingsStatus('Âà†Èô§Â§±Ë¥•: ' + error.message, 'error');
      }
    };
    
    // ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
    function showSettingsStatus(message, type) {
      const statusDiv = document.getElementById('settingsStatus');
      statusDiv.style.display = 'block';
      statusDiv.style.padding = '12px';
      statusDiv.style.borderRadius = 'var(--radius-md)';
      
      if (type === 'success') {
        statusDiv.style.background = '#d1fae5';
        statusDiv.style.color = '#047857';
      } else {
        statusDiv.style.background = '#fee2e2';
        statusDiv.style.color = '#991b1b';
      }
      
      statusDiv.textContent = message;
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      const btnRefreshModelInfo = document.getElementById('btnRefreshModelInfo');
      const btnRefreshAdvice = document.getElementById('btnRefreshAdvice');
      const btnRefreshAnalytics = document.getElementById('btnRefreshAnalytics');
      const btnRefreshApis = document.getElementById('btnRefreshApis');
      const btnRefreshLearning = document.getElementById('btnRefreshLearning');
      const btnRefreshMaintenance = document.getElementById('btnRefreshMaintenance');
      
      if (btnRefreshModelInfo) {
        btnRefreshModelInfo.addEventListener('click', () => {
          loadCoreAdminModelInfo();
        });
      }
      
      if (btnRefreshAdvice) {
        btnRefreshAdvice.addEventListener('click', () => {
          loadCoreAdminAdvice();
        });
      }
      
      if (btnRefreshAnalytics) {
        btnRefreshAnalytics.addEventListener('click', () => {
          loadCoreAdminAnalytics();
        });
      }
      
      if (btnRefreshApis) {
        btnRefreshApis.addEventListener('click', () => {
          loadCoreAdminApis();
        });
      }
      
      if (btnRefreshLearning) {
        btnRefreshLearning.addEventListener('click', () => {
          loadCoreAdminLearning();
        });
      }
      
      if (btnRefreshMaintenance) {
        btnRefreshMaintenance.addEventListener('click', () => {
          loadCoreAdminMaintenance();
        });
      }
    });
    
    // Á≥ªÁªüÂçáÁ∫ßÂäüËÉΩ
    async function loadUpgradeData() {
      const CORE_ADMIN_API_BASE = 'http://localhost:3001/api';
      
      try {
        // Âä†ËΩΩÂçáÁ∫ßÊ¶ÇËßà
        const overviewResponse = await fetch(`${CORE_ADMIN_API_BASE}/upgrade/overview`);
        if (overviewResponse.ok) {
          const overviewResult = await overviewResponse.json();
          if (overviewResult.success && overviewResult.data) {
            const overview = overviewResult.data;
            document.getElementById('upgradeVersion').textContent = `v${overview.version}`;
            document.getElementById('upgradePartsCount').textContent = overview.completedCount || '--';
            document.getElementById('upgradeNewFiles').textContent = overview.statistics?.newFiles || '--';
            document.getElementById('upgradeNewCode').textContent = (overview.statistics?.newCodeLines / 1000).toFixed(1) + 'K';
            document.getElementById('upgradeAutomation').textContent = overview.capabilities?.automation || '--';
          }
        }

        // Âä†ËΩΩÂçáÁ∫ßÈÉ®ÂàÜ
        const partsResponse = await fetch(`${CORE_ADMIN_API_BASE}/upgrade/parts`);
        if (partsResponse.ok) {
          const partsResult = await partsResponse.json();
          if (partsResult.success && partsResult.data) {
            renderUpgradeParts(partsResult.data);
          }
        }

        // Âä†ËΩΩËÉΩÂäõÊèêÂçá
        const capabilitiesResponse = await fetch(`${CORE_ADMIN_API_BASE}/upgrade/capabilities`);
        if (capabilitiesResponse.ok) {
          const capabilitiesResult = await capabilitiesResponse.json();
          if (capabilitiesResult.success && capabilitiesResult.data) {
            renderCapabilities(capabilitiesResult.data);
          }
        }
      } catch (error) {
        console.error('Âä†ËΩΩÂçáÁ∫ßÊï∞ÊçÆÂ§±Ë¥•:', error);
        document.getElementById('upgradePartsList').innerHTML = `
          <div style="padding:20px;text-align:center;background:#fef3c7;border-radius:8px;border:1px solid #f59e0b;">
            <p style="margin:0 0 12px 0;color:#92400e;font-weight:600;">‚ö†Ô∏è Êó†Ê≥ïËøûÊé•Âà∞ÂçáÁ∫ßÊúçÂä°</p>
            <p style="margin:0;color:#78350f;font-size:14px;">ËØ∑Á°Æ‰øù‰∏≠Êû¢ÁÆ°ÂÆ∂ÊúçÂä°Ê≠£Âú®ËøêË°å</p>
          </div>
        `;
      }
    }

    // Ê∏≤ÊüìÂçáÁ∫ßÈÉ®ÂàÜ
    function renderUpgradeParts(parts) {
      const container = document.getElementById('upgradePartsList');
      
      if (!parts || parts.length === 0) {
        container.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ÊöÇÊó†ÂçáÁ∫ßËÆ∞ÂΩï</p>';
        return;
      }

      const html = parts.map(part => `
        <div style="background:#f8fafc;border-radius:12px;padding:24px;margin-bottom:16px;border:2px solid #e2e8f0;transition:all 0.3s ease;" 
             onmouseover="this.style.borderColor='#3b82f6';this.style.boxShadow='0 4px 12px rgba(59,130,246,0.15)'" 
             onmouseout="this.style.borderColor='#e2e8f0';this.style.boxShadow='none'">
          <div style="display:flex;align-items:start;gap:16px;">
            <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;">
              ${part.id === 'frontend' ? 'üé®' : part.id === 'security' ? 'üîí' : part.id === 'database' ? 'üóÑÔ∏è' : 'ü§ñ'}
            </div>
            <div style="flex:1;">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                <h4 style="margin:0;font-size:18px;font-weight:700;color:#1e293b;">${part.name}</h4>
                <span style="background:#10b981;color:#fff;padding:4px 12px;border-radius:6px;font-size:12px;font-weight:600;">‚úÖ ${part.status === 'completed' ? 'Â∑≤ÂÆåÊàê' : 'ËøõË°å‰∏≠'}</span>
              </div>
              <p style="margin:0 0 16px 0;color:#64748b;font-size:14px;line-height:1.6;">${part.description}</p>
              
              ${part.files && part.files.length > 0 ? `
                <div style="margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;">Áõ∏ÂÖ≥Êñá‰ª∂Ôºö</div>
                  <div style="display:flex;flex-wrap:wrap;gap:8px;">
                    ${part.files.map(file => `
                      <span style="background:#e2e8f0;color:#475569;padding:4px 10px;border-radius:6px;font-size:12px;font-family:monospace;">${file}</span>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              ${part.modules && part.modules.length > 0 ? `
                <div style="margin-bottom:12px;">
                  <div style="font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;">Êñ∞Â¢ûÊ®°ÂùóÔºö</div>
                  <div style="display:flex;flex-wrap:wrap;gap:8px;">
                    ${part.modules.map(module => `
                      <div style="background:#dbeafe;color:#1e40af;padding:6px 12px;border-radius:6px;font-size:12px;display:flex;align-items:center;gap:6px;">
                        <span>üì¶</span>
                        <span>${module.name}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              ${part.benefits && part.benefits.length > 0 ? `
                <div>
                  <div style="font-size:13px;font-weight:600;color:#475569;margin-bottom:8px;">Êî∂ÁõäÔºö</div>
                  <ul style="margin:0;padding-left:20px;color:#64748b;font-size:13px;">
                    ${part.benefits.map(benefit => `<li style="margin-bottom:4px;">${benefit}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    // Ê∏≤ÊüìËÉΩÂäõÊèêÂçá
    function renderCapabilities(capabilities) {
      const container = document.getElementById('upgradeCapabilities');
      
      const html = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">
          <div style="background:linear-gradient(135deg, #e6f0ff 0%, #dbeafe 100%);border-radius:12px;padding:20px;border:2px solid rgba(59,130,246,0.2);">
            <div style="font-size:14px;font-weight:600;color:#1e40af;margin-bottom:8px;">Ëá™Âä®ÂåñÁéá</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.automation || '--'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);border-radius:12px;padding:20px;border:2px solid rgba(16,185,129,0.2);">
            <div style="font-size:14px;font-weight:600;color:#065f46;margin-bottom:8px;">Êô∫ËÉΩÂåñÁéá</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.intelligence || '--'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border-radius:12px;padding:20px;border:2px solid rgba(245,158,11,0.2);">
            <div style="font-size:14px;font-weight:600;color:#92400e;margin-bottom:8px;">È¢ÑÊµãÂáÜÁ°ÆÁéá</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.prediction || '--'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);border-radius:12px;padding:20px;border:2px solid rgba(236,72,153,0.2);">
            <div style="font-size:14px;font-weight:600;color:#9f1239;margin-bottom:8px;">APIÂÆâÂÖ®ÊÄß</div>
            <div style="font-size:32px;font-weight:700;color:#1e293b;">${capabilities.security || '--'}</div>
          </div>
        </div>
      `;

      container.innerHTML = html;
    }

    // Êô∫ËÉΩÂäüËÉΩÊ®°ÂùóÂä†ËΩΩÂáΩÊï∞
    const CORE_ADMIN_API_BASE = 'http://localhost:3001/api';

    // Âä†ËΩΩÊô∫ËÉΩÂÜ≥Á≠ñÂª∫ËÆÆ
    async function loadIntelligentAdvice() {
      const preview = document.getElementById('intelligentAdvicePreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/advice`);
        const result = await response.json();
        if (result.success && result.data) {
          const advice = result.data;
          preview.innerHTML = `<strong>${advice.title || 'Êô∫ËÉΩÂª∫ËÆÆ'}</strong><br>${advice.description || advice.reason || 'ÊöÇÊó†Âª∫ËÆÆ'}`;
          // ÂèØ‰ª•ÊâìÂºÄËØ¶ÁªÜÊ®°ÊÄÅÊ°ÜÊòæÁ§∫ÂÆåÊï¥‰ø°ÊÅØ
          showIntelligentModal('ÂÜ≥Á≠ñÂºïÊìé', advice);
        } else {
          preview.innerHTML = 'ÊöÇÊó†Âª∫ËÆÆ';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩÊô∫ËÉΩÂª∫ËÆÆÂ§±Ë¥•:', error);
      }
    }

    // Âä†ËΩΩÈ¢ÑÊµãÁª¥Êä§‰ø°ÊÅØ
    async function loadIntelligentPredictions() {
      const preview = document.getElementById('intelligentPredictionsPreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/predictions`);
        const result = await response.json();
        if (result.success && result.data) {
          const predictions = result.data;
          const count = predictions.predictions?.length || 0;
          preview.innerHTML = `ÂèëÁé∞ <strong>${count}</strong> ‰∏™ÊΩúÂú®ÈóÆÈ¢ò<br>${predictions.summary || 'ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ'}`;
          showIntelligentModal('È¢ÑÊµãÁª¥Êä§', predictions);
        } else {
          preview.innerHTML = 'ÊöÇÊó†È¢ÑÊµã‰ø°ÊÅØ';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩÈ¢ÑÊµã‰ø°ÊÅØÂ§±Ë¥•:', error);
      }
    }

    // Âä†ËΩΩÂ∑•‰ΩúÊµÅÂàóË°®
    async function loadIntelligentWorkflows() {
      const preview = document.getElementById('intelligentWorkflowsPreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/workflows`);
        const result = await response.json();
        if (result.success && result.data) {
          const workflows = result.data;
          const count = workflows.workflows?.length || 0;
          preview.innerHTML = `ÂÖ±Êúâ <strong>${count}</strong> ‰∏™Â∑•‰ΩúÊµÅ<br>${workflows.summary || 'ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ'}`;
          showIntelligentModal('Â∑•‰ΩúÊµÅÂºïÊìé', workflows);
        } else {
          preview.innerHTML = 'ÊöÇÊó†Â∑•‰ΩúÊµÅ';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩÂ∑•‰ΩúÊµÅÂ§±Ë¥•:', error);
      }
    }

    // Âä†ËΩΩÂëäË≠¶ÂàóË°®
    async function loadIntelligentAlerts() {
      const preview = document.getElementById('intelligentAlertsPreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/alerts`);
        const result = await response.json();
        if (result.success && result.data) {
          const alerts = result.data;
          const activeCount = alerts.alerts?.filter(a => a.status === 'active').length || 0;
          preview.innerHTML = `Ê¥ªË∑ÉÂëäË≠¶: <strong style="color:#ef4444;">${activeCount}</strong><br>${alerts.summary || 'ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ'}`;
          showIntelligentModal('ÂëäË≠¶Á≥ªÁªü', alerts);
        } else {
          preview.innerHTML = 'ÊöÇÊó†ÂëäË≠¶';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩÂëäË≠¶Â§±Ë¥•:', error);
      }
    }

    // Âä†ËΩΩËá™ÈÄÇÂ∫î‰ºòÂåñÁä∂ÊÄÅ
    async function loadIntelligentOptimization() {
      const preview = document.getElementById('intelligentOptimizationPreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/optimization`);
        const result = await response.json();
        if (result.success && result.data) {
          const optimization = result.data;
          preview.innerHTML = `‰ºòÂåñÁä∂ÊÄÅ: <strong>${optimization.status || 'ËøêË°å‰∏≠'}</strong><br>${optimization.summary || 'ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ'}`;
          showIntelligentModal('Ëá™ÈÄÇÂ∫î‰ºòÂåñ', optimization);
        } else {
          preview.innerHTML = 'ÊöÇÊó†‰ºòÂåñ‰ø°ÊÅØ';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩ‰ºòÂåñ‰ø°ÊÅØÂ§±Ë¥•:', error);
      }
    }

    // Âä†ËΩΩÁü•ËØÜÂõæË∞±
    async function loadIntelligentKnowledge() {
      const preview = document.getElementById('intelligentKnowledgePreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/knowledge`);
        const result = await response.json();
        if (result.success && result.data) {
          const knowledge = result.data;
          preview.innerHTML = `ÂÆû‰ΩìÊï∞Èáè: <strong>${knowledge.entities?.length || 0}</strong><br>${knowledge.summary || 'ÁÇπÂáªÊü•ËØ¢Áü•ËØÜÂõæË∞±'}`;
          showIntelligentModal('Áü•ËØÜÂõæË∞±', knowledge);
        } else {
          preview.innerHTML = 'ÊöÇÊó†Áü•ËØÜÊï∞ÊçÆ';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩÁü•ËØÜÂõæË∞±Â§±Ë¥•:', error);
      }
    }

    // Âä†ËΩΩÊô∫ËÉΩÊä•Âëä
    async function loadIntelligentReports() {
      const preview = document.getElementById('intelligentReportsPreview');
      preview.innerHTML = 'Âä†ËΩΩ‰∏≠...';
      try {
        const response = await fetch(`${CORE_ADMIN_API_BASE}/intelligent/reports`);
        const result = await response.json();
        if (result.success && result.data) {
          const reports = result.data;
          const count = reports.reports?.length || 0;
          preview.innerHTML = `ÂÖ±Êúâ <strong>${count}</strong> ‰∏™Êä•Âëä<br>${reports.summary || 'ÁÇπÂáªÊü•ÁúãÊä•Âëä'}`;
          showIntelligentModal('Êô∫ËÉΩÊä•Âëä', reports);
        } else {
          preview.innerHTML = 'ÊöÇÊó†Êä•Âëä';
        }
      } catch (error) {
        preview.innerHTML = 'Âä†ËΩΩÂ§±Ë¥•';
        console.error('Âä†ËΩΩÊä•ÂëäÂ§±Ë¥•:', error);
      }
    }

    // ÊòæÁ§∫Êô∫ËÉΩÂäüËÉΩËØ¶ÁªÜ‰ø°ÊÅØÁöÑÊ®°ÊÄÅÊ°Ü
    function showIntelligentModal(title, data) {
      // ÂàõÂª∫ÊàñËé∑ÂèñÊ®°ÊÄÅÊ°Ü
      let modal = document.getElementById('intelligentModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'intelligentModal';
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-content" style="max-width:800px;">
            <div class="modal-header">
              <h3 id="intelligentModalTitle">${title}</h3>
              <button class="btn btn-ghost btn-sm" onclick="closeIntelligentModal()">‚úï</button>
            </div>
            <div class="modal-body" id="intelligentModalBody" style="max-height:70vh;overflow-y:auto;">
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" onclick="closeIntelligentModal()">ÂÖ≥Èó≠</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      document.getElementById('intelligentModalTitle').textContent = title;
      const body = document.getElementById('intelligentModalBody');
      
      // Ê†ºÂºèÂåñÊòæÁ§∫Êï∞ÊçÆ
      body.innerHTML = `<pre style="white-space:pre-wrap;word-wrap:break-word;font-family:inherit;font-size:14px;line-height:1.6;">${JSON.stringify(data, null, 2)}</pre>`;
      
      modal.style.display = 'flex';
    }

    function closeIntelligentModal() {
      const modal = document.getElementById('intelligentModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    // ÂàùÂßãÂåñ
    // ÂÆâÂÖ®ÁâàÊú¨ÁöÑcheckAuthË∞ÉÁî®ÔºàÊ£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÔºâ
    if (!window.__loginInProgress && !window.__justLoggedIn) {
      setTimeout(function() {
        if (!window.__loginInProgress && !window.__justLoggedIn) {
          checkAuth();
        }
      }, 2000);
    }
  </script>
</body>
</html>
