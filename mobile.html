<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>æ™ºé¸½ï½œPigeonAI - ç§»åŠ¨ç«¯</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- ğŸ”¥ğŸ”¥ğŸ”¥ ç»ˆæä¿æŠ¤è„šæœ¬ - å¿…é¡»åœ¨æ‰€æœ‰è„šæœ¬ä¹‹å‰ï¼Œæ‹¦æˆªæ‰€æœ‰éšè—æ“ä½œ ğŸ”¥ğŸ”¥ğŸ”¥ -->
  <script>
    (function() {
      'use strict';
      console.log('ğŸ›¡ï¸ [ç»ˆæä¿æŠ¤] å¯åŠ¨é¡µé¢ä¿æŠ¤æœºåˆ¶...');
      
      // ä¿æŠ¤çš„å…³é”®å…ƒç´ 
      const PROTECTED_ELEMENTS = {
        body: null,
        mobileContent: null,
        homeView: null
      };
      
      // å¼ºåˆ¶æ˜¾ç¤ºå‡½æ•°ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
      function ultimateForceShow() {
        try {
          // å¼ºåˆ¶æ˜¾ç¤ºbody
          if (document.body) {
            PROTECTED_ELEMENTS.body = document.body;
            document.body.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 100vh !important; position: relative !important;';
            // é˜»æ­¢ä»»ä½•è„šæœ¬ä¿®æ”¹bodyæ ·å¼
            Object.defineProperty(document.body.style, 'display', {
              set: function(value) {
                if (value === 'none' || value === '') {
                  console.warn('ğŸ›¡ï¸ [ç»ˆæä¿æŠ¤] é˜»æ­¢éšè—bodyï¼Œå¼ºåˆ¶æ˜¾ç¤º');
                  Object.defineProperty(this, 'display', {value: 'block !important', writable: false});
                } else {
                  Object.defineProperty(this, 'display', {value: value, writable: true});
                }
              },
              get: function() { return 'block'; },
              configurable: true
            });
          }
          
          // å¼ºåˆ¶æ˜¾ç¤ºmobile-content
          const mobileContent = document.querySelector('.mobile-content');
          if (mobileContent) {
            PROTECTED_ELEMENTS.mobileContent = mobileContent;
            mobileContent.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 100vh !important; position: relative !important; z-index: 1 !important;';
          }
          
          // å¼ºåˆ¶æ˜¾ç¤ºhomeView
          const homeView = document.getElementById('homeView');
          if (homeView) {
            PROTECTED_ELEMENTS.homeView = homeView;
            homeView.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 600px !important; height: auto !important; position: relative !important; width: 100% !important; z-index: 1 !important;';
            homeView.classList.remove('hidden', 'd-none');
            
            // æ‹¦æˆªæ‰€æœ‰è¯•å›¾éšè—homeViewçš„æ“ä½œ
            const originalSetProperty = homeView.style.setProperty;
            homeView.style.setProperty = function(property, value, priority) {
              if (property === 'display' && (value === 'none' || value === '')) {
                console.warn('ğŸ›¡ï¸ [ç»ˆæä¿æŠ¤] é˜»æ­¢éšè—homeViewï¼Œå¼ºåˆ¶æ˜¾ç¤º');
                return originalSetProperty.call(this, 'display', 'block', 'important');
              }
              return originalSetProperty.call(this, property, value, priority);
            };
            
            // æ‹¦æˆªç›´æ¥è®¾ç½®displayå±æ€§
            Object.defineProperty(homeView.style, 'display', {
              set: function(value) {
                if (value === 'none' || value === '') {
                  console.warn('ğŸ›¡ï¸ [ç»ˆæä¿æŠ¤] é˜»æ­¢éšè—homeViewï¼Œå¼ºåˆ¶æ˜¾ç¤º');
                  this.setProperty('display', 'block', 'important');
                } else {
                  this.setProperty('display', value, 'important');
                }
              },
              get: function() { return 'block'; },
              configurable: true
            });
          }
        } catch (e) {
          console.error('âŒ [ç»ˆæä¿æŠ¤] å¼ºåˆ¶æ˜¾ç¤ºå¤±è´¥:', e);
        }
      }
      
      // ç«‹å³æ‰§è¡Œ
      ultimateForceShow();
      
      // ä½¿ç”¨MutationObserverç›‘æ§æ‰€æœ‰DOMå˜åŒ–
      if (typeof MutationObserver !== 'undefined') {
        const observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
              const target = mutation.target;
              
              // æ£€æŸ¥æ˜¯å¦æ˜¯å—ä¿æŠ¤çš„å…ƒç´ 
              if (target === PROTECTED_ELEMENTS.body || 
                  target === PROTECTED_ELEMENTS.mobileContent || 
                  target === PROTECTED_ELEMENTS.homeView ||
                  target.id === 'homeView' ||
                  target.classList.contains('mobile-content')) {
                
                const computedStyle = window.getComputedStyle(target);
                if (computedStyle.display === 'none' || 
                    computedStyle.visibility === 'hidden' || 
                    computedStyle.opacity === '0') {
                  console.warn('ğŸ›¡ï¸ [ç»ˆæä¿æŠ¤] æ£€æµ‹åˆ°å—ä¿æŠ¤å…ƒç´ è¢«éšè—ï¼Œç«‹å³æ¢å¤ï¼', target);
                  ultimateForceShow();
                }
              }
            }
            
            // æ£€æŸ¥æ–°å¢çš„èŠ‚ç‚¹
            if (mutation.addedNodes) {
              mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1) { // Element node
                  if (node.id === 'homeView' || node.classList.contains('mobile-content')) {
                    PROTECTED_ELEMENTS.homeView = node.id === 'homeView' ? node : null;
                    PROTECTED_ELEMENTS.mobileContent = node.classList.contains('mobile-content') ? node : null;
                    ultimateForceShow();
                  }
                }
              });
            }
          });
        });
        
        // ç­‰å¾…DOMåŠ è½½åå¼€å§‹ç›‘æ§
        function startProtection() {
          if (document.body) {
            observer.observe(document.body, {
              childList: true,
              subtree: true,
              attributes: true,
              attributeFilter: ['style', 'class']
            });
            console.log('ğŸ›¡ï¸ [ç»ˆæä¿æŠ¤] MutationObserverå·²å¯åŠ¨');
          } else {
            setTimeout(startProtection, 100);
          }
        }
        
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', startProtection);
        } else {
          startProtection();
        }
      }
      
      // æŒç»­å¼ºåˆ¶æ˜¾ç¤ºï¼ˆæ¯100msæ‰§è¡Œä¸€æ¬¡ï¼ŒæŒç»­10ç§’ï¼‰
      let forceShowCount = 0;
      const forceShowInterval = setInterval(function() {
        ultimateForceShow();
        forceShowCount++;
        if (forceShowCount >= 100) { // 10ç§’ååœæ­¢
          clearInterval(forceShowInterval);
          console.log('ğŸ›¡ï¸ [ç»ˆæä¿æŠ¤] æŒç»­ä¿æŠ¤å·²åœæ­¢ï¼Œé¡µé¢åº”è¯¥å·²ç¨³å®š');
        }
      }, 100);
      
      // åœ¨å¤šä¸ªæ—¶æœºæ‰§è¡Œ
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          ultimateForceShow();
          setTimeout(ultimateForceShow, 0);
          setTimeout(ultimateForceShow, 10);
          setTimeout(ultimateForceShow, 50);
          setTimeout(ultimateForceShow, 100);
          setTimeout(ultimateForceShow, 500);
        });
      } else {
        ultimateForceShow();
        setTimeout(ultimateForceShow, 0);
        setTimeout(ultimateForceShow, 10);
        setTimeout(ultimateForceShow, 50);
        setTimeout(ultimateForceShow, 100);
        setTimeout(ultimateForceShow, 500);
      }
      
      window.addEventListener('load', function() {
        ultimateForceShow();
        setTimeout(ultimateForceShow, 0);
        setTimeout(ultimateForceShow, 100);
        setTimeout(ultimateForceShow, 500);
        setTimeout(ultimateForceShow, 1000);
      });
      
      console.log('ğŸ›¡ï¸ [ç»ˆæä¿æŠ¤] é¡µé¢ä¿æŠ¤æœºåˆ¶å·²å¯åŠ¨');
    })();
  </script>
  
  <!-- ğŸ”¥ğŸ”¥ğŸ”¥ ç»ˆæCSSä¿æŠ¤ - ç¡®ä¿é¡µé¢å§‹ç»ˆå¯è§ ğŸ”¥ğŸ”¥ğŸ”¥ -->
  <style>
    /* æœ€é«˜ä¼˜å…ˆçº§CSSè§„åˆ™ - ç¡®ä¿é¡µé¢å§‹ç»ˆå¯è§ */
    html, body {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      min-height: 100vh !important;
      position: relative !important;
      overflow-x: hidden !important;
    }
    
    .mobile-content {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      min-height: 100vh !important;
      position: relative !important;
      z-index: 1 !important;
    }
    
    #homeView,
    div#homeView,
    .mobile-view#homeView,
    div#homeView.mobile-view,
    #homeView.mobile-view {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      min-height: 600px !important;
      height: auto !important;
      position: relative !important;
      width: 100% !important;
      z-index: 1 !important;
    }
    
    /* é˜»æ­¢ä»»ä½•éšè—æ“ä½œ */
    body[style*="display: none"],
    body[style*="display:none"],
    .mobile-content[style*="display: none"],
    .mobile-content[style*="display:none"],
    #homeView[style*="display: none"],
    #homeView[style*="display:none"] {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
  </style>
  
  <!-- ğŸ”§ Eruda ç§»åŠ¨ç«¯è°ƒè¯•å·¥å…·ï¼ˆä¸­æ–‡ç‰ˆï¼‰ - å»¶è¿ŸåŠ è½½é¿å…é˜»å¡é¡µé¢ -->
  <script>
    // å»¶è¿ŸåŠ è½½Erudaï¼Œç¡®ä¿ä¸å½±å“é¡µé¢æ¸²æŸ“
    (function() {
      function loadEruda() {
        // åªåœ¨ç§»åŠ¨è®¾å¤‡ä¸ŠåŠ è½½
        if (!/Mobile|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
          return;
        }
        
        // åŠ¨æ€åŠ è½½Erudaè„šæœ¬
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/eruda';
        script.onload = function() {
          // ç¡®ä¿bodyå­˜åœ¨åå†åˆå§‹åŒ–
          function initEruda() {
            if (document.body && typeof eruda !== 'undefined') {
              try {
                eruda.init({
                  container: document.body,
                  tool: ['console', 'elements', 'network', 'resources', 'info', 'snippets'],
                  autoScale: true,
                  defaults: {
                    displaySize: 50,
                    transparency: 0.9,
                    theme: 'dark'
                  }
                });
                console.log('âœ… Erudaè°ƒè¯•å·¥å…·å·²åˆå§‹åŒ–ï¼ˆä¸­æ–‡ç‰ˆï¼‰');
              } catch (e) {
                console.warn('âš ï¸ Erudaåˆå§‹åŒ–å¤±è´¥:', e);
              }
            } else {
              // bodyè¿˜ä¸å­˜åœ¨ï¼Œå»¶è¿Ÿé‡è¯•
              setTimeout(initEruda, 100);
            }
          }
          
          // ç­‰å¾…DOMåŠ è½½å®Œæˆ
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initEruda);
          } else {
            setTimeout(initEruda, 100);
          }
        };
        script.onerror = function() {
          console.warn('âš ï¸ Erudaè„šæœ¬åŠ è½½å¤±è´¥');
        };
        document.head.appendChild(script);
      }
      
      // å»¶è¿ŸåŠ è½½ï¼Œç¡®ä¿ä¸å½±å“é¡µé¢æ¸²æŸ“
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadEruda);
      } else {
        setTimeout(loadEruda, 500);
      }
    })();
  </script>
  
  <!-- ğŸ”§ ç§»åŠ¨ç«¯ç«‹å³æ˜¾ç¤ºè„šæœ¬ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ - å¿…é¡»åœ¨æ‰€æœ‰è„šæœ¬ä¹‹å‰ï¼‰ -->
  <script>
    // ç§»åŠ¨ç«¯ç«‹å³æ˜¾ç¤ºè„šæœ¬ - åœ¨é¡µé¢åŠ è½½å‰å°±æ‰§è¡Œï¼ˆæ”¯æŒPCå’Œç§»åŠ¨ç«¯ï¼‰
    (function() {
      'use strict';
      const isMobile = /Mobile|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      
      // PCç«¯æ‰“å¼€ç§»åŠ¨ç«¯é¡µé¢æ—¶ä¹Ÿå¯ç”¨æ˜¾ç¤ºä¿®å¤
      console.log('ğŸ“± [ç§»åŠ¨ç«¯ä¿®å¤] æ£€æµ‹è®¾å¤‡ç±»å‹ - ç§»åŠ¨è®¾å¤‡:', isMobile, 'è§¦æ‘¸è®¾å¤‡:', isTouchDevice);
      
      // ğŸ”¥ æœ€æ¿€è¿›çš„å¼ºåˆ¶æ˜¾ç¤ºå‡½æ•° - ç«‹å³æ‰§è¡Œï¼Œä¸ç­‰å¾…ä»»ä½•äº‹ä»¶
      function ultraForceShow() {
        try {
          // å¼ºåˆ¶æ˜¾ç¤ºbody
          if (document.body) {
            document.body.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 100vh !important;';
          }
          
          // å¼ºåˆ¶æ˜¾ç¤ºmobile-content
          const mobileContent = document.querySelector('.mobile-content');
          if (mobileContent) {
            mobileContent.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 100vh !important; position: relative !important; z-index: 1 !important;';
          }
          
          // å¼ºåˆ¶æ˜¾ç¤ºhomeViewï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
          const homeView = document.getElementById('homeView');
          if (homeView) {
            homeView.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 600px !important; height: auto !important; position: relative !important; width: 100% !important; z-index: 1 !important;';
            // ç§»é™¤å¯èƒ½éšè—çš„ç±»
            homeView.classList.remove('hidden', 'd-none');
            console.log('âœ… [è¶…å¼ºåˆ¶æ˜¾ç¤º] homeViewå·²å¼ºåˆ¶æ˜¾ç¤ºï¼Œé«˜åº¦:', homeView.offsetHeight);
          } else {
            console.warn('âš ï¸ [è¶…å¼ºåˆ¶æ˜¾ç¤º] homeViewå…ƒç´ ä¸å­˜åœ¨ï¼Œç­‰å¾…DOMåŠ è½½...');
          }
          
          // å¼ºåˆ¶éšè—PCè­¦å‘Šå¼¹çª—ï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰
          if (isMobile || isTouchDevice || (window.innerWidth && window.innerWidth < 769)) {
            const pcWarning = document.getElementById('pcWarning');
            if (pcWarning) {
              pcWarning.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important; z-index: -1 !important; pointer-events: none !important; position: fixed !important;';
            }
          }
        } catch (e) {
          console.error('âŒ [è¶…å¼ºåˆ¶æ˜¾ç¤º] æ‰§è¡Œå¤±è´¥:', e);
        }
      }
      
      // ç«‹å³æ‰§è¡Œï¼ˆä¸ç­‰å¾…ä»»ä½•äº‹ä»¶ï¼‰
      ultraForceShow();
      
      // DOMåŠ è½½åç«‹å³æ‰§è¡Œ
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          ultraForceShow();
          setTimeout(ultraForceShow, 0);
          setTimeout(ultraForceShow, 10);
          setTimeout(ultraForceShow, 50);
          setTimeout(ultraForceShow, 100);
        });
      } else {
        ultraForceShow();
        setTimeout(ultraForceShow, 0);
        setTimeout(ultraForceShow, 10);
        setTimeout(ultraForceShow, 50);
        setTimeout(ultraForceShow, 100);
      }
      
      // é¡µé¢å®Œå…¨åŠ è½½åå†æ¬¡æ‰§è¡Œ
      window.addEventListener('load', function() {
        ultraForceShow();
        setTimeout(ultraForceShow, 0);
        setTimeout(ultraForceShow, 100);
        setTimeout(ultraForceShow, 500);
      });
      
      // ä½¿ç”¨MutationObserveræŒç»­ç›‘æ§ï¼Œç¡®ä¿å†…å®¹å§‹ç»ˆæ˜¾ç¤º
      if (typeof MutationObserver !== 'undefined' && document.body) {
        const observer = new MutationObserver(function() {
          const homeView = document.getElementById('homeView');
          if (homeView) {
            const computedStyle = window.getComputedStyle(homeView);
            if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden' || computedStyle.opacity === '0') {
              console.warn('âš ï¸ [è¶…å¼ºåˆ¶æ˜¾ç¤º] æ£€æµ‹åˆ°homeViewè¢«éšè—ï¼Œç«‹å³å¼ºåˆ¶æ˜¾ç¤º');
              ultraForceShow();
            }
          }
        });
        
        function startObserving() {
          if (document.body) {
            observer.observe(document.body, {
              childList: true,
              subtree: true,
              attributes: true,
              attributeFilter: ['style', 'class']
            });
            console.log('âœ… [è¶…å¼ºåˆ¶æ˜¾ç¤º] MutationObserverå·²å¯åŠ¨ï¼ŒæŒç»­ç›‘æ§é¡µé¢æ˜¾ç¤ºçŠ¶æ€');
          } else {
            setTimeout(startObserving, 100);
          }
        }
        
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', startObserving);
        } else {
          startObserving();
        }
      }
      
      // ç«‹å³æ·»åŠ å†…è”æ ·å¼åˆ°headï¼Œç¡®ä¿CSSä¼˜å…ˆçº§æœ€é«˜ï¼ˆPCå’Œç§»åŠ¨ç«¯éƒ½é€‚ç”¨ï¼‰
      const style = document.createElement('style');
      style.id = 'mobile-immediate-fix';
      style.textContent = `
        body { 
          display: block !important; 
          visibility: visible !important; 
          opacity: 1 !important; 
          pointer-events: auto !important;
          min-height: 100vh !important;
        }
        .mobile-content { 
          display: block !important; 
          visibility: visible !important; 
          opacity: 1 !important; 
          pointer-events: auto !important;
          min-height: 100vh !important;
        }
        #homeView { 
          display: block !important; 
          visibility: visible !important; 
          opacity: 1 !important; 
          position: relative !important;
          pointer-events: auto !important;
          min-height: 600px !important;
          height: auto !important;
        }
        /* å¼ºåˆ¶è¦†ç›–æ‰€æœ‰å¯èƒ½éšè—homeViewçš„è§„åˆ™ */
        .mobile-view#homeView,
        div#homeView.mobile-view,
        #homeView.mobile-view {
          display: block !important;
          visibility: visible !important;
          opacity: 1 !important;
          position: relative !important;
          min-height: 600px !important;
          height: auto !important;
        }
        /* ç§»åŠ¨è®¾å¤‡ä¸Šå¼ºåˆ¶éšè—PCè­¦å‘Šå¼¹çª—ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰ */
        @media (max-width: 768px), (hover: none), (pointer: coarse) {
          .pc-warning,
          #pcWarning {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            z-index: -1 !important;
            pointer-events: none !important;
          }
        }
        /* ç¡®ä¿æ‰€æœ‰æŒ‰é’®å¯ç‚¹å‡» */
        button, .btn, .btn-icon, .mobile-nav-item, .mobile-card, .mobile-tab {
          pointer-events: auto !important;
          cursor: pointer !important;
          touch-action: manipulation !important;
          -webkit-tap-highlight-color: rgba(37, 99, 235, 0.3) !important;
        }
      `;
      if (document.head) {
        document.head.appendChild(style);
      } else {
        document.addEventListener('DOMContentLoaded', function() {
          document.head.appendChild(style);
        });
      }
    })();
  </script>
  
  <!-- ğŸ”§ è‡ªåŠ¨è´¦å·æ³¨å†Œå’Œæ•°æ®ç®¡ç†è„šæœ¬ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ - å¿…é¡»åœ¨å…¶ä»–è„šæœ¬ä¹‹å‰ï¼‰ -->
  <script src="js/auto-account-register.js"></script>
  
  <!-- ğŸ”§ ç§»åŠ¨ç«¯æŒ‰é’®ç‚¹å‡»ç»ˆæä¿®å¤è„šæœ¬ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ - å¿…é¡»åœ¨é¡µé¢æ˜¾ç¤ºä¿®å¤ä¹‹å‰ï¼‰ -->
  <script src="js/mobile-button-click-fix.js"></script>
  
  <!-- ğŸ”§ é¡µé¢æ˜¾ç¤ºä¿®å¤è„šæœ¬ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ - ç¡®ä¿é¡µé¢å†…å®¹å¯è§ï¼‰ -->
  <script>
    // ç«‹å³æ‰§è¡Œï¼Œç¡®ä¿é¡µé¢å†…å®¹å¯è§ï¼ˆä¸ç­‰å¾…DOMåŠ è½½ï¼‰
    (function() {
      console.log('ğŸ”§ [é¡µé¢ä¿®å¤] å¼€å§‹åˆå§‹åŒ–é¡µé¢æ˜¾ç¤ºä¿®å¤è„šæœ¬...');
      
      // å¼ºåˆ¶æ˜¾ç¤ºhomeViewçš„å‡½æ•°ï¼ˆä½¿ç”¨æœ€å¼ºåŠ›çš„æ–¹æ³•ï¼‰
      function forceShowHomeView() {
        try {
          const homeView = document.getElementById('homeView');
          const mobileContent = document.querySelector('.mobile-content');
          const body = document.body;
          
          // ç¡®ä¿bodyå¯è§
          if (body) {
            body.style.setProperty('display', 'block', 'important');
            body.style.setProperty('visibility', 'visible', 'important');
            body.style.setProperty('opacity', '1', 'important');
          }
          
          // ç¡®ä¿mobile-contentå¯è§
          if (mobileContent) {
            mobileContent.style.setProperty('display', 'block', 'important');
            mobileContent.style.setProperty('visibility', 'visible', 'important');
            mobileContent.style.setProperty('opacity', '1', 'important');
            // ä¿®å¤height: 0pxé—®é¢˜ - ç¡®ä¿mobile-contentæœ‰æœ€å°é«˜åº¦
            mobileContent.style.setProperty('min-height', '100vh', 'important');
            mobileContent.style.setProperty('height', 'auto', 'important');
          }
          
          if (homeView) {
            // ä½¿ç”¨setPropertyè®¾ç½®!importantä¼˜å…ˆçº§ï¼ˆæœ€å¼ºåŠ›ï¼‰
            homeView.style.setProperty('display', 'block', 'important');
            homeView.style.setProperty('visibility', 'visible', 'important');
            homeView.style.setProperty('opacity', '1', 'important');
            homeView.style.setProperty('position', 'relative', 'important');
            homeView.style.setProperty('width', '100%', 'important');
            // ä¿®å¤height: 0pxé—®é¢˜ - å…ˆè®¾ç½®ä¸€ä¸ªæœ€å°é«˜åº¦ç¡®ä¿å¯è§ï¼Œç„¶åè®¾ç½®ä¸ºauto
            homeView.style.setProperty('min-height', '600px', 'important');
            homeView.style.setProperty('height', 'auto', 'important');
            
            // ç§»é™¤å¯èƒ½éšè—å…ƒç´ çš„ç±»
            homeView.classList.remove('hidden', 'd-none');
            
            // éšè—å…¶ä»–è§†å›¾
            document.querySelectorAll('.mobile-view').forEach(view => {
              if (view.id && view.id !== 'homeView') {
                view.style.setProperty('display', 'none', 'important');
              }
            });
            
            const computedStyle = window.getComputedStyle(homeView);
            console.log('âœ… [é¡µé¢ä¿®å¤] å·²å¼ºåˆ¶æ˜¾ç¤ºhomeViewå’Œmobile-contentï¼ŒçŠ¶æ€:', {
              display: computedStyle.display,
              visibility: computedStyle.visibility,
              opacity: computedStyle.opacity,
              height: homeView.offsetHeight,
              width: homeView.offsetWidth,
              isMobile: /Mobile|Android|iPhone|iPad/i.test(navigator.userAgent)
            });
            return true;
          } else {
            console.warn('âš ï¸ [é¡µé¢ä¿®å¤] homeViewå…ƒç´ ä¸å­˜åœ¨');
            return false;
          }
        } catch (e) {
          console.error('âŒ [é¡µé¢ä¿®å¤] å¼ºåˆ¶æ˜¾ç¤ºå¤±è´¥:', e);
          return false;
        }
      }
      
      // ä½¿ç”¨MutationObserverç›‘å¬DOMå˜åŒ–
      if (typeof MutationObserver !== 'undefined') {
        const observer = new MutationObserver(function(mutations) {
          const homeView = document.getElementById('homeView');
          if (homeView) {
            const computedStyle = window.getComputedStyle(homeView);
            if (computedStyle.display === 'none' || homeView.style.display === 'none') {
              console.log('âš ï¸ [é¡µé¢ä¿®å¤] MutationObserveræ£€æµ‹åˆ°homeViewè¢«éšè—ï¼Œå¼ºåˆ¶æ˜¾ç¤º');
              forceShowHomeView();
            }
          }
        });
        
        // å¼€å§‹è§‚å¯Ÿbody
        if (document.body) {
          observer.observe(document.body, { 
            childList: true, 
            subtree: true,
            attributes: true,
            attributeFilter: ['style', 'class']
          });
          // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
          forceShowHomeView();
        } else {
          document.addEventListener('DOMContentLoaded', function() {
            observer.observe(document.body, { 
              childList: true, 
              subtree: true,
              attributes: true,
              attributeFilter: ['style', 'class']
            });
            forceShowHomeView();
          });
        }
      }
      
      // å®šæ—¶å™¨æ£€æŸ¥ï¼ˆå¤šé‡æ£€æŸ¥ç¡®ä¿ä¸‡æ— ä¸€å¤±ï¼‰
      const checkTimes = [0, 50, 100, 200, 500, 1000, 2000, 3000, 5000];
      checkTimes.forEach(delay => {
        setTimeout(function() {
          console.log(`ğŸ”§ [é¡µé¢ä¿®å¤] å»¶è¿Ÿ${delay}msæ£€æŸ¥homeViewæ˜¾ç¤ºçŠ¶æ€`);
          const homeView = document.getElementById('homeView');
          if (homeView) {
            const computedStyle = window.getComputedStyle(homeView);
            if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden' || computedStyle.opacity === '0') {
              console.warn(`âš ï¸ [é¡µé¢ä¿®å¤] å»¶è¿Ÿ${delay}msæ£€æŸ¥ï¼šhomeViewè¢«éšè—ï¼Œå¼ºåˆ¶æ˜¾ç¤º`);
              forceShowHomeView();
            } else {
              console.log(`âœ… [é¡µé¢ä¿®å¤] å»¶è¿Ÿ${delay}msæ£€æŸ¥ï¼šhomeViewæ­£å¸¸æ˜¾ç¤º`);
            }
          } else {
            console.warn(`âš ï¸ [é¡µé¢ä¿®å¤] å»¶è¿Ÿ${delay}msæ£€æŸ¥ï¼šhomeViewä¸å­˜åœ¨`);
          }
        }, delay);
      });
      
      // PCå’Œç§»åŠ¨ç«¯éƒ½ç«‹å³æ‰§è¡Œï¼ˆä¸ç­‰å¾…ä»»ä½•äº‹ä»¶ï¼‰
      const isMobileDevice = /Mobile|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      
      console.log('ğŸ“± [é¡µé¢ä¿®å¤] è®¾å¤‡æ£€æµ‹ - ç§»åŠ¨è®¾å¤‡:', isMobileDevice, 'è§¦æ‘¸è®¾å¤‡:', isTouchDevice);
      
      // æ— è®ºPCè¿˜æ˜¯ç§»åŠ¨ç«¯éƒ½ç«‹å³æ‰§è¡Œï¼Œç¡®ä¿é¡µé¢å¯è§
      const immediateTimes = [0, 10, 50, 100, 200];
      immediateTimes.forEach(delay => {
        setTimeout(function() {
          forceShowHomeView();
        }, delay);
      });
      
      // DOMContentLoadedæ—¶æ‰§è¡Œ
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          console.log('ğŸ”§ [é¡µé¢ä¿®å¤] DOMContentLoadedäº‹ä»¶è§¦å‘ï¼Œå¼ºåˆ¶æ˜¾ç¤ºhomeView');
          forceShowHomeView();
          // PCå’Œç§»åŠ¨ç«¯éƒ½é¢å¤–å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿é¡µé¢å¯è§
          setTimeout(forceShowHomeView, 100);
          setTimeout(forceShowHomeView, 300);
          setTimeout(forceShowHomeView, 500);
          setTimeout(forceShowHomeView, 1000);
        });
      } else {
        // DOMå·²åŠ è½½ï¼Œç«‹å³æ‰§è¡Œ
        console.log('ğŸ”§ [é¡µé¢ä¿®å¤] DOMå·²åŠ è½½ï¼Œç«‹å³å¼ºåˆ¶æ˜¾ç¤ºhomeView');
        forceShowHomeView();
        // PCå’Œç§»åŠ¨ç«¯éƒ½é¢å¤–å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿é¡µé¢å¯è§
        setTimeout(forceShowHomeView, 100);
        setTimeout(forceShowHomeView, 300);
        setTimeout(forceShowHomeView, 500);
        setTimeout(forceShowHomeView, 1000);
      }
      
      // çª—å£åŠ è½½å®Œæˆåå†æ¬¡æ£€æŸ¥ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
      window.addEventListener('load', function() {
        console.log('ğŸ”§ [é¡µé¢ä¿®å¤] window.loadäº‹ä»¶è§¦å‘ï¼Œå¼ºåˆ¶æ˜¾ç¤ºhomeView');
        
        // ç«‹å³å¼ºåˆ¶æ˜¾ç¤ºï¼ˆä¸ç­‰å¾…ï¼‰
        forceShowHomeView();
        
        // å¤šæ¬¡å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿è¦†ç›–æ‰€æœ‰å¯èƒ½çš„éšè—æ“ä½œ
        setTimeout(forceShowHomeView, 0);
        setTimeout(forceShowHomeView, 10);
        setTimeout(forceShowHomeView, 50);
        setTimeout(forceShowHomeView, 100);
        setTimeout(forceShowHomeView, 200);
        setTimeout(forceShowHomeView, 500);
        setTimeout(forceShowHomeView, 1000);
        setTimeout(forceShowHomeView, 2000);
        
        // ğŸ”¥ æ·»åŠ æŒç»­ç›‘æ§ï¼Œé˜²æ­¢homeViewè¢«å…¶ä»–è„šæœ¬éšè—
        const protectHomeView = setInterval(function() {
          const homeView = document.getElementById('homeView');
          if (homeView) {
            const computedStyle = window.getComputedStyle(homeView);
            // å¦‚æœhomeViewè¢«éšè—ï¼Œç«‹å³æ¢å¤
            if (computedStyle.display === 'none' || 
                computedStyle.visibility === 'hidden' || 
                computedStyle.opacity === '0' ||
                homeView.style.display === 'none') {
              console.warn('âš ï¸ [é¡µé¢ä¿æŠ¤] æ£€æµ‹åˆ°homeViewè¢«éšè—ï¼Œç«‹å³æ¢å¤ï¼');
              forceShowHomeView();
            }
          }
        }, 500); // æ¯500msæ£€æŸ¥ä¸€æ¬¡
        
        // 10ç§’ååœæ­¢ç›‘æ§ï¼ˆé¡µé¢åº”è¯¥å·²ç»ç¨³å®šï¼‰
        setTimeout(function() {
          clearInterval(protectHomeView);
          console.log('âœ… [é¡µé¢ä¿æŠ¤] åœæ­¢ç›‘æ§ï¼Œé¡µé¢åº”è¯¥å·²ç¨³å®š');
        }, 10000);
        
        // è¾“å‡ºè¯Šæ–­ä¿¡æ¯
        setTimeout(function() {
          console.log('ğŸ“Š [é¡µé¢è¯Šæ–­] å¼€å§‹è¯Šæ–­é¡µé¢æ˜¾ç¤ºé—®é¢˜...');
          const homeView = document.getElementById('homeView');
          const mobileContent = document.querySelector('.mobile-content');
          const body = document.body;
          
          if (homeView) {
            const computedStyle = window.getComputedStyle(homeView);
            console.log('ğŸ“Š [é¡µé¢è¯Šæ–­] homeViewçŠ¶æ€:', {
              exists: true,
              display: computedStyle.display,
              visibility: computedStyle.visibility,
              opacity: computedStyle.opacity,
              height: computedStyle.height,
              width: computedStyle.width,
              inlineStyle: homeView.getAttribute('style'),
              offsetHeight: homeView.offsetHeight,
              offsetWidth: homeView.offsetWidth
            });
          } else {
            console.error('âŒ [é¡µé¢è¯Šæ–­] homeViewå…ƒç´ ä¸å­˜åœ¨ï¼');
          }
          
          if (mobileContent) {
            const computedStyle = window.getComputedStyle(mobileContent);
            console.log('ğŸ“Š [é¡µé¢è¯Šæ–­] mobileContentçŠ¶æ€:', {
              exists: true,
              display: computedStyle.display,
              visibility: computedStyle.visibility,
              opacity: computedStyle.opacity,
              height: computedStyle.height,
              width: computedStyle.width,
              offsetHeight: mobileContent.offsetHeight,
              offsetWidth: mobileContent.offsetWidth
            });
          } else {
            console.error('âŒ [é¡µé¢è¯Šæ–­] mobileContentå…ƒç´ ä¸å­˜åœ¨ï¼');
          }
          
          if (body) {
            const computedStyle = window.getComputedStyle(body);
            console.log('ğŸ“Š [é¡µé¢è¯Šæ–­] bodyçŠ¶æ€:', {
              exists: true,
              display: computedStyle.display,
              visibility: computedStyle.visibility,
              opacity: computedStyle.opacity,
              height: computedStyle.height,
              width: computedStyle.width
            });
          }
          
          // æ£€æŸ¥æ˜¯å¦æœ‰é®æŒ¡å…ƒç´ 
          const allFixedElements = document.querySelectorAll('[style*="position: fixed"], [style*="position:fixed"]');
          console.log('ğŸ“Š [é¡µé¢è¯Šæ–­] å›ºå®šå®šä½å…ƒç´ æ•°é‡:', allFixedElements.length);
          allFixedElements.forEach((el, index) => {
            const computedStyle = window.getComputedStyle(el);
            if (parseInt(computedStyle.zIndex) > 1000) {
              console.warn(`âš ï¸ [é¡µé¢è¯Šæ–­] é«˜z-indexå…ƒç´  #${index}:`, {
                tag: el.tagName,
                id: el.id,
                class: el.className,
                zIndex: computedStyle.zIndex,
                display: computedStyle.display,
                visibility: computedStyle.visibility
              });
            }
          });
        }, 2000);
      });
      
      // æš´éœ²è¯Šæ–­å‡½æ•°åˆ°å…¨å±€ï¼Œæ–¹ä¾¿åœ¨æ§åˆ¶å°è°ƒç”¨
      window.diagnosePage = function() {
        const homeView = document.getElementById('homeView');
        const mobileContent = document.querySelector('.mobile-content');
        
        console.log('ğŸ” [è¯Šæ–­] é¡µé¢è¯Šæ–­ä¿¡æ¯:');
        console.log('homeView:', homeView);
        console.log('mobileContent:', mobileContent);
        if (homeView) {
          console.log('homeView computed style:', window.getComputedStyle(homeView));
          console.log('homeView inline style:', homeView.getAttribute('style'));
          console.log('homeView offsetHeight:', homeView.offsetHeight);
          console.log('homeView offsetWidth:', homeView.offsetWidth);
        }
        if (mobileContent) {
          console.log('mobileContent computed style:', window.getComputedStyle(mobileContent));
          console.log('mobileContent offsetHeight:', mobileContent.offsetHeight);
          console.log('mobileContent offsetWidth:', mobileContent.offsetWidth);
        }
        
        forceShowHomeView();
      };
      
      console.log('âœ… [é¡µé¢ä¿®å¤] é¡µé¢æ˜¾ç¤ºä¿®å¤è„šæœ¬å·²åŠ è½½ï¼Œå¯é€šè¿‡ window.diagnosePage() è¿›è¡Œè¯Šæ–­');
    })();
  </script>
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    :root {
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --border-light: #e2e8f0;
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    
    body {
      font-family: 'Inter', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      padding-bottom: 70px; /* ä¸ºåº•éƒ¨å¯¼èˆªæ ç•™å‡ºç©ºé—´ */
      overflow-x: hidden;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    /* é¡¶éƒ¨å¯¼èˆªæ  */
    .mobile-header {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      color: #fff;
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .mobile-header h1 {
      font-size: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(90deg, #fff 0%, #a5b4fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .mobile-header h1::before {
      content: 'ğŸ•Šï¸';
      font-size: 18px;
      -webkit-text-fill-color: initial;
    }
    
    .mobile-header-actions {
      display: flex;
      gap: 4px;
      align-items: center;
      /* åŸæœ¬ä¸º 8pxï¼Œå‘ä¸‹æ•´ä½“ç§»åŠ¨ 20px => 8px + 20px = 28px */
      margin-top: 28px;
    }
    
    .btn-icon {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: #fff;
      padding: 2px 6px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 2px;
      min-width: auto;
      height: 19px;
      white-space: nowrap;
      transition: all 0.2s;
    }
    
    .btn-icon:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    
    .btn-icon:active {
      transform: scale(0.95);
    }
    
    .btn-icon .btn-icon-emoji {
      font-size: 8px;
      line-height: 1;
      display: inline-block;
      flex-shrink: 0;
    }
    
    /* é¡¶éƒ¨â€œè´¦æˆ· / è®¾ç½®â€æŒ‰é’®æ•´ä½“æ”¾å¤§çº¦ 10% */
    .mobile-header-actions .btn-icon {
      padding: 3px 7px;
      font-size: 9px;
      height: 21px;
    }
    .mobile-header-actions .btn-icon .btn-icon-emoji {
      font-size: 9px;
    }
    
    .btn-icon .btn-icon-text {
      font-size: 8px;
      font-weight: 500;
      line-height: 1;
      color: #fff !important;
      display: inline-block !important;
      opacity: 1 !important;
      visibility: visible !important;
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    /* ç¡®ä¿é¡¶éƒ¨å¯¼èˆªæ æŒ‰é’®çš„æ–‡å­—å§‹ç»ˆå¯è§ */
    .mobile-header-actions .btn-icon .btn-icon-text {
      color: #fff !important;
      display: inline-block !important;
      opacity: 1 !important;
      visibility: visible !important;
      font-size: 9px !important;
    }
    
    /* æå°å±å¹•é€‚é…ï¼šåªåœ¨å±å¹•éå¸¸å°æ—¶éšè—æ–‡å­— */
    @media (max-width: 280px) {
      .mobile-header-actions .btn-icon .btn-icon-text {
        display: none !important;
      }
      .mobile-header-actions .btn-icon {
        padding: 8px;
        width: 36px;
        min-width: 36px;
      }
    }
    
    /* ä¸»å†…å®¹åŒº */
    .mobile-content {
      padding: 16px;
      max-width: 100%;
      overflow-x: hidden;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    /* ä¼˜åŒ–é—´è·å’Œå¸ƒå±€ */
    .mobile-section {
      margin-bottom: 20px;
    }
    
    .mobile-section:last-child {
      margin-bottom: 0;
    }
    
    .mobile-card {
      margin-bottom: 12px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .mobile-card:active {
      transform: scale(0.98);
    }
    
    /* ä¼˜åŒ–è¡¨å•é—´è· */
    .mobile-form-group {
      margin-bottom: 16px;
    }
    
    .mobile-form-group:last-child {
      margin-bottom: 0;
    }
    
    /* ä¼˜åŒ–æŒ‰é’®é—´è· */
    .mobile-quick-links {
      gap: 12px;
    }
    
    .mobile-quick-link-btn {
      padding: 14px;
      min-height: 64px;
    }
    
    /* ä¼˜åŒ–ç»Ÿè®¡å¡ç‰‡ */
    .mobile-stats {
      gap: 7.2px;
    }
    
    .mobile-stat-item {
      padding: 9.6px;
      min-height: 48px;
    }
    
    /* ä¼˜åŒ–åˆ—è¡¨é—´è· */
    .mobile-list {
      gap: 12px;
    }
    
    /* ä¼˜åŒ–æ ‡é¢˜é—´è· */
    .mobile-section-header {
      margin-bottom: 16px;
    }
    
    .mobile-section-title {
      margin-bottom: 0;
    }
    
    /* ä¼˜åŒ–æ¨¡æ€æ¡† */
    .mobile-modal-content {
      max-height: 85vh;
      margin: 20px;
    }
    
    .mobile-modal-body {
      padding: 20px;
      max-height: calc(85vh - 120px);
      overflow-y: auto;
    }
    
    /* ä¼˜åŒ–è¾“å…¥æ¡† */
    .mobile-input {
      padding: 12px 16px;
      font-size: 15px;
    }
    
    /* ä¼˜åŒ–æŒ‰é’® */
    .btn-primary, .btn-outline, .btn-secondary {
      padding: 12px 20px;
      font-size: 15px;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .btn-primary:active, .btn-outline:active, .btn-secondary:active {
      transform: scale(0.98);
    }
    
    /* ä¼˜åŒ–è¡¨æ ¼ */
    .mobile-table {
      border-spacing: 0;
    }
    
    .mobile-table th,
    .mobile-table td {
      padding: 12px;
    }
    
    /* ä¼˜åŒ–æ ‡ç­¾é¡µ */
    .mobile-tabs {
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .mobile-tab {
      padding: 10px 16px;
      font-size: 14px;
    }
    
    /* ä¼˜åŒ–ç©ºçŠ¶æ€ */
    .mobile-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    /* ä¼˜åŒ–åŠ è½½çŠ¶æ€ */
    .mobile-loading {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    /* ä¼˜åŒ–å¡ç‰‡æ ‡é¢˜å’Œå†…å®¹é—´è· */
    .mobile-card-title {
      margin-bottom: 8px;
    }
    
    .mobile-card-meta {
      margin-top: 4px;
    }
    
    /* ä¼˜åŒ–å¥åº·ç»Ÿè®¡å¡ç‰‡ */
    .mobile-health-stat {
      padding: 16px;
      min-height: 90px;
    }
    
    /* ä¼˜åŒ–æ—¶é—´è½´ */
    .health-timeline-item {
      padding: 12px 0;
    }
    
    /* ä¼˜åŒ–è®­ç»ƒè®°å½•å¡ç‰‡ */
    .mobile-race-item {
      padding: 16px;
      margin-bottom: 12px;
    }
    
    /* ä¼˜åŒ–è¯¦æƒ…è§†å›¾ */
    .mobile-detail-section {
      margin-bottom: 20px;
    }
    
    .mobile-detail-section:last-child {
      margin-bottom: 0;
    }
    
    /* ä¼˜åŒ–å›¾ç‰‡æ˜¾ç¤º */
    .mobile-image-preview {
      border-radius: 8px;
      margin: 8px 0;
    }
    
    /* ä¼˜åŒ–æœç´¢å»ºè®® */
    .mobile-search-suggestions {
      margin-top: 8px;
      border-radius: 8px;
    }
    
    /* ä¼˜åŒ–è¡€ç»Ÿæ ‘ */
    #mp_pedigreeTree {
      padding: 20px;
      min-height: 400px;
    }
    
    /* ä¼˜åŒ–é…å¯¹è¯„ä¼°å¡ç‰‡ */
    .mobile-card .mobile-card-title {
      font-size: 13px;
      font-weight: 600;
    }
    
    /* ä¼˜åŒ–åˆ†æç»“æœ */
    .mobile-analysis-result {
      padding: 16px;
      border-radius: 12px;
      margin: 12px 0;
    }
    
    /* ä¼˜åŒ–æ•°æ®æ¦‚è§ˆå¡ç‰‡ */
    .mobile-dashboard-card {
      padding: 16px;
      margin-bottom: 12px;
    }
    
    /* å“åº”å¼ä¼˜åŒ– */
    @media (max-width: 375px) {
      .mobile-content {
        padding: 12px;
      }
      
      .mobile-section {
        margin-bottom: 16px;
      }
      
      .mobile-card {
        padding: 14px;
      }
      
      .mobile-stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
      }
      
      .mobile-quick-links {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
    }
    
    /* ä¼˜åŒ–æ»šåŠ¨æ¡ */
    .mobile-list::-webkit-scrollbar,
    .mobile-evo-messages::-webkit-scrollbar,
    .mobile-modal-body::-webkit-scrollbar {
      width: 4px;
    }
    
    .mobile-list::-webkit-scrollbar-track,
    .mobile-evo-messages::-webkit-scrollbar-track,
    .mobile-modal-body::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }
    
    .mobile-list::-webkit-scrollbar-thumb,
    .mobile-evo-messages::-webkit-scrollbar-thumb,
    .mobile-modal-body::-webkit-scrollbar-thumb {
      background: var(--border-light);
      border-radius: 2px;
    }
    
    /* ä¼˜åŒ–åŠ¨ç”» */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .mobile-view {
      animation: fadeIn 0.3s ease-out;
    }
    
    .mobile-card {
      animation: fadeIn 0.2s ease-out;
    }
    
    /* ä¼˜åŒ–ç„¦ç‚¹çŠ¶æ€ */
    .mobile-input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    /* ä¼˜åŒ–ç¦ç”¨çŠ¶æ€ */
    button:disabled,
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    /* ä¼˜åŒ–åŠ è½½åŠ¨ç”» */
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    .mobile-loading::before {
      content: '';
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--border-light);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    /* å¼€å…³æŒ‰é’®æ ·å¼ */
    label[style*="position:relative"] input[type="checkbox"] + span {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 24px;
    }
    
    label[style*="position:relative"] input[type="checkbox"] + span:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }
    
    label[style*="position:relative"] input[type="checkbox"]:checked + span {
      background-color: #667eea;
    }
    
    label[style*="position:relative"] input[type="checkbox"]:checked + span:before {
      transform: translateX(20px);
    }
    
    /* æ—¥æœŸå’Œå¤©æ°”åŒºåŸŸ */
    .mobile-overview {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 7.2px;
      padding: 7.2px;
      margin-bottom: 9.6px;
      color: #fff;
      box-shadow: var(--shadow-lg);
    }
    
    .mobile-overview-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 6px;
    }
    
    .mobile-date {
      display: flex;
      align-items: center;
      gap: 4.8px;
    }
    
    .mobile-date-day {
      font-size: 19.2px;
      font-weight: 700;
      line-height: 1;
    }
    
    .mobile-date-info {
      display: flex;
      flex-direction: column;
    }
    
    .mobile-date-weekday {
      font-size: 8.4px;
      opacity: 0.9;
    }
    
    .mobile-date-full {
      font-size: 7.2px;
      opacity: 0.8;
    }
    
    .mobile-weather {
      display: flex;
      align-items: center;
      gap: 3px;
      background: rgba(255, 255, 255, 0.15);
      padding: 3px 4.8px;
      border-radius: 4.8px;
      backdrop-filter: blur(10px);
    }
    
    .mobile-weather-icon {
      font-size: 10.8px;
    }
    
    .mobile-weather-text {
      font-size: 7.2px;
      font-weight: 600;
    }
    
    /* åŠŸèƒ½æ¨¡å—ç»Ÿè®¡å¡ç‰‡ - ç¡®ä¿å¯è§ */
    .mobile-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 4.8px;
      margin-top: 6px;
      width: 100%;
    }
    
    .mobile-stat-item {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border-radius: 4.8px;
      padding: 6px;
      display: flex;
      align-items: center;
      gap: 4.8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      min-height: 34.8px;
    }
    
    .mobile-stat-icon {
      font-size: 10.8px;
      flex-shrink: 0;
    }
    
    .mobile-stat-content {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 0;
    }
    
    .mobile-stat-number {
      font-size: 12px;
      font-weight: 800;
      color: #fff;
      line-height: 1.2;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .mobile-stat-label {
      font-size: 7.2px;
      color: rgba(255, 255, 255, 0.95);
      margin-top: 2.4px;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
    }
    
    /* å¥åº·ç»Ÿè®¡å¡ç‰‡ç‰¹æ®Šä¼˜åŒ– */
    .mobile-health-stat .mobile-stat-number {
      font-size: 24px;
      font-weight: 900;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .mobile-health-stat .mobile-stat-label {
      font-size: 13px;
      font-weight: 700;
      color: rgba(255, 255, 255, 1);
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.25);
    }
    
    /* å…¬å‘ŠåŒºåŸŸ */
    .mobile-announcement {
      background: linear-gradient(90deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-left: 4px solid #f59e0b;
    }
    
    .mobile-announcement-icon {
      font-size: 20px;
    }
    
    .mobile-announcement-text {
      flex: 1;
      font-size: 14px;
      color: #78350f;
    }
    
    /* èµ„è®¯å’Œèµ›äº‹åŒºåŸŸ */
    .mobile-section {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 14px;
      margin-bottom: 14px;
      box-shadow: var(--shadow-md);
    }
    
    .mobile-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .mobile-section-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.2px;
    }
    
    .mobile-section-title h3 {
      font-size: 14px;
      font-weight: 700;
    }
    
    .mobile-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 14px;
      border-bottom: 2px solid var(--border-light);
    }
    
    .mobile-tab {
      padding: 6px 10px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .mobile-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    
    .mobile-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .mobile-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: 10px;
      padding: 12px;
      transition: all 0.2s;
    }
    
    .mobile-card:active {
      transform: scale(0.98);
      background: var(--bg-primary);
    }
    
    .mobile-card-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
      line-height: 1.5;
    }
    
    .mobile-card-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 6px;
    }
    
    .mobile-card-tags {
      display: flex;
      gap: 5px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    
    .mobile-tag {
      background: var(--primary-50);
      color: var(--primary);
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
    }
    
    /* ç´§å‡‘å¸ƒå±€æ ·å¼ - ç”¨äºé¸½å­å’Œæ¯”èµ›ç•Œé¢ */
    .mobile-view-compact .mobile-section {
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 12px;
    }
    
    .mobile-view-compact .mobile-section-header {
      margin-bottom: 8px;
    }
    
    .mobile-view-compact .mobile-section-title {
      font-size: 12px;
      font-weight: 600;
    }
    
    .mobile-view-compact .mobile-list {
      gap: 6px;
    }
    
    .mobile-view-compact .mobile-card {
      padding: 8px 10px;
      border-radius: 8px;
    }
    
    .mobile-view-compact .mobile-card-title {
      font-size: 11px;
      margin-bottom: 4px;
      line-height: 1.4;
    }
    
    .mobile-view-compact .mobile-card-meta {
      gap: 8px;
      font-size: 10px;
      margin-top: 4px;
    }
    
    .mobile-view-compact .mobile-tabs {
      margin-bottom: 8px;
    }
    
    .mobile-view-compact .mobile-tab {
      padding: 4px 8px;
      font-size: 11px;
    }
    
    /* è¡¨æ ¼è§†å›¾æ ·å¼ */
    .mobile-table-view {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-top: 8px;
    }
    
    .mobile-table {
      width: 100%;
      min-width: 700px;
      border-collapse: collapse;
      font-size: 12px;
      background: var(--bg-secondary);
    }
    
    .mobile-table thead {
      background: var(--bg-primary);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .mobile-table th {
      padding: 8px 6px;
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 11px;
      border-bottom: 2px solid var(--border-light);
      white-space: nowrap;
    }
    
    .mobile-table td {
      padding: 8px 6px;
      border-bottom: 1px solid var(--border-light);
      color: var(--text-secondary);
      font-size: 11px;
      white-space: nowrap;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .mobile-table tbody tr {
      transition: background 0.2s;
      cursor: pointer;
    }
    
    .mobile-table tbody tr:hover {
      background: var(--bg-primary);
    }
    
    .mobile-table tbody tr:active {
      background: var(--bg-primary);
      opacity: 0.8;
    }
    
    .mobile-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .mobile-view-compact .mobile-table-view {
      margin-top: 6px;
    }
    
    .mobile-view-compact .mobile-table th,
    .mobile-view-compact .mobile-table td {
      padding: 6px 4px;
      font-size: 10px;
    }
    
    .tag-alive {
      background: #d1fae5;
      color: #047857;
    }
    
    .tag-dead {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .mobile-view-switch {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    
    .mobile-view-switch-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: var(--text-secondary);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    
    .mobile-view-switch-btn.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    
    .mobile-view-compact .mobile-view-switch-btn {
      background: var(--bg-primary);
      border: 1px solid var(--border-light);
    }
    
    .mobile-view-compact .mobile-view-switch-btn.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    
    /* åº•éƒ¨å¯¼èˆªæ  - ç¡®ä¿åœ¨æ‰€æœ‰å…ƒç´ ä¹‹ä¸Šï¼ŒåŒ…æ‹¬PCè­¦å‘Šå¼¹çª— */
    .mobile-bottom-nav {
      position: fixed !important;
      bottom: 0 !important;
      left: 0 !important;
      right: 0 !important;
      background: #fff !important;
      border-top: 1px solid var(--border-light) !important;
      display: flex !important;
      justify-content: space-around !important;
      padding: 8px 0 !important;
      z-index: 999999 !important; /* ç¡®ä¿åœ¨æ‰€æœ‰å…ƒç´ ä¹‹ä¸Šï¼ŒåŒ…æ‹¬PCè­¦å‘Šå¼¹çª— */
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1) !important;
      pointer-events: auto !important;
    }
    
    /* ç¡®ä¿åº•éƒ¨èœå•å³ä½¿åœ¨PCè­¦å‘Šå¼¹çª—æ˜¾ç¤ºæ—¶ä¹Ÿèƒ½ç‚¹å‡» */
    @media (min-width: 769px) and (hover: hover) and (pointer: fine) {
      .mobile-bottom-nav {
        z-index: 100000 !important; /* PCä¸Šç¡®ä¿åœ¨PCè­¦å‘Šå¼¹çª—ä¹‹ä¸Š */
      }
    }
    
    .mobile-nav-item {
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
      gap: 4px !important;
      padding: 8px 16px !important;
      background: transparent !important;
      border: none !important;
      color: var(--text-secondary) !important;
      font-size: 12px !important;
      cursor: pointer !important;
      transition: all 0.2s !important;
      flex: 1 !important;
      pointer-events: auto !important;
      touch-action: manipulation !important;
      -webkit-tap-highlight-color: rgba(37, 99, 235, 0.3) !important;
      user-select: none !important;
      -webkit-user-select: none !important;
      position: relative !important;
      z-index: 999999 !important;
    }
    
    .mobile-nav-item.active {
      color: var(--primary);
    }
    
    .mobile-nav-icon {
      font-size: 18px;
    }
    
    /* åŠ è½½çŠ¶æ€ */
    .mobile-loading {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    
    .mobile-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    
    /* PCç«¯æç¤º - é»˜è®¤å®Œå…¨éšè—ï¼Œé¿å…åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šé®æŒ¡å†…å®¹ */
    .pc-warning {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: -1 !important; /* ç§»åŠ¨è®¾å¤‡ä¸Šè®¾ç½®ä¸º-1ï¼Œé¿å…é®æŒ¡ */
      align-items: center;
      justify-content: center;
      padding: 20px;
      pointer-events: none !important; /* ç§»åŠ¨è®¾å¤‡ä¸Šç¦ç”¨äº¤äº’ */
    }
    
    /* åªåœ¨çœŸæ­£çš„PCè®¾å¤‡ï¼ˆéè§¦æ‘¸è®¾å¤‡ï¼Œå®½åº¦å¤§äº769pxï¼‰ä¸Šæ˜¾ç¤º */
    @media (min-width: 769px) and (hover: hover) and (pointer: fine) {
      .pc-warning {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        z-index: 10000 !important; /* PCä¸Šæ­£å¸¸æ˜¾ç¤ºï¼Œä½†ä½äºåº•éƒ¨èœå• */
        pointer-events: auto !important; /* PCä¸Šå¯ç”¨äº¤äº’ */
      }
    }
    
    /* ç§»åŠ¨è®¾å¤‡ä¸Šå¼ºåˆ¶éšè—ï¼ˆå¤šé‡ä¿éšœï¼‰ */
    @media (max-width: 768px), (hover: none), (pointer: coarse) {
      .pc-warning {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        z-index: -1 !important;
        pointer-events: none !important;
      }
    }
    
    .pc-warning-content {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      text-align: center;
      position: relative !important;
      z-index: 10001 !important; /* ç¡®ä¿å†…å®¹åœ¨é®ç½©å±‚ä¹‹ä¸Š */
      pointer-events: auto !important; /* ç¡®ä¿å†…å®¹å¯ä»¥ç‚¹å‡» */
    }
    
    .pc-warning-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 12px;
    }
    
    .pc-warning-text {
      color: var(--text-secondary);
      margin-bottom: 20px;
    }
    
    .pc-warning-btn {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      position: relative !important;
      z-index: 10002 !important; /* ç¡®ä¿æŒ‰é’®åœ¨æœ€ä¸Šå±‚ */
      pointer-events: auto !important; /* ç¡®ä¿æŒ‰é’®å¯ä»¥ç‚¹å‡» */
      touch-action: manipulation !important;
      -webkit-tap-highlight-color: rgba(37, 99, 235, 0.3) !important;
      user-select: none !important;
      -webkit-user-select: none !important;
    }
    
    .pc-warning-btn:hover {
      opacity: 0.9;
    }
    
    .pc-warning-btn:active {
      transform: scale(0.98);
    }
    
    /* è§†å›¾å®¹å™¨ */
    .mobile-view {
      width: 100%;
      min-height: calc(100vh - 140px);
      display: none; /* é»˜è®¤éšè—æ‰€æœ‰è§†å›¾ */
    }
    
    /* é¦–é¡µè§†å›¾é»˜è®¤æ˜¾ç¤ºï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰ */
    #homeView,
    div#homeView,
    .mobile-view#homeView,
    div#homeView.mobile-view {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      min-height: 600px !important;
      height: auto !important;
      position: relative !important;
      width: 100% !important;
    }
    
    /* ç§»åŠ¨ç«¯å¼ºåˆ¶æ˜¾ç¤ºè§„åˆ™ï¼ˆç¡®ä¿åœ¨æ‰€æœ‰ç§»åŠ¨è®¾å¤‡ä¸Šå¯è§ï¼‰ */
    @media (max-width: 768px), (hover: none), (pointer: coarse) {
      body {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        pointer-events: auto !important;
      }
      
      .mobile-content {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        pointer-events: auto !important;
      }
      
      #homeView {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        height: auto !important;
        min-height: 600px !important;
        pointer-events: auto !important;
      }
      
      /* ç§»åŠ¨è®¾å¤‡ä¸Šï¼šéšè—å…¶ä»–è§†å›¾ï¼Œä½†å¼ºåˆ¶æ˜¾ç¤ºhomeView */
      .mobile-view:not(#homeView) {
        display: none !important;
      }
      
      /* å¼ºåˆ¶æ˜¾ç¤ºhomeViewï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼Œè¦†ç›–æ‰€æœ‰è§„åˆ™ï¼‰ */
      #homeView,
      div#homeView,
      .mobile-view#homeView,
      div#homeView.mobile-view,
      #homeView.mobile-view {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        min-height: 600px !important;
        height: auto !important;
        width: 100% !important;
        z-index: 1 !important;
      }
      
      /* ç¡®ä¿æ‰€æœ‰æŒ‰é’®å¯ç‚¹å‡» */
      button, .btn, .btn-icon, .mobile-nav-item, .mobile-card, .mobile-tab {
        pointer-events: auto !important;
        cursor: pointer !important;
        touch-action: manipulation !important;
        -webkit-tap-highlight-color: rgba(37, 99, 235, 0.3) !important;
        user-select: none !important;
        -webkit-user-select: none !important;
      }
    }
    
    /* PCç«¯æ‰“å¼€ç§»åŠ¨ç«¯é¡µé¢æ—¶ä¹Ÿå¼ºåˆ¶æ˜¾ç¤ºï¼ˆç¡®ä¿å…¼å®¹æ€§ï¼‰ */
    @media (min-width: 769px) {
      body {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        pointer-events: auto !important;
      }
      
      .mobile-content {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        pointer-events: auto !important;
      }
      
      #homeView {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
        pointer-events: auto !important;
      }
      
      /* PCç«¯æŒ‰é’®ä¹Ÿè¦å¯ç‚¹å‡» */
      button, .btn, .btn-icon, .mobile-nav-item, .mobile-card, .mobile-tab {
        pointer-events: auto !important;
        cursor: pointer !important;
        user-select: none !important;
      }
    }
    
    /* è§¦æ‘¸è®¾å¤‡å¼ºåˆ¶æ˜¾ç¤º */
    @media (hover: none) and (pointer: coarse) {
      #homeView {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      .mobile-content {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
    }
    
    /* æŒ‰é’®æ ·å¼ */
    .btn-primary {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    /* æ¨¡æ€æ¡†æ ·å¼ */
    .mobile-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 2000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }

    .mobile-modal-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .mobile-modal-content {
      position: relative;
      background: var(--bg-secondary);
      width: 100%;
      max-height: 90vh;
      border-radius: 16px 16px 0 0;
      display: flex;
      flex-direction: column;
      z-index: 2001;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }

    .mobile-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid var(--border-light);
      position: sticky;
      top: 0;
      background: var(--bg-secondary);
      z-index: 10;
    }

    .mobile-modal-header h2 {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .mobile-modal-close {
      background: transparent;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .mobile-modal-close:active {
      background: var(--bg-primary);
    }

    .mobile-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      -webkit-overflow-scrolling: touch;
    }

    /* è¡¨å•æ ·å¼ */
    .mobile-form-section {
      margin-bottom: 24px;
    }

    .mobile-form-section-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .mobile-form-desc {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .mobile-form-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .mobile-form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .mobile-form-group label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .mobile-form-group .required {
      color: #ef4444;
      margin-left: 4px;
    }

    .mobile-form-group input,
    .mobile-form-group select {
      padding: 10px 12px;
      border: 1px solid var(--border-light);
      border-radius: 8px;
      font-size: 14px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      width: 100%;
      box-sizing: border-box;
    }

    .mobile-form-group input:focus,
    .mobile-form-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .mobile-form-hint {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .mobile-radio-group {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .mobile-radio-group label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 400;
      cursor: pointer;
    }

    .mobile-radio-group input[type="radio"] {
      width: auto;
      margin: 0;
    }

    .mobile-radio-group input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    /* å‚èµ›è®°å½•é¡¹æ ·å¼ */
    .mobile-race-item {
      background: var(--bg-primary);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .mobile-race-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-light);
    }

    .mobile-race-item-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .mobile-race-item-delete {
      background: #ef4444;
      color: #fff;
      border: none;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }

    .mobile-race-item-fields {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .mobile-race-item-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .mobile-race-item-field label {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .mobile-race-item-field input {
      padding: 8px 10px;
      border: 1px solid var(--border-light);
      border-radius: 6px;
      font-size: 13px;
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    /* æ™ºèƒ½æœç´¢æ ·å¼ */
    .mobile-smart-search {
      position: relative;
      margin-bottom: 12.8px;
    }

    .mobile-smart-search-input {
      width: 100%;
      padding: 9.6px 12.8px;
      border: 1px solid var(--border-light);
      border-radius: 9.6px;
      font-size: 11.2px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      outline: none;
    }

    .mobile-smart-search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2.4px rgba(37, 99, 235, 0.1);
    }

    .mobile-search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: 9.6px;
      box-shadow: var(--shadow-lg);
      margin-top: 6.4px;
      max-height: 240px;
      overflow-y: auto;
      display: none;
      z-index: 1000;
    }

    .mobile-search-suggestions.show {
      display: block;
    }

    .mobile-search-suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .mobile-search-suggestion-item:hover {
      background: var(--bg-primary);
    }

    .mobile-search-suggestion-item:last-child {
      border-bottom: none;
    }

    /* å¿«é€Ÿé“¾æ¥æŒ‰é’® */
    .mobile-quick-links {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .mobile-quick-link-btn {
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: var(--shadow-sm);
    }

    .mobile-quick-link-btn:active {
      transform: scale(0.98);
      box-shadow: none;
    }

    .mobile-quick-link-btn span:first-child {
      font-size: 24px;
    }

    .mobile-quick-link-btn span:last-child {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
    }
  </style>
</head>
<body>
  <!-- PCç«¯è®¿é—®æç¤º -->
  <div class="pc-warning" id="pcWarning">
    <div class="pc-warning-content">
      <div class="pc-warning-title">ğŸ“± ç§»åŠ¨ç«¯é¡µé¢</div>
      <div class="pc-warning-text">è¿™æ˜¯ä¸“ä¸ºç§»åŠ¨è®¾å¤‡ä¼˜åŒ–çš„é¡µé¢ã€‚å¦‚æœæ‚¨åœ¨PCä¸Šè®¿é—®ï¼Œå»ºè®®ä½¿ç”¨æ¡Œé¢ç‰ˆé¡µé¢ã€‚</div>
      <button class="pc-warning-btn" id="pcWarningBtnDesktop" style="margin-bottom: 8px;">å‰å¾€æ¡Œé¢ç‰ˆ</button>
      <button class="pc-warning-btn" id="pcWarningBtnMobile" style="background: var(--text-secondary);">ç»§ç»­ä½¿ç”¨ç§»åŠ¨ç‰ˆ</button>
    </div>
  </div>
  
  <!-- ğŸ”§ ç§»åŠ¨è®¾å¤‡è‡ªåŠ¨éšè—PCè­¦å‘Šè„šæœ¬ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ - åœ¨é¡µé¢åŠ è½½å‰æ‰§è¡Œï¼‰ -->
  <script>
    (function() {
      'use strict';
      // ç«‹å³æ£€æµ‹å¹¶éšè—PCè­¦å‘Šï¼ˆåœ¨DOMåŠ è½½å‰å°±æ‰§è¡Œï¼‰
      function hidePcWarningImmediately() {
        // æ£€æµ‹æ˜¯å¦æ˜¯ç§»åŠ¨è®¾å¤‡
        const isMobileDevice = /Mobile|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        const viewportWidth = window.innerWidth || document.documentElement.clientWidth || 0;
        const hasHover = window.matchMedia('(hover: hover)').matches;
        const hasFinePointer = window.matchMedia('(pointer: fine)').matches;
        
        // åˆ¤æ–­æ˜¯å¦æ˜¯çœŸæ­£çš„PCè®¾å¤‡ï¼ˆéœ€è¦åŒæ—¶æ»¡è¶³ï¼šå®½åº¦>769px + æœ‰hover + ç²¾ç¡®æŒ‡é’ˆï¼‰
        const isRealPC = viewportWidth >= 769 && hasHover && hasFinePointer;
        
        // å¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡ã€è§¦æ‘¸è®¾å¤‡ï¼Œæˆ–è§†å£å®½åº¦å°äº769pxï¼Œå¼ºåˆ¶éšè—è­¦å‘Š
        if (isMobileDevice || isTouchDevice || viewportWidth < 769 || !isRealPC) {
          // ä½¿ç”¨å¤šç§æ–¹æ³•ç¡®ä¿éšè—ï¼ˆæœ€å¼ºåŠ›ï¼‰
          const pcWarning = document.getElementById('pcWarning');
          if (pcWarning) {
            // ä½¿ç”¨setPropertyè®¾ç½®!importantä¼˜å…ˆçº§
            pcWarning.style.setProperty('display', 'none', 'important');
            pcWarning.style.setProperty('visibility', 'hidden', 'important');
            pcWarning.style.setProperty('opacity', '0', 'important');
            pcWarning.style.setProperty('pointer-events', 'none', 'important');
            pcWarning.style.setProperty('z-index', '-1', 'important'); // è®¾ç½®ä¸º-1é¿å…é®æŒ¡
            pcWarning.style.setProperty('position', 'fixed', 'important');
            
            // åŒæ—¶è®¾ç½®å†…è”æ ·å¼ï¼ˆåŒé‡ä¿éšœï¼‰
            pcWarning.setAttribute('style', 
              'display: none !important; ' +
              'visibility: hidden !important; ' +
              'opacity: 0 !important; ' +
              'pointer-events: none !important; ' +
              'z-index: -1 !important; ' +
              'position: fixed !important;'
            );
            
            console.log('âœ… [PCè­¦å‘Šéšè—] å·²å¼ºåˆ¶éšè—PCè­¦å‘Šå¼¹çª—ï¼ˆç§»åŠ¨è®¾å¤‡ï¼‰');
          }
        } else {
          // PCè®¾å¤‡ä¸Šæ­£å¸¸æ˜¾ç¤º
          const pcWarning = document.getElementById('pcWarning');
          if (pcWarning) {
            pcWarning.style.setProperty('display', 'flex', 'important');
            pcWarning.style.setProperty('visibility', 'visible', 'important');
            pcWarning.style.setProperty('opacity', '1', 'important');
            pcWarning.style.setProperty('pointer-events', 'auto', 'important');
            pcWarning.style.setProperty('z-index', '10000', 'important');
            console.log('âœ… [PCè­¦å‘Šæ˜¾ç¤º] PCè®¾å¤‡ä¸Šæ­£å¸¸æ˜¾ç¤ºè­¦å‘Šå¼¹çª—');
          }
        }
      }
      
      // ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼ˆå¦‚æœå…ƒç´ å·²å­˜åœ¨ï¼‰
      hidePcWarningImmediately();
      
      // DOMåŠ è½½åç«‹å³æ‰§è¡Œå¤šæ¬¡ï¼Œç¡®ä¿è¦†ç›–æ‰€æœ‰å¯èƒ½çš„æ˜¾ç¤º
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          hidePcWarningImmediately();
          // å»¶è¿Ÿå¤šæ¬¡æ‰§è¡Œï¼Œç¡®ä¿è¦†ç›–æ‰€æœ‰å¯èƒ½çš„æ˜¾ç¤º
          setTimeout(hidePcWarningImmediately, 0);
          setTimeout(hidePcWarningImmediately, 10);
          setTimeout(hidePcWarningImmediately, 50);
          setTimeout(hidePcWarningImmediately, 100);
          setTimeout(hidePcWarningImmediately, 200);
          setTimeout(hidePcWarningImmediately, 500);
        });
      } else {
        hidePcWarningImmediately();
        setTimeout(hidePcWarningImmediately, 0);
        setTimeout(hidePcWarningImmediately, 10);
        setTimeout(hidePcWarningImmediately, 50);
        setTimeout(hidePcWarningImmediately, 100);
        setTimeout(hidePcWarningImmediately, 200);
        setTimeout(hidePcWarningImmediately, 500);
      }
      
      // ç›‘å¬çª—å£å¤§å°å˜åŒ–å’Œå±å¹•æ—‹è½¬
      window.addEventListener('resize', function() {
        setTimeout(hidePcWarningImmediately, 0);
        setTimeout(hidePcWarningImmediately, 100);
      });
      window.addEventListener('orientationchange', function() {
        setTimeout(hidePcWarningImmediately, 0);
        setTimeout(hidePcWarningImmediately, 50);
        setTimeout(hidePcWarningImmediately, 200);
        setTimeout(hidePcWarningImmediately, 500);
      });
      
      // ä½¿ç”¨MutationObserverç›‘å¬pcWarningå…ƒç´ çš„å˜åŒ–ï¼ˆå¦‚æœè¢«å…¶ä»–è„šæœ¬æ˜¾ç¤ºï¼Œç«‹å³éšè—ï¼‰
      if (document.body) {
        const observer = new MutationObserver(function(mutations) {
          // æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–å¯¼è‡´å¼¹çª—æ˜¾ç¤º
          const pcWarning = document.getElementById('pcWarning');
          if (pcWarning) {
            const computedStyle = window.getComputedStyle(pcWarning);
            const isMobileDevice = /Mobile|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            const viewportWidth = window.innerWidth || document.documentElement.clientWidth || 0;
            
            // å¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡ä¸”å¼¹çª—è¢«æ˜¾ç¤ºï¼Œç«‹å³éšè—
            if ((isMobileDevice || isTouchDevice || viewportWidth < 769) && 
                (computedStyle.display !== 'none' || computedStyle.visibility !== 'hidden')) {
              console.warn('âš ï¸ [PCè­¦å‘Šéšè—] æ£€æµ‹åˆ°å¼¹çª—è¢«æ˜¾ç¤ºï¼Œç«‹å³å¼ºåˆ¶éšè—');
              hidePcWarningImmediately();
            }
          }
        });
        
        // ç­‰å¾…pcWarningå…ƒç´ å‡ºç°
        function startObserving() {
          const pcWarning = document.getElementById('pcWarning');
          if (pcWarning) {
            observer.observe(pcWarning, {
              attributes: true,
              attributeFilter: ['style', 'class'],
              childList: false,
              subtree: false
            });
            hidePcWarningImmediately();
            console.log('âœ… [PCè­¦å‘Šéšè—] MutationObserverå·²å¯åŠ¨ï¼Œç›‘å¬å¼¹çª—å˜åŒ–');
          } else {
            setTimeout(startObserving, 100);
          }
        }
        
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', startObserving);
        } else {
          startObserving();
        }
      }
      
      // é¡µé¢å®Œå…¨åŠ è½½åå†æ¬¡æ£€æŸ¥
      window.addEventListener('load', function() {
        setTimeout(hidePcWarningImmediately, 0);
        setTimeout(hidePcWarningImmediately, 100);
        setTimeout(hidePcWarningImmediately, 500);
      });
      
      // ğŸ”¥ æ·»åŠ PCè­¦å‘Šå¼¹çª—æŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†ï¼ˆç¡®ä¿æŒ‰é’®å¯ä»¥ç‚¹å‡»ï¼‰
      function setupPcWarningButtons() {
        const btnDesktop = document.getElementById('pcWarningBtnDesktop');
        const btnMobile = document.getElementById('pcWarningBtnMobile');
        const pcWarning = document.getElementById('pcWarning');
        
        // å‰å¾€æ¡Œé¢ç‰ˆæŒ‰é’®
        if (btnDesktop) {
          // ç§»é™¤æ—§çš„onclickï¼Œä½¿ç”¨addEventListenerï¼ˆæ›´å¯é ï¼‰
          btnDesktop.onclick = null;
          btnDesktop.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('âœ… [PCè­¦å‘Š] ç‚¹å‡»äº†"å‰å¾€æ¡Œé¢ç‰ˆ"æŒ‰é’®');
            window.location.href = 'index.html';
          }, true); // ä½¿ç”¨æ•è·é˜¶æ®µï¼Œç¡®ä¿ä¼˜å…ˆæ‰§è¡Œ
          
          // åŒæ—¶è®¾ç½®onclickä½œä¸ºå¤‡ç”¨
          btnDesktop.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            window.location.href = 'index.html';
          };
        }
        
        // ç»§ç»­ä½¿ç”¨ç§»åŠ¨ç‰ˆæŒ‰é’®
        if (btnMobile && pcWarning) {
          // ç§»é™¤æ—§çš„onclickï¼Œä½¿ç”¨addEventListenerï¼ˆæ›´å¯é ï¼‰
          btnMobile.onclick = null;
          btnMobile.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('âœ… [PCè­¦å‘Š] ç‚¹å‡»äº†"ç»§ç»­ä½¿ç”¨ç§»åŠ¨ç‰ˆ"æŒ‰é’®');
            
            // ä½¿ç”¨æœ€å¼ºåŠ›çš„æ–¹æ³•éšè—å¼¹çª—
            pcWarning.style.setProperty('display', 'none', 'important');
            pcWarning.style.setProperty('visibility', 'hidden', 'important');
            pcWarning.style.setProperty('opacity', '0', 'important');
            pcWarning.style.setProperty('pointer-events', 'none', 'important');
            pcWarning.style.setProperty('z-index', '-1', 'important');
            
            // åŒæ—¶è®¾ç½®å†…è”æ ·å¼ï¼ˆåŒé‡ä¿éšœï¼‰
            pcWarning.setAttribute('style', 
              'display: none !important; ' +
              'visibility: hidden !important; ' +
              'opacity: 0 !important; ' +
              'pointer-events: none !important; ' +
              'z-index: -1 !important; ' +
              'position: fixed !important;'
            );
            
            console.log('âœ… [PCè­¦å‘Š] å¼¹çª—å·²å…³é—­');
          }, true); // ä½¿ç”¨æ•è·é˜¶æ®µï¼Œç¡®ä¿ä¼˜å…ˆæ‰§è¡Œ
          
          // åŒæ—¶è®¾ç½®onclickä½œä¸ºå¤‡ç”¨
          btnMobile.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            pcWarning.style.setProperty('display', 'none', 'important');
            pcWarning.style.setProperty('visibility', 'hidden', 'important');
            pcWarning.style.setProperty('opacity', '0', 'important');
            pcWarning.style.setProperty('pointer-events', 'none', 'important');
            pcWarning.style.setProperty('z-index', '-1', 'important');
          };
        }
        
        console.log('âœ… [PCè­¦å‘Š] æŒ‰é’®ç‚¹å‡»äº‹ä»¶å·²è®¾ç½®');
      }
      
      // DOMåŠ è½½åè®¾ç½®æŒ‰é’®
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          setupPcWarningButtons();
          setTimeout(setupPcWarningButtons, 100);
          setTimeout(setupPcWarningButtons, 500);
        });
      } else {
        setupPcWarningButtons();
        setTimeout(setupPcWarningButtons, 100);
        setTimeout(setupPcWarningButtons, 500);
      }
      
      // é¡µé¢å®Œå…¨åŠ è½½åå†æ¬¡è®¾ç½®
      window.addEventListener('load', function() {
        setupPcWarningButtons();
        setTimeout(setupPcWarningButtons, 100);
        setTimeout(setupPcWarningButtons, 500);
      });
    })();
  </script>

  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <div class="mobile-header">
    <div>
      <h1>æ™ºé¸½ï½œPigeonAI</h1>
      <div style="font-size: 9px; color: rgba(248, 250, 252, 0.9); margin-top: 2px; white-space: nowrap;">
        æ¯åªé¸½å­ï¼Œçš†æ˜¯èµ›çº§ ï½œEvery Pigeon, Race-Grade
      </div>
    </div>
    <div class="mobile-header-actions">
      <button class="btn-icon" onclick="showUserInfoModal()" title="ç”¨æˆ·">
        <span class="btn-icon-emoji">ğŸ‘¤</span>
        <span class="btn-icon-text">è´¦æˆ·</span>
      </button>
      <button class="btn-icon" onclick="showSettingsModal()" title="è®¾ç½®">
        <span class="btn-icon-emoji">âš™ï¸</span>
        <span class="btn-icon-text">è®¾ç½®</span>
      </button>
    </div>
  </div>

  <!-- ä¸»å†…å®¹åŒº -->
  <div class="mobile-content" style="display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 100vh !important; position: relative !important; z-index: 1 !important;">
    <!-- é¦–é¡µè§†å›¾ -->
    <div id="homeView" class="mobile-view" style="display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 600px !important; height: auto !important; position: relative !important; z-index: 1 !important;">
    <!-- æ—¥æœŸå’Œå¤©æ°”æ¦‚è§ˆ -->
    <div class="mobile-overview">
      <div class="mobile-overview-top">
        <div class="mobile-date">
          <div class="mobile-date-day" id="mobileDay">22</div>
          <div class="mobile-date-info">
            <div class="mobile-date-weekday" id="mobileWeekday">æ˜ŸæœŸä¸€</div>
            <div class="mobile-date-full" id="mobileDateFull">2025å¹´12æœˆ</div>
          </div>
        </div>
        <div class="mobile-weather" id="mobileWeather">
          <span class="mobile-weather-icon">â˜€ï¸</span>
          <div>
            <div class="mobile-weather-text">æ™´æœ—</div>
            <div style="font-size: 11px; opacity: 0.8;">é€‚åˆæ”¾é£</div>
          </div>
        </div>
      </div>
      
      <!-- è‡ªåŠ¨å°ç»“ä¸å¾…åŠæé†’ -->
      <div class="mobile-auto-summary-card" id="mobileAutoSummary" style="margin-top: 12px; padding: 10px 12px; border-radius: 10px; background: linear-gradient(135deg, #eef2ff, #e0f2fe); color: #1f2933; box-shadow: 0 3px 10px rgba(15,23,42,0.08); border: 1px solid rgba(148, 163, 184, 0.35);">
        <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px; color: #4b5563;">æœ¬å‘¨Evoè§‚å¯Ÿ</div>
        <div id="mobileAutoSummaryText" style="font-size: 12px; font-weight: 500; color: #111827;">
          æ­£åœ¨æ ¹æ®ä½ çš„é¸½èˆæ•°æ®ç”Ÿæˆç®€çŸ­åˆ†æ...
        </div>
        <div id="mobileAutoTodoHint" style="font-size: 11px; opacity: 0.85; margin-top: 4px; color: #374151;">
          å°†è‡ªåŠ¨æé†’ï¼šä¸´è¿‘æ¯”èµ›ã€å¥åº·åˆ°æœŸã€è®­ç»ƒç¼ºå¤±ç­‰äº‹é¡¹ã€‚
        </div>
      </div>
      
      <!-- åŠŸèƒ½æ¨¡å—ç»Ÿè®¡å¡ç‰‡ - ç¡®ä¿å¯è§ -->
      <div class="mobile-stats" id="mobileStats">
        <div class="mobile-stat-item">
          <span class="mobile-stat-icon">ğŸ“°</span>
          <div class="mobile-stat-content">
            <div class="mobile-stat-number" id="statNews">0</div>
            <div class="mobile-stat-label">ä»Šæ—¥èµ„è®¯</div>
          </div>
        </div>
        <div class="mobile-stat-item">
          <span class="mobile-stat-icon">ğŸ</span>
          <div class="mobile-stat-content">
            <div class="mobile-stat-number" id="statRaces">0</div>
            <div class="mobile-stat-label">è¿›è¡Œä¸­èµ›äº‹</div>
          </div>
        </div>
        <div class="mobile-stat-item">
          <span class="mobile-stat-icon">ğŸ†</span>
          <div class="mobile-stat-content">
            <div class="mobile-stat-number" id="statResults">0</div>
            <div class="mobile-stat-label">å·²å…¬å¸ƒæˆç»©</div>
          </div>
        </div>
        <div class="mobile-stat-item">
          <span class="mobile-stat-icon">ğŸ•Šï¸</span>
          <div class="mobile-stat-content">
            <div class="mobile-stat-number" id="statPigeons">0</div>
            <div class="mobile-stat-label">æˆ‘çš„é¸½å­</div>
          </div>
        </div>
      </div>
    </div>

    <!-- å…¬å‘Š -->
    <div class="mobile-announcement" id="mobileAnnouncement" style="display:none;">
      <span class="mobile-announcement-icon">ğŸ“¢</span>
      <div class="mobile-announcement-text" id="mobileAnnouncementText">æš‚æ— å…¬å‘Š</div>
    </div>

    <!-- å…¬å‘Šæ  -->
    <div class="mobile-announcement" id="mobileAnnouncementMain">
      <span class="mobile-announcement-icon">ğŸ“¢</span>
      <div class="mobile-announcement-text" id="mobileAnnouncementMainText">æš‚æ— å…¬å‘Š</div>
    </div>

    <!-- æ™ºèƒ½æœç´¢ -->
    <div class="mobile-smart-search">
      <input type="text" id="mobileSmartSearchInput" class="mobile-smart-search-input" placeholder="ğŸ” æ™ºèƒ½æœç´¢: å¦‚ '2022 å…¬é¸½ è¿›å¥–' æˆ–è¶³ç¯å·..." />
      <div id="mobileSearchSuggestions" class="mobile-search-suggestions"></div>
    </div>

    <!-- èµ›é¸½èµ„è®¯ -->
    <div class="mobile-section">
      <div class="mobile-section-header">
        <h2 class="mobile-section-title">ğŸ“° èµ›é¸½èµ„è®¯</h2>
      </div>
      <div class="mobile-tabs">
        <button class="mobile-tab active" data-region="local" onclick="switchNewsRegion('local')">ğŸ“ æœ¬åœ°</button>
        <button class="mobile-tab" data-region="national" onclick="switchNewsRegion('national')">ğŸŒ å…¨å›½</button>
      </div>
      <div class="mobile-tabs">
        <button class="mobile-tab active" data-filter="all" onclick="switchNewsFilter('all')">å…¨éƒ¨</button>
        <button class="mobile-tab" data-filter="race" onclick="switchNewsFilter('race')">èµ›äº‹</button>
        <button class="mobile-tab" data-filter="breeding" onclick="switchNewsFilter('breeding')">è‚²ç§</button>
        <button class="mobile-tab" data-filter="health" onclick="switchNewsFilter('health')">å¥åº·</button>
      </div>
      <div class="mobile-list" id="mobileNewsList">
        <div class="mobile-loading">åŠ è½½ä¸­...</div>
      </div>
    </div>

    <!-- å®æ—¶èµ›äº‹ -->
    <div class="mobile-section">
      <div class="mobile-section-header">
        <h2 class="mobile-section-title">ğŸ å®æ—¶èµ›äº‹</h2>
      </div>
      <div class="mobile-tabs">
        <button class="mobile-tab active" data-tab="ongoing" onclick="switchEventTab('ongoing')">â± è¿›è¡Œä¸­</button>
        <button class="mobile-tab" data-tab="upcoming" onclick="switchEventTab('upcoming')">ğŸ“… å³å°†å¼€å§‹</button>
        <button class="mobile-tab" data-tab="results" onclick="switchEventTab('results')">ğŸ† æœ€æ–°æˆç»©</button>
      </div>
      <div class="mobile-list" id="mobileEventsList">
        <div class="mobile-loading">åŠ è½½ä¸­...</div>
      </div>
    </div>
    </div>
    <!-- é¦–é¡µè§†å›¾ç»“æŸ -->

    <!-- é¸½å­ç®¡ç†è§†å›¾ -->
    <div id="listView" class="mobile-view mobile-view-compact" style="display:none;">
      <div class="mobile-section">
        <div class="mobile-section-header">
          <h2 class="mobile-section-title">ğŸ•Šï¸ é¸½å­ç®¡ç†</h2>
          <div style="display: flex; gap: 8px; align-items: center;">
            <div class="mobile-view-switch">
              <button class="mobile-view-switch-btn active" id="pigeonViewCard" onclick="switchPigeonView('card')" title="å¡ç‰‡è§†å›¾">
                <span>ğŸ“‹</span>
                <span>å¡ç‰‡</span>
              </button>
              <button class="mobile-view-switch-btn" id="pigeonViewTable" onclick="switchPigeonView('table')" title="è¡¨æ ¼è§†å›¾">
                <span>ğŸ“Š</span>
                <span>è¡¨æ ¼</span>
              </button>
            </div>
            <button class="btn-icon" onclick="goToCreatePigeon()" style="background: var(--primary); color: #fff;">â•</button>
          </div>
        </div>
        <div id="pigeonListContainer">
          <div class="mobile-loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- æ¯”èµ›ç®¡ç†è§†å›¾ -->
    <div id="raceView" class="mobile-view mobile-view-compact" style="display:none;">
      <div class="mobile-section">
        <div class="mobile-section-header">
          <h2 class="mobile-section-title">ğŸ† æ¯”èµ›ä¸æˆç»©ç®¡ç†</h2>
          <button class="btn-icon" onclick="goToAddRace()" style="background: var(--primary); color: #fff;">â•</button>
        </div>
        <div class="mobile-tabs">
          <button class="mobile-tab active" data-race-tab="list" onclick="switchRaceTab('list')">ğŸ“‹ æ¯”èµ›åˆ—è¡¨</button>
          <button class="mobile-tab" data-race-tab="stats" onclick="switchRaceTab('stats')">ğŸ“Š æˆç»©ç»Ÿè®¡</button>
        </div>
        <div id="raceListContainer" class="mobile-list">
          <div class="mobile-loading">åŠ è½½ä¸­...</div>
        </div>
        <div id="raceStatsContainer" class="mobile-list" style="display:none;">
          <div class="mobile-loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- æ•°æ®ç»Ÿè®¡è§†å›¾ -->
    <div id="statsView" class="mobile-view" style="display:none;">
      <div class="mobile-section">
        <div class="mobile-section-header">
          <h2 class="mobile-section-title">ğŸ“Š æ•°æ®æ¦‚è§ˆ</h2>
        </div>
        <div class="mobile-stats" style="background: transparent; grid-template-columns: repeat(2, 1fr); gap: 12px; margin: 16px 0;">
          <div class="mobile-stat-item" style="background: var(--bg-secondary); border: 1px solid var(--border-light);">
            <span class="mobile-stat-icon">ğŸ“Š</span>
            <div class="mobile-stat-content">
              <div class="mobile-stat-number" id="statTotal" style="color: var(--primary);">0</div>
              <div class="mobile-stat-label" style="color: var(--text-secondary);">æ€»é¸½å­æ•°</div>
            </div>
          </div>
          <div class="mobile-stat-item" style="background: var(--bg-secondary); border: 1px solid var(--border-light);">
            <span class="mobile-stat-icon">ğŸ•Šï¸</span>
            <div class="mobile-stat-content">
              <div class="mobile-stat-number" id="statAlive" style="color: #059669;">0</div>
              <div class="mobile-stat-label" style="color: var(--text-secondary);">åœ¨ä¸–</div>
            </div>
          </div>
          <div class="mobile-stat-item" style="background: var(--bg-secondary); border: 1px solid var(--border-light);">
            <span class="mobile-stat-icon">ğŸ’”</span>
            <div class="mobile-stat-content">
              <div class="mobile-stat-number" id="statDead" style="color: #4b5563;">0</div>
              <div class="mobile-stat-label" style="color: var(--text-secondary);">å·²æ­»äº¡</div>
            </div>
          </div>
          <div class="mobile-stat-item" style="background: var(--bg-secondary); border: 1px solid var(--border-light);">
            <span class="mobile-stat-icon">ğŸ†</span>
            <div class="mobile-stat-content">
              <div class="mobile-stat-number" id="statRaced" style="color: #d97706;">0</div>
              <div class="mobile-stat-label" style="color: var(--text-secondary);">æœ‰æˆç»©</div>
            </div>
          </div>
        </div>
        <div id="statsContainer" class="mobile-list">
          <div class="mobile-empty">æš‚æ— ç»Ÿè®¡æ•°æ®</div>
        </div>

        <!-- å›¾è¡¨å±•ç¤º -->
        <div class="mobile-section" style="margin-top: 24px;">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title">ğŸ“ˆ æ•°æ®è¶‹åŠ¿</h3>
          </div>
          <div id="statsChartContainer" class="mobile-card" style="min-height: 200px; padding: 16px;">
            <div class="mobile-empty">å›¾è¡¨æ•°æ®åŠ è½½ä¸­...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- è¡€ç»Ÿå…³ç³»è§†å›¾ -->
    <div id="pedigreeView" class="mobile-view" style="display:none;">
      <div class="mobile-section">
        <div class="mobile-section-header">
          <h2 class="mobile-section-title">ğŸ§¬ è¡€ç»Ÿå…³ç³»æ ‘</h2>
          <button class="btn-icon" onclick="switchView('more')" style="background: var(--text-secondary); color: #fff;">â†</button>
        </div>
        <!-- æœç´¢æ¡† -->
        <div class="mobile-smart-search" style="margin-bottom: 12px;">
          <input type="text" id="pedigreeSearchInput" class="mobile-smart-search-input" placeholder="ğŸ” æœç´¢é¸½å­ï¼ˆè¶³ç¯å·æˆ–åå­—ï¼‰..." />
        </div>
        <div class="mobile-form-group" style="margin-bottom: 16px;">
          <select id="mp_pedigreeSelect" style="width: 100%;" onchange="selectPedigreePigeon()">
            <option value="">é€‰æ‹©é¸½å­æŸ¥çœ‹è¡€ç»Ÿæ ‘</option>
          </select>
        </div>
        <div id="mp_pedigreeTree" style="min-height: 300px; padding: 16px; background: var(--bg-primary); border-radius: 8px;">
          <div class="mobile-empty">è¯·ä»ä¸Šæ–¹ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©ä¸€åªé¸½å­ï¼ŒæŸ¥çœ‹å…¶å®Œæ•´è¡€ç»Ÿå…³ç³»æ ‘</div>
        </div>
      </div>
    </div>

    <!-- æ›´å¤šåŠŸèƒ½è§†å›¾ -->
    <div id="moreView" class="mobile-view" style="display:none;">
      <div class="mobile-section">
        <div class="mobile-section-header">
          <h2 class="mobile-section-title">âš™ï¸ æ›´å¤šåŠŸèƒ½</h2>
        </div>
        <div class="mobile-list">
          <div class="mobile-card" onclick="switchView('pedigree')">
            <div class="mobile-card-title">ğŸ§¬ è¡€ç»Ÿå…³ç³»</div>
            <div class="mobile-card-meta">æŸ¥çœ‹è¡€ç»Ÿæ ‘</div>
          </div>
          <div class="mobile-card" onclick="switchView('breeding')">
            <div class="mobile-card-title">ğŸ’• ç¹è‚²é…å¯¹</div>
            <div class="mobile-card-meta">é…å¯¹è¯„ä¼°å’Œç®¡ç†</div>
          </div>
          <div class="mobile-card" onclick="switchView('health')">
            <div class="mobile-card-title">ğŸ©º å¥åº·ç®¡ç†</div>
            <div class="mobile-card-meta">å¥åº·è®°å½•å’Œæé†’</div>
          </div>
          <div class="mobile-card" onclick="switchView('analysis')">
            <div class="mobile-card-title">ğŸ§  æ™ºèƒ½åˆ†æ</div>
            <div class="mobile-card-meta">AIæ™ºèƒ½åˆ†æ</div>
          </div>
          <div class="mobile-card" onclick="switchView('training')">
            <div class="mobile-card-title">ğŸƒ è®­ç»ƒæ¨¡å—</div>
            <div class="mobile-card-meta">è®­ç»ƒè®°å½•å’Œåˆ†æ</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç¹è‚²é…å¯¹è§†å›¾ -->
    <div id="breedingView" class="mobile-view" style="display:none;">
      <div class="mobile-section">
        <div class="mobile-section-header">
          <h2 class="mobile-section-title">ğŸ’• ç¹è‚²é…å¯¹</h2>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="btn-icon" onclick="askEvoWithContext && askEvoWithContext('breeding')" title="è®©Evoç»™å‡ºé…å¯¹å»ºè®®">
              <span class="btn-icon-emoji">ğŸ¤–</span>
              <span class="btn-icon-text">AIé…å¯¹</span>
            </button>
            <button class="btn-icon" onclick="switchView('more')" style="background: var(--text-secondary); color: #fff;">â†</button>
          </div>
        </div>
        
        <!-- å…¬é¸½é€‰æ‹© -->
        <div class="mobile-form-group">
          <label>â™‚ é€‰æ‹©å…¬é¸½</label>
          <select id="breedingMaleSelect" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-light);">
            <option value="">è¯·é€‰æ‹©å…¬é¸½...</option>
          </select>
        </div>

        <!-- æ¯é¸½é€‰æ‹© -->
        <div class="mobile-form-group">
          <label>â™€ é€‰æ‹©æ¯é¸½</label>
          <select id="breedingFemaleSelect" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-light);">
            <option value="">è¯·é€‰æ‹©æ¯é¸½...</option>
          </select>
        </div>

        <!-- é…å¯¹è¯„ä¼°ç»“æœ -->
        <div id="breedingAssessment" style="margin-top: 16px; padding: 16px; background: var(--bg-primary); border-radius: 12px; min-height: 200px;">
          <div style="text-align:center;padding:40px 20px;color:var(--text-secondary);">
            <div style="font-size:32px;margin-bottom:12px;">ğŸ”®</div>
            <p>è¯·å…ˆé€‰æ‹©å…¬é¸½å’Œæ¯é¸½</p>
            <p style="font-size:12px;">ç³»ç»Ÿå°†è‡ªåŠ¨åˆ†æè¿‘äº²é£é™©ä¸é…å¯¹å»ºè®®</p>
          </div>
        </div>

        <!-- ç¡®è®¤é…å¯¹æŒ‰é’® -->
        <button id="btnConfirmPairing" class="btn-primary" style="width: 100%; margin-top: 16px; padding: 14px; border-radius: 8px; border: none; font-size: 16px; font-weight: 600; background: var(--primary); color: #fff; cursor: pointer;" disabled>
          ğŸ’• ç¡®è®¤é…å¯¹
        </button>

        <!-- é…å¯¹å†å²è®°å½• -->
        <div class="mobile-section" style="margin-top: 24px;">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title">ğŸ“‹ é…å¯¹å†å²è®°å½•</h3>
          </div>
          <div id="pairingHistoryContainer" class="mobile-list">
            <div class="mobile-empty">æš‚æ— é…å¯¹è®°å½•</div>
          </div>
        </div>
      </div>
    </div>

    <!-- å¥åº·ç®¡ç†è§†å›¾ -->
    <div id="healthView" class="mobile-view" style="display:none;">
      <div class="mobile-section">
        <div class="mobile-section-header">
          <h2 class="mobile-section-title">ğŸ©º å¥åº·ç®¡ç†</h2>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="btn-icon" onclick="askEvoWithContext && askEvoWithContext('health')" title="è®©Evoåˆ†æå¥åº·çŠ¶å†µ">
              <span class="btn-icon-emoji">ğŸ¤–</span>
              <span class="btn-icon-text">AIåˆ†æ</span>
            </button>
            <button class="btn-icon" onclick="switchView('more')" style="background: var(--text-secondary); color: #fff;">â†</button>
          </div>
        </div>
        
        <!-- å¥åº·çŠ¶æ€æ¦‚è§ˆ -->
        <div class="mobile-stats" style="margin-bottom: 16px;">
          <div class="mobile-stat-item mobile-health-stat" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: 2px solid #047857; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">
            <span class="mobile-stat-icon" style="font-size: 28px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">âœ…</span>
            <div class="mobile-stat-content">
              <div class="mobile-stat-number" id="healthyCount" style="color: #ffffff; font-size: 32px; font-weight: 900; text-shadow: 0 2px 4px rgba(0,0,0,0.3); line-height: 1.2;">0</div>
              <div class="mobile-stat-label" style="color: #ffffff; font-size: 15px; font-weight: 700; text-shadow: 0 1px 3px rgba(0,0,0,0.25); margin-top: 6px;">å¥åº·çŠ¶æ€</div>
            </div>
          </div>
          <div class="mobile-stat-item mobile-health-stat" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: 2px solid #b45309; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);">
            <span class="mobile-stat-icon" style="font-size: 28px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">â°</span>
            <div class="mobile-stat-content">
              <div class="mobile-stat-number" id="upcomingCount" style="color: #ffffff; font-size: 32px; font-weight: 900; text-shadow: 0 2px 4px rgba(0,0,0,0.3); line-height: 1.2;">0</div>
              <div class="mobile-stat-label" style="color: #ffffff; font-size: 15px; font-weight: 700; text-shadow: 0 1px 3px rgba(0,0,0,0.25); margin-top: 6px;">å³å°†åˆ°æœŸ</div>
            </div>
          </div>
          <div class="mobile-stat-item mobile-health-stat" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: 2px solid #b91c1c; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);">
            <span class="mobile-stat-icon" style="font-size: 28px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">ğŸ¥</span>
            <div class="mobile-stat-content">
              <div class="mobile-stat-number" id="needAttentionCount" style="color: #ffffff; font-size: 32px; font-weight: 900; text-shadow: 0 2px 4px rgba(0,0,0,0.3); line-height: 1.2;">0</div>
              <div class="mobile-stat-label" style="color: #ffffff; font-size: 15px; font-weight: 700; text-shadow: 0 1px 3px rgba(0,0,0,0.25); margin-top: 6px;">éœ€è¦å…³æ³¨</div>
            </div>
          </div>
          <div class="mobile-stat-item mobile-health-stat" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); border: 2px solid #4338ca; box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);">
            <span class="mobile-stat-icon" style="font-size: 28px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">ğŸ’Š</span>
            <div class="mobile-stat-content">
              <div class="mobile-stat-number" id="medicatingCount" style="color: #ffffff; font-size: 32px; font-weight: 900; text-shadow: 0 2px 4px rgba(0,0,0,0.3); line-height: 1.2;">0</div>
              <div class="mobile-stat-label" style="color: #ffffff; font-size: 15px; font-weight: 700; text-shadow: 0 1px 3px rgba(0,0,0,0.25); margin-top: 6px;">ç”¨è¯ä¸­</div>
            </div>
          </div>
        </div>

        <!-- æ·»åŠ è®°å½•æŒ‰é’® -->
        <button class="btn-primary" onclick="showAddHealthRecord()" style="width: 100%; margin-bottom: 16px; padding: 16px; border-radius: 10px; border: none; font-size: 17px; font-weight: 700; background: var(--primary); color: #fff; cursor: pointer; box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3); letter-spacing: 0.3px;">
          ğŸ’‰ æ·»åŠ å¥åº·è®°å½•
        </button>

        <!-- å¥åº·æé†’ -->
        <div class="mobile-section">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title" style="font-size: 14px; font-weight: 700;">ğŸ”” å¥åº·æé†’</h3>
          </div>
          <div id="healthAlertsContainer" class="mobile-list">
            <div class="mobile-empty">æš‚æ— å¥åº·æé†’</div>
          </div>
        </div>

        <!-- å¥åº·è®°å½•åˆ—è¡¨ -->
        <div class="mobile-section">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title" style="font-size: 14px; font-weight: 700;">ğŸ“‹ å¥åº·è®°å½•</h3>
            <select id="healthPigeonSelect" onchange="filterHealthRecords()" style="padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border-light); font-size: 14px; font-weight: 500;">
              <option value="">å…¨éƒ¨é¸½å­</option>
            </select>
          </div>
          <div id="healthRecordsContainer" class="mobile-list">
            <div class="mobile-empty">æš‚æ— å¥åº·è®°å½•</div>
          </div>
        </div>
      </div>
    </div>

    <!-- è®­ç»ƒæ¨¡å—è§†å›¾ -->
    <div id="trainingView" class="mobile-view" style="display:none;">
      <div class="mobile-section">
        <div class="mobile-section-header">
          <h2 class="mobile-section-title">ğŸƒ è®­ç»ƒæ¨¡å—</h2>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="btn-icon" onclick="askEvoWithContext && askEvoWithContext('training')" title="è®©Evoåˆ†æè®­ç»ƒè®¡åˆ’">
              <span class="btn-icon-emoji">ğŸ¤–</span>
              <span class="btn-icon-text">AIåˆ†æ</span>
            </button>
            <button class="btn-icon" onclick="switchView('more')" style="background: var(--text-secondary); color: #fff;">â†</button>
          </div>
        </div>
        
        <!-- æ·»åŠ è®­ç»ƒè®°å½•æŒ‰é’® -->
        <button class="btn-primary" onclick="showAddTrainingRecord()" style="width: 100%; margin-bottom: 16px; padding: 14px; border-radius: 8px; border: none; font-size: 16px; font-weight: 600; background: var(--primary); color: #fff; cursor: pointer;">
          âœï¸ æ·»åŠ è®­ç»ƒè®°å½•
        </button>

        <!-- è®­ç»ƒè®°å½•åˆ—è¡¨ -->
        <div class="mobile-section">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title">ğŸ“‹ è®­ç»ƒè®°å½•</h3>
            <select id="trainingPigeonSelect" onchange="filterTrainingRecords()" style="padding: 8px; border-radius: 6px; border: 1px solid var(--border-light); font-size: 13px;">
              <option value="">å…¨éƒ¨é¸½å­</option>
            </select>
          </div>
          <div id="trainingRecordsContainer" class="mobile-list">
            <div class="mobile-empty">æš‚æ— è®­ç»ƒè®°å½•</div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ™ºèƒ½åˆ†æä¸­å¿ƒè§†å›¾ -->
    <div id="analysisView" class="mobile-view" style="display:none;">
      <div class="mobile-section">
        <div class="mobile-section-header">
          <h2 class="mobile-section-title">ğŸ§  æ™ºèƒ½åˆ†æä¸­å¿ƒ</h2>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="btn-icon" onclick="askEvoWithContext && askEvoWithContext('analysis')" title="è®©Evoç»™å‡ºç»¼åˆå»ºè®®">
              <span class="btn-icon-emoji">ğŸ¤–</span>
              <span class="btn-icon-text">Evoå»ºè®®</span>
            </button>
            <button class="btn-icon" onclick="switchView('more')" style="background: var(--text-secondary); color: #fff;">â†</button>
          </div>
        </div>
        
        <!-- è¿è¡Œåˆ†ææŒ‰é’® -->
        <button class="btn-primary" onclick="runMobileFullAnalysis()" style="width: 100%; margin-bottom: 16px; padding: 14px; border-radius: 8px; border: none; font-size: 16px; font-weight: 600; background: var(--primary); color: #fff; cursor: pointer;">
          ğŸš€ è¿è¡Œå…¨é¢åˆ†æ
        </button>

        <!-- æ™ºèƒ½æ´å¯Ÿå¡ç‰‡ -->
        <div class="mobile-section">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title">ğŸ† ä»Šå¹´æœ€æˆåŠŸè¡€ç³»</h3>
          </div>
          <div id="topBloodlineCard" class="mobile-card">
            <div class="mobile-empty">ç‚¹å‡»"è¿è¡Œå…¨é¢åˆ†æ"å¼€å§‹åˆ†æ</div>
          </div>
        </div>

        <div class="mobile-section">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title">â™‚ æœ€å¼ºç§å…¬</h3>
          </div>
          <div id="topMaleCard" class="mobile-card">
            <div class="mobile-empty">ç‚¹å‡»"è¿è¡Œå…¨é¢åˆ†æ"å¼€å§‹åˆ†æ</div>
          </div>
        </div>

        <div class="mobile-section">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title">â™€ æœ€å¼ºç§æ¯</h3>
          </div>
          <div id="topFemaleCard" class="mobile-card">
            <div class="mobile-empty">ç‚¹å‡»"è¿è¡Œå…¨é¢åˆ†æ"å¼€å§‹åˆ†æ</div>
          </div>
        </div>

        <div class="mobile-section">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title">ğŸ’• æ™ºèƒ½æ¨èé…å¯¹</h3>
          </div>
          <div id="recommendedPairingCard" class="mobile-card">
            <div class="mobile-empty">ç‚¹å‡»"è¿è¡Œå…¨é¢åˆ†æ"å¼€å§‹åˆ†æ</div>
          </div>
        </div>

        <!-- é¸½å­æ½œåŠ›æ’è¡Œæ¦œ -->
        <div class="mobile-section">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title">â­ é¸½å­æ½œåŠ›æ’è¡Œæ¦œ</h3>
          </div>
          <div id="potentialRankingContainer" class="mobile-list">
            <div class="mobile-empty">ç‚¹å‡»"è¿è¡Œå…¨é¢åˆ†æ"å¼€å§‹åˆ†æ</div>
          </div>
        </div>

        <!-- ç»¼åˆåˆ†æç»“è®º -->
        <div class="mobile-section">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title">ğŸ’¡ æ™ºèƒ½åˆ†æç»“è®ºä¸å»ºè®®</h3>
          </div>
          <div id="analysisConclusion" class="mobile-card">
            <div class="mobile-empty">ç‚¹å‡»"è¿è¡Œå…¨é¢åˆ†æ"ç”Ÿæˆæ™ºèƒ½åˆ†ææŠ¥å‘Š</div>
          </div>
        </div>
      </div>
    </div>

    <!-- èƒ½åŠ›ç»¼åˆåˆ†æè§†å›¾ -->
    <div id="qualificationView" class="mobile-view" style="display:none;">
      <div class="mobile-section">
        <div class="mobile-section-header">
          <h2 class="mobile-section-title">ğŸ¯ èƒ½åŠ›ç»¼åˆåˆ†æ</h2>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="btn-icon" onclick="askEvoWithContext && askEvoWithContext('qualification')" title="è®©Evoæ¨èå‚èµ›åå•">
              <span class="btn-icon-emoji">ğŸ¤–</span>
              <span class="btn-icon-text">AIå‚èµ›</span>
            </button>
            <button class="btn-icon" onclick="switchView('more')" style="background: var(--text-secondary); color: #fff;">â†</button>
          </div>
        </div>
        
        <!-- åˆ†æè¡¨å• -->
        <div class="mobile-form-group">
          <label>é€‰æ‹©é¸½å­<span style="color:#ef4444;">*</span></label>
          <select id="qualificationPigeonSelect" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border-light);">
            <option value="">é€‰æ‹©é¸½å­...</option>
          </select>
        </div>

        <div class="mobile-form-group">
          <label>æ¯”èµ›è·ç¦»ï¼ˆå…¬é‡Œï¼‰<span style="color:#ef4444;">*</span></label>
          <input type="number" id="qualificationDistance" step="0.1" placeholder="ä¾‹å¦‚ï¼š500" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border-light);" />
        </div>

        <button class="btn-primary" onclick="analyzeQualificationMobile()" style="width: 100%; margin-bottom: 16px; padding: 14px; border-radius: 8px; border: none; font-size: 16px; font-weight: 600; background: var(--primary); color: #fff; cursor: pointer;">
          ğŸ“Š å¼€å§‹åˆ†æ
        </button>

        <!-- åˆ†æç»“æœ -->
        <div id="qualificationResult" style="display:none;">
          <div class="mobile-section">
            <div class="mobile-section-header">
              <h3 class="mobile-section-title">åˆ†æç»“æœ</h3>
            </div>
            <div id="qualificationResultContent" class="mobile-card"></div>
          </div>
        </div>

        <!-- åˆ†æè®°å½•åˆ—è¡¨ -->
        <div class="mobile-section">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title">ğŸ“Š èƒ½åŠ›åˆ†æè®°å½•</h3>
          </div>
          <div id="qualificationRecordsList" class="mobile-list">
            <div class="mobile-empty">æš‚æ— åˆ†æè®°å½•</div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ•°æ®æ¦‚è§ˆè§†å›¾ -->
    <div id="dashboardView" class="mobile-view" style="display:none;">
      <div class="mobile-section">
        <div class="mobile-section-header">
          <h2 class="mobile-section-title">ğŸ“Š æ•°æ®æ¦‚è§ˆ</h2>
        </div>
        
        <!-- æ•°æ®å¡ç‰‡ -->
        <div class="mobile-stats" style="margin-bottom: 16px;">
          <div class="mobile-stat-item">
            <span class="mobile-stat-icon">ğŸ•Šï¸</span>
            <div class="mobile-stat-content">
              <div class="mobile-stat-number" id="dashboardTotalPigeons">0</div>
              <div class="mobile-stat-label">æ€»é¸½å­æ•°</div>
            </div>
          </div>
          <div class="mobile-stat-item">
            <span class="mobile-stat-icon">âœ…</span>
            <div class="mobile-stat-content">
              <div class="mobile-stat-number" id="dashboardAlivePigeons">0</div>
              <div class="mobile-stat-label">åœ¨ä¸–</div>
            </div>
          </div>
          <div class="mobile-stat-item">
            <span class="mobile-stat-icon">ğŸ†</span>
            <div class="mobile-stat-content">
              <div class="mobile-stat-number" id="dashboardRacedPigeons">0</div>
              <div class="mobile-stat-label">æœ‰æˆç»©</div>
            </div>
          </div>
          <div class="mobile-stat-item">
            <span class="mobile-stat-icon">â­</span>
            <div class="mobile-stat-content">
              <div class="mobile-stat-number" id="dashboardCorePigeons">0</div>
              <div class="mobile-stat-label">æ ¸å¿ƒç§é¸½</div>
            </div>
          </div>
        </div>

        <!-- æœ€è¿‘æ´»åŠ¨ -->
        <div class="mobile-section">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title">ğŸ“… æœ€è¿‘æ´»åŠ¨</h3>
          </div>
          <div id="dashboardRecentActivity" class="mobile-list">
            <div class="mobile-empty">æš‚æ— æ´»åŠ¨è®°å½•</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- é¸½å­è¯¦æƒ…è§†å›¾ -->
  <div id="detailView" class="mobile-view" style="display:none;">
    <div class="mobile-section">
      <div class="mobile-section-header" style="position: sticky; top: 0; background: var(--bg-secondary); z-index: 10; padding-bottom: 12px; margin-bottom: 12px; border-bottom: 1px solid var(--border-light);">
        <div style="flex: 1;">
          <h2 class="mobile-section-title" id="md_title"></h2>
          <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;" id="md_subtitle"></div>
          <div style="margin-top: 8px;" id="md_statusRow"></div>
        </div>
        <div style="display: flex; gap: 8px; flex-direction: column;">
          <button class="btn-icon" onclick="backToList()" style="background: var(--text-secondary);">â†</button>
          <button class="btn-icon" id="md_btnEdit" onclick="toggleEditMode()" style="background: var(--primary);">âœ</button>
          <button class="btn-icon" id="md_btnDelete" onclick="deletePigeon()" style="background: #ef4444;">ğŸ—‘</button>
        </div>
      </div>

      <!-- æµè§ˆæ¨¡å¼ -->
      <div id="md_browseMode">
        <!-- å›¾ç‰‡åŒºåŸŸ -->
        <div id="md_images" style="margin-bottom: 16px;"></div>

        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="mobile-form-section">
          <div class="mobile-form-section-title">åŸºæœ¬ä¿¡æ¯</div>
          <div id="md_basic"></div>
        </div>

        <!-- é¸½ä¸»ä¿¡æ¯ -->
        <div class="mobile-form-section" id="md_ownerInfoSection"></div>

        <!-- è¡€ç»Ÿä¿¡æ¯ -->
        <div class="mobile-form-section">
          <div class="mobile-form-section-title">è¡€ç»Ÿä¿¡æ¯</div>
          <div id="md_pedigree"></div>
        </div>

        <!-- è¡€ç»Ÿæ ‘å¯è§†åŒ– -->
        <div class="mobile-form-section">
          <div class="mobile-form-section-title">è¡€ç»Ÿæ ‘å¯è§†åŒ–</div>
          <div id="md_pedigreeTree" style="margin-top: 8px;"></div>
        </div>

        <!-- å‚èµ›è®°å½• -->
        <div class="mobile-form-section">
          <div class="mobile-form-section-title">å‚èµ›è®°å½•</div>
          <div id="md_races"></div>
        </div>
      </div>

      <!-- ç¼–è¾‘æ¨¡å¼ -->
      <div id="md_editMode" style="display:none;">
        <div class="mobile-form-section">
          <div class="mobile-form-section-title">åŸºæœ¬ä¿¡æ¯</div>
          <div class="mobile-form-grid">
            <div class="mobile-form-group">
              <label>é¸½å­åç§°</label>
              <input type="text" id="me_name" />
            </div>
            <div class="mobile-form-group">
              <label>è¶³ç¯å·ç <span class="required">*</span></label>
              <input type="text" id="me_ring" disabled />
              <span class="mobile-form-hint">ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼Œé€šå¸¸ä¸å…è®¸ä¿®æ”¹ã€‚</span>
            </div>
            <div class="mobile-form-group">
              <label>æ€§åˆ«</label>
              <select id="me_gender">
                <option value="">æœªé€‰æ‹©</option>
                <option value="å…¬">å…¬</option>
                <option value="æ¯">æ¯</option>
                <option value="æœªçŸ¥">æœªçŸ¥</option>
              </select>
            </div>
            <div class="mobile-form-group">
              <label>ç¾½è‰²</label>
              <input type="text" id="me_color" />
            </div>
            <div class="mobile-form-group">
              <label>å‡ºç”Ÿæ—¥æœŸ</label>
              <input type="date" id="me_birth" />
            </div>
            <div class="mobile-form-group">
              <label>é¸½å­ç±»å‹</label>
              <select id="me_type">
                <option value="">æœªé€‰æ‹©</option>
                <option value="ç§é¸½">ç§é¸½</option>
                <option value="æ¯”èµ›é¸½">æ¯”èµ›é¸½</option>
                <option value="åä»£é¸½">åä»£é¸½</option>
              </select>
            </div>
            <div class="mobile-form-group">
              <label><input type="checkbox" id="me_core" style="margin-right: 6px;" /> æ ‡è®°ä¸ºæ ¸å¿ƒç§é¸½ â­</label>
            </div>
          </div>
        </div>

        <!-- ç§é¸½ä¿¡æ¯ -->
        <div class="mobile-form-section" id="me_breederSection" style="display:none;">
          <div class="mobile-form-section-title">ç§é¸½ä¿¡æ¯</div>
          <div class="mobile-form-grid">
            <div class="mobile-form-group">
              <label>å‰é¸½ä¸»ï¼ˆå¯é€‰ï¼‰</label>
              <input type="text" id="me_previousOwner" placeholder="å¦‚ï¼šå¼ ä¸‰" />
            </div>
            <div class="mobile-form-group">
              <label>å‰åœ°åŒºï¼ˆå¯é€‰ï¼‰</label>
              <input type="text" id="me_previousRegion" placeholder="å¦‚ï¼šåŒ—äº¬" />
            </div>
          </div>
        </div>

        <!-- é¸½ä¸»ä¿¡æ¯ -->
        <div class="mobile-form-section">
          <div class="mobile-form-section-title">é¸½ä¸»ä¿¡æ¯</div>
          <div class="mobile-form-grid">
            <div class="mobile-form-group">
              <label>ç°é¸½ä¸»</label>
              <input type="text" id="me_currentOwner" placeholder="å¦‚ï¼šæå›½è¾‰" list="me_ownerList" />
              <datalist id="me_ownerList"></datalist>
            </div>
            <div class="mobile-form-group">
              <label>ç°åœ°åŒº</label>
              <input type="text" id="me_currentRegion" placeholder="å¦‚ï¼šè´µå·é»”è¥¿" list="me_regionList" />
              <datalist id="me_regionList"></datalist>
            </div>
          </div>
        </div>

        <!-- è¡€ç»Ÿä¿¡æ¯ -->
        <div class="mobile-form-section">
          <div class="mobile-form-section-title">è¡€ç»Ÿä¿¡æ¯</div>
          <div class="mobile-form-grid">
            <div class="mobile-form-group">
              <label>çˆ¶é¸½ï¼ˆå¯é€‰ï¼‰</label>
              <select id="me_father"></select>
            </div>
            <div class="mobile-form-group">
              <label>æ¯é¸½ï¼ˆå¯é€‰ï¼‰</label>
              <select id="me_mother"></select>
            </div>
          </div>
        </div>

        <!-- å‚èµ›ä¿¡æ¯ -->
        <div class="mobile-form-section">
          <div class="mobile-form-section-title">å‚èµ›ä¿¡æ¯ï¼ˆå¯å¢/æ”¹/åˆ ï¼‰</div>
          <div id="me_raceList"></div>
          <button type="button" class="btn-primary" onclick="addRaceItemEdit()" style="width: 100%; margin-top: 8px;">â• æ·»åŠ ä¸€æ¡å‚èµ›è®°å½•</button>
        </div>

        <!-- é¸½å­çŠ¶æ€ -->
        <div class="mobile-form-section">
          <div class="mobile-form-section-title">é¸½å­çŠ¶æ€</div>
          <div class="mobile-form-grid">
            <div class="mobile-form-group">
              <label>å½“å‰çŠ¶æ€</label>
              <div class="mobile-radio-group">
                <label><input type="radio" name="me_alive" value="alive" /> åœ¨ä¸–</label>
                <label><input type="radio" name="me_alive" value="dead" /> å·²æ­»äº¡</label>
              </div>
            </div>
            <div class="mobile-form-group me-death-extra" style="display:none;">
              <label>æ­»äº¡æ—¥æœŸ<span class="required">*</span></label>
              <input type="date" id="me_death_date" />
            </div>
            <div class="mobile-form-group me-death-extra" style="display:none;">
              <label>æ­»äº¡åŸå› ï¼ˆå¯é€‰ï¼‰</label>
              <input type="text" id="me_death_reason" placeholder="å¦‚ï¼šç–¾ç—…ã€æ„å¤–â€¦" />
            </div>
          </div>
        </div>

        <!-- å›¾ç‰‡ç®¡ç† -->
        <div class="mobile-form-section">
          <div class="mobile-form-section-title">å›¾ç‰‡ç®¡ç†</div>
          <div class="mobile-form-grid">
            <div class="mobile-form-group">
              <label>ç«™ç«‹ä¾§èº«å›¾ç‰‡</label>
              <input type="file" id="me_body_photo" accept="image/*" />
              <input type="file" id="me_body_photo_camera" accept="image/*" capture style="display:none;" />
              <button type="button" class="btn-primary" onclick="triggerCameraEdit('body')" style="margin-top: 8px; width: 100%;">ğŸ“· æ‹ç…§</button>
            </div>
            <div class="mobile-form-group">
              <label>çœ¼ç›ç‰¹å†™å›¾ç‰‡</label>
              <input type="file" id="me_eye_photo" accept="image/*" />
              <input type="file" id="me_eye_photo_camera" accept="image/*" capture style="display:none;" />
              <button type="button" class="btn-primary" onclick="triggerCameraEdit('eye')" style="margin-top: 8px; width: 100%;">ğŸ“· æ‹ç…§</button>
            </div>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div style="display: flex; gap: 12px; margin-top: 24px; padding-bottom: 20px;">
          <button type="button" class="btn-primary" onclick="cancelEdit()" style="flex: 1; background: var(--text-secondary);">å–æ¶ˆ</button>
          <button type="button" class="btn-primary" onclick="saveEdit()" style="flex: 1;">ğŸ’¾ ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ¯”èµ›ç®¡ç†æ¨¡æ€æ¡† -->
  <div id="raceModal" class="mobile-modal" style="display:none;">
    <div class="mobile-modal-overlay" onclick="closeRaceModal()"></div>
    <div class="mobile-modal-content">
      <div class="mobile-modal-header">
        <h2 id="raceModalTitle">æ–°å¢æ¯”èµ›</h2>
        <button class="mobile-modal-close" onclick="closeRaceModal()">âœ•</button>
      </div>
      <div class="mobile-modal-body">
        <div class="mobile-form-section">
          <div class="mobile-form-grid">
            <div class="mobile-form-group">
              <label>èµ›äº‹åç§°<span class="required">*</span></label>
              <input type="text" id="mr_name" placeholder="ä¾‹å¦‚ï¼š2024æ˜¥å­£ä¿¡é¸½å¤§èµ›" required />
            </div>
            <div class="mobile-form-group">
              <label>æ¯”èµ›æ—¶é—´<span class="required">*</span></label>
              <input type="date" id="mr_date" required />
            </div>
            <div class="mobile-form-group">
              <label>æ¯”èµ›åœ°ç‚¹<span class="required">*</span></label>
              <input type="text" id="mr_location" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬" required />
            </div>
            <div class="mobile-form-group">
              <label>å¤©æ°”æƒ…å†µ</label>
              <select id="mr_weather">
                <option value="">è¯·é€‰æ‹©</option>
                <option value="æ™´å¤©">æ™´å¤©</option>
                <option value="å¤šäº‘">å¤šäº‘</option>
                <option value="é˜´å¤©">é˜´å¤©</option>
                <option value="å°é›¨">å°é›¨</option>
                <option value="ä¸­é›¨">ä¸­é›¨</option>
                <option value="å¤§é›¨">å¤§é›¨</option>
                <option value="é›¾">é›¾</option>
                <option value="å¤§é£">å¤§é£</option>
              </select>
            </div>
          </div>
        </div>

        <div class="mobile-form-section">
          <div class="mobile-form-section-title">å‚èµ›é¸½åŠæˆç»©</div>
          <div id="mr_participantsContainer"></div>
          <button type="button" class="btn-primary" onclick="addRaceParticipant()" style="width: 100%; margin-top: 8px;">â• æ·»åŠ å‚èµ›é¸½</button>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 24px; padding-bottom: 20px;">
          <button type="button" class="btn-primary" onclick="closeRaceModal()" style="flex: 1; background: var(--text-secondary);">å–æ¶ˆ</button>
          <button type="button" class="btn-primary" onclick="saveRace()" style="flex: 1;">ğŸ’¾ ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ·»åŠ é¸½å­æ¨¡æ€æ¡† -->
  <div id="createPigeonModal" class="mobile-modal" style="display:none;">
    <div class="mobile-modal-overlay" onclick="closeCreatePigeonModal()"></div>
    <div class="mobile-modal-content">
      <div class="mobile-modal-header">
        <h2>æ–°å¢é¸½å­ä¿¡æ¯</h2>
        <button class="mobile-modal-close" onclick="closeCreatePigeonModal()">âœ•</button>
      </div>
      <div class="mobile-modal-body" id="createPigeonForm">
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="mobile-form-section">
          <div class="mobile-form-section-title">åŸºæœ¬ä¿¡æ¯</div>
          <div class="mobile-form-desc">åƒå¡«å†™è¡¨æ ¼ä¸€æ ·ç®€å•ï¼Œè¶³ç¯å·å¿…é¡»å”¯ä¸€ã€‚</div>
          <div class="mobile-form-grid">
            <div class="mobile-form-group">
              <label>é¸½å­åç§°</label>
              <input type="text" id="mc_name" placeholder="å¯é€‰ï¼Œä¾‹å¦‚ï¼šé£å¤©001" />
            </div>
            <div class="mobile-form-group">
              <label>è¶³ç¯å·ç <span class="required">*</span></label>
              <input type="text" id="mc_ring" placeholder="å¿…å¡«ï¼Œå”¯ä¸€ï¼Œå¦‚ï¼šCHN2025-0001" required />
            </div>
            <div class="mobile-form-group">
              <label>æ€§åˆ«</label>
              <select id="mc_gender">
                <option value="">æœªé€‰æ‹©</option>
                <option value="å…¬">å…¬</option>
                <option value="æ¯">æ¯</option>
                <option value="æœªçŸ¥">æœªçŸ¥</option>
              </select>
            </div>
            <div class="mobile-form-group">
              <label>ç¾½è‰²</label>
              <input type="text" id="mc_color" placeholder="å¦‚ï¼šç°ã€é›¨ç‚¹ã€ç™½æ¡â€¦" />
            </div>
            <div class="mobile-form-group">
              <label>å‡ºç”Ÿæ—¥æœŸ</label>
              <input type="date" id="mc_birth" />
            </div>
            <div class="mobile-form-group">
              <label>é¸½å­ç±»å‹</label>
              <select id="mc_type">
                <option value="">æœªé€‰æ‹©</option>
                <option value="ç§é¸½">ç§é¸½</option>
                <option value="æ¯”èµ›é¸½">æ¯”èµ›é¸½</option>
                <option value="åä»£é¸½">åä»£é¸½</option>
              </select>
            </div>
            <div class="mobile-form-group">
              <label>
                <input type="checkbox" id="mc_core" style="margin-right: 6px;" /> æ ‡è®°ä¸ºæ ¸å¿ƒç§é¸½ â­
              </label>
            </div>
          </div>
        </div>

        <!-- ç§é¸½ä¿¡æ¯ -->
        <div class="mobile-form-section" id="mc_breederSection" style="display:none;">
          <div class="mobile-form-section-title">ç§é¸½ä¿¡æ¯</div>
          <div class="mobile-form-desc">ç§é¸½éœ€è¦è®°å½•å‰é¸½ä¸»å’Œå‰åœ°åŒºä¿¡æ¯</div>
          <div class="mobile-form-grid">
            <div class="mobile-form-group">
              <label>å‰é¸½ä¸»ï¼ˆå¯é€‰ï¼‰</label>
              <input type="text" id="mc_previousOwner" placeholder="å¦‚ï¼šå¼ ä¸‰" />
            </div>
            <div class="mobile-form-group">
              <label>å‰åœ°åŒºï¼ˆå¯é€‰ï¼‰</label>
              <input type="text" id="mc_previousRegion" placeholder="å¦‚ï¼šåŒ—äº¬" />
            </div>
          </div>
        </div>

        <!-- é¸½ä¸»ä¿¡æ¯ -->
        <div class="mobile-form-section">
          <div class="mobile-form-section-title">é¸½ä¸»ä¿¡æ¯</div>
          <div class="mobile-form-desc">è®°å½•å½“å‰é¸½ä¸»å’Œæ‰€åœ¨åœ°åŒº</div>
          <div class="mobile-form-grid">
            <div class="mobile-form-group">
              <label>ç°é¸½ä¸»</label>
              <input type="text" id="mc_currentOwner" placeholder="å¦‚ï¼šæå›½è¾‰" list="mc_ownerList" />
              <datalist id="mc_ownerList"></datalist>
              <span class="mobile-form-hint">è¾“å…¥æˆ–ä»ä¸‹æ‹‰é€‰æ‹©</span>
            </div>
            <div class="mobile-form-group">
              <label>ç°åœ°åŒº</label>
              <input type="text" id="mc_currentRegion" placeholder="å¦‚ï¼šè´µå·é»”è¥¿" list="mc_regionList" />
              <datalist id="mc_regionList"></datalist>
              <span class="mobile-form-hint">è¾“å…¥æˆ–ä»ä¸‹æ‹‰é€‰æ‹©</span>
            </div>
          </div>
        </div>

        <!-- è¡€ç»Ÿä¿¡æ¯ -->
        <div class="mobile-form-section">
          <div class="mobile-form-section-title">è¡€ç»Ÿä¿¡æ¯</div>
          <div class="mobile-form-desc">çˆ¶é¸½ / æ¯é¸½å¯ä»å·²å½•å…¥çš„é¸½å­ä¸­é€‰æ‹©ï¼Œä¹Ÿå¯ä»¥æš‚æ—¶ç•™ç©ºï¼Œåç»­å†è¡¥å……ã€‚</div>
          <div class="mobile-form-grid">
            <div class="mobile-form-group">
              <label>çˆ¶é¸½ï¼ˆå¯é€‰ï¼‰</label>
              <select id="mc_father"></select>
            </div>
            <div class="mobile-form-group">
              <label>æ¯é¸½ï¼ˆå¯é€‰ï¼‰</label>
              <select id="mc_mother"></select>
            </div>
          </div>
        </div>

        <!-- å‚èµ›ä¿¡æ¯ -->
        <div class="mobile-form-section">
          <div class="mobile-form-section-title">å‚èµ›ä¿¡æ¯ï¼ˆå¯æ·»åŠ å¤šæ¡ï¼‰</div>
          <div class="mobile-form-desc">æ¯æ¬¡æ¯”èµ›å•ç‹¬ä¸€æ¡è®°å½•ï¼Œæ–¹ä¾¿æ—¥åç»Ÿè®¡å’ŒæŸ¥çœ‹ã€‚</div>
          <div id="mc_raceList"></div>
          <button type="button" class="btn-primary" onclick="addRaceItem()" style="width: 100%; margin-top: 8px;">â• æ·»åŠ ä¸€æ¡å‚èµ›è®°å½•</button>
        </div>

        <!-- é¸½å­çŠ¶æ€ -->
        <div class="mobile-form-section">
          <div class="mobile-form-section-title">é¸½å­çŠ¶æ€</div>
          <div class="mobile-form-desc">æ­»äº¡åªæ”¹å˜çŠ¶æ€ï¼Œä¸ä¼šåˆ é™¤ä»»ä½•å†å²æˆç»©ã€‚</div>
          <div class="mobile-form-grid">
            <div class="mobile-form-group">
              <label>å½“å‰çŠ¶æ€</label>
              <div class="mobile-radio-group">
                <label><input type="radio" name="mc_alive" value="alive" checked /> åœ¨ä¸–</label>
                <label><input type="radio" name="mc_alive" value="dead" /> å·²æ­»äº¡</label>
              </div>
            </div>
            <div class="mobile-form-group mc-death-extra" style="display:none;">
              <label>æ­»äº¡æ—¥æœŸ<span class="required">*</span></label>
              <input type="date" id="mc_death_date" />
            </div>
            <div class="mobile-form-group mc-death-extra" style="display:none;">
              <label>æ­»äº¡åŸå› ï¼ˆå¯é€‰ï¼‰</label>
              <input type="text" id="mc_death_reason" placeholder="å¦‚ï¼šç–¾ç—…ã€æ„å¤–â€¦" />
            </div>
          </div>
        </div>

        <!-- å›¾ç‰‡ä¸Šä¼  -->
        <div class="mobile-form-section">
          <div class="mobile-form-section-title">å›¾ç‰‡ä¸Šä¼ </div>
          <div class="mobile-form-desc">å¯ä¸ºæ¯åªé¸½å­ä¸Šä¼ ä¸¤å¼ å›¾ç‰‡ï¼šä¸€å¼ ç«™ç«‹ä¾§èº«ç…§ã€ä¸€å¼ çœ¼ç›ç‰¹å†™</div>
          <div class="mobile-form-grid">
            <div class="mobile-form-group">
              <label>ç«™ç«‹ä¾§èº«å›¾ç‰‡</label>
              <input type="file" id="mc_body_photo" accept="image/*" />
              <input type="file" id="mc_body_photo_camera" accept="image/*" capture style="display:none;" />
              <button type="button" class="btn-primary" onclick="triggerCamera('body')" style="margin-top: 8px; width: 100%;">ğŸ“· æ‹ç…§</button>
              <span class="mobile-form-hint">æ”¯æŒå¸¸è§å›¾ç‰‡æ ¼å¼ï¼ˆJPGã€PNGã€GIFã€WEBPç­‰ï¼‰</span>
            </div>
            <div class="mobile-form-group">
              <label>çœ¼ç›ç‰¹å†™å›¾ç‰‡</label>
              <input type="file" id="mc_eye_photo" accept="image/*" />
              <input type="file" id="mc_eye_photo_camera" accept="image/*" capture style="display:none;" />
              <button type="button" class="btn-primary" onclick="triggerCamera('eye')" style="margin-top: 8px; width: 100%;">ğŸ“· æ‹ç…§</button>
              <span class="mobile-form-hint">æ”¯æŒå¸¸è§å›¾ç‰‡æ ¼å¼ï¼ˆJPGã€PNGã€GIFã€WEBPç­‰ï¼‰</span>
            </div>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div style="display: flex; gap: 12px; margin-top: 24px; padding-bottom: 20px;">
          <button type="button" class="btn-primary" onclick="closeCreatePigeonModal()" style="flex: 1; background: var(--text-secondary);">âŒ å–æ¶ˆ</button>
          <button type="button" class="btn-primary" onclick="saveCreatePigeon()" style="flex: 1;">ğŸ’¾ ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨å¯¼èˆªæ  -->
  <div class="mobile-bottom-nav">
    <button class="mobile-nav-item active" onclick="switchView('home')">
      <span class="mobile-nav-icon">ğŸ </span>
      <span>é¦–é¡µ</span>
    </button>
    <button class="mobile-nav-item" onclick="switchView('pigeons')">
      <span class="mobile-nav-icon">ğŸ•Šï¸</span>
      <span>é¸½å­</span>
    </button>
    <button class="mobile-nav-item" onclick="switchView('races')">
      <span class="mobile-nav-icon">ğŸ†</span>
      <span>æ¯”èµ›</span>
    </button>
    <button class="mobile-nav-item" onclick="switchView('stats')">
      <span class="mobile-nav-icon">ğŸ“Š</span>
      <span>ç»Ÿè®¡</span>
    </button>
    <button class="mobile-nav-item" onclick="switchView('more')">
      <span class="mobile-nav-icon">âš™ï¸</span>
      <span>æ›´å¤š</span>
    </button>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let NEWS_DATA = [];
    let EVENTS_DATA = { ongoing: [], upcoming: [], results: [] };
    let currentNewsRegion = 'local';
    let currentNewsFilter = 'all';
    let currentEventTab = 'ongoing';
    let currentPigeonView = 'card'; // é¸½å­è§†å›¾æ¨¡å¼ï¼š'card' æˆ– 'table'

    // åˆå§‹åŒ–ï¼ˆå·²åœ¨åº•éƒ¨ç»Ÿä¸€å¤„ç†ï¼‰

    // æ›´æ–°æ—¥æœŸ
    function updateDate() {
      const now = new Date();
      const day = now.getDate();
      const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
      const weekday = weekdays[now.getDay()];
      const year = now.getFullYear();
      const month = now.getMonth() + 1;
      
      document.getElementById('mobileDay').textContent = day;
      document.getElementById('mobileWeekday').textContent = weekday;
      document.getElementById('mobileDateFull').textContent = `${year}å¹´${month}æœˆ`;
    }

    // åŠ è½½æ•°æ®
    async function loadData() {
      await Promise.all([
        loadNews(),
        loadEvents(),
        loadMobileAnnouncement()
      ]);
      updateStats();
    }
    
    // åŠ è½½ç§»åŠ¨ç«¯å…¬å‘Š
    async function loadMobileAnnouncement() {
      const announcementEl = document.getElementById('mobileAnnouncementMain');
      const announcementTextEl = document.getElementById('mobileAnnouncementMainText');
      
      if (!announcementEl || !announcementTextEl) return;
      
      try {
        const apiConfig = getApiConfig();
        const apiUrl = apiConfig.apiUrl || 'http://localhost:3000/api';
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        // ä»å…¬å…±APIè·å–å…¬å‘Šï¼ˆä¸éœ€è¦tokenï¼‰
        const response = await fetch(`${apiUrl}/announcements/public`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          },
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        // å¤„ç†404å’Œå…¶ä»–é”™è¯¯ï¼Œä¸æŠ›å‡ºå¼‚å¸¸ï¼Œä½¿ç”¨é»˜è®¤å€¼
        if (!response.ok) {
          if (response.status === 404) {
            console.log('ğŸ“¢ [å…¬å‘Š] APIæ¥å£ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤å…¬å‘Š');
            announcementTextEl.textContent = 'æš‚æ— å…¬å‘Š';
            announcementEl.style.display = 'flex';
            return;
          }
          throw new Error(`è·å–å…¬å‘Šå¤±è´¥: ${response.status}`);
        }
        
        const result = await response.json();
        const announcements = result.data || [];
        
        // è·å–æœ€æ–°çš„å·²å‘å¸ƒå…¬å‘Š
        const activeAnnouncements = announcements.filter(ann => ann.active);
        if (activeAnnouncements.length > 0) {
          // æŒ‰æ›´æ–°æ—¶é—´æ’åºï¼Œè·å–æœ€æ–°çš„
          activeAnnouncements.sort((a, b) => {
            const timeA = new Date(a.updatedAt || a.createdAt);
            const timeB = new Date(b.updatedAt || b.createdAt);
            return timeB - timeA;
          });
          
          const latestAnnouncement = activeAnnouncements[0];
          const content = latestAnnouncement.content || 'æš‚æ— å…¬å‘Š';
          
          // é™åˆ¶æ˜¾ç¤ºé•¿åº¦
          const maxLength = 100;
          if (content.length > maxLength) {
            announcementTextEl.textContent = content.substring(0, maxLength) + '...';
          } else {
            announcementTextEl.textContent = content;
          }
          
          // ç¡®ä¿å…¬å‘Šæ æ˜¾ç¤º
          announcementEl.style.display = 'flex';
        } else {
          announcementTextEl.textContent = 'æš‚æ— å…¬å‘Š';
          announcementEl.style.display = 'flex';
        }
      } catch (error) {
        console.error('åŠ è½½å…¬å‘Šå¤±è´¥:', error);
        announcementTextEl.textContent = 'æš‚æ— å…¬å‘Š';
        announcementEl.style.display = 'flex';
      }
    }

    // åŠ è½½èµ„è®¯
    async function loadNews() {
      try {
        const apiConfig = getApiConfig();
        if (apiConfig.newsApiUrl) {
          const response = await fetch(apiConfig.newsApiUrl);
          if (response.ok) {
            const result = await response.json();
            if (result.success && Array.isArray(result.data)) {
              NEWS_DATA = result.data;
            } else {
              NEWS_DATA = getSampleNewsData();
            }
          } else {
            NEWS_DATA = getSampleNewsData();
          }
        } else {
          NEWS_DATA = getSampleNewsData();
        }
      } catch (error) {
        console.warn('åŠ è½½èµ„è®¯å¤±è´¥ï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®:', error);
        NEWS_DATA = getSampleNewsData();
      }
      renderNews();
    }

    // åŠ è½½èµ›äº‹
    async function loadEvents() {
      try {
        const apiConfig = getApiConfig();
        if (apiConfig.eventsApiUrl) {
          const response = await fetch(apiConfig.eventsApiUrl);
          if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
              EVENTS_DATA = result.data;
            } else {
              EVENTS_DATA = getSampleEventsData();
            }
          } else {
            EVENTS_DATA = getSampleEventsData();
          }
        } else {
          EVENTS_DATA = getSampleEventsData();
        }
      } catch (error) {
        console.warn('åŠ è½½èµ›äº‹å¤±è´¥ï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®:', error);
        EVENTS_DATA = getSampleEventsData();
      }
      renderEvents();
    }

    // è·å–APIé…ç½®ï¼ˆè‡ªåŠ¨æ£€æµ‹éƒ¨ç½²ç¯å¢ƒï¼‰
    function getApiConfig() {
      // è‡ªåŠ¨æ£€æµ‹å½“å‰ç¯å¢ƒ
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      const defaultBaseUrl = isLocalhost ? 'http://localhost:3000/api' : (window.location.origin + '/api');
      
      const config = localStorage.getItem('pigeon_api_config');
      if (config) {
        try {
          const parsed = JSON.parse(config);
          // å¦‚æœé…ç½®çš„URLåŒ…å«localhostï¼Œä½†åœ¨éƒ¨ç½²ç¯å¢ƒä¸­ï¼Œè‡ªåŠ¨æ›´æ–°
          if (!isLocalhost && parsed.apiUrl && parsed.apiUrl.includes('localhost')) {
            parsed.apiUrl = defaultBaseUrl;
            // æ›´æ–°é…ç½®
            localStorage.setItem('pigeon_api_config', JSON.stringify(parsed));
          }
          if (!parsed.apiUrl) {
            parsed.apiUrl = defaultBaseUrl;
          }
          return parsed;
        } catch (e) {
          console.warn('è§£æAPIé…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', e);
        }
      }
      
      return {
        apiUrl: defaultBaseUrl,
        newsApiUrl: defaultBaseUrl + '/news',
        eventsApiUrl: defaultBaseUrl + '/events',
        apiKey: ''
      };
    }

    // ç¤ºä¾‹èµ„è®¯æ•°æ®
    function getSampleNewsData() {
      const now = new Date();
      return [
        {
          id: 'news_1',
          title: 'è´µå·çœä¿¡é¸½åä¼šæ˜¥å­£æ´»åŠ¨é€šçŸ¥',
          source: 'è´µå·çœä¿¡é¸½åä¼š',
          time: '3å°æ—¶å‰',
          tags: ['çƒ­é—¨', '#æœ¬åœ°', '#æ´»åŠ¨'],
          category: 'race',
          region: 'local',
          hot: true
        },
        {
          id: 'news_2',
          title: '2024å¹´æ˜¥å­£ä¿¡é¸½å¤§èµ›å³å°†å¼€èµ›',
          source: 'ä¸­å›½ä¿¡é¸½ä¿¡æ¯ç½‘',
          time: '5å°æ—¶å‰',
          tags: ['èµ›äº‹', 'æ˜¥å­£'],
          category: 'race',
          region: 'national',
          hot: false
        },
        {
          id: 'news_3',
          title: 'èµ›é¸½è‚²ç§æ–°æŠ€æœ¯åˆ†äº«',
          source: 'èµ›é¸½å¤©åœ°',
          time: '1å¤©å‰',
          tags: ['è‚²ç§', 'æŠ€æœ¯'],
          category: 'breeding',
          region: 'national',
          hot: false
        }
      ];
    }

    // ç¤ºä¾‹èµ›äº‹æ•°æ®
    function getSampleEventsData() {
      const now = new Date();
      return {
        ongoing: [
          {
            id: 'event_1',
            name: '2024å¹´æ˜¥å­£500å…¬é‡Œç«ç¿”èµ›',
            region: 'local',
            distance: '500å…¬é‡Œ',
            participants: 1250,
            source: 'è´µå·çœä¿¡é¸½åä¼š'
          }
        ],
        upcoming: [
          {
            id: 'event_2',
            name: '2024å¹´æ˜¥å­£700å…¬é‡Œç²¾è‹±èµ›',
            region: 'national',
            distance: '700å…¬é‡Œ',
            participants: 3500,
            source: 'ä¸­å›½ä¿¡é¸½ä¿¡æ¯ç½‘'
          }
        ],
        results: [
          {
            id: 'event_3',
            name: '2024å¹´æ˜¥å­£300å…¬é‡Œçƒ­èº«èµ›',
            region: 'local',
            distance: '300å…¬é‡Œ',
            participants: 850,
            winner: 'å¼ ä¸‰',
            source: 'è´µå·çœä¿¡é¸½åä¼š'
          }
        ]
      };
    }

    // æ¸²æŸ“èµ„è®¯
    function renderNews() {
      const list = document.getElementById('mobileNewsList');
      const filtered = NEWS_DATA.filter(item => {
        if (currentNewsRegion === 'local' && item.region !== 'local') return false;
        if (currentNewsRegion === 'national' && item.region !== 'national') return false;
        if (currentNewsFilter !== 'all' && item.category !== currentNewsFilter) return false;
        return true;
      });

      if (filtered.length === 0) {
        list.innerHTML = '<div class="mobile-empty">æš‚æ— èµ„è®¯</div>';
        return;
      }

      list.innerHTML = filtered.slice(0, 10).map(item => `
        <div class="mobile-card" onclick="viewNews('${item.id}')">
          <div class="mobile-card-title">${item.title}</div>
          <div class="mobile-card-meta">
            <span>${item.source}</span>
            <span>${item.time}</span>
          </div>
          ${item.tags && item.tags.length > 0 ? `
            <div class="mobile-card-tags">
              ${item.tags.map(tag => `<span class="mobile-tag">${tag}</span>`).join('')}
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    // æ¸²æŸ“èµ›äº‹
    function renderEvents() {
      const list = document.getElementById('mobileEventsList');
      const events = EVENTS_DATA[currentEventTab] || [];

      if (events.length === 0) {
        list.innerHTML = '<div class="mobile-empty">æš‚æ— èµ›äº‹</div>';
        return;
      }

      list.innerHTML = events.slice(0, 10).map(item => `
        <div class="mobile-card" onclick="viewEvent('${item.id}')">
          <div class="mobile-card-title">${item.name}</div>
          <div class="mobile-card-meta">
            <span>${item.distance || ''}</span>
            <span>${item.participants || 0}ç¾½</span>
            <span>${item.source || ''}</span>
          </div>
        </div>
      `).join('');
    }

    // æ›´æ–°ç»Ÿè®¡
    function updateStats() {
      const newsCount = NEWS_DATA.filter(n => {
        const today = new Date().toDateString();
        const newsDate = new Date(n.updateTime || Date.now()).toDateString();
        return today === newsDate;
      }).length;
      
      const activeRaces = EVENTS_DATA.ongoing?.length || 0;
      const completedRaces = EVENTS_DATA.results?.length || 0;
      
      // ä»localStorageè·å–é¸½å­æ•°é‡ï¼ˆä½¿ç”¨ä¸PCç«¯ç›¸åŒçš„å­˜å‚¨é”®ï¼‰
      const pigeons = loadPigeons();
      const pigeonCount = pigeons.length;

      document.getElementById('statNews').textContent = newsCount;
      document.getElementById('statRaces').textContent = activeRaces;
      document.getElementById('statResults').textContent = completedRaces;
      document.getElementById('statPigeons').textContent = pigeonCount;
    }

    // åˆ‡æ¢èµ„è®¯åœ°åŒº
    function switchNewsRegion(region) {
      currentNewsRegion = region;
      document.querySelectorAll('.mobile-tab[data-region]').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.region === region);
      });
      renderNews();
    }

    // åˆ‡æ¢èµ„è®¯ç­›é€‰
    function switchNewsFilter(filter) {
      currentNewsFilter = filter;
      document.querySelectorAll('.mobile-tab[data-filter]').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.filter === filter);
      });
      renderNews();
    }

    // åˆ‡æ¢èµ›äº‹æ ‡ç­¾
    function switchEventTab(tab) {
      currentEventTab = tab;
      document.querySelectorAll('.mobile-tab[data-tab]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      renderEvents();
    }

    // è§†å›¾å¯¹è±¡ï¼ˆå‡½æ•°å½¢å¼ï¼Œç¡®ä¿æ¯æ¬¡éƒ½è·å–æœ€æ–°çš„DOMå…ƒç´ ï¼‰
    function getViews() {
      return {
        home: document.getElementById('homeView'),
        pigeons: document.getElementById('listView'),
        races: document.getElementById('raceView'),
        stats: document.getElementById('statsView'),
        pedigree: document.getElementById('pedigreeView'),
        breeding: document.getElementById('breedingView'),
        health: document.getElementById('healthView'),
        training: document.getElementById('trainingView'),
        analysis: document.getElementById('analysisView'),
        qualification: document.getElementById('qualificationView'),
        dashboard: document.getElementById('dashboardView'),
        more: document.getElementById('moreView')
      };
    }
    
    // è§†å›¾å¯¹è±¡ï¼ˆä¿æŒå…¼å®¹æ€§ï¼Œä½†åœ¨ä½¿ç”¨æ—¶ç¡®ä¿å…ƒç´ å­˜åœ¨ï¼‰
    let views = getViews();

    // åˆ‡æ¢è§†å›¾
    function switchView(viewName) {
      console.log('åˆ‡æ¢è§†å›¾:', viewName);
      
      // é‡æ–°è·å–viewså¯¹è±¡ï¼Œç¡®ä¿å…ƒç´ å­˜åœ¨
      views = getViews();
      
      // æ›´æ–°åº•éƒ¨å¯¼èˆªæ çŠ¶æ€
      document.querySelectorAll('.mobile-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      // æ‰¾åˆ°å¯¹åº”çš„å¯¼èˆªæŒ‰é’®å¹¶æ¿€æ´»
      const navButtons = document.querySelectorAll('.mobile-nav-item');
      navButtons.forEach(btn => {
        const onclickAttr = btn.getAttribute('onclick');
        if (onclickAttr && onclickAttr.includes(`'${viewName}'`)) {
          btn.classList.add('active');
        }
      });
      
      // éšè—æ‰€æœ‰è§†å›¾ï¼ˆä½†ä¿æŠ¤homeViewï¼Œç¡®ä¿å®ƒå§‹ç»ˆå¯è§ï¼‰
      Object.keys(views).forEach(key => {
        if (views[key] && key !== 'home') { // ä¸éšè—homeView
          views[key].style.display = 'none';
        }
      });
      
      // æ˜¾ç¤ºç›®æ ‡è§†å›¾ï¼ˆä½¿ç”¨æœ€å¼ºåŠ›çš„æ–¹æ³•ï¼‰
      if (views[viewName]) {
        // ä½¿ç”¨setPropertyç¡®ä¿ä¼˜å…ˆçº§æœ€é«˜
        views[viewName].style.setProperty('display', 'block', 'important');
        views[viewName].style.setProperty('visibility', 'visible', 'important');
        views[viewName].style.setProperty('opacity', '1', 'important');
        
        // å¦‚æœæ˜¯homeViewï¼Œé¢å¤–è®¾ç½®é«˜åº¦å’Œä½ç½®
        if (viewName === 'home') {
          views[viewName].style.setProperty('min-height', '600px', 'important');
          views[viewName].style.setProperty('height', 'auto', 'important');
          views[viewName].style.setProperty('position', 'relative', 'important');
          views[viewName].style.setProperty('width', '100%', 'important');
        }
        
        // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥ä¿®å¤è„šæœ¬
        window.dispatchEvent(new CustomEvent('mobileViewSwitched', { detail: { view: viewName } }));
        
        // æ ¹æ®è§†å›¾æ‰§è¡Œç‰¹å®šæ“ä½œ
        switch(viewName) {
          case 'home':
            loadData();
            break;
          case 'pigeons':
            refreshList();
            break;
          case 'races':
            refreshRaceList();
            break;
          case 'stats':
            refreshDashboard();
            break;
          case 'detail':
            // è¯¦æƒ…è§†å›¾å·²é€šè¿‡viewPigeonDetailå‡½æ•°åŠ è½½
            break;
          case 'pedigree':
            refreshPedigreeSelect();
            break;
        }
        
        // è§†å›¾åˆ‡æ¢åï¼Œç¡®ä¿æŒ‰é’®è¢«ä¿®å¤ï¼ˆç‰¹åˆ«æ˜¯moreViewä¸­çš„å¡ç‰‡ï¼‰
        if (typeof window.fixMoreViewCards === 'function') {
          setTimeout(() => {
            window.fixMoreViewCards();
          }, 100);
        }
        if (typeof window.forceFixMobileButtons === 'function') {
          setTimeout(() => {
            window.forceFixMobileButtons();
          }, 200);
        }
        
        // ğŸ”¥ å¦‚æœåˆ‡æ¢åˆ°homeè§†å›¾ï¼Œç¡®ä¿å¼ºåˆ¶æ˜¾ç¤ºï¼ˆé˜²æ­¢è¢«å…¶ä»–è„šæœ¬éšè—ï¼‰
        if (viewName === 'home') {
          setTimeout(() => {
            const homeView = document.getElementById('homeView');
            if (homeView) {
              homeView.style.setProperty('display', 'block', 'important');
              homeView.style.setProperty('visibility', 'visible', 'important');
              homeView.style.setProperty('opacity', '1', 'important');
              homeView.style.setProperty('min-height', '600px', 'important');
              homeView.style.setProperty('height', 'auto', 'important');
              console.log('âœ… [switchView] å·²å¼ºåˆ¶æ˜¾ç¤ºhomeView');
            }
          }, 0);
          setTimeout(() => {
            const homeView = document.getElementById('homeView');
            if (homeView) {
              homeView.style.setProperty('display', 'block', 'important');
              homeView.style.setProperty('visibility', 'visible', 'important');
              homeView.style.setProperty('opacity', '1', 'important');
            }
          }, 100);
        }
      } else {
        console.warn('è§†å›¾ä¸å­˜åœ¨:', viewName);
      }
    }
    
    // ğŸ”¥ åŒ…è£…switchViewå‡½æ•°ï¼Œæ·»åŠ ä¿æŠ¤æœºåˆ¶
    const originalSwitchView = switchView;
    window.switchView = function(viewName) {
      console.log('ğŸ”§ [switchViewåŒ…è£…] è°ƒç”¨switchView:', viewName);
      originalSwitchView(viewName);
      
      // å¦‚æœåˆ‡æ¢åˆ°homeï¼Œç¡®ä¿homeViewå§‹ç»ˆå¯è§
      if (viewName === 'home') {
        setTimeout(() => {
          const homeView = document.getElementById('homeView');
          if (homeView) {
            const computedStyle = window.getComputedStyle(homeView);
            if (computedStyle.display === 'none' || 
                computedStyle.visibility === 'hidden' || 
                computedStyle.opacity === '0') {
              console.warn('âš ï¸ [switchViewåŒ…è£…] homeViewè¢«éšè—ï¼Œç«‹å³æ¢å¤ï¼');
              homeView.style.setProperty('display', 'block', 'important');
              homeView.style.setProperty('visibility', 'visible', 'important');
              homeView.style.setProperty('opacity', '1', 'important');
              homeView.style.setProperty('min-height', '600px', 'important');
              homeView.style.setProperty('height', 'auto', 'important');
            }
          }
        }, 50);
      }
    };

    // åˆ·æ–°æ•°æ®
    function refreshData() {
      loadData();
    }

    // æŸ¥çœ‹èµ„è®¯è¯¦æƒ…
    function viewNews(id) {
      const news = NEWS_DATA.find(n => n.id === id);
      if (news) {
        alert(news.title + '\n\n' + (news.content || 'æš‚æ— è¯¦ç»†å†…å®¹'));
      }
    }

    // æŸ¥çœ‹èµ›äº‹è¯¦æƒ…
    function viewEvent(id) {
      const event = [...EVENTS_DATA.ongoing, ...EVENTS_DATA.upcoming, ...EVENTS_DATA.results].find(e => e.id === id);
      if (event) {
        alert(event.name + '\n\nè·ç¦»: ' + (event.distance || 'æœªçŸ¥') + '\nå‚ä¸: ' + (event.participants || 0) + 'ç¾½');
      }
    }

    // æ›´æ–°ç”¨æˆ·æŒ‰é’®æ˜¾ç¤ºï¼ˆå…¼å®¹è‡ªåŠ¨ç™»å½•ï¼‰
    function updateMobileUserButton() {
      const userBtn = document.querySelector('.mobile-header-actions .btn-icon[onclick*="showUserInfoModal"]');
      if (!userBtn) return;
      
      try {
        const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
        const userSettings = JSON.parse(localStorage.getItem('userSettings') || '{}');
        // å…¼å®¹è‡ªåŠ¨ç™»å½•ï¼šåŒæ—¶æ£€æŸ¥ token å’Œ auth_token
        const token = localStorage.getItem('token') || localStorage.getItem('auth_token');
        
        // å¦‚æœæ²¡æœ‰userInfoï¼Œå°è¯•ä»è‡ªåŠ¨è´¦æˆ·è·å–
        let displayName = userSettings.displayName || userInfo.username || userInfo.name;
        if (!displayName) {
          const autoAccount = JSON.parse(localStorage.getItem('pigeon_auto_account') || '{}');
          displayName = autoAccount.username || 'è´¦æˆ·';
        }
        displayName = displayName || 'è´¦æˆ·';
        const shortName = displayName.length > 6 ? displayName.substring(0, 6) + '...' : displayName;
        
        if (token && (userInfo.username || userInfo.name || displayName !== 'è´¦æˆ·')) {
          // å·²ç™»å½•ï¼Œæ˜¾ç¤ºç”¨æˆ·å
          userBtn.innerHTML = `
            <span class="btn-icon-emoji">ğŸ‘¤</span>
            <span class="btn-icon-text">${shortName}</span>
          `;
        } else {
          // æœªç™»å½•ï¼Œæ˜¾ç¤º"è´¦æˆ·"
          userBtn.innerHTML = `
            <span class="btn-icon-emoji">ğŸ‘¤</span>
            <span class="btn-icon-text">è´¦æˆ·</span>
          `;
        }
      } catch (e) {
        console.error('æ›´æ–°ç”¨æˆ·æŒ‰é’®å¤±è´¥:', e);
        // å‡ºé”™æ—¶æ˜¾ç¤ºé»˜è®¤æ–‡æœ¬
        userBtn.innerHTML = `
          <span class="btn-icon-emoji">ğŸ‘¤</span>
          <span class="btn-icon-text">è´¦æˆ·</span>
        `;
      }
    }
    
    // ========================================
    // ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯åŠŸèƒ½
    // ========================================
    
    // è·å–åç«¯APIåœ°å€
    function getBackendApiUrl() {
      const apiConfig = getApiConfig();
      return apiConfig.apiUrl || 'http://localhost:3000/api';
    }
    
    // è®¾ç½®è®¤è¯token
    function setAuthToken(token) {
      if (token) {
        localStorage.setItem('token', token);
      } else {
        localStorage.removeItem('token');
      }
    }
    
    // è·å–è®¤è¯tokenï¼ˆå…¼å®¹è‡ªåŠ¨ç™»å½•ï¼‰
    function getAuthToken() {
      // åŒæ—¶æ£€æŸ¥ token å’Œ auth_tokenï¼Œå…¼å®¹è‡ªåŠ¨ç™»å½•è„šæœ¬
      return localStorage.getItem('token') || localStorage.getItem('auth_token');
    }

    // è®¾å¤‡æ ‡è®°ï¼ˆç”¨äºåå°è¯†åˆ«ä¸åŒè®¾å¤‡ï¼‰
    const DEVICE_ID_KEY = 'pigeon_device_id';

    function getOrCreateDeviceId() {
      try {
        let id = localStorage.getItem(DEVICE_ID_KEY);
        if (!id) {
          // ä¼˜å…ˆä½¿ç”¨æµè§ˆå™¨æä¾›çš„éšæœºID
          if (window.crypto && window.crypto.randomUUID) {
            id = window.crypto.randomUUID();
          } else {
            id = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          }
          localStorage.setItem(DEVICE_ID_KEY, id);
        }
        return id;
      } catch (e) {
        console.warn('ç”Ÿæˆè®¾å¤‡IDå¤±è´¥:', e);
        return null;
      }
    }

    // è‡ªåŠ¨åŒæ­¥ç”¨æˆ·æ•°æ®åˆ°åå°/äº‘ç«¯
    let lastUserDataSyncAt = 0;

    async function autoSyncUserData(options = {}) {
      const { force = false } = options;
      try {
        const token = getAuthToken();
        if (!token) return; // æœªç™»å½•ä¸ä¸Šä¼ 

        const now = Date.now();
        // é»˜è®¤è‡³å°‘é—´éš”60ç§’å†åŒæ­¥ä¸€æ¬¡ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
        if (!force && now - lastUserDataSyncAt < 60000) {
          return;
        }

        const apiUrl = getBackendApiUrl();
        const deviceId = getOrCreateDeviceId();
        const deviceInfo = {
          userAgent: navigator.userAgent || '',
          platform: navigator.platform || ''
        };

        const body = {
          pigeons: loadPigeons(),
          races: loadRaces(),
          healthRecords,
          trainingRecords,
          pairings,
          qualificationRecords,
          deviceId,
          deviceInfo
          // sharing é…ç½®æš‚ç”±åå°æˆ–å°†æ¥çš„è®¾ç½®ç•Œé¢æ§åˆ¶ï¼Œè¿™é‡Œä¸å¼ºåˆ¶è¦†ç›–
        };

        const resp = await fetch(apiUrl + '/user/data/full', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(body)
        });

        if (resp.ok) {
          lastUserDataSyncAt = now;
        } else {
          console.warn('è‡ªåŠ¨åŒæ­¥ç”¨æˆ·æ•°æ®å¤±è´¥:', resp.status);
        }
      } catch (e) {
        console.warn('è‡ªåŠ¨åŒæ­¥ç”¨æˆ·æ•°æ®å¼‚å¸¸:', e);
      }
    }

    // å½“æœ¬åœ°æ•°æ®ç¼ºå¤±æ—¶ï¼Œä»äº‘ç«¯/åå°æ¢å¤
    async function restoreUserDataIfMissing() {
      try {
        const token = getAuthToken();
        if (!token) return;

        const hasLocalPigeons = !!localStorage.getItem('pigeon_manager_data_v1');
        const hasLocalRaces = !!localStorage.getItem('pigeon_races_v1');

        // å¦‚æœæœ¬åœ°å·²æœ‰æ ¸å¿ƒæ•°æ®ï¼Œåˆ™ä¸å¼ºåˆ¶è¦†ç›–
        if (hasLocalPigeons || hasLocalRaces) {
          return;
        }

        const apiUrl = getBackendApiUrl();
        const resp = await fetch(apiUrl + '/user/data/full', {
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (!resp.ok) {
          console.warn('ä»åå°è·å–ç”¨æˆ·å®Œæ•´æ•°æ®å¤±è´¥:', resp.status);
          return;
        }

        const result = await resp.json();
        if (!result.success || !result.data) return;

        const data = result.data;

        if (Array.isArray(data.pigeons) && data.pigeons.length > 0) {
          localStorage.setItem('pigeon_manager_data_v1', JSON.stringify(data.pigeons));
        }
        if (Array.isArray(data.races) && data.races.length > 0) {
          localStorage.setItem('pigeon_races_v1', JSON.stringify(data.races));
        }
        if (Array.isArray(data.healthRecords) && data.healthRecords.length > 0) {
          localStorage.setItem(HEALTH_RECORDS_KEY, JSON.stringify(data.healthRecords));
          healthRecords = data.healthRecords;
        }
        if (Array.isArray(data.trainingRecords) && data.trainingRecords.length > 0) {
          localStorage.setItem(TRAINING_STORAGE_KEY, JSON.stringify(data.trainingRecords));
          trainingRecords = data.trainingRecords;
        }
        if (Array.isArray(data.pairings) && data.pairings.length > 0) {
          localStorage.setItem(PAIRING_RECORDS_KEY, JSON.stringify(data.pairings));
          pairings = data.pairings;
        }
        if (Array.isArray(data.qualificationRecords) && data.qualificationRecords.length > 0) {
          localStorage.setItem(QUALIFICATION_STORAGE_KEY, JSON.stringify(data.qualificationRecords));
          qualificationRecords = data.qualificationRecords;
        }

        console.log('âœ… å·²ä»åå°æ¢å¤ç”¨æˆ·æ•°æ®');
        // æ¢å¤ååˆ·æ–°ç»Ÿè®¡/åˆ—è¡¨è§†å›¾
        try {
          refreshList();
          refreshRaceList();
          renderHealthAlerts();
          renderTrainingRecords();
          updateStats();
        } catch (e) {
          console.warn('æ¢å¤ååˆ·æ–°è§†å›¾æ—¶å‡ºé”™:', e);
        }
      } catch (e) {
        console.warn('å°è¯•ä»åå°æ¢å¤ç”¨æˆ·æ•°æ®å¤±è´¥:', e);
      }
    }
    
    // åŠ è½½ç”¨æˆ·è®¾ç½®
    function loadUserSettings() {
      try {
        const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
        return {
          avatar: settings.avatar || null,
          displayName: settings.displayName || null
        };
      } catch (e) {
        console.error('åŠ è½½ç”¨æˆ·è®¾ç½®å¤±è´¥:', e);
        return { avatar: null, displayName: null };
      }
    }
    
    // ä¿å­˜ç”¨æˆ·è®¾ç½®
    function saveUserSettings(settings) {
      try {
        localStorage.setItem('userSettings', JSON.stringify(settings));
        return true;
      } catch (e) {
        console.error('ä¿å­˜ç”¨æˆ·è®¾ç½®å¤±è´¥:', e);
        return false;
      }
    }
    
    // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
    window.showLoginModal = function() {
      const modal = document.getElementById('loginModal');
      if (!modal) {
        const loginModalHTML = `
          <div id="loginModal" class="mobile-modal" style="display:none;">
            <div class="mobile-modal-overlay" onclick="closeLoginModal()"></div>
            <div class="mobile-modal-content" style="max-width:100%;border-radius:20px 20px 0 0;margin-top:auto;max-height:90vh;">
              <div class="mobile-modal-header" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border-radius:20px 20px 0 0;padding:20px;position:relative;">
                <h3 style="margin:0;font-size:16px;font-weight:600;color:#fff;">
                  <span id="loginModalTitle">ğŸ”</span>
                  <span id="loginModalTitleText" style="margin-left:8px;">ç”¨æˆ·ç™»å½•</span>
                </h3>
                <button onclick="closeLoginModal()" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.2);border:none;width:32px;height:32px;border-radius:50%;font-size:18px;cursor:pointer;color:#fff;display:flex;align-items:center;justify-content:center;transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">âœ•</button>
              </div>
              <div class="mobile-modal-body" style="padding:20px;background:var(--bg-primary);">
                <!-- ç™»å½•è¡¨å• -->
                <div id="loginForm">
                  <div style="margin-bottom:16px;">
                    <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-size:13px;font-weight:600;">ç”¨æˆ·åæˆ–é‚®ç®±</label>
                    <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±" style="width:100%;padding:12px 14px;border-radius:12px;border:2px solid var(--border-light);font-size:13px;outline:none;transition:all 0.2s;background:var(--bg-secondary);color:var(--text-primary);box-sizing:border-box;" onfocus="this.style.borderColor='var(--primary)';this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'" onblur="this.style.borderColor='var(--border-light)';this.style.boxShadow='none'" />
                  </div>
                  <div style="margin-bottom:16px;">
                    <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-size:13px;font-weight:600;">å¯†ç </label>
                    <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " style="width:100%;padding:12px 14px;border-radius:12px;border:2px solid var(--border-light);font-size:13px;outline:none;transition:all 0.2s;background:var(--bg-secondary);color:var(--text-primary);box-sizing:border-box;" onfocus="this.style.borderColor='var(--primary)';this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'" onblur="this.style.borderColor='var(--border-light)';this.style.boxShadow='none'" />
                  </div>
                  <div id="loginError" style="display:none;padding:12px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:12px;color:#ef4444;font-size:12px;margin-bottom:16px;"></div>
                  <button class="btn btn-primary" style="width:100%;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border:none;padding:14px;border-radius:12px;color:#fff;font-weight:600;font-size:14px;box-shadow:0 4px 12px rgba(102,126,234,0.3);transition:all 0.2s;margin-bottom:16px;" onclick="handleLogin()" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(102,126,234,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(102,126,234,0.3)'">ç™»å½•</button>
                  <div style="text-align:center;padding-top:16px;border-top:1px solid var(--border-light);">
                    <span style="color:var(--text-secondary);font-size:13px;">è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ</span>
                    <a href="#" onclick="switchToRegister(); return false;" style="color:var(--primary);font-size:13px;font-weight:600;text-decoration:none;margin-left:8px;">ç«‹å³æ³¨å†Œ</a>
                  </div>
                </div>
                
                <!-- æ³¨å†Œè¡¨å• -->
                <div id="registerForm" style="display:none;">
                  <div style="margin-bottom:16px;">
                    <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-size:13px;font-weight:600;">ç”¨æˆ·å</label>
                    <input type="text" id="registerUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" style="width:100%;padding:12px 14px;border-radius:12px;border:2px solid var(--border-light);font-size:13px;outline:none;transition:all 0.2s;background:var(--bg-secondary);color:var(--text-primary);box-sizing:border-box;" onfocus="this.style.borderColor='var(--primary)';this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'" onblur="this.style.borderColor='var(--border-light)';this.style.boxShadow='none'" />
                  </div>
                  <div style="margin-bottom:16px;">
                    <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-size:13px;font-weight:600;">é‚®ç®±</label>
                    <input type="email" id="registerEmail" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€" style="width:100%;padding:12px 14px;border-radius:12px;border:2px solid var(--border-light);font-size:13px;outline:none;transition:all 0.2s;background:var(--bg-secondary);color:var(--text-primary);box-sizing:border-box;" onfocus="this.style.borderColor='var(--primary)';this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'" onblur="this.style.borderColor='var(--border-light)';this.style.boxShadow='none'" />
                  </div>
                  <div style="margin-bottom:16px;">
                    <label style="display:block;margin-bottom:8px;color:var(--text-secondary);font-size:13px;font-weight:600;">å¯†ç </label>
                    <input type="password" id="registerPassword" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" style="width:100%;padding:12px 14px;border-radius:12px;border:2px solid var(--border-light);font-size:13px;outline:none;transition:all 0.2s;background:var(--bg-secondary);color:var(--text-primary);box-sizing:border-box;" onfocus="this.style.borderColor='var(--primary)';this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'" onblur="this.style.borderColor='var(--border-light)';this.style.boxShadow='none'" />
                  </div>
                  <div id="registerError" style="display:none;padding:12px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:12px;color:#ef4444;font-size:12px;margin-bottom:16px;"></div>
                  <button class="btn btn-primary" style="width:100%;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border:none;padding:14px;border-radius:12px;color:#fff;font-weight:600;font-size:14px;box-shadow:0 4px 12px rgba(102,126,234,0.3);transition:all 0.2s;margin-bottom:16px;" onclick="handleRegister()" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(102,126,234,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(102,126,234,0.3)'">æ³¨å†Œ</button>
                  <div style="text-align:center;padding-top:16px;border-top:1px solid var(--border-light);">
                    <span style="color:var(--text-secondary);font-size:13px;">å·²æœ‰è´¦æˆ·ï¼Ÿ</span>
                    <a href="#" onclick="switchToLogin(); return false;" style="color:var(--primary);font-size:13px;font-weight:600;text-decoration:none;margin-left:8px;">ç«‹å³ç™»å½•</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', loginModalHTML);
      }
      
      document.getElementById('loginModal').style.display = 'flex';
      switchToLogin();
    };
    
    // å…³é—­ç™»å½•æ¨¡æ€æ¡†
    window.closeLoginModal = function() {
      const modal = document.getElementById('loginModal');
      if (modal) {
        modal.style.display = 'none';
        // æ¸…ç©ºè¡¨å•
        const loginUsername = document.getElementById('loginUsername');
        const loginPassword = document.getElementById('loginPassword');
        const registerUsername = document.getElementById('registerUsername');
        const registerEmail = document.getElementById('registerEmail');
        const registerPassword = document.getElementById('registerPassword');
        const loginError = document.getElementById('loginError');
        const registerError = document.getElementById('registerError');
        
        if (loginUsername) loginUsername.value = '';
        if (loginPassword) loginPassword.value = '';
        if (registerUsername) registerUsername.value = '';
        if (registerEmail) registerEmail.value = '';
        if (registerPassword) registerPassword.value = '';
        if (loginError) loginError.style.display = 'none';
        if (registerError) registerError.style.display = 'none';
      }
    };
    
    // åˆ‡æ¢åˆ°ç™»å½•è¡¨å•
    function switchToLogin() {
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      const loginModalTitle = document.getElementById('loginModalTitle');
      const loginModalTitleText = document.getElementById('loginModalTitleText');
      
      if (loginForm) loginForm.style.display = 'block';
      if (registerForm) registerForm.style.display = 'none';
      if (loginModalTitle) loginModalTitle.textContent = 'ğŸ”';
      if (loginModalTitleText) loginModalTitleText.textContent = 'ç”¨æˆ·ç™»å½•';
    }
    
    // åˆ‡æ¢åˆ°æ³¨å†Œè¡¨å•
    function switchToRegister() {
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      const loginModalTitle = document.getElementById('loginModalTitle');
      const loginModalTitleText = document.getElementById('loginModalTitleText');
      
      if (loginForm) loginForm.style.display = 'none';
      if (registerForm) registerForm.style.display = 'block';
      if (loginModalTitle) loginModalTitle.textContent = 'ğŸ“';
      if (loginModalTitleText) loginModalTitleText.textContent = 'ç”¨æˆ·æ³¨å†Œ';
    }
    
    // å¤„ç†ç™»å½•
    window.handleLogin = async function() {
      const username = document.getElementById('loginUsername')?.value.trim();
      const password = document.getElementById('loginPassword')?.value;
      const errorDiv = document.getElementById('loginError');
      
      if (!username || !password) {
        if (errorDiv) {
          errorDiv.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
          errorDiv.style.display = 'block';
        }
        return;
      }
      
      try {
        const apiUrl = getBackendApiUrl();
        const response = await fetch(`${apiUrl}/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password })
        });
        
        const result = await response.json();
        
        if (result.success && result.data && result.data.token) {
          // ä¿å­˜token
          setAuthToken(result.data.token);
          
          // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
          if (result.data.user) {
            localStorage.setItem('userInfo', JSON.stringify(result.data.user));
          }
          
          // å…³é—­ç™»å½•æ¨¡æ€æ¡†
          closeLoginModal();
          
          // æ›´æ–°UI
          updateMobileUserButton();
          
          // æ˜¾ç¤ºæˆåŠŸæç¤º
          alert('ç™»å½•æˆåŠŸï¼');
          
          // åˆ·æ–°é¡µé¢æ•°æ®
          if (typeof loadData === 'function') {
            loadData();
          }
        } else {
          if (errorDiv) {
            errorDiv.textContent = result.error || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ';
            errorDiv.style.display = 'block';
          }
        }
      } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);
        if (errorDiv) {
          errorDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨';
          errorDiv.style.display = 'block';
        }
      }
    };
    
    // å¤„ç†æ³¨å†Œ
    window.handleRegister = async function() {
      const username = document.getElementById('registerUsername')?.value.trim();
      const email = document.getElementById('registerEmail')?.value.trim();
      const password = document.getElementById('registerPassword')?.value;
      const errorDiv = document.getElementById('registerError');
      
      if (!username || !email || !password) {
        if (errorDiv) {
          errorDiv.textContent = 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹';
          errorDiv.style.display = 'block';
        }
        return;
      }
      
      if (password.length < 6) {
        if (errorDiv) {
          errorDiv.textContent = 'å¯†ç é•¿åº¦è‡³å°‘6ä½';
          errorDiv.style.display = 'block';
        }
        return;
      }
      
      try {
        const apiUrl = getBackendApiUrl();
        const response = await fetch(`${apiUrl}/auth/register`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, email, password })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨ç™»å½•
          const loginResponse = await fetch(`${apiUrl}/auth/login`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, password })
          });
          
          const loginResult = await loginResponse.json();
          
          if (loginResult.success && loginResult.data && loginResult.data.token) {
            setAuthToken(loginResult.data.token);
            
            if (loginResult.data.user) {
              localStorage.setItem('userInfo', JSON.stringify(loginResult.data.user));
            }
            
            closeLoginModal();
            updateMobileUserButton();
            
            alert('æ³¨å†ŒæˆåŠŸï¼å·²è‡ªåŠ¨ç™»å½•');
          } else {
            if (errorDiv) {
              errorDiv.textContent = 'æ³¨å†ŒæˆåŠŸï¼Œä½†è‡ªåŠ¨ç™»å½•å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç™»å½•';
              errorDiv.style.display = 'block';
            }
          }
        } else {
          if (errorDiv) {
            errorDiv.textContent = result.error || 'æ³¨å†Œå¤±è´¥';
            errorDiv.style.display = 'block';
          }
        }
      } catch (error) {
        console.error('æ³¨å†Œé”™è¯¯:', error);
        if (errorDiv) {
          errorDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨';
          errorDiv.style.display = 'block';
        }
      }
    };
    
    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯æ¨¡æ€æ¡†
    function showUserInfoModal() {
      // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
      const token = getAuthToken();
      if (!token) {
        // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
        showLoginModal();
        return;
      }
      
      const modal = document.getElementById('userInfoModal');
      if (!modal) {
        const modalHTML = `
          <div id="userInfoModal" class="mobile-modal" style="display:none;">
            <div class="mobile-modal-overlay" onclick="closeUserInfoModal()"></div>
            <div class="mobile-modal-content" style="max-width:100%;border-radius:20px 20px 0 0;margin-top:auto;max-height:90vh;">
              <div class="mobile-modal-header" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border-radius:20px 20px 0 0;padding:20px;position:relative;">
                <h3 style="margin:0;font-size:16px;font-weight:600;color:#fff;">è´¦æˆ·ä¿¡æ¯</h3>
                <button onclick="closeUserInfoModal()" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.2);border:none;width:32px;height:32px;border-radius:50%;font-size:18px;cursor:pointer;color:#fff;display:flex;align-items:center;justify-content:center;transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">âœ•</button>
              </div>
              <div class="mobile-modal-body" style="padding:0;background:var(--bg-primary);">
                <!-- æŸ¥çœ‹æ¨¡å¼ -->
                <div id="userInfoViewMode">
                  <!-- ç”¨æˆ·å¤´åƒåŒºåŸŸ -->
                  <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);padding:30px 20px 50px;text-align:center;position:relative;">
                    <div style="width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);margin:0 auto 16px;display:flex;align-items:center;justify-content:center;font-size:48px;color:#fff;box-shadow:0 8px 24px rgba(0,0,0,0.2);background-size:cover;background-position:center;background-repeat:no-repeat;border:4px solid rgba(255,255,255,0.3);transition:transform 0.3s;" id="userAvatarDisplay" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">ğŸ‘¨â€ğŸ’¼</div>
                    <h4 style="margin:0 0 8px;font-size:18px;font-weight:700;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,0.2);" id="userNameDisplay">ç”¨æˆ·å</h4>
                    <p style="margin:0;color:rgba(255,255,255,0.9);font-size:13px;" id="userEmailDisplay">user@example.com</p>
                  </div>
                  
                  <!-- ä¿¡æ¯å¡ç‰‡åŒºåŸŸ -->
                  <div style="padding:20px;margin-top:-30px;position:relative;z-index:1;">
                    <div style="background:var(--bg-secondary);border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.08);margin-bottom:16px;">
                      <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid var(--border-light);">
                        <div style="display:flex;align-items:center;gap:12px;">
                          <span style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg, #667eea20 0%, #764ba220 100%);display:flex;align-items:center;justify-content:center;font-size:16px;">ğŸ‘¤</span>
                          <span style="color:var(--text-secondary);font-size:13px;">è´¦æˆ·ç±»å‹</span>
                        </div>
                        <span style="color:var(--text-primary);font-weight:600;font-size:13px;" id="userTypeDisplay">æ™®é€šç”¨æˆ·</span>
                      </div>
                      <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid var(--border-light);">
                        <div style="display:flex;align-items:center;gap:12px;">
                          <span style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg, #667eea20 0%, #764ba220 100%);display:flex;align-items:center;justify-content:center;font-size:16px;">ğŸ“…</span>
                          <span style="color:var(--text-secondary);font-size:13px;">æ³¨å†Œæ—¶é—´</span>
                        </div>
                        <span style="color:var(--text-primary);font-weight:600;font-size:13px;" id="userRegisterDate">2024-01-01</span>
                      </div>
                      <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 0;">
                        <div style="display:flex;align-items:center;gap:12px;">
                          <span style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg, #667eea20 0%, #764ba220 100%);display:flex;align-items:center;justify-content:center;font-size:16px;">ğŸ•Šï¸</span>
                          <span style="color:var(--text-secondary);font-size:13px;">æ•°æ®ç»Ÿè®¡</span>
                        </div>
                        <span style="color:var(--primary);font-weight:700;font-size:14px;" id="userDataStats">0 åªé¸½å­</span>
                      </div>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                      <button class="btn btn-primary" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border:none;padding:12px;border-radius:12px;color:#fff;font-weight:600;font-size:13px;box-shadow:0 4px 12px rgba(102,126,234,0.3);transition:all 0.2s;" onclick="enterEditUserInfoMode()" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(102,126,234,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(102,126,234,0.3)'">âœï¸ ç¼–è¾‘èµ„æ–™</button>
                      <button class="btn btn-outline" style="border:2px solid var(--border-light);padding:12px;border-radius:12px;background:var(--bg-secondary);color:var(--text-primary);font-weight:600;font-size:13px;transition:all 0.2s;" onclick="closeUserInfoModal(); showSettingsModal();" onmouseover="this.style.borderColor='var(--primary)';this.style.color='var(--primary)'" onmouseout="this.style.borderColor='var(--border-light)';this.style.color='var(--text-primary)'">âš™ï¸ ç³»ç»Ÿè®¾ç½®</button>
                    </div>
                    <button class="btn btn-outline" style="width:100%;border:2px solid #ef4444;padding:12px;border-radius:12px;background:rgba(239,68,68,0.1);color:#ef4444;font-weight:600;font-size:13px;transition:all 0.2s;margin-bottom:12px;" onclick="handleLogout(); closeUserInfoModal();" onmouseover="this.style.background='rgba(239,68,68,0.2)'" onmouseout="this.style.background='rgba(239,68,68,0.1)'">ğŸšª é€€å‡ºç™»å½•</button>
                    <button class="btn btn-outline" style="width:100%;border:2px solid var(--border-light);padding:10px;border-radius:12px;background:var(--bg-secondary);color:var(--text-secondary);font-size:12px;transition:all 0.2s;" onclick="closeUserInfoModal()" onmouseover="this.style.borderColor='var(--text-secondary)';this.style.color='var(--text-primary)'" onmouseout="this.style.borderColor='var(--border-light)';this.style.color='var(--text-secondary)'">å…³é—­</button>
                  </div>
                </div>
                
                <!-- ç¼–è¾‘æ¨¡å¼ -->
                <div id="userInfoEditMode" style="display:none;">
                  <!-- ç¼–è¾‘å¤´éƒ¨ -->
                  <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);padding:30px 20px 40px;text-align:center;position:relative;">
                    <div style="position:relative;display:inline-block;margin-bottom:20px;">
                      <div style="width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);margin:0 auto;display:flex;align-items:center;justify-content:center;font-size:48px;color:#fff;box-shadow:0 8px 24px rgba(0,0,0,0.2);background-size:cover;background-position:center;background-repeat:no-repeat;border:4px solid rgba(255,255,255,0.3);" id="userAvatarEditDisplay">ğŸ‘¨â€ğŸ’¼</div>
                      <label for="userAvatarInput" style="position:absolute;bottom:0;right:calc(50% - 50px);width:40px;height:40px;background:#2563eb;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 12px rgba(37,99,235,0.4);border:3px solid #fff;transition:all 0.2s;" onmouseover="this.style.transform='scale(1.1)';this.style.boxShadow='0 6px 16px rgba(37,99,235,0.5)'" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(37,99,235,0.4)'">
                        <span style="font-size:20px;">ğŸ“·</span>
                      </label>
                      <input type="file" id="userAvatarInput" accept="image/*" style="display:none;" />
                    </div>
                  </div>
                  
                  <!-- ç¼–è¾‘è¡¨å• -->
                  <div style="padding:20px;margin-top:-30px;position:relative;z-index:1;">
                    <div style="background:var(--bg-secondary);border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.08);margin-bottom:20px;">
                      <label style="display:block;margin-bottom:10px;color:var(--text-primary);font-size:13px;font-weight:600;">æ˜µç§°</label>
                      <input type="text" id="userNameInput" placeholder="è¯·è¾“å…¥æ˜µç§°" style="width:100%;padding:12px 14px;border-radius:12px;border:2px solid var(--border-light);font-size:13px;outline:none;transition:all 0.2s;background:var(--bg-primary);color:var(--text-primary);box-sizing:border-box;" onfocus="this.style.borderColor='var(--primary)';this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'" onblur="this.style.borderColor='var(--border-light)';this.style.boxShadow='none'" />
                      <p style="margin:10px 0 0 0;color:var(--text-secondary);font-size:12px;line-height:1.5;">æ˜µç§°å°†æ˜¾ç¤ºåœ¨è´¦æˆ·ç•Œé¢å’Œé¡¶éƒ¨å¯¼èˆªæ </p>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div style="display:flex;gap:12px;">
                      <button class="btn btn-primary" style="flex:1;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border:none;padding:12px;border-radius:12px;color:#fff;font-weight:600;font-size:13px;box-shadow:0 4px 12px rgba(102,126,234,0.3);transition:all 0.2s;" onclick="saveUserInfo()" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 16px rgba(102,126,234,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(102,126,234,0.3)'">ğŸ’¾ ä¿å­˜</button>
                      <button class="btn btn-outline" style="flex:1;border:2px solid var(--border-light);padding:12px;border-radius:12px;background:var(--bg-secondary);color:var(--text-primary);font-weight:600;font-size:13px;transition:all 0.2s;" onclick="cancelEditUserInfo()" onmouseover="this.style.borderColor='var(--text-secondary)';this.style.color='var(--text-primary)'" onmouseout="this.style.borderColor='var(--border-light)';this.style.color='var(--text-primary)'">å–æ¶ˆ</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      // åˆ‡æ¢åˆ°æŸ¥çœ‹æ¨¡å¼
      const viewMode = document.getElementById('userInfoViewMode');
      const editMode = document.getElementById('userInfoEditMode');
      if (viewMode) viewMode.style.display = 'block';
      if (editMode) editMode.style.display = 'none';
      
      // åŠ è½½ç”¨æˆ·ä¿¡æ¯
      const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
      const userSettings = loadUserSettings();
      const userName = userSettings.displayName || userInfo.name || userInfo.username || 'ç”¨æˆ·';
      const userEmail = userInfo.email || 'user@example.com';
      const userType = userInfo.type || 'æ™®é€šç”¨æˆ·';
      const registerDate = userInfo.registerDate || new Date().toISOString().split('T')[0];
      
      // æ›´æ–°æ˜¾ç¤º
      const avatarDisplay = document.getElementById('userAvatarDisplay');
      if (avatarDisplay) {
        if (userSettings.avatar) {
          avatarDisplay.style.backgroundImage = `url(${userSettings.avatar})`;
          avatarDisplay.textContent = '';
        } else {
          avatarDisplay.style.backgroundImage = '';
          avatarDisplay.textContent = 'ğŸ‘¨â€ğŸ’¼';
        }
      }
      
      const userNameDisplay = document.getElementById('userNameDisplay');
      if (userNameDisplay) userNameDisplay.textContent = userName;
      
      const userEmailDisplay = document.getElementById('userEmailDisplay');
      if (userEmailDisplay) userEmailDisplay.textContent = userEmail;
      
      const userTypeDisplay = document.getElementById('userTypeDisplay');
      if (userTypeDisplay) userTypeDisplay.textContent = userType;
      
      const userRegisterDate = document.getElementById('userRegisterDate');
      if (userRegisterDate) userRegisterDate.textContent = registerDate;
      
      // è®¡ç®—æ•°æ®ç»Ÿè®¡
      const pigeons = loadPigeons();
      const pigeonCount = pigeons.filter(p => p.alive).length;
      const userDataStats = document.getElementById('userDataStats');
      if (userDataStats) userDataStats.textContent = `${pigeonCount} åªé¸½å­`;
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      document.getElementById('userInfoModal').style.display = 'flex';
    }
    
    // å…³é—­ç”¨æˆ·ä¿¡æ¯æ¨¡æ€æ¡†
    function closeUserInfoModal() {
      const modal = document.getElementById('userInfoModal');
      if (modal) modal.style.display = 'none';
    }
    
    // è¿›å…¥ç¼–è¾‘æ¨¡å¼
    function enterEditUserInfoMode() {
      const viewMode = document.getElementById('userInfoViewMode');
      const editMode = document.getElementById('userInfoEditMode');
      if (viewMode) viewMode.style.display = 'none';
      if (editMode) editMode.style.display = 'block';
      
      // åŠ è½½å½“å‰è®¾ç½®
      const userSettings = loadUserSettings();
      const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
      
      // è®¾ç½®å¤´åƒæ˜¾ç¤º
      const avatarEditDisplay = document.getElementById('userAvatarEditDisplay');
      if (avatarEditDisplay) {
        if (userSettings.avatar) {
          avatarEditDisplay.style.backgroundImage = `url(${userSettings.avatar})`;
          avatarEditDisplay.textContent = '';
        } else {
          avatarEditDisplay.style.backgroundImage = '';
          avatarEditDisplay.textContent = 'ğŸ‘¨â€ğŸ’¼';
        }
      }
      
      // è®¾ç½®åå­—è¾“å…¥æ¡†
      const userNameInput = document.getElementById('userNameInput');
      if (userNameInput) {
        userNameInput.value = userSettings.displayName || userInfo.name || userInfo.username || '';
      }
      
      // ç»‘å®šå¤´åƒä¸Šä¼ äº‹ä»¶
      const avatarInput = document.getElementById('userAvatarInput');
      if (avatarInput) {
        avatarInput.onchange = function(e) {
          const file = e.target.files[0];
          if (file) {
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º2MBï¼‰
            if (file.size > 2 * 1024 * 1024) {
              alert('å¤´åƒæ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡2MB');
              return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
              alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
              return;
            }
            
            // è¯»å–æ–‡ä»¶å¹¶è½¬æ¢ä¸ºbase64
            const reader = new FileReader();
            reader.onload = function(e) {
              const base64 = e.target.result;
              if (avatarEditDisplay) {
                avatarEditDisplay.style.backgroundImage = `url(${base64})`;
                avatarEditDisplay.textContent = '';
              }
            };
            reader.readAsDataURL(file);
          }
        };
      }
    }
    
    // å–æ¶ˆç¼–è¾‘
    function cancelEditUserInfo() {
      const viewMode = document.getElementById('userInfoViewMode');
      const editMode = document.getElementById('userInfoEditMode');
      if (viewMode) viewMode.style.display = 'block';
      if (editMode) editMode.style.display = 'none';
      showUserInfoModal(); // é‡æ–°åŠ è½½æ˜¾ç¤º
    }
    
    // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
    function saveUserInfo() {
      const userNameInput = document.getElementById('userNameInput');
      const avatarInput = document.getElementById('userAvatarInput');
      const avatarEditDisplay = document.getElementById('userAvatarEditDisplay');
      
      if (!userNameInput) return;
      
      const displayName = userNameInput.value.trim();
      if (!displayName) {
        alert('è¯·è¾“å…¥æ˜µç§°');
        return;
      }
      
      // è·å–å¤´åƒï¼ˆbase64ï¼‰
      let avatar = null;
      if (avatarEditDisplay && avatarEditDisplay.style.backgroundImage && avatarEditDisplay.style.backgroundImage !== 'none') {
        avatar = avatarEditDisplay.style.backgroundImage.replace('url("', '').replace('")', '').replace("url('", '').replace("')", '');
      }
      
      // ä¿å­˜è®¾ç½®
      const success = saveUserSettings({
        avatar: avatar,
        displayName: displayName
      });
      
      if (success) {
        // æ›´æ–°é¡¶éƒ¨å¯¼èˆªæ 
        updateMobileUserButton();
        
        // åˆ‡æ¢å›æŸ¥çœ‹æ¨¡å¼å¹¶åˆ·æ–°
        cancelEditUserInfo();
        alert('ä¿å­˜æˆåŠŸï¼');
      } else {
        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }
    
    // é€€å‡ºç™»å½•
    window.handleLogout = function() {
      if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        setAuthToken(null);
        localStorage.removeItem('userInfo');
        updateMobileUserButton();
        alert('å·²é€€å‡ºç™»å½•');
      }
    }
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆé¡µé¢åŠ è½½æ—¶è°ƒç”¨ï¼‰
    async function checkLoginStatus() {
      const token = getAuthToken();
      if (!token) {
        return;
      }
      
      try {
        const apiUrl = getBackendApiUrl();
        const response = await fetch(`${apiUrl}/auth/me`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
          // tokenæœ‰æ•ˆï¼Œæ›´æ–°ç”¨æˆ·ä¿¡æ¯
          localStorage.setItem('userInfo', JSON.stringify(result.data));
          updateMobileUserButton();
        } else {
          // tokenæ— æ•ˆï¼Œæ¸…é™¤
          setAuthToken(null);
          localStorage.removeItem('userInfo');
          updateMobileUserButton();
        }
      } catch (error) {
        console.warn('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
        // ç½‘ç»œé”™è¯¯ä¸å½±å“ä½¿ç”¨ï¼Œä¿ç•™token
      }
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶åˆå§‹åŒ–é¦–é¡µè‡ªåŠ¨å°ç»“
    if (typeof document !== 'undefined') {
      document.addEventListener('DOMContentLoaded', function() {
        checkLoginStatus();
        initHomeAutoSummary();
      });
    }
    
    // æ˜¾ç¤ºè®¾ç½®æ¨¡æ€æ¡†
    function showSettingsModal() {
      const menu = document.getElementById('settingsModal');
      if (!menu) {
        const menuHTML = `
          <div id="settingsModal" class="mobile-modal" style="display:none;">
            <div class="mobile-modal-overlay" onclick="closeSettingsModal()"></div>
            <div class="mobile-modal-content" style="max-width:100%;border-radius:20px 20px 0 0;margin-top:auto;max-height:90vh;">
              <div class="mobile-modal-header" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border-radius:20px 20px 0 0;padding:20px;position:relative;">
                <h3 style="margin:0;font-size:16px;font-weight:600;color:#fff;">âš™ï¸ ç³»ç»Ÿè®¾ç½®</h3>
                <button onclick="closeSettingsModal()" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.2);border:none;width:32px;height:32px;border-radius:50%;font-size:18px;cursor:pointer;color:#fff;display:flex;align-items:center;justify-content:center;transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">âœ•</button>
              </div>
              <div class="mobile-modal-body" style="padding:20px;background:var(--bg-primary);overflow-y:auto;max-height:calc(90vh - 80px);">
                <!-- å¤–è§‚è®¾ç½® -->
                <div style="background:var(--bg-secondary);border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.08);margin-bottom:16px;">
                  <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <span style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg, #667eea20 0%, #764ba220 100%);display:flex;align-items:center;justify-content:center;font-size:16px;">ğŸ¨</span>
                    <label style="color:var(--text-primary);font-size:13px;font-weight:600;flex:1;">å¤–è§‚è®¾ç½®</label>
                  </div>
                  <div style="margin-bottom:12px;">
                    <div style="color:var(--text-secondary);font-size:12px;margin-bottom:8px;">ä¸»é¢˜æ¨¡å¼</div>
                    <select id="themeSelect" onchange="changeTheme(this.value)" style="width:100%;padding:12px 14px;border-radius:12px;border:2px solid var(--border-light);font-size:13px;outline:none;transition:all 0.2s;background:var(--bg-primary);color:var(--text-primary);box-sizing:border-box;cursor:pointer;" onfocus="this.style.borderColor='var(--primary)';this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'" onblur="this.style.borderColor='var(--border-light)';this.style.boxShadow='none'">
                      <option value="light">æµ…è‰²æ¨¡å¼</option>
                      <option value="dark">æ·±è‰²æ¨¡å¼</option>
                      <option value="auto">è·Ÿéšç³»ç»Ÿ</option>
                    </select>
                  </div>
                  <div style="margin-bottom:12px;">
                    <div style="color:var(--text-secondary);font-size:12px;margin-bottom:8px;">å­—ä½“å¤§å°</div>
                    <select id="fontSizeSelect" style="width:100%;padding:12px 14px;border-radius:12px;border:2px solid var(--border-light);font-size:13px;outline:none;transition:all 0.2s;background:var(--bg-primary);color:var(--text-primary);box-sizing:border-box;cursor:pointer;" onfocus="this.style.borderColor='var(--primary)';this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'" onblur="this.style.borderColor='var(--border-light)';this.style.boxShadow='none'">
                      <option value="small">å°</option>
                      <option value="medium" selected>ä¸­</option>
                      <option value="large">å¤§</option>
                    </select>
                  </div>
                  <div>
                    <div style="color:var(--text-secondary);font-size:12px;margin-bottom:8px;">ç•Œé¢å¯†åº¦</div>
                    <select id="densitySelect" style="width:100%;padding:12px 14px;border-radius:12px;border:2px solid var(--border-light);font-size:13px;outline:none;transition:all 0.2s;background:var(--bg-primary);color:var(--text-primary);box-sizing:border-box;cursor:pointer;" onfocus="this.style.borderColor='var(--primary)';this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'" onblur="this.style.borderColor='var(--border-light)';this.style.boxShadow='none'">
                      <option value="compact">ç´§å‡‘</option>
                      <option value="normal" selected>æ ‡å‡†</option>
                      <option value="comfortable">èˆ’é€‚</option>
                    </select>
                  </div>
                </div>
                
                <!-- æ•°æ®ç®¡ç† -->
                <div style="background:var(--bg-secondary);border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.08);margin-bottom:16px;">
                  <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <span style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg, #667eea20 0%, #764ba220 100%);display:flex;align-items:center;justify-content:center;font-size:16px;">ğŸ’¾</span>
                    <label style="color:var(--text-primary);font-size:13px;font-weight:600;flex:1;">æ•°æ®ç®¡ç†</label>
                  </div>
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                    <button onclick="exportData()" class="btn-outline" style="border:2px solid var(--border-light);padding:12px;border-radius:12px;background:var(--bg-primary);color:var(--text-primary);font-weight:600;font-size:13px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--primary)';this.style.color='var(--primary)';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='var(--border-light)';this.style.color='var(--text-primary)';this.style.transform='translateY(0)'">ğŸ“¥ å¯¼å‡ºJSON</button>
                    <label class="btn-outline" style="border:2px solid var(--border-light);padding:12px;border-radius:12px;background:var(--bg-primary);color:var(--text-primary);font-weight:600;font-size:13px;cursor:pointer;transition:all 0.2s;text-align:center;display:flex;align-items:center;justify-content:center;" onmouseover="this.style.borderColor='var(--primary)';this.style.color='var(--primary)';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='var(--border-light)';this.style.color='var(--text-primary)';this.style.transform='translateY(0)'">
                      ğŸ“¤ å¯¼å…¥JSON
                      <input type="file" id="importFileInput" accept=".json" style="display:none;" onchange="handleImportFile(event)">
                    </label>
                  </div>
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                    <button onclick="showDataStats()" class="btn-outline" style="border:2px solid var(--border-light);padding:12px;border-radius:12px;background:var(--bg-primary);color:var(--text-primary);font-weight:600;font-size:13px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--primary)';this.style.color='var(--primary)';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='var(--border-light)';this.style.color='var(--text-primary)';this.style.transform='translateY(0)'">ğŸ“Š æŸ¥çœ‹ç»Ÿè®¡</button>
                    <button onclick="backupData()" class="btn-outline" style="border:2px solid var(--border-light);padding:12px;border-radius:12px;background:var(--bg-primary);color:var(--text-primary);font-weight:600;font-size:13px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--primary)';this.style.color='var(--primary)';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='var(--border-light)';this.style.color='var(--text-primary)';this.style.transform='translateY(0)'">ğŸ’¾ å¤‡ä»½æ•°æ®</button>
                  </div>
                  <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-top:1px solid var(--border-light);margin-top:12px;">
                    <div>
                      <div style="color:var(--text-primary);font-size:13px;font-weight:600;margin-bottom:4px;">è‡ªåŠ¨å¤‡ä»½</div>
                      <div style="color:var(--text-secondary);font-size:11px;">æ¯å¤©è‡ªåŠ¨å¤‡ä»½æ•°æ®</div>
                    </div>
                    <label style="position:relative;display:inline-block;width:44px;height:24px;">
                      <input type="checkbox" id="autoBackupToggle" style="opacity:0;width:0;height:0;" onchange="saveAutoBackupSetting(this.checked)">
                      <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:24px;" id="autoBackupSlider"></span>
                    </label>
                  </div>
                </div>
                
                <!-- APIé…ç½® -->
                <div style="background:var(--bg-secondary);border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.08);margin-bottom:16px;">
                  <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <span style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg, #667eea20 0%, #764ba220 100%);display:flex;align-items:center;justify-content:center;font-size:16px;">ğŸ”—</span>
                    <label style="color:var(--text-primary);font-size:13px;font-weight:600;flex:1;">APIé…ç½®</label>
                  </div>
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                    <button onclick="showApiConfigModal('èµ„è®¯')" class="btn-outline" style="border:2px solid var(--border-light);padding:12px;border-radius:12px;background:var(--bg-primary);color:var(--text-primary);font-weight:600;font-size:13px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--primary)';this.style.color='var(--primary)';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='var(--border-light)';this.style.color='var(--text-primary)';this.style.transform='translateY(0)'">ğŸ”— èµ„è®¯API</button>
                    <button onclick="showApiConfigModal('èµ›äº‹')" class="btn-outline" style="border:2px solid var(--border-light);padding:12px;border-radius:12px;background:var(--bg-primary);color:var(--text-primary);font-weight:600;font-size:13px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--primary)';this.style.color='var(--primary)';this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='var(--border-light)';this.style.color='var(--text-primary)';this.style.transform='translateY(0)'">ğŸ”— èµ›äº‹API</button>
                  </div>
                  <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-top:1px solid var(--border-light);margin-top:12px;">
                    <div>
                      <div style="color:var(--text-primary);font-size:13px;font-weight:600;margin-bottom:4px;">APIçŠ¶æ€</div>
                      <div style="color:var(--text-secondary);font-size:11px;" id="apiStatusDesc">æ£€æŸ¥APIè¿æ¥çŠ¶æ€</div>
                    </div>
                    <button onclick="testApiConnection()" class="btn-outline" style="border:2px solid var(--border-light);padding:8px 16px;border-radius:12px;background:var(--bg-primary);color:var(--text-primary);font-weight:600;font-size:12px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--primary)';this.style.color='var(--primary)'" onmouseout="this.style.borderColor='var(--border-light)';this.style.color='var(--text-primary)'">ğŸ” æµ‹è¯•</button>
                  </div>
                </div>
                
                <!-- é€šçŸ¥è®¾ç½® -->
                <div style="background:var(--bg-secondary);border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.08);margin-bottom:16px;">
                  <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <span style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg, #667eea20 0%, #764ba220 100%);display:flex;align-items:center;justify-content:center;font-size:16px;">ğŸ””</span>
                    <label style="color:var(--text-primary);font-size:13px;font-weight:600;flex:1;">é€šçŸ¥è®¾ç½®</label>
                  </div>
                  <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border-light);">
                    <div>
                      <div style="color:var(--text-primary);font-size:13px;font-weight:600;margin-bottom:4px;">ç³»ç»Ÿé€šçŸ¥</div>
                      <div style="color:var(--text-secondary);font-size:11px;">æ¥æ”¶ç³»ç»Ÿé‡è¦é€šçŸ¥</div>
                    </div>
                    <label style="position:relative;display:inline-block;width:44px;height:24px;">
                      <input type="checkbox" id="systemNotificationToggle" checked style="opacity:0;width:0;height:0;" onchange="saveNotificationSetting('system', this.checked)">
                      <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#667eea;transition:.4s;border-radius:24px;" id="systemNotificationSlider"></span>
                    </label>
                  </div>
                  <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border-light);">
                    <div>
                      <div style="color:var(--text-primary);font-size:13px;font-weight:600;margin-bottom:4px;">æ•°æ®æ›´æ–°æé†’</div>
                      <div style="color:var(--text-secondary);font-size:11px;">æ•°æ®æ›´æ–°æ—¶æ˜¾ç¤ºæé†’</div>
                    </div>
                    <label style="position:relative;display:inline-block;width:44px;height:24px;">
                      <input type="checkbox" id="dataUpdateNotificationToggle" checked style="opacity:0;width:0;height:0;" onchange="saveNotificationSetting('dataUpdate', this.checked)">
                      <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#667eea;transition:.4s;border-radius:24px;" id="dataUpdateNotificationSlider"></span>
                    </label>
                  </div>
                  <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;">
                    <div>
                      <div style="color:var(--text-primary);font-size:13px;font-weight:600;margin-bottom:4px;">èµ›äº‹æé†’</div>
                      <div style="color:var(--text-secondary);font-size:11px;">é‡è¦èµ›äº‹å¼€å§‹å‰æé†’</div>
                    </div>
                    <label style="position:relative;display:inline-block;width:44px;height:24px;">
                      <input type="checkbox" id="eventNotificationToggle" checked style="opacity:0;width:0;height:0;" onchange="saveNotificationSetting('event', this.checked)">
                      <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#667eea;transition:.4s;border-radius:24px;" id="eventNotificationSlider"></span>
                    </label>
                  </div>
                </div>
                
                <!-- ç³»ç»Ÿè®¾ç½® -->
                <div style="background:var(--bg-secondary);border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.08);margin-bottom:16px;">
                  <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <span style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg, #667eea20 0%, #764ba220 100%);display:flex;align-items:center;justify-content:center;font-size:16px;">âš™ï¸</span>
                    <label style="color:var(--text-primary);font-size:13px;font-weight:600;flex:1;">ç³»ç»Ÿè®¾ç½®</label>
                  </div>
                  <div style="margin-bottom:12px;">
                    <div style="color:var(--text-secondary);font-size:12px;margin-bottom:8px;">è¯­è¨€è®¾ç½®</div>
                    <select id="languageSelect" style="width:100%;padding:12px 14px;border-radius:12px;border:2px solid var(--border-light);font-size:13px;outline:none;transition:all 0.2s;background:var(--bg-primary);color:var(--text-primary);box-sizing:border-box;cursor:pointer;" onfocus="this.style.borderColor='var(--primary)';this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'" onblur="this.style.borderColor='var(--border-light)';this.style.boxShadow='none'">
                      <option value="zh-CN" selected>ç®€ä½“ä¸­æ–‡</option>
                      <option value="zh-TW">ç¹ä½“ä¸­æ–‡</option>
                      <option value="en-US">English</option>
                    </select>
                  </div>
                  <div style="margin-bottom:12px;">
                    <div style="color:var(--text-secondary);font-size:12px;margin-bottom:8px;">æ—¶åŒºè®¾ç½®</div>
                    <select id="timezoneSelect" style="width:100%;padding:12px 14px;border-radius:12px;border:2px solid var(--border-light);font-size:13px;outline:none;transition:all 0.2s;background:var(--bg-primary);color:var(--text-primary);box-sizing:border-box;cursor:pointer;" onfocus="this.style.borderColor='var(--primary)';this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'" onblur="this.style.borderColor='var(--border-light)';this.style.boxShadow='none'">
                      <option value="local" selected>æœ¬åœ°æ—¶åŒº</option>
                      <option value="UTC">UTC</option>
                    </select>
                  </div>
                  <div>
                    <div style="color:var(--text-secondary);font-size:12px;margin-bottom:8px;">æ—¥æœŸæ ¼å¼</div>
                    <select id="dateFormatSelect" style="width:100%;padding:12px 14px;border-radius:12px;border:2px solid var(--border-light);font-size:13px;outline:none;transition:all 0.2s;background:var(--bg-primary);color:var(--text-primary);box-sizing:border-box;cursor:pointer;" onfocus="this.style.borderColor='var(--primary)';this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'" onblur="this.style.borderColor='var(--border-light)';this.style.boxShadow='none'">
                      <option value="YYYY-MM-DD" selected>YYYY-MM-DD</option>
                      <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                      <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                    </select>
                  </div>
                </div>
                
                <!-- å…³äº -->
                <div style="background:var(--bg-secondary);border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.08);margin-bottom:20px;">
                  <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <span style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg, #667eea20 0%, #764ba220 100%);display:flex;align-items:center;justify-content:center;font-size:16px;">â„¹ï¸</span>
                    <label style="color:var(--text-primary);font-size:13px;font-weight:600;flex:1;">å…³äº</label>
                  </div>
                  <div style="padding:16px;background:linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%);border-radius:12px;text-align:center;">
                    <div style="font-size:32px;margin-bottom:12px;">ğŸ•Šï¸</div>
                    <h4 style="margin:0 0 8px;font-size:16px;color:var(--text-primary);font-weight:600;">æ™ºé¸½ï½œPigeonAI</h4>
                    <p style="margin:0 0 12px;font-size:12px;color:var(--text-secondary);line-height:1.6;">
                      ç‰ˆæœ¬: 2.0.0<br>
                      æ¯åªé¸½å­ï¼Œçš†æ˜¯èµ›çº§<br>
                      <span style="font-size:11px;">Every Pigeon, Race-Grade</span>
                    </p>
                  </div>
                </div>
                
                <!-- å…³é—­æŒ‰é’® -->
                <button onclick="closeSettingsModal()" class="btn btn-outline" style="width:100%;border:2px solid var(--border-light);padding:12px;border-radius:12px;background:var(--bg-secondary);color:var(--text-secondary);font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--text-secondary)';this.style.color='var(--text-primary)'" onmouseout="this.style.borderColor='var(--border-light)';this.style.color='var(--text-secondary)'">å…³é—­</button>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', menuHTML);
      }
      
      // è®¾ç½®å½“å‰ä¸»é¢˜
      const currentTheme = localStorage.getItem('pigeon_theme_preference') || 'light';
      const themeSelect = document.getElementById('themeSelect');
      if (themeSelect) themeSelect.value = currentTheme;
      
      // åŠ è½½è®¾ç½®
      loadSettingsValues();
      
      document.getElementById('settingsModal').style.display = 'flex';
    }
    
    // å…³é—­è®¾ç½®æ¨¡æ€æ¡†
    window.closeSettingsModal = function() {
      const modal = document.getElementById('settingsModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    // åŠ è½½è®¾ç½®å€¼
    function loadSettingsValues() {
      // å­—ä½“å¤§å°
      const fontSize = localStorage.getItem('pigeon_font_size') || 'medium';
      const fontSizeSelect = document.getElementById('fontSizeSelect');
      if (fontSizeSelect) fontSizeSelect.value = fontSize;
      
      // ç•Œé¢å¯†åº¦
      const density = localStorage.getItem('pigeon_density') || 'normal';
      const densitySelect = document.getElementById('densitySelect');
      if (densitySelect) densitySelect.value = density;
      
      // è‡ªåŠ¨å¤‡ä»½
      const autoBackup = localStorage.getItem('pigeon_auto_backup') === 'true';
      const autoBackupToggle = document.getElementById('autoBackupToggle');
      if (autoBackupToggle) {
        autoBackupToggle.checked = autoBackup;
        updateSwitchStyle('autoBackupSlider', autoBackup);
      }
      
      // é€šçŸ¥è®¾ç½®
      const systemNotification = localStorage.getItem('pigeon_system_notification') !== 'false';
      const systemNotificationToggle = document.getElementById('systemNotificationToggle');
      if (systemNotificationToggle) {
        systemNotificationToggle.checked = systemNotification;
        updateSwitchStyle('systemNotificationSlider', systemNotification);
      }
      
      const dataUpdateNotification = localStorage.getItem('pigeon_data_update_notification') !== 'false';
      const dataUpdateNotificationToggle = document.getElementById('dataUpdateNotificationToggle');
      if (dataUpdateNotificationToggle) {
        dataUpdateNotificationToggle.checked = dataUpdateNotification;
        updateSwitchStyle('dataUpdateNotificationSlider', dataUpdateNotification);
      }
      
      const eventNotification = localStorage.getItem('pigeon_event_notification') !== 'false';
      const eventNotificationToggle = document.getElementById('eventNotificationToggle');
      if (eventNotificationToggle) {
        eventNotificationToggle.checked = eventNotification;
        updateSwitchStyle('eventNotificationSlider', eventNotification);
      }
      
      // è¯­è¨€è®¾ç½®
      const language = localStorage.getItem('pigeon_language') || 'zh-CN';
      const languageSelect = document.getElementById('languageSelect');
      if (languageSelect) languageSelect.value = language;
      
      // æ—¶åŒºè®¾ç½®
      const timezone = localStorage.getItem('pigeon_timezone') || 'local';
      const timezoneSelect = document.getElementById('timezoneSelect');
      if (timezoneSelect) timezoneSelect.value = timezone;
      
      // æ—¥æœŸæ ¼å¼
      const dateFormat = localStorage.getItem('pigeon_date_format') || 'YYYY-MM-DD';
      const dateFormatSelect = document.getElementById('dateFormatSelect');
      if (dateFormatSelect) dateFormatSelect.value = dateFormat;
    }
    
    // æ›´æ–°å¼€å…³æ ·å¼
    function updateSwitchStyle(sliderId, checked) {
      const slider = document.getElementById(sliderId);
      if (slider) {
        slider.style.backgroundColor = checked ? '#667eea' : '#ccc';
        slider.style.transform = checked ? 'translateX(20px)' : 'translateX(0)';
      }
    }
    
    // ä¿å­˜è‡ªåŠ¨å¤‡ä»½è®¾ç½®
    function saveAutoBackupSetting(enabled) {
      localStorage.setItem('pigeon_auto_backup', enabled);
      updateSwitchStyle('autoBackupSlider', enabled);
    }
    
    // ä¿å­˜é€šçŸ¥è®¾ç½®
    function saveNotificationSetting(type, enabled) {
      const key = type === 'system' ? 'pigeon_system_notification' : 
                  type === 'dataUpdate' ? 'pigeon_data_update_notification' : 
                  'pigeon_event_notification';
      localStorage.setItem(key, enabled);
      const sliderId = type === 'system' ? 'systemNotificationSlider' : 
                       type === 'dataUpdate' ? 'dataUpdateNotificationSlider' : 
                       'eventNotificationSlider';
      updateSwitchStyle(sliderId, enabled);
    }
    
    // æ˜¾ç¤ºæ•°æ®ç»Ÿè®¡
    function showDataStats() {
      const pigeons = loadPigeons();
      const races = loadRaces();
      const healthRecords = JSON.parse(localStorage.getItem(HEALTH_RECORDS_KEY) || '[]');
      const trainingRecords = JSON.parse(localStorage.getItem(TRAINING_STORAGE_KEY) || '[]');
      const pairings = JSON.parse(localStorage.getItem(PAIRING_RECORDS_KEY) || '[]');
      const qualificationRecords = JSON.parse(localStorage.getItem(QUALIFICATION_STORAGE_KEY) || '[]');
      
      const stats = {
        pigeons: pigeons.length,
        races: races.length,
        healthRecords: healthRecords.length,
        trainingRecords: trainingRecords.length,
        pairings: pairings.length,
        qualificationRecords: qualificationRecords.length
      };
      
      const statsText = `æ•°æ®ç»Ÿè®¡\n\n` +
        `é¸½å­è®°å½•: ${stats.pigeons} æ¡\n` +
        `æ¯”èµ›è®°å½•: ${stats.races} æ¡\n` +
        `å¥åº·è®°å½•: ${stats.healthRecords} æ¡\n` +
        `è®­ç»ƒè®°å½•: ${stats.trainingRecords} æ¡\n` +
        `é…å¯¹è®°å½•: ${stats.pairings} æ¡\n` +
        `èµ„æ ¼è®°å½•: ${stats.qualificationRecords} æ¡`;
      
      alert(statsText);
    }
    
    // å¤‡ä»½æ•°æ®
    function backupData() {
      exportData();
    }
    
    // å¤„ç†å¯¼å…¥æ–‡ä»¶
    function handleImportFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          if (confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
            if (data.pigeons) {
              localStorage.setItem('pigeon_manager_data_v1', JSON.stringify(data.pigeons));
            }
            if (data.races) {
              localStorage.setItem('pigeon_races_v1', JSON.stringify(data.races));
            }
            if (data.healthRecords) {
              localStorage.setItem(HEALTH_RECORDS_KEY, JSON.stringify(data.healthRecords));
            }
            if (data.trainingRecords) {
              localStorage.setItem(TRAINING_STORAGE_KEY, JSON.stringify(data.trainingRecords));
            }
            if (data.pairings) {
              localStorage.setItem(PAIRING_RECORDS_KEY, JSON.stringify(data.pairings));
            }
            if (data.qualificationRecords) {
              localStorage.setItem(QUALIFICATION_STORAGE_KEY, JSON.stringify(data.qualificationRecords));
            }
            
            alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ã€‚');
            location.reload();
          }
        } catch (error) {
          alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
        }
      };
      reader.readAsText(file);
    }
    
    // æ˜¾ç¤ºAPIé…ç½®æ¨¡æ€æ¡†
    window.showApiConfigModal = function(type) {
      const apiConfig = getApiConfig();
      const apiUrl = type === 'èµ„è®¯' ? apiConfig.newsApiUrl : apiConfig.eventsApiUrl;
      const apiKey = apiConfig.apiKey || '';
      
      const newsApiUrl = prompt(`è¯·è¾“å…¥${type === 'èµ„è®¯' ? 'èµ„è®¯' : 'èµ›äº‹'}APIåœ°å€:`, apiUrl || '');
      if (newsApiUrl === null) return; // ç”¨æˆ·å–æ¶ˆ
      
      const newApiKey = prompt('è¯·è¾“å…¥APIå¯†é’¥ï¼ˆå¯é€‰ï¼Œç›´æ¥å›è½¦è·³è¿‡ï¼‰:', apiKey);
      
      const newConfig = {
        ...apiConfig,
        [type === 'èµ„è®¯' ? 'newsApiUrl' : 'eventsApiUrl']: newsApiUrl,
        apiKey: newApiKey || apiKey
      };
      
      // ä¿å­˜APIé…ç½®
      localStorage.setItem('pigeon_api_config', JSON.stringify(newConfig));
      
      alert('APIé…ç½®å·²ä¿å­˜');
    };
    
    // æµ‹è¯•APIè¿æ¥
    async function testApiConnection() {
      const apiConfig = getApiConfig();
      const apiStatusDesc = document.getElementById('apiStatusDesc');
      
      if (apiStatusDesc) {
        apiStatusDesc.textContent = 'æ­£åœ¨æµ‹è¯•è¿æ¥...';
      }
      
      try {
        // æµ‹è¯•èµ„è®¯API
        if (apiConfig.newsApiUrl) {
          const response = await fetch(apiConfig.newsApiUrl, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            if (apiStatusDesc) {
              apiStatusDesc.textContent = 'APIè¿æ¥æ­£å¸¸';
            }
            alert('APIè¿æ¥æµ‹è¯•æˆåŠŸï¼');
            return;
          }
        }
        
        // æµ‹è¯•èµ›äº‹API
        if (apiConfig.eventsApiUrl) {
          const response = await fetch(apiConfig.eventsApiUrl, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            if (apiStatusDesc) {
              apiStatusDesc.textContent = 'APIè¿æ¥æ­£å¸¸';
            }
            alert('APIè¿æ¥æµ‹è¯•æˆåŠŸï¼');
            return;
          }
        }
        
        if (apiStatusDesc) {
          apiStatusDesc.textContent = 'APIæœªé…ç½®æˆ–è¿æ¥å¤±è´¥';
        }
        alert('APIè¿æ¥æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIåœ°å€æ˜¯å¦æ­£ç¡®');
      } catch (error) {
        if (apiStatusDesc) {
          apiStatusDesc.textContent = 'APIè¿æ¥å¤±è´¥';
        }
        alert('APIè¿æ¥æµ‹è¯•å¤±è´¥ï¼š' + error.message);
      }
    }
    
    // ç»‘å®šè®¾ç½®å˜æ›´äº‹ä»¶
    document.addEventListener('DOMContentLoaded', function() {
      // å­—ä½“å¤§å°
      const fontSizeSelect = document.getElementById('fontSizeSelect');
      if (fontSizeSelect) {
        fontSizeSelect.addEventListener('change', function() {
          localStorage.setItem('pigeon_font_size', this.value);
          document.documentElement.setAttribute('data-font-size', this.value);
        });
      }
      
      // ç•Œé¢å¯†åº¦
      const densitySelect = document.getElementById('densitySelect');
      if (densitySelect) {
        densitySelect.addEventListener('change', function() {
          localStorage.setItem('pigeon_density', this.value);
          document.documentElement.setAttribute('data-density', this.value);
        });
      }
      
      // è¯­è¨€è®¾ç½®
      const languageSelect = document.getElementById('languageSelect');
      if (languageSelect) {
        languageSelect.addEventListener('change', function() {
          localStorage.setItem('pigeon_language', this.value);
        });
      }
      
      // æ—¶åŒºè®¾ç½®
      const timezoneSelect = document.getElementById('timezoneSelect');
      if (timezoneSelect) {
        timezoneSelect.addEventListener('change', function() {
          localStorage.setItem('pigeon_timezone', this.value);
        });
      }
      
      // æ—¥æœŸæ ¼å¼
      const dateFormatSelect = document.getElementById('dateFormatSelect');
      if (dateFormatSelect) {
        dateFormatSelect.addEventListener('change', function() {
          localStorage.setItem('pigeon_date_format', this.value);
        });
      }
    });

    // ========================================
    // ğŸ” æ™ºèƒ½æœç´¢åŠŸèƒ½
    // ========================================
    
    // è§£æè‡ªç„¶è¯­è¨€æœç´¢
    function parseSmartSearch(query) {
      const conditions = {
        year: null,
        gender: null,
        type: null,
        hasAward: false,
        hasRaces: false,
        isCore: false,
        isAlive: null,
        ring: null,
        name: null,
        owner: null
      };
      
      const q = query.toLowerCase().trim();
      
      // å¹´ä»½åŒ¹é… (2020-2030)
      const yearMatch = q.match(/20[2-3][0-9]/);
      if (yearMatch) {
        conditions.year = yearMatch[0];
      }
      
      // æ€§åˆ«åŒ¹é…
      if (q.includes('å…¬') || q.includes('é›„')) {
        conditions.gender = 'å…¬';
      } else if (q.includes('æ¯') || q.includes('é›Œ')) {
        conditions.gender = 'æ¯';
      }
      
      // ç±»å‹åŒ¹é…
      if (q.includes('ç§é¸½')) {
        conditions.type = 'ç§é¸½';
      } else if (q.includes('æ¯”èµ›')) {
        conditions.type = 'æ¯”èµ›é¸½';
      } else if (q.includes('åä»£')) {
        conditions.type = 'åä»£é¸½';
      }
      
      // æˆç»©åŒ¹é…
      if (q.includes('è¿›å¥–') || q.includes('è·å¥–') || q.includes('å‰ä¸‰') || q.includes('å† å†›')) {
        conditions.hasAward = true;
      }
      if (q.includes('å‚èµ›') || q.includes('æ¯”èµ›')) {
        conditions.hasRaces = true;
      }
      
      // æ ¸å¿ƒç§é¸½
      if (q.includes('æ ¸å¿ƒ')) {
        conditions.isCore = true;
      }
      
      // çŠ¶æ€åŒ¹é…
      if (q.includes('åœ¨ä¸–') || q.includes('å­˜æ´»')) {
        conditions.isAlive = true;
      } else if (q.includes('æ­»äº¡') || q.includes('å·²æ•…')) {
        conditions.isAlive = false;
      }
      
      // å¦‚æœæ²¡æœ‰åŒ¹é…ä»»ä½•æ¡ä»¶ï¼Œä½œä¸ºè¶³ç¯å·ã€åå­—æˆ–é¸½ä¸»æœç´¢
      if (!conditions.year && !conditions.gender && !conditions.type && 
          !conditions.hasAward && !conditions.hasRaces && !conditions.isCore && 
          conditions.isAlive === null) {
        conditions.ring = q;
        conditions.name = q;
        conditions.owner = q;
      }
      
      return conditions;
    }
    
    // æ‰§è¡Œæ™ºèƒ½æœç´¢
    function executeSmartSearch(query) {
      const pigeons = loadPigeons();
      if (!query || query.trim() === '') return pigeons;
      
      const conditions = parseSmartSearch(query);
      const q = query.toLowerCase().trim();
      
      // åˆ¤æ–­æ˜¯å¦ä¸ºç›´æ¥æœç´¢æ¨¡å¼ï¼ˆæ²¡æœ‰åŒ¹é…åˆ°ç‰¹æ®Šæ¡ä»¶ï¼‰
      const isDirectSearch = conditions.ring && conditions.name && conditions.owner && 
                             !conditions.year && !conditions.gender && !conditions.type && 
                             !conditions.hasAward && !conditions.hasRaces && !conditions.isCore && 
                             conditions.isAlive === null;
      
      return pigeons.filter(p => {
        // ç›´æ¥æœç´¢æ¨¡å¼ï¼šåªåŒ¹é…è¶³ç¯å·ã€åå­—æˆ–é¸½ä¸»
        if (isDirectSearch) {
          const ringMatch = (p.ring || '').toLowerCase().includes(q);
          const nameMatch = (p.name || '').toLowerCase().includes(q);
          const ownerMatch = (p.currentOwner || '').toLowerCase().includes(q);
          return ringMatch || nameMatch || ownerMatch;
        }
        
        // æ¡ä»¶æœç´¢æ¨¡å¼ï¼šéœ€è¦æ»¡è¶³æ‰€æœ‰æ¡ä»¶
        // å¹´ä»½æ¡ä»¶
        if (conditions.year) {
          const birthYear = (p.birth || '').substring(0, 4);
          if (birthYear !== conditions.year) return false;
        }
        
        // æ€§åˆ«æ¡ä»¶
        if (conditions.gender && p.gender !== conditions.gender) return false;
        
        // ç±»å‹æ¡ä»¶
        if (conditions.type && p.type !== conditions.type) return false;
        
        // è·å¥–æ¡ä»¶
        if (conditions.hasAward) {
          const hasAward = (p.races || []).some(r => r.rank && r.rank <= 3);
          if (!hasAward) return false;
        }
        
        // å‚èµ›æ¡ä»¶
        if (conditions.hasRaces) {
          if (!p.races || p.races.length === 0) return false;
        }
        
        // æ ¸å¿ƒç§é¸½
        if (conditions.isCore && !p.isCore) return false;
        
        // å­˜æ´»çŠ¶æ€
        if (conditions.isAlive !== null && p.alive !== conditions.isAlive) return false;
        
        // å¦‚æœè®¾ç½®äº† ring/name/ownerï¼Œä¹Ÿéœ€è¦æ£€æŸ¥è¿™äº›å­—æ®µï¼ˆæ¡ä»¶æœç´¢æ¨¡å¼ä¸‹ä½œä¸ºé¢å¤–æ¡ä»¶ï¼‰
        if (conditions.ring || conditions.name || conditions.owner) {
          const ringMatch = conditions.ring ? (p.ring || '').toLowerCase().includes(q) : true;
          const nameMatch = conditions.name ? (p.name || '').toLowerCase().includes(q) : true;
          const ownerMatch = conditions.owner ? (p.currentOwner || '').toLowerCase().includes(q) : true;
          if (!ringMatch && !nameMatch && !ownerMatch) return false;
        }
        
        return true;
      });
    }
    
    // æ˜¾ç¤ºæœç´¢å»ºè®®
    function showMobileSearchSuggestions(query) {
      const container = document.getElementById('mobileSearchSuggestions');
      if (!container) return;
      
      if (!query || query.trim() === '') {
        container.classList.remove('show');
        return;
      }
      
      const results = executeSmartSearch(query).slice(0, 8);
      
      if (results.length === 0) {
        container.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text-secondary);">æœªæ‰¾åˆ°åŒ¹é…ç»“æœ</div>';
        container.classList.add('show');
        return;
      }
      
      container.innerHTML = results.map(p => {
        const statusText = p.alive !== false ? 'åœ¨ä¸–' : 'å·²æ­»äº¡';
        const statusClass = p.alive !== false ? 'tag-alive' : 'tag-dead';
        return `
          <div class="mobile-search-suggestion-item" data-pigeon-id="${p.id || p.ring}" onclick="handleSearchSuggestionClick('${p.id || p.ring}')">
            <div>
              <div style="font-weight:600;color:var(--text-primary);">${escapeHtml(p.name || p.ring)}</div>
              <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">
                ${escapeHtml(p.ring)} | ${p.gender || 'â€”'} | ${p.type || 'â€”'}${p.currentOwner ? ' | é¸½ä¸»: ' + escapeHtml(p.currentOwner) : ''}
              </div>
            </div>
            <div>
              <span class="${statusClass}" style="padding:2px 6px;border-radius:4px;font-size:10px;">${statusText}</span>
            </div>
          </div>
        `;
      }).join('');
      
      container.classList.add('show');
    }
    
    // å¤„ç†æœç´¢å»ºè®®ç‚¹å‡»
    function handleSearchSuggestionClick(pigeonId) {
      const container = document.getElementById('mobileSearchSuggestions');
      const input = document.getElementById('mobileSmartSearchInput');
      if (container) container.classList.remove('show');
      if (input) input.value = '';
      viewPigeonDetail(pigeonId);
      switchView('pigeons');
    }

    // æ£€æŸ¥URLå‚æ•°ï¼Œåˆ¤æ–­æ˜¯å¦ä»app.htmlè·³è½¬è¿‡æ¥
    const urlParams = new URLSearchParams(window.location.search);
    const restored = urlParams.get('restored') === 'true';
    const deviceType = urlParams.get('device') || 'mobile';
    
    // å¦‚æœæ˜¯ä»app.htmlè·³è½¬è¿‡æ¥ä¸”æ ‡è®°ä¸ºå·²æ¢å¤ï¼Œæ˜¾ç¤ºæç¤º
    if (restored) {
      setTimeout(() => {
        alert('âœ… æ•°æ®å·²ä»äº‘ç«¯æ¢å¤');
      }, 2000);
    }
    
    // å¼ºåˆ¶æ˜¾ç¤ºé¦–é¡µçš„è¾…åŠ©å‡½æ•°ï¼ˆä½¿ç”¨æœ€å¼ºåŠ›çš„æ–¹æ³•ï¼‰
    function forceShowHomeView() {
      try {
        const homeView = document.getElementById('homeView');
        const mobileContent = document.querySelector('.mobile-content');
        const body = document.body;
        
        // ç¡®ä¿bodyå¯è§
        if (body) {
          body.style.setProperty('display', 'block', 'important');
          body.style.setProperty('visibility', 'visible', 'important');
          body.style.setProperty('opacity', '1', 'important');
        }
        
        // ç¡®ä¿mobile-contentå¯è§
        if (mobileContent) {
          mobileContent.style.setProperty('display', 'block', 'important');
          mobileContent.style.setProperty('visibility', 'visible', 'important');
          mobileContent.style.setProperty('opacity', '1', 'important');
        }
        
        if (homeView) {
          // éšè—å…¶ä»–è§†å›¾
          const allViews = document.querySelectorAll('.mobile-view');
          allViews.forEach(view => {
            if (view.id && view.id !== 'homeView') {
              view.style.setProperty('display', 'none', 'important');
            }
          });
          
          // ä½¿ç”¨setPropertyè®¾ç½®!importantä¼˜å…ˆçº§ï¼ˆæœ€å¼ºåŠ›ï¼‰
          homeView.style.setProperty('display', 'block', 'important');
          homeView.style.setProperty('visibility', 'visible', 'important');
          homeView.style.setProperty('opacity', '1', 'important');
          homeView.style.setProperty('position', 'relative', 'important');
          homeView.style.setProperty('width', '100%', 'important');
          // ä¿®å¤height: 0pxé—®é¢˜ - å…ˆè®¾ç½®æœ€å°é«˜åº¦ï¼Œå†è®¾ç½®ä¸ºauto
          homeView.style.setProperty('min-height', '600px', 'important');
          homeView.style.setProperty('height', 'auto', 'important');
          // ç¡®ä¿overflowæ­£å¸¸
          homeView.style.setProperty('overflow', 'visible', 'important');
          
          // ç§»é™¤å¯èƒ½éšè—å…ƒç´ çš„ç±»
          homeView.classList.remove('hidden', 'd-none');
          
          // ç¡®ä¿homeViewå†…çš„å†…å®¹ä¹Ÿæ˜¯å¯è§çš„
          const homeViewChildren = homeView.querySelectorAll('*');
          homeViewChildren.forEach(child => {
            const computedStyle = window.getComputedStyle(child);
            if (computedStyle.display === 'none' && child.tagName !== 'SCRIPT' && child.tagName !== 'STYLE') {
              child.style.setProperty('display', '', 'important');
            }
          });
          
          console.log('âœ… å·²å¼ºåˆ¶æ˜¾ç¤ºé¦–é¡µè§†å›¾ï¼Œé«˜åº¦:', homeView.offsetHeight);
          return true;
        } else {
          console.error('âŒ æ‰¾ä¸åˆ°homeViewå…ƒç´ ');
          return false;
        }
      } catch (e) {
        console.error('âŒ å¼ºåˆ¶æ˜¾ç¤ºé¦–é¡µå¤±è´¥:', e);
        return false;
      }
    }
    
    // åˆå§‹åŒ–è§†å›¾
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸ”§ å¼€å§‹åˆå§‹åŒ–é¡µé¢è§†å›¾...');
      
      // é‡æ–°åˆå§‹åŒ–viewså¯¹è±¡ï¼Œç¡®ä¿DOMå…ƒç´ å·²åŠ è½½
      views = getViews();
      
      // é»˜è®¤æ˜¾ç¤ºé¦–é¡µï¼ˆç¡®ä¿é¡µé¢å¯è§ï¼‰
      try {
        // å…ˆæ˜¾ç¤ºé¦–é¡µï¼ˆç¡®ä¿é¡µé¢å¯è§ï¼‰
        const homeView = document.getElementById('homeView');
        if (homeView) {
          // ä½¿ç”¨setPropertyç¡®ä¿ä¼˜å…ˆçº§æœ€é«˜
          homeView.style.setProperty('display', 'block', 'important');
          homeView.style.setProperty('visibility', 'visible', 'important');
          homeView.style.setProperty('opacity', '1', 'important');
          // ä¿®å¤height: 0pxé—®é¢˜
          homeView.style.setProperty('min-height', '600px', 'important');
          homeView.style.setProperty('height', 'auto', 'important');
          views.home = homeView;
          console.log('âœ… é¡µé¢è§†å›¾å·²åˆå§‹åŒ–ï¼Œæ˜¾ç¤ºé¦–é¡µ');
        } else {
          console.error('âŒ æ‰¾ä¸åˆ°homeViewå…ƒç´ ');
          // å»¶è¿Ÿé‡è¯•
          setTimeout(forceShowHomeView, 100);
        }
        
        // ç„¶åéšè—å…¶ä»–è§†å›¾ï¼ˆä½†ä¸è¦éšè—homeViewï¼‰
        const otherViews = ['listView', 'raceView', 'statsView', 'pedigreeView', 
                         'breedingView', 'healthView', 'trainingView', 'analysisView', 
                         'qualificationView', 'dashboardView', 'moreView', 'detailView'];
        otherViews.forEach(viewId => {
          const viewEl = document.getElementById(viewId);
          if (viewEl) {
            viewEl.style.display = 'none';
          }
        });
      } catch (e) {
        console.error('âŒ åˆå§‹åŒ–è§†å›¾å¤±è´¥:', e);
        // å³ä½¿å‡ºé”™ï¼Œä¹Ÿå°è¯•æ˜¾ç¤ºé¦–é¡µ
        forceShowHomeView();
      }
      
      // å»¶è¿Ÿå¤šæ¬¡æ£€æŸ¥ï¼Œç¡®ä¿é¦–é¡µæ˜¾ç¤ºï¼ˆé˜²æ­¢è¢«å…¶ä»–è„šæœ¬éšè—ï¼‰
      setTimeout(() => {
        const homeView = document.getElementById('homeView');
        if (homeView) {
          const computedStyle = window.getComputedStyle(homeView);
          if (computedStyle.display === 'none' || 
              computedStyle.visibility === 'hidden' || 
              computedStyle.opacity === '0' ||
              homeView.style.display === 'none') {
            console.warn('âš ï¸ [åˆå§‹åŒ–æ£€æŸ¥] é¦–é¡µè¢«éšè—ï¼Œå¼ºåˆ¶æ˜¾ç¤º');
            forceShowHomeView();
          }
        }
      }, 100);
      setTimeout(() => {
        const homeView = document.getElementById('homeView');
        if (homeView) {
          const computedStyle = window.getComputedStyle(homeView);
          if (computedStyle.display === 'none' || 
              computedStyle.visibility === 'hidden' || 
              computedStyle.opacity === '0' ||
              homeView.style.display === 'none') {
            console.warn('âš ï¸ [åˆå§‹åŒ–æ£€æŸ¥] é¦–é¡µè¢«éšè—ï¼Œå¼ºåˆ¶æ˜¾ç¤º');
            forceShowHomeView();
          }
        }
      }, 500);
      setTimeout(() => {
        const homeView = document.getElementById('homeView');
        if (homeView) {
          const computedStyle = window.getComputedStyle(homeView);
          if (computedStyle.display === 'none' || 
              computedStyle.visibility === 'hidden' || 
              computedStyle.opacity === '0' ||
              homeView.style.display === 'none') {
            console.warn('âš ï¸ [åˆå§‹åŒ–æ£€æŸ¥] é¦–é¡µè¢«éšè—ï¼Œå¼ºåˆ¶æ˜¾ç¤º');
            forceShowHomeView();
          }
        }
      }, 1000);
      // åˆå§‹åŒ–æ•°æ®
      // å®šæ—¶å™¨IDå­˜å‚¨ï¼ˆç”¨äºæ¸…ç†ï¼‰
      const mobileTimers = {
        updateDate: null,
        updateUserButton: null
      };
      
      try {
        updateDate();
        loadData();
      } catch (e) {
        console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', e);
      }
      mobileTimers.updateDate = setInterval(updateDate, 60000);
      
      // é¡µé¢åŠ è½½åï¼Œå¦‚æœæœ¬åœ°æ•°æ®ç¼ºå¤±ä¸”å·²ç™»å½•ï¼Œåˆ™å°è¯•ä»åå°/äº‘ç«¯æ¢å¤æ•°æ®
      setTimeout(() => {
        restoreUserDataIfMissing();
      }, 1500);
      
      // æ›´æ–°ç”¨æˆ·æŒ‰é’®æ˜¾ç¤º
      setTimeout(() => {
        updateMobileUserButton();
      }, 500);
      
      // ç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–ï¼ˆæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
      mobileTimers.updateUserButton = setInterval(() => {
        updateMobileUserButton();
      }, 5000);
      
      // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
      window.addEventListener('beforeunload', () => {
        if (mobileTimers.updateDate) clearInterval(mobileTimers.updateDate);
        if (mobileTimers.updateUserButton) clearInterval(mobileTimers.updateUserButton);
      });
      
      // åˆå§‹åŒ–æ™ºèƒ½æœç´¢
      const mobileSearchInput = document.getElementById('mobileSmartSearchInput');
      if (mobileSearchInput) {
        let searchTimeout;
        mobileSearchInput.addEventListener('input', (e) => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            showMobileSearchSuggestions(e.target.value);
          }, 200);
        });
        
        mobileSearchInput.addEventListener('focus', () => {
          if (mobileSearchInput.value.trim()) {
            showMobileSearchSuggestions(mobileSearchInput.value);
          }
        });
        
        mobileSearchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            const query = mobileSearchInput.value.trim();
            if (query) {
              const results = executeSmartSearch(query);
              if (results.length > 0) {
                handleSearchSuggestionClick(results[0].id || results[0].ring);
              }
            }
          } else if (e.key === 'Escape') {
            const container = document.getElementById('mobileSearchSuggestions');
            if (container) container.classList.remove('show');
            mobileSearchInput.blur();
          }
        });
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­å»ºè®®
        document.addEventListener('click', (e) => {
          const container = document.getElementById('mobileSearchSuggestions');
          if (container && !container.contains(e.target) && e.target !== mobileSearchInput) {
            container.classList.remove('show');
          }
        });
      }
    });

    // HTMLè½¬ä¹‰å‡½æ•°ï¼Œé˜²æ­¢XSSæ”»å‡»
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ä»PCç«¯åŠ è½½é¸½å­æ•°æ®ï¼ˆä½¿ç”¨ä¸PCç«¯ç›¸åŒçš„å­˜å‚¨é”®ï¼‰
    function loadPigeons() {
      try {
        const STORAGE_KEY = 'pigeon_manager_data_v1'; // ä¸PCç«¯ä¿æŒä¸€è‡´
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const data = JSON.parse(raw);
          return Array.isArray(data) ? data : [];
        }
      } catch (e) {
        console.error('åŠ è½½é¸½å­æ•°æ®å¤±è´¥:', e);
      }
      return [];
    }

    // åˆ‡æ¢é¸½å­è§†å›¾æ¨¡å¼
    function switchPigeonView(view) {
      currentPigeonView = view;
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.getElementById('pigeonViewCard').classList.toggle('active', view === 'card');
      document.getElementById('pigeonViewTable').classList.toggle('active', view === 'table');
      
      // é‡æ–°æ¸²æŸ“åˆ—è¡¨
      refreshList();
    }
    
    // åˆ·æ–°é¸½å­åˆ—è¡¨
    function refreshList() {
      const container = document.getElementById('pigeonListContainer');
      if (!container) return;
      
      const pigeons = loadPigeons();
      
      if (pigeons.length === 0) {
        if (currentPigeonView === 'table') {
          container.className = 'mobile-table-view';
          container.innerHTML = `
            <div class="mobile-empty" style="padding: 40px 20px; text-align: center; color: var(--text-secondary);">
              <p style="margin-bottom: 16px;">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆç‚¹å‡»å³ä¸Šè§’ã€Œâ•ã€æ–°å¢é¸½å­ä¿¡æ¯ã€‚</p>
            </div>
          `;
        } else {
          container.className = 'mobile-list';
          container.innerHTML = `
            <div class="mobile-empty">
              <p>æš‚æ— æ•°æ®ï¼Œè¯·å…ˆç‚¹å‡»å³ä¸Šè§’ã€Œâ•ã€æ–°å¢é¸½å­ä¿¡æ¯ã€‚</p>
              <button class="btn-primary" onclick="goToCreatePigeon()" style="margin-top: 16px;">â• æ·»åŠ ç¬¬ä¸€åªé¸½å­</button>
            </div>
          `;
        }
        return;
      }
      
      // åˆ›å»ºIDåˆ°é¸½å­å¯¹è±¡çš„æ˜ å°„ï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾
      const pigeonMap = {};
      pigeons.forEach(p => {
        if (p.id) pigeonMap[p.id] = p;
      });
      
      if (currentPigeonView === 'table') {
        // è¡¨æ ¼è§†å›¾
        container.className = 'mobile-table-view';
        container.innerHTML = `
          <table class="mobile-table">
            <thead>
              <tr>
                <th>è¶³ç¯å·</th>
                <th>åç§°</th>
                <th>ç±»å‹</th>
                <th>çŠ¶æ€</th>
                <th>çˆ¶é¸½ / æ¯é¸½</th>
                <th>ç°é¸½ä¸»</th>
                <th>å‚èµ›è®°å½•æ•°</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${pigeons.map(p => {
                const father = p.fatherId ? pigeonMap[p.fatherId] : null;
                const mother = p.motherId ? pigeonMap[p.motherId] : null;
                const fatherName = father ? (father.name || father.ring || 'â€”') : 'â€”';
                const motherName = mother ? (mother.name || mother.ring || 'â€”') : 'â€”';
                const parentsText = fatherName + ' / ' + motherName;
                const raceCount = (p.races && Array.isArray(p.races)) ? p.races.length : 0;
                const statusText = p.alive !== false ? 'åœ¨ä¸–' : 'å·²æ­»äº¡';
                const statusClass = p.alive !== false ? 'tag-alive' : 'tag-dead';
                
                return `
                  <tr>
                    <td onclick="viewPigeonDetail('${p.id || p.ring}')" style="cursor:pointer;">${escapeHtml(p.ring || 'â€”')}${p.ringRecycled ? '<span style="background:#fff3cd;color:#856404;padding:2px 4px;border-radius:3px;font-size:9px;margin-left:4px;">å›æ”¶</span>' : ''}</td>
                    <td onclick="viewPigeonDetail('${p.id || p.ring}')" style="cursor:pointer;">${escapeHtml(p.name || 'â€”')}${p.isCore ? '<span style="background:#fef3c7;color:#b45309;padding:2px 4px;border-radius:3px;font-size:9px;margin-left:4px;">æ ¸å¿ƒ</span>' : ''}</td>
                    <td onclick="viewPigeonDetail('${p.id || p.ring}')" style="cursor:pointer;">${escapeHtml(p.type || 'â€”')}</td>
                    <td onclick="viewPigeonDetail('${p.id || p.ring}')" style="cursor:pointer;"><span class="${statusClass}" style="padding:2px 6px;border-radius:4px;font-size:10px;">${statusText}</span></td>
                    <td onclick="viewPigeonDetail('${p.id || p.ring}')" style="cursor:pointer;">${escapeHtml(parentsText)}</td>
                    <td onclick="viewPigeonDetail('${p.id || p.ring}')" style="cursor:pointer;">${escapeHtml(p.currentOwner || 'â€”')}</td>
                    <td onclick="viewPigeonDetail('${p.id || p.ring}')" style="cursor:pointer;text-align:center;">${raceCount}</td>
                    <td style="text-align:center;">
                      ${p.alive !== false ? `<button onclick="event.stopPropagation();quickMarkDead('${p.id || p.ring}')" style="background:#ef4444;color:#fff;border:none;padding:4px 8px;border-radius:4px;font-size:10px;cursor:pointer;">æ ‡è®°æ­»äº¡</button>` : '<span style="color:var(--text-secondary);font-size:10px;">å·²æ­»äº¡</span>'}
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
      } else {
        // å¡ç‰‡è§†å›¾
        container.className = 'mobile-list';
        container.innerHTML = pigeons.map(p => {
          const father = p.fatherId ? pigeonMap[p.fatherId] : null;
          const mother = p.motherId ? pigeonMap[p.motherId] : null;
          const fatherName = father ? (father.name || father.ring || 'â€”') : 'â€”';
          const motherName = mother ? (mother.name || mother.ring || 'â€”') : 'â€”';
          const displayName = p.name || p.ring || 'æœªå‘½å';
          const raceCount = (p.races && Array.isArray(p.races)) ? p.races.length : 0;
          const statusText = p.alive !== false ? 'ğŸ•Šï¸ åœ¨ä¸–' : 'ğŸ’” å·²æ­»äº¡';
          const statusClass = p.alive !== false ? 'tag-alive' : 'tag-dead';
          
          return `
            <div class="mobile-card" onclick="viewPigeonDetail('${p.id || p.ring}')">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <div style="flex: 1;">
                  <div class="mobile-card-title">${escapeHtml(displayName)}${p.isCore ? ' <span style="background:#fef3c7;color:#b45309;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:500;">â­ æ ¸å¿ƒ</span>' : ''}</div>
                  <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">${escapeHtml(p.ring || 'æ— è¶³ç¯å·')}${p.ringRecycled ? ' <span style="background:#fff3cd;color:#856404;padding:2px 4px;border-radius:3px;font-size:9px;">å›æ”¶</span>' : ''}</div>
                </div>
                <span class="${statusClass}" style="padding:4px 8px;border-radius:4px;font-size:11px;font-weight:500;">${statusText}</span>
              </div>
              <div class="mobile-card-meta" style="margin-bottom: 6px;">
                <span>ç±»å‹: ${escapeHtml(p.type || 'â€”')}</span>
                ${p.currentOwner ? `<span>é¸½ä¸»: ${escapeHtml(p.currentOwner)}</span>` : ''}
                ${raceCount > 0 ? `<span>ğŸ† ${raceCount}åœº</span>` : ''}
              </div>
              <div class="mobile-card-meta" style="font-size: 10px; color: var(--text-secondary);">
                <span>çˆ¶: ${escapeHtml(fatherName)}</span>
                <span>æ¯: ${escapeHtml(motherName)}</span>
              </div>
            </div>
          `;
        }).join('');
      }
    }

    // å¸¸é‡å®šä¹‰
    const DEFAULT_BODY_IMG = 'picker/IMG_6540.jpg';
    const DEFAULT_EYE_IMG = 'picker/IMG_6539.jpg';
    let currentDetailId = null;

    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(d) {
      if (!d) return '';
      return d;
    }

    // ä¿å­˜æ•°æ®åˆ°å­˜å‚¨
    function saveToStorage() {
      const STORAGE_KEY = 'pigeon_manager_data_v1';
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(loadPigeons()));
      } catch (e) {
        console.error('ä¿å­˜æ•°æ®å¤±è´¥:', e);
      }
    }

    // æŸ¥çœ‹é¸½å­è¯¦æƒ…
    function viewPigeonDetail(id) {
      currentDetailId = id;
      renderMobileDetail();
      switchView('detail');
    }

    // æ¸²æŸ“ç§»åŠ¨ç«¯è¯¦æƒ…
    function renderMobileDetail() {
      const p = getPigeonById(currentDetailId);
      if (!p) {
        alert('æœªæ‰¾åˆ°è¯¥é¸½å­ä¿¡æ¯');
        backToList();
        return;
      }

      // æ ‡é¢˜å’Œå‰¯æ ‡é¢˜
      document.getElementById('md_title').textContent = p.name || p.ring;
      let subtitle = `è¶³ç¯å·ï¼š${p.ring}`;
      if (p.ringRecycled) subtitle += ' <span style="background:#fff3cd;color:#856404;padding:2px 6px;border-radius:4px;font-size:10px;">å›æ”¶ä½¿ç”¨</span>';
      if (p.type) subtitle += ` <span style="background:#e0e7ff;color:#3730a3;padding:2px 6px;border-radius:4px;font-size:10px;">${p.type}</span>`;
      if (p.isCore) subtitle += ' <span style="background:#fef3c7;color:#b45309;padding:2px 6px;border-radius:4px;font-size:10px;">æ ¸å¿ƒç§é¸½ â­</span>';
      document.getElementById('md_subtitle').innerHTML = subtitle;

      // çŠ¶æ€
      const statusRow = document.getElementById('md_statusRow');
      statusRow.innerHTML = '';
      const aliveSpan = document.createElement('span');
      if (p.alive !== false) {
        aliveSpan.className = 'tag-alive';
        aliveSpan.textContent = 'ğŸ•Šï¸ åœ¨ä¸–';
        aliveSpan.style.cssText = 'padding:4px 8px;border-radius:4px;font-size:12px;background:#d1fae5;color:#047857;';
      } else {
        aliveSpan.className = 'tag-dead';
        aliveSpan.textContent = 'ğŸ’” å·²æ­»äº¡';
        aliveSpan.style.cssText = 'padding:4px 8px;border-radius:4px;font-size:12px;background:#fee2e2;color:#991b1b;';
        const extra = document.createElement('span');
        extra.style.cssText = 'margin-left:8px;color:var(--text-secondary);font-size:12px;';
        extra.textContent = (p.deathDate ? `ï¼ˆ${p.deathDate}` : 'ï¼ˆ') + (p.deathReason ? `ï¼Œ${p.deathReason}` : '') + 'ï¼‰';
        statusRow.appendChild(extra);
      }
      statusRow.appendChild(aliveSpan);

      // ç¡®ä¿åå­—å­˜åœ¨
      if (!p.name || p.name.trim() === '') {
        const newName = getRandomUnusedName();
        if (newName) {
          p.name = newName;
          saveToStorage();
          renderMobileDetail(); // é‡æ–°æ¸²æŸ“
          return;
        }
      }

      // åŸºæœ¬ä¿¡æ¯
      const basicDiv = document.getElementById('md_basic');
      basicDiv.innerHTML = '';
      const fields = [
        ['é¸½å­åç§°', p.name || 'â€”'],
        ['è¶³ç¯å·ç ', p.ring],
        ['æ€§åˆ«', p.gender || 'â€”'],
        ['ç¾½è‰²', p.color || 'â€”'],
        ['å‡ºç”Ÿæ—¥æœŸ', formatDate(p.birth) || 'â€”'],
        ['é¸½å­ç±»å‹', p.type || 'â€”']
      ];
      fields.forEach(([label, value]) => {
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-light);';
        const l = document.createElement('div');
        l.style.cssText = 'font-size:13px;color:var(--text-secondary);font-weight:500;';
        l.textContent = label + 'ï¼š';
        const v = document.createElement('div');
        v.style.cssText = 'font-size:13px;color:var(--text-primary);';
        v.textContent = value;
        row.appendChild(l);
        row.appendChild(v);
        basicDiv.appendChild(row);
      });

      // å›¾ç‰‡åŒºåŸŸ
      const imagesDiv = document.getElementById('md_images');
      imagesDiv.innerHTML = '';
      const hasCustomBody = p.images && p.images.body;
      const hasCustomEye = p.images && p.images.eye;
      const bodySrc = hasCustomBody ? p.images.body : DEFAULT_BODY_IMG;
      const eyeSrc = hasCustomEye ? p.images.eye : DEFAULT_EYE_IMG;

      const imgContainer = document.createElement('div');
      imgContainer.style.cssText = 'display:flex;gap:12px;flex-wrap:wrap;';
      
      if (hasCustomBody || !hasCustomEye) {
        const bodyImg = document.createElement('img');
        bodyImg.src = bodySrc;
        bodyImg.style.cssText = 'width:100%;max-width:300px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);';
        bodyImg.onerror = function() {
          this.style.display = 'none';
        };
        imgContainer.appendChild(bodyImg);
      }

      if (hasCustomEye || !hasCustomBody) {
        const eyeImg = document.createElement('img');
        eyeImg.src = eyeSrc;
        eyeImg.style.cssText = 'width:100%;max-width:300px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);';
        eyeImg.onerror = function() {
          this.style.display = 'none';
        };
        imgContainer.appendChild(eyeImg);
      }

      imagesDiv.appendChild(imgContainer);

      // é¸½ä¸»ä¿¡æ¯
      const ownerInfoDiv = document.getElementById('md_ownerInfoSection');
      ownerInfoDiv.innerHTML = '';
      
      // ç§é¸½çš„å‰é¸½ä¸»å’Œå‰åœ°åŒº
      if (p.type === 'ç§é¸½' && (p.previousOwner || p.previousRegion)) {
        const sectionTitle = document.createElement('div');
        sectionTitle.className = 'mobile-form-section-title';
        sectionTitle.textContent = 'ç§é¸½ä¿¡æ¯';
        ownerInfoDiv.appendChild(sectionTitle);

        if (p.previousOwner) {
          const row = document.createElement('div');
          row.style.cssText = 'display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-light);';
          row.innerHTML = `
            <div style="font-size:13px;color:var(--text-secondary);font-weight:500;">å‰é¸½ä¸»ï¼š</div>
            <div style="font-size:13px;color:var(--text-primary);">${escapeHtml(p.previousOwner)}</div>
          `;
          ownerInfoDiv.appendChild(row);
        }

        if (p.previousRegion) {
          const row = document.createElement('div');
          row.style.cssText = 'display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-light);';
          row.innerHTML = `
            <div style="font-size:13px;color:var(--text-secondary);font-weight:500;">å‰åœ°åŒºï¼š</div>
            <div style="font-size:13px;color:var(--text-primary);">${escapeHtml(p.previousRegion)}</div>
          `;
          ownerInfoDiv.appendChild(row);
        }
      }

      // ç°é¸½ä¸»å’Œç°åœ°åŒº
      const currentOwnerTitle = document.createElement('div');
      currentOwnerTitle.className = 'mobile-form-section-title';
      currentOwnerTitle.textContent = 'é¸½ä¸»ä¿¡æ¯';
      currentOwnerTitle.style.marginTop = '16px';
      ownerInfoDiv.appendChild(currentOwnerTitle);

      const rowOwner = document.createElement('div');
      rowOwner.style.cssText = 'display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-light);';
      rowOwner.innerHTML = `
        <div style="font-size:13px;color:var(--text-secondary);font-weight:500;">ç°é¸½ä¸»ï¼š</div>
        <div style="font-size:13px;color:var(--text-primary);">${escapeHtml(p.currentOwner || 'â€”')}</div>
      `;
      ownerInfoDiv.appendChild(rowOwner);

      const rowRegion = document.createElement('div');
      rowRegion.style.cssText = 'display:flex;justify-content:space-between;padding:8px 0;';
      rowRegion.innerHTML = `
        <div style="font-size:13px;color:var(--text-secondary);font-weight:500;">ç°åœ°åŒºï¼š</div>
        <div style="font-size:13px;color:var(--text-primary);">${escapeHtml(p.currentRegion || 'â€”')}</div>
      `;
      ownerInfoDiv.appendChild(rowRegion);

      // è¡€ç»Ÿä¿¡æ¯
      const pedigreeDiv = document.getElementById('md_pedigree');
      pedigreeDiv.innerHTML = '';
      const father = p.fatherId ? getPigeonById(p.fatherId) : null;
      const mother = p.motherId ? getPigeonById(p.motherId) : null;

      if (father && (!father.name || father.name.trim() === '')) {
        const newName = getRandomUnusedName();
        if (newName) {
          father.name = newName;
          saveToStorage();
        }
      }
      if (mother && (!mother.name || mother.name.trim() === '')) {
        const newName = getRandomUnusedName();
        if (newName) {
          mother.name = newName;
          saveToStorage();
        }
      }

      const rowF = document.createElement('div');
      rowF.style.cssText = 'display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border-light);';
      const labelF = document.createElement('div');
      labelF.style.cssText = 'font-size:13px;color:var(--text-secondary);font-weight:500;';
      labelF.textContent = 'çˆ¶é¸½ï¼š';
      const valueF = document.createElement('div');
      valueF.style.cssText = 'font-size:13px;color:var(--primary);text-decoration:underline;cursor:pointer;';
      if (father) {
        valueF.textContent = `${father.name || father.ring}${father.name && father.ring ? 'ï¼ˆ' + father.ring + 'ï¼‰' : ''}`;
        valueF.onclick = () => viewPigeonDetail(father.id);
      } else {
        valueF.textContent = 'â€”';
        valueF.style.color = 'var(--text-primary)';
        valueF.style.textDecoration = 'none';
        valueF.style.cursor = 'default';
      }
      rowF.appendChild(labelF);
      rowF.appendChild(valueF);
      pedigreeDiv.appendChild(rowF);

      const rowM = document.createElement('div');
      rowM.style.cssText = 'display:flex;justify-content:space-between;padding:8px 0;';
      const labelM = document.createElement('div');
      labelM.style.cssText = 'font-size:13px;color:var(--text-secondary);font-weight:500;';
      labelM.textContent = 'æ¯é¸½ï¼š';
      const valueM = document.createElement('div');
      valueM.style.cssText = 'font-size:13px;color:var(--primary);text-decoration:underline;cursor:pointer;';
      if (mother) {
        valueM.textContent = `${mother.name || mother.ring}${mother.name && mother.ring ? 'ï¼ˆ' + mother.ring + 'ï¼‰' : ''}`;
        valueM.onclick = () => viewPigeonDetail(mother.id);
      } else {
        valueM.textContent = 'â€”';
        valueM.style.color = 'var(--text-primary)';
        valueM.style.textDecoration = 'none';
        valueM.style.cursor = 'default';
      }
      rowM.appendChild(labelM);
      rowM.appendChild(valueM);
      pedigreeDiv.appendChild(rowM);

      // è¡€ç»Ÿæ ‘å¯è§†åŒ–ï¼ˆç®€åŒ–ç‰ˆï¼‰
      renderMobilePedigreeTree(p);

      // å‚èµ›è®°å½•
      const racesDiv = document.getElementById('md_races');
      racesDiv.innerHTML = '';
      if (!p.races || p.races.length === 0) {
        racesDiv.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-secondary);">æš‚æ— å‚èµ›è®°å½•ã€‚</div>';
      } else {
        p.races.forEach((r, idx) => {
          const item = document.createElement('div');
          item.className = 'mobile-card';
          item.style.marginBottom = '12px';
          item.innerHTML = `
            <div class="mobile-card-title">${escapeHtml(r.name || 'æœªå‘½åæ¯”èµ›')} <span style="color:var(--text-secondary);font-size:12px;">#${idx + 1}</span></div>
            <div class="mobile-card-meta" style="margin-top:8px;">
              <span>æ—¶é—´: ${escapeHtml(formatDate(r.date) || 'â€”')}</span>
              <span>è·ç¦»: ${escapeHtml(r.distance || 'â€”')}km</span>
              <span>åæ¬¡: ${escapeHtml(r.rank || 'â€”')}</span>
            </div>
            ${r.total ? `<div class="mobile-card-meta"><span>å‚èµ›æ€»ç¾½æ•°: ${escapeHtml(r.total)}</span></div>` : ''}
            ${r.remark ? `<div style="margin-top:8px;font-size:12px;color:var(--text-secondary);">å¤‡æ³¨: ${escapeHtml(r.remark)}</div>` : ''}
          `;
          racesDiv.appendChild(item);
        });
      }

      // ç¡®ä¿åœ¨æµè§ˆæ¨¡å¼
      document.getElementById('md_browseMode').style.display = 'block';
      document.getElementById('md_editMode').style.display = 'none';
    }

    // æ¸²æŸ“ç§»åŠ¨ç«¯è¡€ç»Ÿæ ‘ï¼ˆç®€åŒ–ç‰ˆï¼‰
    function renderMobilePedigreeTree(pigeon) {
      const treeDiv = document.getElementById('md_pedigreeTree');
      treeDiv.innerHTML = '';

      function buildTree(p, level = 0, maxLevel = 3) {
        if (!p || level >= maxLevel) return null;
        const node = {
          id: p.id,
          ring: p.ring,
          name: p.name,
          isCore: p.isCore,
          alive: p.alive,
          level: level
        };
        const father = p.fatherId ? getPigeonById(p.fatherId) : null;
        const mother = p.motherId ? getPigeonById(p.motherId) : null;
        node.father = father ? buildTree(father, level + 1, maxLevel) : null;
        node.mother = mother ? buildTree(mother, level + 1, maxLevel) : null;
        return node;
      }

      const tree = buildTree(pigeon);
      if (!tree) {
        treeDiv.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-secondary);">æš‚æ— è¡€ç»Ÿæ ‘æ•°æ®ï¼ˆéœ€è¦è®¾ç½®çˆ¶é¸½å’Œæ¯é¸½ä¿¡æ¯ï¼‰ã€‚</div>';
        return;
      }

      function renderNode(node, container) {
        if (!node) return;
        const nodeEl = document.createElement('div');
        nodeEl.style.cssText = 'padding:8px 12px;margin:4px;background:var(--bg-primary);border:1px solid var(--border-light);border-radius:6px;text-align:center;cursor:pointer;font-size:12px;';
        if (node.isCore) {
          nodeEl.style.background = '#fef3c7';
          nodeEl.style.borderColor = '#f59e0b';
        }
        nodeEl.textContent = `${node.ring}${node.name ? 'ï¼ˆ' + node.name + 'ï¼‰' : ''}`;
        if (!node.alive) nodeEl.textContent += ' [å·²æ­»äº¡]';
        nodeEl.onclick = () => {
          if (node.id !== currentDetailId) {
            viewPigeonDetail(node.id);
          }
        };
        container.appendChild(nodeEl);

        if (node.father || node.mother) {
          const childrenContainer = document.createElement('div');
          childrenContainer.style.cssText = 'display:flex;gap:8px;margin-top:8px;justify-content:center;flex-wrap:wrap;';
          
          if (node.father) {
            const fatherContainer = document.createElement('div');
            fatherContainer.style.cssText = 'text-align:center;';
            const fatherLabel = document.createElement('div');
            fatherLabel.textContent = 'çˆ¶';
            fatherLabel.style.cssText = 'font-size:11px;color:var(--text-secondary);margin-bottom:4px;';
            fatherContainer.appendChild(fatherLabel);
            renderNode(node.father, fatherContainer);
            childrenContainer.appendChild(fatherContainer);
          }
          
          if (node.mother) {
            const motherContainer = document.createElement('div');
            motherContainer.style.cssText = 'text-align:center;';
            const motherLabel = document.createElement('div');
            motherLabel.textContent = 'æ¯';
            motherLabel.style.cssText = 'font-size:11px;color:var(--text-secondary);margin-bottom:4px;';
            motherContainer.appendChild(motherLabel);
            renderNode(node.mother, motherContainer);
            childrenContainer.appendChild(motherContainer);
          }
          
          container.appendChild(childrenContainer);
        }
      }

      const treeContainer = document.createElement('div');
      treeContainer.style.cssText = 'text-align:center;';
      const currentLabel = document.createElement('div');
      currentLabel.textContent = 'å½“å‰é¸½å­';
      currentLabel.style.cssText = 'font-size:11px;color:var(--text-secondary);margin-bottom:8px;';
      treeContainer.appendChild(currentLabel);
      renderNode(tree, treeContainer);
      treeDiv.appendChild(treeContainer);
    }

    // å¿«é€Ÿæ ‡è®°æ­»äº¡
    function quickMarkDead(id) {
      const p = getPigeonById(id);
      if (!p) return;
      
      if (!confirm(`ç¡®å®šå°†ã€${p.ring}${p.name ? 'ï¼ˆ' + p.name + 'ï¼‰' : ''}ã€‘æ ‡è®°ä¸ºå·²æ­»äº¡å—ï¼Ÿä¸ä¼šåˆ é™¤ä»»ä½•å†å²æˆç»©ã€‚`)) {
        return;
      }

      p.alive = false;
      p.deathDate = new Date().toISOString().slice(0, 10);
      
      const pigeons = loadPigeons();
      const index = pigeons.findIndex(pid => pid.id === id);
      if (index >= 0) {
        pigeons[index] = p;
        saveToStorage();
        alert('å·²æ ‡è®°ä¸ºå·²æ­»äº¡');
        refreshList();
        refreshDashboard();
      }
    }

    // è¿”å›åˆ—è¡¨
    function backToList() {
      // å¦‚æœåœ¨ç¼–è¾‘æ¨¡å¼ï¼Œå…ˆæ£€æŸ¥æœªä¿å­˜çš„æ›´æ”¹
      const editMode = document.getElementById('md_editMode');
      if (editMode && editMode.style.display !== 'none') {
        if (hasUnsavedChanges()) {
          if (!confirm('æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦è¿”å›åˆ—è¡¨å—ï¼Ÿ\n\nå¦‚æœè¿”å›ï¼Œæ‰€æœ‰æœªä¿å­˜çš„æ›´æ”¹å°†ä¼šä¸¢å¤±ã€‚')) {
            return;
          }
        }
        toggleEditMode(); // é€€å‡ºç¼–è¾‘æ¨¡å¼
      }
      switchView('pigeons');
    }

    // åˆ é™¤é¸½å­
    function deletePigeon() {
      if (!currentDetailId) return;
      const p = getPigeonById(currentDetailId);
      if (!p) return;

      if (!confirm(`ç¡®å®šè¦åˆ é™¤ã€${p.ring}${p.name ? 'ï¼ˆ' + p.name + 'ï¼‰' : ''}ã€‘å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œå°†åˆ é™¤è¯¥é¸½å­çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬å‚èµ›è®°å½•ã€‚`)) {
        return;
      }

      const pigeons = loadPigeons();
      const index = pigeons.findIndex(pid => pid.id === currentDetailId);
      if (index >= 0) {
        pigeons.splice(index, 1);
        const STORAGE_KEY = 'pigeon_manager_data_v1';
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(pigeons));
          alert('åˆ é™¤æˆåŠŸ');
          backToList();
          refreshList();
          refreshDashboard();
        } catch (e) {
          console.error('åˆ é™¤å¤±è´¥:', e);
          alert('åˆ é™¤å¤±è´¥ï¼š' + (e.message || 'æœªçŸ¥é”™è¯¯'));
        }
      }
    }

    // ç¼–è¾‘æ¨¡å¼ç›¸å…³å˜é‡
    let editFormInitialState = null;

    // åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
    function toggleEditMode() {
      const editMode = document.getElementById('md_editMode');
      const browseMode = document.getElementById('md_browseMode');
      const btnEdit = document.getElementById('md_btnEdit');
      
      if (editMode.style.display === 'none') {
        // è¿›å…¥ç¼–è¾‘æ¨¡å¼
        browseMode.style.display = 'none';
        editMode.style.display = 'block';
        btnEdit.textContent = 'â†';
        btnEdit.title = 'è¿”å›æµè§ˆ';
        fillEditForm();
        setTimeout(() => {
          editFormInitialState = getEditFormState();
        }, 200);
      } else {
        // é€€å‡ºç¼–è¾‘æ¨¡å¼
        if (hasUnsavedChanges()) {
          if (!confirm('æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦é€€å‡ºç¼–è¾‘æ¨¡å¼å—ï¼Ÿ\n\nå¦‚æœé€€å‡ºï¼Œæ‰€æœ‰æœªä¿å­˜çš„æ›´æ”¹å°†ä¼šä¸¢å¤±ã€‚')) {
            return;
          }
        }
        browseMode.style.display = 'block';
        editMode.style.display = 'none';
        btnEdit.textContent = 'âœ';
        btnEdit.title = 'ç¼–è¾‘ä¿¡æ¯';
        editFormInitialState = null;
      }
    }

    // å–æ¶ˆç¼–è¾‘
    function cancelEdit() {
      if (hasUnsavedChanges()) {
        if (!confirm('æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦å–æ¶ˆå—ï¼Ÿ\n\næ‰€æœ‰æœªä¿å­˜çš„æ›´æ”¹å°†ä¼šä¸¢å¤±ã€‚')) {
          return;
        }
      }
      toggleEditMode();
    }

    // å¡«å……ç¼–è¾‘è¡¨å•
    function fillEditForm() {
      const p = getPigeonById(currentDetailId);
      if (!p) return;

      document.getElementById('me_name').value = p.name || '';
      document.getElementById('me_ring').value = p.ring;
      document.getElementById('me_gender').value = p.gender || '';
      document.getElementById('me_color').value = p.color || '';
      document.getElementById('me_birth').value = p.birth || '';
      document.getElementById('me_type').value = p.type || '';
      document.getElementById('me_core').checked = !!p.isCore;

      // ç§é¸½ç±»å‹åˆ‡æ¢
      const typeSelect = document.getElementById('me_type');
      const breederSection = document.getElementById('me_breederSection');
      
      function toggleBreederFields() {
        breederSection.style.display = typeSelect.value === 'ç§é¸½' ? 'block' : 'none';
      }
      typeSelect.addEventListener('change', toggleBreederFields);
      toggleBreederFields();

      // ç§é¸½ä¿¡æ¯
      document.getElementById('me_previousOwner').value = p.previousOwner || '';
      document.getElementById('me_previousRegion').value = p.previousRegion || '';

      // é¸½ä¸»ä¿¡æ¯
      document.getElementById('me_currentOwner').value = p.currentOwner || '';
      document.getElementById('me_currentRegion').value = p.currentRegion || '';
      updateOwnerDatalist('me_ownerList');
      if (p.currentOwner) {
        updateRegionDatalist(p.currentOwner, 'me_regionList');
      }

      // çˆ¶é¸½æ¯é¸½
      fillParentOptions(document.getElementById('me_father'), p.id);
      fillParentOptions(document.getElementById('me_mother'), p.id);
      document.getElementById('me_father').value = p.fatherId || '';
      document.getElementById('me_mother').value = p.motherId || '';

      // çŠ¶æ€
      const aliveRadios = document.querySelectorAll('input[name="me_alive"]');
      aliveRadios.forEach(r => {
        r.checked = (r.value === (p.alive !== false ? 'alive' : 'dead'));
      });
      const deathExtras = document.querySelectorAll('.me-death-extra');
      if (p.alive !== false) {
        deathExtras.forEach(el => el.style.display = 'none');
        document.getElementById('me_death_date').value = '';
        document.getElementById('me_death_reason').value = '';
      } else {
        deathExtras.forEach(el => el.style.display = 'block');
        document.getElementById('me_death_date').value = p.deathDate || '';
        document.getElementById('me_death_reason').value = p.deathReason || '';
      }
      aliveRadios.forEach(r => {
        r.onchange = () => {
          if (r.checked && r.value === 'dead') {
            deathExtras.forEach(el => el.style.display = 'block');
          } else if (r.checked && r.value === 'alive') {
            deathExtras.forEach(el => el.style.display = 'none');
          }
        };
      });

      // å‚èµ›è®°å½•
      const raceListContainer = document.getElementById('me_raceList');
      raceListContainer.innerHTML = '';
      (p.races || []).forEach((race, index) => {
        createRaceFormItemEdit(raceListContainer, race, () => {
          // åˆ é™¤å›è°ƒ
          const pigeons = loadPigeons();
          const p = getPigeonById(currentDetailId);
          if (p && p.races) {
            p.races.splice(index, 1);
            saveToStorage();
          }
        });
      });
    }

    // åˆ›å»ºç¼–è¾‘æ¨¡å¼çš„å‚èµ›è®°å½•é¡¹
    function createRaceFormItemEdit(container, race = {}, onRemove) {
      const item = document.createElement('div');
      item.className = 'mobile-race-item';

      const header = document.createElement('div');
      header.className = 'mobile-race-item-header';
      const title = document.createElement('div');
      title.className = 'mobile-race-item-title';
      title.textContent = race.name || 'æ–°å‚èµ›è®°å½•';
      header.appendChild(title);
      
      const btnDel = document.createElement('button');
      btnDel.className = 'mobile-race-item-delete';
      btnDel.textContent = 'åˆ é™¤';
      btnDel.type = 'button';
      btnDel.onclick = () => {
        if (onRemove) onRemove();
        container.removeChild(item);
      };
      header.appendChild(btnDel);
      item.appendChild(header);

      const fields = document.createElement('div');
      fields.className = 'mobile-race-item-fields';

      function addField(labelText, inputType, inputValue, placeholder) {
        const field = document.createElement('div');
        field.className = 'mobile-race-item-field';
        const label = document.createElement('label');
        label.textContent = labelText;
        field.appendChild(label);
        const input = document.createElement('input');
        input.type = inputType;
        input.value = inputValue || '';
        input.placeholder = placeholder || '';
        field.appendChild(input);
        fields.appendChild(field);
        return input;
      }

      const iName = addField('æ¯”èµ›åç§°', 'text', race.name, 'å¦‚ï¼š500å…¬é‡Œè”èµ›');
      const iDate = addField('æ¯”èµ›æ—¶é—´', 'date', race.date, '');
      const iDist = addField('æ¯”èµ›è·ç¦»ï¼ˆå…¬é‡Œï¼‰', 'number', race.distance, 'å¦‚ï¼š500');
      const iRank = addField('åæ¬¡', 'number', race.rank, 'å¦‚ï¼š1');
      const iTotal = addField('å‚èµ›æ€»ç¾½æ•°', 'number', race.total, 'å¦‚ï¼š2000');
      const iRemark = addField('å¤‡æ³¨', 'text', race.remark, 'å¦‚ï¼šé€†é£ã€é›¨å¤©ç­‰æƒ…å†µè¯´æ˜');

      iName.addEventListener('input', () => {
        title.textContent = iName.value.trim() || 'æ–°å‚èµ›è®°å½•';
      });

      item.getValue = () => ({
        name: iName.value.trim(),
        date: iDate.value,
        distance: iDist.value,
        rank: iRank.value,
        total: iTotal.value,
        remark: iRemark.value.trim()
      });

      item.appendChild(fields);
      container.appendChild(item);
      return item;
    }

    // æ·»åŠ ç¼–è¾‘æ¨¡å¼çš„å‚èµ›è®°å½•
    function addRaceItemEdit() {
      const container = document.getElementById('me_raceList');
      createRaceFormItemEdit(container);
    }

    // è§¦å‘ç¼–è¾‘æ¨¡å¼çš„ç›¸æœº
    function triggerCameraEdit(type) {
      const cameraInput = document.getElementById(`me_${type}_photo_camera`);
      if (cameraInput) {
        cameraInput.click();
        cameraInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            const fileInput = document.getElementById(`me_${type}_photo`);
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
          }
        }, { once: true });
      }
    }

    // è·å–ç¼–è¾‘è¡¨å•çŠ¶æ€
    function getEditFormState() {
      if (!currentDetailId) return null;
      return {
        name: document.getElementById('me_name')?.value || '',
        ring: document.getElementById('me_ring')?.value || '',
        gender: document.getElementById('me_gender')?.value || '',
        color: document.getElementById('me_color')?.value || '',
        birth: document.getElementById('me_birth')?.value || '',
        type: document.getElementById('me_type')?.value || '',
        isCore: document.getElementById('me_core')?.checked || false,
        previousOwner: document.getElementById('me_previousOwner')?.value.trim() || '',
        previousRegion: document.getElementById('me_previousRegion')?.value.trim() || '',
        currentOwner: document.getElementById('me_currentOwner')?.value.trim() || '',
        currentRegion: document.getElementById('me_currentRegion')?.value.trim() || '',
        fatherId: document.getElementById('me_father')?.value || null,
        motherId: document.getElementById('me_mother')?.value || null,
        alive: document.querySelector('input[name="me_alive"]:checked')?.value === 'alive',
        deathDate: document.getElementById('me_death_date')?.value || null,
        deathReason: document.getElementById('me_death_reason')?.value.trim() || '',
        bodyPhoto: document.getElementById('me_body_photo')?.files.length > 0,
        eyePhoto: document.getElementById('me_eye_photo')?.files.length > 0,
        races: Array.from(document.querySelectorAll('#me_raceList .mobile-race-item')).map(item => {
          try {
            return item.getValue ? item.getValue() : null;
          } catch (e) {
            return null;
          }
        }).filter(r => r !== null)
      };
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ›´æ”¹
    function hasUnsavedChanges() {
      if (!editFormInitialState) return false;
      const currentState = getEditFormState();
      if (!currentState) return false;

      const fields = ['name', 'ring', 'gender', 'color', 'birth', 'type', 'isCore', 
                      'previousOwner', 'previousRegion', 'currentOwner', 'currentRegion',
                      'fatherId', 'motherId', 'alive', 'deathDate', 'deathReason'];
      
      for (let field of fields) {
        if (editFormInitialState[field] !== currentState[field]) {
          return true;
        }
      }

      if (editFormInitialState.bodyPhoto !== currentState.bodyPhoto ||
          editFormInitialState.eyePhoto !== currentState.eyePhoto) {
        return true;
      }

      if (editFormInitialState.races.length !== currentState.races.length) {
        return true;
      }

      for (let i = 0; i < Math.max(editFormInitialState.races.length, currentState.races.length); i++) {
        const oldRace = editFormInitialState.races[i];
        const newRace = currentState.races[i];
        if (!oldRace || !newRace) return true;
        if (JSON.stringify(oldRace) !== JSON.stringify(newRace)) {
          return true;
        }
      }

      return false;
    }

    // ä¿å­˜ç¼–è¾‘
    async function saveEdit() {
      if (!currentDetailId) return;
      const p = getPigeonById(currentDetailId);
      if (!p) return;

      const aliveRadio = document.querySelector('input[name="me_alive"]:checked');
      const alive = aliveRadio.value === 'alive';
      const deathDate = alive ? null : document.getElementById('me_death_date').value;
      const deathReason = alive ? '' : document.getElementById('me_death_reason').value.trim();

      if (!alive && !deathDate) {
        alert('å·²æ­»äº¡çŠ¶æ€ä¸‹ï¼Œæ­»äº¡æ—¥æœŸä¸ºå¿…å¡«ã€‚');
        return;
      }

      // è·å–è¡¨å•æ•°æ®
      const name = document.getElementById('me_name').value.trim();
      const gender = document.getElementById('me_gender').value;
      const color = document.getElementById('me_color').value.trim();
      const birth = document.getElementById('me_birth').value;
      const type = document.getElementById('me_type').value;
      const isCore = document.getElementById('me_core').checked;
      const previousOwner = type === 'ç§é¸½' ? (document.getElementById('me_previousOwner').value.trim() || '') : '';
      const previousRegion = type === 'ç§é¸½' ? (document.getElementById('me_previousRegion').value.trim() || '') : '';
      const currentOwner = document.getElementById('me_currentOwner').value.trim() || '';
      const currentRegion = document.getElementById('me_currentRegion').value.trim() || '';
      const fatherId = document.getElementById('me_father').value || null;
      const motherId = document.getElementById('me_mother').value || null;

      // è®°å½•é¸½ä¸»-åœ°åŒºé…å¯¹
      if (currentOwner && currentRegion) {
        addOwnerRegionPair(currentOwner, currentRegion);
        updateOwnerDatalist('me_ownerList');
        updateRegionDatalist(currentOwner, 'me_regionList');
      }

      // è·å–å‚èµ›è®°å½•
      const races = [];
      const raceListContainer = document.getElementById('me_raceList');
      raceListContainer.querySelectorAll('.mobile-race-item').forEach(item => {
        if (item.getValue) {
          const raceData = item.getValue();
          if (raceData.name || raceData.date) {
            races.push(raceData);
          }
        }
      });

      // å¤„ç†å›¾ç‰‡
      const bodyFile = document.getElementById('me_body_photo').files[0] || null;
      const eyeFile = document.getElementById('me_eye_photo').files[0] || null;

      let bodyImg = p.images && p.images.body ? p.images.body : null;
      let eyeImg = p.images && p.images.eye ? p.images.eye : null;

      if (bodyFile) {
        try {
          if (!bodyFile.type || !bodyFile.type.startsWith('image/')) {
            alert('ç«™ç«‹ä¾§èº«å›¾ç‰‡æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ã€‚');
            return;
          }
          bodyImg = await readFileAsDataURL(bodyFile);
        } catch (e) {
          console.error('è¯»å–å›¾ç‰‡å¤±è´¥', e);
          alert('è¯»å–å›¾ç‰‡å¤±è´¥ï¼š' + (e.message || 'æœªçŸ¥é”™è¯¯'));
          return;
        }
      }

      if (eyeFile) {
        try {
          if (!eyeFile.type || !eyeFile.type.startsWith('image/')) {
            alert('çœ¼ç›ç‰¹å†™å›¾ç‰‡æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ã€‚');
            return;
          }
          eyeImg = await readFileAsDataURL(eyeFile);
        } catch (e) {
          console.error('è¯»å–å›¾ç‰‡å¤±è´¥', e);
          alert('è¯»å–å›¾ç‰‡å¤±è´¥ï¼š' + (e.message || 'æœªçŸ¥é”™è¯¯'));
          return;
        }
      }

      // æ›´æ–°é¸½å­å¯¹è±¡
      p.name = name;
      p.gender = gender;
      p.color = color;
      p.birth = birth;
      p.type = type;
      p.isCore = isCore;
      p.previousOwner = previousOwner;
      p.previousRegion = previousRegion;
      p.currentOwner = currentOwner;
      p.currentRegion = currentRegion;
      p.fatherId = fatherId;
      p.motherId = motherId;
      p.alive = alive;
      p.deathDate = deathDate;
      p.deathReason = deathReason;
      p.races = races;
      p.images = {
        body: bodyImg,
        eye: eyeImg
      };

      // ä¿å­˜
      saveToStorage();
      alert('ä¿å­˜æˆåŠŸ');
      renderMobileDetail(); // é‡æ–°æ¸²æŸ“è¯¦æƒ…
      toggleEditMode(); // é€€å‡ºç¼–è¾‘æ¨¡å¼
      refreshList(); // åˆ·æ–°åˆ—è¡¨
      refreshDashboard(); // åˆ·æ–°ç»Ÿè®¡
    }

    // PCç«¯ä½¿ç”¨çš„å¸¸é‡ï¼ˆä»index.htmlå¤åˆ¶ï¼‰
    const PIGEON_NAMES = [
      'ç‰¹', 'å¸ƒæ–¯å¡”', 'åŸƒæ–‡æ–¯', 'è¯ºé‡Œ', 'è¿ªç±³ç‰¹æ´›å¤«', 'è¥¿è¥¿å¸•æ–¯', 'é½é½å¸•æ–¯', 'å¢å¸ƒåˆ—å¤«', 'å¡æ‹‰é‡‡å¤«', 'å¡æ°è¯ºå¤«', 
      'å“ˆæ°è¯ºå¤«', 'æ¢…å¾·éŸ¦æ°å¤«', 'ç¦é›·è¿ªåŠ æ–¯', 'ç½—çº³å¾·èŒƒè¥¿', 'ç±³æ­‡å°”å¡å¤«', 'é˜¿è¯ºå¾·ç´¢', 'å¼—æœ—è¥¿æ–¯æ©', 'æ‰˜é©¬æ–¯è¯º', 
      'äº¨å¾·é‡Œå…‹è«', 'æœ¬æ°æ˜è¿ª', 'å®‰ä¸œå°¼æ©', 'é©¬å¡å°”èŠ’', 'çš®åŸƒå°”è¥¿', 'é›…å…‹å¸ƒä½©', 'çºªå°§å§†å§†', 'è·¯æ˜“æ–¯æ‹‰', 'çˆ±å¾·åå¤šçº³', 
      'è«é‡Œæ–¯å°”', 'é˜¿å°”è´æ‰˜ç»´', 'èµ«å°”æ›¼å°”', 'é²è¿ªæ ¼æ©', 'æ ¼å“ˆå¾·ç§‘', 'ç“¦å°”ç‰¹ç§‘', 'èƒ¡æˆˆåš', 'è¿ªç‰¹é©¬å°”æ£®', 'è±å› å“ˆå¾·å°”', 
      'å›ç‰¹å“ˆ', 'å¡å°”æµ·å› èŒ¨', 'æ›¼å¼—é›·å¾·æ©', 'çº¦é˜¿å¸Œå§†å°”', 'ç»´å°”çº³æ©', 'æµ·å› èŒ¨å°”', 'å¼—æœ—èŒ¨å°”', 'å¡å·´æ–¯è’‚å®‰', 'é©¬åº“æ–¯æ©', 
      'å…‹é‡Œæ–¯è’‚å®‰', 'æ–¯ç‰¹å‡¡æ©', 'çº¦æ ¼æ©', 'ç±³å¤åŸƒå°”æ©', 'å®‰å¾·çƒˆäºšæ–¯', 'å“ˆæ‹‰å°”å¾·æ©', 'è¿ªå°”å…‹æ©', 'å»¶æ–¯æ©', 'å…‹åŠ³æ–¯æ©', 
      'ä¹ŒéŸ¦æ©', 'çº¦å°”æ ¼æ©', 'æ‰˜é©¬æ–¯æ©', 'é©¬è’‚äºšæ–¯æ©', 'ä¼¯æ©å“ˆå¾·æ©', 'çº¦çº³æ–¯æ©', 'æ‹‰æ–¯ç©†æ–¯æ©', 'å¥¥åˆ©å¼—æ©', 'æ‰¬æ©', 
      'å°¼å°”æ–¯æ©', 'ä½©å¾·æ£®æ©', 'å…‹é‡Œæ–¯æ»•æ£®', 'å®‰å¾·æ–¯æ©', 'åŸƒé‡Œå…‹æ¾æ©', 'å¡å°”æ£®æ©', 'æ—å¾·æ–¯ç‰¹ä¼¦', 'å¥¥å°”æ£®æ©', 'çº¦ç¿°æ¾æ©', 
      'ä½©å°”æ¾æ©', 'å¤æ–¯å¡”å¤«æ¾', 'æ¯”çº¦æ©æ¾æ©', 'æ–¯æ–‡æ¾æ©', 'æ‹‰æ£®æ©', 'æ±‰æ£®æ©', 'è«æ»•æ£®æ©', 'å»¶æ£®æ©'
    ];
    const USED_NAMES_KEY = 'pigeon_used_names';
    const OWNER_REGION_PAIRS_KEY = 'pigeon_owner_region_pairs';

    // ç”ŸæˆID
    function generateId() {
      return 'p_' + Math.random().toString(36).slice(2, 10);
    }

    // è·å–é¸½å­ï¼ˆæ ¹æ®IDï¼‰
    function getPigeonById(id) {
      const pigeons = loadPigeons();
      return pigeons.find(p => p.id === id);
    }

    // è·å–é¸½å­ï¼ˆæ ¹æ®è¶³ç¯å·ï¼Œä»…æ´»ç€çš„ï¼‰
    function getPigeonByRing(ring) {
      const pigeons = loadPigeons();
      const target = (ring || '').trim();
      if (!target) return null;
      return pigeons.find(p => (p.ring || '').toLowerCase() === target.toLowerCase() && p.alive !== false);
    }

    // è·å–æ‰€æœ‰ä½¿ç”¨è¯¥è¶³ç¯å·çš„é¸½å­
    function getAllPigeonsByRing(ring) {
      const pigeons = loadPigeons();
      const target = (ring || '').trim();
      if (!target) return [];
      return pigeons.filter(p => (p.ring || '').toLowerCase() === target.toLowerCase());
    }

    // åŠ è½½å·²ä½¿ç”¨çš„åå­—
    function loadUsedNames() {
      try {
        const raw = localStorage.getItem(USED_NAMES_KEY);
        if (!raw) return new Set();
        const names = JSON.parse(raw);
        return new Set(names);
      } catch (e) {
        console.error('åŠ è½½å·²ä½¿ç”¨åå­—å¤±è´¥:', e);
        return new Set();
      }
    }

    // ä¿å­˜å·²ä½¿ç”¨çš„åå­—
    function saveUsedNames(usedNames) {
      try {
        localStorage.setItem(USED_NAMES_KEY, JSON.stringify(Array.from(usedNames)));
      } catch (e) {
        console.error('ä¿å­˜å·²ä½¿ç”¨åå­—å¤±è´¥:', e);
      }
    }

    // è·å–éšæœºæœªä½¿ç”¨çš„åå­—
    function getRandomUnusedName() {
      const usedNames = loadUsedNames();
      const availableNames = PIGEON_NAMES.filter(name => !usedNames.has(name));
      if (availableNames.length === 0) {
        return null;
      }
      const randomIndex = Math.floor(Math.random() * availableNames.length);
      const selectedName = availableNames[randomIndex];
      usedNames.add(selectedName);
      saveUsedNames(usedNames);
      return selectedName;
    }

    // åŠ è½½é¸½ä¸»-åœ°åŒºé…å¯¹
    function loadOwnerRegionPairs() {
      try {
        const raw = localStorage.getItem(OWNER_REGION_PAIRS_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch (e) {
        console.error('åŠ è½½é¸½ä¸»-åœ°åŒºé…å¯¹å¤±è´¥:', e);
        return [];
      }
    }

    // ä¿å­˜é¸½ä¸»-åœ°åŒºé…å¯¹
    function saveOwnerRegionPairs(pairs) {
      try {
        localStorage.setItem(OWNER_REGION_PAIRS_KEY, JSON.stringify(pairs));
      } catch (e) {
        console.error('ä¿å­˜é¸½ä¸»-åœ°åŒºé…å¯¹å¤±è´¥:', e);
      }
    }

    // æ·»åŠ é¸½ä¸»-åœ°åŒºé…å¯¹
    function addOwnerRegionPair(owner, region) {
      if (!owner || !region) return;
      const pairs = loadOwnerRegionPairs();
      const pairKey = `${owner}|${region}`;
      const existingPair = pairs.find(p => p.key === pairKey);
      if (existingPair) {
        existingPair.count = (existingPair.count || 1) + 1;
        if (existingPair.count >= 2 && !existingPair.saved) {
          existingPair.saved = true;
          saveOwnerRegionPairs(pairs);
        }
      } else {
        pairs.push({ key: pairKey, owner, region, count: 1, saved: false });
        saveOwnerRegionPairs(pairs);
      }
    }

    // è¯»å–æ–‡ä»¶ä¸ºDataURL
    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // å¡«å……çˆ¶é¸½/æ¯é¸½é€‰é¡¹
    function fillParentOptions(selectEl, excludeId) {
      const pigeons = loadPigeons();
      selectEl.innerHTML = '<option value="">æœªé€‰æ‹©</option>';
      pigeons.forEach(p => {
        if (p.id === excludeId) return;
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.ring + (p.name ? 'ï¼ˆ' + p.name + 'ï¼‰' : '');
        selectEl.appendChild(opt);
      });
    }

    // æ›´æ–°é¸½ä¸»ä¸‹æ‹‰åˆ—è¡¨
    function updateOwnerDatalist(elementId) {
      const datalist = document.getElementById(elementId);
      if (!datalist) return;
      datalist.innerHTML = '';
      
      const option1 = document.createElement('option');
      option1.value = 'æå›½è¾‰';
      datalist.appendChild(option1);

      const pairs = loadOwnerRegionPairs();
      const owners = new Set(pairs.map(p => p.owner));
      owners.forEach(owner => {
        const option = document.createElement('option');
        option.value = owner;
        datalist.appendChild(option);
      });
    }

    // æ›´æ–°åœ°åŒºä¸‹æ‹‰åˆ—è¡¨
    function updateRegionDatalist(owner, elementId) {
      const datalist = document.getElementById(elementId);
      if (!datalist || !owner) return;
      datalist.innerHTML = '';
      
      const pairs = loadOwnerRegionPairs();
      const regions = pairs.filter(p => p.owner === owner).map(p => p.region);
      regions.forEach(region => {
        const option = document.createElement('option');
        option.value = region;
        datalist.appendChild(option);
      });
    }

    // æ‰“å¼€åˆ›å»ºé¸½å­æ¨¡æ€æ¡†
    function goToCreatePigeon() {
      setupCreateForm();
      document.getElementById('createPigeonModal').style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    // å…³é—­åˆ›å»ºé¸½å­æ¨¡æ€æ¡†
    function closeCreatePigeonModal() {
      document.getElementById('createPigeonModal').style.display = 'none';
      document.body.style.overflow = '';
      clearCreateForm();
    }

    // åˆå§‹åŒ–åˆ›å»ºè¡¨å•
    function setupCreateForm() {
      fillParentOptions(document.getElementById('mc_father'));
      fillParentOptions(document.getElementById('mc_mother'));
      updateOwnerDatalist('mc_ownerList');

      // çŠ¶æ€åˆ‡æ¢
      const radios = document.querySelectorAll('input[name="mc_alive"]');
      const deathExtras = document.querySelectorAll('.mc-death-extra');
      radios.forEach(r => {
        r.addEventListener('change', () => {
          if (r.checked && r.value === 'dead') {
            deathExtras.forEach(el => el.style.display = '');
          } else if (r.checked && r.value === 'alive') {
            deathExtras.forEach(el => el.style.display = 'none');
          }
        });
      });

      // ç§é¸½ç±»å‹åˆ‡æ¢
      const typeSelect = document.getElementById('mc_type');
      const breederSection = document.getElementById('mc_breederSection');
      
      typeSelect.addEventListener('change', () => {
        if (typeSelect.value === 'ç§é¸½') {
          breederSection.style.display = '';
        } else {
          breederSection.style.display = 'none';
        }
      });

      // ç°é¸½ä¸»è¾“å…¥æ—¶æ›´æ–°åœ°åŒºåˆ—è¡¨
      const currentOwnerInput = document.getElementById('mc_currentOwner');
      const currentRegionInput = document.getElementById('mc_currentRegion');
      
      let ownerInputTimeout;
      currentOwnerInput.addEventListener('input', () => {
        clearTimeout(ownerInputTimeout);
        ownerInputTimeout = setTimeout(() => {
          const owner = currentOwnerInput.value.trim();
          if (owner) {
            updateRegionDatalist(owner, 'mc_regionList');
          }
        }, 500);
      });

      // ç°é¸½ä¸»å’Œç°åœ°åŒºéƒ½è¾“å…¥æ—¶ä¿å­˜é…å¯¹
      let pairSaveTimeout;
      function savePair() {
        const owner = currentOwnerInput.value.trim();
        const region = currentRegionInput.value.trim();
        if (owner && region) {
          addOwnerRegionPair(owner, region);
          updateOwnerDatalist('mc_ownerList');
          updateRegionDatalist(owner, 'mc_regionList');
        }
      }
      
      currentRegionInput.addEventListener('input', () => {
        clearTimeout(pairSaveTimeout);
        pairSaveTimeout = setTimeout(savePair, 1000);
      });
    }

    // æ¸…ç©ºåˆ›å»ºè¡¨å•
    function clearCreateForm() {
      document.getElementById('mc_name').value = '';
      document.getElementById('mc_ring').value = '';
      document.getElementById('mc_gender').value = '';
      document.getElementById('mc_color').value = '';
      document.getElementById('mc_birth').value = '';
      document.getElementById('mc_type').value = '';
      document.getElementById('mc_father').value = '';
      document.getElementById('mc_mother').value = '';
      document.querySelector('input[name="mc_alive"][value="alive"]').checked = true;
      document.querySelectorAll('.mc-death-extra').forEach(el => el.style.display = 'none');
      document.getElementById('mc_death_date').value = '';
      document.getElementById('mc_death_reason').value = '';
      document.getElementById('mc_core').checked = false;
      document.getElementById('mc_previousOwner').value = '';
      document.getElementById('mc_previousRegion').value = '';
      document.getElementById('mc_currentOwner').value = '';
      document.getElementById('mc_currentRegion').value = '';
      document.getElementById('mc_body_photo').value = '';
      document.getElementById('mc_eye_photo').value = '';
      document.getElementById('mc_raceList').innerHTML = '';
      document.getElementById('mc_breederSection').style.display = 'none';
    }

    // åˆ›å»ºå‚èµ›è®°å½•è¡¨å•é¡¹
    function createRaceFormItem(race = {}) {
      const container = document.getElementById('mc_raceList');
      const item = document.createElement('div');
      item.className = 'mobile-race-item';

      const header = document.createElement('div');
      header.className = 'mobile-race-item-header';
      const title = document.createElement('div');
      title.className = 'mobile-race-item-title';
      title.textContent = race.name || 'æ–°å‚èµ›è®°å½•';
      header.appendChild(title);
      
      const btnDel = document.createElement('button');
      btnDel.className = 'mobile-race-item-delete';
      btnDel.textContent = 'åˆ é™¤';
      btnDel.type = 'button';
      btnDel.onclick = () => {
        container.removeChild(item);
      };
      header.appendChild(btnDel);
      item.appendChild(header);

      const fields = document.createElement('div');
      fields.className = 'mobile-race-item-fields';

      function addField(labelText, inputType, inputValue, placeholder) {
        const field = document.createElement('div');
        field.className = 'mobile-race-item-field';
        const label = document.createElement('label');
        label.textContent = labelText;
        field.appendChild(label);
        const input = document.createElement('input');
        input.type = inputType;
        input.value = inputValue || '';
        input.placeholder = placeholder || '';
        field.appendChild(input);
        fields.appendChild(field);
        return input;
      }

      const iName = addField('æ¯”èµ›åç§°', 'text', race.name, 'å¦‚ï¼š500å…¬é‡Œè”èµ›');
      const iDate = addField('æ¯”èµ›æ—¶é—´', 'date', race.date, '');
      const iDist = addField('æ¯”èµ›è·ç¦»ï¼ˆå…¬é‡Œï¼‰', 'number', race.distance, 'å¦‚ï¼š500');
      const iRank = addField('åæ¬¡', 'number', race.rank, 'å¦‚ï¼š1');
      const iTotal = addField('å‚èµ›æ€»ç¾½æ•°', 'number', race.total, 'å¦‚ï¼š2000');
      const iRemark = addField('å¤‡æ³¨', 'text', race.remark, 'å¦‚ï¼šé€†é£ã€é›¨å¤©ç­‰æƒ…å†µè¯´æ˜');

      iName.addEventListener('input', () => {
        title.textContent = iName.value.trim() || 'æ–°å‚èµ›è®°å½•';
      });

      item.getValue = () => ({
        name: iName.value.trim(),
        date: iDate.value,
        distance: iDist.value,
        rank: iRank.value,
        total: iTotal.value,
        remark: iRemark.value.trim()
      });

      item.appendChild(fields);
      container.appendChild(item);
      return item;
    }

    // æ·»åŠ å‚èµ›è®°å½•
    function addRaceItem() {
      createRaceFormItem();
    }

    // è§¦å‘ç›¸æœºæ‹ç…§
    function triggerCamera(type) {
      const cameraInput = document.getElementById(`mc_${type}_photo_camera`);
      if (cameraInput) {
        cameraInput.click();
        cameraInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            const fileInput = document.getElementById(`mc_${type}_photo`);
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
          }
        }, { once: true });
      }
    }

    // ä¿å­˜åˆ›å»ºé¸½å­
    async function saveCreatePigeon() {
      const ring = document.getElementById('mc_ring').value.trim();
      if (!ring) {
        alert('è¶³ç¯å·ç ä¸ºå¿…å¡«é¡¹ã€‚');
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰æ´»ç€çš„é¸½å­ä½¿ç”¨è¯¥è¶³ç¯å·
      const existingAlive = getPigeonByRing(ring);
      if (existingAlive) {
        alert('è¯¥è¶³ç¯å·ç å·²è¢«æ´»ç€çš„é¸½å­ä½¿ç”¨ï¼Œè¯·ç¡®è®¤æ˜¯å¦é‡å¤ã€‚');
        return;
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰å·²æ­»äº¡çš„é¸½å­ä½¿ç”¨è¯¥è¶³ç¯å·ï¼ˆå›æ”¶ä½¿ç”¨ï¼‰
      const allWithRing = getAllPigeonsByRing(ring);
      const deadPigeons = allWithRing.filter(p => !p.alive);
      if (deadPigeons.length > 0) {
        deadPigeons.forEach(p => {
          p.ringRecycled = true;
          p.recycledDate = new Date().toISOString().slice(0, 10);
        });
        if (!confirm(`è¯¥è¶³ç¯å·æ›¾è¢«å·²æ­»äº¡çš„é¸½å­ä½¿ç”¨è¿‡ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ ‡è®°ä¸º"å›æ”¶ä½¿ç”¨"ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
          return;
        }
      }

      let name = document.getElementById('mc_name').value.trim();
      // å¦‚æœåç§°ä¸ºç©ºï¼Œè‡ªåŠ¨åˆ†é…ä¸€ä¸ªæœªä½¿ç”¨çš„åå­—
      if (!name) {
        name = getRandomUnusedName();
        if (!name) {
          alert('æ‰€æœ‰å¯ç”¨åå­—éƒ½å·²ä½¿ç”¨å®Œæ¯•ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ä¸€ä¸ªåå­—ã€‚');
          return;
        }
      } else {
        // å¦‚æœæ‰‹åŠ¨è¾“å…¥çš„åå­—åœ¨åˆ—è¡¨ä¸­ï¼Œä¹Ÿæ ‡è®°ä¸ºå·²ä½¿ç”¨
        const usedNames = loadUsedNames();
        if (PIGEON_NAMES.includes(name) && !usedNames.has(name)) {
          usedNames.add(name);
          saveUsedNames(usedNames);
        }
      }

      const gender = document.getElementById('mc_gender').value;
      const color = document.getElementById('mc_color').value.trim();
      const birth = document.getElementById('mc_birth').value;
      const type = document.getElementById('mc_type').value;
      const fatherId = document.getElementById('mc_father').value || null;
      const motherId = document.getElementById('mc_mother').value || null;
      const aliveRadio = document.querySelector('input[name="mc_alive"]:checked').value;
      const alive = aliveRadio === 'alive';
      const deathDate = alive ? null : document.getElementById('mc_death_date').value;
      const deathReason = alive ? '' : document.getElementById('mc_death_reason').value.trim();
      
      if (!alive && !deathDate) {
        alert('å·²æ­»äº¡çŠ¶æ€ä¸‹ï¼Œæ­»äº¡æ—¥æœŸä¸ºå¿…å¡«ã€‚');
        return;
      }
      
      // è·å–ç§é¸½ä¸“ç”¨ä¿¡æ¯
      const previousOwner = type === 'ç§é¸½' ? (document.getElementById('mc_previousOwner')?.value.trim() || '') : '';
      const previousRegion = type === 'ç§é¸½' ? (document.getElementById('mc_previousRegion')?.value.trim() || '') : '';
      
      // è·å–ç°é¸½ä¸»å’Œç°åœ°åŒº
      const currentOwner = document.getElementById('mc_currentOwner')?.value.trim() || '';
      const currentRegion = document.getElementById('mc_currentRegion')?.value.trim() || '';
      
      // è®°å½•é¸½ä¸»-åœ°åŒºé…å¯¹
      if (currentOwner && currentRegion) {
        addOwnerRegionPair(currentOwner, currentRegion);
        updateOwnerDatalist('mc_ownerList');
        updateRegionDatalist(currentOwner, 'mc_regionList');
      }

      // è·å–å‚èµ›è®°å½•
      const races = [];
      const raceListContainer = document.getElementById('mc_raceList');
      raceListContainer.querySelectorAll('.mobile-race-item').forEach(item => {
        if (item.getValue) {
          const raceData = item.getValue();
          if (raceData.name || raceData.date) {
            races.push(raceData);
          }
        }
      });

      // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
      const bodyFile = document.getElementById('mc_body_photo').files[0] || null;
      const eyeFile = document.getElementById('mc_eye_photo').files[0] || null;

      let bodyImg = null;
      let eyeImg = null;
      
      if (bodyFile) {
        try {
          if (!bodyFile.type || !bodyFile.type.startsWith('image/')) {
            alert('ç«™ç«‹ä¾§èº«å›¾ç‰‡æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼ˆJPGã€PNGã€GIFã€WEBPç­‰ï¼‰ã€‚');
            return;
          }
          bodyImg = await readFileAsDataURL(bodyFile);
        } catch (e) {
          console.error('è¯»å–ç«™ç«‹ä¾§èº«å›¾ç‰‡å¤±è´¥', e);
          alert('è¯»å–ç«™ç«‹ä¾§èº«å›¾ç‰‡å¤±è´¥ï¼š' + (e.message || 'æœªçŸ¥é”™è¯¯') + 'ï¼Œè¯·é‡è¯•ã€‚');
          return;
        }
      }
      
      if (eyeFile) {
        try {
          if (!eyeFile.type || !eyeFile.type.startsWith('image/')) {
            alert('çœ¼ç›ç‰¹å†™å›¾ç‰‡æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼ˆJPGã€PNGã€GIFã€WEBPç­‰ï¼‰ã€‚');
            return;
          }
          eyeImg = await readFileAsDataURL(eyeFile);
        } catch (e) {
          console.error('è¯»å–çœ¼ç›å›¾ç‰‡å¤±è´¥', e);
          alert('è¯»å–çœ¼ç›å›¾ç‰‡å¤±è´¥ï¼š' + (e.message || 'æœªçŸ¥é”™è¯¯') + 'ï¼Œè¯·é‡è¯•ã€‚');
          return;
        }
      }

      // åˆ›å»ºé¸½å­å¯¹è±¡
      const pigeon = {
        id: generateId(),
        ring,
        name,
        gender,
        color,
        birth,
        type,
        fatherId,
        motherId,
        alive,
        deathDate,
        deathReason,
        isCore: !!document.getElementById('mc_core')?.checked,
        races,
        images: {
          body: bodyImg,
          eye: eyeImg
        },
        ringRecycled: deadPigeons && deadPigeons.length > 0,
        previousOwner: previousOwner,
        previousRegion: previousRegion,
        currentOwner: currentOwner,
        currentRegion: currentRegion
      };

      // ä¿å­˜åˆ°å­˜å‚¨
      const STORAGE_KEY = 'pigeon_manager_data_v1';
      let pigeons = loadPigeons();
      
      // å¦‚æœæœ‰å›æ”¶çš„è¶³ç¯å·ï¼Œå…ˆæ›´æ–°å·²æ­»äº¡é¸½å­çš„æ ‡è®°
      if (deadPigeons.length > 0) {
        pigeons.forEach(p => {
          const deadP = deadPigeons.find(dp => dp.id === p.id);
          if (deadP) {
            p.ringRecycled = true;
            p.recycledDate = new Date().toISOString().slice(0, 10);
          }
        });
      }
      
      pigeons.push(pigeon);
      
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(pigeons));
      } catch (e) {
        console.error('ä¿å­˜é¸½å­æ•°æ®å¤±è´¥:', e);
        alert('ä¿å­˜å¤±è´¥ï¼š' + (e.message || 'æœªçŸ¥é”™è¯¯'));
        return;
      }

      alert('ä¿å­˜æˆåŠŸï¼Œå·²ç”Ÿæˆæ¡£æ¡ˆã€‚');
      closeCreatePigeonModal();
      refreshList();
      refreshDashboard();
    }

    // åŠ è½½æ¯”èµ›æ•°æ®ï¼ˆä½¿ç”¨ä¸PCç«¯ç›¸åŒçš„å­˜å‚¨é”®ï¼‰
    function loadRaces() {
      try {
        const RACES_STORAGE_KEY = 'pigeon_races'; // ä¸PCç«¯ä¿æŒä¸€è‡´
        const raw = localStorage.getItem(RACES_STORAGE_KEY);
        if (raw) {
          const data = JSON.parse(raw);
          return Array.isArray(data) ? data : [];
        }
      } catch (e) {
        console.error('åŠ è½½æ¯”èµ›æ•°æ®å¤±è´¥:', e);
      }
      return [];
    }

    // åˆ·æ–°æ¯”èµ›åˆ—è¡¨
    function refreshRaceList() {
      const container = document.getElementById('raceListContainer');
      if (!container) return;
      
      const races = loadRaces();
      
      if (races.length === 0) {
        container.innerHTML = `
          <div class="mobile-empty">
            <p>æš‚æ— æ¯”èµ›è®°å½•</p>
            <button class="btn-primary" onclick="goToAddRace()" style="margin-top: 16px;">â• æ·»åŠ ç¬¬ä¸€åœºæ¯”èµ›</button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = races.slice(0, 20).map(r => `
        <div class="mobile-card">
          <div class="mobile-card-title" onclick="viewRaceDetail('${r.id}')">${escapeHtml(r.name || 'æœªå‘½åæ¯”èµ›')}</div>
          <div class="mobile-card-meta" onclick="viewRaceDetail('${r.id}')">
            <span>${escapeHtml(r.location || 'æœªçŸ¥åœ°ç‚¹')}</span>
            <span>${escapeHtml(r.date || 'æœªçŸ¥æ—¥æœŸ')}</span>
            <span>${r.participants ? r.participants.length + 'ç¾½' : '0ç¾½'}</span>
            ${r.weather ? `<span>${escapeHtml(r.weather)}</span>` : ''}
          </div>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button class="btn-primary" onclick="goToAddRace('${r.id}')" style="flex:1;padding:6px;font-size:12px;">âœ ç¼–è¾‘</button>
            <button class="btn-primary" onclick="deleteRace('${r.id}')" style="flex:1;padding:6px;font-size:12px;background:#ef4444;">ğŸ—‘ åˆ é™¤</button>
          </div>
        </div>
      `).join('');
    }

    // åˆ‡æ¢æ¯”èµ›æ ‡ç­¾
    function switchRaceTab(tab) {
      document.querySelectorAll('.mobile-tab[data-race-tab]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.raceTab === tab);
      });
      
      const listContainer = document.getElementById('raceListContainer');
      const statsContainer = document.getElementById('raceStatsContainer');
      
      if (tab === 'list') {
        if (listContainer) listContainer.style.display = 'block';
        if (statsContainer) statsContainer.style.display = 'none';
        refreshRaceList();
      } else if (tab === 'stats') {
        if (listContainer) listContainer.style.display = 'none';
        if (statsContainer) statsContainer.style.display = 'block';
        renderRaceStats();
      }
    }

    // æ¸²æŸ“æˆç»©ç»Ÿè®¡
    function renderRaceStats() {
      const container = document.getElementById('raceStatsContainer');
      if (!container) return;
      
      const races = loadRaces();
      const pigeons = loadPigeons();
      
      if (races.length === 0) {
        container.innerHTML = '<div class="mobile-empty">æš‚æ— æ¯”èµ›è®°å½•</div>';
        return;
      }
      
      // ç»Ÿè®¡æ€»æ¯”èµ›æ•°
      const totalRaces = races.length;
      
      // ç»Ÿè®¡æ€»å‚èµ›æ¬¡æ•°
      let totalParticipants = 0;
      races.forEach(r => {
        if (r.participants && Array.isArray(r.participants)) {
          totalParticipants += r.participants.length;
        }
      });
      
      // ç»Ÿè®¡è·å¥–æ¬¡æ•°
      let totalWins = 0;
      let totalTop3 = 0;
      let totalTop10 = 0;
      
      pigeons.forEach(p => {
        if (p.races && Array.isArray(p.races)) {
          p.races.forEach(r => {
            if (r.rank === 1) totalWins++;
            if (r.rank && r.rank <= 3) totalTop3++;
            if (r.rank && r.rank <= 10) totalTop10++;
          });
        }
      });
      
      // æŒ‰è·ç¦»ç»Ÿè®¡
      const distanceStats = {};
      races.forEach(r => {
        const distance = r.distance || 0;
        const key = distance < 300 ? 'çŸ­è·ç¦»' : distance < 500 ? 'ä¸­è·ç¦»' : distance < 700 ? 'é•¿è·ç¦»' : 'è¶…é•¿è·ç¦»';
        if (!distanceStats[key]) {
          distanceStats[key] = { count: 0, participants: 0 };
        }
        distanceStats[key].count++;
        if (r.participants) distanceStats[key].participants += r.participants.length;
      });
     
      // è‡ªåŠ¨åˆ†æï¼šè¿‘æœŸçŠ¶æ€ä¸äº®ç‚¹/é£é™©
      const recentRaces = races
        .filter(r => r.date)
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5);
      let trendText = '';
      if (recentRaces.length >= 3) {
        const recentWins = [];
        pigeons.forEach(p => {
          (p.races || []).forEach(r => {
            if (recentRaces.some(rr => rr.id === r.raceId) && r.rank && r.rank <= 3) {
              recentWins.push({ pigeon: p, record: r });
            }
          });
        });
        if (recentWins.length > 0) {
          const star = recentWins[0].pigeon;
          trendText = `æœ€è¿‘ ${recentRaces.length} åœºæ¯”èµ›ä¸­ï¼Œæœ‰é¸½å­ ${star.name || star.ring} å¤šæ¬¡è¿›å…¥å‰ä¸‰ï¼ŒçŠ¶æ€æŒç»­ç¨³å®šï¼Œå¯é‡ç‚¹ä¿ç•™ä½œä¸ºä¸»åŠ›ã€‚`;
        } else if (totalParticipants > 0 && totalWins === 0) {
          trendText = `æœ€è¿‘æ¯”èµ›å°šæœªå–å¾—å‰åˆ—åæ¬¡ï¼Œå¯è€ƒè™‘åœ¨è®­ç»ƒæ¨¡å—ä¸­å¢åŠ ä¸­é•¿è·ç¦»è®­ç»ƒæˆ–æ£€æŸ¥å¥åº·çŠ¶æ€ã€‚`;
        } else {
          trendText = `æ•´ä½“å‚èµ›æ¬¡æ•° ${totalParticipants} æ¬¡ï¼Œè¡¨ç°è¾ƒä¸ºå¹³ç¨³ï¼Œå¯ç»“åˆè®­ç»ƒå’Œå¥åº·è®°å½•ç»§ç»­ä¼˜åŒ–ã€‚`;
        }
      } else {
        trendText = 'æ¯”èµ›è®°å½•æš‚æ—¶ä¸å¤šï¼Œå»ºè®®å¤šå‚åŠ å‡ åœºæ¯”èµ›ä»¥ä¾¿å½¢æˆç¨³å®šçš„æ•°æ®æ ·æœ¬ã€‚';
      }

      container.innerHTML = `
        <div class="mobile-stats" style="margin-bottom: 16px;">
          <div class="mobile-stat-item">
            <span class="mobile-stat-icon">ğŸ</span>
            <div class="mobile-stat-content">
              <div class="mobile-stat-number">${totalRaces}</div>
              <div class="mobile-stat-label">æ€»æ¯”èµ›æ•°</div>
            </div>
          </div>
          <div class="mobile-stat-item">
            <span class="mobile-stat-icon">ğŸ•Šï¸</span>
            <div class="mobile-stat-content">
              <div class="mobile-stat-number">${totalParticipants}</div>
              <div class="mobile-stat-label">æ€»å‚èµ›æ¬¡æ•°</div>
            </div>
          </div>
          <div class="mobile-stat-item">
            <span class="mobile-stat-icon">ğŸ¥‡</span>
            <div class="mobile-stat-content">
              <div class="mobile-stat-number">${totalWins}</div>
              <div class="mobile-stat-label">å† å†›æ¬¡æ•°</div>
            </div>
          </div>
          <div class="mobile-stat-item">
            <span class="mobile-stat-icon">ğŸ†</span>
            <div class="mobile-stat-content">
              <div class="mobile-stat-number">${totalTop3}</div>
              <div class="mobile-stat-label">å‰ä¸‰æ¬¡æ•°</div>
            </div>
          </div>
        </div>
        
        <div class="mobile-section">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title">ğŸ“Š æŒ‰è·ç¦»ç»Ÿè®¡</h3>
          </div>
          <div class="mobile-list">
            ${Object.entries(distanceStats).map(([key, stats]) => `
              <div class="mobile-card">
                <div class="mobile-card-title">${key}</div>
                <div class="mobile-card-meta">
                  æ¯”èµ›æ•°ï¼š${stats.count}åœº | å‚èµ›æ¬¡æ•°ï¼š${stats.participants}æ¬¡
                </div>
              </div>
            `).join('')}
          </div>
        </div>
        
        <div class="mobile-section">
          <div class="mobile-section-header">
            <h3 class="mobile-section-title">ğŸ§  æ¯”èµ›è‡ªåŠ¨åˆ†æ</h3>
          </div>
          <div class="mobile-card">
            <div class="mobile-card-meta" style="font-size:13px;line-height:1.6;">
              ${trendText}
            </div>
          </div>
        </div>
      `;
    }

    // æŸ¥çœ‹æ¯”èµ›è¯¦æƒ…
    function viewRaceDetail(id) {
      const races = loadRaces();
      const race = races.find(r => r.id === id);
      
      if (!race) {
        alert('æœªæ‰¾åˆ°è¯¥æ¯”èµ›è®°å½•');
        return;
      }
      
      const pigeons = loadPigeons();
      const participants = race.participants || [];
      
      let detailHTML = `
        <div style="padding:20px;">
          <h3 style="margin:0 0 16px;">${escapeHtml(race.name || 'æœªå‘½åæ¯”èµ›')}</h3>
          <div style="margin-bottom:12px;">
            <strong>æ—¥æœŸï¼š</strong>${race.date || 'â€”'}<br>
            <strong>åœ°ç‚¹ï¼š</strong>${escapeHtml(race.location || 'â€”')}<br>
            <strong>è·ç¦»ï¼š</strong>${race.distance || 'â€”'}å…¬é‡Œ<br>
            <strong>å¤©æ°”ï¼š</strong>${escapeHtml(race.weather || 'â€”')}<br>
            <strong>å‚èµ›æ•°ï¼š</strong>${participants.length}ç¾½
          </div>
      `;
      
      if (participants.length > 0) {
        detailHTML += `
          <div style="margin-top:16px;">
            <strong>å‚èµ›æˆç»©ï¼š</strong>
            <div style="max-height:300px;overflow-y:auto;margin-top:8px;">
              <table style="width:100%;border-collapse:collapse;font-size:13px;">
                <thead>
                  <tr style="background:var(--bg-primary);border-bottom:2px solid var(--border-light);">
                    <th style="padding:8px;text-align:left;">æ’å</th>
                    <th style="padding:8px;text-align:left;">è¶³ç¯å·</th>
                    <th style="padding:8px;text-align:left;">æˆç»©</th>
                  </tr>
                </thead>
                <tbody>
                  ${participants.sort((a, b) => (a.rank || 999) - (b.rank || 999)).map(p => {
                    const pigeon = pigeons.find(pi => pi.id === p.pigeonId || pi.ring === p.ring);
                    return `
                      <tr style="border-bottom:1px solid var(--border-light);">
                        <td style="padding:8px;">${p.rank || 'â€”'}</td>
                        <td style="padding:8px;">${escapeHtml(pigeon ? (pigeon.name || pigeon.ring) : (p.ring || 'â€”'))}</td>
                        <td style="padding:8px;">${p.time || 'â€”'}</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }
      
      detailHTML += '</div>';
      
      // åˆ›å»ºè¯¦æƒ…æ¨¡æ€æ¡†
      const modal = document.getElementById('raceDetailModal');
      if (!modal) {
        const modalHTML = `
          <div id="raceDetailModal" class="mobile-modal" style="display:none;">
            <div class="mobile-modal-content" style="max-height:90vh;overflow-y:auto;">
              <div class="mobile-modal-header">
                <h3>æ¯”èµ›è¯¦æƒ…</h3>
                <button onclick="closeRaceDetail()" style="background:none;border:none;font-size:24px;cursor:pointer;">âœ•</button>
              </div>
              <div class="mobile-modal-body" id="raceDetailContent"></div>
              <div class="mobile-modal-footer">
                <button onclick="closeRaceDetail()" class="btn-primary" style="width:100%;padding:12px;border-radius:8px;border:none;background:var(--primary);color:#fff;cursor:pointer;font-weight:600;">å…³é—­</button>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      document.getElementById('raceDetailContent').innerHTML = detailHTML;
      document.getElementById('raceDetailModal').style.display = 'flex';
    }
    
    function closeRaceDetail() {
      const modal = document.getElementById('raceDetailModal');
      if (modal) modal.style.display = 'none';
    }

    // æ¯”èµ›ç®¡ç†ç›¸å…³å˜é‡
    let currentRaceId = null;

    // ä¿å­˜æ¯”èµ›æ•°æ®
    function saveRaces(races) {
      const RACES_STORAGE_KEY = 'pigeon_races';
      try {
        localStorage.setItem(RACES_STORAGE_KEY, JSON.stringify(races));
      } catch (e) {
        console.error('ä¿å­˜æ¯”èµ›æ•°æ®å¤±è´¥:', e);
      }
    }

    // æ‰“å¼€æ–°å¢/ç¼–è¾‘æ¯”èµ›æ¨¡æ€æ¡†
    function goToAddRace(raceId = null) {
      currentRaceId = raceId;
      const modal = document.getElementById('raceModal');
      const title = document.getElementById('raceModalTitle');
      
      if (raceId) {
        title.textContent = 'ç¼–è¾‘æ¯”èµ›';
        fillRaceForm(raceId);
      } else {
        title.textContent = 'æ–°å¢æ¯”èµ›';
        clearRaceForm();
      }
      
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    // å…³é—­æ¯”èµ›æ¨¡æ€æ¡†
    function closeRaceModal() {
      document.getElementById('raceModal').style.display = 'none';
      document.body.style.overflow = '';
      clearRaceForm();
      currentRaceId = null;
    }

    // æ¸…ç©ºæ¯”èµ›è¡¨å•
    function clearRaceForm() {
      document.getElementById('mr_name').value = '';
      document.getElementById('mr_date').value = '';
      document.getElementById('mr_location').value = '';
      document.getElementById('mr_weather').value = '';
      document.getElementById('mr_participantsContainer').innerHTML = '';
      addRaceParticipant(); // æ·»åŠ ä¸€ä¸ªç©ºçš„å‚èµ›é¸½é¡¹
    }

    // å¡«å……æ¯”èµ›è¡¨å•ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
    function fillRaceForm(raceId) {
      const races = loadRaces();
      const race = races.find(r => r.id === raceId);
      if (!race) return;

      document.getElementById('mr_name').value = race.name || '';
      document.getElementById('mr_date').value = race.date || '';
      document.getElementById('mr_location').value = race.location || '';
      document.getElementById('mr_weather').value = race.weather || '';
      
      const container = document.getElementById('mr_participantsContainer');
      container.innerHTML = '';
      
      if (race.participants && race.participants.length > 0) {
        race.participants.forEach(p => {
          createRaceParticipantItem(container, p);
        });
      } else {
        addRaceParticipant();
      }
    }

    // æ·»åŠ å‚èµ›é¸½é¡¹
    function addRaceParticipant(participant = {}) {
      const container = document.getElementById('mr_participantsContainer');
      createRaceParticipantItem(container, participant);
    }

    // åˆ›å»ºå‚èµ›é¸½é¡¹
    function createRaceParticipantItem(container, participant = {}) {
      const item = document.createElement('div');
      item.className = 'mobile-race-item';
      item.style.cssText = 'margin-bottom: 12px;';

      const header = document.createElement('div');
      header.className = 'mobile-race-item-header';
      const title = document.createElement('div');
      title.className = 'mobile-race-item-title';
      title.textContent = 'å‚èµ›é¸½';
      header.appendChild(title);
      
      const btnDel = document.createElement('button');
      btnDel.className = 'mobile-race-item-delete';
      btnDel.textContent = 'åˆ é™¤';
      btnDel.type = 'button';
      btnDel.onclick = () => {
        container.removeChild(item);
      };
      header.appendChild(btnDel);
      item.appendChild(header);

      const fields = document.createElement('div');
      fields.className = 'mobile-race-item-fields';

      // é¸½å­é€‰æ‹©
      const pigeonField = document.createElement('div');
      pigeonField.className = 'mobile-race-item-field';
      const pigeonLabel = document.createElement('label');
      pigeonLabel.textContent = 'é€‰æ‹©é¸½å­';
      pigeonField.appendChild(pigeonLabel);
      const pigeonSelect = document.createElement('select');
      pigeonSelect.className = 'participant-pigeon';
      pigeonSelect.innerHTML = '<option value="">é€‰æ‹©é¸½å­...</option>';
      const pigeons = loadPigeons();
      pigeons.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.ring}${p.name ? 'ï¼ˆ' + p.name + 'ï¼‰' : ''}`;
        if (participant.pigeonId === p.id) opt.selected = true;
        pigeonSelect.appendChild(opt);
      });
      pigeonField.appendChild(pigeonSelect);
      fields.appendChild(pigeonField);

      // åæ¬¡
      const rankField = document.createElement('div');
      rankField.className = 'mobile-race-item-field';
      const rankLabel = document.createElement('label');
      rankLabel.textContent = 'åæ¬¡';
      rankField.appendChild(rankLabel);
      const rankInput = document.createElement('input');
      rankInput.type = 'number';
      rankInput.className = 'participant-rank';
      rankInput.placeholder = 'å¦‚ï¼š1';
      rankInput.min = '1';
      rankInput.value = participant.rank || '';
      rankField.appendChild(rankInput);
      fields.appendChild(rankField);

      // åˆ†æ•°
      const scoreField = document.createElement('div');
      scoreField.className = 'mobile-race-item-field';
      const scoreLabel = document.createElement('label');
      scoreLabel.textContent = 'åˆ†æ•°ï¼ˆå¯é€‰ï¼‰';
      scoreField.appendChild(scoreLabel);
      const scoreInput = document.createElement('input');
      scoreInput.type = 'number';
      scoreInput.className = 'participant-score';
      scoreInput.placeholder = 'å¦‚ï¼š1200';
      scoreInput.step = '0.01';
      scoreInput.value = participant.score || '';
      scoreField.appendChild(scoreInput);
      fields.appendChild(scoreField);

      // å½’å·¢æ—¶é—´
      const timeField = document.createElement('div');
      timeField.className = 'mobile-race-item-field';
      const timeLabel = document.createElement('label');
      timeLabel.textContent = 'å½’å·¢æ—¶é—´ï¼ˆå¯é€‰ï¼‰';
      timeField.appendChild(timeLabel);
      const timeInput = document.createElement('input');
      timeInput.type = 'time';
      timeInput.className = 'participant-time';
      timeInput.value = participant.returnTime || '';
      timeField.appendChild(timeInput);
      fields.appendChild(timeField);

      item.appendChild(fields);
      container.appendChild(item);
      return item;
    }

    // ä¿å­˜æ¯”èµ›
    function saveRace() {
      const name = document.getElementById('mr_name').value.trim();
      const date = document.getElementById('mr_date').value;
      const location = document.getElementById('mr_location').value.trim();
      const weather = document.getElementById('mr_weather').value;

      if (!name || !date || !location) {
        alert('è¯·å¡«å†™å®Œæ•´çš„æ¯”èµ›ä¿¡æ¯ï¼ˆèµ›äº‹åç§°ã€æ—¶é—´ã€åœ°ç‚¹ä¸ºå¿…å¡«é¡¹ï¼‰');
        return;
      }

      const participants = [];
      document.querySelectorAll('#mr_participantsContainer .mobile-race-item').forEach(item => {
        const pigeonId = item.querySelector('.participant-pigeon')?.value;
        const rank = item.querySelector('.participant-rank')?.value;
        const score = item.querySelector('.participant-score')?.value;
        const returnTime = item.querySelector('.participant-time')?.value;

        if (pigeonId) {
          participants.push({
            pigeonId,
            rank: rank ? parseInt(rank) : null,
            score: score ? parseFloat(score) : null,
            returnTime: returnTime || null
          });
        }
      });

      const races = loadRaces();
      const raceId = currentRaceId || Date.now().toString();

      const race = {
        id: raceId,
        name,
        date,
        location,
        weather: weather || null,
        participants
      };

      const index = races.findIndex(r => r.id === raceId);
      if (index >= 0) {
        races[index] = race;
      } else {
        races.push(race);
      }

      saveRaces(races);
      syncRacesToPigeons(); // åŒæ­¥åˆ°é¸½å­æ¡£æ¡ˆ
      refreshRaceList();
      refreshList();
      closeRaceModal();
      alert('æ¯”èµ›ä¿å­˜æˆåŠŸï¼å·²è‡ªåŠ¨åŒæ­¥åˆ°é¸½å­æ¡£æ¡ˆã€‚');
    }

    // åŒæ­¥æ¯”èµ›æ•°æ®åˆ°é¸½å­æ¡£æ¡ˆ
    function syncRacesToPigeons() {
      const races = loadRaces();
      const pigeons = loadPigeons();

      // æ¸…ç©ºæ‰€æœ‰é¸½å­çš„å‚èµ›è®°å½•
      pigeons.forEach(p => {
        p.races = [];
      });

      // é‡æ–°åˆ†é…å‚èµ›è®°å½•
      races.forEach(race => {
        race.participants.forEach(participant => {
          const pigeon = pigeons.find(p => p.id === participant.pigeonId);
          if (pigeon) {
            if (!pigeon.races) pigeon.races = [];
            pigeon.races.push({
              name: race.name,
              date: race.date,
              distance: null, // æ¯”èµ›æ•°æ®ä¸­æ²¡æœ‰è·ç¦»ä¿¡æ¯
              rank: participant.rank,
              total: race.participants.length,
              remark: race.weather || null
            });
          }
        });
      });

      saveToStorage();
    }

    // æŸ¥çœ‹æ¯”èµ›è¯¦æƒ…
    function viewRaceDetail(id) {
      const races = loadRaces();
      const race = races.find(r => r.id === id);
      if (!race) {
        alert('æœªæ‰¾åˆ°è¯¥æ¯”èµ›ä¿¡æ¯');
        return;
      }

      let detail = `æ¯”èµ›åç§°ï¼š${race.name}\n`;
      detail += `æ¯”èµ›æ—¶é—´ï¼š${race.date}\n`;
      detail += `æ¯”èµ›åœ°ç‚¹ï¼š${race.location}\n`;
      if (race.weather) detail += `å¤©æ°”æƒ…å†µï¼š${race.weather}\n`;
      detail += `\nå‚èµ›é¸½æ•°ï¼š${race.participants ? race.participants.length : 0}ç¾½\n\n`;
      
      if (race.participants && race.participants.length > 0) {
        detail += 'å‚èµ›æˆç»©ï¼š\n';
        const pigeons = loadPigeons();
        race.participants.forEach((p, index) => {
          const pigeon = pigeons.find(pid => pid.id === p.pigeonId);
          if (pigeon) {
            detail += `${index + 1}. ${pigeon.ring}${pigeon.name ? 'ï¼ˆ' + pigeon.name + 'ï¼‰' : ''}`;
            if (p.rank) detail += ` - åæ¬¡ï¼š${p.rank}`;
            if (p.score) detail += ` - åˆ†æ•°ï¼š${p.score}`;
            if (p.returnTime) detail += ` - å½’å·¢æ—¶é—´ï¼š${p.returnTime}`;
            detail += '\n';
          }
        });
      }

      alert(detail);
    }

    // åˆ é™¤æ¯”èµ›
    function deleteRace(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™åœºæ¯”èµ›å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        return;
      }

      const races = loadRaces();
      const index = races.findIndex(r => r.id === id);
      if (index >= 0) {
        races.splice(index, 1);
        saveRaces(races);
        syncRacesToPigeons();
        refreshRaceList();
        refreshList();
        alert('åˆ é™¤æˆåŠŸ');
      }
    }

    // ç”Ÿæˆç»Ÿè®¡æ•°æ®
    function getStatsData() {
      const pigeons = loadPigeons();
      const map = {};
      pigeons.forEach(p => {
        const birthYear = p.birth ? String(p.birth).slice(0, 4) : '';
        const deathYear = p.deathDate ? String(p.deathDate).slice(0, 4) : '';

        if (birthYear) {
          if (!map[birthYear]) map[birthYear] = { born: 0, dead: 0, raced: 0, racedSet: new Set() };
          map[birthYear].born += 1;
        }
        if (deathYear) {
          if (!map[deathYear]) map[deathYear] = { born: 0, dead: 0, raced: 0, racedSet: new Set() };
          map[deathYear].dead += 1;
        }
        if (p.races && p.races.length > 0) {
          p.races.forEach(r => {
            const year = r.date ? String(r.date).slice(0, 4) : '';
            if (!year) return;
            if (!map[year]) map[year] = { born: 0, dead: 0, raced: 0, racedSet: new Set() };
            map[year].racedSet.add(p.id);
          });
        }
      });
      
      // è½¬æ¢Setä¸ºæ•°å­—
      Object.keys(map).forEach(year => {
        map[year].raced = map[year].racedSet.size;
      });
      
      return map;
    }

    // åˆ·æ–°æ•°æ®æ¦‚è§ˆ
    function refreshDashboard() {
      const pigeons = loadPigeons();
      
      const total = pigeons.length;
      const alive = pigeons.filter(p => p.alive !== false).length;
      const dead = pigeons.filter(p => p.alive === false).length;
      const raced = pigeons.filter(p => p.races && p.races.length > 0).length;
      
      if (document.getElementById('statTotal')) {
        document.getElementById('statTotal').textContent = total;
      }
      if (document.getElementById('statAlive')) {
        document.getElementById('statAlive').textContent = alive;
      }
      if (document.getElementById('statDead')) {
        document.getElementById('statDead').textContent = dead;
      }
      if (document.getElementById('statRaced')) {
        document.getElementById('statRaced').textContent = raced;
      }
      
      // æ›´æ–°ç»Ÿè®¡å®¹å™¨ï¼ˆå¹´åº¦ç»Ÿè®¡è¡¨æ ¼ï¼‰
      const statsContainer = document.getElementById('statsContainer');
      if (statsContainer) {
        const map = getStatsData();
        const years = Object.keys(map).sort().reverse();
        
        if (years.length === 0) {
          statsContainer.innerHTML = `
            <div class="mobile-card">
              <div class="mobile-card-title">ğŸ“ˆ æ•°æ®ç»Ÿè®¡</div>
              <div class="mobile-card-meta">
                <span>æ€»è®°å½•æ•°: ${total}</span>
                <span>åœ¨ä¸–: ${alive}</span>
                <span>å·²æ­»äº¡: ${dead}</span>
              </div>
            </div>
          `;
          return;
        }

        // åˆ›å»ºå¹´åº¦ç»Ÿè®¡è¡¨æ ¼
        let tableHTML = `
          <div class="mobile-card" style="overflow-x: auto;">
            <div class="mobile-card-title">ğŸ“ˆ å¹´åº¦ç»Ÿè®¡</div>
            <table class="mobile-table" style="margin-top: 12px; min-width: 400px;">
              <thead>
                <tr>
                  <th>å¹´ä»½</th>
                  <th>å‡ºç”Ÿ</th>
                  <th>æ­»äº¡</th>
                  <th>æœ‰å‚èµ›è®°å½•</th>
                </tr>
              </thead>
              <tbody>
        `;

        years.forEach(year => {
          const info = map[year];
          tableHTML += `
            <tr>
              <td style="font-weight:600;">${year}</td>
              <td style="color:#059669;font-weight:500;">${info.born || 0}</td>
              <td style="color:#4b5563;font-weight:500;">${info.dead || 0}</td>
              <td style="color:#d97706;font-weight:500;">${info.raced || 0}</td>
            </tr>
          `;
        });

        tableHTML += `
              </tbody>
            </table>
          </div>
        `;

        statsContainer.innerHTML = tableHTML;
      }
    }

    // æ˜¾ç¤ºæ›´å¤šé€‰é¡¹
    function showMoreOptions() {
      alert('è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...\nå»ºè®®åœ¨PCç«¯ä½¿ç”¨å®Œæ•´åŠŸèƒ½');
    }

    // åˆ·æ–°è¡€ç»Ÿå…³ç³»é€‰æ‹©ä¸‹æ‹‰åˆ—è¡¨
    function refreshPedigreeSelect() {
      const select = document.getElementById('mp_pedigreeSelect');
      if (!select) return;
      
      select.innerHTML = '<option value="">é€‰æ‹©é¸½å­æŸ¥çœ‹è¡€ç»Ÿæ ‘</option>';
      const pigeons = loadPigeons();
      pigeons.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.ring}${p.name ? ' - ' + p.name : ''}${p.isCore ? ' â­' : ''}`;
        select.appendChild(opt);
      });
      
      // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
      const searchInput = document.getElementById('pedigreeSearchInput');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase().trim();
          if (!query) {
            // æ¸…ç©ºæœç´¢æ—¶æ˜¾ç¤ºæ‰€æœ‰é€‰é¡¹
            Array.from(select.options).forEach(opt => {
              opt.style.display = '';
            });
            return;
          }
          
          // è¿‡æ»¤é€‰é¡¹
          Array.from(select.options).forEach(opt => {
            if (opt.value === '') {
              opt.style.display = '';
              return;
            }
            const text = opt.textContent.toLowerCase();
            opt.style.display = text.includes(query) ? '' : 'none';
          });
        });
        
        searchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„é€‰é¡¹å¹¶é€‰æ‹©
            const visibleOptions = Array.from(select.options).filter(opt => opt.style.display !== 'none' && opt.value !== '');
            if (visibleOptions.length > 0) {
              select.value = visibleOptions[0].value;
              selectPedigreePigeon();
            }
          }
        });
      }
    }

    // é€‰æ‹©è¡€ç»Ÿå…³ç³»é¸½å­
    function selectPedigreePigeon() {
      const select = document.getElementById('mp_pedigreeSelect');
      const treeDiv = document.getElementById('mp_pedigreeTree');
      if (!select || !treeDiv) return;

      const pigeonId = select.value;
      if (!pigeonId) {
        treeDiv.innerHTML = '<div class="mobile-empty">è¯·ä»ä¸Šæ–¹ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©ä¸€åªé¸½å­ï¼ŒæŸ¥çœ‹å…¶å®Œæ•´è¡€ç»Ÿå…³ç³»æ ‘</div>';
        return;
      }

      const pigeon = getPigeonById(pigeonId);
      if (!pigeon) {
        treeDiv.innerHTML = '<div class="mobile-empty">æœªæ‰¾åˆ°è¯¥é¸½å­ä¿¡æ¯</div>';
        return;
      }

      renderMobilePedigreeTreeFull(pigeon, treeDiv);
    }

    // æ¸²æŸ“å®Œæ•´çš„ç§»åŠ¨ç«¯è¡€ç»Ÿæ ‘ï¼ˆç”¨äºè¡€ç»Ÿå…³ç³»è§†å›¾ï¼‰
    function renderMobilePedigreeTreeFull(pigeon, container) {
      container.innerHTML = '';

      function buildTree(p, level = 0, maxLevel = 4) {
        if (!p || level >= maxLevel) return null;
        const node = {
          id: p.id,
          ring: p.ring,
          name: p.name,
          isCore: p.isCore,
          alive: p.alive,
          level: level,
          type: p.type
        };
        const father = p.fatherId ? getPigeonById(p.fatherId) : null;
        const mother = p.motherId ? getPigeonById(p.motherId) : null;
        node.father = father ? buildTree(father, level + 1, maxLevel) : null;
        node.mother = mother ? buildTree(mother, level + 1, maxLevel) : null;
        return node;
      }

      const tree = buildTree(pigeon);
      if (!tree) {
        container.innerHTML = '<div class="mobile-empty">æš‚æ— è¡€ç»Ÿæ ‘æ•°æ®ï¼ˆéœ€è¦è®¾ç½®çˆ¶é¸½å’Œæ¯é¸½ä¿¡æ¯ï¼‰ã€‚</div>';
        return;
      }

      function renderNode(node, parentEl, isRoot = false) {
        if (!node) return;

        const nodeContainer = document.createElement('div');
        nodeContainer.style.cssText = 'text-align:center;margin:8px;';

        const nodeEl = document.createElement('div');
        nodeEl.style.cssText = `
          padding:10px 12px;
          margin:4px auto;
          background:${node.isCore ? '#fef3c7' : 'var(--bg-secondary)'};
          border:2px solid ${node.isCore ? '#f59e0b' : 'var(--border-light)'};
          border-radius:8px;
          text-align:center;
          cursor:pointer;
          font-size:13px;
          max-width:200px;
          transition:all 0.2s;
        `;
        if (!node.alive) {
          nodeEl.style.opacity = '0.6';
          nodeEl.style.textDecoration = 'line-through';
        }
        
        nodeEl.innerHTML = `
          <div style="font-weight:600;">${escapeHtml(node.ring)}</div>
          ${node.name ? `<div style="font-size:11px;color:var(--text-secondary);margin-top:2px;">${escapeHtml(node.name)}</div>` : ''}
          ${node.isCore ? '<div style="font-size:10px;color:#b45309;margin-top:4px;">â­ æ ¸å¿ƒç§é¸½</div>' : ''}
          ${!node.alive ? '<div style="font-size:10px;color:#991b1b;margin-top:4px;">[å·²æ­»äº¡]</div>' : ''}
        `;

        nodeEl.onclick = () => {
          if (node.id !== currentDetailId) {
            viewPigeonDetail(node.id);
          }
        };

        nodeEl.onmouseover = function() {
          this.style.transform = 'scale(1.05)';
          this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        };
        nodeEl.onmouseout = function() {
          this.style.transform = 'scale(1)';
          this.style.boxShadow = 'none';
        };

        nodeContainer.appendChild(nodeEl);

        if (node.father || node.mother) {
          const parentsContainer = document.createElement('div');
          parentsContainer.style.cssText = 'display:flex;gap:12px;margin-top:12px;justify-content:center;flex-wrap:wrap;';
          
          if (node.father) {
            const fatherContainer = document.createElement('div');
            fatherContainer.style.cssText = 'text-align:center;';
            const fatherLabel = document.createElement('div');
            fatherLabel.textContent = 'çˆ¶';
            fatherLabel.style.cssText = 'font-size:11px;color:var(--text-secondary);margin-bottom:6px;font-weight:500;';
            fatherContainer.appendChild(fatherLabel);
            renderNode(node.father, fatherContainer);
            parentsContainer.appendChild(fatherContainer);
          }
          
          if (node.mother) {
            const motherContainer = document.createElement('div');
            motherContainer.style.cssText = 'text-align:center;';
            const motherLabel = document.createElement('div');
            motherLabel.textContent = 'æ¯';
            motherLabel.style.cssText = 'font-size:11px;color:var(--text-secondary);margin-bottom:6px;font-weight:500;';
            motherContainer.appendChild(motherLabel);
            renderNode(node.mother, motherContainer);
            parentsContainer.appendChild(motherContainer);
          }
          
          nodeContainer.appendChild(parentsContainer);
        }

        parentEl.appendChild(nodeContainer);
      }

      const rootContainer = document.createElement('div');
      rootContainer.style.cssText = 'text-align:center;';
      const currentLabel = document.createElement('div');
      currentLabel.textContent = 'å½“å‰é¸½å­';
      currentLabel.style.cssText = 'font-size:12px;color:var(--text-secondary);margin-bottom:12px;font-weight:500;';
      rootContainer.appendChild(currentLabel);
      renderNode(tree, rootContainer, true);
      container.appendChild(rootContainer);
    }

    // ========================================
    // ğŸ’• ç¹è‚²é…å¯¹åŠŸèƒ½
    // ========================================
    
    const PAIRING_RECORDS_KEY = 'pigeon_pairing_records_v1';
    let pairings = [];
    
    function loadPairings() {
      try {
        const raw = localStorage.getItem(PAIRING_RECORDS_KEY);
        if (raw) pairings = JSON.parse(raw);
      } catch (e) {
        console.error('åŠ è½½é…å¯¹è®°å½•å¤±è´¥:', e);
        pairings = [];
      }
    }
    
    function savePairings() {
      try {
        localStorage.setItem(PAIRING_RECORDS_KEY, JSON.stringify(pairings));
      } catch (e) {
        console.error('ä¿å­˜é…å¯¹è®°å½•å¤±è´¥:', e);
      }
    }
    
    // è·å–ç¥–å…ˆï¼ˆç”¨äºè®¡ç®—è¿‘äº²ç³»æ•°ï¼‰
    function getAncestors(pigeonId, maxDepth) {
      const ancestors = [];
      const visited = new Set();
      
      function traverse(id, generation) {
        if (generation > maxDepth || visited.has(id)) return;
        visited.add(id);
        
        const pigeon = getPigeonById(id);
        if (!pigeon) return;
        
        ancestors.push({ id, generation });
        
        if (pigeon.fatherId) traverse(pigeon.fatherId, generation + 1);
        if (pigeon.motherId) traverse(pigeon.motherId, generation + 1);
      }
      
      traverse(pigeonId, 0);
      return ancestors;
    }
    
    // è®¡ç®—è¿‘äº²ç³»æ•°
    function calculateInbreedingCoefficient(maleId, femaleId) {
      const maleAncestors = getAncestors(maleId, 5);
      const femaleAncestors = getAncestors(femaleId, 5);
      
      const maleAncestorMap = new Map();
      maleAncestors.forEach(a => {
        if (!maleAncestorMap.has(a.id)) {
          maleAncestorMap.set(a.id, []);
        }
        maleAncestorMap.get(a.id).push(a.generation);
      });
      
      let inbreedingCoefficient = 0;
      const commonAncestors = [];
      
      femaleAncestors.forEach(fa => {
        if (maleAncestorMap.has(fa.id)) {
          const maleGenerations = maleAncestorMap.get(fa.id);
          maleGenerations.forEach(mg => {
            const contribution = Math.pow(0.5, mg + fa.generation);
            inbreedingCoefficient += contribution;
            
            const ancestor = getPigeonById(fa.id);
            if (ancestor && !commonAncestors.find(ca => ca.id === fa.id)) {
              commonAncestors.push({
                id: fa.id,
                name: ancestor.name || ancestor.ring,
                maleGen: mg,
                femaleGen: fa.generation
              });
            }
          });
        }
      });
      
      const percentage = Math.min(inbreedingCoefficient * 100, 50);
      
      return {
        coefficient: inbreedingCoefficient,
        percentage: percentage.toFixed(2),
        commonAncestors: commonAncestors,
        riskLevel: percentage < 6.25 ? 'low' : percentage < 12.5 ? 'medium' : 'high'
      };
    }
    
    // ç”Ÿæˆé…å¯¹è¯„ä¼°
    function generatePairingAssessment(maleId, femaleId) {
      const male = getPigeonById(maleId);
      const female = getPigeonById(femaleId);
      
      if (!male || !female) {
        return { score: 0, recommendation: 'unknown', reasons: [] };
      }
      
      const inbreeding = calculateInbreedingCoefficient(maleId, femaleId);
      
      let score = 70;
      const reasons = [];
      
      // è¿‘äº²ç³»æ•°è¯„ä¼°
      if (inbreeding.riskLevel === 'low') {
        score += 15;
        reasons.push('âœ… è¿‘äº²ç³»æ•°ä½ï¼Œé—ä¼ å¤šæ ·æ€§å¥½');
      } else if (inbreeding.riskLevel === 'medium') {
        score += 5;
        reasons.push('âš ï¸ ä¸­ç­‰è¿‘äº²é£é™©ï¼Œéœ€è¦å…³æ³¨');
      } else {
        score -= 20;
        reasons.push('âŒ é«˜è¿‘äº²é£é™©ï¼Œä¸å»ºè®®é…å¯¹');
      }
      
      // ç§é¸½è¯„ä¼°
      if (male.isCore) {
        score += 10;
        reasons.push('âœ… å…¬é¸½ä¸ºæ ¸å¿ƒç§é¸½');
      }
      if (female.isCore) {
        score += 10;
        reasons.push('âœ… æ¯é¸½ä¸ºæ ¸å¿ƒç§é¸½');
      }
      
      // å‚èµ›æˆç»©è¯„ä¼°
      const maleRaces = male.races || [];
      const femaleRaces = female.races || [];
      
      const maleBestRank = maleRaces.reduce((best, r) => r.rank && r.rank < best ? r.rank : best, 999);
      const femaleBestRank = femaleRaces.reduce((best, r) => r.rank && r.rank < best ? r.rank : best, 999);
      
      if (maleBestRank <= 10) {
        score += 10;
        reasons.push(`âœ… å…¬é¸½æœ€ä½³æˆç»©ç¬¬${maleBestRank}å`);
      }
      if (femaleBestRank <= 10) {
        score += 10;
        reasons.push(`âœ… æ¯é¸½æœ€ä½³æˆç»©ç¬¬${femaleBestRank}å`);
      }
      
      score = Math.max(0, Math.min(100, score));
      
      let recommendation;
      if (score >= 80) recommendation = 'å¼ºçƒˆæ¨è';
      else if (score >= 60) recommendation = 'æ¨è';
      else if (score >= 40) recommendation = 'è°¨æ…é…å¯¹';
      else recommendation = 'ä¸å»ºè®®';
      
      return {
        score,
        recommendation,
        reasons,
        inbreeding
      };
    }
    
    // å¡«å……ç¹è‚²é…å¯¹é€‰æ‹©æ¡†
    function fillBreedingSelects() {
      const maleSelect = document.getElementById('breedingMaleSelect');
      const femaleSelect = document.getElementById('breedingFemaleSelect');
      
      if (!maleSelect || !femaleSelect) return;
      
      maleSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å…¬é¸½...</option>';
      femaleSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ¯é¸½...</option>';
      
      const pigeons = loadPigeons();
      pigeons.filter(p => p.alive && p.gender === 'å…¬').forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.ring}${p.name ? ' - ' + p.name : ''}${p.isCore ? ' â­' : ''}`;
        maleSelect.appendChild(opt);
      });
      
      pigeons.filter(p => p.alive && p.gender === 'æ¯').forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.ring}${p.name ? ' - ' + p.name : ''}${p.isCore ? ' â­' : ''}`;
        femaleSelect.appendChild(opt);
      });
    }
    
    // æ›´æ–°é…å¯¹è¯„ä¼°æ˜¾ç¤º
    function updateBreedingAssessment() {
      const maleId = document.getElementById('breedingMaleSelect')?.value;
      const femaleId = document.getElementById('breedingFemaleSelect')?.value;
      const container = document.getElementById('breedingAssessment');
      const confirmBtn = document.getElementById('btnConfirmPairing');
      
      if (!container) return;
      
      if (!maleId || !femaleId) {
        container.innerHTML = `
          <div style="text-align:center;padding:40px 20px;color:var(--text-secondary);">
            <div style="font-size:32px;margin-bottom:12px;">ğŸ”®</div>
            <p>è¯·å…ˆé€‰æ‹©å…¬é¸½å’Œæ¯é¸½</p>
            <p style="font-size:12px;">ç³»ç»Ÿå°†è‡ªåŠ¨åˆ†æè¿‘äº²é£é™©ä¸é…å¯¹å»ºè®®</p>
          </div>
        `;
        if (confirmBtn) confirmBtn.disabled = true;
        return;
      }
      
      const assessment = generatePairingAssessment(maleId, femaleId);
      const male = getPigeonById(maleId);
      const female = getPigeonById(femaleId);
      
      const inbreedingColor = assessment.inbreeding.riskLevel === 'low' ? '#10b981' : 
                             assessment.inbreeding.riskLevel === 'medium' ? '#f59e0b' : '#ef4444';
      
      container.innerHTML = `
        <div style="text-align:center;margin-bottom:20px;">
          <div style="font-size:48px;font-weight:700;color:var(--primary);line-height:1;">
            ${assessment.score}
          </div>
          <div style="font-size:14px;color:var(--text-secondary);margin-top:4px;">é…å¯¹è¯„åˆ†</div>
          <div style="margin-top:8px;padding:6px 16px;border-radius:999px;display:inline-block;font-size:13px;font-weight:600;
            background:${assessment.score >= 80 ? '#d1fae5' : assessment.score >= 60 ? '#fef3c7' : assessment.score >= 40 ? '#fee2e2' : '#fecaca'};
            color:${assessment.score >= 80 ? '#047857' : assessment.score >= 60 ? '#b45309' : assessment.score >= 40 ? '#dc2626' : '#b91c1c'};">
            ${assessment.recommendation}
          </div>
        </div>
        
        <div style="margin-bottom:16px;padding:12px;background:var(--bg-primary);border-radius:8px;">
          <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px;">
            <span>è¿‘äº²ç³»æ•°</span>
            <span style="font-weight:600;color:${inbreedingColor};">${assessment.inbreeding.percentage}%</span>
          </div>
          <div style="height:8px;background:var(--border-light);border-radius:4px;overflow:hidden;">
            <div style="height:100%;width:${Math.min(assessment.inbreeding.percentage * 2, 100)}%;background:${inbreedingColor};transition:width 0.3s;"></div>
          </div>
        </div>
        
        ${assessment.inbreeding.commonAncestors.length > 0 ? `
          <div style="margin-bottom:16px;padding:12px;background:var(--bg-primary);border-radius:8px;">
            <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">å…±åŒç¥–å…ˆï¼š</div>
            ${assessment.inbreeding.commonAncestors.slice(0, 3).map(a => `
              <span style="display:inline-block;padding:4px 8px;background:var(--bg-secondary);border-radius:4px;font-size:12px;margin:2px;">${escapeHtml(a.name)}</span>
            `).join('')}
          </div>
        ` : ''}
        
        <div style="font-size:12px;">
          <div style="font-weight:600;margin-bottom:8px;color:var(--text-primary);">è¯„ä¼°ç†ç”±ï¼š</div>
          ${assessment.reasons.map(r => `
            <div style="padding:6px 0;border-bottom:1px solid var(--border-light);">${r}</div>
          `).join('')}
        </div>
      `;
      
      if (confirmBtn) confirmBtn.disabled = false;
    }
    
    // ä¿å­˜é…å¯¹è®°å½•
    function savePairingRecord() {
      const maleId = document.getElementById('breedingMaleSelect')?.value;
      const femaleId = document.getElementById('breedingFemaleSelect')?.value;
      
      if (!maleId || !femaleId) {
        alert('è¯·å…ˆé€‰æ‹©å…¬é¸½å’Œæ¯é¸½');
        return;
      }
      
      const male = getPigeonById(maleId);
      const female = getPigeonById(femaleId);
      const assessment = generatePairingAssessment(maleId, femaleId);
      
      const pairing = {
        id: 'pairing_' + Date.now(),
        maleId,
        femaleId,
        maleName: male.name || male.ring,
        femaleName: female.name || female.ring,
        date: new Date().toISOString().split('T')[0],
        score: assessment.score,
        recommendation: assessment.recommendation,
        inbreeding: assessment.inbreeding.percentage,
        createdAt: new Date().toISOString()
      };
      
      pairings.push(pairing);
      savePairings();
      
      alert('é…å¯¹è®°å½•å·²ä¿å­˜ï¼');
      
      // æ¸…ç©ºé€‰æ‹©
      document.getElementById('breedingMaleSelect').value = '';
      document.getElementById('breedingFemaleSelect').value = '';
      updateBreedingAssessment();
      renderPairingHistory();
    }
    
    // æ¸²æŸ“é…å¯¹å†å²è®°å½•
    function renderPairingHistory() {
      const container = document.getElementById('pairingHistoryContainer');
      if (!container) return;
      
      loadPairings();
      
      if (pairings.length === 0) {
        container.innerHTML = '<div class="mobile-empty">æš‚æ— é…å¯¹è®°å½•</div>';
        return;
      }
      
      const sortedPairings = [...pairings].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      container.innerHTML = sortedPairings.map(pairing => {
        const scoreColor = pairing.score >= 80 ? '#10b981' : 
                          pairing.score >= 60 ? '#3b82f6' : 
                          pairing.score >= 40 ? '#f59e0b' : '#ef4444';
        
        return `
          <div class="mobile-card">
            <div class="mobile-card-title">
              â™‚ ${pairing.maleName} Ã— â™€ ${pairing.femaleName}
              <span style="float:right;font-weight:700;color:${scoreColor};font-size:18px;">${pairing.score}åˆ†</span>
            </div>
            <div class="mobile-card-meta">
              ${pairing.date} | ${pairing.recommendation} | è¿‘äº²ç³»æ•°: ${pairing.inbreeding}%
            </div>
          </div>
        `;
      }).join('');
    }
    
    // åˆå§‹åŒ–ç¹è‚²é…å¯¹
    function initBreeding() {
      loadPairings();
      fillBreedingSelects();
      renderPairingHistory();
      
      const maleSelect = document.getElementById('breedingMaleSelect');
      const femaleSelect = document.getElementById('breedingFemaleSelect');
      const confirmBtn = document.getElementById('btnConfirmPairing');
      
      if (maleSelect) {
        maleSelect.addEventListener('change', updateBreedingAssessment);
      }
      if (femaleSelect) {
        femaleSelect.addEventListener('change', updateBreedingAssessment);
      }
      if (confirmBtn) {
        confirmBtn.addEventListener('click', savePairingRecord);
      }
    }
    
    // ========================================
    // ğŸ©º å¥åº·ç®¡ç†åŠŸèƒ½
    // ========================================
    
    const HEALTH_RECORDS_KEY = 'pigeon_health_records_v1';
    let healthRecords = [];
    
    function loadHealthRecords() {
      try {
        const raw = localStorage.getItem(HEALTH_RECORDS_KEY);
        if (raw) healthRecords = JSON.parse(raw);
        else healthRecords = [];
      } catch (e) {
        console.error('åŠ è½½å¥åº·è®°å½•å¤±è´¥:', e);
        healthRecords = [];
      }
    }
    
    function saveHealthRecords() {
      try {
        localStorage.setItem(HEALTH_RECORDS_KEY, JSON.stringify(healthRecords));
      } catch (e) {
        console.error('ä¿å­˜å¥åº·è®°å½•å¤±è´¥:', e);
      }
    }
    
    // è·å–å¥åº·çŠ¶æ€ç»Ÿè®¡
    function getHealthStats() {
      const now = new Date();
      const pigeons = loadPigeons();
      
      let healthy = 0;
      let upcoming = 0;
      let needAttention = 0;
      let medicating = 0;
      
      pigeons.forEach(p => {
        if (!p.alive) return;
        
        const pigeonRecords = healthRecords.filter(r => r.pigeonId === p.id).sort((a, b) => new Date(b.date) - new Date(a.date));
        if (pigeonRecords.length === 0) {
          healthy++;
          return;
        }
        
        const latestRecord = pigeonRecords[0];
        const recordDate = new Date(latestRecord.date);
        const daysSince = Math.floor((now - recordDate) / (1000 * 60 * 60 * 24));
        
        if (latestRecord.type === 'ç–¾ç—…') {
          needAttention++;
        } else if (latestRecord.type === 'ç”¨è¯') {
          medicating++;
        } else if (latestRecord.nextDate) {
          const nextDate = new Date(latestRecord.nextDate);
          const daysUntil = Math.floor((nextDate - now) / (1000 * 60 * 60 * 24));
          if (daysUntil <= 7 && daysUntil >= 0) {
            upcoming++;
          } else if (daysUntil < 0) {
            needAttention++;
          } else {
            healthy++;
          }
        } else {
          healthy++;
        }
      });
      
      return { healthy, upcoming, needAttention, medicating };
    }
    
    // æ¸²æŸ“å¥åº·æ¦‚è§ˆ
    function renderHealthOverview() {
      const stats = getHealthStats();
      document.getElementById('healthyCount').textContent = stats.healthy;
      document.getElementById('upcomingCount').textContent = stats.upcoming;
      document.getElementById('needAttentionCount').textContent = stats.needAttention;
      document.getElementById('medicatingCount').textContent = stats.medicating;
    }
    
    // æ¸²æŸ“å¥åº·æé†’
    function renderHealthAlerts() {
      const container = document.getElementById('healthAlertsContainer');
      if (!container) return;
      
      const now = new Date();
      const alerts = [];
      
      healthRecords.forEach(record => {
        if (record.nextDate) {
          const nextDate = new Date(record.nextDate);
          const daysUntil = Math.floor((nextDate - now) / (1000 * 60 * 60 * 24));
          
          if (daysUntil <= 7 && daysUntil >= 0) {
            const pigeon = getPigeonById(record.pigeonId);
            alerts.push({
              pigeon: pigeon ? (pigeon.name || pigeon.ring) : 'æœªçŸ¥',
              type: record.type,
              date: record.nextDate,
              daysUntil
            });
          }
        }
      });
      
      if (alerts.length === 0) {
        container.innerHTML = '<div class="mobile-empty">æš‚æ— å¥åº·æé†’</div>';
        return;
      }
      
      container.innerHTML = alerts.slice(0, 10).map(alert => `
        <div class="mobile-card">
          <div class="mobile-card-title">${alert.pigeon} - ${alert.type}</div>
          <div class="mobile-card-meta">
            ${alert.daysUntil === 0 ? 'ä»Šå¤©åˆ°æœŸ' : `${alert.daysUntil}å¤©ååˆ°æœŸ`} | ${alert.date}
          </div>
        </div>
      `).join('');
    }
    
    // æ¸²æŸ“å¥åº·è®°å½•åˆ—è¡¨
    function renderHealthRecords(pigeonId = null) {
      const container = document.getElementById('healthRecordsContainer');
      if (!container) return;
      
      let filtered = healthRecords;
      if (pigeonId) {
        filtered = healthRecords.filter(r => r.pigeonId === pigeonId);
      }
      
      filtered = filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      if (filtered.length === 0) {
        container.innerHTML = '<div class="mobile-empty">æš‚æ— å¥åº·è®°å½•</div>';
        return;
      }
      
      container.innerHTML = filtered.map(record => {
        const pigeon = getPigeonById(record.pigeonId);
        const typeIcons = {
          'ç–«è‹—': 'ğŸ’‰',
          'é©±è™«': 'ğŸ›',
          'ä½“æ£€': 'ğŸ”¬',
          'ç–¾ç—…': 'ğŸ¥',
          'ç”¨è¯': 'ğŸ’Š',
          'åº·å¤': 'âœ…',
          'å…¶ä»–': 'ğŸ“'
        };
        
        return `
          <div class="mobile-card">
            <div class="mobile-card-title">${typeIcons[record.type] || 'ğŸ“'} ${record.type}</div>
            <div class="mobile-card-meta">
              ${pigeon ? (pigeon.name || pigeon.ring) : 'æœªçŸ¥é¸½å­'} | ${record.date}
              ${record.nextDate ? ` | ä¸‹æ¬¡: ${record.nextDate}` : ''}
            </div>
            ${record.description ? `<div style="margin-top:8px;font-size:13px;color:var(--text-secondary);">${escapeHtml(record.description)}</div>` : ''}
          </div>
        `;
      }).join('');
    }
    
    // è¿‡æ»¤å¥åº·è®°å½•
    function filterHealthRecords() {
      const select = document.getElementById('healthPigeonSelect');
      const pigeonId = select ? select.value : null;
      renderHealthRecords(pigeonId);
    }
    
    // å¡«å……å¥åº·è®°å½•é¸½å­é€‰æ‹©
    function fillHealthPigeonSelects() {
      const select = document.getElementById('healthPigeonSelect');
      if (!select) return;
      
      select.innerHTML = '<option value="">å…¨éƒ¨é¸½å­</option>';
      const pigeons = loadPigeons();
      pigeons.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.ring}${p.name ? ' - ' + p.name : ''}`;
        select.appendChild(opt);
      });
    }
    
    // å¡«å……å¥åº·è®°å½•è¡¨å•çš„é¸½å­é€‰æ‹©
    function fillHealthRecordPigeonSelect() {
      const select = document.getElementById('healthRecordPigeon');
      if (!select) return;
      
      select.innerHTML = '<option value="">é€‰æ‹©é¸½å­...</option>';
      const pigeons = loadPigeons();
      pigeons.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.ring}${p.name ? ' - ' + p.name : ''}`;
        select.appendChild(opt);
      });
    }
    
    // æ˜¾ç¤ºæ·»åŠ å¥åº·è®°å½•æ¨¡æ€æ¡†
    function showAddHealthRecord() {
      const modal = document.getElementById('healthRecordModal');
      if (!modal) {
        // åˆ›å»ºæ¨¡æ€æ¡†
        const modalHTML = `
          <div id="healthRecordModal" class="mobile-modal" style="display:none;">
            <div class="mobile-modal-content">
              <div class="mobile-modal-header">
                <h3>ğŸ’‰ æ·»åŠ å¥åº·è®°å½•</h3>
                <button onclick="closeHealthRecordModal()" style="background:none;border:none;font-size:24px;cursor:pointer;">âœ•</button>
              </div>
              <div class="mobile-modal-body">
                <div class="mobile-form-group">
                  <label>é€‰æ‹©é¸½å­<span style="color:#ef4444;">*</span></label>
                  <select id="healthRecordPigeon" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border-light);">
                    <option value="">é€‰æ‹©é¸½å­...</option>
                  </select>
                </div>
                <div class="mobile-form-group">
                  <label>è®°å½•ç±»å‹<span style="color:#ef4444;">*</span></label>
                  <select id="healthRecordType" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border-light);">
                    <option value="">é€‰æ‹©ç±»å‹...</option>
                    <option value="ç–«è‹—">ğŸ’‰ ç–«è‹—æ¥ç§</option>
                    <option value="é©±è™«">ğŸ› é©±è™«</option>
                    <option value="ä½“æ£€">ğŸ”¬ ä½“æ£€</option>
                    <option value="ç–¾ç—…">ğŸ¥ ç–¾ç—…è®°å½•</option>
                    <option value="ç”¨è¯">ğŸ’Š ç”¨è¯è®°å½•</option>
                    <option value="åº·å¤">âœ… åº·å¤è®°å½•</option>
                    <option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
                  </select>
                </div>
                <div class="mobile-form-group">
                  <label>æ—¥æœŸ<span style="color:#ef4444;">*</span></label>
                  <input type="date" id="healthRecordDate" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border-light);" />
                </div>
                <div class="mobile-form-group">
                  <label>ä¸‹æ¬¡æé†’æ—¥æœŸ</label>
                  <input type="date" id="healthRecordNextDate" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border-light);" />
                </div>
                <div class="mobile-form-group">
                  <label>è¯¦ç»†æè¿°</label>
                  <textarea id="healthRecordDescription" rows="4" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border-light);resize:vertical;" placeholder="è®°å½•è¯¦ç»†æƒ…å†µï¼Œå¦‚ï¼šç–«è‹—åç§°ã€å‰‚é‡ã€è¯ç‰©åç§°ã€ç—‡çŠ¶ç­‰"></textarea>
                </div>
              </div>
              <div class="mobile-modal-footer">
                <button onclick="closeHealthRecordModal()" class="btn-outline" style="flex:1;padding:12px;border-radius:8px;border:1px solid var(--border-light);background:var(--bg-secondary);cursor:pointer;">å–æ¶ˆ</button>
                <button onclick="saveHealthRecord()" class="btn-primary" style="flex:1;padding:12px;border-radius:8px;border:none;background:var(--primary);color:#fff;cursor:pointer;font-weight:600;">ä¿å­˜</button>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      fillHealthRecordPigeonSelect();
      document.getElementById('healthRecordDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('healthRecordModal').style.display = 'flex';
    }
    
    function closeHealthRecordModal() {
      const modal = document.getElementById('healthRecordModal');
      if (modal) modal.style.display = 'none';
    }
    
    // ä¿å­˜å¥åº·è®°å½•
    function saveHealthRecord() {
      const pigeonId = document.getElementById('healthRecordPigeon')?.value;
      const type = document.getElementById('healthRecordType')?.value;
      const date = document.getElementById('healthRecordDate')?.value;
      const nextDate = document.getElementById('healthRecordNextDate')?.value;
      const description = document.getElementById('healthRecordDescription')?.value;
      
      if (!pigeonId) {
        alert('è¯·é€‰æ‹©é¸½å­');
        return;
      }
      if (!type) {
        alert('è¯·é€‰æ‹©è®°å½•ç±»å‹');
        return;
      }
      if (!date) {
        alert('è¯·é€‰æ‹©æ—¥æœŸ');
        return;
      }
      
      const record = {
        id: 'health_' + Date.now(),
        pigeonId,
        type,
        date,
        nextDate: nextDate || null,
        description: description || '',
        createdAt: new Date().toISOString()
      };
      
      healthRecords.push(record);
      saveHealthRecords();
      
      closeHealthRecordModal();
      
      // æ¸…ç©ºè¡¨å•
      document.getElementById('healthRecordPigeon').value = '';
      document.getElementById('healthRecordType').value = '';
      document.getElementById('healthRecordDate').value = '';
      document.getElementById('healthRecordNextDate').value = '';
      document.getElementById('healthRecordDescription').value = '';
      
      // åˆ·æ–°æ˜¾ç¤º
      renderHealthOverview();
      renderHealthAlerts();
      renderHealthRecords();
      renderHealthCalendar();
      fillHealthPigeonSelects();
      
      alert('å¥åº·è®°å½•å·²ä¿å­˜ï¼');
    }
    
    // æ¸²æŸ“å¥åº·æé†’æ—¥å†
    function renderHealthCalendar() {
      const container = document.getElementById('healthCalendarContainer');
      if (!container) return;
      
      const now = new Date();
      const alerts = [];
      
      healthRecords.forEach(record => {
        if (record.nextDate) {
          const nextDate = new Date(record.nextDate);
          const daysUntil = Math.floor((nextDate - now) / (1000 * 60 * 60 * 24));
          
          if (daysUntil <= 30 && daysUntil >= -7) {
            const pigeon = getPigeonById(record.pigeonId);
            alerts.push({
              pigeon: pigeon ? (pigeon.name || pigeon.ring) : 'æœªçŸ¥',
              type: record.type,
              date: record.nextDate,
              daysUntil,
              description: record.description
            });
          }
        }
      });
      
      alerts.sort((a, b) => a.daysUntil - b.daysUntil);
      
      if (alerts.length === 0) {
        container.innerHTML = '<div class="mobile-empty">æš‚æ— å³å°†åˆ°æœŸçš„æé†’</div>';
        return;
      }
      
      container.innerHTML = alerts.map(alert => {
        const alertColor = alert.daysUntil < 0 ? '#ef4444' : alert.daysUntil <= 3 ? '#f59e0b' : '#3b82f6';
        const alertBg = alert.daysUntil < 0 ? '#fee2e2' : alert.daysUntil <= 3 ? '#fef3c7' : '#dbeafe';
        
        return `
          <div class="mobile-card" style="border-left:4px solid ${alertColor};">
            <div class="mobile-card-title">${alert.pigeon} - ${alert.type}</div>
            <div class="mobile-card-meta">
              ${alert.daysUntil < 0 ? `å·²è¿‡æœŸ ${Math.abs(alert.daysUntil)} å¤©` : alert.daysUntil === 0 ? 'ä»Šå¤©åˆ°æœŸ' : `${alert.daysUntil}å¤©ååˆ°æœŸ`} | ${alert.date}
            </div>
            ${alert.description ? `<div style="margin-top:8px;font-size:13px;color:var(--text-secondary);">${escapeHtml(alert.description)}</div>` : ''}
          </div>
        `;
      }).join('');
    }
    
    // åˆå§‹åŒ–å¥åº·ç®¡ç†
    function initHealth() {
      loadHealthRecords();
      fillHealthPigeonSelects();
      renderHealthOverview();
      renderHealthAlerts();
      renderHealthRecords();
      renderHealthCalendar();
    }
    
    // å¡«å……è®­ç»ƒè®°å½•è¡¨å•çš„é¸½å­é€‰æ‹©
    function fillTrainingRecordPigeonSelect() {
      const select = document.getElementById('trainingRecordPigeon');
      if (!select) return;
      
      select.innerHTML = '<option value="">é€‰æ‹©é¸½å­...</option>';
      const pigeons = loadPigeons();
      pigeons.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.ring}${p.name ? ' - ' + p.name : ''}`;
        select.appendChild(opt);
      });
    }

    // ========================================
    // ğŸƒ è®­ç»ƒæ¨¡å—åŠŸèƒ½
    // ========================================
    
    const TRAINING_STORAGE_KEY = 'pigeon_training_records_v1';
    let trainingRecords = [];
    
    function loadTrainingRecords() {
      try {
        const raw = localStorage.getItem(TRAINING_STORAGE_KEY);
        if (raw) trainingRecords = JSON.parse(raw);
        else trainingRecords = [];
      } catch (e) {
        console.error('åŠ è½½è®­ç»ƒè®°å½•å¤±è´¥:', e);
        trainingRecords = [];
      }
    }
    
    function saveTrainingRecords() {
      try {
        localStorage.setItem(TRAINING_STORAGE_KEY, JSON.stringify(trainingRecords));
      } catch (e) {
        console.error('ä¿å­˜è®­ç»ƒè®°å½•å¤±è´¥:', e);
      }
    }
    
    // æ¸²æŸ“è®­ç»ƒè®°å½•åˆ—è¡¨
    function renderTrainingRecords(pigeonId = null) {
      const container = document.getElementById('trainingRecordsContainer');
      if (!container) return;
      
      let filtered = trainingRecords;
      if (pigeonId) {
        filtered = trainingRecords.filter(r => r.pigeonId === pigeonId);
      }
      
      filtered = filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      if (filtered.length === 0) {
        container.innerHTML = '<div class="mobile-empty">æš‚æ— è®­ç»ƒè®°å½•</div>';
        return;
      }
      
      container.innerHTML = filtered.map(record => {
        const pigeon = getPigeonById(record.pigeonId);
        const avgSpeed = record.distance && record.duration ? (record.distance / (record.duration / 60)).toFixed(1) : 'â€”';
        
        return `
          <div class="mobile-card">
            <div class="mobile-card-title">${pigeon ? (pigeon.name || pigeon.ring) : 'æœªçŸ¥é¸½å­'} - ${record.date}</div>
            <div class="mobile-card-meta">
              è·ç¦»: ${record.distance || 'â€”'}km | æ—¶é•¿: ${record.duration || 'â€”'}åˆ†é’Ÿ | å¹³å‡é€Ÿåº¦: ${avgSpeed}km/h
            </div>
            ${record.weather ? `<div style="margin-top:8px;font-size:13px;color:var(--text-secondary);">å¤©æ°”: ${record.weather}${record.temperature ? ` | æ¸©åº¦: ${record.temperature}â„ƒ` : ''}</div>` : ''}
            ${record.notes ? `<div style="margin-top:8px;font-size:13px;color:var(--text-secondary);">å¤‡æ³¨: ${escapeHtml(record.notes)}</div>` : ''}
          </div>
        `;
      }).join('');
    }
    
    // è¿‡æ»¤è®­ç»ƒè®°å½•
    function filterTrainingRecords() {
      const select = document.getElementById('trainingPigeonSelect');
      const pigeonId = select ? select.value : null;
      renderTrainingRecords(pigeonId);
    }
    
    // å¡«å……è®­ç»ƒè®°å½•é¸½å­é€‰æ‹©
    function fillTrainingPigeonSelects() {
      const select = document.getElementById('trainingPigeonSelect');
      if (!select) return;
      
      select.innerHTML = '<option value="">å…¨éƒ¨é¸½å­</option>';
      const pigeons = loadPigeons();
      pigeons.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.ring}${p.name ? ' - ' + p.name : ''}`;
        select.appendChild(opt);
      });
    }
    
    // æ˜¾ç¤ºæ·»åŠ è®­ç»ƒè®°å½•æ¨¡æ€æ¡†
    function showAddTrainingRecord() {
      const modal = document.getElementById('trainingRecordModal');
      if (!modal) {
        // åˆ›å»ºæ¨¡æ€æ¡†
        const modalHTML = `
          <div id="trainingRecordModal" class="mobile-modal" style="display:none;">
            <div class="mobile-modal-content">
              <div class="mobile-modal-header">
                <h3>âœï¸ æ·»åŠ è®­ç»ƒè®°å½•</h3>
                <button onclick="closeTrainingRecordModal()" style="background:none;border:none;font-size:24px;cursor:pointer;">âœ•</button>
              </div>
              <div class="mobile-modal-body">
                <div class="mobile-form-group">
                  <label>é€‰æ‹©é¸½å­<span style="color:#ef4444;">*</span></label>
                  <select id="trainingRecordPigeon" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border-light);">
                    <option value="">é€‰æ‹©é¸½å­...</option>
                  </select>
                </div>
                <div class="mobile-form-group">
                  <label>è®­ç»ƒæ—¥æœŸ<span style="color:#ef4444;">*</span></label>
                  <input type="date" id="trainingRecordDate" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border-light);" />
                </div>
                <div class="mobile-form-group">
                  <label>è®­ç»ƒè·ç¦»ï¼ˆå…¬é‡Œï¼‰<span style="color:#ef4444;">*</span></label>
                  <input type="number" id="trainingRecordDistance" step="0.1" placeholder="ä¾‹å¦‚ï¼š50" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border-light);" />
                </div>
                <div class="mobile-form-group">
                  <label>é£è¡Œæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰<span style="color:#ef4444;">*</span></label>
                  <input type="number" id="trainingRecordDuration" step="0.1" placeholder="ä¾‹å¦‚ï¼š60" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border-light);" />
                </div>
                <div class="mobile-form-group">
                  <label>å¤©æ°”</label>
                  <select id="trainingRecordWeather" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border-light);">
                    <option value="">é€‰æ‹©å¤©æ°”...</option>
                    <option value="æ™´å¤©">æ™´å¤©</option>
                    <option value="å¤šäº‘">å¤šäº‘</option>
                    <option value="é›¨å¤©">é›¨å¤©</option>
                    <option value="å¤§é£">å¤§é£</option>
                    <option value="é›¾å¤©">é›¾å¤©</option>
                  </select>
                </div>
                <div class="mobile-form-group">
                  <label>æ¸©åº¦ï¼ˆâ„ƒï¼‰</label>
                  <input type="number" id="trainingRecordTemperature" step="0.1" placeholder="ä¾‹å¦‚ï¼š25" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border-light);" />
                </div>
                <div class="mobile-form-group">
                  <label>å¤‡æ³¨</label>
                  <textarea id="trainingRecordNotes" rows="3" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border-light);resize:vertical;" placeholder="è®­ç»ƒå¤‡æ³¨ä¿¡æ¯"></textarea>
                </div>
              </div>
              <div class="mobile-modal-footer">
                <button onclick="closeTrainingRecordModal()" class="btn-outline" style="flex:1;padding:12px;border-radius:8px;border:1px solid var(--border-light);background:var(--bg-secondary);cursor:pointer;">å–æ¶ˆ</button>
                <button onclick="saveTrainingRecord()" class="btn-primary" style="flex:1;padding:12px;border-radius:8px;border:none;background:var(--primary);color:#fff;cursor:pointer;font-weight:600;">ä¿å­˜</button>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      }
      
      fillTrainingRecordPigeonSelect();
      document.getElementById('trainingRecordDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('trainingRecordModal').style.display = 'flex';
    }
    
    function closeTrainingRecordModal() {
      const modal = document.getElementById('trainingRecordModal');
      if (modal) modal.style.display = 'none';
    }
    
    // ä¿å­˜è®­ç»ƒè®°å½•
    function saveTrainingRecord() {
      const pigeonId = document.getElementById('trainingRecordPigeon')?.value;
      const date = document.getElementById('trainingRecordDate')?.value;
      const distance = parseFloat(document.getElementById('trainingRecordDistance')?.value);
      const duration = parseFloat(document.getElementById('trainingRecordDuration')?.value);
      const weather = document.getElementById('trainingRecordWeather')?.value;
      const temperature = document.getElementById('trainingRecordTemperature')?.value;
      const notes = document.getElementById('trainingRecordNotes')?.value;
      
      if (!pigeonId) {
        alert('è¯·é€‰æ‹©é¸½å­');
        return;
      }
      if (!date) {
        alert('è¯·é€‰æ‹©è®­ç»ƒæ—¥æœŸ');
        return;
      }
      if (!distance || distance <= 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è®­ç»ƒè·ç¦»');
        return;
      }
      if (!duration || duration <= 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é£è¡Œæ—¶é•¿');
        return;
      }
      
      const record = {
        id: 'training_' + Date.now(),
        pigeonId,
        date,
        distance,
        duration,
        weather: weather || null,
        temperature: temperature ? parseFloat(temperature) : null,
        notes: notes || '',
        createdAt: new Date().toISOString()
      };
      
      trainingRecords.push(record);
      saveTrainingRecords();
      
      closeTrainingRecordModal();
      
      // æ¸…ç©ºè¡¨å•
      document.getElementById('trainingRecordPigeon').value = '';
      document.getElementById('trainingRecordDate').value = '';
      document.getElementById('trainingRecordDistance').value = '';
      document.getElementById('trainingRecordDuration').value = '';
      document.getElementById('trainingRecordWeather').value = '';
      document.getElementById('trainingRecordTemperature').value = '';
      document.getElementById('trainingRecordNotes').value = '';
      
      // åˆ·æ–°æ˜¾ç¤º
      renderTrainingRecords();
      fillTrainingPigeonSelects();
      
      alert('è®­ç»ƒè®°å½•å·²ä¿å­˜ï¼');
    }
    
    // æ¸²æŸ“è®­ç»ƒæ•°æ®åˆ†æ
    function renderTrainingAnalysis(pigeonId = null) {
      const container = document.getElementById('trainingAnalysisContainer');
      if (!container) return;
      
      if (!pigeonId) {
        container.innerHTML = '<div class="mobile-empty">é€‰æ‹©é¸½å­æŸ¥çœ‹è®­ç»ƒåˆ†æ</div>';
        return;
      }
      
      const filtered = trainingRecords.filter(r => r.pigeonId === pigeonId);
      
      if (filtered.length === 0) {
        container.innerHTML = '<div class="mobile-empty">è¯¥é¸½å­æš‚æ— è®­ç»ƒè®°å½•</div>';
        return;
      }
      
      const avgDistance = filtered.reduce((sum, r) => sum + (r.distance || 0), 0) / filtered.length;
      const avgDuration = filtered.reduce((sum, r) => sum + (r.duration || 0), 0) / filtered.length;
      const maxDistance = Math.max(...filtered.map(r => r.distance || 0));
      const totalDistance = filtered.reduce((sum, r) => sum + (r.distance || 0), 0);
      const avgSpeed = filtered.filter(r => r.distance && r.duration).map(r => r.distance / (r.duration / 60)).reduce((sum, s) => sum + s, 0) / filtered.filter(r => r.distance && r.duration).length;
     
      // è‡ªåŠ¨è®­ç»ƒå»ºè®®ï¼šæ ¹æ®æœ€å¤§è·ç¦»ä¸é¢‘æ¬¡ç»™å‡ºç®€å•æç¤º
      let advice = '';
      if (filtered.length >= 5) {
        if (maxDistance < 100) {
          advice = 'å½“å‰è®­ç»ƒå¤šä»¥ 100 å…¬é‡Œä»¥å†…ä¸ºä¸»ï¼Œå»ºè®®é€æ­¥å¢åŠ ä¸­è·ç¦»è®­ç»ƒï¼Œä¸ºä¸­é•¿è·ç¦»æ¯”èµ›æ‰“åŸºç¡€ã€‚';
        } else if (maxDistance >= 300) {
          advice = 'å·²å…·å¤‡è¾ƒå¥½çš„é•¿è·ç¦»è®­ç»ƒåŸºç¡€ï¼Œå¯ç»“åˆæ¯”èµ›å®‰æ’ï¼Œé€‚å½“å¢åŠ æ¢å¤æ€§çŸ­è®­ï¼Œé¿å…è¿‡åº¦ç–²åŠ³ã€‚';
        } else {
          advice = 'è®­ç»ƒè·ç¦»è¦†ç›–ä¸­çŸ­ç¨‹ï¼Œå»ºè®®æ ¹æ®è¿‘æœŸæ¯”èµ›è·ç¦»ï¼Œæœ‰è®¡åˆ’åœ°æ‹‰é•¿æˆ–ç¼©çŸ­éƒ¨åˆ†è®­ç»ƒè·ç¦»ã€‚';
        }
      } else {
        advice = 'è®­ç»ƒè®°å½•è¾ƒå°‘ï¼Œå»ºè®®å…ˆä¿æŒæ¯å‘¨ 2â€“3 æ¬¡ç¨³å®šè®­ç»ƒï¼Œå½¢æˆåŸºæœ¬æ•°æ®åå†è¿›è¡Œæ›´ç»†è‡´çš„åˆ†æã€‚';
      }

      container.innerHTML = `
        <div class="mobile-card-title">è®­ç»ƒæ•°æ®åˆ†æ</div>
        <div class="mobile-card-meta">
          <div style="margin:8px 0;">æ€»è®­ç»ƒæ¬¡æ•°ï¼š${filtered.length}æ¬¡</div>
          <div style="margin:8px 0;">æ€»è®­ç»ƒè·ç¦»ï¼š${totalDistance.toFixed(1)}km</div>
          <div style="margin:8px 0;">å¹³å‡è·ç¦»ï¼š${avgDistance.toFixed(1)}km</div>
          <div style="margin:8px 0;">æœ€å¤§è·ç¦»ï¼š${maxDistance.toFixed(1)}km</div>
          <div style="margin:8px 0;">å¹³å‡æ—¶é•¿ï¼š${avgDuration.toFixed(1)}åˆ†é’Ÿ</div>
          ${avgSpeed ? `<div style="margin:8px 0;">å¹³å‡é€Ÿåº¦ï¼š${avgSpeed.toFixed(1)}km/h</div>` : ''}
        </div>
        <div style="margin-top:8px;font-size:13px;color:var(--text-secondary);line-height:1.6;">
          ğŸ§  è®­ç»ƒå»ºè®®ï¼š${advice}
        </div>
      `;
    }
    
    // æ›´æ–°è®­ç»ƒåˆ†æ
    function updateTrainingAnalysis() {
      const select = document.getElementById('trainingPigeonSelect');
      const pigeonId = select ? select.value : null;
      renderTrainingAnalysis(pigeonId);
    }
    
    // åˆå§‹åŒ–è®­ç»ƒæ¨¡å—
    function initTraining() {
      loadTrainingRecords();
      fillTrainingPigeonSelects();
      renderTrainingRecords();
      
      const select = document.getElementById('trainingPigeonSelect');
      if (select) {
        select.addEventListener('change', () => {
          filterTrainingRecords();
          updateTrainingAnalysis();
        });
      }
    }
    
    // ========================================
    // ğŸ§  æ™ºèƒ½åˆ†æä¸­å¿ƒåŠŸèƒ½
    // ========================================
    
    // è®¡ç®—é¸½å­æ½œåŠ›è¯„åˆ†
    function calculatePotentialScore(pigeon) {
      let score = 50;
      const factors = [];
      
      const father = pigeon.fatherId ? getPigeonById(pigeon.fatherId) : null;
      const mother = pigeon.motherId ? getPigeonById(pigeon.motherId) : null;
      
      if (father?.isCore) {
        score += 10;
        factors.push('çˆ¶ä¸ºæ ¸å¿ƒç§é¸½');
      }
      if (mother?.isCore) {
        score += 10;
        factors.push('æ¯ä¸ºæ ¸å¿ƒç§é¸½');
      }
      
      const fatherBest = father?.races?.reduce((best, r) => r.rank && r.rank < best ? r.rank : best, 999) || 999;
      const motherBest = mother?.races?.reduce((best, r) => r.rank && r.rank < best ? r.rank : best, 999) || 999;
      
      if (fatherBest <= 3) {
        score += 5;
        factors.push('çˆ¶æœ‰å‰3æˆç»©');
      }
      if (motherBest <= 3) {
        score += 5;
        factors.push('æ¯æœ‰å‰3æˆç»©');
      }
      
      const races = pigeon.races || [];
      const wins = races.filter(r => r.rank && r.rank <= 3).length;
      const top10 = races.filter(r => r.rank && r.rank <= 10).length;
      const bestRank = races.reduce((best, r) => r.rank && r.rank < best ? r.rank : best, 999);
      
      if (wins >= 3) {
        score += 20;
        factors.push(`${wins}æ¬¡å‰3å`);
      } else if (wins >= 1) {
        score += wins * 5;
        factors.push(`${wins}æ¬¡å‰3å`);
      }
      
      if (top10 >= 5) {
        score += 10;
        factors.push('ç¨³å®šå‘æŒ¥');
      }
      
      if (bestRank === 1) {
        score += 10;
        factors.push('å† å†›');
      }
      
      const pigeonHealth = healthRecords.filter(r => r.pigeonId === pigeon.id);
      const hasIllness = pigeonHealth.some(r => r.type === 'ç–¾ç—…');
      if (!hasIllness && pigeonHealth.length > 0) {
        score += 10;
        factors.push('å¥åº·è®°å½•è‰¯å¥½');
      }
      
      if (pigeon.birth) {
        const age = new Date().getFullYear() - parseInt(pigeon.birth.substring(0, 4));
        if (age >= 2 && age <= 5) {
          score += 10;
          factors.push('é»„é‡‘å¹´é¾„');
        } else if (age < 2) {
          score += 5;
          factors.push('å¹´è½»æœ‰æ½œåŠ›');
        }
      }
      
      return {
        score: Math.min(100, Math.max(0, score)),
        factors
      };
    }
    
    // è·å–æœ€å¼ºç§å…¬/ç§æ¯
    function getTopBreeders() {
      const pigeons = loadPigeons();
      const males = pigeons.filter(p => p.gender === 'å…¬' && p.alive);
      const females = pigeons.filter(p => p.gender === 'æ¯' && p.alive);
      
      const calculateBreederScore = (breeder, isMale) => {
        const offspring = pigeons.filter(p => 
          isMale ? p.fatherId === breeder.id : p.motherId === breeder.id
        );
        
        if (offspring.length === 0) return { score: 0, offspring: 0, wins: 0 };
        
        let totalWins = 0;
        let totalRaces = 0;
        
        offspring.forEach(child => {
          const races = child.races || [];
          totalRaces += races.length;
          totalWins += races.filter(r => r.rank && r.rank <= 3).length;
        });
        
        const score = (totalWins * 3 + offspring.length) / (totalRaces || 1) * 10;
        
        return {
          score,
          offspring: offspring.length,
          wins: totalWins
        };
      };
      
      const maleScores = males.map(m => ({
        pigeon: m,
        ...calculateBreederScore(m, true)
      })).sort((a, b) => b.score - a.score);
      
      const femaleScores = females.map(f => ({
        pigeon: f,
        ...calculateBreederScore(f, false)
      })).sort((a, b) => b.score - a.score);
      
      return {
        topMale: maleScores[0] || null,
        topFemale: femaleScores[0] || null
      };
    }
    
    // è·å–æœ€ä½³è¡€ç³»
    function getTopBloodlines() {
      const pigeons = loadPigeons();
      const bloodlineStats = new Map();
      
      pigeons.forEach(p => {
        if (p.fatherId) {
          const father = getPigeonById(p.fatherId);
          if (father) {
            const key = `${father.id}_father`;
            if (!bloodlineStats.has(key)) {
              bloodlineStats.set(key, {
                ancestor: father,
                descendants: [],
                wins: 0,
                races: 0
              });
            }
            const stats = bloodlineStats.get(key);
            stats.descendants.push(p);
            const pRaces = p.races || [];
            stats.races += pRaces.length;
            stats.wins += pRaces.filter(r => r.rank && r.rank <= 3).length;
          }
        }
      });
      
      const bloodlines = Array.from(bloodlineStats.values())
        .map(b => ({
          ...b,
          score: b.races > 0 ? (b.wins * 3 + b.descendants.length) / b.races : 0
        }))
        .filter(b => b.descendants.length >= 2)
        .sort((a, b) => b.score - a.score);
      
      return bloodlines;
    }
    
    // æ™ºèƒ½é…å¯¹æ¨è
    function getRecommendedPairings() {
      const pigeons = loadPigeons();
      const males = pigeons.filter(p => p.gender === 'å…¬' && p.alive);
      const females = pigeons.filter(p => p.gender === 'æ¯' && p.alive);
      
      const recommendations = [];
      
      males.forEach(male => {
        females.forEach(female => {
          const assessment = generatePairingAssessment(male.id, female.id);
          if (assessment.score >= 70) {
            recommendations.push({
              male,
              female,
              assessment
            });
          }
        });
      });
      
      return recommendations.sort((a, b) => b.assessment.score - a.assessment.score).slice(0, 5);
    }
    
    // è¿è¡Œç§»åŠ¨ç«¯å…¨é¢åˆ†æ
    function runMobileFullAnalysis() {
      const pigeons = loadPigeons();
      loadHealthRecords();
      
      // æœ€ä½³è¡€ç³»
      const bloodlines = getTopBloodlines();
      const topBloodlineContainer = document.getElementById('topBloodlineCard');
      if (topBloodlineContainer) {
        if (bloodlines.length > 0) {
          const top = bloodlines[0];
          topBloodlineContainer.innerHTML = `
            <div class="mobile-card-title">${top.ancestor.name || top.ancestor.ring}</div>
            <div class="mobile-card-meta">
              åä»£æ•°ï¼š${top.descendants.length}åª | è·å¥–æ¬¡æ•°ï¼š${top.wins}æ¬¡<br>
              è¡€ç³»å¾—åˆ†ï¼š${top.score.toFixed(2)}
            </div>
          `;
        } else {
          topBloodlineContainer.innerHTML = '<div class="mobile-empty">æ•°æ®ä¸è¶³</div>';
        }
      }
      
      // æœ€å¼ºç§å…¬/ç§æ¯
      const topBreeders = getTopBreeders();
      
      const topMaleContainer = document.getElementById('topMaleCard');
      if (topMaleContainer && topBreeders.topMale) {
        const top = topBreeders.topMale;
        topMaleContainer.innerHTML = `
          <div class="mobile-card-title">${top.pigeon.name || top.pigeon.ring}</div>
          <div class="mobile-card-meta">
            åä»£æ•°ï¼š${top.offspring}åª | åä»£è·å¥–ï¼š${top.wins}æ¬¡<br>
            è‚²ç§å¾—åˆ†ï¼š${top.score.toFixed(2)}
          </div>
        `;
      }
      
      const topFemaleContainer = document.getElementById('topFemaleCard');
      if (topFemaleContainer && topBreeders.topFemale) {
        const top = topBreeders.topFemale;
        topFemaleContainer.innerHTML = `
          <div class="mobile-card-title">${top.pigeon.name || top.pigeon.ring}</div>
          <div class="mobile-card-meta">
            åä»£æ•°ï¼š${top.offspring}åª | åä»£è·å¥–ï¼š${top.wins}æ¬¡<br>
            è‚²ç§å¾—åˆ†ï¼š${top.score.toFixed(2)}
          </div>
        `;
      }
      
      // æ¨èé…å¯¹
      const recommendations = getRecommendedPairings();
      const recommendedContainer = document.getElementById('recommendedPairingCard');
      if (recommendedContainer) {
        if (recommendations.length > 0) {
          const top = recommendations[0];
          recommendedContainer.innerHTML = `
            <div class="mobile-card-title">
              â™‚ ${top.male.name || top.male.ring} Ã— â™€ ${top.female.name || top.female.ring}
            </div>
            <div class="mobile-card-meta">
              è¯„åˆ†ï¼š${top.assessment.score}åˆ† | ${top.assessment.recommendation}
            </div>
          `;
        } else {
          recommendedContainer.innerHTML = '<div class="mobile-empty">æš‚æ— æ¨è</div>';
        }
      }
      
      // æ½œåŠ›æ’è¡Œæ¦œ
      const potentialContainer = document.getElementById('potentialRankingContainer');
      if (potentialContainer) {
        const potentials = pigeons
          .filter(p => p.alive)
          .map(p => ({
            pigeon: p,
            ...calculatePotentialScore(p)
          }))
          .sort((a, b) => b.score - a.score)
          .slice(0, 10);
        
        if (potentials.length > 0) {
          potentialContainer.innerHTML = potentials.map((item, index) => `
            <div class="mobile-card">
              <div class="mobile-card-title">
                #${index + 1} ${item.pigeon.name || item.pigeon.ring}
                <span style="float:right;font-weight:700;color:var(--primary);">${item.score}åˆ†</span>
              </div>
              <div class="mobile-card-meta">${item.pigeon.ring} | ${item.factors.slice(0, 3).join('ã€')}</div>
            </div>
          `).join('');
        } else {
          potentialContainer.innerHTML = '<div class="mobile-empty">æš‚æ— æ•°æ®</div>';
        }
      }
      
      // ç»¼åˆç»“è®º
      const conclusionContainer = document.getElementById('analysisConclusion');
      if (conclusionContainer) {
        const totalPigeons = pigeons.length;
        const alivePigeons = pigeons.filter(p => p.alive).length;
        const totalWins = pigeons.reduce((sum, p) => {
          return sum + (p.races || []).filter(r => r.rank && r.rank <= 3).length;
        }, 0);
        
        conclusionContainer.innerHTML = `
          <div class="mobile-card-title">ğŸ“Š æ•°æ®æ¦‚å†µ</div>
          <div class="mobile-card-meta">
            ç³»ç»Ÿå…±è®°å½• ${totalPigeons} åªé¸½å­ï¼Œå…¶ä¸­ ${alivePigeons} åªåœ¨ä¸–ï¼Œè·å¾— ${totalWins} æ¬¡å‰ä¸‰åã€‚
          </div>
          ${bloodlines.length > 0 ? `
            <div class="mobile-card-title" style="margin-top:12px;">ğŸ§¬ è¡€ç³»åˆ†æ</div>
            <div class="mobile-card-meta">
              ${bloodlines[0].ancestor.name || bloodlines[0].ancestor.ring} è¡€ç³»è¡¨ç°æœ€ä¸ºçªå‡ºï¼Œå·²äº§å‡º ${bloodlines[0].descendants.length} åªåä»£ï¼Œç´¯è®¡è·å¥– ${bloodlines[0].wins} æ¬¡ã€‚
            </div>
          ` : ''}
          <div class="mobile-card-title" style="margin-top:12px;">ğŸ“‹ åç»­å»ºè®®</div>
          <div class="mobile-card-meta">
            â€¢ å®šæœŸæ›´æ–°é¸½å­çš„æ¯”èµ›æˆç»©ï¼Œä¿æŒæ•°æ®å‡†ç¡®æ€§<br>
            â€¢ å…³æ³¨é«˜æ½œåŠ›é¸½å­çš„è®­ç»ƒå’Œå‚èµ›å®‰æ’<br>
            â€¢ æ ¹æ®é…å¯¹è¯„ä¼°ç»“æœä¼˜åŒ–ç¹è‚²è®¡åˆ’<br>
            â€¢ æŒç»­è¿½è¸ªä¼˜ç§€è¡€ç³»çš„åä»£è¡¨ç°
          </div>
        `;
      }
    }
    
    // åˆå§‹åŒ–æ™ºèƒ½åˆ†æ
    function initAnalysis() {
      // å¯ä»¥åœ¨è¿™é‡Œé¢„åŠ è½½æ•°æ®
    }

    // ========================================
    // ğŸ¯ èƒ½åŠ›ç»¼åˆåˆ†æåŠŸèƒ½
    // ========================================
    
    const QUALIFICATION_STORAGE_KEY = 'pigeon_qualification_records_v1';
    let qualificationRecords = [];
    
    function loadQualificationRecords() {
      try {
        const raw = localStorage.getItem(QUALIFICATION_STORAGE_KEY);
        if (raw) qualificationRecords = JSON.parse(raw);
        else qualificationRecords = [];
      } catch (e) {
        console.error('åŠ è½½èƒ½åŠ›åˆ†æè®°å½•å¤±è´¥:', e);
        qualificationRecords = [];
      }
    }
    
    function saveQualificationRecords() {
      try {
        localStorage.setItem(QUALIFICATION_STORAGE_KEY, JSON.stringify(qualificationRecords));
      } catch (e) {
        console.error('ä¿å­˜èƒ½åŠ›åˆ†æè®°å½•å¤±è´¥:', e);
      }
    }
    
    // åˆ†æè®­ç»ƒæ•°æ®
    function analyzeTrainingForRaceMobile(trainingRecords, raceDistance) {
      if (!trainingRecords || trainingRecords.length === 0) {
        return {
          score: 0,
          level: 'insufficient',
          message: 'è®­ç»ƒæ•°æ®ä¸è¶³',
          details: []
        };
      }
      
      const recentTrainings = trainingRecords.slice(0, 10);
      const avgDistance = recentTrainings.reduce((sum, t) => sum + (t.distance || 0), 0) / recentTrainings.length;
      const avgSpeed = recentTrainings.reduce((sum, t) => sum + (t.speed || 0), 0) / recentTrainings.length;
      const maxDistance = Math.max(...recentTrainings.map(t => t.distance || 0));
      
      let score = 0;
      const details = [];
      
      if (maxDistance >= raceDistance * 0.8) {
        score += 40;
        details.push('âœ… æœ€å¤§è®­ç»ƒè·ç¦»è¾¾åˆ°æ¯”èµ›è·ç¦»çš„80%ä»¥ä¸Š');
      } else if (maxDistance >= raceDistance * 0.6) {
        score += 30;
        details.push('ğŸ‘ æœ€å¤§è®­ç»ƒè·ç¦»è¾¾åˆ°æ¯”èµ›è·ç¦»çš„60%ä»¥ä¸Š');
      } else if (maxDistance >= raceDistance * 0.4) {
        score += 20;
        details.push('âš ï¸ æœ€å¤§è®­ç»ƒè·ç¦»ä»…è¾¾åˆ°æ¯”èµ›è·ç¦»çš„40%');
      } else {
        details.push('âŒ æœ€å¤§è®­ç»ƒè·ç¦»ä¸è¶³æ¯”èµ›è·ç¦»çš„40%');
      }
      
      if (avgDistance >= raceDistance * 0.5) {
        score += 30;
        details.push('âœ… å¹³å‡è®­ç»ƒè·ç¦»è¾¾åˆ°æ¯”èµ›è·ç¦»çš„50%ä»¥ä¸Š');
      } else if (avgDistance >= raceDistance * 0.3) {
        score += 20;
        details.push('ğŸ‘ å¹³å‡è®­ç»ƒè·ç¦»è¾¾åˆ°æ¯”èµ›è·ç¦»çš„30%ä»¥ä¸Š');
      }
      
      if (avgSpeed >= 60) {
        score += 30;
        details.push('âœ… å¹³å‡é€Ÿåº¦è¾¾åˆ°60km/hä»¥ä¸Š');
      } else if (avgSpeed >= 50) {
        score += 20;
        details.push('ğŸ‘ å¹³å‡é€Ÿåº¦è¾¾åˆ°50km/hä»¥ä¸Š');
      }
      
      let level = 'insufficient';
      if (score >= 80) level = 'excellent';
      else if (score >= 60) level = 'good';
      else if (score >= 40) level = 'fair';
      
      return {
        score: Math.min(100, score),
        level,
        message: score >= 60 ? 'è®­ç»ƒæ•°æ®è‰¯å¥½' : score >= 40 ? 'è®­ç»ƒæ•°æ®ä¸€èˆ¬' : 'è®­ç»ƒæ•°æ®ä¸è¶³',
        details
      };
    }
    
    // åˆ†ææ¯”èµ›å†å²
    function analyzeRaceHistoryMobile(races, raceDistance) {
      if (!races || races.length === 0) {
        return {
          score: 0,
          level: 'insufficient',
          message: 'æ— æ¯”èµ›è®°å½•',
          details: []
        };
      }
      
      const similarDistanceRaces = races.filter(r => {
        const rDistance = r.distance || raceDistance;
        return Math.abs(rDistance - raceDistance) <= raceDistance * 0.2;
      });
      
      if (similarDistanceRaces.length === 0) {
        return {
          score: 30,
          level: 'fair',
          message: 'æ— åŒè·ç¦»æ¯”èµ›è®°å½•',
          details: ['âš ï¸ æ— ç›¸ä¼¼è·ç¦»çš„æ¯”èµ›è®°å½•ï¼Œæ— æ³•å‡†ç¡®è¯„ä¼°']
        };
      }
      
      let score = 50;
      const details = [];
      
      const bestRank = similarDistanceRaces.reduce((best, r) => r.rank && r.rank < best ? r.rank : best, 999);
      const wins = similarDistanceRaces.filter(r => r.rank && r.rank <= 3).length;
      const avgRank = similarDistanceRaces.reduce((sum, r) => sum + (r.rank || 999), 0) / similarDistanceRaces.length;
      
      if (bestRank <= 3) {
        score += 30;
        details.push(`âœ… æœ€ä½³æˆç»©ç¬¬${bestRank}å`);
      } else if (bestRank <= 10) {
        score += 20;
        details.push(`ğŸ‘ æœ€ä½³æˆç»©ç¬¬${bestRank}å`);
      }
      
      if (wins >= 2) {
        score += 20;
        details.push(`âœ… æœ‰${wins}æ¬¡å‰3åæˆç»©`);
      } else if (wins >= 1) {
        score += 10;
        details.push(`ğŸ‘ æœ‰${wins}æ¬¡å‰3åæˆç»©`);
      }
      
      let level = 'insufficient';
      if (score >= 80) level = 'excellent';
      else if (score >= 60) level = 'good';
      else if (score >= 40) level = 'fair';
      
      return {
        score: Math.min(100, score),
        level,
        message: score >= 60 ? 'å†å²æ¯”èµ›è¡¨ç°ä¼˜ç§€' : score >= 40 ? 'å†å²æ¯”èµ›è¡¨ç°è‰¯å¥½' : 'å†å²æ¯”èµ›è¡¨ç°ä¸€èˆ¬',
        details,
        bestRank,
        avgRank: avgRank.toFixed(1),
        wins,
        raceCount: similarDistanceRaces.length
      };
    }
    
    // ç»¼åˆåˆ†æå¹¶è®¡ç®—é€‚åˆå‚èµ›åº¦
    function analyzeQualificationMobile() {
      const pigeonId = document.getElementById('qualificationPigeonSelect')?.value;
      const raceDistance = parseFloat(document.getElementById('qualificationDistance')?.value);
      
      if (!pigeonId) {
        alert('è¯·é€‰æ‹©é¸½å­');
        return;
      }
      if (!raceDistance || raceDistance <= 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ¯”èµ›è·ç¦»');
        return;
      }
      
      const pigeon = getPigeonById(pigeonId);
      if (!pigeon) {
        alert('æœªæ‰¾åˆ°é€‰ä¸­çš„é¸½å­ï¼');
        return;
      }
      
      loadTrainingRecords();
      const pigeonTrainings = trainingRecords.filter(t => t.pigeonId === pigeonId);
      
      const pigeonRaces = [];
      const pigeons = loadPigeons();
      pigeons.forEach(p => {
        if (p.id === pigeonId && p.races && Array.isArray(p.races)) {
          pigeonRaces.push(...p.races.map(r => ({
            ...r,
            distance: raceDistance
          })));
        }
      });
      
      const trainingAnalysis = analyzeTrainingForRaceMobile(pigeonTrainings, raceDistance);
      const raceAnalysis = analyzeRaceHistoryMobile(pigeonRaces, raceDistance);
      
      const totalScore = (trainingAnalysis.score * 0.6) + (raceAnalysis.score * 0.4);
      
      let qualificationLevel = 'not_qualified';
      let qualificationPercent = 0;
      let recommendation = '';
      
      if (totalScore >= 75) {
        qualificationLevel = 'highly_qualified';
        qualificationPercent = Math.min(100, Math.round(totalScore));
        recommendation = 'å¼ºçƒˆæ¨èå‚èµ›';
      } else if (totalScore >= 60) {
        qualificationLevel = 'qualified';
        qualificationPercent = Math.min(95, Math.round(totalScore));
        recommendation = 'æ¨èå‚èµ›';
      } else if (totalScore >= 45) {
        qualificationLevel = 'conditionally_qualified';
        qualificationPercent = Math.min(85, Math.round(totalScore));
        recommendation = 'è°¨æ…å‚èµ›';
      } else {
        qualificationLevel = 'not_qualified';
        qualificationPercent = Math.max(0, Math.round(totalScore));
        recommendation = 'ä¸å»ºè®®å‚èµ›';
      }
      
      const analysis = {
        id: 'qual_' + Date.now(),
        pigeonId,
        pigeonRing: pigeon.ring,
        pigeonName: pigeon.name,
        raceDistance,
        totalScore: totalScore.toFixed(1),
        qualificationPercent,
        qualificationLevel,
        recommendation,
        trainingAnalysis,
        raceAnalysis,
        conclusion: `${pigeon.name || pigeon.ring} é€‚åˆ${raceDistance}å…¬é‡Œæ¯”èµ›çš„èƒ½åŠ›ä¸º ${qualificationPercent}%ï¼Œ${recommendation}ã€‚è®­ç»ƒæ•°æ®è¯„åˆ†${trainingAnalysis.score}åˆ†ï¼Œå†å²æ¯”èµ›è¯„åˆ†${raceAnalysis.score}åˆ†ã€‚`,
        analysisDate: new Date().toISOString()
      };
      
      qualificationRecords.push(analysis);
      saveQualificationRecords();
      
      displayQualificationResultMobile(analysis);
      renderQualificationRecordsMobile();
    }
    
    // æ˜¾ç¤ºåˆ†æç»“æœ
    function displayQualificationResultMobile(analysis) {
      const resultDiv = document.getElementById('qualificationResult');
      const contentDiv = document.getElementById('qualificationResultContent');
      
      if (!resultDiv || !contentDiv) return;
      
      resultDiv.style.display = 'block';
      
      const percentColor = analysis.qualificationPercent >= 75 ? '#10b981' : 
                          analysis.qualificationPercent >= 60 ? '#3b82f6' : 
                          analysis.qualificationPercent >= 45 ? '#f59e0b' : '#ef4444';
      
      contentDiv.innerHTML = `
        <div style="text-align:center;margin-bottom:20px;">
          <div style="font-size:48px;font-weight:700;color:${percentColor};line-height:1;">
            ${analysis.qualificationPercent}%
          </div>
          <div style="font-size:14px;color:var(--text-secondary);margin-top:4px;">é€‚åˆå‚èµ›åº¦</div>
          <div style="font-size:16px;color:${percentColor};font-weight:600;margin-top:8px;">${analysis.recommendation}</div>
        </div>
        
        <div style="margin-bottom:16px;padding:12px;background:var(--bg-primary);border-radius:8px;">
          <div style="font-weight:600;margin-bottom:8px;">ğŸƒ è®­ç»ƒæ•°æ®åˆ†æ</div>
          <div style="font-size:13px;color:var(--text-secondary);">
            è¯„åˆ†ï¼š${analysis.trainingAnalysis.score}åˆ† | ${analysis.trainingAnalysis.message}
          </div>
          <ul style="margin:8px 0;padding-left:20px;font-size:12px;">
            ${analysis.trainingAnalysis.details.map(d => `<li style="margin:4px 0;">${d}</li>`).join('')}
          </ul>
        </div>
        
        <div style="margin-bottom:16px;padding:12px;background:var(--bg-primary);border-radius:8px;">
          <div style="font-weight:600;margin-bottom:8px;">ğŸ† å†å²æ¯”èµ›åˆ†æ</div>
          <div style="font-size:13px;color:var(--text-secondary);">
            è¯„åˆ†ï¼š${analysis.raceAnalysis.score}åˆ† | ${analysis.raceAnalysis.message}
          </div>
          ${analysis.raceAnalysis.details.length > 0 ? `
            <ul style="margin:8px 0;padding-left:20px;font-size:12px;">
              ${analysis.raceAnalysis.details.map(d => `<li style="margin:4px 0;">${d}</li>`).join('')}
            </ul>
          ` : ''}
        </div>
        
        <div style="padding:12px;background:#ecfdf5;border-radius:8px;border:2px solid #10b981;">
          <div style="font-weight:600;margin-bottom:8px;">ğŸ“Š ç»¼åˆåˆ†æç»“è®º</div>
          <div style="font-size:13px;line-height:1.8;">${analysis.conclusion}</div>
        </div>
      `;
    }
    
    // æ¸²æŸ“èƒ½åŠ›åˆ†æè®°å½•
    function renderQualificationRecordsMobile() {
      const container = document.getElementById('qualificationRecordsList');
      if (!container) return;
      
      loadQualificationRecords();
      
      if (qualificationRecords.length === 0) {
        container.innerHTML = '<div class="mobile-empty">æš‚æ— åˆ†æè®°å½•</div>';
        return;
      }
      
      const sortedRecords = [...qualificationRecords].sort((a, b) => 
        parseFloat(b.qualificationPercent) - parseFloat(a.qualificationPercent)
      );
      
      container.innerHTML = sortedRecords.map((record, index) => {
        const percentColor = record.qualificationPercent >= 75 ? '#10b981' : 
                            record.qualificationPercent >= 60 ? '#3b82f6' : 
                            record.qualificationPercent >= 45 ? '#f59e0b' : '#ef4444';
        
        return `
          <div class="mobile-card">
            <div class="mobile-card-title">
              #${index + 1} ${record.pigeonName || record.pigeonRing}
              <span style="float:right;font-weight:700;color:${percentColor};font-size:18px;">${record.qualificationPercent}%</span>
            </div>
            <div class="mobile-card-meta">
              ${record.raceDistance}km | ${record.recommendation} | ${new Date(record.analysisDate).toLocaleDateString('zh-CN')}
            </div>
          </div>
        `;
      }).join('');
    }
    
    // å¡«å……èƒ½åŠ›åˆ†æé¸½å­é€‰æ‹©
    function fillQualificationPigeonSelect() {
      const select = document.getElementById('qualificationPigeonSelect');
      if (!select) return;
      
      select.innerHTML = '<option value="">é€‰æ‹©é¸½å­...</option>';
      const pigeons = loadPigeons();
      pigeons.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.ring}${p.name ? ' - ' + p.name : ''}`;
        select.appendChild(opt);
      });
    }
    
    // åˆå§‹åŒ–èƒ½åŠ›ç»¼åˆåˆ†æ
    function initQualification() {
      loadQualificationRecords();
      fillQualificationPigeonSelect();
      renderQualificationRecordsMobile();
    }

    // ========================================
    // ğŸ“Š æ•°æ®æ¦‚è§ˆåŠŸèƒ½
    // ========================================
    
    // æ¸²æŸ“æ•°æ®æ¦‚è§ˆ
    function renderDashboard() {
      const pigeons = loadPigeons();
      const total = pigeons.length;
      const alive = pigeons.filter(p => p.alive).length;
      const raced = pigeons.filter(p => p.races && p.races.length > 0).length;
      const core = pigeons.filter(p => p.isCore).length;
      
      document.getElementById('dashboardTotalPigeons').textContent = total;
      document.getElementById('dashboardAlivePigeons').textContent = alive;
      document.getElementById('dashboardRacedPigeons').textContent = raced;
      document.getElementById('dashboardCorePigeons').textContent = core;
      
      // æœ€è¿‘æ´»åŠ¨
      const container = document.getElementById('dashboardRecentActivity');
      if (container) {
        const activities = [];
        
        // æœ€è¿‘æ·»åŠ çš„é¸½å­
        pigeons.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0)).slice(0, 5).forEach(p => {
          activities.push({
            type: 'æ–°å¢',
            text: `æ–°å¢é¸½å­ï¼š${p.name || p.ring}`,
            date: p.createdAt || new Date().toISOString()
          });
        });
        
        // æœ€è¿‘çš„æ¯”èµ›
        const races = loadRaces();
        races.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5).forEach(r => {
          activities.push({
            type: 'æ¯”èµ›',
            text: `æ¯”èµ›ï¼š${r.name}`,
            date: r.date
          });
        });
        
        activities.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
        
        if (activities.length === 0) {
          container.innerHTML = '<div class="mobile-empty">æš‚æ— æ´»åŠ¨è®°å½•</div>';
        } else {
          container.innerHTML = activities.map(act => `
            <div class="mobile-card">
              <div class="mobile-card-title">${act.type}: ${act.text}</div>
              <div class="mobile-card-meta">${new Date(act.date).toLocaleDateString('zh-CN')}</div>
            </div>
          `).join('');
        }
      }
    }
    
    // åˆå§‹åŒ–æ•°æ®æ¦‚è§ˆ
    function initDashboard() {
      renderDashboard();
    }

    // é¦–é¡µè‡ªåŠ¨å°ç»“å’Œæé†’
    function initHomeAutoSummary() {
      const summaryEl = document.getElementById('mobileAutoSummaryText');
      const todoEl = document.getElementById('mobileAutoTodoHint');
      if (!summaryEl || !todoEl) return;
      
      try {
        const pigeons = loadPigeons() || [];
        const races = loadRaces() || [];
        const today = new Date();
        const in7Days = new Date();
        in7Days.setDate(today.getDate() + 7);

        // ç¡®ä¿pigeonså’Œracesæ˜¯æ•°ç»„
        if (!Array.isArray(pigeons) || !Array.isArray(races)) {
          throw new Error('æ•°æ®æ ¼å¼é”™è¯¯ï¼špigeonsæˆ–racesä¸æ˜¯æ•°ç»„');
        }

        const alive = pigeons.filter(p => p.status !== 'dead' && p.status !== 'å·²æ­»äº¡').length;
        const breeders = pigeons.filter(p => p.type === 'ç§é¸½' || (p.tags && p.tags.includes('æ ¸å¿ƒç§é¸½'))).length;

        const upcomingRaces = races.filter(r => {
          const d = new Date(r.date || r.raceDate || r.startDate);
          return d >= today && d <= in7Days;
        });
        const recentTrainings = (window.loadTrainingRecords ? window.loadTrainingRecords() : []).filter(t => {
          const d = new Date(t.date || t.trainingDate);
          return (today - d) / (1000 * 60 * 60 * 24) <= 7;
        });

        // è‡ªåŠ¨å°ç»“
        if (upcomingRaces.length > 0) {
          const nextRace = upcomingRaces.sort((a, b) => new Date(a.date || a.raceDate) - new Date(b.date || b.raceDate))[0];
          const d = new Date(nextRace.date || nextRace.raceDate);
          const diffDays = Math.round((d - today) / (1000 * 60 * 60 * 24));
          summaryEl.textContent = `æœ¬å‘¨æœ‰ ${upcomingRaces.length} åœºæ¯”èµ›å³å°†å¼€å§‹ï¼Œæœ€è¿‘ä¸€åœºåœ¨ ${d.toLocaleDateString('zh-CN')}ï¼ˆçº¦ ${diffDays} å¤©åï¼‰ã€‚ç›®å‰åœ¨æ£šé¸½å­ ${alive} åªï¼Œå…¶ä¸­æ ¸å¿ƒç§é¸½ ${breeders} åªã€‚`;
        } else if (alive > 0) {
          summaryEl.textContent = `å½“å‰åœ¨æ£šå…±æœ‰ ${alive} åªé¸½å­ï¼Œå…¶ä¸­æ ¸å¿ƒç§é¸½ ${breeders} åªã€‚æœ¬å‘¨æš‚æ— å³å°†å¼€å§‹çš„æ¯”èµ›ï¼Œå¯ä»¥ä¸“æ³¨å¥åº·å’Œè®­ç»ƒç§¯ç´¯ã€‚`;
        } else {
          summaryEl.textContent = 'æš‚æœªæ£€æµ‹åˆ°é¸½å­æ•°æ®ï¼Œä½ å¯ä»¥ä»â€œæ–°å¢é¸½å­â€å¼€å§‹å»ºç«‹è‡ªå·±çš„é¸½èˆæ¡£æ¡ˆã€‚';
        }

        // å¾…åŠæé†’
        const hints = [];
        if (upcomingRaces.length > 0 && recentTrainings.length === 0) {
          hints.push('å»ºè®®åœ¨æ¯”èµ›å‰å®‰æ’ 1â€“2 æ¬¡å†²åˆºè®­ç»ƒã€‚');
        }
        if (alive > 0 && pigeons.some(p => p.healthReminders && p.healthReminders.length > 0)) {
          hints.push('æœ‰é¸½å­çš„å¥åº·æé†’å³å°†åˆ°æœŸï¼Œå»ºè®®åœ¨â€œå¥åº·ç®¡ç†â€ä¸­æ£€æŸ¥ã€‚');
        }

        if (hints.length > 0) {
          todoEl.textContent = hints.join(' ');
        } else {
          todoEl.textContent = 'æš‚æ— ç´§æ€¥å¾…åŠï¼Œå¯ç»§ç»­ä¼˜åŒ–ç¹è‚²è®¡åˆ’æˆ–æŸ¥çœ‹æ™ºèƒ½åˆ†ææŠ¥å‘Šã€‚';
        }
      } catch (e) {
        console.warn('initHomeAutoSummary failed', e);
        summaryEl.textContent = 'æš‚æ—¶æ— æ³•ç”Ÿæˆè‡ªåŠ¨å°ç»“ï¼Œä½†ä¸å½±å“æ­£å¸¸ä½¿ç”¨ã€‚';
        todoEl.textContent = 'ä½ å¯ä»¥å…ˆä»â€œé¸½å­ç®¡ç†â€å’Œâ€œæ¯”èµ›ç®¡ç†â€å¼€å§‹å½•å…¥æ•°æ®ã€‚';
      }
    }

    // ========================================
    // âš™ï¸ ç³»ç»Ÿè®¾ç½®åŠŸèƒ½
    // ========================================
    
    // è¿™ä¸ªå‡½æ•°å·²è¢« showSettingsModal() æ›¿ä»£ï¼Œä¿ç•™ç”¨äºå‘åå…¼å®¹
    function showUserMenu() {
      showSettingsModal();
    }
    
    // æ—§å‡½æ•°ï¼Œå·²è¢«æ›¿ä»£
    function closeUserMenu() {
      closeSettingsModal();
    }
    
    
    function changeTheme(theme) {
      if (theme === 'auto') {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
      } else {
        document.documentElement.setAttribute('data-theme', theme);
      }
      localStorage.setItem('pigeon_theme_preference', theme);
    }
    
    function exportData() {
      const data = {
        pigeons: loadPigeons(),
        races: loadRaces(),
        healthRecords: healthRecords,
        trainingRecords: trainingRecords,
        pairings: pairings,
        qualificationRecords: qualificationRecords,
        exportDate: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `pigeon_data_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      alert('æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
    }
    
    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            
            if (confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
              if (data.pigeons) {
                localStorage.setItem('pigeon_manager_data_v1', JSON.stringify(data.pigeons));
              }
              if (data.races) {
                localStorage.setItem('pigeon_races_v1', JSON.stringify(data.races));
              }
              if (data.healthRecords) {
                localStorage.setItem(HEALTH_RECORDS_KEY, JSON.stringify(data.healthRecords));
                healthRecords = data.healthRecords;
              }
              if (data.trainingRecords) {
                localStorage.setItem(TRAINING_STORAGE_KEY, JSON.stringify(data.trainingRecords));
                trainingRecords = data.trainingRecords;
              }
              if (data.pairings) {
                localStorage.setItem(PAIRING_RECORDS_KEY, JSON.stringify(data.pairings));
                pairings = data.pairings;
              }
              if (data.qualificationRecords) {
                localStorage.setItem(QUALIFICATION_STORAGE_KEY, JSON.stringify(data.qualificationRecords));
                qualificationRecords = data.qualificationRecords;
              }
              
              alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ã€‚');
              location.reload();
            }
          } catch (error) {
            alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }
    
    // åŠ è½½æ¯”èµ›æ•°æ®
    function loadRaces() {
      try {
        const STORAGE_KEY = 'pigeon_races_v1';
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          return JSON.parse(raw);
        }
      } catch (e) {
        console.error('åŠ è½½æ¯”èµ›æ•°æ®å¤±è´¥:', e);
      }
      return [];
    }

    // å½“åˆ‡æ¢åˆ°ä¸åŒè§†å›¾æ—¶åˆå§‹åŒ–
    const originalSwitchView = window.switchView;
    if (originalSwitchView) {
      window.switchView = function(viewName) {
        originalSwitchView(viewName);
        if (viewName === 'breeding') {
          setTimeout(initBreeding, 100);
        } else if (viewName === 'health') {
          setTimeout(initHealth, 100);
        } else if (viewName === 'training') {
          setTimeout(initTraining, 100);
        } else if (viewName === 'analysis') {
          setTimeout(initAnalysis, 100);
        } else if (viewName === 'qualification') {
          setTimeout(initQualification, 100);
        } else if (viewName === 'dashboard') {
          setTimeout(initDashboard, 100);
        }
      };
    }
    // ========================================
    // ğŸ•Šï¸ Evo æ™ºèƒ½åŠ©æ‰‹åŠŸèƒ½ï¼ˆPCç«¯å®Œæ•´åŠŸèƒ½å¤åˆ»ï¼‰
    // ========================================
    
    const MobileEvoAssistant = (function() {
      // å­˜å‚¨é”®ï¼ˆä½¿ç”¨ä¸PCç«¯ç›¸åŒçš„é”®ï¼Œç¡®ä¿æ•°æ®åŒæ­¥ï¼‰
      const CHAT_HISTORY_KEY = 'evo_chat_history';
      const SETTINGS_KEY = 'evo_settings';
      const GREETING_STORAGE_KEY = 'evo_has_greeted';
      const GREETING_SESSION_KEY = 'evo_greeting_session';
      const USED_GREETINGS_KEY = 'evo_used_greetings';
      
      // æ¬¢è¿æ¶ˆæ¯åç¼€é€‰é¡¹
      const GREETING_SUFFIXES = [
        'åˆ†ææ•°æ®',
        'æŸ¥çœ‹è¡€ç»Ÿå…³ç³»',
        'ç»Ÿè®¡æ¯”èµ›æˆç»©',
        'ç®¡ç†é¸½å­ä¿¡æ¯',
        'åˆ†æè®­ç»ƒè®°å½•',
        'æŸ¥çœ‹èƒ½åŠ›è¯„ä¼°',
        'è§„åˆ’ç¹è‚²é…å¯¹',
        'ç®¡ç†å¥åº·æ¡£æ¡ˆ',
        'ç”Ÿæˆæ•°æ®æŠ¥è¡¨',
        'ä¼˜åŒ–è®­ç»ƒè®¡åˆ’',
        'åˆ†æèµ›äº‹è¡¨ç°',
        'è¿½è¸ªè¡€ç»Ÿå›¾è°±',
        'è¯„ä¼°ç«ç¿”èƒ½åŠ›',
        'åˆ¶å®šç¹è‚²ç­–ç•¥',
        'ç›‘æ§å¥åº·çŠ¶æ€'
      ];
      
      // çŠ¶æ€
      let isExpanded = false;
      let activeTab = 'chat';
      let messages = [];
      let isTyping = false;
      let autoCloseTimer = null;
      let userInteractionTimer = null;
      let hasShownGreetingThisPageLoad = false;
      const AUTO_CLOSE_DELAY = 5000; // æœªäº¤äº’æ—¶5ç§’åå…³é—­
      const USER_INACTIVITY_DELAY = 8000; // ç”¨æˆ·åœ¨å¯¹è¯æ¡†å†…æ— æ“ä½œ8ç§’åå…³é—­
      
      // DOM å…ƒç´ 
      let assistantEl, iconButton, dialog, messagesContainer, inputField, sendBtn;
      
      // Evoè®¾ç½®ï¼ˆå…¨å±€ï¼Œä¾›chatå‡½æ•°ä½¿ç”¨ï¼‰
      let evoSettings = {
        enabled: true,
        showWelcome: true,
        saveHistory: true,
        autoClose: 5,
        functionGuides: {}
      };
      
      // åˆå§‹åŒ–
      function init() {
        try {
          createHTML();
          bindEvents();
          loadSettings();
          
          // ç«‹å³ç¡®ä¿å›¾æ ‡å¯è§
          ensureIconVisible();
          
          // å»¶è¿Ÿå†æ¬¡ç¡®ä¿ï¼ˆç¡®ä¿DOMå®Œå…¨æ¸²æŸ“ï¼‰
          setTimeout(() => {
            ensureIconVisible();
          }, 100);
          
          setTimeout(() => {
            ensureIconVisible();
          }, 500);
          
          // å¯åŠ¨å®šæœŸæ£€æŸ¥æœºåˆ¶ï¼Œç¡®ä¿å›¾æ ‡å§‹ç»ˆå¯è§
          startIconMonitor();
          
          // å»¶è¿Ÿæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯ï¼ˆç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½å·²åˆå§‹åŒ–ï¼‰
          hasShownGreetingThisPageLoad = false;
          console.log('ğŸ”„ [åˆå§‹åŒ–] é‡ç½® hasShownGreetingThisPageLoad = false');
          
          // å¼ºåˆ¶æ˜¾ç¤ºå‡½æ•°
          const forceShowGreeting = () => {
            if (!document.body) {
              console.warn('âš ï¸ document.body ä¸å­˜åœ¨');
              return false;
            }
            
            const existingBubble = document.getElementById('mobileEvoWelcomeBubble');
            if (existingBubble) {
              console.log('â„¹ï¸ æ°”æ³¡å·²å­˜åœ¨ï¼Œè·³è¿‡');
              return true;
            }
            
            console.log('âœ… [å¼ºåˆ¶æ˜¾ç¤º] å‡†å¤‡è°ƒç”¨ showWelcomeGreeting');
            hasShownGreetingThisPageLoad = false;
            showWelcomeGreeting();
            return true;
          };
          
          // å»¶è¿Ÿ1.5ç§’åç¬¬ä¸€æ¬¡å°è¯•
          setTimeout(() => {
            console.log('ğŸ” [å»¶è¿Ÿ1.5s] ç¬¬ä¸€æ¬¡å°è¯•æ˜¾ç¤º');
            forceShowGreeting();
          }, 1500);
          
          // å»¶è¿Ÿ3ç§’åç¬¬äºŒæ¬¡å°è¯•
          setTimeout(() => {
            console.log('ğŸ” [å»¶è¿Ÿ3s] ç¬¬äºŒæ¬¡å°è¯•æ˜¾ç¤º');
            const existingBubble = document.getElementById('mobileEvoWelcomeBubble');
            if (!existingBubble) {
              forceShowGreeting();
            }
          }, 3000);
          
          // å»¶è¿Ÿ5ç§’åæœ€åä¸€æ¬¡å°è¯•
          setTimeout(() => {
            console.log('ğŸ” [å»¶è¿Ÿ5s] æœ€åä¸€æ¬¡å¼ºåˆ¶æ˜¾ç¤º');
            const existingBubble = document.getElementById('mobileEvoWelcomeBubble');
            if (!existingBubble) {
              hasShownGreetingThisPageLoad = false;
              showWelcomeGreeting();
            }
          }, 5000);
        } catch (error) {
          console.error('Evoåˆå§‹åŒ–é”™è¯¯:', error);
          setTimeout(() => {
            ensureIconVisible();
          }, 1000);
        }
      }

      // æš´éœ²ç»™å¤–éƒ¨æ¨¡å—çš„å¿«æ·è°ƒç”¨ï¼šè®©EvoåŸºäºå½“å‰æ•°æ®è¿›è¡Œä¸“é¡¹åˆ†æ
      window.askEvoWithContext = async function(module, extraQuestion = '') {
        try {
          isExpanded = true;
          if (!dialog) {
            dialog = document.getElementById('mobileEvoDialog');
          }
          if (dialog) {
            dialog.style.display = 'flex';
            activeTab = 'chat';
            switchTab('chat');
          }
          const baseQuestionMap = {
            races: 'è¯·æ ¹æ®å½“å‰æ‰€æœ‰æ¯”èµ›å’Œæˆç»©æ•°æ®ï¼Œå¸®æˆ‘åˆ†ææ•´ä½“å‚èµ›è¡¨ç°ï¼ŒæŒ‡å‡ºè¡¨ç°æœ€ç¨³å®šçš„é¸½å­å’Œéœ€è¦é‡ç‚¹æ”¹è¿›çš„åœ°æ–¹ã€‚',
            training: 'è¯·æ ¹æ®å½“å‰è®­ç»ƒè®°å½•ï¼Œå¸®æˆ‘åˆ†ææ€»ä½“è®­ç»ƒé‡å’Œå¼ºåº¦ï¼Œç»™å‡ºä¸‹ä¸€é˜¶æ®µçš„è®­ç»ƒå»ºè®®ã€‚',
            health: 'è¯·æ ¹æ®å¥åº·è®°å½•å’Œæé†’ï¼Œå¸®æˆ‘åˆ†æå“ªäº›é¸½å­éœ€è¦é‡ç‚¹å…³æ³¨å¥åº·é£é™©ï¼Œå¹¶ç»™å‡ºä¿å…»å»ºè®®ã€‚',
            breeding: 'è¯·æ ¹æ®è¡€ç»Ÿå’Œé…å¯¹è®°å½•ï¼Œå¸®æˆ‘åˆ†æå½“å‰ç¹è‚²ç­–ç•¥çš„ä¼˜ç¼ºç‚¹ï¼Œå¹¶æ¨èå‡ ç§æ›´ä¼˜çš„é…å¯¹æ€è·¯ã€‚',
            qualification: 'è¯·æ ¹æ®èƒ½åŠ›åˆ†æä¸æ¯”èµ›è¡¨ç°ï¼Œå¸®æˆ‘ç­›é€‰é€‚åˆå‚åŠ ä¸‹ä¸€åœºå…³é”®æ¯”èµ›çš„é¸½å­ï¼Œå¹¶è¯´æ˜ç†ç”±ã€‚',
            analysis: 'è¯·åŸºäºå½“å‰æ‰€æœ‰æ•°æ®ï¼Œç»™å‡ºä¸€ä»½æ•´ä½“è¿è¥å»ºè®®ï¼ŒåŒ…æ‹¬ç¹è‚²ã€è®­ç»ƒã€å‚èµ›å’Œå¥åº·æ–¹é¢ã€‚'
          };
          const baseQuestion = baseQuestionMap[module] || 'è¯·ç»“åˆå½“å‰ç³»ç»Ÿä¸­æ‰€æœ‰å·²å½•å…¥çš„æ•°æ®ï¼Œç»™å‡ºä¸€ä»½ç»¼åˆåˆ†æå’Œå»ºè®®ã€‚';
          const finalQuestion = extraQuestion ? `${baseQuestion}\n\nè¡¥å……éœ€æ±‚ï¼š${extraQuestion}` : baseQuestion;
          if (inputField) {
            inputField.value = finalQuestion;
          }
          await sendMessage();
        } catch (e) {
          console.error('askEvoWithContext è°ƒç”¨å¤±è´¥:', e);
          alert('æš‚æ—¶æ— æ³•å‘¼å« Evo æ™ºèƒ½åˆ†æï¼Œè¯·ç¨åå†è¯•ã€‚');
        }
      };
      
      // ç¡®ä¿å›¾æ ‡å¯è§çš„å‡½æ•°
      function ensureIconVisible() {
        try {
          let assistant = document.getElementById('mobileEvoAssistant');
          let icon = document.getElementById('mobileEvoIconButton');
          
          // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œé‡æ–°åˆ›å»º
          if (!assistant) {
            console.warn('EvoåŠ©æ‰‹å…ƒç´ ä¸¢å¤±ï¼Œæ­£åœ¨é‡æ–°åˆ›å»º...');
            try {
              createHTML();
              assistantEl = document.getElementById('mobileEvoAssistant');
              iconButton = document.getElementById('mobileEvoIconButton');
              assistant = assistantEl;
              icon = iconButton;
              if (assistant && icon) {
                bindEvents();
                console.log('âœ… EvoåŠ©æ‰‹å…ƒç´ å·²é‡æ–°åˆ›å»º');
              }
            } catch (error) {
              console.error('é‡æ–°åˆ›å»ºEvoåŠ©æ‰‹å¤±è´¥:', error);
            }
          }
          
          if (assistant) {
            assistant.style.cssText = `
              position: fixed !important;
              bottom: 30vh !important;
              right: 16px !important;
              z-index: 99999 !important;
              display: block !important;
              visibility: visible !important;
              opacity: 1 !important;
              pointer-events: none !important;
            `;
            assistantEl = assistant;
          }
          
          if (icon) {
            icon.style.cssText = `
              display: flex !important;
              visibility: visible !important;
              opacity: 1 !important;
              pointer-events: auto !important;
            `;
            iconButton = icon;
          }
        } catch (error) {
          console.error('ensureIconVisibleé”™è¯¯:', error);
        }
      }
      
      // å›¾æ ‡ç›‘æ§å®šæ—¶å™¨IDï¼ˆç”¨äºæ¸…ç†ï¼‰
      let iconMonitorTimer = null;
      
      // å¯åŠ¨å›¾æ ‡ç›‘æ§
      function startIconMonitor() {
        // å…ˆæ¸…ç†æ—§çš„å®šæ—¶å™¨
        if (iconMonitorTimer) {
          clearInterval(iconMonitorTimer);
        }
        
        iconMonitorTimer = setInterval(() => {
          const assistant = document.getElementById('mobileEvoAssistant');
          const icon = document.getElementById('mobileEvoIconButton');
          
          if (!assistant || !icon) {
            console.warn('æ£€æµ‹åˆ°Evoå›¾æ ‡ä¸¢å¤±ï¼Œæ­£åœ¨æ¢å¤...');
            ensureIconVisible();
            return;
          }
          
          const computedStyle = window.getComputedStyle(assistant);
          const isVisible = computedStyle.display !== 'none' && 
                           computedStyle.visibility !== 'hidden' && 
                           parseFloat(computedStyle.opacity) > 0;
          
          if (!isVisible) {
            console.warn('æ£€æµ‹åˆ°Evoå›¾æ ‡è¢«éšè—ï¼Œæ­£åœ¨æ¢å¤...');
            ensureIconVisible();
          }
        }, 3000);
        
        // ç›‘å¬DOMå˜åŒ–
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            mutation.removedNodes.forEach((node) => {
              if (node.id === 'mobileEvoAssistant' || (node.querySelector && node.querySelector('#mobileEvoAssistant'))) {
                console.warn('æ£€æµ‹åˆ°EvoåŠ©æ‰‹è¢«ç§»é™¤ï¼Œæ­£åœ¨æ¢å¤...');
                setTimeout(() => {
                  ensureIconVisible();
                }, 100);
              }
            });
          });
        });
        
        if (document.body) {
          observer.observe(document.body, {
            childList: true,
            subtree: true
          });
        }
      }
      
      // åˆ›å»ºHTMLç»“æ„ï¼ˆåŒ…å«4ä¸ªæ ‡ç­¾é¡µï¼‰
      function createHTML() {
        const existing = document.getElementById('mobileEvoAssistant');
        if (existing) {
          existing.remove();
        }
        
        const html = `
          <div class="mobile-evo-assistant" id="mobileEvoAssistant">
            <div class="mobile-evo-icon-button" id="mobileEvoIconButton">
              <div class="mobile-evo-pigeon-icon">
                <span class="mobile-evo-icon">ğŸ•Šï¸</span>
                <div class="mobile-evo-pulse"></div>
              </div>
            </div>
            
            <div class="mobile-evo-dialog" id="mobileEvoDialog" style="display: none;">
              <div class="mobile-evo-header">
                <div class="mobile-evo-header-left">
                  <span class="mobile-evo-icon-large">ğŸ•Šï¸</span>
                  <div>
                    <h3 class="mobile-evo-title">Evo æ™ºèƒ½åŠ©æ‰‹</h3>
                    <p class="mobile-evo-subtitle" id="mobileEvoStatus">å‡†å¤‡å¥½ä¸ºæ‚¨æœåŠ¡</p>
                  </div>
                </div>
                <button class="mobile-evo-close-btn" id="mobileEvoCloseBtn">Ã—</button>
              </div>
              
              <div class="mobile-evo-content">
                <div class="mobile-evo-tabs">
                  <div class="mobile-evo-tab-headers">
                    <div class="mobile-evo-tab-header active" data-tab="chat">ğŸ’¬ å¯¹è¯</div>
                    <div class="mobile-evo-tab-header" data-tab="analytics">ğŸ“Š æ•°æ®</div>
                    <div class="mobile-evo-tab-header" data-tab="recommendations">âœ¨ æ¨è</div>
                    <div class="mobile-evo-tab-header" data-tab="settings">âš™ï¸ è®¾ç½®</div>
                  </div>
                  
                  <!-- å¯¹è¯æ ‡ç­¾ -->
                  <div class="mobile-evo-tab-content active" id="mobileTabChat">
                    <div class="mobile-evo-chat-container">
                      <div class="mobile-evo-messages" id="mobileEvoMessages"></div>
                      <div class="mobile-evo-input-area">
                        <div class="mobile-evo-input-group">
                          <input type="text" class="mobile-evo-input" id="mobileEvoInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜...">
                          <button class="mobile-evo-send-btn" id="mobileEvoSendBtn">å‘é€</button>
                        </div>
                        <div class="mobile-evo-quick-actions">
                          <button class="mobile-evo-quick-action-btn" data-action="stats">æŸ¥çœ‹ç»Ÿè®¡æ•°æ®</button>
                          <button class="mobile-evo-quick-action-btn" data-action="pedigree">åˆ†æè¡€ç»Ÿå…³ç³»</button>
                          <button class="mobile-evo-quick-action-btn" data-action="races">æ¯”èµ›è®°å½•</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- æ•°æ®åˆ†ææ ‡ç­¾ -->
                  <div class="mobile-evo-tab-content" id="mobileTabAnalytics">
                    <div class="mobile-evo-analytics" id="mobileEvoAnalytics">
                      <div class="mobile-evo-empty">æš‚æ— åˆ†ææŠ¥å‘Š</div>
                    </div>
                  </div>
                  
                  <!-- æ™ºèƒ½æ¨èæ ‡ç­¾ -->
                  <div class="mobile-evo-tab-content" id="mobileTabRecommendations">
                    <div class="mobile-evo-recommendations" id="mobileEvoRecommendations">
                      <div class="mobile-evo-empty">æš‚æ— æ¨èå†…å®¹</div>
                    </div>
                  </div>
                  
                  <!-- è®¾ç½®æ ‡ç­¾ -->
                  <div class="mobile-evo-tab-content" id="mobileTabSettings">
                    <div class="mobile-evo-settings">
                      <h4 style="margin-bottom: 15px; font-size: 14px;">ğŸ”— GitHub èŠå¤©æœºå™¨äººé…ç½®</h4>
                      <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: 500;">ä»“åº“åœ°å€</label>
                        <input type="text" id="mobileGithubRepo" placeholder="ä¾‹å¦‚: username/repo-name" 
                          style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                        <div style="font-size: 10px; color: #909399; margin-top: 4px;">æ ¼å¼ï¼šç”¨æˆ·å/ä»“åº“å</div>
                      </div>
                      <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: 500;">Token</label>
                        <input type="password" id="mobileGithubToken" placeholder="GitHub Personal Access Token" 
                          style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                        <div style="font-size: 10px; color: #909399; margin-top: 4px;">
                          <a href="https://github.com/settings/tokens" target="_blank" style="color: #409eff;">è·å– Token</a>
                        </div>
                      </div>
                      <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: 500;">APIç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="mobileGithubApiEndpoint" placeholder="ä¾‹å¦‚: https://your-app.vercel.app/api/chat" 
                          style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                        <div style="font-size: 10px; color: #909399; margin-top: 4px;">å¦‚æœNext.jsåº”ç”¨å·²éƒ¨ç½²ï¼Œå¯ç›´æ¥æŒ‡å®šAPIç«¯ç‚¹</div>
                      </div>
                      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button id="mobileBtnSaveGitHubConfig" style="flex: 1; padding: 8px; background: #409eff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ä¿å­˜é…ç½®</button>
                        <button id="mobileBtnTestGitHubBot" style="flex: 1; padding: 8px; background: #67c23a; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">æµ‹è¯•è¿æ¥</button>
                      </div>
                      <div id="mobileGithubConfigStatus" style="padding: 10px; background: #f0f9ff; border-radius: 4px; font-size: 11px; display: none;"></div>
                      
                      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e4e7ed;">
                        <h4 style="margin-bottom: 10px; font-size: 13px;">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h4>
                        <div style="font-size: 11px; color: #606266; line-height: 1.6;">
                          <p>1. é…ç½®GitHubä»“åº“åœ°å€å’ŒTokenåï¼ŒEvoå°†ä¼˜å…ˆä½¿ç”¨æ‚¨çš„GitHubèŠå¤©æœºå™¨äºº</p>
                          <p>2. å¦‚æœæ‚¨çš„Next.jsåº”ç”¨å·²éƒ¨ç½²ï¼Œå¯ç›´æ¥æŒ‡å®šAPIç«¯ç‚¹</p>
                          <p>3. å¦‚æœGitHubèŠå¤©æœºå™¨äººä¸å¯ç”¨ï¼Œå°†è‡ªåŠ¨ä½¿ç”¨æœ¬åœ°é€»è¾‘</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', html);
        
        // è·å–DOMå…ƒç´ 
        assistantEl = document.getElementById('mobileEvoAssistant');
        iconButton = document.getElementById('mobileEvoIconButton');
        dialog = document.getElementById('mobileEvoDialog');
        messagesContainer = document.getElementById('mobileEvoMessages');
        inputField = document.getElementById('mobileEvoInput');
        sendBtn = document.getElementById('mobileEvoSendBtn');
        
        // ç¡®ä¿å›¾æ ‡æŒ‰é’®å¯è§
        if (assistantEl) {
          assistantEl.style.cssText = `
            position: fixed !important;
            bottom: 30vh !important;
            right: 16px !important;
            z-index: 99999 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: none !important;
          `;
        }
        
        if (iconButton) {
          iconButton.style.cssText = `
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
          `;
        }
      }
      
      // ç»‘å®šäº‹ä»¶
      function bindEvents() {
        if (!iconButton) {
          console.error('Evoå›¾æ ‡æŒ‰é’®æœªæ‰¾åˆ°');
          return;
        }
        iconButton.addEventListener('click', toggleExpanded);
        const closeBtn = document.getElementById('mobileEvoCloseBtn');
        if (closeBtn) {
          closeBtn.addEventListener('click', toggleExpanded);
        }
        
        if (sendBtn) {
          sendBtn.addEventListener('click', sendMessage);
        }
        if (inputField) {
          inputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isTyping) {
              sendMessage();
            }
          });
        }
        
        // æ ‡ç­¾åˆ‡æ¢
        document.querySelectorAll('.mobile-evo-tab-header').forEach(header => {
          header.addEventListener('click', () => {
            const tab = header.dataset.tab;
            switchTab(tab);
            resetAutoCloseTimer();
          });
        });
        
        // å¿«é€Ÿæ“ä½œ
        document.querySelectorAll('.mobile-evo-quick-action-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const action = btn.dataset.action;
            handleQuickAction(action);
            resetAutoCloseTimer();
          });
        });
        
        // é‡ç½®è‡ªåŠ¨å…³é—­å®šæ—¶å™¨
        if (dialog) {
          dialog.addEventListener('click', () => {
            if (hasUserInteraction()) {
              resetAutoCloseTimer();
            }
          });
          
          if (inputField) {
            inputField.addEventListener('input', resetAutoCloseTimer);
            inputField.addEventListener('keydown', resetAutoCloseTimer);
            inputField.addEventListener('focus', resetAutoCloseTimer);
          }
        }
        
        // GitHubé…ç½®æŒ‰é’®
        const saveBtn = document.getElementById('mobileBtnSaveGitHubConfig');
        const testBtn = document.getElementById('mobileBtnTestGitHubBot');
        if (saveBtn) {
          saveBtn.addEventListener('click', saveGitHubConfig);
        }
        if (testBtn) {
          testBtn.addEventListener('click', testGitHubBot);
        }
      }
      
      // åˆ‡æ¢å±•å¼€/æ”¶èµ·
      function toggleExpanded() {
        isExpanded = !isExpanded;
        if (dialog) {
          dialog.style.display = isExpanded ? 'flex' : 'none';
        }
        
        if (isExpanded) {
          loadHistory();
          if (typeof generateRecommendations === 'function') {
            generateRecommendations();
          }
          if (!hasUserInteraction()) {
            startAutoCloseTimer();
          } else {
            startUserInactivityTimer();
          }
        } else {
          clearAutoCloseTimer();
        }
      }
      
      // åˆ‡æ¢æ ‡ç­¾
      function switchTab(tab) {
        activeTab = tab;
        
        document.querySelectorAll('.mobile-evo-tab-header').forEach(h => {
          h.classList.toggle('active', h.dataset.tab === tab);
        });
        
        document.querySelectorAll('.mobile-evo-tab-content').forEach(c => {
          const tabId = `mobileTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`;
          c.classList.toggle('active', c.id === tabId);
        });
      }
      
      // å‘é€æ¶ˆæ¯
      async function sendMessage() {
        const text = inputField?.value.trim();
        if (!text || isTyping) return;
        
        addMessage('user', text);
        inputField.value = '';
        
        clearAutoCloseTimer();
        startUserInactivityTimer();
        
        isTyping = true;
        updateStatus('æ­£åœ¨æ€è€ƒ...');
        
        try {
          const response = await chat(text);
          addMessage('evo', response.text);
          saveHistory();
        } catch (error) {
          addMessage('evo', 'æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å“åº”ï¼Œè¯·ç¨åå†è¯•ã€‚');
          console.error('Evo chat error:', error);
        } finally {
          isTyping = false;
          updateStatus('åœ¨çº¿');
          resetAutoCloseTimer();
        }
      }
      
      // GitHubé…ç½®
      const GITHUB_CONFIG_KEY = 'evo_github_config';
      let githubConfig = null;
      
      function loadGitHubConfig() {
        try {
          const config = localStorage.getItem(GITHUB_CONFIG_KEY);
          if (config) {
            githubConfig = JSON.parse(config);
          }
        } catch (error) {
          console.error('Failed to load GitHub config:', error);
        }
      }
      
      function isGitHubConfigured() {
        return githubConfig && githubConfig.repo && githubConfig.token;
      }
      
      function saveGitHubConfig() {
        const repo = document.getElementById('mobileGithubRepo')?.value.trim();
        const token = document.getElementById('mobileGithubToken')?.value.trim();
        const apiEndpoint = document.getElementById('mobileGithubApiEndpoint')?.value.trim();
        
        githubConfig = { repo, token, apiEndpoint };
        localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify(githubConfig));
        
        const statusEl = document.getElementById('mobileGithubConfigStatus');
        if (statusEl) {
          statusEl.style.display = 'block';
          statusEl.textContent = 'âœ… é…ç½®å·²ä¿å­˜';
          statusEl.style.background = '#f0f9ff';
          statusEl.style.color = '#409eff';
        }
      }
      
      async function testGitHubBot() {
        const statusEl = document.getElementById('mobileGithubConfigStatus');
        if (statusEl) {
          statusEl.style.display = 'block';
          statusEl.textContent = 'æ­£åœ¨æµ‹è¯•è¿æ¥...';
          statusEl.style.background = '#fff7e6';
          statusEl.style.color = '#e6a23c';
        }
        
        // ç®€å•çš„æµ‹è¯•é€»è¾‘
        if (isGitHubConfigured()) {
          if (statusEl) {
            statusEl.textContent = 'âœ… é…ç½®æœ‰æ•ˆ';
            statusEl.style.background = '#f0f9ff';
            statusEl.style.color = '#67c23a';
          }
        } else {
          if (statusEl) {
            statusEl.textContent = 'âŒ è¯·å…ˆé…ç½®ä»“åº“åœ°å€å’ŒToken';
            statusEl.style.background = '#fef0f0';
            statusEl.style.color = '#f56c6c';
          }
        }
      }
      
      async function chatWithGitHubBot(question, history = [], context = {}) {
        if (!isGitHubConfigured()) {
          return null;
        }
        
        try {
          const [owner, repo] = githubConfig.repo.split('/');
          const apiPaths = [];
          
          if (githubConfig.apiEndpoint) {
            apiPaths.push(githubConfig.apiEndpoint);
          }
          
          const isNextJSRepo = repo.toLowerCase().includes('nextjs') || repo.toLowerCase().includes('next');
          if (isNextJSRepo) {
            apiPaths.push(`https://${repo}.vercel.app/api/chat`);
            apiPaths.push(`https://${owner}-${repo}.vercel.app/api/chat`);
          }
          
          apiPaths.push(`https://${owner}.github.io/${repo}/api/chat`);
          
          for (const apiPath of apiPaths) {
            try {
              const response = await fetch(apiPath, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  ...(githubConfig.token ? { 'Authorization': `Bearer ${githubConfig.token}` } : {})
                },
                body: JSON.stringify({
                  question: question,
                  message: question,
                  history: history,
                  context: context
                })
              });
              
              if (response.ok) {
                const data = await response.json();
                let responseText = data.response || data.text || data.answer || data.message || data.content;
                if (data.choices && data.choices[0] && data.choices[0].message) {
                  responseText = data.choices[0].message.content;
                }
                if (responseText) {
                  return { text: responseText };
                }
              }
            } catch (e) {
              continue;
            }
          }
        } catch (error) {
          console.error('GitHub chatbot error:', error);
        }
        
        return null;
      }
      
      async function chatWithBackendAPI(question, history = []) {
        const API_URL = window.API_URL || 'http://localhost:3000';
        const token = localStorage.getItem('token');
        
        if (!token) {
          return null;
        }
        
        try {
          const response = await fetch(`${API_URL}/api/evo/chat`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              question: question,
              history: history
            })
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.data) {
              return { text: data.data.text || data.data.response };
            }
          }
        } catch (error) {
          console.error('Backend API chat error:', error);
        }
        
        return null;
      }
      
      function getFunctionGuide(question) {
        const currentEvoSettings = window.getMobileEvoSettings ? window.getMobileEvoSettings() : (evoSettings || {});
        const functionGuides = currentEvoSettings.functionGuides || {};
        const lowerQuestion = question.toLowerCase();
        
        if (lowerQuestion.includes('å¦‚ä½•ä½¿ç”¨') || lowerQuestion.includes('æ€ä¹ˆç”¨') || 
            lowerQuestion.includes('ä½¿ç”¨æ–¹æ³•') || lowerQuestion.includes('åŠŸèƒ½è¯´æ˜') ||
            lowerQuestion.includes('å¸®åŠ©') || lowerQuestion.includes('æ•™ç¨‹')) {
          
          for (const [funcName, guide] of Object.entries(functionGuides)) {
            if (lowerQuestion.includes(funcName.toLowerCase()) || 
                lowerQuestion.includes(funcName.replace('ä¸', '').toLowerCase())) {
              let response = `ğŸ“– **${funcName}åŠŸèƒ½ä½¿ç”¨è¯´æ˜**\n\n${guide.description}\n\n**ä¸»è¦åŠŸèƒ½ï¼š**\n`;
              guide.features.forEach(feature => {
                response += `${feature}\n`;
              });
              response += `\nğŸ’¡ **ä½¿ç”¨æç¤º**ï¼šç‚¹å‡»åº•éƒ¨å¯¼èˆªæ çš„"${funcName}"å³å¯è¿›å…¥è¯¥åŠŸèƒ½é¡µé¢ã€‚`;
              return response;
            }
          }
          
          if (Object.keys(functionGuides).length > 0) {
            let response = 'ğŸ“š **æ™ºé¸½ç³»ç»ŸåŠŸèƒ½ä½¿ç”¨è¯´æ˜**\n\nç³»ç»ŸåŒ…å«ä»¥ä¸‹ä¸»è¦åŠŸèƒ½æ¨¡å—ï¼š\n\n';
            Object.keys(functionGuides).forEach((funcName, index) => {
              response += `${index + 1}. **${funcName}**ï¼š${functionGuides[funcName].description}\n`;
            });
            response += '\nğŸ’¡ **ä½¿ç”¨æç¤º**ï¼š\n';
            response += 'â€¢ æ‚¨å¯ä»¥è¯¢é—®å…·ä½“åŠŸèƒ½çš„ä½¿ç”¨æ–¹æ³•\n';
            response += 'â€¢ ç‚¹å‡»åº•éƒ¨å¯¼èˆªæ å¯ä»¥åˆ‡æ¢ä¸åŒçš„åŠŸèƒ½æ¨¡å—\n';
            response += 'â€¢ å¦‚æœ‰ç–‘é—®ï¼Œéšæ—¶å¯ä»¥é—®æˆ‘ï¼';
            return response;
          }
        }
        
        return null;
      }
      
      async function getWebPageData() {
        try {
          const pigeons = loadPigeons();
          const races = loadRaces();
          const pigeonList = Array.isArray(pigeons) ? pigeons : (pigeons.pigeons || []);
          const raceList = Array.isArray(races) ? races : (races.races || []);
          
          return {
            totalPigeons: pigeonList.length,
            alivePigeons: pigeonList.filter(p => p.status !== 'dead' && p.status !== 'å·²æ­»äº¡').length,
            deadPigeons: pigeonList.filter(p => p.status === 'dead' || p.status === 'å·²æ­»äº¡').length,
            breeders: pigeonList.filter(p => p.type === 'ç§é¸½' || p.tags?.includes('æ ¸å¿ƒç§é¸½')).length,
            racesCount: raceList.length,
            activeRaces: raceList.filter(r => r.status === 'ongoing').length,
            completedRaces: raceList.filter(r => r.status === 'completed').length,
            pigeons: pigeonList.slice(0, 10),
            races: raceList.slice(0, 10)
          };
        } catch (error) {
          console.error('è·å–ç½‘é¡µæ•°æ®å¤±è´¥:', error);
          return null;
        }
      }
      
      // å¿«é€Ÿæ“ä½œï¼ˆç§»åŠ¨ç«¯ï¼šåˆ‡æ¢è§†å›¾å¹¶å…³é—­å¯¹è¯æ¡†ï¼‰
      function handleQuickAction(action) {
        switch (action) {
          case 'stats':
            if (typeof switchView === 'function') {
              switchView('stats');
            }
            toggleExpanded();
            break;
          case 'pedigree':
            if (typeof switchView === 'function') {
              switchView('pedigree');
            }
            toggleExpanded();
            break;
          case 'races':
            if (typeof switchView === 'function') {
              switchView('races');
            }
            toggleExpanded();
            break;
          default:
            // å¦‚æœæ²¡æœ‰å¯¹åº”çš„è§†å›¾ï¼Œå‘é€æ¶ˆæ¯
            const actionMessages = {
              stats: 'è¯·å¸®æˆ‘æŸ¥çœ‹ç»Ÿè®¡æ•°æ®',
              pedigree: 'è¯·åˆ†æè¡€ç»Ÿå…³ç³»',
              races: 'æ˜¾ç¤ºæ¯”èµ›è®°å½•'
            };
            if (inputField) {
              inputField.value = actionMessages[action] || action;
              sendMessage();
            }
        }
      }
      
      // æ·»åŠ æ¶ˆæ¯
      function addMessage(type, text) {
        const message = {
          type,
          text,
          time: new Date()
        };
        messages.push(message);
        renderMessages();
      }
      
      // æ¸²æŸ“æ¶ˆæ¯
      function renderMessages() {
        if (!messagesContainer) {
          console.warn('âš ï¸ messagesContainer ä¸å­˜åœ¨ï¼Œæ— æ³•æ¸²æŸ“æ¶ˆæ¯');
          return;
        }
        
        messagesContainer.innerHTML = messages.map(msg => {
          const timeStr = formatTime(msg.time);
          if (msg.type === 'user') {
            return `
              <div class="mobile-evo-message mobile-evo-message-user">
                <div class="mobile-evo-message-avatar">ğŸ‘¨â€ğŸ’¼</div>
                <div class="mobile-evo-message-wrapper">
                  <div class="mobile-evo-message-content">
                    <div class="mobile-evo-message-text">${formatMessage(msg.text)}</div>
                  </div>
                  <div class="mobile-evo-message-time">${timeStr}</div>
                </div>
              </div>
            `;
          } else {
            return `
              <div class="mobile-evo-message mobile-evo-message-evo">
                <div class="mobile-evo-message-avatar">ğŸ•Šï¸</div>
                <div class="mobile-evo-message-content">
                  <div class="mobile-evo-message-text">${formatMessage(msg.text)}</div>
                  <div class="mobile-evo-message-time">${timeStr}</div>
                </div>
              </div>
            `;
          }
        }).join('');
        
        if (isTyping) {
          messagesContainer.innerHTML += `
            <div class="mobile-evo-message mobile-evo-message-evo">
              <div class="mobile-evo-message-avatar">ğŸ•Šï¸</div>
              <div class="mobile-evo-message-content">
                <div class="mobile-evo-typing-indicator">
                  <span></span><span></span><span></span>
                </div>
              </div>
            </div>
          `;
        }
        
        scrollToBottom();
      }
      
      // æ ¼å¼åŒ–æ¶ˆæ¯æ–‡æœ¬
      function formatMessage(text) {
        return escapeHtml(text).replace(/\n/g, '<br>');
      }
      
      // æ ¼å¼åŒ–æ—¶é—´
      function formatTime(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        
        if (minutes < 1) return 'åˆšåˆš';
        if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
        if (minutes < 1440) return `${Math.floor(minutes / 60)}å°æ—¶å‰`;
        return date.toLocaleString();
      }
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      function scrollToBottom() {
        if (messagesContainer) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }
      
      // æ›´æ–°çŠ¶æ€
      function updateStatus(status) {
        const statusEl = document.getElementById('mobileEvoStatus');
        if (statusEl) {
          statusEl.textContent = status;
        }
      }
      
      // ç”Ÿæˆæ¨è
      function generateRecommendations() {
        const container = document.getElementById('mobileEvoRecommendations');
        if (!container) return;
        
        const pigeons = loadPigeons();
        const total = pigeons.length;
        const alive = pigeons.filter(p => p.status !== 'dead' && p.status !== 'å·²æ­»äº¡').length;
        const recommendations = [];
        
        if (total === 0) {
          recommendations.push({
            icon: 'â•',
            title: 'å¼€å§‹æ·»åŠ é¸½å­',
            description: 'æ‚¨è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•é¸½å­ï¼Œç‚¹å‡»æ–°å¢å¼€å§‹å§ï¼'
          });
        } else if (alive < 5) {
          recommendations.push({
            icon: 'ğŸ•Šï¸',
            title: 'å¢åŠ é¸½å­æ•°é‡',
            description: `å½“å‰åªæœ‰${alive}åªé¸½å­ï¼Œå»ºè®®å¢åŠ æ•°é‡ä»¥å»ºç«‹æ›´å¥½çš„è¡€ç»Ÿä½“ç³»`
          });
        }
        
        if (recommendations.length > 0) {
          container.innerHTML = recommendations.map(rec => `
            <div class="mobile-evo-recommendation-card">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="font-size: 24px;">${rec.icon}</div>
                <div>
                  <h4 style="margin: 0 0 4px 0; font-size: 14px;">${rec.title}</h4>
                  <p style="margin: 0; font-size: 12px; color: #909399;">${rec.description}</p>
                </div>
              </div>
            </div>
          `).join('');
        }
      }
      
      // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯æ°”æ³¡
      function showWelcomeGreeting() {
        const existingBubble = document.getElementById('mobileEvoWelcomeBubble');
        if (existingBubble) {
          return;
        }
        
        hasShownGreetingThisPageLoad = true;
        
        try {
          if (!document.body) {
            setTimeout(showWelcomeGreeting, 500);
            return;
          }
          
          const suffix = getUnusedGreetingSuffix();
          const greeting = `ä½ å¥½ï¼Œæˆ‘æ˜¯Evoï¼Œæˆ‘å¯ä»¥å¸®ä½ ${suffix}ã€‚`;
          
          const bubble = document.createElement('div');
          bubble.id = 'mobileEvoWelcomeBubble';
          bubble.className = 'mobile-evo-welcome-bubble';
          
          bubble.style.position = 'fixed';
          bubble.style.bottom = 'calc(30vh + 80px)';
          bubble.style.right = '16px';
          bubble.style.zIndex = '99998';
          bubble.style.maxWidth = '240px';
          bubble.style.pointerEvents = 'auto';
          bubble.style.display = 'block';
          bubble.style.visibility = 'visible';
          bubble.style.opacity = '1';
          
          const bubbleContent = document.createElement('div');
          bubbleContent.className = 'mobile-evo-welcome-bubble-content';
          bubbleContent.textContent = greeting;
          bubbleContent.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          bubbleContent.style.color = '#fff';
          bubbleContent.style.padding = '10px 14px';
          bubbleContent.style.borderRadius = '8px';
          // å°†æ‰“æ‹›å‘¼æ°”æ³¡æ•´ä½“ç¼©å°ä¸ºåŸæ¥çš„ 60%
          bubbleContent.style.fontSize = '13px';
          bubbleContent.style.transform = 'scale(0.6)';
          bubbleContent.style.transformOrigin = 'bottom right';
          bubbleContent.style.lineHeight = '1.5';
          bubbleContent.style.boxShadow = '0 4px 20px rgba(102, 126, 234, 0.4)';
          bubbleContent.style.cursor = 'pointer';
          bubbleContent.style.fontWeight = '500';
          
          bubbleContent.addEventListener('click', () => {
            hideWelcomeBubble();
            if (!dialog) {
              dialog = document.getElementById('mobileEvoDialog');
            }
            if (dialog) {
              isExpanded = true;
              dialog.style.display = 'flex';
              activeTab = 'chat';
              switchTab('chat');
              if (messagesContainer) {
                messages = [];
                messagesContainer.innerHTML = '';
                addMessage('evo', greeting);
                saveHistory();
              }
            }
          });
          
          bubble.appendChild(bubbleContent);
          document.body.appendChild(bubble);
          
          setTimeout(() => {
            hideWelcomeBubble();
          }, 3000);
        } catch (error) {
          console.error('æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯å¤±è´¥:', error);
        }
      }
      
      // éšè—æ¬¢è¿æ¶ˆæ¯æ°”æ³¡
      function hideWelcomeBubble() {
        const bubble = document.getElementById('mobileEvoWelcomeBubble');
        if (bubble) {
          bubble.classList.add('hiding');
          setTimeout(() => {
            if (bubble.parentNode) {
              bubble.remove();
            }
          }, 300);
        }
      }
      
      // è·å–æœªä½¿ç”¨çš„æ¬¢è¿æ¶ˆæ¯åç¼€
      function getUnusedGreetingSuffix() {
        try {
          const used = JSON.parse(localStorage.getItem(USED_GREETINGS_KEY) || '[]');
          const available = GREETING_SUFFIXES.filter(suffix => !used.includes(suffix));
          
          if (available.length === 0) {
            localStorage.setItem(USED_GREETINGS_KEY, '[]');
            return GREETING_SUFFIXES[Math.floor(Math.random() * GREETING_SUFFIXES.length)];
          }
          
          const selected = available[Math.floor(Math.random() * available.length)];
          used.push(selected);
          localStorage.setItem(USED_GREETINGS_KEY, JSON.stringify(used));
          
          return selected;
        } catch (error) {
          console.error('è·å–æ¬¢è¿æ¶ˆæ¯å¤±è´¥:', error);
          return GREETING_SUFFIXES[0];
        }
      }
      
      // è‡ªåŠ¨å…³é—­å®šæ—¶å™¨
      function clearAutoCloseTimer() {
        if (autoCloseTimer) {
          clearTimeout(autoCloseTimer);
          autoCloseTimer = null;
        }
        if (userInteractionTimer) {
          clearTimeout(userInteractionTimer);
          userInteractionTimer = null;
        }
      }
      
      function hasUserInteraction() {
        return messages.some(msg => msg.type === 'user');
      }
      
      function startAutoCloseTimer() {
        clearAutoCloseTimer();
        if (isExpanded && !hasUserInteraction()) {
          autoCloseTimer = setTimeout(() => {
            if (!hasUserInteraction() && isExpanded) {
              toggleExpanded();
            }
          }, AUTO_CLOSE_DELAY);
        } else if (isExpanded && hasUserInteraction()) {
          startUserInactivityTimer();
        }
      }
      
      function startUserInactivityTimer() {
        clearUserInactivityTimer();
        if (isExpanded && hasUserInteraction()) {
          userInteractionTimer = setTimeout(() => {
            if (isExpanded) {
              toggleExpanded();
            }
          }, USER_INACTIVITY_DELAY);
        }
      }
      
      function clearUserInactivityTimer() {
        if (userInteractionTimer) {
          clearTimeout(userInteractionTimer);
          userInteractionTimer = null;
        }
      }
      
      function resetAutoCloseTimer() {
        if (isExpanded) {
          if (hasUserInteraction()) {
            startUserInactivityTimer();
          } else {
            startAutoCloseTimer();
          }
        }
      }
      
      // å¯¹è¯åŠŸèƒ½ï¼ˆå¢å¼ºç‰ˆ - ä¼˜å…ˆAIï¼Œç»“åˆä½¿ç”¨è¯´æ˜å’Œç½‘é¡µæ•°æ®ï¼‰
      async function chat(question) {
        loadGitHubConfig();
        
        const history = messages.map(msg => ({
          type: msg.type,
          text: msg.text,
          time: msg.time
        }));
        
        const guideAnswer = getFunctionGuide(question);
        const webData = await getWebPageData();
        const currentEvoSettings = window.getMobileEvoSettings ? window.getMobileEvoSettings() : (evoSettings || {});
        
        const context = {
          ...(webData || {}),
          functionGuides: currentEvoSettings.functionGuides || {},
          currentGuide: guideAnswer || null
        };
        
        let enhancedQuestion = question;
        if (guideAnswer) {
          enhancedQuestion += `\n\nã€ç³»ç»ŸåŠŸèƒ½è¯´æ˜å‚è€ƒã€‘\n${guideAnswer}`;
        }
        if (webData) {
          enhancedQuestion += `\n\nã€å½“å‰ç³»ç»Ÿæ•°æ®ã€‘\næ€»é¸½å­æ•°ï¼š${webData.totalPigeons}ï¼Œåœ¨ä¸–ï¼š${webData.alivePigeons}ï¼Œç§é¸½ï¼š${webData.breeders}ï¼Œæ¯”èµ›è®°å½•ï¼š${webData.racesCount}æ¡`;
        }
        
        // ä¼˜å…ˆçº§1ï¼šå°è¯•ä½¿ç”¨AI API
        try {
          const API_URL = window.API_URL || 'http://localhost:3000';
          const response = await fetch(`${API_URL}/api/ai/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              question: enhancedQuestion,
              context: context,
              history: history
            })
          });
          
          if (response.ok) {
            const data = await response.json();
            const aiAnswer = data.text || data.answer || '';
            if (aiAnswer && aiAnswer.length > 10) {
              return { text: aiAnswer };
            }
          }
        } catch (error) {
          console.warn('AI APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°é€»è¾‘:', error);
        }
        
        // ä¼˜å…ˆçº§2ï¼šå°è¯•ä½¿ç”¨GitHubèŠå¤©æœºå™¨äºº
        if (isGitHubConfigured()) {
          try {
            const githubResponse = await chatWithGitHubBot(enhancedQuestion, history, context);
            if (githubResponse && githubResponse.text) {
              return githubResponse;
            }
          } catch (error) {
            console.warn('GitHub chatbot failed, using fallback:', error);
          }
        }
        
        // ä¼˜å…ˆçº§3ï¼šå°è¯•ä½¿ç”¨åç«¯API
        try {
          const apiResponse = await chatWithBackendAPI(enhancedQuestion, history);
          if (apiResponse && apiResponse.text) {
            return apiResponse;
          }
        } catch (error) {
          console.warn('Backend API failed, using local logic:', error);
        }
        
        // ä¼˜å…ˆçº§4ï¼šä½¿ç”¨æœ¬åœ°é€»è¾‘
        if (guideAnswer) {
          return { text: guideAnswer };
        }
        
        const q = question.toLowerCase();
        
        if (q.includes('ç»Ÿè®¡') || q.includes('æ•°æ®') || q.includes('æ€»æ•°')) {
          return handleStatsQuestion(webData);
        }
        if (q.includes('é¸½å­') || q.includes('ä¿¡é¸½')) {
          return handlePigeonQuestion(question, webData);
        }
        if (q.includes('è¡€ç»Ÿ') || q.includes('çˆ¶æ¯') || q.includes('å­ä»£')) {
          return handlePedigreeQuestion(webData);
        }
        if (q.includes('æ¯”èµ›') || q.includes('æˆç»©')) {
          return handleRaceQuestion(webData);
        }
        if (q.includes('ä½ å¥½') || q.includes('hello') || q.includes('hi') || q.includes('å¸®åŠ©')) {
          return handleGreetingQuestion();
        }
        
        return {
          text: `æˆ‘ç†è§£æ‚¨çš„é—®é¢˜ï¼š"${question}"\n\n` +
                `ç›®å‰æˆ‘å¯ä»¥å¸®æ‚¨ï¼š\n` +
                `â€¢ æŸ¥çœ‹ç³»ç»Ÿç»Ÿè®¡æ•°æ®\n` +
                `â€¢ æŸ¥æ‰¾é¸½å­ä¿¡æ¯\n` +
                `â€¢ åˆ†æè¡€ç»Ÿå…³ç³»\n` +
                `â€¢ æŸ¥çœ‹æ¯”èµ›è®°å½•\n` +
                `â€¢ è¯¢é—®åŠŸèƒ½ä½¿ç”¨æ–¹æ³•\n\n` +
                `è¯·å‘Šè¯‰æˆ‘æ‚¨å…·ä½“éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ`
        };
      }
      
      function handleStatsQuestion(webData) {
        if (!webData) {
          return { text: 'æ— æ³•è·å–ç»Ÿè®¡æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚' };
        }
        
        const total = webData.totalPigeons || 0;
        const alive = webData.alivePigeons || 0;
        const dead = webData.deadPigeons || 0;
        const breeders = webData.breeders || 0;
        const racesCount = webData.racesCount || 0;
        const aliveRate = total > 0 ? ((alive / total) * 100).toFixed(1) : 0;
        const breederRate = total > 0 ? ((breeders / total) * 100).toFixed(1) : 0;
        
        return {
          text: `ğŸ“Š ç³»ç»Ÿç»Ÿè®¡æ•°æ®ï¼š\n\n` +
                `ğŸ•Šï¸ æ€»é¸½å­æ•°ï¼š${total}\n` +
                `âœ… åœ¨ä¸–é¸½å­ï¼š${alive}\n` +
                `ğŸ’” å·²æ­»äº¡ï¼š${dead}\n` +
                `â­ ç§é¸½æ•°é‡ï¼š${breeders}\n` +
                `ğŸ† æ¯”èµ›è®°å½•ï¼š${racesCount}æ¡\n` +
                `ğŸ è¿›è¡Œä¸­èµ›äº‹ï¼š${webData.activeRaces || 0}ä¸ª\n` +
                `âœ… å·²å®Œæˆèµ›äº‹ï¼š${webData.completedRaces || 0}ä¸ª\n\n` +
                `ğŸ“ˆ æ•°æ®åˆ†æï¼š\n` +
                `â€¢ åœ¨ä¸–ç‡ï¼š${aliveRate}%\n` +
                `â€¢ ç§é¸½å æ¯”ï¼š${breederRate}%\n\n` +
                `éœ€è¦æŸ¥çœ‹æ›´è¯¦ç»†çš„ä¿¡æ¯å—ï¼Ÿ`
        };
      }
      
      function handlePigeonQuestion(question, webData) {
        if (!webData || !webData.pigeons) {
          return { text: 'æ— æ³•è·å–é¸½å­æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚' };
        }
        
        const ringMatch = question.match(/(\d{4}[-\s]?\d{3,})|(CHN\d{4}[-\s]?\d{3,})/i);
        if (ringMatch) {
          const ring = ringMatch[0].replace(/\s/g, '');
          const pigeon = webData.pigeons.find(p => {
            const pRing = (p.ring || '').replace(/\s/g, '');
            return pRing === ring || pRing.includes(ring) || ring.includes(pRing);
          });
          
          if (pigeon) {
            const raceCount = pigeon.races ? pigeon.races.length : 0;
            return {
              text: `ğŸ•Šï¸ æ‰¾åˆ°é¸½å­ä¿¡æ¯ï¼š\n\n` +
                    `è¶³ç¯å·ï¼š${pigeon.ring || '-'}\n` +
                    `åå­—ï¼š${pigeon.name || 'æœªå‘½å'}\n` +
                    `æ€§åˆ«ï¼š${pigeon.gender || 'æœªçŸ¥'}\n` +
                    `ç±»å‹ï¼š${pigeon.type || 'æœªçŸ¥'}\n` +
                    `çŠ¶æ€ï¼š${pigeon.status === 'dead' || pigeon.status === 'å·²æ­»äº¡' ? 'å·²æ­»äº¡' : 'åœ¨ä¸–'}\n` +
                    (pigeon.birthDate ? `å‡ºç”Ÿæ—¥æœŸï¼š${pigeon.birthDate}\n` : '') +
                    (pigeon.father || pigeon.fatherRing ? `çˆ¶é¸½ï¼š${pigeon.father || pigeon.fatherRing}\n` : '') +
                    (pigeon.mother || pigeon.motherRing ? `æ¯é¸½ï¼š${pigeon.mother || pigeon.motherRing}\n` : '') +
                    `å‚èµ›è®°å½•ï¼š${raceCount}æ¬¡\n\n` +
                    `éœ€è¦æŸ¥çœ‹è¿™åªé¸½å­çš„è¯¦ç»†èµ„æ–™å—ï¼Ÿ`
            };
          }
        }
        
        return {
          text: `ğŸ“Š é¸½å­ä¿¡æ¯ç»Ÿè®¡ï¼š\n\n` +
                `æ€»é¸½å­æ•°ï¼š${webData.totalPigeons || 0}\n` +
                `åœ¨ä¸–ï¼š${webData.alivePigeons || 0}\n` +
                `ç§é¸½ï¼š${webData.breeders || 0}\n\n` +
                `ğŸ’¡ æç¤ºï¼šè¯·æä¾›é¸½å­çš„è¶³ç¯å·ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨æŸ¥æ‰¾ç›¸å…³ä¿¡æ¯ã€‚`
        };
      }
      
      function handlePedigreeQuestion(webData) {
        if (!webData || !webData.pigeons) {
          return { text: 'æ— æ³•è·å–è¡€ç»Ÿæ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚' };
        }
        
        const total = webData.totalPigeons || 0;
        const withParents = webData.pigeons.filter(p => (p.father || p.fatherRing || p.mother || p.motherRing)).length;
        
        return {
          text: `ğŸ“Š è¡€ç»Ÿå…³ç³»åˆ†æï¼š\n\n` +
                `æ€»é¸½å­æ•°ï¼š${total}\n` +
                `æœ‰è¡€ç»Ÿè®°å½•çš„ï¼š${withParents}åª\n` +
                `è¡€ç»Ÿå®Œæ•´ç‡ï¼š${total > 0 ? ((withParents / total) * 100).toFixed(1) : 0}%\n\n` +
                `æˆ‘å¯ä»¥å¸®æ‚¨æŸ¥çœ‹é¸½å­çš„çˆ¶æ¯ä¿¡æ¯ã€å­ä»£ä¿¡æ¯å’Œè¡€ç»Ÿå›¾è°±ã€‚`
        };
      }
      
      function handleRaceQuestion(webData) {
        if (!webData) {
          return { text: 'æ— æ³•è·å–æ¯”èµ›æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚' };
        }
        
        const racesCount = webData.racesCount || 0;
        const activeRaces = webData.activeRaces || 0;
        const completedRaces = webData.completedRaces || 0;
        
        return {
          text: `ğŸ† æ¯”èµ›è®°å½•ç»Ÿè®¡ï¼š\n\n` +
                `æ€»æ¯”èµ›è®°å½•ï¼š${racesCount}æ¡\n` +
                `ğŸ è¿›è¡Œä¸­èµ›äº‹ï¼š${activeRaces}ä¸ª\n` +
                `âœ… å·²å®Œæˆèµ›äº‹ï¼š${completedRaces}ä¸ª\n\n` +
                `æˆ‘å¯ä»¥å¸®æ‚¨æŸ¥çœ‹æ¯”èµ›å†å²è®°å½•ã€åˆ†ææ¯”èµ›æˆç»©å’ŒæŸ¥çœ‹æœ€ä½³è¡¨ç°ã€‚`
        };
      }
      
      function handleGreetingQuestion() {
        const greetings = [
          'ä½ å¥½ï¼æˆ‘æ˜¯ Evoï¼Œæ‚¨çš„æ™ºèƒ½åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®æ‚¨ï¼š\n\n' +
          'â€¢ ğŸ“Š æŸ¥çœ‹ç»Ÿè®¡æ•°æ®\n' +
          'â€¢ ğŸ•Šï¸ æŸ¥æ‰¾é¸½å­ä¿¡æ¯\n' +
          'â€¢ ğŸŒ³ åˆ†æè¡€ç»Ÿå…³ç³»\n' +
          'â€¢ ğŸ† æŸ¥çœ‹æ¯”èµ›è®°å½•\n\n' +
          'æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ',
          'æ‚¨å¥½ï¼æˆ‘æ˜¯ Evoï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚\n\n' +
          'æˆ‘å¯ä»¥å¸®æ‚¨ç®¡ç†å’Œåˆ†æä¿¡é¸½æ•°æ®ï¼Œå›ç­”æ‚¨çš„é—®é¢˜ã€‚\n\n' +
          'è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ'
        ];
        
        return {
          text: greetings[Math.floor(Math.random() * greetings.length)]
        };
      }
      
      // ä¿å­˜å†å²
      function saveHistory() {
        try {
          localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(messages));
        } catch (error) {
          console.error('Failed to save chat history:', error);
        }
      }
      
      // åŠ è½½å†å²
      function loadHistory() {
        try {
          const history = localStorage.getItem(CHAT_HISTORY_KEY);
          if (history) {
            messages = JSON.parse(history).map(msg => ({
              ...msg,
              time: new Date(msg.time)
            }));
            renderMessages();
          }
        } catch (error) {
          console.error('Failed to load chat history:', error);
        }
      }
      
      // åŠ è½½è®¾ç½®ï¼ˆä»åå°åŒæ­¥ï¼‰
      async function loadSettings() {
        try {
          const apiConfig = getApiConfig();
          const apiUrl = apiConfig.apiUrl || 'http://localhost:3000/api';
          
          const response = await fetch(`${apiUrl}/evo-settings`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
              evoSettings = { ...evoSettings, ...result.data };
              console.log('âœ… Evoè®¾ç½®å·²åŠ è½½ï¼ŒåŠŸèƒ½è¯´æ˜æ•°é‡:', Object.keys(evoSettings.functionGuides || {}).length);
              
              localStorage.setItem('evo_settings', JSON.stringify(evoSettings));
              applyEvoSettings(evoSettings);
            }
          }
        } catch (error) {
          console.warn('âš ï¸ åŠ è½½Evoè®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®:', error);
          try {
            const cached = localStorage.getItem('evo_settings');
            if (cached) {
              evoSettings = { ...evoSettings, ...JSON.parse(cached) };
              console.log('âœ… ä»ç¼“å­˜åŠ è½½Evoè®¾ç½®');
            }
          } catch (e) {
            console.error('åŠ è½½ç¼“å­˜è®¾ç½®å¤±è´¥:', e);
          }
        }
      }
      
      // åº”ç”¨Evoè®¾ç½®
      function applyEvoSettings(settings) {
        if (!settings) return;
        
        // åº”ç”¨åŸºæœ¬è®¾ç½®ï¼ˆå¯ç”¨/ç¦ç”¨ï¼‰
        if (settings.enabled === false) {
          const assistant = document.getElementById('mobileEvoAssistant');
          if (assistant) {
            assistant.style.display = 'none';
          }
          return;
        } else {
          const assistant = document.getElementById('mobileEvoAssistant');
          if (assistant) {
            assistant.style.display = 'block';
          }
        }
        
        // åº”ç”¨ä½ç½®è®¾ç½®
        if (settings.position) {
          const assistant = document.getElementById('mobileEvoAssistant');
          if (assistant) {
            const positions = {
              'bottom-right': { bottom: '30vh', right: '16px', top: 'auto', left: 'auto' },
              'bottom-left': { bottom: '30vh', left: '16px', top: 'auto', right: 'auto' },
              'top-right': { top: '80px', right: '16px', bottom: 'auto', left: 'auto' },
              'top-left': { top: '80px', left: '16px', bottom: 'auto', right: 'auto' }
            };
            
            const pos = positions[settings.position] || positions['bottom-right'];
            Object.assign(assistant.style, pos);
          }
        }
        
        // åº”ç”¨å›¾æ ‡å¤§å°
        if (settings.iconSize) {
          const iconButton = document.getElementById('mobileEvoIconButton');
          if (iconButton) {
            iconButton.style.width = settings.iconSize + 'px';
            iconButton.style.height = settings.iconSize + 'px';
          }
        }
        
        // åº”ç”¨ä¸»é¢˜é¢œè‰²
        if (settings.theme) {
          const iconButton = document.getElementById('mobileEvoIconButton');
          if (iconButton) {
            const themes = {
              'purple': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
              'blue': 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
              'green': 'linear-gradient(135deg, #10b981 0%, #059669 100%)'
            };
            iconButton.style.background = themes[settings.theme] || themes['purple'];
          }
        }
        
        console.log('âœ… Evoè®¾ç½®å·²åº”ç”¨');
      }
      
      // å®šæœŸåŒæ­¥è®¾ç½®å®šæ—¶å™¨IDï¼ˆç”¨äºæ¸…ç†ï¼‰
      let settingsTimer = null;
      
      // å®šæœŸåŒæ­¥è®¾ç½®ï¼ˆæ¯30ç§’ï¼‰
      settingsTimer = setInterval(() => {
        loadSettings();
      }, 30000);
      
      // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
      window.addEventListener('beforeunload', () => {
        if (settingsTimer) clearInterval(settingsTimer);
        if (iconMonitorTimer) clearInterval(iconMonitorTimer);
      });
      
      // å…¬å¼€API
      return {
        init,
        ensureIconVisible,
        startIconMonitor,
        showWelcomeGreeting,
        getSettings: () => evoSettings,
        loadSettings
      };
    })();
    
    // å…¨å±€è®¿é—®evoSettingsï¼ˆä¾›chatå‡½æ•°ä½¿ç”¨ï¼‰
    window.getMobileEvoSettings = () => {
      if (MobileEvoAssistant && typeof MobileEvoAssistant.getSettings === 'function') {
        return MobileEvoAssistant.getSettings();
      }
      try {
        const cached = localStorage.getItem('evo_settings');
        return cached ? JSON.parse(cached) : { functionGuides: {} };
      } catch (e) {
        return { functionGuides: {} };
      }
    };
    
    // ========================================
    // ğŸ”„ è‡ªåŠ¨åŒ–åŠŸèƒ½ï¼ˆä¸PCç«¯ä¸€è‡´ï¼‰
    // ========================================
    
    // è‡ªåŠ¨åˆ·æ–°ç»Ÿè®¡æ•°æ®
    function autoRefreshStats() {
      if (document.getElementById('statsView')?.style.display !== 'none') {
        refreshStats();
      }
      if (document.getElementById('homeView')?.style.display !== 'none') {
        refreshDashboard();
      }
    }
    
    // è‡ªåŠ¨ä¿å­˜æ•°æ®ï¼ˆé˜²ä¸¢å¤±ï¼‰
    function autoSaveData() {
      try {
        // è‡ªåŠ¨ä¿å­˜é¸½å­æ•°æ®
        const pigeons = loadPigeons();
        if (pigeons.length > 0) {
          localStorage.setItem('pigeon_manager_data_v1', JSON.stringify(pigeons));
        }
        
        // è‡ªåŠ¨ä¿å­˜æ¯”èµ›æ•°æ®
        const races = loadRaces();
        if (races.length > 0) {
          localStorage.setItem('pigeon_races_v1', JSON.stringify(races));
        }
        
        // è‡ªåŠ¨ä¿å­˜å¥åº·è®°å½•
        if (healthRecords.length > 0) {
          localStorage.setItem(HEALTH_RECORDS_KEY, JSON.stringify(healthRecords));
        }
        
        // è‡ªåŠ¨ä¿å­˜è®­ç»ƒè®°å½•
        if (trainingRecords.length > 0) {
          localStorage.setItem(TRAINING_STORAGE_KEY, JSON.stringify(trainingRecords));
        }
        
        // è‡ªåŠ¨ä¿å­˜é…å¯¹è®°å½•
        if (pairings.length > 0) {
          localStorage.setItem(PAIRING_RECORDS_KEY, JSON.stringify(pairings));
        }
        
        // è‡ªåŠ¨ä¸Šä¼ åˆ°åå°/äº‘ç«¯ï¼ˆéœ€å·²ç™»å½•ï¼‰
        autoSyncUserData();
      } catch (e) {
        console.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', e);
      }
    }
    
    // è‡ªåŠ¨æ›´æ–°å¥åº·æé†’
    function autoUpdateHealthAlerts() {
      if (document.getElementById('healthView')?.style.display !== 'none') {
        renderHealthAlerts();
        renderHealthCalendar();
      }
    }
    
    // è‡ªåŠ¨åŒæ­¥æ¯”èµ›æ•°æ®åˆ°é¸½å­æ¡£æ¡ˆ
    function autoSyncRaceData() {
      const races = loadRaces();
      const pigeons = loadPigeons();
      let hasChanges = false;
      
      races.forEach(race => {
        if (race.participants && Array.isArray(race.participants)) {
          race.participants.forEach(participant => {
            const pigeon = pigeons.find(p => p.id === participant.pigeonId || p.ring === participant.ring);
            if (pigeon) {
              if (!pigeon.races) pigeon.races = [];
              
              // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥æ¯”èµ›è®°å½•
              const existingRace = pigeon.races.find(r => r.id === race.id);
              if (!existingRace) {
                pigeon.races.push({
                  id: race.id,
                  name: race.name,
                  date: race.date,
                  location: race.location,
                  distance: race.distance,
                  rank: participant.rank,
                  time: participant.time,
                  weather: race.weather
                });
                hasChanges = true;
              } else {
                // æ›´æ–°ç°æœ‰è®°å½•
                const index = pigeon.races.findIndex(r => r.id === race.id);
                if (index !== -1) {
                  pigeon.races[index] = {
                    id: race.id,
                    name: race.name,
                    date: race.date,
                    location: race.location,
                    distance: race.distance,
                    rank: participant.rank,
                    time: participant.time,
                    weather: race.weather
                  };
                  hasChanges = true;
                }
              }
            }
          });
        }
      });
      
      if (hasChanges) {
        try {
          localStorage.setItem('pigeon_manager_data_v1', JSON.stringify(pigeons));
        } catch (e) {
          console.error('åŒæ­¥æ¯”èµ›æ•°æ®å¤±è´¥:', e);
        }
      }
    }
    
    // è‡ªåŠ¨æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
    function autoCheckDataIntegrity() {
      const pigeons = loadPigeons();
      
      pigeons.forEach(pigeon => {
        // æ£€æŸ¥å¹¶ä¿®å¤çˆ¶é¸½/æ¯é¸½å¼•ç”¨
        if (pigeon.fatherId) {
          const father = pigeons.find(p => p.id === pigeon.fatherId);
          if (!father) {
            console.warn(`é¸½å­ ${pigeon.ring} çš„çˆ¶é¸½å¼•ç”¨æ— æ•ˆ`);
          }
        }
        
        if (pigeon.motherId) {
          const mother = pigeons.find(p => p.id === pigeon.motherId);
          if (!mother) {
            console.warn(`é¸½å­ ${pigeon.ring} çš„æ¯é¸½å¼•ç”¨æ— æ•ˆ`);
          }
        }
        
        // æ£€æŸ¥å¹¶ä¿®å¤æ¯”èµ›è®°å½•
        if (pigeon.races && Array.isArray(pigeon.races)) {
          pigeon.races = pigeon.races.filter(r => r && r.id);
        }
      });
    }
    
    // å®šæ—¶å™¨IDå­˜å‚¨ï¼ˆç”¨äºæ¸…ç†ï¼‰
    const autoTaskTimers = {
      stats: null,
      save: null,
      health: null,
      race: null,
      integrity: null
    };
    
    // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
    function clearAutoTasks() {
      Object.values(autoTaskTimers).forEach(timerId => {
        if (timerId) clearInterval(timerId);
      });
      Object.keys(autoTaskTimers).forEach(key => {
        autoTaskTimers[key] = null;
      });
    }
    
    // å¯åŠ¨è‡ªåŠ¨åŒ–ä»»åŠ¡
    function startAutoTasks() {
      // å…ˆæ¸…ç†æ—§çš„å®šæ—¶å™¨ï¼ˆé¿å…é‡å¤åˆ›å»ºï¼‰
      clearAutoTasks();
      
      // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ç»Ÿè®¡æ•°æ®
      autoTaskTimers.stats = setInterval(autoRefreshStats, 30000);
      
      // æ¯60ç§’è‡ªåŠ¨ä¿å­˜æ•°æ®
      autoTaskTimers.save = setInterval(autoSaveData, 60000);
      
      // æ¯5åˆ†é’Ÿè‡ªåŠ¨æ›´æ–°å¥åº·æé†’
      autoTaskTimers.health = setInterval(autoUpdateHealthAlerts, 300000);
      
      // æ¯10åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥æ¯”èµ›æ•°æ®
      autoTaskTimers.race = setInterval(autoSyncRaceData, 600000);
      
      // æ¯å°æ—¶æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
      autoTaskTimers.integrity = setInterval(autoCheckDataIntegrity, 3600000);
      
      // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶è‡ªåŠ¨åˆ·æ–°
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          autoRefreshStats();
          autoSyncRaceData();
        }
      });
      
      // é¡µé¢å¸è½½å‰è‡ªåŠ¨ä¿å­˜å¹¶æ¸…ç†å®šæ—¶å™¨
      window.addEventListener('beforeunload', () => {
        clearAutoTasks();
        autoSaveData();
      });
      
      // é¡µé¢åŠ è½½å®Œæˆåç«‹å³æ‰§è¡Œä¸€æ¬¡
      setTimeout(() => {
        autoSyncRaceData();
        autoCheckDataIntegrity();
      }, 2000);
    }
    
    // åŒæ­¥Evoè®¾ç½®ï¼ˆä»åå°ï¼‰
    async function syncEvoSettings() {
      try {
        const apiConfig = getApiConfig();
        const apiUrl = apiConfig.apiUrl || 'http://localhost:3000/api';
        
        const syncFlag = localStorage.getItem('evo_settings_sync');
        const lastSyncTime = localStorage.getItem('evo_settings_sync_timestamp');
        const currentTime = Date.now();
        
        if (syncFlag === 'true' || !lastSyncTime || (currentTime - parseInt(lastSyncTime)) > 300000) {
          const response = await fetch(`${apiUrl}/evo-settings`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
              localStorage.setItem('evo_settings', JSON.stringify(result.data));
              localStorage.removeItem('evo_settings_sync');
              localStorage.setItem('evo_settings_sync_timestamp', currentTime.toString());
              
              console.log('âœ… Evoè®¾ç½®å·²ä»æœåŠ¡å™¨åŒæ­¥');
              
              // åº”ç”¨è®¾ç½®ï¼ˆé€šè¿‡å…¬å¼€APIï¼‰
              if (MobileEvoAssistant && typeof MobileEvoAssistant.loadSettings === 'function') {
                MobileEvoAssistant.loadSettings();
              }
            }
          }
        } else {
          const localSettings = localStorage.getItem('evo_settings');
          if (localSettings) {
            // è®¾ç½®å·²ç¼“å­˜ï¼Œæ— éœ€é‡æ–°åŠ è½½
            console.log('âœ… ä½¿ç”¨ç¼“å­˜çš„Evoè®¾ç½®');
          }
        }
      } catch (error) {
        console.warn('åŒæ­¥Evoè®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°è®¾ç½®:', error);
        const localSettings = localStorage.getItem('evo_settings');
        if (localSettings) {
          console.log('âœ… ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„Evoè®¾ç½®');
        }
      }
    }
    
    // åˆå§‹åŒ–è‡ªåŠ¨åŒ–åŠŸèƒ½
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', async () => {
        // å…ˆåŒæ­¥è®¾ç½®
        await syncEvoSettings();
        
        setTimeout(() => {
          MobileEvoAssistant.init();
          startAutoTasks();
        }, 500);
      });
    } else {
      (async () => {
        // å…ˆåŒæ­¥è®¾ç½®
        await syncEvoSettings();
        
        setTimeout(() => {
          MobileEvoAssistant.init();
          startAutoTasks();
        }, 500);
      })();
    }
    
    // å®šæ—¶å™¨IDå­˜å‚¨ï¼ˆç”¨äºæ¸…ç†ï¼‰
    const globalMobileTimers = {
      syncSettings: null,
      iconCheck: null
    };
    
    // å®šæœŸæ£€æŸ¥è®¾ç½®æ›´æ–°ï¼ˆæ¯5åˆ†é’Ÿï¼‰
    globalMobileTimers.syncSettings = setInterval(() => {
      syncEvoSettings();
    }, 300000);
    
    // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ¢å¤å›¾æ ‡
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && MobileEvoAssistant && typeof MobileEvoAssistant.ensureIconVisible === 'function') {
        setTimeout(() => {
          MobileEvoAssistant.ensureIconVisible();
        }, 100);
      }
    });
    
    // çª—å£ç„¦ç‚¹å˜åŒ–æ—¶æ¢å¤å›¾æ ‡
    window.addEventListener('focus', () => {
      if (MobileEvoAssistant && typeof MobileEvoAssistant.ensureIconVisible === 'function') {
        setTimeout(() => {
          MobileEvoAssistant.ensureIconVisible();
        }, 100);
      }
    });
    
    // å®šæœŸæ£€æŸ¥å›¾æ ‡ï¼ˆæ¯5ç§’ï¼‰
    globalMobileTimers.iconCheck = setInterval(() => {
      if (MobileEvoAssistant && typeof MobileEvoAssistant.ensureIconVisible === 'function') {
        const assistant = document.getElementById('mobileEvoAssistant');
        if (!assistant) {
          console.warn('Evoå›¾æ ‡ä¸¢å¤±ï¼Œæ­£åœ¨æ¢å¤...');
          MobileEvoAssistant.ensureIconVisible();
        } else {
          const computedStyle = window.getComputedStyle(assistant);
          if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden' || parseFloat(computedStyle.opacity) === 0) {
            console.warn('Evoå›¾æ ‡è¢«éšè—ï¼Œæ­£åœ¨æ¢å¤...');
            MobileEvoAssistant.ensureIconVisible();
          }
        }
      }
    }, 5000);
  </script>
  
  <style>
    /* ========================================
       ğŸ•Šï¸ Evo æ™ºèƒ½åŠ©æ‰‹æ ·å¼ï¼ˆç§»åŠ¨ç«¯ä¼˜åŒ–ï¼‰
       ======================================== */
    
    .mobile-evo-assistant {
      position: fixed;
      bottom: 30vh;
      right: 16px;
      z-index: 99999;
      font-family: 'Inter', 'Noto Sans SC', sans-serif;
      /* ç¡®ä¿ä¸ä¼šé®æŒ¡åº•éƒ¨å¯¼èˆªæ  */
      pointer-events: none !important;
    }
    
    /* Evoå›¾æ ‡æŒ‰é’®åº”è¯¥å¯ç‚¹å‡» */
    .mobile-evo-assistant .mobile-evo-icon-button,
    .mobile-evo-icon-button {
      pointer-events: auto !important;
    }
    
    /* Evoå¯¹è¯æ¡†åº”è¯¥å¯ç‚¹å‡» */
    .mobile-evo-dialog {
      pointer-events: auto !important;
    }
    
    .mobile-evo-icon-button {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.6),
                  0 0 30px rgba(118, 75, 162, 0.4);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
      border: 3px solid rgba(255, 255, 255, 0.3);
    }
    
    .mobile-evo-icon-button:active {
      transform: scale(0.95);
    }
    
    .mobile-evo-icon {
      font-size: 28px;
      z-index: 1;
      position: relative;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .mobile-evo-pulse {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: rgba(102, 126, 234, 0.3);
      animation: mobile-evo-pulse 2s ease-in-out infinite;
    }
    
    @keyframes mobile-evo-pulse {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.4); opacity: 0; }
    }
    
    .mobile-evo-dialog {
      position: fixed;
      /* æé«˜æ•´ä½“ä½ç½®ï¼Œç¡®ä¿ä¸é®æŒ¡å³ä¸‹è§’åŠ©æ‰‹å›¾æ ‡ */
      bottom: calc(32vh + 72px);
      right: 12px;
      left: auto;
      width: 220px;
      max-width: min(76vw, calc(100vw - 32px));
      /* é«˜åº¦ç¼©å‡åˆ°åŸæ¥çº¦ 60% å·¦å³ */
      max-height: 42vh;
      height: auto;
      min-height: 240px;
      background: var(--bg-secondary);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(15, 23, 42, 0.25);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: mobile-evo-dialog-appear 0.25s ease-out;
      z-index: 1000;
    }
    
    /* å°å±å¹•é€‚é… */
    @media (max-width: 375px) {
      .mobile-evo-dialog {
        width: 200px;
        max-width: min(80vw, calc(100vw - 24px));
        right: 10px;
        left: auto;
        bottom: calc(30vh + 64px);
        max-height: 40vh;
        min-height: 220px;
      }
    }
    
    @keyframes mobile-evo-dialog-appear {
      from {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .mobile-evo-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 12px 12px 0 0;
      flex-shrink: 0;
    }
    
    .mobile-evo-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .mobile-evo-icon-large {
      font-size: 20px;
    }
    
    .mobile-evo-title {
      font-size: 12px;
      font-weight: 600;
      margin: 0;
      line-height: 1.2;
    }
    
    .mobile-evo-subtitle {
      font-size: 9px;
      opacity: 0.9;
      margin: 2px 0 0 0;
      line-height: 1.2;
    }
    
    .mobile-evo-close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: #fff;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      padding: 0;
    }
    
    .mobile-evo-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .mobile-evo-tabs {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .mobile-evo-tab-headers {
      display: flex;
      border-bottom: 1px solid var(--border-light);
      padding: 0 4px;
      background: var(--bg-primary);
      flex-shrink: 0;
    }
    
    .mobile-evo-tab-header {
      padding: 6px 8px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
      font-size: 10px;
      color: var(--text-secondary);
      white-space: nowrap;
      flex: 1;
      text-align: center;
    }
    
    .mobile-evo-tab-header.active {
      color: #667eea;
      border-bottom-color: #667eea;
      font-weight: 600;
    }
    
    .mobile-evo-tab-header:active {
      background: rgba(102, 126, 234, 0.1);
    }
    
    .mobile-evo-tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: none;
    }
    
    .mobile-evo-tab-content.active {
      display: block;
    }
    
    .mobile-evo-analytics,
    .mobile-evo-recommendations,
    .mobile-evo-settings {
      padding: 12px;
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .mobile-evo-empty {
      text-align: center;
      padding: 20px;
      color: var(--text-secondary);
      font-size: 12px;
    }
    
    .mobile-evo-recommendation-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .mobile-evo-chat-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }
    
    .mobile-evo-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
      max-height: calc(42vh - 160px);
    }
    
    /* æ¬¢è¿æ¶ˆæ¯æ°”æ³¡ */
    .mobile-evo-welcome-bubble {
      position: fixed;
      bottom: calc(30vh + 80px);
      right: 16px;
      z-index: 99998;
      max-width: 240px;
      animation: mobile-evo-bubble-appear 0.3s ease-out;
      pointer-events: auto !important;
      /* ç¡®ä¿ä¸ä¼šé®æŒ¡åº•éƒ¨å¯¼èˆªæ ï¼ˆè™½ç„¶z-indexè¾ƒä½ï¼Œä½†æ˜ç¡®è®¾ç½®ï¼‰ */
    }
    
    /* ç¡®ä¿æ¬¢è¿æ°”æ³¡ä¸ä¼šå½±å“åº•éƒ¨å¯¼èˆªæ çš„ç‚¹å‡» */
    @media (max-width: 768px) {
      .mobile-evo-welcome-bubble {
        /* å¦‚æœåº•éƒ¨å¯¼èˆªæ å¯è§ï¼Œç¡®ä¿æ°”æ³¡ä¸ä¼šé®æŒ¡ */
        bottom: calc(30vh + 80px) !important;
      }
    }
    
    .mobile-evo-welcome-bubble-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.5;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
      position: relative;
      word-wrap: break-word;
      font-weight: 500;
    }
    
    .mobile-evo-welcome-bubble-content::after {
      content: '';
      position: absolute;
      bottom: -8px;
      right: 30px;
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid #764ba2;
    }
    
    @keyframes mobile-evo-bubble-appear {
      from {
        opacity: 0;
        transform: translateY(10px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    @keyframes mobile-evo-bubble-disappear {
      from {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateY(-10px) scale(0.9);
      }
    }
    
    .mobile-evo-welcome-bubble.hiding {
      animation: mobile-evo-bubble-disappear 0.3s ease-out forwards;
    }
    
    .mobile-evo-message {
      display: flex;
      gap: 8px;
      animation: mobile-evo-message-appear 0.3s ease-out;
      margin-bottom: 12px;
    }
    
    @keyframes mobile-evo-message-appear {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .mobile-evo-message-user {
      flex-direction: row-reverse;
      align-items: flex-start;
    }
    
    .mobile-evo-message-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--bg-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    
    .mobile-evo-message-user .mobile-evo-message-avatar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .mobile-evo-message-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      max-width: 70%;
    }
    
    .mobile-evo-message-content {
      flex: 0 1 auto;
      max-width: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .mobile-evo-message-evo .mobile-evo-message-content {
      max-width: 70%;
    }
    
    .mobile-evo-message-user .mobile-evo-message-content {
      text-align: right;
      align-items: flex-end;
    }
    
    .mobile-evo-message-text {
      background: var(--bg-primary);
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 12px;
      line-height: 1.5;
      word-wrap: break-word;
      display: inline-block;
      max-width: 100%;
    }
    
    .mobile-evo-message-user .mobile-evo-message-text {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .mobile-evo-message-time {
      font-size: 9px;
      color: var(--text-secondary);
      margin-top: 4px;
      padding: 0 4px;
    }
    
    .mobile-evo-message-user .mobile-evo-message-time {
      text-align: right;
    }
    
    .mobile-evo-typing-indicator {
      display: flex;
      gap: 4px;
      padding: 8px 12px;
    }
    
    .mobile-evo-typing-indicator span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-secondary);
      animation: mobile-evo-typing 1.4s ease-in-out infinite;
    }
    
    .mobile-evo-typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .mobile-evo-typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes mobile-evo-typing {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
      30% { transform: translateY(-8px); opacity: 1; }
    }
    
    .mobile-evo-input-area {
      padding: 12px;
      border-top: 1px solid var(--border-light);
      background: var(--bg-secondary);
      flex-shrink: 0;
    }
    
    .mobile-evo-input-group {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }
    
    .mobile-evo-input {
      flex: 1;
      min-width: 0;
      padding: 8px 12px;
      border: 1px solid var(--border-light);
      border-radius: 12px;
      font-size: 12px;
      background: var(--bg-primary);
      color: var(--text-primary);
    }
    
    .mobile-evo-input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .mobile-evo-send-btn {
      padding: 8px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      flex-shrink: 0;
      white-space: nowrap;
      transition: all 0.3s;
    }
    
    .mobile-evo-send-btn:active {
      transform: scale(0.95);
    }
    
    .mobile-evo-quick-actions {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 2px;
    }
    
    .mobile-evo-quick-action-btn {
      padding: 6px 10px;
      background: var(--bg-primary);
      border: 1px solid var(--border-light);
      border-radius: 10px;
      font-size: 10px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      flex: 1;
      min-width: 0;
      text-align: center;
    }
    
    .mobile-evo-quick-action-btn:active {
      background: #667eea;
      color: #fff;
      border-color: #667eea;
    }
    
    .mobile-evo-pigeon-icon {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</body>
</html>

