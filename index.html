<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Êô∫È∏ΩÔΩúPigeonAI - ÊØèÂè™È∏ΩÂ≠êÔºåÁöÜÊòØËµõÁ∫ß ÔΩúEvery Pigeon, Race-Grade</title>
  <!-- Google Fonts - ‰∏ì‰∏öÂ≠ó‰Ωì -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Ê®°Âùó1ÔºöËÆæÂ§áËá™Âä®ËØÜÂà´‰∏éÊó†ÊÑüÁü•Ë∑≥ËΩ¨ÔºàÁã¨Á´ãÂ∞ÅË£ÖÔºå‰∏çÁ†¥ÂùèÂéüÊúâÈÄªËæëÔºâ -->
  <script src="js/device-detect.js"></script>

  <style>
    /* ==========================================
       üé® CSS ÂèòÈáè - ËÆæËÆ°Á≥ªÁªü
       ========================================== */
    :root {
      /* ‰∏ªËâ≤Ë∞É */
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1d4ed8;
      --primary-50: #eff6ff;
      --primary-100: #dbeafe;
      --primary-200: #bfdbfe;
      
      /* Âº∫Ë∞ÉËâ≤ */
      --accent: #8b5cf6;
      --accent-light: #a78bfa;
      
      /* ÊàêÂäü/Ë≠¶Âëä/ÈîôËØØ */
      --success: #10b981;
      --success-light: #d1fae5;
      --warning: #f59e0b;
      --warning-light: #fef3c7;
      --danger: #ef4444;
      --danger-light: #fee2e2;
      
      /* ‰∏≠ÊÄßËâ≤ */
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      
      /* ËÉåÊôØËâ≤ */
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f1f5f9;
      
      /* ÊñáÂ≠óÈ¢úËâ≤ */
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      
      /* ËæπÊ°Ü */
      --border-light: #e2e8f0;
      --border-medium: #cbd5e1;
      
      /* Èò¥ÂΩ± */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --shadow-glow: 0 0 20px rgba(37, 99, 235, 0.3);
      
      /* ÂúÜËßí */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      
      /* ËøáÊ∏° */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
      
      /* È°∂Ê†èÈ´òÂ∫¶ */
      --header-height: 68px;
      --sidebar-width: 260px;
    }
    
    /* Ê∑±Ëâ≤Ê®°ÂºèÂèòÈáè */
    [data-theme="dark"] {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-light: #334155;
      --border-medium: #475569;
      --gray-50: #1e293b;
      --gray-100: #334155;
      --gray-200: #475569;
    }
    
    /* ==========================================
       üîß Âü∫Á°ÄÈáçÁΩÆ‰∏éÈÄöÁî®Ê†∑Âºè
       ========================================== */
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    html {
      scroll-behavior: smooth;
    }
    
    body { 
      font-family: 'Inter', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      pointer-events: auto !important;
      overflow-x: hidden;
      overflow-y: auto;
      width: 100%;
    }
    
    /* ÊªöÂä®Êù°ÁæéÂåñ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--gray-100);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-400);
    }
    
    /* ÈÄâ‰∏≠ÊñáÂ≠óÊ†∑Âºè */
    ::selection {
      background: var(--primary-200);
      color: var(--primary-dark);
    }
    
    /* ==========================================
       üîù È°∂ÈÉ®ÂØºËà™Ê†è
       ========================================== */
    .top-header { 
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      color: #fff; 
      padding: 0 28px; 
      height: var(--header-height); 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      z-index: 1000;
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .top-header h1 { 
      margin: 0; 
      font-size: 20px; 
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(90deg, #fff 0%, #a5b4fc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .top-header h1::before {
      content: 'üïäÔ∏è';
      font-size: 24px;
      -webkit-text-fill-color: initial;
    }
    .top-header-actions { 
      display: flex; 
      align-items: center; 
      gap: 14px; 
    }
    
    /* ÁßªÂä®Á´ØËèúÂçïÊåâÈíÆ */
    .mobile-menu-btn {
      display: none;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      transition: all var(--transition-fast);
      backdrop-filter: blur(10px);
    }
    .mobile-menu-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    /* ‰æßËæπÊ†èÈÅÆÁΩ©Â±Ç */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 998;
      opacity: 0;
      transition: opacity var(--transition-normal);
    }
    .sidebar-overlay.active {
      display: block;
      opacity: 1;
    }
    
    /* ==========================================
       üì± Â∑¶‰æßËèúÂçï
       ========================================== */
    .sidebar { 
      width: var(--sidebar-width); 
      background: var(--bg-secondary);
      position: fixed; 
      top: var(--header-height); 
      left: 0; 
      bottom: 0; 
      box-shadow: var(--shadow-lg);
      overflow-y: auto; 
      z-index: 999;
      border-right: 1px solid var(--border-light);
      transition: transform var(--transition-normal);
      pointer-events: auto !important;
    }
    .sidebar-menu { 
      padding: 20px 12px;
      pointer-events: auto !important;
    }
    .sidebar-item { 
      display: flex; 
      align-items: center; 
      padding: 14px 18px; 
      color: var(--text-secondary); 
      cursor: pointer; 
      transition: all var(--transition-fast);
      border-radius: var(--radius-md);
      margin-bottom: 4px;
      font-weight: 500;
      font-size: 14px;
      pointer-events: auto !important;
      user-select: none;
      -webkit-user-select: none;
      position: relative;
      z-index: 1;
    }
    .sidebar-item:hover { 
      background: var(--primary-50);
      color: var(--primary);
      transform: translateX(4px);
    }
    .sidebar-item.active { 
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: #fff;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    .sidebar-item-icon { 
      margin-right: 14px; 
      font-size: 18px;
      width: 24px;
      text-align: center;
    }
    
    /* ==========================================
       üìÑ ‰∏ªÂÜÖÂÆπÂå∫
       ========================================== */
    .main-content { 
      margin-left: var(--sidebar-width); 
      margin-top: var(--header-height); 
      padding: 28px; 
      min-height: calc(100vh - var(--header-height));
      background: var(--bg-primary);
      overflow-x: hidden;
      overflow-y: visible;
      width: calc(100% - var(--sidebar-width));
    }
    .content-wrapper { 
      max-width: 1600px; 
      margin: 0 auto;
    }
    
    /* ==========================================
       üÉè Âç°ÁâáÊ†∑Âºè
       ========================================== */
    .card { 
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: 28px;
      margin-bottom: 24px;
      border: 1px solid var(--border-light);
      transition: all var(--transition-normal);
    }
    .card:hover {
      box-shadow: var(--shadow-lg);
    }
    .card-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-light);
    }
    .card-header h2 { 
      margin: 0; 
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* ==========================================
       üîò ÊåâÈíÆÁ≥ªÁªü
       ========================================== */
    .btn { 
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all var(--transition-fast);
      gap: 6px;
      white-space: nowrap;
      pointer-events: auto !important;
      user-select: none;
      -webkit-user-select: none;
      position: relative;
      z-index: 1;
    }
    .btn:active {
      transform: scale(0.97);
    }
    .btn-primary { 
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(37, 99, 235, 0.35);
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.45);
      transform: translateY(-2px);
    }
    .btn-outline { 
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
    }
    .btn-outline:hover {
      background: var(--primary-50);
      border-color: var(--primary-dark);
    }
    .btn-danger { 
      background: linear-gradient(135deg, var(--danger) 0%, #f87171 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(239, 68, 68, 0.35);
    }
    .btn-danger:hover {
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.45);
      transform: translateY(-2px);
    }
    .btn-ghost { 
      background: transparent;
      color: var(--text-secondary);
    }
    .btn-ghost:hover {
      background: var(--gray-100);
      color: var(--text-primary);
    }
    .btn-sm { 
      padding: 6px 12px;
      font-size: 13px;
      border-radius: var(--radius-sm);
    }
    .btn + .btn { 
      margin-left: 10px; 
    }
    
    /* ==========================================
       üîÄ ËßÜÂõæÂàáÊç¢Âô®
       ========================================== */
    .view-switcher {
      display: flex;
      gap: 4px;
      background: var(--gray-100);
      padding: 5px;
      border-radius: var(--radius-md);
    }
    .view-switch-btn {
      padding: 10px 20px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
    }
    .view-switch-btn:hover {
      background: rgba(255,255,255,0.7);
      color: var(--text-primary);
    }
    .view-switch-btn.active {
      background: var(--bg-secondary);
      color: var(--primary);
      font-weight: 600;
      box-shadow: var(--shadow-md);
    }
    
    /* ==========================================
       üè∑Ô∏è Ê†áÁ≠æÁ≥ªÁªü
       ========================================== */
    .tag { 
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
      margin-left: 8px;
      transition: all var(--transition-fast);
    }
    .tag-alive { 
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #047857;
    }
    .tag-dead { 
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #b91c1c;
    }
    .tag-type { 
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      color: #1d4ed8;
    }
    
    /* ==========================================
       üìä Ë°®Ê†ºÊ†∑Âºè
       ========================================== */
    table { 
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td { 
      padding: 14px 12px;
      border-bottom: 1px solid var(--border-light);
      text-align: left;
    }
    th { 
      background: var(--gray-50);
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    tr {
      transition: all var(--transition-fast);
    }
    tr:hover { 
      background: var(--primary-50);
    }
    tbody tr:last-child td {
      border-bottom: none;
    }
    .muted { 
      color: var(--text-muted);
      font-size: 13px;
    }

    /* ==========================================
       üìù Ë°®ÂçïÊ†∑Âºè
       ========================================== */
    .form-grid { 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px 28px;
      margin-top: 12px;
    }
    .form-group { 
      display: flex;
      flex-direction: column;
      margin-bottom: 12px;
    }
    .form-group label { 
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }
    .form-group label .required { 
      color: var(--danger);
      margin-left: 4px;
    }
    .form-group input[type="text"],
    .form-group input[type="date"],
    .form-group input[type="number"],
    .form-group input[type="time"],
    .form-group input[type="file"],
    .form-group select,
    .form-group textarea {
      padding: 12px 14px;
      border-radius: var(--radius-md);
      border: 2px solid var(--border-light);
      font-size: 14px;
      outline: none;
      transition: all var(--transition-fast);
      background: var(--bg-secondary);
      color: var(--text-primary);
    }
    .form-group input:hover,
    .form-group select:hover,
    .form-group textarea:hover {
      border-color: var(--border-medium);
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }
    .form-group input::placeholder,
    .form-group textarea::placeholder {
      color: var(--text-muted);
    }
    .form-inline { 
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    .radio-group { 
      display: flex;
      gap: 16px;
      font-size: 14px;
    }
    .radio-group label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    .radio-group input[type="radio"],
    .radio-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }
    
    /* ==========================================
       üìë Âå∫ÂùóÊ†áÈ¢ò
       ========================================== */
    .section-title { 
      font-size: 16px;
      font-weight: 700;
      margin: 36px 0 18px;
      padding: 14px 20px;
      color: var(--text-primary);
      background: linear-gradient(135deg, var(--primary-50) 0%, var(--bg-tertiary) 100%);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .section-title:first-of-type { 
      margin-top: 0;
    }
    
    /* ËØ¶ÁªÜ‰ø°ÊÅØÈ°µÈù¢Â≠óÊÆµÂÆπÂô® */
    .detail-section {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-light);
    }
    .section-desc { 
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }
    .flex-between { 
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* ==========================================
       üèÅ ÊØîËµõËÆ∞ÂΩï
       ========================================== */
    .race-list { 
      margin-top: 12px;
    }
    .race-item { 
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      padding: 16px 18px;
      margin-bottom: 12px;
      background: var(--gray-50);
      transition: all var(--transition-fast);
    }
    .race-item:hover {
      border-color: var(--primary-200);
      box-shadow: var(--shadow-sm);
    }
    .race-header { 
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .race-fields { 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px 20px;
      font-size: 13px;
    }
    .pill { 
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 999px;
      background: var(--gray-100);
      font-size: 12px;
      font-weight: 500;
      margin-right: 6px;
      transition: all var(--transition-fast);
    }
    .pill:hover {
      background: var(--primary-100);
      color: var(--primary);
    }

    .images-grid { display:flex; gap:16px; margin-top: 8px; justify-content:center; flex-wrap:wrap; }
    .image-thumb { width:400px; height:300px; background:#f0f0f0; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:14px; color:#999; position:relative; overflow:hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .image-thumb img { width:100%; height:100%; object-fit:cover; }
    .badge { position:absolute; bottom:8px; left:8px; right:8px; background:rgba(0,0,0,0.7); color:#fff; font-size:13px; padding:6px 10px; border-radius:8px; text-align:center; }
    
    .pedigree-tree { margin-top:16px; padding:20px; background:#fafafa; border-radius:8px; min-height:200px; }
    .pedigree-node { display:inline-block; padding:8px 12px; margin:4px; background:#fff; border:2px solid #2b5cff; border-radius:6px; font-size:13px; cursor:pointer; }
    .pedigree-node:hover { background:#e6f0ff; }
    .pedigree-node.core { border-color:#ffa500; background:#fff8e6; }
    .pedigree-connection { stroke:#2b5cff; stroke-width:2; fill:none; }
    
    /* Ë°ÄÁªüÊ†ëÂÆπÂô®Ê†∑Âºè */
    .pedigree-tree-container {
      position: relative;
      overflow: auto;
    }
    
    /* Ê†ëÁä∂ÂõæËäÇÁÇπÊ†∑Âºè - ‰ºòÂåñÁâà */
    .tree-node {
      display: inline-block;
      padding: 14px 20px;
      margin: 8px;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 2.5px solid #2b5cff;
      border-radius: 12px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(43, 92, 255, 0.15);
      min-width: 160px;
      text-align: center;
      position: relative;
    }
    .tree-node::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #2b5cff 0%, #6366f1 100%);
      border-radius: 12px 12px 0 0;
    }
    .tree-node:hover {
      background: linear-gradient(135deg, #e6f0ff 0%, #f0f7ff 100%);
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 8px 24px rgba(43, 92, 255, 0.25);
      border-color: #6366f1;
    }
    .tree-node.core {
      border-color: #ffa500;
      background: linear-gradient(135deg, #fff8e6 0%, #fffbf0 100%);
      box-shadow: 0 4px 12px rgba(255, 165, 0, 0.2);
    }
    .tree-node.core::before {
      background: linear-gradient(90deg, #ffa500 0%, #ffb84d 100%);
    }
    .tree-node.dead {
      opacity: 0.7;
      border-color: #9ca3af;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .tree-node.dead::before {
      background: #9ca3af;
    }
    .tree-node-name {
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 6px;
      font-size: 14px;
      letter-spacing: -0.2px;
    }
    .tree-node-ring {
      font-size: 11px;
      color: #6b7280;
      font-family: 'Courier New', monospace;
      background: rgba(107, 114, 128, 0.1);
      padding: 3px 8px;
      border-radius: 6px;
      display: inline-block;
      margin-top: 4px;
    }
    .tree-node-label {
      font-size: 10px;
      color: #9ca3af;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid #e5e7eb;
      font-weight: 500;
    }
    
    /* Ê†ëÁä∂ÂõæËøûÊé•Á∫øÂÆπÂô® */
    .tree-connections {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    
    /* Ê†ëÁä∂ÂõæËøûÊé•Á∫ø */
    .tree-connection {
      stroke: #2b5cff;
      stroke-width: 2.5;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      opacity: 0.6;
      filter: drop-shadow(0 1px 2px rgba(43, 92, 255, 0.3));
    }
    
    /* Ê†ëÁä∂ÂõæÂ∏ÉÂ±Ä */
    .tree-level {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      margin: 30px 0;
      position: relative;
    }
    .tree-level-parents {
      display: flex;
      gap: 60px;
      justify-content: center;
      margin-bottom: 40px;
      position: relative;
    }
    .tree-level-children {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
      position: relative;
    }
    .tree-current {
      margin: 40px 0;
      text-align: center;
      position: relative;
      padding: 20px 0;
    }
    .tree-section-title {
      font-size: 15px;
      font-weight: 700;
      color: #374151;
      margin: 30px 0 20px;
      text-align: center;
      padding: 12px 20px;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border-radius: 10px;
      border: 1px solid #d1d5db;
      letter-spacing: 0.3px;
    }
    
    /* Áà∂È∏Ω/ÊØçÈ∏ΩÊ†áÁ≠æÊ†∑Âºè */
    .tree-parent-label {
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 12px;
      padding: 6px 14px;
      border-radius: 20px;
      display: inline-block;
      letter-spacing: 0.5px;
    }
    .tree-parent-label.father {
      color: #1e40af;
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border: 2px solid #3b82f6;
    }
    .tree-parent-label.mother {
      color: #be185d;
      background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
      border: 2px solid #ec4899;
    }
    
    /* Ê†ëÁä∂ÂõæÂÆπÂô®‰ºòÂåñ */
    .pedigree-tree-container {
      background: linear-gradient(135deg, #fafbfc 0%, #f3f4f6 100%);
    }
    
    @media (max-width: 900px) {
      .image-thumb { width:100%; max-width:400px; height:auto; min-height:250px; }
    }

    .field-row { 
      display:flex; 
      margin-bottom:12px; 
      font-size:14px; 
      padding:12px 16px; 
      border-bottom:1px solid #f0f0f0; 
      align-items:center; 
      min-height:44px;
      transition:background 0.2s;
    }
    .field-row:hover { background:#fafbfc; }
    .field-row:last-child { border-bottom:none; }
    .field-label { 
      width:120px; 
      color:#666; 
      flex-shrink:0; 
      font-weight:500; 
      text-align:right;
      padding-right:16px;
      border-right:1px solid #f0f0f0;
    }
    .field-value { 
      flex:1; 
      color:#222; 
      padding-left:16px;
      word-break:break-word;
    }

    .status-dead { color:#ff4d4f; font-weight:600; margin-left:8px; }
    .badge-small { display:inline-block; padding:2px 6px; border-radius:6px; background:#f5f5f5; font-size:11px; margin-left:4px; }

    .notice { background:#fffbe6; border:1px solid #ffe58f; color:#ad8b00; padding:8px 10px; border-radius:8px; font-size:12px; margin-bottom:10px; }

    /* È∏ΩÂ≠êÂç°ÁâáËßÜÂõæÊ†∑Âºè */
    .pigeon-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 14px;
      margin-top: 16px;
      padding: 8px 0;
    }
    .pigeon-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-radius: 10px;
      padding: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .pigeon-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #2b5cff 0%, #6366f1 100%);
    }
    .pigeon-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 32px rgba(43,92,255,0.15);
      border-color: #2b5cff;
    }
    .pigeon-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #f0f0f0;
    }
    .pigeon-card-header > div:first-child {
      flex: 1;
      min-width: 0;
    }
    .pigeon-card-name {
      font-size: 15px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 5px;
      line-height: 1.3;
      letter-spacing: -0.2px;
      word-break: break-word;
    }
    .pigeon-card-ring {
      font-size: 11px;
      color: #6b7280;
      font-family: 'Courier New', monospace;
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      display: inline-block;
    }
    .pigeon-card-info {
      margin-bottom: 10px;
      flex: 1;
      padding: 0;
    }
    .pigeon-card-info-item {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 0;
      display: flex !important;
      justify-content: space-between !important;
      align-items: center;
      padding: 6px 8px;
      line-height: 1.4;
      min-height: 32px;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }
    .pigeon-card-info-item:hover {
      background: #fafbfc;
    }
    .pigeon-card-info-item:last-child {
      border-bottom: none;
    }
    .pigeon-card-info-label {
      flex: 0 0 60px;
      color: #6b7280 !important;
      font-size: 11px !important;
      text-align: left !important;
      font-weight: 500;
      padding-right: 8px;
    }
    .pigeon-card-info-value {
      flex: 1;
      color: #1f2937 !important;
      font-weight: 500 !important;
      text-align: right !important;
      word-break: break-word;
      font-size: 12px !important;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .pigeon-card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: auto;
      padding-top: 10px;
      border-top: 1px solid #f0f0f0;
    }
    .pigeon-card-tags .tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 8px;
    }
    .tag-core {
      background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
      color: #7c3aed;
      border: 1px solid #e9d5ff;
      font-weight: 500;
    }
    .tag-recycled {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      color: #856404;
      border: 1px solid #ffeaa7;
      font-weight: 500;
    }
    @media (max-width: 768px) {
      .pigeon-cards {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .pigeon-card {
        padding: 14px;
      }
    }

    /* Êï∞ÊçÆÊ¶ÇÂÜµÁªüËÆ°Âç°ÁâáÊ†∑Âºè */
    .stats-cards { 
      display: grid; 
      grid-template-columns: repeat(5, 1fr); 
      gap: 20px; 
      margin-top: 8px;
    }
    @media (max-width: 1200px) {
      .stats-cards { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 800px) {
      .stats-cards { grid-template-columns: repeat(2, 1fr); }
    }
    .stat-card { 
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-radius: 12px; 
      padding: 24px 20px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e5e7eb;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #2b5cff 0%, #6366f1 100%);
    }
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    .stat-card-label { 
      font-size: 14px; 
      color: #6b7280; 
      margin-bottom: 12px; 
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .stat-card-number { 
      font-size: 36px; 
      font-weight: 700; 
      color: #1f2937; 
      line-height: 1.2;
      letter-spacing: -0.5px;
    }
    .stat-card:nth-child(1)::before { background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%); }
    .stat-card:nth-child(2)::before { background: linear-gradient(90deg, #10b981 0%, #059669 100%); }
    .stat-card:nth-child(3)::before { background: linear-gradient(90deg, #6b7280 0%, #4b5563 100%); }
    .stat-card:nth-child(4)::before { background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%); }
    .stat-card:nth-child(5)::before { background: linear-gradient(90deg, #8b5cf6 0%, #7c3aed 100%); }

    /* Âπ¥Â∫¶ÁªüËÆ°Ë°®Ê†º‰ºòÂåñ */
    #chartContainer {
      background: #fafbfc;
      border-radius: 8px;
    }
    #chartContainer table {
      width: 100%;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
    }
    #chartContainer table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      font-weight: 600;
      padding: 14px 16px;
      text-align: center;
    }
    #chartContainer table td {
      padding: 12px 16px;
      text-align: center;
      border-bottom: 1px solid #f0f0f0;
    }
    #chartContainer table tr:last-child td {
      border-bottom: none;
    }
    #chartContainer table tr:hover {
      background: #f8f9ff;
    }

    @media (max-width: 600px) {
      header { padding:12px 16px; }
      .card { padding:16px; }
      .field-label { width:80px; }
      .stats-cards { grid-template-columns: 1fr; gap: 16px; }
      .stat-card { padding: 20px 16px; }
      .stat-card-number { font-size: 28px; }
    }
    
    /* ÊØîËµõÁÆ°ÁêÜÊ†∑Âºè */
    .race-tab-btn {
      padding: 10px 20px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    .race-tab-btn:hover {
      color: #2b5cff;
      background: #f0f7ff;
    }
    .race-tab-btn.active {
      color: #2b5cff;
      border-bottom-color: #2b5cff;
      font-weight: 600;
    }
    .race-tab-content {
      display: none;
      padding: 20px 0;
    }
    .race-tab-content.active {
      display: block;
    }
    .race-card {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e5e7eb;
      transition: all 0.3s;
    }
    .race-card:hover {
      box-shadow: 0 4px 16px rgba(43,92,255,0.15);
      transform: translateY(-2px);
    }
    .race-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f0f0;
    }
    .race-card-title {
      font-size: 18px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
    }
    .race-card-meta {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      font-size: 13px;
      color: #6b7280;
    }
    .race-card-meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .participant-item {
      transition: all 0.2s;
    }
    .participant-item:hover {
      background: #f3f4f6 !important;
    }
    .stats-chart-container {
      background: #fff;
      border-radius: 10px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .analysis-conclusion {
      background: linear-gradient(135deg, #f0f7ff 0%, #e6f0ff 100%);
      border-left: 4px solid #2b5cff;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    .analysis-conclusion h4 {
      margin: 0 0 12px 0;
      color: #1f2937;
      font-size: 16px;
    }
    .analysis-conclusion p {
      margin: 8px 0;
      color: #4b5563;
      line-height: 1.6;
    }
    
    /* ÁπÅËÇ≤ÈÖçÂØπÊ®°ÂùóÊ†∑Âºè */
    .breeding-panel {
      padding: 20px 0;
    }
    .breeding-pigeon-card {
      transition: all 0.3s;
    }
    .breeding-pigeon-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }
    .breeding-pigeon-info {
      font-size: 13px;
      color: #4b5563;
    }
    .breeding-pigeon-info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .inbreeding-meter {
      height: 8px;
      border-radius: 4px;
      background: #e5e7eb;
      overflow: hidden;
      margin: 12px 0;
    }
    .inbreeding-meter-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    .inbreeding-low { background: linear-gradient(90deg, #10b981 0%, #34d399 100%); }
    .inbreeding-medium { background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%); }
    .inbreeding-high { background: linear-gradient(90deg, #ef4444 0%, #f87171 100%); }
    
    .pairing-history-item {
      display: grid;
      grid-template-columns: 1fr 1fr 2fr 1fr;
      gap: 16px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 12px;
      align-items: center;
    }
    .pairing-history-item:hover {
      background: #f0f7ff;
    }
    
    /* ÂÅ•Â∫∑ÁÆ°ÁêÜÊ®°ÂùóÊ†∑Âºè */
    .health-alert-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: #fff;
      border-radius: 10px;
      margin-bottom: 12px;
      border-left: 4px solid #e5e7eb;
      transition: all 0.2s;
    }
    .health-alert-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .health-alert-item.urgent {
      border-left-color: #ef4444;
      background: #fef2f2;
    }
    .health-alert-item.warning {
      border-left-color: #f59e0b;
      background: #fffbeb;
    }
    .health-alert-item.info {
      border-left-color: #3b82f6;
      background: #eff6ff;
    }
    
    .health-timeline-item {
      display: flex;
      gap: 20px;
      padding: 20px 0;
      border-bottom: 1px solid #f0f0f0;
      position: relative;
    }
    .health-timeline-item::before {
      content: '';
      position: absolute;
      left: 15px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #e5e7eb;
    }
    .health-timeline-item:last-child::before {
      display: none;
    }
    .health-timeline-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      z-index: 1;
      flex-shrink: 0;
    }
    .health-timeline-dot.vaccine { background: #dbeafe; }
    .health-timeline-dot.deworm { background: #fef3c7; }
    .health-timeline-dot.checkup { background: #d1fae5; }
    .health-timeline-dot.illness { background: #fee2e2; }
    .health-timeline-dot.medication { background: #e0e7ff; }
    .health-timeline-dot.recovery { background: #d1fae5; }
    
    /* Êô∫ËÉΩÂàÜÊûêÊ®°ÂùóÊ†∑Âºè */
    .insight-card {
      transition: all 0.3s;
    }
    .insight-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }
    
    .potential-item {
      display: grid;
      grid-template-columns: 50px 2fr 1fr 1fr 120px;
      gap: 16px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 10px;
      margin-bottom: 12px;
      align-items: center;
    }
    .potential-item:hover {
      background: #f0f7ff;
    }
    .potential-rank {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
    }
    .potential-rank.gold { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #fff; }
    .potential-rank.silver { background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); color: #fff; }
    .potential-rank.bronze { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: #fff; }
    .potential-rank.normal { background: #e5e7eb; color: #4b5563; }
    
    .potential-score {
      font-size: 18px;
      font-weight: 700;
      color: #2b5cff;
    }
    .potential-bar {
      height: 8px;
      border-radius: 4px;
      background: #e5e7eb;
      overflow: hidden;
    }
    .potential-bar-fill {
      height: 100%;
      border-radius: 4px;
      background: linear-gradient(90deg, #3b82f6 0%, #2b5cff 100%);
      transition: width 0.5s ease;
    }
    
    /* ExcelÂØºÂÖ•Ê†∑Âºè */
    .excel-import-zone {
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #fafafa;
    }
    .excel-import-zone:hover {
      border-color: #2b5cff;
      background: #f0f7ff;
    }
    .excel-import-zone.dragover {
      border-color: #2b5cff;
      background: #e6f0ff;
    }
    
    /* Êô∫ËÉΩÊêúÁ¥¢Ê†∑Âºè */
    .smart-search-container {
      position: relative;
    }
    .smart-search-input {
      width: 100%;
      padding: 14px 20px;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      font-size: 15px;
      outline: none;
      transition: all 0.3s;
    }
    .smart-search-input:focus {
      border-color: #2b5cff;
      box-shadow: 0 0 0 4px rgba(43,92,255,0.1);
    }
    .smart-search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      margin-top: 8px;
      max-height: 300px;
      overflow-y: auto;
      display: none;
      z-index: 100;
    }
    .smart-search-suggestions.show {
      display: block;
    }
    .search-suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }
    .search-suggestion-item:hover {
      background: #f0f7ff;
    }
    
    /* Ê†áÁ≠æËá™Âä®ÂåñÊ†∑Âºè */
    .auto-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }
    .auto-tag.stable { background: #d1fae5; color: #047857; }
    .auto-tag.core { background: #fef3c7; color: #b45309; }
    .auto-tag.potential { background: #dbeafe; color: #1e40af; }
    .auto-tag.warning { background: #fee2e2; color: #dc2626; }
    .auto-tag.champion { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #fff; }
    
    /* ==========================================
       üè† È¶ñÈ°µ ¬∑ ËµõÈ∏ΩËµÑËÆØ‰∏≠ÂøÉÊ†∑Âºè
       ========================================== */
    
    .home-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
      overflow-x: hidden;
      overflow-y: visible;
    }
    
    /* È°∂ÈÉ®‰ªäÊó•Ê¶ÇËßà */
    .home-overview {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 50%, #1e3a5f 100%);
      border-radius: 16px;
      padding: 24px 32px;
      color: #fff;
      box-shadow: 0 8px 32px rgba(30, 58, 95, 0.3);
    }
    .home-overview-left {
      display: flex;
      align-items: center;
      gap: 32px;
      flex: 1;
      margin-right: 32px;
    }
    .home-date {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .home-date-day {
      font-size: 56px;
      font-weight: 800;
      line-height: 1;
      background: linear-gradient(180deg, #fff 0%, #a0c4ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .home-date-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .home-date-weekday {
      font-size: 18px;
      font-weight: 600;
    }
    .home-date-full {
      font-size: 14px;
      opacity: 0.8;
    }
    .home-weather {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }
    .home-announcement-bubble {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      max-width: 300px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .home-announcement-bubble:hover {
      background: rgba(255,255,255,0.15);
      transform: translateY(-2px);
    }
    .home-announcement-icon {
      font-size: 24px;
      flex-shrink: 0;
    }
    .home-announcement-content {
      flex: 1;
      min-width: 0;
    }
    .home-announcement-text {
      font-weight: 600;
      font-size: 14px;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      word-break: break-word;
    }
    .home-announcement-hint {
      font-size: 11px;
      color: rgba(255,255,255,0.7);
      margin-top: 4px;
    }
    .home-overview-stats {
      display: flex;
      gap: 24px;
    }
    .home-stat-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }
    .home-stat-icon {
      font-size: 24px;
    }
    .home-stat-content {
      display: flex;
      flex-direction: column;
    }
    .home-stat-number {
      font-size: 24px;
      font-weight: 700;
    }
    .home-stat-label {
      font-size: 12px;
      opacity: 0.8;
    }
    
    /* ÈáçË¶ÅÂÖ¨Âëä */
    .home-announcement {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      background: linear-gradient(90deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 12px;
      border-left: 4px solid #f59e0b;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .home-announcement:hover {
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
      transform: translateY(-2px);
    }
    .announcement-icon {
      font-size: 20px;
    }
    .announcement-text {
      flex: 1;
      font-size: 14px;
      color: #92400e;
      font-weight: 500;
      line-height: 1.6;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      word-break: break-word;
    }
    
    /* ÂÖ¨ÂëäËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü */
    .announcement-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    .announcement-modal.active {
      display: flex;
    }
    .announcement-modal-content {
      background: #fff;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
    }
    .announcement-modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .announcement-modal-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .announcement-modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .announcement-modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    .announcement-modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }
    .announcement-modal-content-text {
      font-size: 15px;
      line-height: 1.8;
      color: #374151;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .announcement-modal-meta {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
      font-size: 13px;
      color: #6b7280;
      display: flex;
      gap: 16px;
    }
    
    /* ‰∏âÊ†èÂ∏ÉÂ±Ä */
    .home-content {
      display: grid;
      grid-template-columns: 1fr 1.2fr 320px;
      gap: 20px;
      min-height: 600px;
      width: 100%;
      overflow-x: hidden;
    }
    
    /* ÈÄöÁî®ÂàóÊ†∑Âºè */
    .home-column {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      overflow: visible;
      min-height: 400px;
      max-height: none;
    }
    .home-column-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #f0f0f0;
    }
    .home-column-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }
    .home-column-footer {
      padding: 16px;
      text-align: center;
      border-top: 1px solid #f0f0f0;
    }
    
    /* ËµÑËÆØÁ≠õÈÄâÊåâÈíÆ */
    .news-filter {
      display: flex;
      gap: 4px;
    }
    .news-filter-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 12px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .news-filter-btn:hover {
      background: #f3f4f6;
      color: #1f2937;
    }
    .news-filter-btn.active {
      background: #2b5cff;
      color: #fff;
    }
    
    /* Êú¨Âú∞/ÂÖ®ÂõΩËµÑËÆØÊ†áÁ≠æÈ°µ */
    .news-region-tabs {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #f9fafb;
      border-bottom: 1px solid #f0f0f0;
    }
    .news-region-tab {
      flex: 1;
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .news-region-tab:hover {
      background: #f3f4f6;
      color: #1f2937;
    }
    .news-region-tab.active {
      background: #2563eb;
      color: #fff;
    }
    
    /* ËµÑËÆØÂàóË°® */
    .home-news-list {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 12px;
      min-height: 200px;
      max-height: none;
    }
    .news-card {
      padding: 16px;
      border-radius: 12px;
      background: #f9fafb;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid transparent;
    }
    .news-card:hover {
      background: #f0f7ff;
      border-color: #dbeafe;
      transform: translateX(4px);
    }
    .news-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .news-card-title {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
      line-height: 1.4;
      flex: 1;
    }
    .news-card-time {
      font-size: 11px;
      color: #9ca3af;
      white-space: nowrap;
      margin-left: 12px;
    }
    .news-card-source {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .news-card-update-time {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .news-card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }
    .news-card-action-btn {
      flex: 1;
      padding: 6px 12px;
      border: 1px solid #d1d5db;
      background: #fff;
      color: #6b7280;
      font-size: 12px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .news-card-action-btn:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
      color: #1f2937;
    }
    .news-card-action-btn.primary {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }
    .news-card-action-btn.primary:hover {
      background: #1d4ed8;
      border-color: #1d4ed8;
    }
    
    /* ËµÑËÆØËØ¶ÊÉÖÂºπÁ™ó */
    .news-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .news-modal.active {
      display: flex;
    }
    .news-modal-content {
      background: #fff;
      border-radius: 16px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .news-modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .news-modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
      margin: 0;
    }
    .news-modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: #f3f4f6;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      color: #6b7280;
      transition: all 0.2s;
    }
    .news-modal-close:hover {
      background: #e5e7eb;
      color: #1f2937;
    }
    .news-modal-body {
      padding: 24px;
    }
    .news-modal-meta {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e5e7eb;
      flex-wrap: wrap;
    }
    .news-modal-meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #6b7280;
    }
    .news-modal-content-text {
      font-size: 15px;
      line-height: 1.8;
      color: #374151;
      margin-bottom: 24px;
    }
    .news-modal-footer {
      padding: 20px 24px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .news-card-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .news-tag {
      padding: 2px 8px;
      background: #e5e7eb;
      border-radius: 4px;
      font-size: 11px;
      color: #4b5563;
    }
    .news-tag.race { background: #dbeafe; color: #1e40af; }
    .news-tag.breeding { background: #fce7f3; color: #be185d; }
    .news-tag.health { background: #d1fae5; color: #047857; }
    .news-tag.hot { background: #fee2e2; color: #dc2626; }
    
    /* Ëµõ‰∫ãÂú∞Âå∫Ê†áÁ≠æÈ°µ */
    .event-region-tabs {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #f9fafb;
      border-bottom: 1px solid #f0f0f0;
    }
    .event-region-tab {
      flex: 1;
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .event-region-tab:hover {
      background: #f3f4f6;
      color: #1f2937;
    }
    .event-region-tab.active {
      background: #2563eb;
      color: #fff;
    }
    
    /* Ëµõ‰∫ãÊ†áÁ≠æÈ°µ */
    .event-tabs {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
      background: #f9fafb;
    }
    .event-tab-btn {
      flex: 1;
      padding: 10px 12px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 13px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
      font-weight: 500;
    }
    .event-tab-btn:hover {
      background: #fff;
      color: #1f2937;
    }
    .event-tab-btn.active {
      background: #fff;
      color: #2b5cff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    /* Ëµõ‰∫ãÂàóË°® */
    .home-events-list {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 12px;
      min-height: 200px;
      max-height: none;
    }
    .event-card {
      padding: 16px;
      border-radius: 12px;
      background: #fff;
      margin-bottom: 12px;
      border: 1px solid #e5e7eb;
      transition: all 0.3s;
    }
    .event-card:hover {
      border-color: #2b5cff;
      box-shadow: 0 4px 16px rgba(43,92,255,0.12);
    }
    .event-card-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .event-card-status.ongoing {
      background: #d1fae5;
      color: #047857;
    }
    .event-card-status.ongoing::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #10b981;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .event-card-status.upcoming {
      background: #dbeafe;
      color: #1e40af;
    }
    .event-card-status.completed {
      background: #f3f4f6;
      color: #4b5563;
    }
    .event-card-title {
      font-size: 15px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
    }
    .event-card-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 13px;
      color: #6b7280;
    }
    .event-card-info-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .event-card-progress {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #f0f0f0;
    }
    .event-progress-bar {
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 6px;
    }
    .event-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
      border-radius: 3px;
      transition: width 0.5s;
    }
    .event-progress-text {
      font-size: 12px;
      color: #6b7280;
      text-align: center;
    }
    
    /* Âè≥‰æßÂ∞èÈÉ®‰ª∂ */
    .home-sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 16px;
      background: #f9fafb;
    }
    .home-widget {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }
    .home-widget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-bottom: 1px solid #e5e7eb;
    }
    .home-widget-header h4 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }
    .home-widget-content {
      padding: 14px 16px;
    }
    
    /* ËÆ¢ÈòÖÊ†áÁ≠æ */
    .subscription-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .subscription-tag {
      padding: 6px 12px;
      background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
      border-radius: 999px;
      font-size: 12px;
      color: #1e40af;
      font-weight: 500;
    }
    .subscription-tag.add-tag {
      background: #f3f4f6;
      color: #6b7280;
      cursor: pointer;
      border: 1px dashed #d1d5db;
    }
    .subscription-tag.add-tag:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }
    
    /* Âø´Êç∑ÂÖ•Âè£ */
    .quick-links {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .quick-link-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 14px 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
      color: #4b5563;
    }
    .quick-link-btn:hover {
      background: #f0f7ff;
      border-color: #2b5cff;
      color: #2b5cff;
      transform: translateY(-2px);
    }
    .quick-link-btn span:first-child {
      font-size: 24px;
    }
    
    /* Êé®ËçêÂç°Áâá */
    .recommendation-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .recommendation-item:hover {
      background: #f0f7ff;
    }
    .recommendation-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }
    .recommendation-icon.race { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
    .recommendation-icon.pigeon { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); }
    .recommendation-icon.breeding { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); }
    .recommendation-content {
      flex: 1;
    }
    .recommendation-title {
      font-size: 13px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .recommendation-desc {
      font-size: 11px;
      color: #6b7280;
    }
    
    /* ‰ªäÊó•ÊèêÈÜí */
    .alert-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: #fff;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 3px solid #e5e7eb;
      font-size: 13px;
    }
    .alert-item.urgent { border-left-color: #ef4444; background: #fef2f2; }
    .alert-item.warning { border-left-color: #f59e0b; background: #fffbeb; }
    .alert-item.info { border-left-color: #3b82f6; background: #eff6ff; }
    .alert-item-icon { font-size: 16px; }
    .alert-item-text { flex: 1; color: #4b5563; }
    
    /* ==========================================
       üì± ÂìçÂ∫îÂºèËÆæËÆ° - ÂÆåÊï¥Êñ≠ÁÇπÁ≥ªÁªü
       ========================================== */
    
    /* Ë∂ÖÂ§ßÂ±èÂπï‰ºòÂåñ (1400px+) */
    @media (min-width: 1400px) {
      .content-wrapper {
        max-width: 1800px;
      }
      .home-content {
        grid-template-columns: 1.2fr 1.4fr 360px;
        gap: 24px;
      }
    }
    
    /* Â§ßÂ±èÂπï (1200px - 1399px) */
    @media (max-width: 1399px) and (min-width: 1200px) {
      .home-content {
        grid-template-columns: 1fr 1.1fr 300px;
        gap: 18px;
      }
    }
    
    /* ‰∏≠Á≠âÂ±èÂπï - Âπ≥ÊùøÊ®™Â±è (992px - 1199px) */
    @media (max-width: 1199px) and (min-width: 992px) {
      .home-content {
        grid-template-columns: 1fr 1fr;
        gap: 18px;
      }
      .home-sidebar {
        grid-column: span 2;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        padding: 16px;
      }
      .home-widget {
        min-width: 0;
      }
      .home-overview-left {
        gap: 24px;
        margin-right: 24px;
      }
      .home-overview-stats {
        gap: 16px;
      }
      .home-stat-item {
        padding: 10px 16px;
      }
    }
    
    /* Â∞èÂ±èÂπï - Âπ≥ÊùøÁ´ñÂ±è (768px - 991px) */
    @media (max-width: 991px) and (min-width: 768px) {
      /* ‰æßËæπÊ†èÂú®‰∏≠Á≠âÂ±èÂπï‰øùÊåÅÊòæÁ§∫Ôºå‰ΩÜÂèØ‰ª•Áº©Â∞è */
      .sidebar {
        width: 220px;
      }
      .main-content {
        margin-left: 220px;
        overflow-x: hidden;
      }
      
      .home-section {
        overflow-x: hidden;
        width: 100%;
      }
      
      .home-content {
        grid-template-columns: 1fr;
        gap: 16px;
        min-height: auto;
        width: 100%;
      }
      
      .home-column {
        overflow: visible;
        min-height: auto;
      }
      
      .home-news-list,
      .home-events-list {
        overflow-y: auto;
        max-height: 600px;
      }
      .home-sidebar {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        padding: 16px;
      }
      .home-widget {
        min-width: 0;
      }
      .home-overview {
        flex-direction: column;
        gap: 16px;
        padding: 20px 24px;
      }
      .home-overview-left {
        width: 100%;
        margin-right: 0;
        justify-content: space-between;
      }
      .home-overview-stats {
        width: 100%;
        flex-wrap: wrap;
        justify-content: space-around;
        gap: 12px;
      }
      .home-stat-item {
        flex: 1;
        min-width: 140px;
        padding: 10px 14px;
      }
      .home-date-day {
        font-size: 48px;
      }
      .home-date-weekday {
        font-size: 16px;
      }
      .news-filter {
        flex-wrap: wrap;
        gap: 4px;
      }
      .news-filter-btn {
        font-size: 11px;
        padding: 5px 10px;
      }
      .event-tabs {
        flex-wrap: wrap;
      }
      .event-tab-btn {
        font-size: 12px;
        padding: 8px 10px;
      }
      .quick-links {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* ‰∏≠Á≠âÂ±èÂπï‰ºòÂåñ (992px - 1199px) - ‰æßËæπÊ†è‰øùÊåÅÊòæÁ§∫ */
    @media (max-width: 1199px) and (min-width: 992px) {
      .sidebar {
        width: 240px;
      }
      .main-content {
        margin-left: 240px;
      }
      .top-header {
        padding: 0 20px;
      }
      .top-header h1 {
        font-size: 16px;
      }
      .top-header-actions {
        gap: 8px;
      }
      .top-header-actions .btn {
        padding: 8px 12px;
        font-size: 12px;
      }
      /* ÊêúÁ¥¢Ê°ÜÂú®‰∏≠Á≠âÂ±èÂπïÂèØ‰ª•Á®çÂæÆÁº©Â∞è */
      .smart-search-container {
        max-width: 300px;
      }
    }
    
    /* Â∞èÂ±èÂπï‰ºòÂåñ (768px - 991px) - È°∂ÈÉ®ÂØºËà™Ê†è */
    @media (max-width: 991px) and (min-width: 768px) {
      .top-header {
        padding: 0 16px;
      }
      .top-header h1 {
        font-size: 15px;
      }
      .top-header-actions .btn {
        padding: 6px 10px;
        font-size: 11px;
      }
      .smart-search-container {
        max-width: 200px;
      }
    }
    
    /* ÁßªÂä®Á´Ø - Â§ßÊâãÊú∫ (576px - 767px) */
    @media (max-width: 767px) and (min-width: 576px) {
      /* Á°Æ‰øù‰æßËæπÊ†èÂú®ÁßªÂä®Á´ØÈöêËóè */
      .sidebar {
        transform: translateX(-100%);
        width: 280px;
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
        padding: 12px;
        overflow-x: hidden;
        overflow-y: visible;
      }
      
      .home-section {
        overflow-x: hidden;
        overflow-y: visible;
        width: 100%;
      }
      
      .home-content {
        grid-template-columns: 1fr;
        gap: 16px;
        min-height: auto;
        width: 100%;
        overflow-x: hidden;
        display: grid !important;
        visibility: visible !important;
      }
      
      .home-column {
        overflow: visible;
        min-height: auto;
        max-height: none;
        width: 100%;
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        height: auto !important;
      }
      
      .home-news-list,
      .home-events-list {
        overflow-y: visible;
        max-height: none;
        min-height: auto;
        display: block !important;
        visibility: visible !important;
      }
      .home-sidebar {
        display: flex !important;
        flex-direction: column;
        gap: 12px;
        padding: 12px;
        visibility: visible !important;
      }
      .home-widget {
        min-width: 0;
        display: block !important;
        visibility: visible !important;
      }
      
      .home-widget-header {
        display: flex !important;
        visibility: visible !important;
      }
      
      .home-widget-content {
        display: block !important;
        visibility: visible !important;
      }
      
      /* Á°Æ‰øùÈ¶ñÈ°µÂíåÊâÄÊúâÊ®°ÂùóÂèØËßÅ */
      #homeView {
        display: flex !important;
        visibility: visible !important;
      }
      
      .home-section {
        display: flex !important;
        visibility: visible !important;
      }
      
      .recommendation-item,
      .subscription-tags,
      .quick-links,
      .alert-item {
        display: flex !important;
        visibility: visible !important;
      }
      .home-overview {
        flex-direction: column;
        gap: 16px;
        padding: 16px 20px;
        border-radius: 12px;
      }
      .home-overview-left {
        width: 100%;
        margin-right: 0;
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      .home-date {
        width: 100%;
      }
      .home-date-day {
        font-size: 42px;
      }
      .home-weather,
      .home-announcement-bubble {
        width: 100%;
        max-width: 100%;
      }
      .home-overview-stats {
        width: 100% !important;
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
        visibility: visible !important;
        opacity: 1 !important;
        margin-top: 16px !important;
      }
      .home-stat-item {
        width: 100% !important;
        padding: 10px 12px !important;
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      .home-stat-number {
        font-size: 20px !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      .home-stat-label {
        font-size: 11px !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      .home-column-header {
        padding: 12px 16px;
        flex-wrap: wrap;
        gap: 8px;
      }
      .home-column-header h3 {
        font-size: 15px;
      }
      .news-filter {
        width: 100%;
        order: 2;
        margin-top: 8px;
      }
      .news-filter-btn {
        flex: 1;
        font-size: 11px;
        padding: 6px 8px;
      }
      .news-region-tabs,
      .event-region-tabs {
        padding: 10px 12px;
      }
      .news-region-tab,
      .event-region-tab {
        font-size: 12px;
        padding: 6px 12px;
      }
      .event-tabs {
        padding: 10px 12px;
        flex-wrap: wrap;
      }
      .event-tab-btn {
        flex: 1;
        min-width: calc(33.333% - 4px);
        font-size: 11px;
        padding: 8px 6px;
      }
      .news-card,
      .event-card {
        padding: 12px;
        margin-bottom: 10px;
      }
      .news-card-title {
        font-size: 13px;
      }
      .event-card-title {
        font-size: 14px;
      }
      .event-card-info {
        grid-template-columns: 1fr;
        gap: 6px;
      }
      .quick-links {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      .quick-link-btn {
        padding: 12px 8px;
        font-size: 11px;
      }
      .quick-link-btn span:first-child {
        font-size: 20px;
      }
      .subscription-tags {
        gap: 6px;
      }
      .subscription-tag {
        font-size: 11px;
        padding: 5px 10px;
      }
    }
    
    /* ÁßªÂä®Á´Ø - Â∞èÊâãÊú∫ (< 576px) */
    @media (max-width: 575px) {
      /* Á°Æ‰øù‰æßËæπÊ†èÂú®Ë∂ÖÂ∞èÂ±èÂπïÈöêËóè */
      .sidebar {
        transform: translateX(-100%);
        width: 260px;
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
        padding: 8px;
        overflow-x: hidden;
        overflow-y: visible;
      }
      
      .home-section {
        overflow-x: hidden;
        overflow-y: visible;
        width: 100%;
      }
      
      .home-content {
        grid-template-columns: 1fr;
        gap: 12px;
        min-height: auto;
        width: 100%;
        overflow-x: hidden;
      }
      
      .home-column {
        overflow: visible;
        min-height: auto;
        max-height: none;
        width: 100%;
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        height: auto !important;
      }
      
      .home-news-list,
      .home-events-list {
        overflow-y: visible;
        max-height: none;
        min-height: auto;
        display: block !important;
        visibility: visible !important;
      }
      .home-sidebar {
        display: flex !important;
        flex-direction: column;
        gap: 12px;
        padding: 12px;
        visibility: visible !important;
      }
      .home-widget {
        min-width: 0;
        display: block !important;
        visibility: visible !important;
      }
      
      .home-widget-header {
        display: flex !important;
        visibility: visible !important;
      }
      
      .home-widget-content {
        display: block !important;
        visibility: visible !important;
      }
      
      /* Á°Æ‰øùÈ¶ñÈ°µÂíåÊâÄÊúâÊ®°ÂùóÂèØËßÅ */
      #homeView {
        display: flex !important;
        visibility: visible !important;
      }
      
      .home-section {
        display: flex !important;
        visibility: visible !important;
      }
      
      .home-content {
        display: grid !important;
        visibility: visible !important;
      }
      
      .recommendation-item,
      .subscription-tags,
      .quick-links,
      .alert-item {
        display: flex !important;
        visibility: visible !important;
      }
      .home-widget-header {
        padding: 12px;
        display: flex !important;
        visibility: visible !important;
      }
      .home-widget-header h4 {
        font-size: 13px;
      }
      .home-widget-content {
        padding: 12px;
        display: block !important;
        visibility: visible !important;
      }
      /* Á°Æ‰øùÊâÄÊúâÈ¶ñÈ°µÊ®°ÂùóÈÉΩÂèØËßÅ */
      .home-column {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        height: auto !important;
        min-height: auto !important;
      }
      .home-content {
        display: grid !important;
        visibility: visible !important;
        grid-template-columns: 1fr !important;
      }
      .home-section {
        display: flex !important;
        visibility: visible !important;
        flex-direction: column !important;
      }
      .home-overview {
        flex-direction: column;
        gap: 12px;
        padding: 16px;
        border-radius: 12px;
      }
      .home-overview-left {
        width: 100%;
        margin-right: 0;
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      .home-date {
        width: 100%;
      }
      .home-date-day {
        font-size: 36px;
      }
      .home-date-weekday {
        font-size: 14px;
      }
      .home-date-full {
        font-size: 12px;
      }
      .home-weather,
      .home-announcement-bubble {
        width: 100%;
        max-width: 100%;
        padding: 10px 16px;
      }
      .home-weather span {
        font-size: 24px;
      }
      .home-overview-stats {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      .home-stat-item {
        width: 100%;
        padding: 10px;
        flex-direction: column;
        text-align: center;
        gap: 8px;
      }
      .home-stat-icon {
        font-size: 20px;
      }
      .home-stat-number {
        font-size: 18px;
      }
      .home-stat-label {
        font-size: 10px;
      }
      .home-column {
        border-radius: 12px;
      }
      .home-column-header {
        padding: 12px;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .home-column-header h3 {
        font-size: 14px;
        width: 100%;
      }
      .news-filter {
        width: 100%;
        order: 2;
        margin-top: 8px;
        flex-wrap: wrap;
      }
      .news-filter-btn {
        flex: 1;
        min-width: calc(50% - 2px);
        font-size: 10px;
        padding: 5px 6px;
      }
      .news-region-tabs,
      .event-region-tabs {
        padding: 8px 10px;
        gap: 6px;
      }
      .news-region-tab,
      .event-region-tab {
        font-size: 11px;
        padding: 6px 10px;
      }
      .event-tabs {
        padding: 8px 10px;
        flex-wrap: wrap;
        gap: 4px;
      }
      .event-tab-btn {
        flex: 1;
        min-width: calc(50% - 2px);
        font-size: 10px;
        padding: 6px 4px;
      }
      .home-news-list,
      .home-events-list {
        padding: 10px;
      }
      .news-card,
      .event-card {
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 10px;
      }
      .news-card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
      .news-card-title {
        font-size: 12px;
        width: 100%;
      }
      .news-card-time {
        margin-left: 0;
        font-size: 10px;
      }
      .news-card-source {
        font-size: 11px;
      }
      .news-card-actions {
        flex-direction: column;
        gap: 6px;
      }
      .news-card-action-btn {
        width: 100%;
        font-size: 11px;
        padding: 6px;
      }
      .event-card-title {
        font-size: 13px;
      }
      .event-card-info {
        grid-template-columns: 1fr;
        gap: 6px;
        font-size: 12px;
      }
      .event-card-status {
        font-size: 10px;
        padding: 3px 8px;
      }
      .home-column-footer {
        padding: 12px;
      }
      .home-column-footer .btn {
        width: 100%;
        margin: 4px 0;
      }
      .quick-links {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .quick-link-btn {
        padding: 12px;
        flex-direction: row;
        justify-content: flex-start;
        text-align: left;
      }
      .quick-link-btn span:first-child {
        font-size: 24px;
        margin-right: 12px;
      }
      .subscription-tags {
        gap: 6px;
      }
      .subscription-tag {
        font-size: 10px;
        padding: 4px 8px;
      }
      .recommendation-item {
        padding: 10px;
        gap: 10px;
      }
      .recommendation-icon {
        width: 36px;
        height: 36px;
        font-size: 18px;
      }
      .recommendation-title {
        font-size: 12px;
      }
      .recommendation-desc {
        font-size: 10px;
      }
      .alert-item {
        padding: 8px 10px;
        font-size: 12px;
      }
    }
    
    /* ==========================================
       ‚ú® ÂÖ®Â±ÄÂä®ÁîªÊïàÊûú
       ========================================== */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px rgba(37, 99, 235, 0.3); }
      50% { box-shadow: 0 0 20px rgba(37, 99, 235, 0.6); }
    }
    
    /* È™®Êû∂Â±èÊïàÊûú */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius-md);
    }
    
    /* ÊÇ¨ÊµÆÊïàÊûúÂ¢ûÂº∫ */
    .hover-lift {
      transition: all var(--transition-normal);
    }
    .hover-lift:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
    }
    
    .hover-glow {
      transition: all var(--transition-normal);
    }
    .hover-glow:hover {
      box-shadow: var(--shadow-glow);
    }
    
    /* ==========================================
       üåô Ê∑±Ëâ≤Ê®°ÂºèÂ¢ûÂº∫Ê†∑Âºè
       ========================================== */
    [data-theme="dark"] {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-light: #334155;
      --border-medium: #475569;
      --gray-50: #1e293b;
      --gray-100: #334155;
      --gray-200: #475569;
    }
    
    [data-theme="dark"] .top-header {
      background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #020617 100%);
      border-bottom-color: rgba(255,255,255,0.05);
    }
    
    [data-theme="dark"] .sidebar {
      background: #1e293b;
      border-right-color: #334155;
    }
    
    [data-theme="dark"] .sidebar-item:hover {
      background: #334155;
    }
    
    [data-theme="dark"] .card {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%);
      border-color: #334155;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    /* ‰∏∫‰∏çÂêåÁ±ªÂûãÁöÑÂç°ÁâáÊ∑ªÂä†‰∏çÂêåÁöÑÊ∑±Ëâ≤Ê∏êÂèò */
    [data-theme="dark"] .card:nth-of-type(1),
    [data-theme="dark"] .card:nth-child(1) {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%);
      border-color: #3b82f6;
    }
    
    [data-theme="dark"] .card:nth-of-type(2),
    [data-theme="dark"] .card:nth-child(2) {
      background: linear-gradient(135deg, #064e3b 0%, #1e293b 50%, #0f172a 100%);
      border-color: #10b981;
    }
    
    [data-theme="dark"] .card:nth-of-type(3),
    [data-theme="dark"] .card:nth-child(3) {
      background: linear-gradient(135deg, #78350f 0%, #1e293b 50%, #0f172a 100%);
      border-color: #f59e0b;
    }
    
    [data-theme="dark"] .card:nth-of-type(4),
    [data-theme="dark"] .card:nth-child(4) {
      background: linear-gradient(135deg, #5b2845 0%, #1e293b 50%, #0f172a 100%);
      border-color: #ec4899;
    }
    
    [data-theme="dark"] .card:nth-of-type(5),
    [data-theme="dark"] .card:nth-child(5) {
      background: linear-gradient(135deg, #3b2764 0%, #1e293b 50%, #0f172a 100%);
      border-color: #a855f7;
    }
    
    [data-theme="dark"] .card:nth-of-type(6),
    [data-theme="dark"] .card:nth-child(6) {
      background: linear-gradient(135deg, #0c4a6e 0%, #1e293b 50%, #0f172a 100%);
      border-color: #0ea5e9;
    }
    
    [data-theme="dark"] .card:hover {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      transform: translateY(-2px);
    }
    
    [data-theme="dark"] table th {
      background: #334155;
    }
    
    [data-theme="dark"] table tr:hover {
      background: #334155;
    }
    
    [data-theme="dark"] .form-group input,
    [data-theme="dark"] .form-group select,
    [data-theme="dark"] .form-group textarea {
      background: #334155;
      border-color: #475569;
      color: #f1f5f9;
    }
    
    [data-theme="dark"] .section-title {
      background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
    }
    
    [data-theme="dark"] .news-card {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%) !important;
      border-color: #3b82f6 !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }
    [data-theme="dark"] .news-card:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1e3a5f 50%, #1e293b 100%) !important;
      border-color: #60a5fa !important;
      box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3) !important;
    }
    
    [data-theme="dark"] .news-card-actions {
      border-top-color: #334155 !important;
    }
    
    [data-theme="dark"] .news-card-action-btn {
      background: linear-gradient(135deg, #334155 0%, #1e293b 100%) !important;
      border-color: #475569 !important;
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] .news-card-action-btn:hover {
      background: linear-gradient(135deg, #475569 0%, #334155 100%) !important;
      border-color: #60a5fa !important;
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .news-card-action-btn.primary {
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%) !important;
      border-color: #2563eb !important;
      color: #fff !important;
    }
    
    [data-theme="dark"] .news-card-action-btn.primary:hover {
      background: linear-gradient(135deg, #1d4ed8 0%, #1e3a8a 100%) !important;
      border-color: #1d4ed8 !important;
    }
    
    [data-theme="dark"] .event-card {
      background: linear-gradient(135deg, #064e3b 0%, #1e293b 50%, #0f172a 100%);
      border-color: #10b981;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    [data-theme="dark"] .event-card:hover {
      background: linear-gradient(135deg, #059669 0%, #064e3b 50%, #1e293b 100%);
      border-color: #34d399;
      box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
    }
    
    [data-theme="dark"] .home-overview {
      background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #1e293b 100%);
    }
    
    [data-theme="dark"] .home-column {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%);
      border-color: #3b82f6;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    [data-theme="dark"] .home-sidebar {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
    }
    
    [data-theme="dark"] .home-widget {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%);
      border-color: #3b82f6;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    [data-theme="dark"] .home-widget-header {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%);
      border-bottom-color: #3b82f6;
    }
    
    [data-theme="dark"] .home-widget-content {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%);
      color: #e2e8f0 !important;
    }
    
    /* ËÆ¢ÈòÖÊ†áÁ≠æ‰ΩøÁî®Ê∑±Ëâ≤Ê∏êÂèò */
    [data-theme="dark"] .subscription-tags {
      background: transparent !important;
    }
    
    [data-theme="dark"] .subscription-tag,
    [data-theme="dark"] [class*="subscription-tag"] {
      background: linear-gradient(135deg, #334155 0%, #1e293b 100%) !important;
      border-color: #475569 !important;
      color: #cbd5e1 !important;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
    }
    
    [data-theme="dark"] .subscription-tag:hover,
    [data-theme="dark"] [class*="subscription-tag"]:hover {
      background: linear-gradient(135deg, #475569 0%, #334155 100%) !important;
      border-color: #60a5fa !important;
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .quick-link-btn {
      background: #334155;
      border-color: #475569;
      color: #94a3b8;
    }
    [data-theme="dark"] .quick-link-btn:hover {
      background: #475569;
      color: var(--primary-light);
    }
    
    [data-theme="dark"] .home-announcement {
      background: linear-gradient(90deg, #78350f 0%, #92400e 100%);
      border-left-color: #f59e0b;
    }
    [data-theme="dark"] .announcement-text {
      color: #fef3c7;
    }
    
    /* ÂÖ¨ÂëäÊ®°ÊÄÅÊ°ÜÊöóËâ≤Ê®°Âºè */
    [data-theme="dark"] .announcement-modal-content {
      background: #1e293b !important;
    }
    [data-theme="dark"] .announcement-modal-header {
      background: linear-gradient(135deg, #4c1d95 0%, #5b21b6 100%) !important;
    }
    [data-theme="dark"] .announcement-modal-body {
      background: #1e293b !important;
    }
    [data-theme="dark"] .announcement-modal-content-text {
      color: #f1f5f9 !important;
    }
    [data-theme="dark"] .announcement-modal-meta {
      border-top-color: #334155 !important;
      color: #94a3b8 !important;
    }
    [data-theme="dark"] #announcementModal > div {
      background: #1e293b !important;
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] #announcementModal h3 {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] #announcementContent {
      background: #334155 !important;
      border-color: #475569 !important;
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] #announcementContent::placeholder {
      color: #94a3b8 !important;
    }
    
    /* Áî®Êà∑‰ø°ÊÅØÂíåËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÊöóËâ≤Ê®°Âºè */
    [data-theme="dark"] #userInfoModal .announcement-modal-content,
    [data-theme="dark"] #settingsModal .announcement-modal-content {
      background: #1e293b !important;
      color: #f1f5f9 !important;
    }
    [data-theme="dark"] #userInfoModal .announcement-modal-body,
    [data-theme="dark"] #settingsModal .announcement-modal-body {
      color: #f1f5f9 !important;
    }
    [data-theme="dark"] #userInfoModal h4,
    [data-theme="dark"] #settingsModal h4 {
      color: #f1f5f9 !important;
      border-bottom-color: #475569 !important;
    }
    [data-theme="dark"] #userInfoModal .announcement-modal-body > div > div,
    [data-theme="dark"] #settingsModal .announcement-modal-body > div > div {
      border-bottom-color: #334155 !important;
    }
    [data-theme="dark"] #userInfoModal .announcement-modal-body span,
    [data-theme="dark"] #settingsModal .announcement-modal-body span {
      color: #94a3b8 !important;
    }
    [data-theme="dark"] #userInfoModal .announcement-modal-body p,
    [data-theme="dark"] #settingsModal .announcement-modal-body p {
      color: #cbd5e1 !important;
    }
    [data-theme="dark"] #settingsModal .announcement-modal-body > div > div[style*="background"] {
      background: #0f172a !important;
    }
    
    /* ËÆæÁΩÆÁïåÈù¢Ê†∑Âºè */
    .settings-section {
      margin-bottom: 32px;
    }
    
    .settings-section:last-child {
      margin-bottom: 0;
    }
    
    .settings-section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .settings-section-icon {
      font-size: 20px;
      line-height: 1;
    }
    
    .settings-section-title {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
    }
    
    .settings-section-content {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .settings-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #f9fafb;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    
    .settings-item:hover {
      background: #f3f4f6;
    }
    
    .settings-item-info {
      flex: 1;
      min-width: 0;
    }
    
    .settings-item-label {
      font-size: 14px;
      font-weight: 500;
      color: #1f2937;
      margin-bottom: 4px;
    }
    
    .settings-item-desc {
      font-size: 12px;
      color: #6b7280;
      line-height: 1.4;
    }
    
    .settings-select {
      padding: 6px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: #fff;
      color: #1f2937;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .settings-select:hover {
      border-color: #667eea;
    }
    
    .settings-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .settings-switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 24px;
      cursor: pointer;
    }
    
    .settings-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .settings-switch-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e1;
      transition: 0.3s;
      border-radius: 24px;
    }
    
    .settings-switch-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }
    
    .settings-switch input:checked + .settings-switch-slider {
      background-color: #667eea;
    }
    
    .settings-switch input:checked + .settings-switch-slider:before {
      transform: translateX(24px);
    }
    
    .settings-switch input:focus + .settings-switch-slider {
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    }
    
    /* ÊöóËâ≤Ê®°Âºè‰∏ãÁöÑËÆæÁΩÆÁïåÈù¢Ê†∑Âºè */
    [data-theme="dark"] .settings-section-header {
      border-bottom-color: #475569;
    }
    
    [data-theme="dark"] .settings-section-title {
      color: #f1f5f9;
    }
    
    [data-theme="dark"] .settings-item {
      background: #1e293b;
    }
    
    [data-theme="dark"] .settings-item:hover {
      background: #334155;
    }
    
    [data-theme="dark"] .settings-item-label {
      color: #f1f5f9;
    }
    
    [data-theme="dark"] .settings-item-desc {
      color: #94a3b8;
    }
    
    [data-theme="dark"] .settings-select {
      background: #1e293b;
      border-color: #475569;
      color: #f1f5f9;
    }
    
    [data-theme="dark"] .settings-select:hover {
      border-color: #667eea;
    }
    
    [data-theme="dark"] .settings-switch-slider {
      background-color: #475569;
    }
    
    [data-theme="dark"] .settings-switch input:checked + .settings-switch-slider {
      background-color: #667eea;
    }
    
    [data-theme="dark"] .race-modal .modal-content {
      background: #1e293b;
    }
    
    [data-theme="dark"] .breeding-pigeon-card.male-card {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%) !important;
      border-color: #3b82f6 !important;
    }
    
    [data-theme="dark"] .breeding-pigeon-card.male-card h3 {
      color: #e0e7ff !important;
    }
    
    [data-theme="dark"] .breeding-pigeon-card.male-card span[style*="font-size:32px"],
    [data-theme="dark"] .breeding-pigeon-card.male-card span[style*="font-size: 32px"] {
      color: #93c5fd !important;
      filter: brightness(1.5) !important;
      opacity: 1 !important;
    }
    
    [data-theme="dark"] .breeding-pigeon-card.male-card span[style*="color:#6b7280"],
    [data-theme="dark"] .breeding-pigeon-card.male-card span[style*="color: #6b7280"] {
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] .breeding-pigeon-card.female-card {
      background: linear-gradient(135deg, #5b2845 0%, #1e293b 100%) !important;
      border-color: #ec4899 !important;
    }
    
    [data-theme="dark"] .breeding-pigeon-card.female-card h3 {
      color: #fce7f3 !important;
    }
    
    [data-theme="dark"] .breeding-pigeon-card.female-card span[style*="font-size:32px"],
    [data-theme="dark"] .breeding-pigeon-card.female-card span[style*="font-size: 32px"] {
      color: #f9a8d4 !important;
      filter: brightness(1.5) !important;
      opacity: 1 !important;
    }
    
    [data-theme="dark"] .breeding-pigeon-card.female-card span[style*="color:#6b7280"],
    [data-theme="dark"] .breeding-pigeon-card.female-card span[style*="color: #6b7280"] {
      color: #f1d5e7 !important;
    }
    
    [data-theme="dark"] .breeding-assessment {
      background: linear-gradient(135deg, #3b2764 0%, #1e293b 100%) !important;
      border-color: #a855f7 !important;
    }
    
    [data-theme="dark"] .breeding-assessment h3 {
      color: #e9d5ff !important;
    }
    
    [data-theme="dark"] .breeding-assessment span[style*="font-size:48px"],
    [data-theme="dark"] .breeding-assessment span[style*="font-size: 48px"],
    [data-theme="dark"] .breeding-assessment span[style*="font-size:32px"],
    [data-theme="dark"] .breeding-assessment span[style*="font-size: 32px"] {
      filter: brightness(1.5) !important;
      opacity: 1 !important;
    }
    
    [data-theme="dark"] .breeding-assessment div[style*="color:#9ca3af"],
    [data-theme="dark"] .breeding-assessment div[style*="color: #9ca3af"] {
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] .breeding-assessment p {
      color: #cbd5e1 !important;
    }
    
    /* Ë¶ÜÁõñÊâÄÊúâÂÜÖËÅîÊ†∑Âºè‰∏≠ÁöÑÊµÖËâ≤ËÉåÊôØ */
    [data-theme="dark"] [style*="background:linear-gradient(135deg, #dbeafe"],
    [data-theme="dark"] [style*="background: linear-gradient(135deg, #dbeafe"] {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%) !important;
    }
    
    [data-theme="dark"] [style*="background:linear-gradient(135deg, #fce7f3"],
    [data-theme="dark"] [style*="background: linear-gradient(135deg, #fce7f3"] {
      background: linear-gradient(135deg, #5b2845 0%, #1e293b 100%) !important;
    }
    
    [data-theme="dark"] [style*="background:linear-gradient(135deg, #fdf4ff"],
    [data-theme="dark"] [style*="background: linear-gradient(135deg, #fdf4ff"] {
      background: linear-gradient(135deg, #3b2764 0%, #1e293b 100%) !important;
    }
    
    /* Ë¶ÜÁõñÂÜÖËÅîÊ†∑Âºè‰∏≠ÁöÑÊ∑±Ëâ≤ÊñáÂ≠ó */
    [data-theme="dark"] [style*="color:#1e40af"],
    [data-theme="dark"] [style*="color: #1e40af"] {
      color: #e0e7ff !important;
    }
    
    [data-theme="dark"] [style*="color:#be185d"],
    [data-theme="dark"] [style*="color: #be185d"] {
      color: #fce7f3 !important;
    }
    
    [data-theme="dark"] [style*="color:#7e22ce"],
    [data-theme="dark"] [style*="color: #7e22ce"] {
      color: #e9d5ff !important;
    }
    
    /* Ë¶ÜÁõñÊâÄÊúâÂ§ßÂè∑Â≠ó‰ΩìÂõæÊ†á */
    [data-theme="dark"] .breeding-pigeon-card span[style*="font-size"],
    [data-theme="dark"] .breeding-assessment span[style*="font-size"],
    [data-theme="dark"] .breeding-pigeon-card div[style*="font-size"],
    [data-theme="dark"] .breeding-assessment div[style*="font-size"] {
      filter: brightness(1.5) !important;
      opacity: 1 !important;
    }
    
    /* ÂéÜÂè≤ÈÖçÂØπÈÉ®ÂàÜ */
    [data-theme="dark"] .breeding-history-section {
      background: #1e293b !important;
      border-color: #334155 !important;
    }
    
    [data-theme="dark"] .breeding-history-section h4 {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .breeding-history-section h4 span {
      filter: brightness(1.3) !important;
      opacity: 1 !important;
    }
    
    [data-theme="dark"] .breeding-history-section [style*="background:#fff"],
    [data-theme="dark"] .breeding-history-section [style*="background: #fff"] {
      background: #1e293b !important;
    }
    
    [data-theme="dark"] .breeding-history-section [style*="color:#1f2937"],
    [data-theme="dark"] .breeding-history-section [style*="color: #1f2937"] {
      color: #f1f5f9 !important;
    }
    
    /* ÈÄâÊã©Ê°ÜÂú®Â§úÈó¥Ê®°Âºè‰∏ãÁöÑÊ†∑Âºè */
    [data-theme="dark"] .breeding-pigeon-card select {
      background: #334155 !important;
      border-color: #475569 !important;
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .breeding-pigeon-card select option {
      background: #334155 !important;
      color: #f1f5f9 !important;
    }
    
    /* Á°Æ‰øùÊâÄÊúâÂõæÊ†áÂú®Ê∑±Ëâ≤ËÉåÊôØ‰∏äÊ∏ÖÊô∞ÂèØËßÅ */
    [data-theme="dark"] .breeding-panel * [style*="font-size:32px"],
    [data-theme="dark"] .breeding-panel * [style*="font-size: 32px"],
    [data-theme="dark"] .breeding-panel * [style*="font-size:48px"],
    [data-theme="dark"] .breeding-panel * [style*="font-size: 48px"] {
      filter: brightness(1.5) !important;
      opacity: 1 !important;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5) !important;
    }
    
    /* Á°Æ‰øùÊâÄÊúâÊñáÂ≠óÂú®Ê∑±Ëâ≤ËÉåÊôØ‰∏äÊ∏ÖÊô∞ÂèØËßÅ */
    [data-theme="dark"] .breeding-panel h3,
    [data-theme="dark"] .breeding-panel h4 {
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
    }
    
    /* ÈÖçÂØπ‰ø°ÊÅØÊòæÁ§∫Âå∫Âüü */
    [data-theme="dark"] #breedingMaleInfo,
    [data-theme="dark"] #breedingFemaleInfo,
    [data-theme="dark"] #breedingAssessment {
      color: #e2e8f0 !important;
    }
    
    [data-theme="dark"] #breedingMaleInfo .muted,
    [data-theme="dark"] #breedingFemaleInfo .muted {
      color: #94a3b8 !important;
    }
    
    /* Á°Æ‰øùÊâÄÊúâemojiÂõæÊ†áÂú®Â§úÈó¥Ê®°Âºè‰∏ãÈÉΩÊ∏ÖÊô∞ */
    [data-theme="dark"] .breeding-panel emoji,
    [data-theme="dark"] .breeding-panel [role="img"] {
      filter: brightness(1.5) !important;
      opacity: 1 !important;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5) !important;
    }
    
    /* ÈÄöÁî®ËßÑÂàôÔºöË¶ÜÁõñÊâÄÊúâÂÜÖËÅîÊ†∑Âºè‰∏≠ÁöÑÊµÖËâ≤ËÉåÊôØÊ∏êÂèò */
    [data-theme="dark"] [style*="background:linear-gradient"][style*="#dbeafe"],
    [data-theme="dark"] [style*="background: linear-gradient"][style*="#dbeafe"],
    [data-theme="dark"] [style*="background:linear-gradient"][style*="#eff6ff"],
    [data-theme="dark"] [style*="background: linear-gradient"][style*="#eff6ff"] {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%) !important;
    }
    
    [data-theme="dark"] [style*="background:linear-gradient"][style*="#fce7f3"],
    [data-theme="dark"] [style*="background: linear-gradient"][style*="#fce7f3"],
    [data-theme="dark"] [style*="background:linear-gradient"][style*="#fdf2f8"],
    [data-theme="dark"] [style*="background: linear-gradient"][style*="#fdf2f8"],
    [data-theme="dark"] [style*="background:linear-gradient"][style*="#fbcfe8"],
    [data-theme="dark"] [style*="background: linear-gradient"][style*="#fbcfe8"] {
      background: linear-gradient(135deg, #5b2845 0%, #1e293b 50%, #0f172a 100%) !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }
    
    /* ÂÅ•Â∫∑ÁÆ°ÁêÜÈ°µÈù¢ - ÈúÄË¶ÅÂÖ≥Ê≥®Âç°ÁâáÔºàÁ∫¢Ëâ≤Ê∏êÂèòÔºâ */
    [data-theme="dark"] [style*="background:linear-gradient"][style*="#fee2e2"],
    [data-theme="dark"] [style*="background: linear-gradient"][style*="#fee2e2"],
    [data-theme="dark"] [style*="background:linear-gradient"][style*="#fef2f2"],
    [data-theme="dark"] [style*="background: linear-gradient"][style*="#fef2f2"] {
      background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 50%, #1e293b 100%) !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }
    
    /* ÂÅ•Â∫∑ÁÆ°ÁêÜÈ°µÈù¢ - Áî®ËçØ‰∏≠Âç°ÁâáÔºàËìùËâ≤Ê∏êÂèòÔºâ */
    [data-theme="dark"] [style*="background:linear-gradient"][style*="#e0e7ff"],
    [data-theme="dark"] [style*="background: linear-gradient"][style*="#e0e7ff"],
    [data-theme="dark"] [style*="background:linear-gradient"][style*="#eef2ff"],
    [data-theme="dark"] [style*="background: linear-gradient"][style*="#eef2ff"] {
      background: linear-gradient(135deg, #312e81 0%, #1e293b 50%, #0f172a 100%) !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }
    
    /* ÂÅ•Â∫∑ÊèêÈÜíÂàóË°®Âå∫Âüü */
    [data-theme="dark"] .health-alerts,
    [data-theme="dark"] [style*="background:#fff"][class*="health"],
    [data-theme="dark"] #healthAlertsContainer {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%) !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }
    
    /* ÂÅ•Â∫∑Áä∂ÊÄÅÊ¶ÇËßàÂå∫Âüü */
    [data-theme="dark"] .health-overview {
      background: transparent !important;
    }
    
    /* Á°Æ‰øùÂÅ•Â∫∑Âç°Áâá‰∏≠ÁöÑÊñáÂ≠óÂú®Ê∑±Ëâ≤Ê∏êÂèòËÉåÊôØ‰∏äÊ∏ÖÊô∞ÂèØËßÅ */
    [data-theme="dark"] .health-overview [style*="color:#047857"],
    [data-theme="dark"] .health-overview [style*="color: #047857"] {
      color: #6ee7b7 !important;
    }
    
    [data-theme="dark"] .health-overview [style*="color:#b45309"],
    [data-theme="dark"] .health-overview [style*="color: #b45309"] {
      color: #fbbf24 !important;
    }
    
    [data-theme="dark"] .health-overview [style*="color:#dc2626"],
    [data-theme="dark"] .health-overview [style*="color: #dc2626"] {
      color: #fca5a5 !important;
    }
    
    [data-theme="dark"] .health-overview [style*="color:#4338ca"],
    [data-theme="dark"] .health-overview [style*="color: #4338ca"] {
      color: #a78bfa !important;
    }
    
    /* ÂÅ•Â∫∑Âç°Áâá‰∏≠ÁöÑÂõæÊ†áÂ¢ûÂº∫ */
    [data-theme="dark"] .health-overview [style*="font-size:28px"],
    [data-theme="dark"] .health-overview [style*="font-size: 28px"] {
      filter: brightness(1.5) !important;
      opacity: 1 !important;
    }
    
    /* ÂÅ•Â∫∑Âç°Áâá‰∏≠ÁöÑÊï∞Â≠óÂ¢ûÂº∫ */
    [data-theme="dark"] .health-overview [style*="font-size:32px"],
    [data-theme="dark"] .health-overview [style*="font-size: 32px"] {
      filter: brightness(1.3) !important;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5) !important;
    }
    
    [data-theme="dark"] [style*="background:linear-gradient"][style*="#fdf4ff"],
    [data-theme="dark"] [style*="background: linear-gradient"][style*="#fdf4ff"],
    [data-theme="dark"] [style*="background:linear-gradient"][style*="#faf5ff"],
    [data-theme="dark"] [style*="background: linear-gradient"][style*="#faf5ff"] {
      background: linear-gradient(135deg, #3b2764 0%, #1e293b 100%) !important;
    }
    
    /* Ë¶ÜÁõñÊâÄÊúâÊµÖËâ≤ÊñáÂ≠óÂú®Ê∑±Ëâ≤ËÉåÊôØ‰∏ä */
    [data-theme="dark"] .breeding-panel * {
      color: inherit;
    }
    
    /* Êõ¥ÈÄöÁî®ÁöÑÂõæÊ†áÂ¢ûÂº∫ËßÑÂàô - ÈíàÂØπÊâÄÊúâÂ§ßÂè∑Â≠ó‰ΩìÂÖÉÁ¥† */
    [data-theme="dark"] .breeding-panel span[style*="font-size:32px"],
    [data-theme="dark"] .breeding-panel span[style*="font-size: 32px"],
    [data-theme="dark"] .breeding-panel span[style*="font-size:48px"],
    [data-theme="dark"] .breeding-panel span[style*="font-size: 48px"],
    [data-theme="dark"] .breeding-panel div[style*="font-size:32px"],
    [data-theme="dark"] .breeding-panel div[style*="font-size: 32px"],
    [data-theme="dark"] .breeding-panel div[style*="font-size:48px"],
    [data-theme="dark"] .breeding-panel div[style*="font-size: 48px"] {
      filter: brightness(1.5) !important;
      opacity: 1 !important;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5) !important;
    }
    
    /* Á°Æ‰øùÊâÄÊúâÊ≤°ÊúâÊòéÁ°ÆÈ¢úËâ≤ÁöÑÂõæÊ†áÂÖÉÁ¥†‰ΩøÁî®ÊµÖËâ≤ */
    [data-theme="dark"] .breeding-panel span[style*="font-size"]:not([style*="color"]),
    [data-theme="dark"] .breeding-panel div[style*="font-size"]:not([style*="color"]) {
      color: #f1f5f9 !important;
    }
    
    /* ÈíàÂØπÁâπÂÆöÁ¨¶Âè∑ÁöÑÂ¢ûÂº∫ */
    [data-theme="dark"] .male-card span[style*="font-size:32px"],
    [data-theme="dark"] .male-card span[style*="font-size: 32px"] {
      color: #93c5fd !important;
      filter: brightness(1.8) !important;
      text-shadow: 0 2px 6px rgba(59, 130, 246, 0.5) !important;
    }
    
    [data-theme="dark"] .female-card span[style*="font-size:32px"],
    [data-theme="dark"] .female-card span[style*="font-size: 32px"] {
      color: #f9a8d4 !important;
      filter: brightness(1.8) !important;
      text-shadow: 0 2px 6px rgba(236, 72, 153, 0.5) !important;
    }
    
    /* ==========================================
       ÂÅ•Â∫∑ÁÆ°ÁêÜÊ®°ÂùóÂ§úÈó¥Ê®°ÂºèÂ¢ûÂº∫
       ========================================== */
    [data-theme="dark"] .health-alert-item {
      background: linear-gradient(135deg, #334155 0%, #1e293b 50%, #0f172a 100%) !important;
      border-left-color: #475569 !important;
      color: #f1f5f9 !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }
    
    [data-theme="dark"] .health-alert-item.urgent {
      background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 50%, #1e293b 100%) !important;
      border-left-color: #ef4444 !important;
      color: #fef2f2 !important;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3) !important;
    }
    
    [data-theme="dark"] .health-alert-item.warning {
      background: linear-gradient(135deg, #78350f 0%, #92400e 50%, #1e293b 100%) !important;
      border-left-color: #f59e0b !important;
      color: #fef3c7 !important;
      box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3) !important;
    }
    
    [data-theme="dark"] .health-alert-item.info {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e40af 50%, #1e293b 100%) !important;
      border-left-color: #3b82f6 !important;
      color: #dbeafe !important;
      box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3) !important;
    }
    
    [data-theme="dark"] .health-timeline-item {
      border-bottom-color: #334155 !important;
      color: #e2e8f0 !important;
    }
    
    [data-theme="dark"] .health-timeline-item::before {
      background: #475569 !important;
    }
    
    [data-theme="dark"] .health-timeline-dot.vaccine {
      background: #1e3a5f !important;
      color: #93c5fd !important;
      filter: brightness(1.3) !important;
    }
    
    [data-theme="dark"] .health-timeline-dot.deworm {
      background: #78350f !important;
      color: #fbbf24 !important;
      filter: brightness(1.3) !important;
    }
    
    [data-theme="dark"] .health-timeline-dot.checkup,
    [data-theme="dark"] .health-timeline-dot.recovery {
      background: #064e3b !important;
      color: #34d399 !important;
      filter: brightness(1.3) !important;
    }
    
    [data-theme="dark"] .health-timeline-dot.illness {
      background: #7f1d1d !important;
      color: #fca5a5 !important;
      filter: brightness(1.3) !important;
    }
    
    [data-theme="dark"] .health-timeline-dot.medication {
      background: #312e81 !important;
      color: #a78bfa !important;
      filter: brightness(1.3) !important;
    }
    
    /* ==========================================
       Êô∫ËÉΩÂàÜÊûêÊ®°ÂùóÂ§úÈó¥Ê®°ÂºèÂ¢ûÂº∫
       ========================================== */
    [data-theme="dark"] .insight-card {
      background: linear-gradient(135deg, #78350f 0%, #1e293b 50%, #0f172a 100%) !important;
      border-color: #f59e0b !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }
    
    [data-theme="dark"] .insight-card:nth-of-type(1) {
      background: linear-gradient(135deg, #78350f 0%, #1e293b 50%, #0f172a 100%) !important;
      border-color: #f59e0b !important;
    }
    
    [data-theme="dark"] .insight-card:nth-of-type(2) {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%) !important;
      border-color: #3b82f6 !important;
    }
    
    [data-theme="dark"] .insight-card:nth-of-type(3) {
      background: linear-gradient(135deg, #5b2845 0%, #1e293b 50%, #0f172a 100%) !important;
      border-color: #ec4899 !important;
    }
    
    [data-theme="dark"] .insight-card:nth-of-type(4) {
      background: linear-gradient(135deg, #064e3b 0%, #1e293b 50%, #0f172a 100%) !important;
      border-color: #10b981 !important;
    }
    
    [data-theme="dark"] .insight-card:hover {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4) !important;
      transform: translateY(-2px) !important;
    }
    
    [data-theme="dark"] .insight-card h4 {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .insight-card span[style*="font-size:32px"],
    [data-theme="dark"] .insight-card span[style*="font-size: 32px"] {
      filter: brightness(1.5) !important;
      opacity: 1 !important;
    }
    
    [data-theme="dark"] [style*="background:linear-gradient"][style*="#fef3c7"],
    [data-theme="dark"] [style*="background: linear-gradient"][style*="#fef3c7"],
    [data-theme="dark"] [style*="background:linear-gradient"][style*="#fffbeb"],
    [data-theme="dark"] [style*="background:linear-gradient"][style*="#fde68a"],
    [data-theme="dark"] [style*="background: linear-gradient"][style*="#fde68a"] {
      background: linear-gradient(135deg, #78350f 0%, #1e293b 50%, #0f172a 100%) !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }
    
    [data-theme="dark"] [style*="background:linear-gradient"][style*="#d1fae5"],
    [data-theme="dark"] [style*="background: linear-gradient"][style*="#d1fae5"],
    [data-theme="dark"] [style*="background:linear-gradient"][style*="#ecfdf5"],
    [data-theme="dark"] [style*="background: linear-gradient"][style*="#ecfdf5"],
    [data-theme="dark"] [style*="background:linear-gradient"][style*="#a7f3d0"],
    [data-theme="dark"] [style*="background: linear-gradient"][style*="#a7f3d0"] {
      background: linear-gradient(135deg, #064e3b 0%, #1e293b 50%, #0f172a 100%) !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }
    
    [data-theme="dark"] [style*="background:linear-gradient"][style*="#f0f9ff"],
    [data-theme="dark"] [style*="background: linear-gradient"][style*="#f0f9ff"],
    [data-theme="dark"] [style*="background:linear-gradient"][style*="#e0f2fe"],
    [data-theme="dark"] [style*="background: linear-gradient"][style*="#e0f2fe"] {
      background: linear-gradient(135deg, #0c4a6e 0%, #1e293b 50%, #0f172a 100%) !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }
    
    [data-theme="dark"] [style*="color:#92400e"],
    [data-theme="dark"] [style*="color: #92400e"] {
      color: #fef3c7 !important;
    }
    
    [data-theme="dark"] [style*="color:#047857"],
    [data-theme="dark"] [style*="color: #047857"] {
      color: #6ee7b7 !important;
    }
    
    [data-theme="dark"] [style*="color:#0369a1"],
    [data-theme="dark"] [style*="color: #0369a1"] {
      color: #7dd3fc !important;
    }
    
    [data-theme="dark"] .potential-item {
      background: linear-gradient(135deg, #334155 0%, #1e293b 50%, #0f172a 100%) !important;
      color: #f1f5f9 !important;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2) !important;
    }
    
    [data-theme="dark"] .potential-item:hover {
      background: linear-gradient(135deg, #475569 0%, #334155 50%, #1e293b 100%) !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }
    
    [data-theme="dark"] .potential-ranking,
    [data-theme="dark"] .failed-pairings {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%) !important;
      border-color: #3b82f6 !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }
    
    [data-theme="dark"] .potential-ranking h4,
    [data-theme="dark"] .failed-pairings h4 {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .potential-ranking span,
    [data-theme="dark"] .failed-pairings span {
      filter: brightness(1.3) !important;
      opacity: 1 !important;
    }
    
    [data-theme="dark"] .analysis-conclusion {
      background: linear-gradient(135deg, #0c4a6e 0%, #1e293b 100%) !important;
      border-color: #0ea5e9 !important;
    }
    
    [data-theme="dark"] .analysis-conclusion h4 {
      color: #7dd3fc !important;
    }
    
    [data-theme="dark"] .analysis-conclusion p {
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] .analysis-conclusion span {
      filter: brightness(1.5) !important;
      opacity: 1 !important;
    }
    
    /* ==========================================
       ËÆ≠ÁªÉÊ®°ÂùóÂ§úÈó¥Ê®°ÂºèÂ¢ûÂº∫
       ========================================== */
    [data-theme="dark"] #trainingStatsContainer [style*="background:linear-gradient"][style*="#dbeafe"],
    [data-theme="dark"] #trainingStatsContainer [style*="background: linear-gradient"][style*="#dbeafe"],
    [data-theme="dark"] #trainingStatsContainer [style*="background:linear-gradient"][style*="#eff6ff"] {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%) !important;
    }
    
    [data-theme="dark"] #trainingStatsContainer [style*="background:linear-gradient"][style*="#d1fae5"],
    [data-theme="dark"] #trainingStatsContainer [style*="background: linear-gradient"][style*="#d1fae5"],
    [data-theme="dark"] #trainingStatsContainer [style*="background:linear-gradient"][style*="#ecfdf5"] {
      background: linear-gradient(135deg, #064e3b 0%, #1e293b 100%) !important;
    }
    
    [data-theme="dark"] #trainingStatsContainer [style*="background:linear-gradient"][style*="#fef3c7"],
    [data-theme="dark"] #trainingStatsContainer [style*="background: linear-gradient"][style*="#fef3c7"],
    [data-theme="dark"] #trainingStatsContainer [style*="background:linear-gradient"][style*="#fffbeb"] {
      background: linear-gradient(135deg, #78350f 0%, #1e293b 100%) !important;
    }
    
    [data-theme="dark"] #trainingStatsContainer [style*="color:#1e40af"],
    [data-theme="dark"] #trainingStatsContainer [style*="color: #1e40af"] {
      color: #93c5fd !important;
    }
    
    [data-theme="dark"] #trainingStatsContainer [style*="color:#047857"],
    [data-theme="dark"] #trainingStatsContainer [style*="color: #047857"] {
      color: #6ee7b7 !important;
    }
    
    [data-theme="dark"] #trainingStatsContainer [style*="color:#92400e"],
    [data-theme="dark"] #trainingStatsContainer [style*="color: #92400e"] {
      color: #fbbf24 !important;
    }
    
    [data-theme="dark"] #trainingStatsContainer [style*="color:#64748b"],
    [data-theme="dark"] #trainingStatsContainer [style*="color: #64748b"] {
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] #trainingStatsContainer [style*="color:#1f2937"],
    [data-theme="dark"] #trainingStatsContainer [style*="color: #1f2937"] {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] #trainingStatsContainer [style*="background:#fff"],
    [data-theme="dark"] #trainingStatsContainer [style*="background: #fff"] {
      background: #1e293b !important;
    }
    
    /* ==========================================
       ÁªºÂêàËÉΩÂäõÂàÜÊûêÊ®°ÂùóÂ§úÈó¥Ê®°ÂºèÂ¢ûÂº∫
       ========================================== */
    [data-theme="dark"] #qualificationView [style*="background:linear-gradient"][style*="#f0f9ff"],
    [data-theme="dark"] #qualificationView [style*="background: linear-gradient"][style*="#f0f9ff"],
    [data-theme="dark"] #qualificationView [style*="background:linear-gradient"][style*="#e0f2fe"] {
      background: linear-gradient(135deg, #0c4a6e 0%, #1e293b 100%) !important;
    }
    
    [data-theme="dark"] #qualificationView [style*="color:#0369a1"],
    [data-theme="dark"] #qualificationView [style*="color: #0369a1"] {
      color: #7dd3fc !important;
    }
    
    /* ==========================================
       È¶ñÈ°µÊ®°ÂùóÂ§úÈó¥Ê®°ÂºèÂ¢ûÂº∫
       ========================================== */
    [data-theme="dark"] .home-column-header h3 {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .news-filter-btn {
      color: #cbd5e1 !important;
      background: transparent !important;
    }
    
    [data-theme="dark"] .news-filter-btn:hover {
      background: #334155 !important;
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .news-filter-btn.active {
      background: #2563eb !important;
      color: #fff !important;
    }
    
    [data-theme="dark"] .news-region-tabs {
      background: #334155 !important;
      border-bottom-color: #475569 !important;
    }
    
    [data-theme="dark"] .news-region-tab {
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] .news-region-tab:hover {
      background: #475569 !important;
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .news-region-tab.active {
      background: #2563eb !important;
      color: #fff !important;
    }
    
    /* ‰∫ã‰ª∂Âå∫ÂüüÊ†áÁ≠æÈ°µ‰ΩøÁî®Ê∑±Ëâ≤Ê∏êÂèò */
    [data-theme="dark"] .event-region-tabs {
      background: linear-gradient(135deg, #334155 0%, #1e293b 50%, #0f172a 100%) !important;
      border-bottom-color: #475569 !important;
    }
    
    [data-theme="dark"] .event-region-tab {
      color: #cbd5e1 !important;
      background: transparent !important;
    }
    
    [data-theme="dark"] .event-region-tab:hover {
      background: rgba(51, 65, 85, 0.6) !important;
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .event-region-tab.active {
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%) !important;
      color: #fff !important;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3) !important;
    }
    
    /* Ëµõ‰∫ãÊ†áÁ≠æÈ°µ‰ΩøÁî®Ê∑±Ëâ≤Ê∏êÂèò */
    [data-theme="dark"] .event-tabs {
      background: linear-gradient(135deg, #334155 0%, #1e293b 50%, #0f172a 100%) !important;
    }
    
    [data-theme="dark"] .event-tab-btn {
      color: #cbd5e1 !important;
      background: transparent !important;
    }
    
    [data-theme="dark"] .event-tab-btn:hover {
      background: rgba(51, 65, 85, 0.6) !important;
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .event-tab-btn.active {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%) !important;
      color: #93c5fd !important;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3) !important;
      border: 1px solid #3b82f6 !important;
    }
    
    [data-theme="dark"] .home-column-footer {
      border-top-color: #334155 !important;
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%) !important;
    }
    
    [data-theme="dark"] .news-tag {
      background: #334155 !important;
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] .news-tag.race {
      background: #1e3a8a !important;
      color: #93c5fd !important;
    }
    
    [data-theme="dark"] .news-tag.breeding {
      background: #831843 !important;
      color: #f9a8d4 !important;
    }
    
    [data-theme="dark"] .news-tag.health {
      background: #064e3b !important;
      color: #6ee7b7 !important;
    }
    
    [data-theme="dark"] .news-tag.hot {
      background: #7f1d1d !important;
      color: #fca5a5 !important;
    }
    
    [data-theme="dark"] .stats-chart-container {
      background: #1e293b !important;
    }
    
    [data-theme="dark"] .participant-item {
      background: #1e293b !important;
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .participant-item:hover {
      background: #334155 !important;
    }
    
    /* ÈÄöÁî®ÔºöË¶ÜÁõñÊâÄÊúâÂÜÖËÅîÊ†∑Âºè‰∏≠ÁöÑÁôΩËâ≤ËÉåÊôØ - ‰ΩøÁî®Ê∑±Ëâ≤Ê∏êÂèò */
    [data-theme="dark"] [style*="background:#fff"],
    [data-theme="dark"] [style*="background: #fff"],
    [data-theme="dark"] [style*="background:#ffffff"],
    [data-theme="dark"] [style*="background: #ffffff"] {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%) !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }
    
    /* ÈÄöÁî®ÔºöË¶ÜÁõñÊâÄÊúâÂÜÖËÅîÊ†∑Âºè‰∏≠ÁöÑÊµÖËâ≤ËÉåÊôØ - ‰ΩøÁî®Ê∑±Ëâ≤Ê∏êÂèò */
    [data-theme="dark"] [style*="background:#f9fafb"],
    [data-theme="dark"] [style*="background: #f9fafb"],
    [data-theme="dark"] [style*="background:#fafbfc"],
    [data-theme="dark"] [style*="background: #fafbfc"],
    [data-theme="dark"] [style*="background:#f3f4f6"],
    [data-theme="dark"] [style*="background: #f3f4f6"],
    [data-theme="dark"] [style*="background:#f8fafc"],
    [data-theme="dark"] [style*="background: #f8fafc"] {
      background: linear-gradient(135deg, #334155 0%, #1e293b 50%, #0f172a 100%) !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }
    
    /* ‰∏∫ÊâÄÊúâÂç°ÁâáÊ∑ªÂä†Ê∑±Ëâ≤Ê∏êÂèòËÉåÊôØÔºàÈÄöÁî®ËßÑÂàôÔºâ */
    [data-theme="dark"] .card,
    [data-theme="dark"] [class*="card"]:not(.card-header):not(.card-footer) {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%) !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }
    
    /* Á°Æ‰øùÊâÄÊúâÂç°ÁâáÂÜÖÂÆπÂú®Ê∑±Ëâ≤Ê∏êÂèòËÉåÊôØ‰∏äÊ∏ÖÊô∞ÂèØËßÅ */
    [data-theme="dark"] .card *,
    [data-theme="dark"] [class*="card"] * {
      color: inherit;
    }
    
    /* Âç°ÁâáÊÇ¨ÂÅúÊïàÊûúÂ¢ûÂº∫ */
    [data-theme="dark"] .card:hover,
    [data-theme="dark"] [class*="card"]:hover {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4) !important;
      transform: translateY(-2px) !important;
    }
    
    /* ÈÄöÁî®ÔºöË¶ÜÁõñÊâÄÊúâÂÜÖËÅîÊ†∑Âºè‰∏≠ÁöÑÊ∑±Ëâ≤ÊñáÂ≠ó */
    [data-theme="dark"] [style*="color:#1f2937"],
    [data-theme="dark"] [style*="color: #1f2937"],
    [data-theme="dark"] [style*="color:#374151"],
    [data-theme="dark"] [style*="color: #374151"] {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] [style*="color:#4b5563"],
    [data-theme="dark"] [style*="color: #4b5563"] {
      color: #cbd5e1 !important;
    }
    
    /* È¶ñÈ°µÊó•ÊúüÂíåÂ§©Ê∞îÂå∫Âüü */
    [data-theme="dark"] .home-date-day {
      background: linear-gradient(180deg, #f1f5f9 0%, #93c5fd 100%) !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
      background-clip: text !important;
    }
    
    [data-theme="dark"] .home-date-weekday,
    [data-theme="dark"] .home-date-full {
      color: #e2e8f0 !important;
    }
    
    [data-theme="dark"] .home-weather {
      background: rgba(30, 41, 59, 0.5) !important;
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .home-stat-item {
      background: rgba(30, 41, 59, 0.8) !important;
      color: #f1f5f9 !important;
      border: 1px solid rgba(59, 130, 246, 0.3) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
    }
    
    [data-theme="dark"] .home-stat-item .home-stat-icon {
      filter: brightness(1.5) !important;
      opacity: 1 !important;
    }
    
    [data-theme="dark"] .home-stat-item .home-stat-number {
      color: #f1f5f9 !important;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
      font-weight: 800 !important;
    }
    
    [data-theme="dark"] .home-stat-item .home-stat-label {
      color: #e2e8f0 !important;
      opacity: 1 !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
    
    /* Â§©Ê∞îÂå∫ÂüüÊñáÂ≠óÂ¢ûÂº∫ */
    [data-theme="dark"] .home-weather {
      background: rgba(30, 41, 59, 0.8) !important;
      color: #f1f5f9 !important;
      border: 1px solid rgba(59, 130, 246, 0.3) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
    }
    
    [data-theme="dark"] .home-weather span[style*="font-size:28px"],
    [data-theme="dark"] .home-weather span[style*="font-size: 28px"] {
      filter: brightness(1.5) !important;
      opacity: 1 !important;
    }
    
    [data-theme="dark"] .home-weather [style*="color:#6b7280"],
    [data-theme="dark"] .home-weather [style*="color: #6b7280"] {
      color: #cbd5e1 !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
    
    [data-theme="dark"] .home-weather [style*="font-weight:600"] {
      color: #f1f5f9 !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
    
    /* Á≥ªÁªüÂÖ¨ÂëäÊñáÂ≠óÂ¢ûÂº∫ */
    [data-theme="dark"] .home-announcement {
      background: linear-gradient(90deg, #78350f 0%, #92400e 100%) !important;
      border-left-color: #f59e0b !important;
      box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3) !important;
    }
    
    [data-theme="dark"] .announcement-text {
      color: #fef3c7 !important;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important;
      font-weight: 600 !important;
    }
    
    [data-theme="dark"] .announcement-icon {
      filter: brightness(1.3) !important;
      opacity: 1 !important;
    }
    
    /* È¶ñÈ°µÊ¶ÇËßàÂå∫ÂüüÊñáÂ≠óÂ¢ûÂº∫ */
    [data-theme="dark"] .home-overview {
      background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #1e293b 100%) !important;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4) !important;
    }
    
    [data-theme="dark"] .home-overview * {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .home-date-weekday,
    [data-theme="dark"] .home-date-full {
      color: #e2e8f0 !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
    
    /* Èù¢ÊùøÂÜÖÂÆπÊñáÂ≠óÂ¢ûÂº∫ */
    [data-theme="dark"] .home-column *,
    [data-theme="dark"] .home-widget * {
      color: #e2e8f0 !important;
    }
    
    [data-theme="dark"] .home-column h3,
    [data-theme="dark"] .home-column h4,
    [data-theme="dark"] .home-widget h3,
    [data-theme="dark"] .home-widget h4 {
      color: #f1f5f9 !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
    
    [data-theme="dark"] .home-column h3 span,
    [data-theme="dark"] .home-column h4 span,
    [data-theme="dark"] .home-widget h3 span,
    [data-theme="dark"] .home-widget h4 span {
      filter: brightness(1.5) !important;
      opacity: 1 !important;
    }
    
    /* Êñ∞ÈóªÂç°ÁâáÊñáÂ≠óÂ¢ûÂº∫ */
    [data-theme="dark"] .news-card-title {
      color: #f1f5f9 !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
    
    [data-theme="dark"] .news-card-source,
    [data-theme="dark"] .news-card-time,
    [data-theme="dark"] .news-card-update-time {
      color: #cbd5e1 !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
    
    /* ‰∫ã‰ª∂Âç°ÁâáÊñáÂ≠óÂ¢ûÂº∫ */
    [data-theme="dark"] .event-card-title {
      color: #f1f5f9 !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
    
    [data-theme="dark"] .event-card-info,
    [data-theme="dark"] .event-card-info-item {
      color: #cbd5e1 !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
    
    /* Êé®ËçêÈ°πÊñáÂ≠óÂ¢ûÂº∫ - ‰ΩøÁî®Ê∑±Ëâ≤Ê∏êÂèòËÉåÊôØ */
    [data-theme="dark"] .recommendation-item {
      background: linear-gradient(135deg, #334155 0%, #1e293b 50%, #0f172a 100%) !important;
      border-color: #475569 !important;
      color: #e2e8f0 !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
    }
    
    [data-theme="dark"] .recommendation-item:hover {
      background: linear-gradient(135deg, #475569 0%, #334155 50%, #1e293b 100%) !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
      transform: translateX(2px) !important;
    }
    
    [data-theme="dark"] .recommendation-title {
      color: #f1f5f9 !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
    
    [data-theme="dark"] .recommendation-desc {
      color: #cbd5e1 !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
    
    /* Êé®ËçêÂõæÊ†á‰ΩøÁî®Ê∑±Ëâ≤Ê∏êÂèò */
    [data-theme="dark"] .recommendation-icon.race {
      background: linear-gradient(135deg, #78350f 0%, #1e293b 100%) !important;
      filter: brightness(1.2) !important;
    }
    
    [data-theme="dark"] .recommendation-icon.pigeon {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%) !important;
      filter: brightness(1.2) !important;
    }
    
    [data-theme="dark"] .recommendation-icon.breeding {
      background: linear-gradient(135deg, #5b2845 0%, #1e293b 100%) !important;
      filter: brightness(1.2) !important;
    }
    
    /* ÊàëÁöÑÂÖ≥Ê≥®Ê†áÁ≠æÂ¢ûÂº∫ */
    [data-theme="dark"] .home-widget .tag,
    [data-theme="dark"] .home-widget [class*="tag"] {
      background: rgba(59, 130, 246, 0.2) !important;
      color: #93c5fd !important;
      border-color: rgba(59, 130, 246, 0.4) !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
    
    /* Âø´Êç∑ÂÖ•Âè£ÊåâÈíÆÂ¢ûÂº∫ - ‰ΩøÁî®Ê∑±Ëâ≤Ê∏êÂèòËÉåÊôØ */
    [data-theme="dark"] .quick-link-btn {
      background: linear-gradient(135deg, #334155 0%, #1e293b 50%, #0f172a 100%) !important;
      border-color: #475569 !important;
      color: #e2e8f0 !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
    }
    
    [data-theme="dark"] .quick-link-btn:hover {
      background: linear-gradient(135deg, #1e3a5f 0%, #334155 50%, #1e293b 100%) !important;
      border-color: #3b82f6 !important;
      color: #f1f5f9 !important;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3) !important;
      transform: translateY(-2px) !important;
    }
    
    [data-theme="dark"] .quick-link-btn span:first-child {
      filter: brightness(1.3) !important;
      opacity: 1 !important;
    }
    
    /* Á°Æ‰øùÊâÄÊúâh2„ÄÅh3„ÄÅh4Ê†áÈ¢òÂú®Â§úÈó¥Ê®°Âºè‰∏ãÊ∏ÖÊô∞ */
    [data-theme="dark"] h2,
    [data-theme="dark"] h3,
    [data-theme="dark"] h4 {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] h2 span,
    [data-theme="dark"] h3 span,
    [data-theme="dark"] h4 span {
      filter: brightness(1.3) !important;
      opacity: 1 !important;
    }
    
    /* Á°Æ‰øùÊâÄÊúâÂç°ÁâáÊ†áÈ¢òÊ∏ÖÊô∞ */
    [data-theme="dark"] .card-header h2,
    [data-theme="dark"] .card-header h3,
    [data-theme="dark"] .card-header h4 {
      color: #f1f5f9 !important;
    }
    
    /* Á°Æ‰øùÊâÄÊúâÂõæÊ†áÂú®Ê∑±Ëâ≤ËÉåÊôØ‰∏äÊ∏ÖÊô∞ */
    [data-theme="dark"] .card-header span,
    [data-theme="dark"] .card-header [class*="icon"] {
      filter: brightness(1.3) !important;
      opacity: 1 !important;
    }
    
    /* ËÆ≠ÁªÉÂàÜÊûêÁªìÊûúÂå∫Âüü */
    [data-theme="dark"] #trainingAnalysisResult,
    [data-theme="dark"] #trainingRecordsList {
      color: #e2e8f0 !important;
    }
    
    /* Êô∫ËÉΩÂàÜÊûêÂç°ÁâáÂÜÖÂÆπ */
    [data-theme="dark"] #topBloodlineCard,
    [data-theme="dark"] #topMaleCard,
    [data-theme="dark"] #topFemaleCard,
    [data-theme="dark"] #recommendedPairingCard,
    [data-theme="dark"] #analysisConclusion {
      color: #e2e8f0 !important;
    }
    
    /* ÊΩúÂäõÊéíË°åÊ¶ú */
    [data-theme="dark"] #potentialRankingContainer,
    [data-theme="dark"] #failedPairingsContainer {
      color: #e2e8f0 !important;
    }
    
    /* Á°Æ‰øùÊâÄÊúâË°®Ê†ºÂú®Â§úÈó¥Ê®°Âºè‰∏ãÊ∏ÖÊô∞ */
    [data-theme="dark"] table {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] table td,
    [data-theme="dark"] table th {
      border-color: #334155 !important;
    }
    
    /* Á°Æ‰øùÊâÄÊúâËæìÂÖ•Ê°ÜÂíåÈÄâÊã©Ê°ÜÂú®Â§úÈó¥Ê®°Âºè‰∏ãÊ∏ÖÊô∞ */
    [data-theme="dark"] input,
    [data-theme="dark"] select,
    [data-theme="dark"] textarea {
      background: #334155 !important;
      border-color: #475569 !important;
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] input::placeholder,
    [data-theme="dark"] textarea::placeholder {
      color: #64748b !important;
    }
    
    /* Á°Æ‰øùÊâÄÊúâÊåâÈíÆÊñáÂ≠óÊ∏ÖÊô∞ */
    [data-theme="dark"] .btn {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      color: #fff !important;
    }
    
    [data-theme="dark"] .btn-outline {
      border-color: #475569 !important;
      color: #e2e8f0 !important;
    }
    
    [data-theme="dark"] .btn-outline:hover {
      background: #475569 !important;
      color: #f1f5f9 !important;
    }
    
    /* Á°Æ‰øùÊâÄÊúâemojiÂíåÂõæÊ†áÂú®Â§úÈó¥Ê®°Âºè‰∏ãÈÉΩÊ∏ÖÊô∞ÂèØËßÅ */
    [data-theme="dark"] * span[style*="font-size"],
    [data-theme="dark"] * div[style*="font-size"] {
      filter: brightness(1.3) !important;
      opacity: 1 !important;
    }
    
    /* ÈÄöÁî®ËßÑÂàôÔºöÊâÄÊúâÂ∏¶È¢úËâ≤ÁöÑÊñáÂ≠óÂú®Â§úÈó¥Ê®°Âºè‰∏ãÂ¢ûÂº∫ */
    [data-theme="dark"] [style*="color:#2563eb"],
    [data-theme="dark"] [style*="color: #2563eb"],
    [data-theme="dark"] [style*="color:#059669"],
    [data-theme="dark"] [style*="color: #059669"],
    [data-theme="dark"] [style*="color:#d97706"],
    [data-theme="dark"] [style*="color: #d97706"],
    [data-theme="dark"] [style*="color:#7c3aed"],
    [data-theme="dark"] [style*="color: #7c3aed"] {
      filter: brightness(1.2) !important;
    }
    
    /* Â§úÈó¥Ê®°ÂºèÊñáÂ≠óÈ¢úËâ≤Â¢ûÂº∫ */
    [data-theme="dark"] .muted {
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] .field-label {
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] .field-value {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] table td {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] table th {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .card p,
    [data-theme="dark"] .card span,
    [data-theme="dark"] .card div {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .form-group label {
      color: #e2e8f0 !important;
    }
    
    [data-theme="dark"] .stat-card-label {
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] .home-stat-label {
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] .pigeon-card-info-label {
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] .tree-node-label,
    [data-theme="dark"] .tree-parent-label {
      color: #e2e8f0 !important;
    }
    
    [data-theme="dark"] label {
      color: #e2e8f0 !important;
    }
    
    [data-theme="dark"] .section-title {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .news-card-title,
    [data-theme="dark"] .news-card-source,
    [data-theme="dark"] .news-card-update-time {
      color: #e2e8f0 !important;
    }
    
    [data-theme="dark"] .event-card-title,
    [data-theme="dark"] .event-card-info {
      color: #e2e8f0 !important;
    }
    
    [data-theme="dark"] .badge-small {
      color: #f1f5f9 !important;
      background: #475569 !important;
    }
    
    [data-theme="dark"] .notice {
      color: #fef3c7 !important;
      background: #78350f !important;
      border-color: #f59e0b !important;
    }
    
    /* ÂÜÖËÅîÊ†∑ÂºèË¶ÜÁõñ */
    [data-theme="dark"] [style*="color: #666"],
    [data-theme="dark"] [style*="color:#666"] {
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] [style*="color: #777"],
    [data-theme="dark"] [style*="color:#777"] {
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] [style*="color: #999"],
    [data-theme="dark"] [style*="color:#999"] {
      color: #94a3b8 !important;
    }
    
    [data-theme="dark"] [style*="color: #222"],
    [data-theme="dark"] [style*="color:#222"] {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .home-widget h3,
    [data-theme="dark"] .home-widget h4 {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .home-widget p {
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] .home-stat-number {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .home-stat-label {
      color: #cbd5e1 !important;
      opacity: 1 !important;
    }
    
    [data-theme="dark"] .race-card-meta,
    [data-theme="dark"] .news-modal-meta {
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] .btn {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .btn-outline {
      color: #e2e8f0 !important;
      border-color: #475569 !important;
    }
    
    [data-theme="dark"] .btn-outline:hover {
      color: #f1f5f9 !important;
      background: #475569 !important;
    }
    
    [data-theme="dark"] .btn-ghost {
      color: #e2e8f0 !important;
    }
    
    [data-theme="dark"] .btn-ghost:hover {
      color: #f1f5f9 !important;
      background: #334155 !important;
    }
    
    [data-theme="dark"] a {
      color: #60a5fa !important;
    }
    
    [data-theme="dark"] a:hover {
      color: #93c5fd !important;
    }
    
    [data-theme="dark"] .top-header h1 {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .sidebar-item {
      color: #e2e8f0 !important;
    }
    
    [data-theme="dark"] .sidebar-item.active {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .sidebar-item:hover {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] h1,
    [data-theme="dark"] h2,
    [data-theme="dark"] h3,
    [data-theme="dark"] h4,
    [data-theme="dark"] h5,
    [data-theme="dark"] h6 {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] p {
      color: #e2e8f0 !important;
    }
    
    [data-theme="dark"] .card-title {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .card-subtitle {
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] .text-muted {
      color: #94a3b8 !important;
    }
    
    [data-theme="dark"] .text-secondary {
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] input::placeholder,
    [data-theme="dark"] textarea::placeholder {
      color: #64748b !important;
    }
    
    [data-theme="dark"] .image-thumb {
      background: #334155 !important;
      color: #cbd5e1 !important;
    }
    
    /* Â§úÈó¥Ê®°ÂºèÂõæÊ†áÂíåÊñáÂ≠óÂØπÊØîÂ∫¶Â¢ûÂº∫ */
    [data-theme="dark"] .sidebar-item-icon {
      filter: brightness(1.2);
      opacity: 1 !important;
    }
    
    [data-theme="dark"] .sidebar-item {
      color: #e2e8f0 !important;
    }
    
    [data-theme="dark"] .sidebar-item.active .sidebar-item-icon {
      filter: brightness(1.5);
    }
    
    [data-theme="dark"] .stat-card {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%) !important;
      border-color: #3b82f6 !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
    }
    
    [data-theme="dark"] .stat-card:nth-child(1) {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 50%, #0f172a 100%) !important;
      border-color: #3b82f6 !important;
    }
    
    [data-theme="dark"] .stat-card:nth-child(2) {
      background: linear-gradient(135deg, #064e3b 0%, #1e293b 50%, #0f172a 100%) !important;
      border-color: #10b981 !important;
    }
    
    [data-theme="dark"] .stat-card:nth-child(3) {
      background: linear-gradient(135deg, #374151 0%, #1e293b 50%, #0f172a 100%) !important;
      border-color: #6b7280 !important;
    }
    
    [data-theme="dark"] .stat-card:nth-child(4) {
      background: linear-gradient(135deg, #78350f 0%, #1e293b 50%, #0f172a 100%) !important;
      border-color: #f59e0b !important;
    }
    
    [data-theme="dark"] .stat-card:nth-child(5) {
      background: linear-gradient(135deg, #3b2764 0%, #1e293b 50%, #0f172a 100%) !important;
      border-color: #a855f7 !important;
    }
    
    [data-theme="dark"] .stat-card:hover {
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4) !important;
      transform: translateY(-2px) !important;
    }
    
    [data-theme="dark"] .stat-card-label {
      color: #cbd5e1 !important;
    }
    
    [data-theme="dark"] .stat-card-number {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .home-stat-icon {
      filter: brightness(1.3);
      opacity: 1 !important;
    }
    
    [data-theme="dark"] .home-stat-number {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .home-stat-label {
      color: #cbd5e1 !important;
      opacity: 1 !important;
    }
    
    [data-theme="dark"] .announcement-icon {
      filter: brightness(1.2);
    }
    
    [data-theme="dark"] .card-header h2 {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .card-header h2::before,
    [data-theme="dark"] .section-title::before {
      filter: brightness(1.3);
      opacity: 1 !important;
    }
    
    [data-theme="dark"] .recommendation-icon {
      filter: brightness(1.2);
      opacity: 1 !important;
    }
    
    /* ÊèêÈÜíÈ°π‰ΩøÁî®Ê∑±Ëâ≤Ê∏êÂèòËÉåÊôØ */
    [data-theme="dark"] .alert-item {
      background: linear-gradient(135deg, #334155 0%, #1e293b 50%, #0f172a 100%) !important;
      border-left-color: #475569 !important;
      color: #e2e8f0 !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
    }
    
    [data-theme="dark"] .alert-item.urgent {
      background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 50%, #1e293b 100%) !important;
      border-left-color: #ef4444 !important;
      color: #fef2f2 !important;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2) !important;
    }
    
    [data-theme="dark"] .alert-item.warning {
      background: linear-gradient(135deg, #78350f 0%, #92400e 50%, #1e293b 100%) !important;
      border-left-color: #f59e0b !important;
      color: #fef3c7 !important;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2) !important;
    }
    
    [data-theme="dark"] .alert-item.info {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e40af 50%, #1e293b 100%) !important;
      border-left-color: #3b82f6 !important;
      color: #dbeafe !important;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2) !important;
    }
    
    [data-theme="dark"] .alert-item-icon {
      filter: brightness(1.5) !important;
      opacity: 1 !important;
    }
    
    [data-theme="dark"] .alert-item-text {
      color: inherit !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
    
    [data-theme="dark"] .evo-icon-button {
      background: #334155 !important;
      color: #e2e8f0 !important;
      border-color: #475569 !important;
    }
    
    [data-theme="dark"] .evo-icon-button:hover {
      background: #475569 !important;
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .evo-pigeon-icon {
      filter: brightness(1.2);
    }
    
    [data-theme="dark"] .evo-icon {
      filter: brightness(1.3);
      opacity: 1 !important;
    }
    
    [data-theme="dark"] .evo-icon-large {
      filter: brightness(1.3);
      opacity: 1 !important;
    }
    
    [data-theme="dark"] .top-header h1::before {
      filter: brightness(1.2);
      opacity: 1 !important;
    }
    
    /* ÊåâÈíÆ‰∏≠ÁöÑÂõæÊ†áÂíåÊñáÂ≠ó */
    [data-theme="dark"] .btn {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .btn .sidebar-item-icon,
    [data-theme="dark"] .btn span[class*="icon"] {
      filter: brightness(1.3);
      opacity: 1 !important;
    }
    
    /* Âç°Áâá‰∏≠ÁöÑÂõæÊ†á */
    [data-theme="dark"] .card .home-stat-icon,
    [data-theme="dark"] .card [class*="icon"],
    [data-theme="dark"] .card span[style*="font-size"] {
      filter: brightness(1.2);
    }
    
    /* Ë°®Ê†º‰∏≠ÁöÑÂõæÊ†á */
    [data-theme="dark"] table td [class*="icon"],
    [data-theme="dark"] table td span[style*="font-size"] {
      filter: brightness(1.3);
      opacity: 1 !important;
    }
    
    /* ÂÅ•Â∫∑Êó∂Èó¥ËΩ¥ÂõæÊ†á */
    [data-theme="dark"] .health-timeline-dot {
      filter: brightness(1.3);
      opacity: 1 !important;
    }
    
    /* ÊâÄÊúâemojiÂõæÊ†áÂ¢ûÂº∫ */
    [data-theme="dark"] span[class*="icon"],
    [data-theme="dark"] div[class*="icon"],
    [data-theme="dark"] [style*="font-size:24px"],
    [data-theme="dark"] [style*="font-size: 24px"],
    [data-theme="dark"] [style*="font-size:20px"],
    [data-theme="dark"] [style*="font-size: 20px"],
    [data-theme="dark"] [style*="font-size:18px"],
    [data-theme="dark"] [style*="font-size: 18px"] {
      filter: brightness(1.2);
      opacity: 1 !important;
    }
    
    /* Á°Æ‰øùÊñáÂ≠óÂíåÂõæÊ†á‰πãÈó¥ÊúâË∂≥Â§üÁöÑÂØπÊØîÂ∫¶ */
    [data-theme="dark"] .stat-card-label,
    [data-theme="dark"] .stat-card-number {
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    [data-theme="dark"] .home-stat-number {
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    [data-theme="dark"] .card-title,
    [data-theme="dark"] .section-title {
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    /* Êé®ËçêÂç°ÁâáÂõæÊ†áÂíåÊñáÂ≠ó */
    [data-theme="dark"] .recommendation-icon {
      filter: brightness(1.2);
      opacity: 1 !important;
    }
    
    [data-theme="dark"] .recommendation-title {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .recommendation-desc {
      color: #cbd5e1 !important;
    }
    
    /* Ë°ÄÁªüËäÇÁÇπ */
    [data-theme="dark"] .pedigree-node {
      background: #334155 !important;
      border-color: #475569 !important;
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .pedigree-node.core {
      background: #78350f !important;
      border-color: #f59e0b !important;
      color: #fef3c7 !important;
    }
    
    /* È∏ΩÂ≠êÂç°Áâá */
    [data-theme="dark"] .pigeon-card {
      background: #1e293b !important;
      border-color: #334155 !important;
    }
    
    [data-theme="dark"] .pigeon-card-info-label {
      color: #cbd5e1 !important;
    }
    
    /* Á°Æ‰øùÊâÄÊúâÂ§ßÂè∑Â≠ó‰ΩìÂõæÊ†áÊ∏ÖÊô∞ÂèØËßÅ */
    [data-theme="dark"] [style*="font-size:36px"],
    [data-theme="dark"] [style*="font-size: 36px"],
    [data-theme="dark"] [style*="font-size:32px"],
    [data-theme="dark"] [style*="font-size: 32px"],
    [data-theme="dark"] [style*="font-size:28px"],
    [data-theme="dark"] [style*="font-size: 28px"] {
      filter: brightness(1.3);
      opacity: 1 !important;
    }
    
    /* ÊåâÈíÆ‰∏≠ÁöÑemojiÂõæÊ†á */
    [data-theme="dark"] button span,
    [data-theme="dark"] button::before,
    [data-theme="dark"] .btn::before {
      filter: brightness(1.2);
      opacity: 1 !important;
    }
    
    /* È°∂ÈÉ®ÊåâÈíÆÊñáÂ≠óÂíåÂõæÊ†á */
    /* Áî®Êà∑Â§¥ÂÉèÂíåËÆæÁΩÆÊåâÈíÆÊ†∑Âºè */
    #btnUserAvatar, #btnSettings {
      transition: all 0.2s ease;
    }
    #btnUserAvatar:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(102,126,234,0.4) !important;
    }
    #btnSettings:hover {
      background: rgba(255,255,255,0.2) !important;
      transform: scale(1.05);
    }
    
    [data-theme="dark"] .top-header-actions button {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .top-header-actions button span {
      filter: brightness(1.2);
      opacity: 1 !important;
    }
    
    /* ÊêúÁ¥¢Ê°ÜÂõæÊ†á */
    [data-theme="dark"] input[type="search"]::placeholder,
    [data-theme="dark"] .search-icon {
      color: #94a3b8 !important;
    }
    
    /* Á°Æ‰øùÊâÄÊúâÂ∏¶ËÉåÊôØÁöÑÂÖÉÁ¥†Âú®Â§úÈó¥Ê®°Âºè‰∏ãÊúâË∂≥Â§üÁöÑÂØπÊØîÂ∫¶ */
    [data-theme="dark"] [style*="background:rgba(255,255,255"],
    [data-theme="dark"] [style*="background: rgba(255,255,255"] {
      background: rgba(30, 41, 59, 0.8) !important;
      color: #f1f5f9 !important;
    }
    
    /* Êñ∞Â¢ûÈ∏ΩÂ≠êÊåâÈíÆÊöóËâ≤Ê®°ÂºèÊ†∑Âºè */
    [data-theme="dark"] #btnGoCreate {
      background: linear-gradient(135deg, #334155 0%, #1e293b 50%, #0f172a 100%) !important;
      color: #e2e8f0 !important;
      border: 1px solid rgba(71, 85, 105, 0.5) !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
    }
    
    [data-theme="dark"] #btnGoCreate:hover {
      background: linear-gradient(135deg, #475569 0%, #334155 50%, #1e293b 100%) !important;
      color: #f1f5f9 !important;
      border-color: #64748b !important;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4) !important;
      transform: translateY(-1px);
    }
    
    /* ÂõæË°®ÂÆπÂô® */
    [data-theme="dark"] #chartContainer {
      background: #1e293b !important;
      color: #f1f5f9 !important;
    }
    
    /* Ê®°ÊÄÅÊ°Ü‰∏≠ÁöÑÂõæÊ†áÂíåÊñáÂ≠ó */
    [data-theme="dark"] .modal-content .icon,
    [data-theme="dark"] .modal-content [class*="icon"] {
      filter: brightness(1.3);
      opacity: 1 !important;
    }
    
    /* Êó∂Èó¥ËΩ¥ÂíåÂàóË°®È°πÂõæÊ†á */
    [data-theme="dark"] .timeline-item [class*="icon"],
    [data-theme="dark"] .list-item [class*="icon"],
    [data-theme="dark"] li [class*="icon"] {
      filter: brightness(1.2);
      opacity: 1 !important;
    }
    
    /* Á°Æ‰øùÂõæÊ†áÂÆπÂô®ÊúâË∂≥Â§üÁöÑÂØπÊØîÂ∫¶ */
    [data-theme="dark"] .icon-container,
    [data-theme="dark"] [class*="icon-wrapper"] {
      background: rgba(51, 65, 85, 0.5) !important;
      border-color: #475569 !important;
    }
    
    /* Êï∞ÊçÆÊ¶ÇËßàÂç°Áâá‰∏≠ÁöÑÂõæÊ†áÂíåÊï∞Â≠ó */
    [data-theme="dark"] .home-overview .home-stat-icon,
    [data-theme="dark"] .home-overview .home-stat-number,
    [data-theme="dark"] .home-overview .home-stat-label {
      color: #f1f5f9 !important;
    }
    
    [data-theme="dark"] .home-overview .home-stat-icon {
      filter: brightness(1.3);
      opacity: 1 !important;
    }
    
    /* Á°Æ‰øùÊâÄÊúâÁªüËÆ°Êï∞Â≠óÊ∏ÖÊô∞ÂèØËßÅ */
    [data-theme="dark"] .stat-number,
    [data-theme="dark"] .number,
    [data-theme="dark"] [class*="number"] {
      color: #f1f5f9 !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    /* Ê†áÁ≠æÂíåÂæΩÁ´† */
    [data-theme="dark"] .badge,
    [data-theme="dark"] .tag,
    [data-theme="dark"] [class*="badge"] {
      color: #f1f5f9 !important;
      background: #475569 !important;
    }
    
    /* Á°Æ‰øùÊâÄÊúâÊñáÂ≠óÂú®Ê∑±Ëâ≤ËÉåÊôØ‰∏äÊ∏ÖÊô∞ */
    [data-theme="dark"] .card-body,
    [data-theme="dark"] .card-content,
    [data-theme="dark"] .content {
      color: #e2e8f0 !important;
    }
    
    /* ÂàóË°®È°π‰∏≠ÁöÑÂõæÊ†áÂíåÊñáÂ≠ó */
    [data-theme="dark"] li,
    [data-theme="dark"] .list-item {
      color: #e2e8f0 !important;
    }
    
    [data-theme="dark"] li [class*="icon"],
    [data-theme="dark"] .list-item [class*="icon"] {
      filter: brightness(1.2);
      opacity: 1 !important;
    }
    
    /* Ë°®Ê†º‰∏≠ÁöÑÂõæÊ†áÂíåÁä∂ÊÄÅÊåáÁ§∫Âô® */
    [data-theme="dark"] table [class*="icon"],
    [data-theme="dark"] table [class*="status"],
    [data-theme="dark"] table [class*="badge"] {
      filter: brightness(1.3);
      opacity: 1 !important;
    }
    
    /* Ë°®Âçï‰∏≠ÁöÑÂõæÊ†á */
    [data-theme="dark"] .form-group [class*="icon"],
    [data-theme="dark"] .form-group label [class*="icon"] {
      filter: brightness(1.2);
      opacity: 1 !important;
    }
    
    /* Á°Æ‰øùÊâÄÊúâemojiÂú®Â§úÈó¥Ê®°Âºè‰∏ãÈÉΩÊ∏ÖÊô∞ÂèØËßÅ */
    [data-theme="dark"] emoji,
    [data-theme="dark"] [role="img"] {
      filter: brightness(1.2);
      opacity: 1 !important;
    }
    
    /* ==========================================
       üì± ÁßªÂä®Á´ØÂìçÂ∫îÂºèÂ¢ûÂº∫
       ========================================== */
    
    /* ÁßªÂä®Á´ØÈÄöÁî®‰øÆÂ§ç - Á°Æ‰øùÊâÄÊúâÂäüËÉΩÊ®°ÂùóÂèØËßÅ */
    @media (max-width: 768px) {
      /* Á°Æ‰øùÈ¶ñÈ°µËßÜÂõæÈªòËÆ§ÊòæÁ§∫ */
      #homeView {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      /* Á°Æ‰øùÊâÄÊúâÈ¶ñÈ°µÊ®°ÂùóÂèØËßÅ */
      .home-section {
        display: flex !important;
        visibility: visible !important;
        flex-direction: column !important;
      }
      
      .home-content {
        display: grid !important;
        visibility: visible !important;
        grid-template-columns: 1fr !important;
      }
      
      .home-column {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        height: auto !important;
      }
      
      .home-sidebar {
        display: flex !important;
        visibility: visible !important;
      }
      
      .home-widget {
        display: block !important;
        visibility: visible !important;
      }
      
      .home-widget-header,
      .home-widget-content {
        display: flex !important;
        visibility: visible !important;
      }
      
      .home-widget-content {
        display: block !important;
      }
      
      .home-news-list,
      .home-events-list {
        display: block !important;
        visibility: visible !important;
      }
      
      .recommendation-item,
      .subscription-tags,
      .quick-links,
      .alert-item {
        display: flex !important;
        visibility: visible !important;
      }
    }
    
    @media (max-width: 768px) {
      /* È°∂ÈÉ®ÂØºËà™Ê†è‰ºòÂåñ */
      .top-header {
        padding: 0 12px;
        height: 60px;
        flex-wrap: nowrap;
      }
      .top-header h1 {
        font-size: 14px;
        flex: 1;
        min-width: 0;
      }
      .top-header h1::before {
        font-size: 18px;
      }
      .top-header p {
        display: none;
      }
      .top-header-actions {
        gap: 6px;
        flex-wrap: nowrap;
      }
      
      /* ÊòæÁ§∫ÁßªÂä®Á´ØËèúÂçïÊåâÈíÆ */
      .mobile-menu-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        order: -1;
        margin-right: 8px;
      }
      
      /* ÊòæÁ§∫‰æßËæπÊ†èÈÅÆÁΩ©Â±Ç */
      .sidebar-overlay {
        display: block;
      }
      
      /* ‰æßËæπÊ†èÁßªÂä®Á´Ø‰ºòÂåñ */
      .sidebar {
        transform: translateX(-100%);
        width: 280px;
        transition: transform var(--transition-normal);
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .sidebar-menu {
        padding: 16px 8px;
      }
      .sidebar-item {
        padding: 12px 14px;
        font-size: 13px;
      }
      .sidebar-item-icon {
        font-size: 16px;
        margin-right: 10px;
        width: 20px;
      }
      
      /* ‰∏ªÂÜÖÂÆπÂå∫‰ºòÂåñ */
      .main-content {
        margin-left: 0;
        padding: 12px;
        margin-top: 60px;
        overflow-x: hidden;
        overflow-y: visible;
        width: 100%;
      }
      .content-wrapper {
        max-width: 100%;
        overflow-x: hidden;
      }
      
      /* Á°Æ‰øùÈ¶ñÈ°µÂå∫ÂüüÂèØ‰ª•Ê≠£Â∏∏ÊªöÂä® */
      .home-section {
        overflow-x: hidden;
        overflow-y: visible;
        width: 100%;
        display: flex !important;
        visibility: visible !important;
        flex-direction: column !important;
      }
      
      .home-content {
        min-height: auto;
        width: 100%;
        overflow-x: hidden;
        display: grid !important;
        visibility: visible !important;
        grid-template-columns: 1fr !important;
      }
      
      .home-column {
        overflow: visible;
        min-height: auto;
        max-height: none;
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        height: auto !important;
      }
      
      .home-news-list,
      .home-events-list {
        overflow-y: visible;
        max-height: none;
        min-height: auto;
        display: block !important;
        visibility: visible !important;
      }
      
      .home-sidebar {
        display: flex !important;
        visibility: visible !important;
        flex-direction: column !important;
      }
      
      .home-widget {
        display: block !important;
        visibility: visible !important;
      }
      
      .home-widget-header {
        display: flex !important;
        visibility: visible !important;
      }
      
      .home-widget-content {
        display: block !important;
        visibility: visible !important;
      }
      
      /* Á°Æ‰øùÊâÄÊúâÂäüËÉΩÊ®°ÂùóÂèØËßÅ */
      #homeView {
        display: flex !important;
        visibility: visible !important;
      }
      
      .recommendation-item,
      .subscription-tags,
      .quick-links,
      .alert-item {
        display: flex !important;
        visibility: visible !important;
      }
      
      /* ÊêúÁ¥¢Ê°Ü‰ºòÂåñ */
      .smart-search-container {
        order: -1;
        width: 100%;
        margin-bottom: 8px;
      }
      .smart-search-container input {
        width: 100% !important;
        font-size: 13px;
        padding: 8px 12px;
      }
      
      /* Âç°Áâá‰ºòÂåñ */
      .card {
        padding: 16px;
        margin-bottom: 16px;
        border-radius: var(--radius-md);
        overflow: visible;
        width: 100%;
        box-sizing: border-box;
      }
      
      /* Á°Æ‰øùÊâÄÊúâËßÜÂõæÈÉΩÂèØ‰ª•Ê≠£Â∏∏ÊòæÁ§∫ */
      section[id$="View"],
      .card {
        overflow-x: hidden;
        overflow-y: visible;
        width: 100%;
        max-width: 100%;
      }
      .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
        padding-bottom: 16px;
        margin-bottom: 16px;
      }
      .card-header h2 {
        font-size: 18px;
        width: 100%;
      }
      
      /* Ë°®Âçï‰ºòÂåñ */
      .form-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .form-group {
        margin-bottom: 16px;
      }
      .form-group label {
        font-size: 13px;
        margin-bottom: 6px;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        font-size: 14px;
        padding: 10px 12px;
      }
      
      /* ÊåâÈíÆ‰ºòÂåñ */
      .btn {
        padding: 10px 16px;
        font-size: 13px;
        width: 100%;
        justify-content: center;
      }
      .btn-sm {
        padding: 8px 12px;
        font-size: 12px;
      }
      .top-header-actions .btn {
        width: auto;
        padding: 6px 10px;
        font-size: 12px;
      }
      
      /* ÁªüËÆ°Âç°Áâá‰ºòÂåñ */
      .stats-cards {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .stat-card {
        padding: 16px;
      }
      .stat-card-label {
        font-size: 12px;
        margin-bottom: 8px;
      }
      .stat-card-number {
        font-size: 28px;
      }
      
      /* È∏ΩÂ≠êÂç°Áâá‰ºòÂåñ */
      .pigeon-cards {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .pigeon-card {
        padding: 12px;
      }
      .pigeon-card-name {
        font-size: 14px;
      }
      .pigeon-card-info-item {
        font-size: 11px;
        padding: 5px 6px;
      }
      
      /* Ë°®Ê†º‰ºòÂåñ */
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        -ms-overflow-style: -ms-autohiding-scrollbar;
      }
      table {
        font-size: 12px;
        min-width: 600px;
        width: 100%;
      }
      table th,
      table td {
        padding: 8px 10px;
        white-space: nowrap;
      }
      
      /* Â≠óÊÆµË°å‰ºòÂåñ */
      .field-row {
        flex-direction: column;
        align-items: flex-start;
        padding: 12px;
      }
      .field-label {
        width: 100%;
        text-align: left;
        padding-right: 0;
        padding-bottom: 6px;
        border-right: none;
        border-bottom: 1px solid #f0f0f0;
        margin-bottom: 6px;
        font-size: 12px;
      }
      .field-value {
        padding-left: 0;
        width: 100%;
        font-size: 13px;
      }
      
      /* Ê†áÁ≠æÈ°µ‰ºòÂåñ */
      .race-tab-btn {
        padding: 8px 12px;
        font-size: 12px;
      }
      
      /* ÂÖ∂‰ªñÂÖÉÁ¥†‰ºòÂåñ */
      .breeding-selector-row {
        grid-template-columns: 1fr !important;
        gap: 12px;
      }
      .view-switcher {
        flex-wrap: wrap;
        gap: 4px;
      }
      .view-switch-btn {
        padding: 8px 12px;
        font-size: 12px;
        flex: 1;
        min-width: 0;
      }
      
      /* ÂõæÁâá‰ºòÂåñ */
      .image-thumb {
        width: 100%;
        max-width: 100%;
        height: auto;
        min-height: 200px;
      }
      
      /* Ê®°ÊÄÅÊ°Ü‰ºòÂåñ */
      .modal-content {
        width: calc(100vw - 24px);
        max-width: 100%;
        margin: 12px;
        padding: 16px;
      }
      
      /* Â∑•ÂÖ∑ÊèêÁ§∫‰ºòÂåñ */
      [title] {
        cursor: pointer;
      }
    }
    
    /* Ë∂ÖÂ∞èÂ±èÂπï‰ºòÂåñÔºàÂ∞è‰∫é480pxÔºâ */
    @media (max-width: 480px) {
      .top-header h1 {
        font-size: 12px;
      }
      .top-header h1::before {
        font-size: 16px;
      }
      .main-content {
        padding: 8px;
        overflow-x: hidden;
        overflow-y: visible;
        width: 100%;
      }
      .card {
        padding: 12px;
        overflow: visible;
        width: 100%;
        box-sizing: border-box;
      }
      .stat-card-number {
        font-size: 24px;
      }
      .btn {
        padding: 10px 12px;
        font-size: 12px;
      }
      
      /* Á°Æ‰øùÈ¶ñÈ°µÊâÄÊúâÊ®°ÂùóÈÉΩÂèØ‰ª•Êü•Áúã */
      .home-section {
        width: 100%;
        overflow-x: hidden;
        overflow-y: visible;
      }
      
      .home-content {
        width: 100%;
        min-height: auto;
        overflow-x: hidden;
      }
      
      .home-column {
        width: 100%;
        overflow: visible;
        min-height: auto;
        max-height: none;
      }
      
      .home-news-list,
      .home-events-list {
        width: 100%;
        overflow-y: visible;
        max-height: none;
        min-height: auto;
      }
      
      .home-widget {
        width: 100%;
        overflow: visible;
      }
      
      .home-widget-content {
        overflow: visible;
        max-height: none;
      }
    }
    
    /* ==========================================
       üñ®Ô∏è ÊâìÂç∞Ê†∑Âºè
       ========================================== */
    @media print {
      .top-header,
      .sidebar,
      .btn,
      .home-announcement,
      .evo-assistant {
        display: none !important;
      }
      
      .main-content {
        margin: 0;
        padding: 20px;
      }
      
      .card {
        box-shadow: none;
        border: 1px solid #ddd;
        page-break-inside: avoid;
      }
    }

    /* ============================================
       üïäÔ∏è Evo Êô∫ËÉΩÂä©ÊâãÊ†∑Âºè
       ============================================ */
    
    /* Evo ÊµÆÂä®ÊåâÈíÆÂíåÂõæÊ†á */
    .evo-assistant {
      position: fixed !important;
      bottom: 30vh !important;
      right: 20px !important;
      z-index: 99999 !important;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      pointer-events: auto !important;
      /* ÁßªÈô§Âä®ÁîªÔºå‰øùÊåÅÂõ∫ÂÆö‰ΩçÁΩÆ */
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    @keyframes evo-float {
      0%, 100% { transform: translateY(0px) translateX(0px); }
      25% { transform: translateY(-10px) translateX(5px); }
      50% { transform: translateY(-15px) translateX(0px); }
      75% { transform: translateY(-10px) translateX(-5px); }
    }

    .evo-icon-button {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 8px 30px rgba(102, 126, 234, 0.7), 
                  0 0 50px rgba(102, 126, 234, 0.5),
                  0 0 80px rgba(102, 126, 234, 0.3);
      cursor: pointer;
      display: flex !important;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
      visibility: visible !important;
      opacity: 1 !important;
      /* ÁßªÈô§Âä®ÁîªÔºå‰øùÊåÅÂõ∫ÂÆö‰ΩçÁΩÆ */
      border: 3px solid rgba(255, 255, 255, 0.3);
    }

    @keyframes evo-button-float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      25% { transform: translateY(-8px) rotate(-3deg); }
      50% { transform: translateY(-12px) rotate(0deg); }
      75% { transform: translateY(-8px) rotate(3deg); }
    }

    .evo-icon-button:hover {
      transform: scale(1.15) translateY(-5px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.7), 
                  0 0 40px rgba(102, 126, 234, 0.4);
      /* ÁßªÈô§ animation-play-stateÔºåÂõ†‰∏∫Â∑≤ÁªèÁßªÈô§‰∫ÜÂä®Áîª */
    }

    .evo-pigeon-icon {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .evo-icon {
      font-size: 40px;
      /* ÁßªÈô§Âä®ÁîªÔºå‰øùÊåÅÂõ∫ÂÆö‰ΩçÁΩÆ */
      display: block;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4)) 
              drop-shadow(0 0 20px rgba(102, 126, 234, 0.6));
      z-index: 1;
      position: relative;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    @keyframes evo-fly {
      0%, 100% { transform: translateY(0) rotate(0deg) scale(1); }
      15% { transform: translateY(-3px) rotate(-8deg) scale(1.05); }
      30% { transform: translateY(-6px) rotate(0deg) scale(1.1); }
      45% { transform: translateY(-3px) rotate(8deg) scale(1.05); }
      60% { transform: translateY(0) rotate(0deg) scale(1); }
      75% { transform: translateY(-2px) rotate(-4deg) scale(1.02); }
      90% { transform: translateY(0) rotate(0deg) scale(1); }
    }

    .evo-pulse {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: rgba(102, 126, 234, 0.3);
      animation: evo-pulse 2s ease-in-out infinite;
    }

    @keyframes evo-pulse {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.5); opacity: 0; }
    }

    .evo-notification-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      width: 12px;
      height: 12px;
      background: #f56c6c;
      border-radius: 50%;
      border: 2px solid white;
      animation: evo-badge-pulse 1s ease-in-out infinite;
    }

    @keyframes evo-badge-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    /* Evo ÂØπËØùÊ°Ü */
    .evo-dialog {
      position: absolute;
      bottom: 100px; /* ÂõæÊ†áÈ´òÂ∫¶70px + 30pxÈó¥Ë∑ùÔºåÁ°Æ‰øùÂØπËØùÊ°Ü‰∏çË¢´ÂõæÊ†áÈÅÆ‰Ωè */
      right: 90px; /* ÂõæÊ†áÂÆΩÂ∫¶70px + 20pxÈó¥Ë∑ùÔºåÂØπËØùÊ°ÜÊòæÁ§∫Âú®ÂõæÊ†áÂ∑¶‰æß */
      width: 320px; /* Áº©Â∞èÂØπËØùÊ°ÜÂ∞∫ÂØ∏ */
      max-width: calc(90vw - 120px); /* Á°Æ‰øù‰∏ç‰ºöË∂ÖÂá∫Â±èÂπï */
      max-height: 80vh;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: evo-dialog-appear 0.3s ease-out;
    }

    /* Ê¨¢ËøéÊ∂àÊÅØÊ∞îÊ≥°ÂºπÁ™óÔºàÁ±ª‰ººÂæÆ‰ø°Ê∂àÊÅØÊ∞îÊ≥°Ôºâ */
    .evo-welcome-bubble {
      position: fixed;
      bottom: calc(30vh + 100px); /* ÂõæÊ†á‰∏äÊñπ100pxÔºàÂõæÊ†á‰ΩçÁΩÆ30vh + Èó¥Ë∑ù100pxÔºâ */
      right: 20px; /* ‰∏éÂõæÊ†áÂè≥ËæπÁºòÂØπÈΩê */
      z-index: 99998;
      max-width: 280px;
      animation: evo-bubble-appear 0.3s ease-out;
      pointer-events: auto;
    }

    .evo-welcome-bubble-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* ‰∏éÂØπËØùÊ°Ü‰∏ÄËá¥ÁöÑÁ¥´Ëâ≤Ê∏êÂèò */
      color: #fff; /* ÁôΩËâ≤ÊñáÂ≠ó */
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.5;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4), 0 0 30px rgba(118, 75, 162, 0.3);
      position: relative;
      word-wrap: break-word;
      font-weight: 500;
    }

    /* Ê∞îÊ≥°Â∞èÂ∞æÂ∑¥ÔºàÊåáÂêëÂè≥‰æßÁöÑÂõæÊ†áÔºâ */
    .evo-welcome-bubble-content::after {
      content: '';
      position: absolute;
      bottom: -8px;
      right: 35px; /* Â∞èÂ∞æÂ∑¥Âú®Ê∞îÊ≥°Âè≥‰æßÔºåÊåáÂêëÂõæÊ†á‰∏≠ÂøÉÔºàÂõæÊ†áÂÆΩÂ∫¶70pxÁöÑ‰∏ÄÂçäÔºâ */
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid #764ba2; /* ‰ΩøÁî®Ê∏êÂèòÁöÑÊ∑±Ëâ≤ÈÉ®ÂàÜ */
    }

    @keyframes evo-bubble-appear {
      from {
        opacity: 0;
        transform: translateY(10px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes evo-bubble-disappear {
      from {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateY(-10px) scale(0.9);
      }
    }

    .evo-welcome-bubble.hiding {
      animation: evo-bubble-disappear 0.3s ease-out forwards;
    }

    @keyframes evo-dialog-appear {
      from { opacity: 0; transform: translateX(20px) translateY(20px) scale(0.9); }
      to { opacity: 1; transform: translateX(0) translateY(0) scale(1); }
    }

    .evo-header {
      padding: 16px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .evo-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .evo-icon-large {
      font-size: 32px;
      animation: evo-fly 3s ease-in-out infinite;
    }

    .evo-title {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .evo-subtitle {
      margin: 2px 0 0 0;
      font-size: 12px;
      opacity: 0.9;
    }

    .evo-close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.3s;
    }

    .evo-close-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .evo-content {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .evo-tabs {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .evo-tab-headers {
      display: flex;
      border-bottom: 1px solid #e4e7ed;
      padding: 0 8px;
      background: #f5f7fa;
    }

    .evo-tab-header {
      padding: 8px 10px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
      font-size: 12px;
      color: #606266;
      white-space: nowrap;
      flex: 1;
      text-align: center;
    }

    .evo-tab-header.active {
      color: #667eea;
      border-bottom-color: #667eea;
      font-weight: 600;
    }

    .evo-tab-header:hover {
      color: #667eea;
    }

    .evo-tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: none;
    }

    .evo-tab-content.active {
      display: block;
    }

    /* ÂØπËØùÁïåÈù¢ */
    .evo-chat-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      max-height: 500px;
    }

    .evo-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 0;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .evo-message {
      display: flex;
      gap: 12px;
      animation: evo-message-appear 0.3s ease-out;
    }

    .evo-message.user {
      flex-direction: row-reverse;
      align-items: flex-start;
    }
    
    .evo-message.user .evo-message-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      max-width: 70%;
      flex: 0 1 auto;
    }

    @keyframes evo-message-appear {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .evo-message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #f5f7fa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .evo-message.user .evo-message-avatar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .evo-message-content {
      flex: 0 1 auto;
      max-width: 100%;
      min-width: 0;
      display: flex;
      flex-direction: column;
      width: fit-content;
    }
    
    .evo-message.evo .evo-message-content {
      max-width: 70%;
      width: fit-content;
    }

    .evo-message.user .evo-message-content {
      text-align: right;
      align-items: flex-end;
      max-width: 100%;
    }

    .evo-message-text {
      background: #f5f7fa;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
      display: inline-block;
      max-width: 100%;
      width: fit-content;
    }

    .evo-message.user .evo-message-text {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-left: auto;
    }

    .evo-message-time {
      font-size: 11px;
      color: #909399;
      margin-top: 4px;
      padding: 0 4px;
      display: inline-block;
      width: fit-content;
    }

    .evo-message.user .evo-message-time {
      text-align: right;
      margin-top: 4px;
      padding-right: 4px;
    }
    
    .evo-message.evo .evo-message-time {
      margin-top: 4px;
    }

    .evo-typing-indicator {
      display: flex;
      gap: 4px;
      padding: 10px 14px;
    }

    .evo-typing-indicator span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #909399;
      animation: evo-typing 1.4s ease-in-out infinite;
    }

    .evo-typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .evo-typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes evo-typing {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
      30% { transform: translateY(-10px); opacity: 1; }
    }

    .evo-input-area {
      padding-top: 16px;
      border-top: 1px solid #e4e7ed;
    }

    .evo-input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .evo-input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #e4e7ed;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: all 0.3s;
    }

    .evo-input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    .evo-send-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .evo-send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .evo-send-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .evo-quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .evo-quick-action-btn {
      padding: 4px 8px;
      background: #f5f7fa;
      border: 1px solid #e4e7ed;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .evo-quick-action-btn:hover {
      background: #e4e7ed;
      border-color: #667eea;
      color: #667eea;
    }

    /* Êï∞ÊçÆÂàÜÊûê„ÄÅÊé®Ëçê„ÄÅËÆæÁΩÆÁïåÈù¢ */
    .evo-analytics, .evo-recommendations, .evo-settings {
      max-height: 500px;
      overflow-y: auto;
    }

    .evo-analytics-card, .evo-recommendation-card, .evo-reminder-card {
      background: #f5f7fa;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 3px solid #667eea;
      cursor: pointer;
      transition: all 0.3s;
    }

    .evo-recommendation-card:hover, .evo-reminder-card:hover {
      background: #e4e7ed;
      transform: translateX(4px);
    }

    .evo-reminder-card.priority-high {
      background: #fff1f0;
      border-left-color: #f5222d;
    }

    .evo-empty {
      text-align: center;
      padding: 40px 20px;
      color: #909399;
    }

    /* Evo Ê∑±Ëâ≤Ê®°ÂºèÈÄÇÈÖç */
    [data-theme="dark"] .evo-dialog {
      background: #1e293b !important;
      border-color: #334155;
    }

    [data-theme="dark"] .evo-tab-headers {
      background: #334155 !important;
      border-bottom-color: #475569 !important;
    }

    [data-theme="dark"] .evo-tab-header {
      color: #94a3b8 !important;
    }

    [data-theme="dark"] .evo-tab-header.active {
      color: #a78bfa !important;
      border-bottom-color: #a78bfa !important;
    }

    [data-theme="dark"] .evo-tab-header:hover {
      color: #a78bfa !important;
    }

    [data-theme="dark"] .evo-tab-content {
      background: #1e293b !important;
      color: #f1f5f9 !important;
    }

    [data-theme="dark"] .evo-message-avatar {
      background: #334155 !important;
    }

    [data-theme="dark"] .evo-message-text {
      background: #334155 !important;
      color: #f1f5f9 !important;
    }

    [data-theme="dark"] .evo-message-time {
      color: #94a3b8 !important;
    }

    [data-theme="dark"] .evo-typing-indicator span {
      background: #94a3b8 !important;
    }

    [data-theme="dark"] .evo-input-area {
      border-top-color: #475569 !important;
    }

    [data-theme="dark"] .evo-input {
      background: #334155 !important;
      border-color: #475569 !important;
      color: #f1f5f9 !important;
    }

    [data-theme="dark"] .evo-input::placeholder {
      color: #64748b !important;
    }

    [data-theme="dark"] .evo-input:focus {
      border-color: #a78bfa !important;
      box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.2) !important;
    }

    [data-theme="dark"] .evo-quick-action-btn {
      background: #334155 !important;
      border-color: #475569 !important;
      color: #f1f5f9 !important;
    }

    [data-theme="dark"] .evo-quick-action-btn:hover {
      background: #475569 !important;
      border-color: #a78bfa !important;
      color: #a78bfa !important;
    }

    [data-theme="dark"] .evo-analytics-card,
    [data-theme="dark"] .evo-recommendation-card,
    [data-theme="dark"] .evo-reminder-card {
      background: #334155 !important;
      border-left-color: #a78bfa !important;
      color: #f1f5f9 !important;
    }

    [data-theme="dark"] .evo-recommendation-card:hover,
    [data-theme="dark"] .evo-reminder-card:hover {
      background: #475569 !important;
    }

    [data-theme="dark"] .evo-reminder-card.priority-high {
      background: #7f1d1d !important;
      border-left-color: #ef4444 !important;
    }

    [data-theme="dark"] .evo-empty {
      color: #94a3b8 !important;
    }

    [data-theme="dark"] .evo-analytics,
    [data-theme="dark"] .evo-recommendations,
    [data-theme="dark"] .evo-settings {
      color: #f1f5f9 !important;
    }

    [data-theme="dark"] .evo-settings label {
      color: #f1f5f9 !important;
    }

    [data-theme="dark"] .evo-settings input[type="text"],
    [data-theme="dark"] .evo-settings input[type="password"] {
      background: #334155 !important;
      border-color: #475569 !important;
      color: #f1f5f9 !important;
    }

    [data-theme="dark"] .evo-settings input::placeholder {
      color: #64748b !important;
    }

    [data-theme="dark"] .evo-settings button {
      background: #4c1d95 !important;
      color: white !important;
    }

    [data-theme="dark"] .evo-settings button:hover {
      background: #5b21b6 !important;
    }

    [data-theme="dark"] .evo-settings div[style*="color: #909399"],
    [data-theme="dark"] .evo-settings div[style*="color: #606266"] {
      color: #94a3b8 !important;
    }

    /* ÊöóËâ≤Ê®°Âºè‰∏ãÁöÑÊ¨¢ËøéÊ∞îÊ≥°Ôºà‰øùÊåÅÁ¥´Ëâ≤Ê∏êÂèòÔºåÂ¢ûÂº∫ÂØπÊØîÂ∫¶Ôºâ */
    [data-theme="dark"] .evo-welcome-bubble-content {
      background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%) !important;
      box-shadow: 0 4px 20px rgba(124, 58, 237, 0.5), 0 0 30px rgba(147, 51, 234, 0.4) !important;
    }

    [data-theme="dark"] .evo-welcome-bubble-content::after {
      border-top-color: #9333ea !important;
    }

    /* ÁßªÂä®Á´ØÈÄÇÈÖç */
    @media (max-width: 768px) {
      .evo-assistant {
        bottom: 30vh;
        right: 15px;
      }
      
      .evo-dialog {
        width: calc(100vw - 30px);
        max-width: none;
        bottom: 100px; /* ÂõæÊ†á‰∏äÊñπÔºåÁ°Æ‰øù‰∏çË¢´ÈÅÆÊå° */
        right: 0;
        max-height: calc(100vh - 100px);
      }

      .evo-welcome-bubble {
        bottom: calc(30vh + 100px); /* ‰∏éÂõæÊ†áÂØπÈΩêÔºåÂõæÊ†á‰∏äÊñπ100px */
        right: 15px; /* ‰∏éÁßªÂä®Á´ØÂõæÊ†á‰ΩçÁΩÆÂØπÈΩê */
        max-width: calc(100vw - 100px);
      }

      .evo-message-content {
        max-width: 80%;
      }
      
      .evo-message.evo .evo-message-content {
        max-width: 75%;
        width: fit-content;
      }
    }
  </style>
</head>
<body>
<!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
<div class="top-header">
  <h1>Êô∫È∏ΩÔΩúPigeonAI</h1>
  <p style="margin:0;font-size:14px;color:rgba(255,255,255,0.8);font-weight:400;margin-top:4px;">ÊØèÂè™È∏ΩÂ≠êÔºåÁöÜÊòØËµõÁ∫ß ÔΩúEvery Pigeon, Race-Grade</p>
  <div class="top-header-actions">
    <div class="smart-search-container" style="position:relative;">
      <input type="text" id="smartSearchInput" placeholder="Êô∫ËÉΩÊêúÁ¥¢: Â¶Ç '2022 ÂÖ¨È∏Ω ËøõÂ•ñ' ÊàñË∂≥ÁéØÂè∑..." style="padding:10px 16px;border-radius:8px;border:none;background:rgba(255,255,255,0.15);color:#fff;font-size:14px;width:320px;outline:none;" />
      <div id="searchSuggestions" class="smart-search-suggestions" style="position:absolute;top:100%;left:0;right:0;background:#fff;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,0.2);margin-top:8px;max-height:300px;overflow-y:auto;display:none;z-index:1001;">
        <!-- ÊêúÁ¥¢Âª∫ËÆÆÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
      </div>
    </div>
    <button class="btn btn-sm" id="btnTestBubble" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;font-weight:600;box-shadow:0 4px 12px rgba(102,126,234,0.3);display:none;" title="ÊµãËØïÊ¨¢ËøéÊ∞îÊ≥°">üí¨ ÊµãËØïÊ∞îÊ≥°</button>
    <button class="btn btn-sm" id="btnGoCreate" style="background:linear-gradient(135deg, #fff 0%, #f0f7ff 100%);color:#1e293b;border:none;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,0.15);">‚ûï Êñ∞Â¢ûÈ∏ΩÂ≠ê</button>
    <!-- Áî®Êà∑Â§¥ÂÉè -->
    <button class="btn btn-sm" id="btnUserAvatar" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none;font-weight:600;box-shadow:0 4px 12px rgba(102,126,234,0.3);padding:8px 16px;border-radius:20px;display:flex;align-items:center;justify-content:center;gap:6px;font-size:14px;cursor:pointer;" title="Êü•ÁúãË¥¶Êà∑‰ø°ÊÅØ">
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2'%3E%3C/path%3E%3Ccircle cx='12' cy='7' r='4'%3E%3C/circle%3E%3C/svg%3E" alt="Áî®Êà∑" style="width:20px;height:20px;object-fit:contain;" />
      <span>Ë¥¶Êà∑</span>
    </button>
    <!-- ËÆæÁΩÆÊåâÈíÆ -->
    <button class="btn btn-sm" id="btnSettings" style="background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.15);backdrop-filter:blur(10px);padding:8px 16px;border-radius:8px;display:flex;align-items:center;justify-content:center;gap:6px;font-size:14px;cursor:pointer;" title="Á≥ªÁªüËÆæÁΩÆ">
      <span style="font-size:16px;">‚öôÔ∏è</span>
      <span>ËÆæÁΩÆ</span>
    </button>
  </div>
</div>

<!-- Â∑¶‰æßËèúÂçï -->
<div class="sidebar">
  <div class="sidebar-menu">
    <div class="sidebar-item active" data-view="homeView">
      <span class="sidebar-item-icon">üè†</span>
      <span>È¶ñÈ°µ</span>
    </div>
    <div class="sidebar-item" data-view="dashboardView">
      <span class="sidebar-item-icon">üìä</span>
      <span>Êï∞ÊçÆÊ¶ÇËßà</span>
    </div>
    <div class="sidebar-item" data-view="listView">
      <span class="sidebar-item-icon">üìã</span>
      <span>È∏ΩÂ≠êÁÆ°ÁêÜ</span>
    </div>
    <div class="sidebar-item" data-view="pedigreeView">
      <span class="sidebar-item-icon">üß¨</span>
      <span>Ë°ÄÁªüÂÖ≥Á≥ª</span>
    </div>
    <div class="sidebar-item" data-view="statsView">
      <span class="sidebar-item-icon">üìà</span>
      <span>ÁªüËÆ°ÂàÜÊûê</span>
    </div>
    <div class="sidebar-item" data-view="raceView">
      <span class="sidebar-item-icon">üèÜ</span>
      <span>ÊØîËµõ‰∏éÊàêÁª©ÁÆ°ÁêÜ</span>
    </div>
    <div class="sidebar-item" data-view="breedingView">
      <span class="sidebar-item-icon">üß¨</span>
      <span>ÁπÅËÇ≤‰∏éÈÖçÂØπ</span>
    </div>
    <div class="sidebar-item" data-view="healthView">
      <span class="sidebar-item-icon">ü©∫</span>
      <span>ÂÅ•Â∫∑ÁÆ°ÁêÜ</span>
    </div>
    <div class="sidebar-item" data-view="analysisView">
      <span class="sidebar-item-icon">üß†</span>
      <span>Êô∫ËÉΩÂàÜÊûê‰∏≠ÂøÉ</span>
    </div>
    <div class="sidebar-item" data-view="trainingView">
      <span class="sidebar-item-icon">üèÉ</span>
      <span>ËÆ≠ÁªÉÊ®°Âùó</span>
    </div>
    <div class="sidebar-item" data-view="qualificationView">
      <span class="sidebar-item-icon">üéØ</span>
      <span>ËÉΩÂäõÁªºÂêàÂàÜÊûê</span>
    </div>
    <div class="sidebar-item" data-open-feedback="true">
      <span class="sidebar-item-icon">üêõ</span>
      <span>ÊÑèËßÅ‰∏éÂèçÈ¶à</span>
    </div>
  </div>
</div>

<!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
<div class="main-content">
  <div class="content-wrapper">

  <!-- üè† È¶ñÈ°µ ¬∑ ËµõÈ∏ΩËµÑËÆØ‰∏≠ÂøÉ -->
  <section id="homeView" class="home-section">
    <!-- È°∂ÈÉ®‰ªäÊó•Ê¶ÇËßà -->
    <div class="home-overview">
      <div class="home-overview-left">
        <div class="home-date">
          <span class="home-date-day" id="homeDay">19</span>
          <div class="home-date-info">
            <span class="home-date-weekday" id="homeWeekday">ÊòüÊúü‰∫î</span>
            <span class="home-date-full" id="homeDateFull">2025Âπ¥12Êúà</span>
          </div>
        </div>
        <div class="home-weather" id="homeWeather">
          <span style="font-size:28px;">‚òÄÔ∏è</span>
          <div>
            <div style="font-weight:600;">Êô¥Êúó</div>
            <div style="font-size:12px;color:#6b7280;">ÈÄÇÂêàÊîæÈ£û</div>
          </div>
        </div>
        <!-- ÂÖ¨ÂëäÊ†è -->
        <div class="home-announcement-bubble" id="homeAnnouncementBubble">
          <span class="home-announcement-icon">üì¢</span>
          <div class="home-announcement-content">
            <div class="home-announcement-text" id="homeAnnouncementBubbleText">ÊöÇÊó†ÂÖ¨Âëä</div>
            <div style="font-size:12px;color:#6b7280;">Á≥ªÁªüÂÖ¨Âëä <span class="home-announcement-hint" id="announcementHint" style="display:none;">ÁÇπÂáªÊü•ÁúãÂÆåÊï¥</span></div>
          </div>
        </div>
      </div>
      
      <!-- Âè≥‰∏ãËßíÔºöÂàáÊç¢Âà∞ÁßªÂä®Á´ØÂÖ•Âè£ -->
      <div style="position: fixed; right: 16px; bottom: 16px; z-index: 1200;">
        <button 
          class="btn btn-outline btn-sm" 
          onclick="(function(){ try { localStorage.setItem('pigeon_forced_view','mobile'); window.location.href='mobile.html'; } catch(e) { window.location.href='mobile.html'; } })()"
          style="border-radius: 999px; padding: 6px 12px; font-size: 12px; backdrop-filter: blur(12px); background: rgba(15,23,42,0.75); color:#e5e7eb; border-color: rgba(148,163,184,0.6);">
          üì± ÂàáÊç¢Âà∞ÁßªÂä®Áâà
        </button>
      </div>
      <div class="home-overview-stats">
        <div class="home-stat-item">
          <span class="home-stat-icon">üì∞</span>
          <div class="home-stat-content">
            <span class="home-stat-number" id="homeNewsCount">12</span>
            <span class="home-stat-label">‰ªäÊó•ËµÑËÆØ</span>
          </div>
        </div>
        <div class="home-stat-item">
          <span class="home-stat-icon">üèÅ</span>
          <div class="home-stat-content">
            <span class="home-stat-number" id="homeActiveRaces">3</span>
            <span class="home-stat-label">ËøõË°å‰∏≠Ëµõ‰∫ã</span>
          </div>
        </div>
        <div class="home-stat-item">
          <span class="home-stat-icon">üèÜ</span>
          <div class="home-stat-content">
            <span class="home-stat-number" id="homeCompletedRaces">5</span>
            <span class="home-stat-label">Â∑≤ÂÖ¨Â∏ÉÊàêÁª©</span>
          </div>
        </div>
        <div class="home-stat-item">
          <span class="home-stat-icon">üïäÔ∏è</span>
          <div class="home-stat-content">
            <span class="home-stat-number" id="homePigeonCount">0</span>
            <span class="home-stat-label">ÊàëÁöÑÈ∏ΩÂ≠ê</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ÈáçË¶ÅÂÖ¨Âëä -->
    <div class="home-announcement" id="homeAnnouncement" style="display:none;">
      <span class="announcement-icon">üì¢</span>
      <span class="announcement-text" id="announcementText"></span>
      <button class="btn btn-sm btn-ghost" id="btnCloseAnnouncement">‚úï</button>
    </div>
    
    <!-- ÂÖ¨ÂëäËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
    <div class="announcement-modal" id="announcementModal">
      <div class="announcement-modal-content">
        <div class="announcement-modal-header">
          <h3 class="announcement-modal-title">
            <span>üì¢</span>
            <span>Á≥ªÁªüÂÖ¨Âëä</span>
          </h3>
          <button class="announcement-modal-close" onclick="closeAnnouncementModal()">√ó</button>
        </div>
        <div class="announcement-modal-body">
          <div class="announcement-modal-content-text" id="announcementModalContent">Âä†ËΩΩ‰∏≠...</div>
          <div class="announcement-modal-meta" id="announcementModalMeta"></div>
        </div>
      </div>
    </div>

    <!-- ‰∏âÊ†èÂ∏ÉÂ±Ä -->
    <div class="home-content">
      <!-- Â∑¶Ê†èÔºöËµõÈ∏ΩËµÑËÆØÊµÅ -->
      <div class="home-column home-news">
        <div class="home-column-header">
          <h3>üì∞ ËµõÈ∏ΩËµÑËÆØ</h3>
          <div class="news-filter">
            <button class="news-filter-btn active" data-filter="all">ÂÖ®ÈÉ®</button>
            <button class="news-filter-btn" data-filter="race">Ëµõ‰∫ã</button>
            <button class="news-filter-btn" data-filter="breeding">ËÇ≤Áßç</button>
            <button class="news-filter-btn" data-filter="health">ÂÅ•Â∫∑</button>
          </div>
        </div>
        <div class="news-region-tabs">
          <button class="news-region-tab active" data-region="local">üìç Êú¨Âú∞ËµÑËÆØ</button>
          <button class="news-region-tab" data-region="national">üåê ÂÖ®ÂõΩËµÑËÆØ</button>
        </div>
        <div class="home-news-list" id="homeNewsList">
          <!-- ËµÑËÆØÂç°ÁâáÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
        </div>
        <div class="home-column-footer">
          <button class="btn btn-outline btn-sm" id="btnRefreshNews">üîÑ Âà∑Êñ∞ËµÑËÆØ</button>
          <button class="btn btn-outline btn-sm" id="btnLoadMoreNews">Âä†ËΩΩÊõ¥Â§ö</button>
        </div>
      </div>

      <!-- ‰∏≠Ê†èÔºöÂÆûÊó∂Ëµõ‰∫ã -->
      <div class="home-column home-events">
        <div class="home-column-header">
          <h3>üèÅ ÂÆûÊó∂Ëµõ‰∫ã</h3>
          <button class="btn btn-primary btn-sm" id="btnRefreshEvents">üîÑ Âà∑Êñ∞</button>
        </div>
        <div class="event-region-tabs">
          <button class="event-region-tab active" data-region="local">üìç Êú¨Âú∞Ëµõ‰∫ã</button>
          <button class="event-region-tab" data-region="national">üåê ÂÖ®ÂõΩËµõ‰∫ã</button>
        </div>
        <div class="event-tabs">
          <button class="event-tab-btn active" data-tab="ongoing">‚è± ËøõË°å‰∏≠</button>
          <button class="event-tab-btn" data-tab="upcoming">üìÖ Âç≥Â∞ÜÂºÄÂßã</button>
          <button class="event-tab-btn" data-tab="results">üèÜ ÊúÄÊñ∞ÊàêÁª©</button>
        </div>
        <div class="home-events-list" id="homeEventsList">
          <!-- Ëµõ‰∫ãÂç°ÁâáÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
        </div>
      </div>

      <!-- Âè≥Ê†èÔºöÊô∫ËÉΩÊé®Ëçê & ËÆ¢ÈòÖ -->
      <div class="home-column home-sidebar">
        <!-- Êô∫ËÉΩÊé®Ëçê -->
        <div class="home-widget">
          <div class="home-widget-header">
            <h4>üß† Êô∫ËÉΩÊé®Ëçê</h4>
          </div>
          <div class="home-widget-content" id="homeRecommendations">
            <!-- Êé®ËçêÂÜÖÂÆπÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
          </div>
        </div>

        <!-- ÊàëÁöÑÂÖ≥Ê≥® -->
        <div class="home-widget">
          <div class="home-widget-header">
            <h4>‚≠ê ÊàëÁöÑÂÖ≥Ê≥®</h4>
            <button class="btn btn-ghost btn-sm" id="btnEditSubscription">ÁºñËæë</button>
          </div>
          <div class="home-widget-content" id="homeSubscriptions">
            <div class="subscription-tags">
              <span class="subscription-tag">Ë¥µÂ∑ûËµõÂå∫</span>
              <span class="subscription-tag">ÂÖ¨Ê£öËµõ</span>
              <span class="subscription-tag">Êò•Â≠£Ëµõ</span>
              <span class="subscription-tag add-tag" id="btnAddSubscription">+ Ê∑ªÂä†</span>
            </div>
          </div>
        </div>

        <!-- Âø´Êç∑ÂÖ•Âè£ -->
        <div class="home-widget">
          <div class="home-widget-header">
            <h4>üöÄ Âø´Êç∑ÂÖ•Âè£</h4>
          </div>
          <div class="home-widget-content">
            <div class="quick-links">
              <button class="quick-link-btn" data-action="addPigeon">
                <span>‚ûï</span>
                <span>Êñ∞Â¢ûÈ∏ΩÂ≠ê</span>
              </button>
              <button class="quick-link-btn" data-action="addRace">
                <span>üèÜ</span>
                <span>ÂΩïÂÖ•ÊàêÁª©</span>
              </button>
              <button class="quick-link-btn" data-action="breeding">
                <span>üíï</span>
                <span>ÈÖçÂØπËØÑ‰º∞</span>
              </button>
              <button class="quick-link-btn" data-action="analysis">
                <span>üìä</span>
                <span>Êô∫ËÉΩÂàÜÊûê</span>
              </button>
            </div>
          </div>
        </div>

        <!-- ‰ªäÊó•ÊèêÈÜí -->
        <div class="home-widget">
          <div class="home-widget-header">
            <h4>üîî ‰ªäÊó•ÊèêÈÜí</h4>
          </div>
          <div class="home-widget-content" id="homeTodayAlerts">
            <!-- ÊèêÈÜíÂÜÖÂÆπÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ËµÑËÆØËØ¶ÊÉÖÂºπÁ™ó -->
  <!-- ÁôªÂΩï/Ê≥®ÂÜåÊ®°ÊÄÅÊ°Ü -->
  <div class="announcement-modal" id="loginModal" style="display:none;">
    <div class="announcement-modal-content" style="max-width:450px;">
      <div class="announcement-modal-header">
        <h3 class="announcement-modal-title">
          <span id="loginModalTitle">üîê</span>
          <span id="loginModalTitleText">Áî®Êà∑ÁôªÂΩï</span>
        </h3>
        <button class="announcement-modal-close" onclick="closeLoginModal()">√ó</button>
      </div>
      <div class="announcement-modal-body">
        <!-- ÁôªÂΩïË°®Âçï -->
        <div id="loginForm" style="display:none;">
          <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:8px;color:#6b7280;font-size:14px;font-weight:600;">Áî®Êà∑ÂêçÊàñÈÇÆÁÆ±</label>
            <input type="text" id="loginUsername" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÊàñÈÇÆÁÆ±" style="width:100%;padding:12px;border-radius:8px;border:2px solid #e5e7eb;font-size:14px;outline:none;transition:border-color 0.2s;" />
          </div>
          <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:8px;color:#6b7280;font-size:14px;font-weight:600;">ÂØÜÁ†Å</label>
            <input type="password" id="loginPassword" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" style="width:100%;padding:12px;border-radius:8px;border:2px solid #e5e7eb;font-size:14px;outline:none;transition:border-color 0.2s;" />
          </div>
          <div id="loginError" style="display:none;padding:12px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;color:#dc2626;font-size:13px;margin-bottom:20px;"></div>
          <button class="btn btn-primary" style="width:100%;padding:12px;font-size:16px;font-weight:600;" onclick="handleLogin()">ÁôªÂΩï</button>
          <div style="text-align:center;margin-top:20px;padding-top:20px;border-top:1px solid #e5e7eb;">
            <span style="color:#6b7280;font-size:14px;">ËøòÊ≤°ÊúâË¥¶Êà∑Ôºü</span>
            <a href="#" onclick="switchToRegister(); return false;" style="color:#2563eb;font-size:14px;font-weight:600;text-decoration:none;margin-left:8px;">Á´ãÂç≥Ê≥®ÂÜå</a>
          </div>
        </div>
        
        <!-- Ê≥®ÂÜåË°®Âçï -->
        <div id="registerForm" style="display:none;">
          <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:8px;color:#6b7280;font-size:14px;font-weight:600;">Áî®Êà∑Âêç</label>
            <input type="text" id="registerUsername" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç" style="width:100%;padding:12px;border-radius:8px;border:2px solid #e5e7eb;font-size:14px;outline:none;transition:border-color 0.2s;" />
          </div>
          <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:8px;color:#6b7280;font-size:14px;font-weight:600;">ÈÇÆÁÆ±</label>
            <input type="email" id="registerEmail" placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±Âú∞ÂùÄ" style="width:100%;padding:12px;border-radius:8px;border:2px solid #e5e7eb;font-size:14px;outline:none;transition:border-color 0.2s;" />
          </div>
          <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:8px;color:#6b7280;font-size:14px;font-weight:600;">ÂØÜÁ†Å</label>
            <input type="password" id="registerPassword" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†ÅÔºàËá≥Â∞ë6‰ΩçÔºâ" style="width:100%;padding:12px;border-radius:8px;border:2px solid #e5e7eb;font-size:14px;outline:none;transition:border-color 0.2s;" />
          </div>
          <div id="registerError" style="display:none;padding:12px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;color:#dc2626;font-size:13px;margin-bottom:20px;"></div>
          <button class="btn btn-primary" style="width:100%;padding:12px;font-size:16px;font-weight:600;" onclick="handleRegister()">Ê≥®ÂÜå</button>
          <div style="text-align:center;margin-top:20px;padding-top:20px;border-top:1px solid #e5e7eb;">
            <span style="color:#6b7280;font-size:14px;">Â∑≤ÊúâË¥¶Êà∑Ôºü</span>
            <a href="#" onclick="switchToLogin(); return false;" style="color:#2563eb;font-size:14px;font-weight:600;text-decoration:none;margin-left:8px;">Á´ãÂç≥ÁôªÂΩï</a>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Áî®Êà∑‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü -->
  <div class="announcement-modal" id="userInfoModal" style="display:none;">
    <div class="announcement-modal-content" style="max-width:500px;">
      <div class="announcement-modal-header">
        <h3 class="announcement-modal-title">
          <span>üë®‚Äçüíº</span>
          <span>Ë¥¶Êà∑‰ø°ÊÅØ</span>
        </h3>
        <button class="announcement-modal-close" onclick="closeUserInfoModal()">√ó</button>
      </div>
      <div class="announcement-modal-body">
        <!-- Êü•ÁúãÊ®°Âºè -->
        <div id="userInfoViewMode">
          <div style="text-align:center;padding:20px 0;">
            <div style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);margin:0 auto 20px;display:flex;align-items:center;justify-content:center;font-size:40px;color:#fff;box-shadow:0 4px 12px rgba(102,126,234,0.3);background-size:cover;background-position:center;background-repeat:no-repeat;" id="userAvatarDisplay">üë®‚Äçüíº</div>
            <h4 style="margin:0 0 10px;font-size:18px;color:#1f2937;" id="userNameDisplay">Áî®Êà∑Âêç</h4>
            <p style="margin:0;color:#6b7280;font-size:14px;" id="userEmailDisplay">user@example.com</p>
          </div>
          <div style="border-top:1px solid #e5e7eb;padding:20px 0;">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f3f4f6;">
              <span style="color:#6b7280;font-size:14px;">Ë¥¶Êà∑Á±ªÂûã</span>
              <span style="color:#1f2937;font-weight:600;font-size:14px;" id="userTypeDisplay">ÊôÆÈÄöÁî®Êà∑</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f3f4f6;">
              <span style="color:#6b7280;font-size:14px;">Ê≥®ÂÜåÊó∂Èó¥</span>
              <span style="color:#1f2937;font-weight:600;font-size:14px;" id="userRegisterDate">2024-01-01</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;">
              <span style="color:#6b7280;font-size:14px;">Êï∞ÊçÆÁªüËÆ°</span>
              <span style="color:#1f2937;font-weight:600;font-size:14px;" id="userDataStats">0 Âè™È∏ΩÂ≠ê</span>
            </div>
          </div>
          <div style="padding-top:20px;border-top:1px solid #e5e7eb;display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-primary" style="flex:1;" onclick="enterEditUserInfoMode()">‚úèÔ∏è ÁºñËæëËµÑÊñô</button>
            <button class="btn btn-outline" style="flex:1;" onclick="closeUserInfoModal(); showSettingsModal();">‚öôÔ∏è Á≥ªÁªüËÆæÁΩÆ</button>
            <button class="btn btn-outline" style="flex:1;background:#ef4444;color:#fff;border-color:#ef4444;" onclick="handleLogout(); closeUserInfoModal();">üö™ ÈÄÄÂá∫ÁôªÂΩï</button>
            <button class="btn btn-outline" style="flex:1;" onclick="closeUserInfoModal()">ÂÖ≥Èó≠</button>
          </div>
        </div>
        
        <!-- ÁºñËæëÊ®°Âºè -->
        <div id="userInfoEditMode" style="display:none;">
          <div style="text-align:center;padding:20px 0;">
            <div style="position:relative;display:inline-block;margin-bottom:20px;">
              <div style="width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);margin:0 auto;display:flex;align-items:center;justify-content:center;font-size:50px;color:#fff;box-shadow:0 4px 12px rgba(102,126,234,0.3);background-size:cover;background-position:center;background-repeat:no-repeat;border:3px solid #fff;" id="userAvatarEditDisplay">üë®‚Äçüíº</div>
              <label for="userAvatarInput" style="position:absolute;bottom:0;right:0;width:36px;height:36px;background:#2563eb;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 8px rgba(37,99,235,0.3);border:3px solid #fff;">
                <span style="font-size:18px;">üì∑</span>
              </label>
              <input type="file" id="userAvatarInput" accept="image/*" style="display:none;" />
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;text-align:left;margin-bottom:8px;color:#6b7280;font-size:14px;font-weight:600;">ÊòµÁß∞</label>
              <input type="text" id="userNameInput" placeholder="ËØ∑ËæìÂÖ•ÊòµÁß∞" style="width:100%;padding:10px 12px;border-radius:8px;border:2px solid #e5e7eb;font-size:14px;outline:none;transition:border-color 0.2s;" />
              <p style="margin:8px 0 0 0;color:#9ca3af;font-size:12px;text-align:left;">ÊòµÁß∞Â∞ÜÊòæÁ§∫Âú®Ë¥¶Êà∑ÁïåÈù¢ÂíåÈ°∂ÈÉ®ÂØºËà™Ê†è</p>
            </div>
          </div>
          <div style="padding-top:20px;border-top:1px solid #e5e7eb;display:flex;gap:10px;">
            <button class="btn btn-primary" style="flex:1;" onclick="saveUserInfo()">üíæ ‰øùÂ≠ò</button>
            <button class="btn btn-outline" style="flex:1;" onclick="cancelEditUserInfo()">ÂèñÊ∂à</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü -->
  <div class="announcement-modal" id="settingsModal" style="display:none;">
    <div class="announcement-modal-content" style="max-width:700px;max-height:85vh;overflow-y:auto;">
      <div class="announcement-modal-header">
        <h3 class="announcement-modal-title">
          <span>‚öôÔ∏è</span>
          <span>Á≥ªÁªüËÆæÁΩÆ</span>
        </h3>
        <button class="announcement-modal-close" onclick="closeSettingsModal()">√ó</button>
      </div>
      <div class="announcement-modal-body">
        <div style="padding:24px 0;">
          
          <!-- Â§ñËßÇËÆæÁΩÆ -->
          <div class="settings-section">
            <div class="settings-section-header">
              <span class="settings-section-icon">üé®</span>
              <h4 class="settings-section-title">Â§ñËßÇËÆæÁΩÆ</h4>
            </div>
            <div class="settings-section-content">
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">‰∏ªÈ¢òÊ®°Âºè</div>
                  <div class="settings-item-desc">ÂàáÊç¢ÊµÖËâ≤/Ê∑±Ëâ≤‰∏ªÈ¢ò</div>
                </div>
                <button class="btn btn-sm btn-primary" id="btnToggleThemeInModal" style="min-width:120px;">
                  <span id="themeToggleText">üåô Â§úÈó¥Ê®°Âºè</span>
                </button>
              </div>
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">Â≠ó‰ΩìÂ§ßÂ∞è</div>
                  <div class="settings-item-desc">Ë∞ÉÊï¥ÁïåÈù¢Â≠ó‰ΩìÂ§ßÂ∞è</div>
                </div>
                <select id="fontSizeSelect" class="settings-select" style="min-width:120px;">
                  <option value="small">Â∞è</option>
                  <option value="medium" selected>‰∏≠</option>
                  <option value="large">Â§ß</option>
                </select>
              </div>
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">ÁïåÈù¢ÂØÜÂ∫¶</div>
                  <div class="settings-item-desc">Ë∞ÉÊï¥ÁïåÈù¢ÂÖÉÁ¥†Èó¥Ë∑ù</div>
                </div>
                <select id="densitySelect" class="settings-select" style="min-width:120px;">
                  <option value="compact">Á¥ßÂáë</option>
                  <option value="normal" selected>Ê†áÂáÜ</option>
                  <option value="comfortable">ËàíÈÄÇ</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Êï∞ÊçÆÁÆ°ÁêÜ -->
          <div class="settings-section">
            <div class="settings-section-header">
              <span class="settings-section-icon">üíæ</span>
              <h4 class="settings-section-title">Êï∞ÊçÆÁÆ°ÁêÜ</h4>
            </div>
            <div class="settings-section-content">
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">Êï∞ÊçÆÂ§á‰ªΩ</div>
                  <div class="settings-item-desc">ÂØºÂá∫ÊâÄÊúâÊï∞ÊçÆÂà∞Êú¨Âú∞Êñá‰ª∂</div>
                </div>
                <button class="btn btn-sm btn-primary" id="btnBackupDataInModal" style="min-width:120px;">
                  üíæ Â§á‰ªΩÊï∞ÊçÆ
                </button>
              </div>
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">ÂØºÂá∫Êï∞ÊçÆ</div>
                  <div class="settings-item-desc">ÂØºÂá∫‰∏∫JSONÊ†ºÂºèÊñá‰ª∂</div>
                </div>
                <button class="btn btn-sm btn-outline" id="btnExportDataInModal" style="min-width:120px;">
                  üì• ÂØºÂá∫JSON
                </button>
              </div>
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">ÂØºÂÖ•Êï∞ÊçÆ</div>
                  <div class="settings-item-desc">‰ªéJSONÊñá‰ª∂ÊÅ¢Â§çÊï∞ÊçÆ</div>
                </div>
                <label class="btn btn-sm btn-outline" style="min-width:120px;cursor:pointer;margin:0;">
                  üì§ ÂØºÂÖ•JSON
                  <input type="file" id="importFileInput" accept=".json" style="display:none;" onchange="handleImportFile(event)">
                </label>
              </div>
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">Êï∞ÊçÆÁªüËÆ°</div>
                  <div class="settings-item-desc">Êü•ÁúãÊï∞ÊçÆÂ≠òÂÇ®ÊÉÖÂÜµ</div>
                </div>
                <button class="btn btn-sm btn-outline" id="btnDataStats" style="min-width:120px;">
                  üìä Êü•ÁúãÁªüËÆ°
                </button>
              </div>
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">Ëá™Âä®Â§á‰ªΩ</div>
                  <div class="settings-item-desc">ÊØèÂ§©Ëá™Âä®Â§á‰ªΩÊï∞ÊçÆ</div>
                </div>
                <label class="settings-switch">
                  <input type="checkbox" id="autoBackupToggle">
                  <span class="settings-switch-slider"></span>
                </label>
              </div>
            </div>
          </div>

          <!-- APIÈÖçÁΩÆ -->
          <div class="settings-section">
            <div class="settings-section-header">
              <span class="settings-section-icon">üîó</span>
              <h4 class="settings-section-title">APIÈÖçÁΩÆ</h4>
            </div>
            <div class="settings-section-content">
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">ËµÑËÆØAPI</div>
                  <div class="settings-item-desc">ÈÖçÁΩÆËµÑËÆØÊï∞ÊçÆÊé•Âè£Âú∞ÂùÄ</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="showApiConfigModal('ËµÑËÆØ')" style="min-width:120px;">
                  üîó ÈÖçÁΩÆËµÑËÆØAPI
                </button>
              </div>
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">Ëµõ‰∫ãAPI</div>
                  <div class="settings-item-desc">ÈÖçÁΩÆËµõ‰∫ãÊï∞ÊçÆÊé•Âè£Âú∞ÂùÄ</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="showApiConfigModal('Ëµõ‰∫ã')" style="min-width:120px;">
                  üîó ÈÖçÁΩÆËµõ‰∫ãAPI
                </button>
              </div>
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">APIÁä∂ÊÄÅ</div>
                  <div class="settings-item-desc" id="apiStatusDesc">Ê£ÄÊü•APIËøûÊé•Áä∂ÊÄÅ</div>
                </div>
                <button class="btn btn-sm btn-outline" id="btnTestApi" style="min-width:120px;">
                  üîç ÊµãËØïËøûÊé•
                </button>
              </div>
            </div>
          </div>

          <!-- ÈÄöÁü•ËÆæÁΩÆ -->
          <div class="settings-section">
            <div class="settings-section-header">
              <span class="settings-section-icon">üîî</span>
              <h4 class="settings-section-title">ÈÄöÁü•ËÆæÁΩÆ</h4>
            </div>
            <div class="settings-section-content">
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">Á≥ªÁªüÈÄöÁü•</div>
                  <div class="settings-item-desc">Êé•Êî∂Á≥ªÁªüÈáçË¶ÅÈÄöÁü•</div>
                </div>
                <label class="settings-switch">
                  <input type="checkbox" id="systemNotificationToggle" checked>
                  <span class="settings-switch-slider"></span>
                </label>
              </div>
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">Êï∞ÊçÆÊõ¥Êñ∞ÊèêÈÜí</div>
                  <div class="settings-item-desc">Êï∞ÊçÆÊõ¥Êñ∞Êó∂ÊòæÁ§∫ÊèêÈÜí</div>
                </div>
                <label class="settings-switch">
                  <input type="checkbox" id="dataUpdateNotificationToggle" checked>
                  <span class="settings-switch-slider"></span>
                </label>
              </div>
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">Ëµõ‰∫ãÊèêÈÜí</div>
                  <div class="settings-item-desc">ÈáçË¶ÅËµõ‰∫ãÂºÄÂßãÂâçÊèêÈÜí</div>
                </div>
                <label class="settings-switch">
                  <input type="checkbox" id="eventNotificationToggle" checked>
                  <span class="settings-switch-slider"></span>
                </label>
              </div>
            </div>
          </div>

          <!-- Á≥ªÁªüËÆæÁΩÆ -->
          <div class="settings-section">
            <div class="settings-section-header">
              <span class="settings-section-icon">‚öôÔ∏è</span>
              <h4 class="settings-section-title">Á≥ªÁªüËÆæÁΩÆ</h4>
            </div>
            <div class="settings-section-content">
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">ËØ≠Ë®ÄËÆæÁΩÆ</div>
                  <div class="settings-item-desc">ÈÄâÊã©ÁïåÈù¢ËØ≠Ë®Ä</div>
                </div>
                <select id="languageSelect" class="settings-select" style="min-width:120px;">
                  <option value="zh-CN" selected>ÁÆÄ‰Ωì‰∏≠Êñá</option>
                  <option value="zh-TW">ÁπÅ‰Ωì‰∏≠Êñá</option>
                  <option value="en-US">English</option>
                </select>
              </div>
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">Êó∂Âå∫ËÆæÁΩÆ</div>
                  <div class="settings-item-desc">ËÆæÁΩÆÊó∂Âå∫ÊòæÁ§∫</div>
                </div>
                <select id="timezoneSelect" class="settings-select" style="min-width:120px;">
                  <option value="local" selected>Êú¨Âú∞Êó∂Âå∫</option>
                  <option value="UTC">UTC</option>
                </select>
              </div>
              <div class="settings-item">
                <div class="settings-item-info">
                  <div class="settings-item-label">Êó•ÊúüÊ†ºÂºè</div>
                  <div class="settings-item-desc">ÈÄâÊã©Êó•ÊúüÊòæÁ§∫Ê†ºÂºè</div>
                </div>
                <select id="dateFormatSelect" class="settings-select" style="min-width:120px;">
                  <option value="YYYY-MM-DD" selected>YYYY-MM-DD</option>
                  <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                  <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                </select>
              </div>
            </div>
          </div>

          <!-- ÂÖ≥‰∫é -->
          <div class="settings-section">
            <div class="settings-section-header">
              <span class="settings-section-icon">‚ÑπÔ∏è</span>
              <h4 class="settings-section-title">ÂÖ≥‰∫é</h4>
            </div>
            <div class="settings-section-content">
              <div style="padding:20px;background:linear-gradient(135deg, #667eea15 0%, #764ba215 100%);border-radius:12px;text-align:center;">
                <div style="font-size:32px;margin-bottom:12px;">üïäÔ∏è</div>
                <h4 style="margin:0 0 8px;font-size:18px;color:#1f2937;font-weight:600;">Êô∫È∏ΩÔΩúPigeonAI</h4>
                <p style="margin:0 0 12px;font-size:14px;color:#6b7280;line-height:1.6;">
                  ÁâàÊú¨: 2.0.0<br>
                  ÊØèÂè™È∏ΩÂ≠êÔºåÁöÜÊòØËµõÁ∫ß<br>
                  <span style="font-size:12px;">Every Pigeon, Race-Grade</span>
                </p>
                <div style="display:flex;gap:8px;justify-content:center;margin-top:16px;">
                  <button class="btn btn-sm btn-outline" onclick="window.open('https://github.com', '_blank')" style="font-size:12px;">
                    üìñ ‰ΩøÁî®ÊñáÊ°£
                  </button>
                  <button class="btn btn-sm btn-outline" id="btnOpenFeedback" data-open-feedback="true" style="font-size:12px;">
                    üêõ ÊÑèËßÅ‰∏éÂèçÈ¶à
                  </button>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div class="news-modal" id="newsModal">
    <div class="news-modal-content">
      <div class="news-modal-header">
        <h3 class="news-modal-title" id="newsModalTitle">ËµÑËÆØÊ†áÈ¢ò</h3>
        <button class="news-modal-close" id="newsModalClose">‚úï</button>
      </div>
      <div class="news-modal-body">
        <div class="news-modal-meta">
          <div class="news-modal-meta-item">
            <span>üì∞</span>
            <span id="newsModalSource">Êù•Ê∫êÔºöÊú™Áü•</span>
          </div>
          <div class="news-modal-meta-item">
            <span>üìç</span>
            <span id="newsModalRegion">ÂÖ®ÂõΩËµÑËÆØ</span>
          </div>
          <div class="news-modal-meta-item">
            <span>üïê</span>
            <span id="newsModalUpdateTime">Êõ¥Êñ∞Êó∂Èó¥ÔºöÊú™Áü•</span>
          </div>
        </div>
        <div class="news-modal-content-text" id="newsModalContent">
          ËµÑËÆØÂÜÖÂÆπÂä†ËΩΩ‰∏≠...
        </div>
      </div>
      <div class="news-modal-footer">
        <button class="btn btn-outline" id="newsModalViewOriginal">üîó Êü•ÁúãÂéüÊñá</button>
        <button class="btn btn-primary" id="newsModalCloseBtn">ÂÖ≥Èó≠</button>
      </div>
    </div>
  </div>

  <!-- ÊÑèËßÅ‰∏éÂèçÈ¶àÂºπÁ™ó -->
  <div class="news-modal" id="feedbackModal" style="display:none;">
    <div class="news-modal-content">
      <div class="news-modal-header">
        <h3 class="news-modal-title">ÊÑèËßÅ‰∏éÂèçÈ¶à</h3>
        <button class="news-modal-close" id="feedbackModalClose">‚úï</button>
      </div>
      <div class="news-modal-body">
        <div class="news-modal-content-text">
          <p style="margin-bottom:8px;font-size:13px;color:#4b5563;">ËØ∑ÂëäËØâÊàë‰ª¨ÊÇ®ÁöÑ‰ΩøÁî®‰ΩìÈ™å„ÄÅÈóÆÈ¢òÊàñÊîπËøõÂª∫ËÆÆÔºö</p>
          <textarea id="feedbackContent" rows="4" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #E5E7EB;font-size:13px;resize:vertical;outline:none;"></textarea>
          <div style="margin-top:10px;">
            <label style="font-size:12px;color:#6b7280;display:block;margin-bottom:4px;">ËÅîÁ≥ªÊñπÂºèÔºàÈÄâÂ°´Ôºå‰æãÂ¶ÇÊâãÊú∫Âè∑ / ÂæÆ‰ø° / ÈÇÆÁÆ±Ôºâ</label>
            <input id="feedbackContact" type="text" style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid #E5E7EB;font-size:13px;outline:none;" />
          </div>
        </div>
      </div>
      <div class="news-modal-footer">
        <button class="btn btn-outline" id="feedbackModalCancel">ÂèñÊ∂à</button>
        <button class="btn btn-primary" id="feedbackModalSubmit">Êèê‰∫§ÂèçÈ¶à</button>
      </div>
    </div>
  </div>

  <!-- ÂàóË°®ËßÜÂõæ -->
  <section id="listView" class="card" style="display:none;">
    <div class="card-header">
      <h2>È∏ΩÂ≠êÁÆ°ÁêÜ</h2>
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="view-switcher">
          <button class="view-switch-btn active" id="btnTableView" data-view-type="table">üìã Ë°®Ê†º</button>
          <button class="view-switch-btn" id="btnCardView" data-view-type="card">üÉè Âç°Áâá</button>
        </div>
      </div>
    </div>
    
    <!-- Ë°®Ê†ºËßÜÂõæ -->
    <div id="tableView">
      <table>
        <thead>
        <tr>
          <th>Ë∂≥ÁéØÂè∑</th>
          <th>ÂêçÁß∞</th>
          <th>Á±ªÂûã</th>
          <th>Áä∂ÊÄÅ</th>
          <th>Áà∂È∏Ω / ÊØçÈ∏Ω</th>
          <th>Áé∞È∏Ω‰∏ª</th>
          <th>ÂèÇËµõËÆ∞ÂΩïÊï∞</th>
          <th>Êìç‰Ωú</th>
        </tr>
        </thead>
        <tbody id="pigeonTableBody">
        <!-- Ë°åÁî± JS Â°´ÂÖÖ -->
        </tbody>
      </table>
    </div>
    
    <!-- Âç°ÁâáËßÜÂõæ -->
    <div id="cardView" style="display:none;">
      <div class="pigeon-cards" id="pigeonCardsBody">
        <!-- Âç°ÁâáÁî± JS Â°´ÂÖÖ -->
      </div>
    </div>
  </section>
  
  <!-- Ë°ÄÁªüÂÖ≥Á≥ªËßÜÂõæ -->
  <section id="pedigreeView" class="card" style="display:none;">
    <div class="card-header">
      <h2>üå≥ Ë°ÄÁªüÂÖ≥Á≥ªÊ†ë</h2>
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <select id="pedigreeSelectPigeon" style="padding:8px 12px;border-radius:6px;border:1px solid #E5E7EB;background:#fff;min-width:250px;">
          <option value="">ÈÄâÊã©È∏ΩÂ≠êÊü•ÁúãË°ÄÁªüÊ†ë</option>
        </select>
        <div style="display:flex;align-items:center;gap:8px;">
          <input type="text" id="pedigreeSearchInput" placeholder="ÊêúÁ¥¢Ë∂≥ÁéØÂè∑ÊàñÂêçÂ≠ó..." style="padding:8px 12px;border-radius:6px;border:1px solid #E5E7EB;background:#fff;min-width:200px;font-size:14px;outline:none;" />
          <button class="btn btn-primary btn-sm" id="btnPedigreeSearch">üîç ÊêúÁ¥¢</button>
      </div>
        <button class="btn btn-outline btn-sm" id="btnShowAllBreeders">üìä ÊòæÁ§∫ÊâÄÊúâÁßçÈ∏ΩÊ†ë</button>
        <button class="btn btn-outline btn-sm" id="btnRefreshPedigree">üîÑ Âà∑Êñ∞</button>
    </div>
    </div>
    <div id="pedigreeTreeContainer" class="pedigree-tree-container" style="min-height:500px;padding:20px;background:#fafbfc;border-radius:8px;">
      <p class="muted" style="text-align:center;padding:40px;">ËØ∑‰ªé‰∏äÊñπ‰∏ãÊãâËèúÂçï‰∏≠ÈÄâÊã©‰∏ÄÂè™È∏ΩÂ≠êÔºåÊàñ‰ΩøÁî®ÊêúÁ¥¢ÂäüËÉΩÊü•ÊâæÔºåÊü•ÁúãÂÖ∂ÂÆåÊï¥Ë°ÄÁªüÂÖ≥Á≥ªÊ†ëÔºàÂåÖÊã¨‰∫≤‰ª£ÂíåÂ≠ê‰ª£Ôºâ</p>
    </div>
  </section>

  <!-- Dashboard Êï∞ÊçÆÊ¶ÇËßà -->
  <section id="dashboardView" class="card" style="display:none;">
    <div class="card-header">
      <h2>üìä Êï∞ÊçÆÊ¶ÇËßà</h2>
      <span class="muted" style="font-size: 13px;">ÂÆûÊó∂ÁªüËÆ°ÊÇ®ÁöÑ‰ø°È∏ΩÊ°£Ê°àÊï∞ÊçÆ</span>
    </div>
    
    <!-- Ê†∏ÂøÉÊï∞ÊçÆÂç°Áâá -->
    <div class="stats-cards">
      <div class="stat-card">
        <div class="stat-card-label">
          <span style="font-size: 18px;">üìä</span>
          <span>ÊÄªÈ∏ΩÂ≠êÊï∞</span>
        </div>
        <div class="stat-card-number" id="statTotal" style="color:#2563eb;">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-label">
          <span style="font-size: 18px;">üïäÔ∏è</span>
          <span>Âú®‰∏ñ</span>
        </div>
        <div class="stat-card-number" id="statAlive" style="color:#059669;">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-label">
          <span style="font-size: 18px;">üíî</span>
          <span>Â∑≤Ê≠ª‰∫°</span>
        </div>
        <div class="stat-card-number" id="statDead" style="color:#4b5563;">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-label">
          <span style="font-size: 18px;">üèÜ</span>
          <span>ÊúâÊàêÁª©</span>
        </div>
        <div class="stat-card-number" id="statRaced" style="color:#d97706;">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-label">
          <span style="font-size: 18px;">‚≠ê</span>
          <span>Ê†∏ÂøÉÁßçÈ∏Ω</span>
        </div>
        <div class="stat-card-number" id="statCore" style="color:#7c3aed;">0</div>
      </div>
    </div>
    
    <!-- ÂõæË°®Âå∫Âüü -->
    <div class="card" style="margin-top:24px;">
      <div class="card-header">
        <h2>üìà Âπ¥Â∫¶ÁªüËÆ°</h2>
        <span class="muted" style="font-size: 13px;">ÊåâÂπ¥‰ªΩÊ±áÊÄªÂá∫Áîü„ÄÅÊ≠ª‰∫°ÂèäÂèÇËµõËÆ∞ÂΩï</span>
      </div>
      <div id="chartContainer" style="min-height:300px; padding:24px;">
        <div id="dashboardStatsTableBody">
          <!-- Âπ¥Â∫¶ÁªüËÆ°Êï∞ÊçÆ -->
        </div>
      </div>
    </div>
  </section>

  <!-- ÁªüËÆ°ËßÜÂõæ -->
  <section id="statsView" class="card" style="display:none;">
    <div class="card-header">
      <h2>Âπ¥Â∫¶ÁªüËÆ°Ê¶ÇËßà</h2>
    </div>
    <p class="muted">ÊåâÂπ¥‰ªΩÊ±áÊÄªÔºöÂá∫ÁîüÊï∞Èáè„ÄÅÊ≠ª‰∫°Êï∞Èáè‰ª•ÂèäÊúâÂèÇËµõËÆ∞ÂΩïÁöÑÈ∏ΩÂ≠êÊï∞Èáè„ÄÇ</p>
    <table>
      <thead>
      <tr>
        <th>Âπ¥‰ªΩ</th>
        <th>Âá∫ÁîüÊï∞Èáè</th>
        <th>Ê≠ª‰∫°Êï∞Èáè</th>
        <th>ÊúâÂèÇËµõËÆ∞ÂΩïÁöÑÈ∏ΩÂ≠êÊï∞</th>
      </tr>
      </thead>
      <tbody id="statsViewTableBody">
      </tbody>
    </table>
  </section>

  <!-- ÊØîËµõ‰∏éÊàêÁª©ÁÆ°ÁêÜËßÜÂõæ -->
  <section id="raceView" class="card" style="display:none;">
    <div class="card-header">
      <h2>üèÜ ÊØîËµõ‰∏éÊàêÁª©ÁÆ°ÁêÜ</h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <button class="btn btn-primary btn-sm" id="btnAddRace">‚ûï Êñ∞Â¢ûÊØîËµõ</button>
        <button class="btn btn-outline btn-sm" id="btnImportExcel">üì• ÂØºÂÖ•Excel</button>
        <button class="btn btn-outline btn-sm" id="btnExportData">üì§ ÂØºÂá∫Êï∞ÊçÆ</button>
        <button class="btn btn-outline btn-sm" id="btnRefreshRaces">üîÑ Âà∑Êñ∞</button>
      </div>
    </div>

    <!-- Ê†áÁ≠æÈ°µÂØºËà™ -->
    <div style="border-bottom:2px solid #e5e7eb;margin-bottom:20px;">
      <div style="display:flex;gap:8px;">
        <button class="race-tab-btn active" data-tab="raceList">üìã ÊØîËµõÂàóË°®</button>
        <button class="race-tab-btn" data-tab="raceImport">üì• ÂØºÂÖ•ÊàêÁª©</button>
        <button class="race-tab-btn" data-tab="raceStats">üìä ÊàêÁª©ÁªüËÆ°</button>
        <button class="race-tab-btn" data-tab="raceAnalysis">üìà ÊàêÁª©ÂàÜÊûê</button>
        <button class="race-tab-btn" data-tab="pedigreeComparison">üß¨ Ë°ÄÁªüÂØπÊØî</button>
      </div>
    </div>

    <!-- ÊØîËµõÂàóË°®Ê†áÁ≠æÈ°µ -->
    <div id="raceListTab" class="race-tab-content active">
      <div id="raceListContainer">
        <p class="muted" style="text-align:center;padding:40px;">ÊöÇÊó†ÊØîËµõËÆ∞ÂΩïÔºåÁÇπÂáª"Êñ∞Â¢ûÊØîËµõ"ÂºÄÂßãËÆ∞ÂΩï</p>
      </div>
    </div>

    <!-- ÂØºÂÖ•ÊàêÁª©Ê†áÁ≠æÈ°µ -->
    <div id="raceImportTab" class="race-tab-content">
      <div style="max-width:800px;margin:0 auto;">
        <div class="excel-import-zone" id="excelDropZone">
          <div style="font-size:48px;margin-bottom:16px;">üìä</div>
          <div style="font-size:16px;font-weight:600;color:#1f2937;margin-bottom:8px;">ÊãñÊîæ Excel/CSV Êñá‰ª∂Âà∞Ê≠§Â§Ñ</div>
          <div style="font-size:13px;color:#6b7280;margin-bottom:16px;">ÊàñÁÇπÂáªÈÄâÊã©Êñá‰ª∂</div>
          <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" style="display:none;" />
          <button class="btn btn-primary" id="btnSelectExcel">ÈÄâÊã©Êñá‰ª∂</button>
        </div>

        <div style="margin-top:24px;padding:20px;background:#f9fafb;border-radius:12px;">
          <h4 style="margin:0 0 12px;color:#1f2937;">üìã Êñá‰ª∂Ê†ºÂºèË¶ÅÊ±Ç</h4>
          <div style="font-size:13px;color:#4b5563;line-height:1.8;">
            <p>Excel Êñá‰ª∂Â∫îÂåÖÂê´‰ª•‰∏ãÂàóÔºàË°®Â§¥ÂêçÁß∞ÔºâÔºö</p>
            <ul style="margin:8px 0;padding-left:20px;">
              <li><strong>Ë∂≥ÁéØÂè∑ / ÁéØÂè∑</strong> - È∏ΩÂ≠êÁöÑË∂≥ÁéØÂè∑Á†ÅÔºàÂøÖÈúÄÔºâ</li>
              <li><strong>ÂêçÊ¨° / ÊéíÂêç</strong> - ÊØîËµõÂêçÊ¨°ÔºàÂøÖÈúÄÔºâ</li>
              <li><strong>ÂàÜÈÄü</strong> - ÊØîËµõÂàÜÈÄüÔºàÂèØÈÄâÔºâ</li>
              <li><strong>ÂΩíÂ∑¢Êó∂Èó¥</strong> - ÂΩíÂ∑¢Êó∂Èó¥ÔºàÂèØÈÄâÔºâ</li>
            </ul>
            <p style="color:#6b7280;font-size:12px;">Á≥ªÁªü‰ºöËá™Âä®ËØÜÂà´Ë°®Â§¥Âπ∂ÂåπÈÖçÊï∞ÊçÆ</p>
          </div>
        </div>

        <div id="importPreviewContainer" style="display:none;margin-top:24px;">
          <div class="card-header">
            <h4 style="margin:0;">üìã Êï∞ÊçÆÈ¢ÑËßà</h4>
            <div style="display:flex;gap:8px;">
              <span id="importMatchedCount" style="padding:4px 12px;background:#d1fae5;color:#047857;border-radius:999px;font-size:12px;">Â∑≤ÂåπÈÖç: 0</span>
              <span id="importUnmatchedCount" style="padding:4px 12px;background:#fee2e2;color:#dc2626;border-radius:999px;font-size:12px;">Êú™ÂåπÈÖç: 0</span>
            </div>
          </div>
          <div id="importPreviewTable" style="max-height:400px;overflow-y:auto;margin-top:16px;"></div>
          <div style="margin-top:16px;display:flex;gap:12px;justify-content:flex-end;">
            <button class="btn btn-outline" id="btnCancelImport">ÂèñÊ∂à</button>
            <button class="btn btn-primary" id="btnConfirmImport">Á°ÆËÆ§ÂØºÂÖ•</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ÊàêÁª©ÁªüËÆ°Ê†áÁ≠æÈ°µ -->
    <div id="raceStatsTab" class="race-tab-content">
      <div style="margin-bottom:20px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;">ÈÄâÊã©ÁªüËÆ°Á±ªÂûãÔºö</label>
        <select id="statsTypeSelect" style="padding:8px 12px;border-radius:6px;border:1px solid #E5E7EB;background:#fff;min-width:200px;">
          <option value="single">ÂçïÈ∏ΩÊàêÁª©ÁªüËÆ°</option>
          <option value="bloodline">Ë°ÄÁ≥ªÊàêÁª©ÁªüËÆ°</option>
          <option value="parents">Áà∂ÊØçÂêé‰ª£ÊàêÁª©ÁªüËÆ°</option>
        </select>
        <select id="statsPigeonSelect" style="padding:8px 12px;border-radius:6px;border:1px solid #E5E7EB;background:#fff;min-width:250px;margin-left:12px;">
          <option value="">ÈÄâÊã©È∏ΩÂ≠ê...</option>
        </select>
        <button class="btn btn-primary btn-sm" id="btnGenerateStats" style="margin-left:12px;">ÁîüÊàêÁªüËÆ°</button>
      </div>
      <div id="raceStatsContainer">
        <p class="muted" style="text-align:center;padding:40px;">ËØ∑ÈÄâÊã©ÁªüËÆ°Á±ªÂûãÂíåÈ∏ΩÂ≠êÔºåÁÑ∂ÂêéÁÇπÂáª"ÁîüÊàêÁªüËÆ°"</p>
      </div>
    </div>

    <!-- ÊàêÁª©ÂàÜÊûêÊ†áÁ≠æÈ°µ -->
    <div id="raceAnalysisTab" class="race-tab-content">
      <div id="raceAnalysisContainer">
        <p class="muted" style="text-align:center;padding:40px;">Ê≠£Âú®Âä†ËΩΩÁªºÂêàÂàÜÊûêÊï∞ÊçÆ...</p>
      </div>
    </div>

    <!-- Ë°ÄÁªüÂØπÊØîÊ†áÁ≠æÈ°µ -->
    <div id="pedigreeComparisonTab" class="race-tab-content">
      <div id="pedigreeComparisonContainer">
        <div style="max-width:1200px;margin:0 auto;">
          <!-- ÈÄâÊã©ÂØπÊØîÈ∏ΩÂ≠ê -->
          <div class="card" style="margin-bottom:24px;">
            <h4 style="margin:0 0 20px;color:#1f2937;">üîç ÈÄâÊã©ÂØπÊØîÈ∏ΩÂ≠ê</h4>
            <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:20px;align-items:end;">
              <div class="form-group">
                <label style="display:block;margin-bottom:8px;font-weight:600;">È∏ΩÂ≠ê A</label>
                <select id="comparisonPigeonA" style="padding:10px 12px;border-radius:8px;border:2px solid #e5e7eb;background:#fff;width:100%;font-size:14px;">
                  <option value="">ÈÄâÊã©Á¨¨‰∏ÄÂè™È∏ΩÂ≠ê...</option>
                </select>
              </div>
              <div style="text-align:center;padding-bottom:8px;">
                <span style="font-size:24px;color:#6b7280;">VS</span>
              </div>
              <div class="form-group">
                <label style="display:block;margin-bottom:8px;font-weight:600;">È∏ΩÂ≠ê B</label>
                <select id="comparisonPigeonB" style="padding:10px 12px;border-radius:8px;border:2px solid #e5e7eb;background:#fff;width:100%;font-size:14px;">
                  <option value="">ÈÄâÊã©Á¨¨‰∫åÂè™È∏ΩÂ≠ê...</option>
                </select>
              </div>
            </div>
            <div style="margin-top:20px;text-align:center;">
              <button class="btn btn-primary" id="btnComparePedigree" style="padding:12px 32px;font-size:16px;">
                üß¨ ÂºÄÂßãÂØπÊØîÂàÜÊûê
              </button>
            </div>
          </div>

          <!-- ÂØπÊØîÁªìÊûúÂå∫Âüü -->
          <div id="pedigreeComparisonResults" style="display:none;">
            <!-- Âü∫Êú¨‰ø°ÊÅØÂØπÊØî -->
            <div class="card" style="margin-bottom:24px;">
              <h4 style="margin:0 0 20px;color:#1f2937;">üìä Âü∫Êú¨‰ø°ÊÅØÂØπÊØî</h4>
              <div id="comparisonBasicInfo" style="display:grid;grid-template-columns:1fr 1fr;gap:24px;">
                <!-- Âä®ÊÄÅÁîüÊàê -->
              </div>
            </div>

            <!-- Ë°ÄÁªüÁõ∏‰ººÂ∫¶ÂàÜÊûê -->
            <div class="card" style="margin-bottom:24px;">
              <h4 style="margin:0 0 20px;color:#1f2937;">üß¨ Ë°ÄÁªüÁõ∏‰ººÂ∫¶ÂàÜÊûê</h4>
              <div id="comparisonSimilarity" style="padding:20px;background:#f9fafb;border-radius:12px;">
                <!-- Âä®ÊÄÅÁîüÊàê -->
              </div>
            </div>

            <!-- ÂÖ±ÂêåÁ•ñÂÖà -->
            <div class="card" style="margin-bottom:24px;">
              <h4 style="margin:0 0 20px;color:#1f2937;">üë• ÂÖ±ÂêåÁ•ñÂÖà</h4>
              <div id="comparisonCommonAncestors">
                <!-- Âä®ÊÄÅÁîüÊàê -->
              </div>
            </div>

            <!-- Ëøë‰∫≤Á≥ªÊï∞ -->
            <div class="card" style="margin-bottom:24px;">
              <h4 style="margin:0 0 20px;color:#1f2937;">üîó Ëøë‰∫≤Á≥ªÊï∞ÂàÜÊûê</h4>
              <div id="comparisonInbreeding">
                <!-- Âä®ÊÄÅÁîüÊàê -->
              </div>
            </div>

            <!-- Ë°ÄÁªüÊ†ëÂØπÊØî -->
            <div class="card">
              <h4 style="margin:0 0 20px;color:#1f2937;">üå≥ Ë°ÄÁªüÊ†ëÂØπÊØî</h4>
              <div id="comparisonPedigreeTrees" style="display:grid;grid-template-columns:1fr 1fr;gap:24px;">
                <!-- Âä®ÊÄÅÁîüÊàê -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Êñ∞Â¢û/ÁºñËæëÊØîËµõÊ®°ÊÄÅÊ°Ü -->
  <div id="raceModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:800px;">
      <div class="modal-header">
        <h3 id="raceModalTitle">Êñ∞Â¢ûÊØîËµõ</h3>
        <button class="modal-close" id="btnCloseRaceModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group">
            <label>Ëµõ‰∫ãÂêçÁß∞<span class="required">*</span></label>
            <input type="text" id="race_name" placeholder="‰æãÂ¶ÇÔºö2024Êò•Â≠£‰ø°È∏ΩÂ§ßËµõ" required />
          </div>
          <div class="form-group">
            <label>ÊØîËµõÊó∂Èó¥<span class="required">*</span></label>
            <input type="date" id="race_date" required />
          </div>
          <div class="form-group">
            <label>ÊØîËµõÂú∞ÁÇπ<span class="required">*</span></label>
            <input type="text" id="race_location" placeholder="‰æãÂ¶ÇÔºöÂåó‰∫¨" required />
          </div>
          <div class="form-group">
            <label>Â§©Ê∞îÊÉÖÂÜµ</label>
            <select id="race_weather">
              <option value="">ËØ∑ÈÄâÊã©</option>
              <option value="Êô¥Â§©">Êô¥Â§©</option>
              <option value="Â§ö‰∫ë">Â§ö‰∫ë</option>
              <option value="Èò¥Â§©">Èò¥Â§©</option>
              <option value="Â∞èÈõ®">Â∞èÈõ®</option>
              <option value="‰∏≠Èõ®">‰∏≠Èõ®</option>
              <option value="Â§ßÈõ®">Â§ßÈõ®</option>
              <option value="Èõæ">Èõæ</option>
              <option value="Â§ßÈ£é">Â§ßÈ£é</option>
            </select>
          </div>
        </div>
        
        <div class="section-title" style="margin-top:24px;">ÂèÇËµõÈ∏ΩÂèäÊàêÁª©</div>
        <div id="raceParticipantsContainer">
          <div class="participant-item" style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:12px;align-items:center;padding:12px;background:#f9fafb;border-radius:8px;margin-bottom:12px;">
            <select class="participant-pigeon" style="padding:8px;border-radius:6px;border:1px solid #E5E7EB;">
              <option value="">ÈÄâÊã©È∏ΩÂ≠ê...</option>
            </select>
            <input type="number" class="participant-rank" placeholder="ÂêçÊ¨°" min="1" style="padding:8px;border-radius:6px;border:1px solid #E5E7EB;" />
            <input type="number" class="participant-score" placeholder="ÂàÜÊï∞" step="0.01" style="padding:8px;border-radius:6px;border:1px solid #E5E7EB;" />
            <input type="time" class="participant-time" placeholder="ÂΩíÂ∑¢Êó∂Èó¥" style="padding:8px;border-radius:6px;border:1px solid #E5E7EB;" />
            <button class="btn btn-outline btn-sm remove-participant" style="padding:6px 12px;">Âà†Èô§</button>
          </div>
        </div>
        <button class="btn btn-outline btn-sm" id="btnAddParticipant" style="margin-top:12px;">‚ûï Ê∑ªÂä†ÂèÇËµõÈ∏Ω</button>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="btnCancelRace">ÂèñÊ∂à</button>
        <button class="btn btn-primary" id="btnSaveRace">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- üß¨ ÁπÅËÇ≤‰∏éÈÖçÂØπÁÆ°ÁêÜÊ®°Âùó -->
  <section id="breedingView" class="card" style="display:none;">
    <div class="card-header">
      <h2>üß¨ ÁπÅËÇ≤‰∏éÈÖçÂØπÁÆ°ÁêÜ</h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <button class="btn btn-primary btn-sm" id="btnNewPairing">üíï Êñ∞Âª∫ÈÖçÂØπ</button>
        <button class="btn btn-outline btn-sm" id="btnViewPairingHistory">üìã ÈÖçÂØπÂéÜÂè≤</button>
        <button class="btn btn-outline btn-sm" id="btnRefreshBreeding">üîÑ Âà∑Êñ∞</button>
      </div>
    </div>

    <!-- ÈÖçÂØπÈù¢Êùø -->
    <div class="breeding-panel">
      <div class="breeding-selector-row" style="display:grid;grid-template-columns:1fr auto 1fr;gap:24px;align-items:start;margin-bottom:24px;">
        <!-- ÂÖ¨È∏ΩÈÄâÊã© -->
        <div class="breeding-pigeon-card male-card" style="background:linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);border:2px solid #3b82f6;border-radius:16px;padding:24px;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
            <span style="font-size:32px;">‚ôÇ</span>
            <div>
              <h3 style="margin:0;color:#1e40af;font-size:18px;">ÈÄâÊã©ÂÖ¨È∏Ω</h3>
              <span style="color:#6b7280;font-size:13px;">Father</span>
            </div>
          </div>
          <select id="breedingMaleSelect" style="width:100%;padding:12px;border-radius:8px;border:2px solid #93c5fd;font-size:14px;background:#fff;">
            <option value="">ËØ∑ÈÄâÊã©ÂÖ¨È∏Ω...</option>
          </select>
          <div id="breedingMaleInfo" style="margin-top:16px;min-height:150px;">
            <p class="muted" style="text-align:center;padding:20px;">ÈÄâÊã©ÂÖ¨È∏ΩÂêéÊòæÁ§∫ËØ¶ÊÉÖ</p>
          </div>
        </div>

        <!-- ÈÖçÂØπËØÑ‰º∞‰∏≠ÂøÉ -->
        <div class="breeding-assessment" style="background:linear-gradient(135deg, #fdf4ff 0%, #faf5ff 100%);border:2px solid #a855f7;border-radius:16px;padding:24px;min-width:300px;">
          <div style="text-align:center;margin-bottom:20px;">
            <span style="font-size:48px;">üíë</span>
            <h3 style="margin:8px 0 0;color:#7e22ce;font-size:18px;">ÈÖçÂØπËØÑ‰º∞</h3>
          </div>
          <div id="breedingAssessment" style="min-height:200px;">
            <div style="text-align:center;padding:40px 20px;color:#9ca3af;">
              <div style="font-size:32px;margin-bottom:12px;">üîÆ</div>
              <p>ËØ∑ÂÖàÈÄâÊã©ÂÖ¨È∏ΩÂíåÊØçÈ∏Ω</p>
              <p style="font-size:12px;">Á≥ªÁªüÂ∞ÜËá™Âä®ÂàÜÊûêËøë‰∫≤È£éÈô©‰∏éÈÖçÂØπÂª∫ËÆÆ</p>
            </div>
          </div>
          <button class="btn btn-primary" id="btnConfirmPairing" style="width:100%;margin-top:16px;padding:14px;font-size:15px;" disabled>‚úÖ Á°ÆËÆ§ÈÖçÂØπ</button>
        </div>

        <!-- ÊØçÈ∏ΩÈÄâÊã© -->
        <div class="breeding-pigeon-card female-card" style="background:linear-gradient(135deg, #fce7f3 0%, #fdf2f8 100%);border:2px solid #ec4899;border-radius:16px;padding:24px;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
            <span style="font-size:32px;">‚ôÄ</span>
            <div>
              <h3 style="margin:0;color:#be185d;font-size:18px;">ÈÄâÊã©ÊØçÈ∏Ω</h3>
              <span style="color:#6b7280;font-size:13px;">Mother</span>
            </div>
          </div>
          <select id="breedingFemaleSelect" style="width:100%;padding:12px;border-radius:8px;border:2px solid #f9a8d4;font-size:14px;background:#fff;">
            <option value="">ËØ∑ÈÄâÊã©ÊØçÈ∏Ω...</option>
          </select>
          <div id="breedingFemaleInfo" style="margin-top:16px;min-height:150px;">
            <p class="muted" style="text-align:center;padding:20px;">ÈÄâÊã©ÊØçÈ∏ΩÂêéÊòæÁ§∫ËØ¶ÊÉÖ</p>
          </div>
        </div>
      </div>

      <!-- ÂéÜÂè≤ÈÖçÂØπÊàêÂäüÊ°à‰æã -->
      <div class="breeding-history-section" style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-top:24px;">
        <h4 style="margin:0 0 16px;color:#1f2937;display:flex;align-items:center;gap:8px;">
          <span>üìä</span> ÂéÜÂè≤ÈÖçÂØπ‰∏éÂêé‰ª£Ë°®Áé∞
        </h4>
        <div id="breedingHistoryContainer">
          <p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†ÈÖçÂØπÂéÜÂè≤ËÆ∞ÂΩï</p>
        </div>
      </div>
    </div>
  </section>

  <!-- ü©∫ ÂÅ•Â∫∑‰∏éÁî®ËçØÁÆ°ÁêÜÊ®°Âùó -->
  <section id="healthView" class="card" style="display:none;">
    <div class="card-header">
      <h2>ü©∫ ÂÅ•Â∫∑‰∏éÁî®ËçØÁÆ°ÁêÜ</h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <button class="btn btn-primary btn-sm" id="btnAddHealthRecord">üíâ Ê∑ªÂä†ËÆ∞ÂΩï</button>
        <button class="btn btn-outline btn-sm" id="btnHealthCalendar">üìÖ ÊèêÈÜíÊó•ÂéÜ</button>
        <button class="btn btn-outline btn-sm" id="btnRefreshHealth">üîÑ Âà∑Êñ∞</button>
      </div>
    </div>

    <!-- ÂÅ•Â∫∑Áä∂ÊÄÅÊ¶ÇËßà -->
    <div class="health-overview" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:16px;margin-bottom:24px;">
      <div style="background:linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);padding:20px;border-radius:12px;border:1px solid #10b981;">
        <div style="font-size:28px;">‚úÖ</div>
        <div style="font-size:13px;color:#047857;margin-top:8px;">ÂÅ•Â∫∑Áä∂ÊÄÅ</div>
        <div id="healthyCount" style="font-size:32px;font-weight:700;color:#047857;">0</div>
      </div>
      <div style="background:linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);padding:20px;border-radius:12px;border:1px solid #f59e0b;">
        <div style="font-size:28px;">‚è∞</div>
        <div style="font-size:13px;color:#b45309;margin-top:8px;">Âç≥Â∞ÜÂà∞Êúü</div>
        <div id="upcomingCount" style="font-size:32px;font-weight:700;color:#b45309;">0</div>
      </div>
      <div style="background:linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);padding:20px;border-radius:12px;border:1px solid #ef4444;">
        <div style="font-size:28px;">üè•</div>
        <div style="font-size:13px;color:#dc2626;margin-top:8px;">ÈúÄË¶ÅÂÖ≥Ê≥®</div>
        <div id="needAttentionCount" style="font-size:32px;font-weight:700;color:#dc2626;">0</div>
      </div>
      <div style="background:linear-gradient(135deg, #e0e7ff 0%, #eef2ff 100%);padding:20px;border-radius:12px;border:1px solid #6366f1;">
        <div style="font-size:28px;">üíä</div>
        <div style="font-size:13px;color:#4338ca;margin-top:8px;">Áî®ËçØ‰∏≠</div>
        <div id="medicatingCount" style="font-size:32px;font-weight:700;color:#4338ca;">0</div>
      </div>
    </div>

    <!-- ÂÅ•Â∫∑ÊèêÈÜíÂàóË°® -->
    <div class="health-alerts" style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:24px;">
      <h4 style="margin:0 0 16px;color:#1f2937;display:flex;align-items:center;gap:8px;">
        <span>üîî</span> ÂÅ•Â∫∑ÊèêÈÜí
      </h4>
      <div id="healthAlertsContainer">
        <p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†ÂÅ•Â∫∑ÊèêÈÜí</p>
      </div>
    </div>

    <!-- È∏ΩÂ≠êÂÅ•Â∫∑Êó∂Èó¥ËΩ¥ -->
    <div class="health-timeline" style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h4 style="margin:0;color:#1f2937;display:flex;align-items:center;gap:8px;">
          <span>üìã</span> ÂÅ•Â∫∑ËÆ∞ÂΩïÊó∂Èó¥ËΩ¥
        </h4>
        <select id="healthPigeonSelect" style="padding:8px 12px;border-radius:6px;border:1px solid #E5E7EB;min-width:200px;">
          <option value="">ÈÄâÊã©È∏ΩÂ≠êÊü•ÁúãËÆ∞ÂΩï...</option>
        </select>
      </div>
      <div id="healthTimelineContainer">
        <p class="muted" style="text-align:center;padding:40px;">ÈÄâÊã©È∏ΩÂ≠êÂêéÊòæÁ§∫ÂÅ•Â∫∑Êó∂Èó¥ËΩ¥</p>
      </div>
    </div>
  </section>

  <!-- ÂÅ•Â∫∑ËÆ∞ÂΩïÊ∑ªÂä†Ê®°ÊÄÅÊ°Ü -->
  <div id="healthModal" class="race-modal" style="display:none;">
    <div class="modal-content" style="max-width:600px;">
      <div class="modal-header">
        <h3 id="healthModalTitle">Ê∑ªÂä†ÂÅ•Â∫∑ËÆ∞ÂΩï</h3>
        <button class="btn btn-ghost btn-sm" id="btnCloseHealthModal">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group">
            <label>ÈÄâÊã©È∏ΩÂ≠ê<span class="required">*</span></label>
            <select id="healthRecordPigeon" style="padding:8px;border-radius:6px;border:1px solid #E5E7EB;">
              <option value="">ÈÄâÊã©È∏ΩÂ≠ê...</option>
            </select>
          </div>
          <div class="form-group">
            <label>ËÆ∞ÂΩïÁ±ªÂûã<span class="required">*</span></label>
            <select id="healthRecordType" style="padding:8px;border-radius:6px;border:1px solid #E5E7EB;">
              <option value="">ÈÄâÊã©Á±ªÂûã...</option>
              <option value="Áñ´Ëãó">üíâ Áñ´ËãóÊé•Áßç</option>
              <option value="È©±Ëô´">üêõ È©±Ëô´</option>
              <option value="‰ΩìÊ£Ä">üî¨ ‰ΩìÊ£Ä</option>
              <option value="ÁñæÁóÖ">üè• ÁñæÁóÖËÆ∞ÂΩï</option>
              <option value="Áî®ËçØ">üíä Áî®ËçØËÆ∞ÂΩï</option>
              <option value="Â∫∑Â§ç">‚úÖ Â∫∑Â§çËÆ∞ÂΩï</option>
              <option value="ÂÖ∂‰ªñ">üìù ÂÖ∂‰ªñ</option>
            </select>
          </div>
          <div class="form-group">
            <label>Êó•Êúü<span class="required">*</span></label>
            <input type="date" id="healthRecordDate" style="padding:8px;border-radius:6px;border:1px solid #E5E7EB;" />
          </div>
          <div class="form-group">
            <label>‰∏ãÊ¨°ÊèêÈÜíÊó•Êúü</label>
            <input type="date" id="healthRecordNextDate" style="padding:8px;border-radius:6px;border:1px solid #E5E7EB;" />
          </div>
        </div>
        <div class="form-group" style="margin-top:12px;">
          <label>ËØ¶ÁªÜÊèèËø∞</label>
          <textarea id="healthRecordDescription" rows="4" style="width:100%;padding:8px;border-radius:6px;border:1px solid #E5E7EB;resize:vertical;" placeholder="ËÆ∞ÂΩïËØ¶ÁªÜÊÉÖÂÜµÔºåÂ¶ÇÔºöÁñ´ËãóÂêçÁß∞„ÄÅÂâÇÈáè„ÄÅËçØÁâ©ÂêçÁß∞„ÄÅÁóáÁä∂Á≠â"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="btnCancelHealth">ÂèñÊ∂à</button>
        <button class="btn btn-primary" id="btnSaveHealth">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- üèÉ ËÆ≠ÁªÉÊ®°Âùó -->
  <section id="trainingView" class="card" style="display:none;">
    <div class="card-header">
      <h2>üèÉ ËÆ≠ÁªÉÊ®°Âùó</h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <button class="btn btn-primary btn-sm" id="btnScanQR">üì∑ Êâ´Á†ÅÂΩïÂÖ•</button>
        <button class="btn btn-outline btn-sm" id="btnManualInput">‚úèÔ∏è ÊâãÂä®ËæìÂÖ•</button>
        <button class="btn btn-outline btn-sm" id="btnRefreshTraining">üîÑ Âà∑Êñ∞</button>
      </div>
    </div>

    <!-- Êâ´Á†Å/ËæìÂÖ•Âå∫Âüü -->
    <div class="card" style="margin-bottom:24px;background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
      <div style="display:flex;gap:20px;align-items:flex-start;flex-wrap:wrap;">
        <div style="flex:1;min-width:300px;">
          <h4 style="margin:0 0 16px;color:#0369a1;">üì∑ Êâ´Á†ÅÊàñËæìÂÖ•ËÑöÁéØÂè∑</h4>
          <div style="display:flex;gap:12px;margin-bottom:16px;">
            <input type="text" id="trainingRingInput" placeholder="ËæìÂÖ•ËÑöÁéØÂè∑" style="flex:1;padding:12px;border-radius:8px;border:2px solid #0ea5e9;font-size:14px;" />
            <button class="btn btn-primary" id="btnSearchPigeon">üîç Êü•Êâæ</button>
          </div>
          <div id="qrScannerContainer" style="display:none;margin-top:16px;">
            <video id="qrVideo" width="100%" style="max-width:400px;border-radius:8px;background:#000;"></video>
            <canvas id="qrCanvas" style="display:none;"></canvas>
            <div style="margin-top:12px;">
              <button class="btn btn-outline btn-sm" id="btnStopScan">ÂÅúÊ≠¢Êâ´Êèè</button>
            </div>
          </div>
        </div>
        <div id="selectedPigeonInfo" style="flex:1;min-width:300px;display:none;">
          <h4 style="margin:0 0 16px;color:#0369a1;">ÈÄâ‰∏≠ÁöÑÈ∏ΩÂ≠ê</h4>
          <div id="selectedPigeonDetails" style="background:#fff;padding:16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);"></div>
        </div>
      </div>
    </div>

    <!-- ËÆ≠ÁªÉËÆ∞ÂΩïË°®Âçï -->
    <div id="trainingFormContainer" style="display:none;">
      <div class="card-header">
        <h3>üìù ËÆ∞ÂΩïËÆ≠ÁªÉÂÜÖÂÆπ</h3>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>ËÆ≠ÁªÉÊó•Êúü<span class="required">*</span></label>
          <input type="date" id="trainingDate" required />
        </div>
        <div class="form-group">
          <label>ËÆ≠ÁªÉË∑ùÁ¶ªÔºàÂÖ¨ÈáåÔºâ<span class="required">*</span></label>
          <input type="number" id="trainingDistance" step="0.1" placeholder="‰æãÂ¶ÇÔºö50" required />
        </div>
        <div class="form-group">
          <label>È£ûË°åÊó∂ÈïøÔºàÂàÜÈíüÔºâ<span class="required">*</span></label>
          <input type="number" id="trainingDuration" step="0.1" placeholder="‰æãÂ¶ÇÔºö60" required />
        </div>
        <div class="form-group">
          <label>Â§©Ê∞î</label>
          <select id="trainingWeather">
            <option value="sunny">Êô¥Â§©</option>
            <option value="cloudy">Â§ö‰∫ë</option>
            <option value="rainy">Èõ®Â§©</option>
            <option value="windy">Â§ßÈ£é</option>
            <option value="foggy">ÈõæÂ§©</option>
            <option value="unknown">Êú™Áü•</option>
          </select>
        </div>
        <div class="form-group">
          <label>Ê∏©Â∫¶Ôºà‚ÑÉÔºâ</label>
          <input type="number" id="trainingTemperature" step="0.1" placeholder="‰æãÂ¶ÇÔºö25" />
        </div>
        <div class="form-group">
          <label>È£éÈÄüÔºàm/sÔºâ</label>
          <input type="number" id="trainingWindSpeed" step="0.1" placeholder="‰æãÂ¶ÇÔºö5" />
        </div>
        <div class="form-group">
          <label>È£éÂêë</label>
          <select id="trainingDirection">
            <option value="N">Âåó</option>
            <option value="NE">‰∏úÂåó</option>
            <option value="E">‰∏ú</option>
            <option value="SE">‰∏úÂçó</option>
            <option value="S">Âçó</option>
            <option value="SW">Ë•øÂçó</option>
            <option value="W">Ë•ø</option>
            <option value="NW">Ë•øÂåó</option>
            <option value="unknown">Êú™Áü•</option>
          </select>
        </div>
        <div class="form-group">
          <label>ÊîæÈ£ûÊó∂Èó¥</label>
          <input type="time" id="trainingReleaseTime" />
        </div>
        <div class="form-group">
          <label>ÂΩíÂ∑¢Êó∂Èó¥</label>
          <input type="time" id="trainingReturnTime" />
        </div>
      </div>
      <div class="form-group" style="margin-top:16px;">
        <label>Â§áÊ≥®</label>
        <textarea id="trainingNotes" rows="3" placeholder="ËÆ∞ÂΩïËÆ≠ÁªÉËøáÁ®ã‰∏≠ÁöÑÁâπÊÆäÊÉÖÂÜµ„ÄÅËßÇÂØüÁ≠â"></textarea>
      </div>
      <div style="margin-top:24px;display:flex;gap:12px;">
        <button class="btn btn-primary" id="btnSaveTraining">üíæ ‰øùÂ≠òËÆ≠ÁªÉËÆ∞ÂΩï</button>
        <button class="btn btn-outline" id="btnCancelTraining">ÂèñÊ∂à</button>
      </div>
    </div>

    <!-- ËÆ≠ÁªÉÁªüËÆ°ÂíåÂàÜÊûê -->
    <div id="trainingStatsContainer" style="margin-top:32px;">
      <div class="card-header">
        <h3>üìä ËÆ≠ÁªÉÁªüËÆ°‰∏éÂàÜÊûê</h3>
      </div>
      
      <!-- ÁªüËÆ°Âç°Áâá -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:24px;">
        <div class="card" style="background:linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);padding:20px;">
          <div style="font-size:24px;font-weight:700;color:#1e40af;" id="trainingTotalCount">0</div>
          <div style="color:#64748b;font-size:14px;margin-top:4px;">ÊÄªËÆ≠ÁªÉÊ¨°Êï∞</div>
        </div>
        <div class="card" style="background:linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);padding:20px;">
          <div style="font-size:24px;font-weight:700;color:#047857;" id="trainingTotalDistance">0</div>
          <div style="color:#64748b;font-size:14px;margin-top:4px;">ÊÄªËÆ≠ÁªÉË∑ùÁ¶ªÔºàÂÖ¨ÈáåÔºâ</div>
        </div>
        <div class="card" style="background:linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);padding:20px;">
          <div style="font-size:24px;font-weight:700;color:#92400e;" id="trainingAvgSpeed">0</div>
          <div style="color:#64748b;font-size:14px;margin-top:4px;">Âπ≥ÂùáÈÄüÂ∫¶ÔºàÂÖ¨Èáå/Â∞èÊó∂Ôºâ</div>
        </div>
        <div class="card" style="background:linear-gradient(135deg, #fce7f3 0%, #fdf2f8 100%);padding:20px;">
          <div style="font-size:24px;font-weight:700;color:#be185d;" id="trainingMaxSpeed">0</div>
          <div style="color:#64748b;font-size:14px;margin-top:4px;">ÊúÄÈ´òÈÄüÂ∫¶ÔºàÂÖ¨Èáå/Â∞èÊó∂Ôºâ</div>
        </div>
      </div>

      <!-- ÂàÜÊûêÁªìÊûú -->
      <div class="card" style="background:#fff;margin-bottom:24px;">
        <h4 style="margin:0 0 16px;color:#1f2937;">üîç Ëá™Âä®ÂàÜÊûêÁªìÊûú</h4>
        <div id="trainingAnalysisResult">
          <p class="muted">ÊöÇÊó†ÂàÜÊûêÊï∞ÊçÆ</p>
        </div>
      </div>

      <!-- ËÆ≠ÁªÉËÆ∞ÂΩïÂàóË°® -->
      <div class="card">
        <h4 style="margin:0 0 16px;color:#1f2937;">üìã ËÆ≠ÁªÉËÆ∞ÂΩïÂàóË°®</h4>
        <div id="trainingRecordsList">
          <p class="muted">ÊöÇÊó†ËÆ≠ÁªÉËÆ∞ÂΩï</p>
        </div>
      </div>
    </div>
  </section>

  <!-- üéØ ËÉΩÂäõÁªºÂêàÂàÜÊûêÊ®°Âùó -->
  <section id="qualificationView" class="card" style="display:none;">
    <div class="card-header">
      <h2>üéØ ËÉΩÂäõÁªºÂêàÂàÜÊûê</h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <button class="btn btn-outline btn-sm" id="btnRefreshQualification">üîÑ Âà∑Êñ∞</button>
      </div>
    </div>

    <!-- ÈÄâÊã©È∏ΩÂ≠êÂíåÊØîËµõË∑ùÁ¶ª -->
    <div class="card" style="margin-bottom:24px;background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
      <h4 style="margin:0 0 16px;color:#0369a1;">ÈÄâÊã©È∏ΩÂ≠êÂíåÊØîËµõ‰ø°ÊÅØ</h4>
      <div class="form-grid">
        <div class="form-group">
          <label>ÈÄâÊã©È∏ΩÂ≠ê<span class="required">*</span></label>
          <select id="qualificationPigeonSelect" style="width:100%;">
            <option value="">ËØ∑ÈÄâÊã©È∏ΩÂ≠ê</option>
          </select>
        </div>
        <div class="form-group">
          <label>ÊØîËµõË∑ùÁ¶ªÔºàÂÖ¨ÈáåÔºâ<span class="required">*</span></label>
          <input type="number" id="qualificationDistance" step="0.1" placeholder="‰æãÂ¶ÇÔºö500" required />
        </div>
        <div class="form-group" style="align-items:flex-end;">
          <button class="btn btn-primary" id="btnAnalyzeQualification">üöÄ ÂºÄÂßãÂàÜÊûê</button>
        </div>
      </div>
    </div>

    <!-- ÂàÜÊûêÁªìÊûú -->
    <div id="qualificationResultContainer" style="display:none;">
      <!-- ÂÖçË¥£Â£∞Êòé -->
      <div class="card" style="background:#fef3c7;border:2px solid #f59e0b;margin-bottom:24px;">
        <div style="display:flex;align-items:flex-start;gap:12px;">
          <span style="font-size:24px;">‚ö†Ô∏è</span>
          <div>
            <h4 style="margin:0 0 8px;color:#92400e;">Êï∞ÊçÆ‰ªÖ‰æõÂèÇËÄÉ</h4>
            <p style="margin:0;color:#78350f;font-size:14px;" id="qualificationDisclaimer">
              Êú¨ÂàÜÊûêÁªìÊûú‰ªÖ‰æõÂèÇËÄÉÔºåÂÆûÈôÖÂèÇËµõËµÑÊ†º‰ª•Ëµõ‰∫ãÁªÑÂßî‰ºöËßÑÂÆö‰∏∫ÂáÜ„ÄÇÊï∞ÊçÆÊù•Ê∫ê‰∫éËÆ≠ÁªÉËÆ∞ÂΩï„ÄÅÂéÜÂè≤ÊØîËµõËÆ∞ÂΩïÂèäÂÖ¨ÂºÄËµõ‰∫ãÊï∞ÊçÆÔºåÂèØËÉΩÂ≠òÂú®ËØØÂ∑Æ„ÄÇ
            </p>
          </div>
        </div>
      </div>

      <!-- ÁªºÂêàÂàÜÊûêÁªìÊûú -->
      <div class="card" style="margin-bottom:24px;">
        <h3 style="margin:0 0 16px;color:#1f2937;">üìä ÁªºÂêàÂàÜÊûêÁªìÊûú</h3>
        <div id="qualificationAnalysisResult">
          <!-- ÂàÜÊûêÁªìÊûúÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
        </div>
      </div>

      <!-- ËÆ≠ÁªÉÂàÜÊûê -->
      <div class="card" style="margin-bottom:24px;">
        <h4 style="margin:0 0 16px;color:#1f2937;">üèÉ ËÆ≠ÁªÉÊï∞ÊçÆÂàÜÊûê</h4>
        <div id="qualificationTrainingAnalysis">
          <!-- ËÆ≠ÁªÉÂàÜÊûêÁªìÊûú -->
        </div>
      </div>

      <!-- ÂéÜÂè≤ÊØîËµõÂàÜÊûê -->
      <div class="card" style="margin-bottom:24px;">
        <h4 style="margin:0 0 16px;color:#1f2937;">üèÜ ÂéÜÂè≤ÊØîËµõÂàÜÊûê</h4>
        <div id="qualificationRaceAnalysis">
          <!-- ÂéÜÂè≤ÊØîËµõÂàÜÊûêÁªìÊûú -->
        </div>
      </div>

      <!-- Êï∞ÊçÆÂØπÊØîÂàÜÊûê -->
      <div class="card" style="margin-bottom:24px;">
        <h4 style="margin:0 0 16px;color:#1f2937;">üìà Êï∞ÊçÆÂØπÊØîÂàÜÊûê</h4>
        <div id="qualificationComparisonAnalysis">
          <!-- ÂØπÊØîÂàÜÊûêÁªìÊûú -->
        </div>
      </div>

      <!-- Âª∫ËÆÆ -->
      <div class="card" style="background:linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);border:2px solid #10b981;margin-bottom:24px;">
        <h4 style="margin:0 0 16px;color:#047857;">üí° Âª∫ËÆÆ</h4>
        <div id="qualificationRecommendations">
          <!-- Âª∫ËÆÆÂàóË°® -->
        </div>
      </div>
    </div>

    <!-- ËÉΩÂäõÂàÜÊûêËÆ∞ÂΩïË°®Ê†º -->
    <div class="card" style="margin-top:24px;">
      <div class="card-header">
        <h3 style="margin:0;">üìä ËÉΩÂäõÂàÜÊûêËÆ∞ÂΩïË°®</h3>
        <p style="margin:8px 0 0 0;color:#6b7280;font-size:14px;">ÊâÄÊúâÂàÜÊûêÁªìÊûúÂ∞ÜËá™Âä®ËÆ∞ÂΩïÂú®Ê≠§Ë°®Ê†º‰∏≠ÔºåÊåâÈÄÇÂêàÂèÇËµõÂ∫¶‰ªéÈ´òÂà∞‰ΩéÊéíÂàó</p>
      </div>
      <div id="qualificationRecordsList" style="padding:20px;">
        <p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†ÂàÜÊûêËÆ∞ÂΩï</p>
      </div>
    </div>

    <!-- ËÉΩÂäõÂàÜÊûêÂêéÁöÑÂèçÈ¶àÂÖ•Âè£ -->
    <div class="card" style="margin-top:20px;padding:20px;display:flex;align-items:center;justify-content:space-between;gap:12px;background:linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);border:1px solid #c7d2fe;">
      <div>
        <h4 style="margin:0 0 6px;color:#312e81;">ÂØπËÉΩÂäõÂàÜÊûêÊúâÂª∫ËÆÆÔºü</h4>
        <p style="margin:0;color:#4b5563;font-size:14px;">ÁÇπÂáªÂèçÈ¶àÂëäËØâÊàë‰ª¨ÂàÜÊûêÁªìÊûú„ÄÅÁÆóÊ≥ïÊàñÂ±ïÁ§∫ÁöÑÊîπËøõÊÑèËßÅ„ÄÇ</p>
      </div>
      <button class="btn btn-primary" data-open-feedback="true" style="white-space:nowrap;">üêõ ÊÑèËßÅ‰∏éÂèçÈ¶à</button>
    </div>
  </section>


  <!-- ÂøòËÆ∞ÂØÜÁ†ÅÊ®°ÊÄÅÊ°Ü -->
  <div id="forgotPasswordModal" class="race-modal" style="display:none;">
    <div class="modal-content" style="max-width:500px;">
      <div class="modal-header">
        <h3>ÊâæÂõûÂØÜÁ†Å</h3>
        <button class="btn btn-ghost btn-sm" id="btnCloseForgotPassword">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>ÈÇÆÁÆ±Âú∞ÂùÄ<span class="required">*</span></label>
          <input type="email" id="forgotPasswordEmail" placeholder="ËØ∑ËæìÂÖ•Ê≥®ÂÜåÈÇÆÁÆ±" style="width:100%;" />
        </div>
        <div id="forgotPasswordMessage" style="margin-top:16px;padding:12px;border-radius:8px;display:none;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="btnCancelForgotPassword">ÂèñÊ∂à</button>
        <button class="btn btn-primary" id="btnSubmitForgotPassword">ÂèëÈÄÅÈáçÁΩÆÈìæÊé•</button>
      </div>
    </div>
  </div>

  <!-- üß† Êô∫ËÉΩÂàÜÊûê‰∏≠ÂøÉÊ®°Âùó -->
  <section id="analysisView" class="card" style="display:none;">
    <div class="card-header">
      <h2>üß† Êô∫ËÉΩÂàÜÊûê‰∏≠ÂøÉ</h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <button class="btn btn-primary btn-sm" id="btnRunAnalysis">üöÄ ËøêË°åÂÖ®Èù¢ÂàÜÊûê</button>
        <button class="btn btn-outline btn-sm" id="btnExportReport">üì§ ÂØºÂá∫Êä•Âëä</button>
        <button class="btn btn-outline btn-sm" id="btnRefreshAnalysis">üîÑ Âà∑Êñ∞</button>
      </div>
    </div>

    <!-- Êô∫ËÉΩÊ¥ûÂØüÂç°Áâá -->
    <div class="insight-cards" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:20px;margin-bottom:24px;">
      <!-- ‰ªäÂπ¥ÊúÄÊàêÂäüÁöÑË°ÄÁ≥ª -->
      <div class="insight-card" style="background:linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);padding:24px;border-radius:16px;border:2px solid #f59e0b;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
          <span style="font-size:32px;">üèÜ</span>
          <h4 style="margin:0;color:#92400e;">‰ªäÂπ¥ÊúÄÊàêÂäüË°ÄÁ≥ª</h4>
        </div>
        <div id="topBloodlineCard">
          <p class="muted">ÂàÜÊûê‰∏≠...</p>
        </div>
      </div>

      <!-- ÊúÄÂº∫ÁßçÂÖ¨ -->
      <div class="insight-card" style="background:linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);padding:24px;border-radius:16px;border:2px solid #3b82f6;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
          <span style="font-size:32px;">‚ôÇ</span>
          <h4 style="margin:0;color:#1e40af;">ÊúÄÂº∫ÁßçÂÖ¨</h4>
        </div>
        <div id="topMaleCard">
          <p class="muted">ÂàÜÊûê‰∏≠...</p>
        </div>
      </div>

      <!-- ÊúÄÂº∫ÁßçÊØç -->
      <div class="insight-card" style="background:linear-gradient(135deg, #fce7f3 0%, #fdf2f8 100%);padding:24px;border-radius:16px;border:2px solid #ec4899;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
          <span style="font-size:32px;">‚ôÄ</span>
          <h4 style="margin:0;color:#be185d;">ÊúÄÂº∫ÁßçÊØç</h4>
        </div>
        <div id="topFemaleCard">
          <p class="muted">ÂàÜÊûê‰∏≠...</p>
        </div>
      </div>

      <!-- Êé®ËçêÈÖçÂØπ -->
      <div class="insight-card" style="background:linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);padding:24px;border-radius:16px;border:2px solid #10b981;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
          <span style="font-size:32px;">üíï</span>
          <h4 style="margin:0;color:#047857;">Êô∫ËÉΩÊé®ËçêÈÖçÂØπ</h4>
        </div>
        <div id="recommendedPairingCard">
          <p class="muted">ÂàÜÊûê‰∏≠...</p>
        </div>
      </div>
    </div>

    <!-- È∏ΩÂ≠êÊΩúÂäõÊéíË°åÊ¶ú -->
    <div class="potential-ranking" style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:24px;">
      <h4 style="margin:0 0 16px;color:#1f2937;display:flex;align-items:center;gap:8px;">
        <span>‚≠ê</span> È∏ΩÂ≠êÊΩúÂäõÊéíË°åÊ¶ú
      </h4>
      <div id="potentialRankingContainer">
        <p class="muted" style="text-align:center;padding:20px;">Ê≠£Âú®ËÆ°ÁÆóÊΩúÂäõËØÑÂàÜ...</p>
      </div>
    </div>

    <!-- Â§±Ë¥•ÈÖçÂØπÂàÜÊûê -->
    <div class="failed-pairings" style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:24px;">
      <h4 style="margin:0 0 16px;color:#1f2937;display:flex;align-items:center;gap:8px;">
        <span>‚ö†Ô∏è</span> Â§±Ë¥•ÈÖçÂØπÊéíË°åÊ¶ú
      </h4>
      <div id="failedPairingsContainer">
        <p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†ÈÖçÂØπËÆ∞ÂΩï</p>
      </div>
    </div>

    <!-- ÁªºÂêàÂàÜÊûêÁªìËÆ∫ -->
    <div class="analysis-conclusion" style="background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);border-radius:12px;padding:24px;border:2px solid #0ea5e9;">
      <h4 style="margin:0 0 16px;color:#0369a1;display:flex;align-items:center;gap:8px;">
        <span>üí°</span> Êô∫ËÉΩÂàÜÊûêÁªìËÆ∫‰∏éÂª∫ËÆÆ
      </h4>
      <div id="analysisConclusion">
        <p class="muted">ÁÇπÂáª"ËøêË°åÂÖ®Èù¢ÂàÜÊûê"ÁîüÊàêÊô∫ËÉΩÂàÜÊûêÊä•Âëä</p>
      </div>
    </div>
  </section>

  <!-- ÈÖçÂØπÊ®°ÊÄÅÊ°Ü -->
  <div id="pairingModal" class="race-modal" style="display:none;">
    <div class="modal-content" style="max-width:500px;">
      <div class="modal-header">
        <h3>Á°ÆËÆ§ÈÖçÂØπ</h3>
        <button class="btn btn-ghost btn-sm" id="btnClosePairingModal">‚úï</button>
      </div>
      <div class="modal-body">
        <div id="pairingConfirmContent">
          <!-- ÈÖçÂØπÁ°ÆËÆ§ÂÜÖÂÆπ -->
        </div>
        <div class="form-group" style="margin-top:16px;">
          <label>ÈÖçÂØπÊó•Êúü<span class="required">*</span></label>
          <input type="date" id="pairingDate" style="width:100%;padding:8px;border-radius:6px;border:1px solid #E5E7EB;" />
        </div>
        <div class="form-group" style="margin-top:12px;">
          <label>Â§áÊ≥®</label>
          <textarea id="pairingNote" rows="3" style="width:100%;padding:8px;border-radius:6px;border:1px solid #E5E7EB;resize:vertical;" placeholder="ÂèØÈÄâÔºöËÆ∞ÂΩïÈÖçÂØπÂéüÂõ†„ÄÅÈ¢ÑÊúüÁ≠â"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="btnCancelPairing">ÂèñÊ∂à</button>
        <button class="btn btn-primary" id="btnSavePairing">Á°ÆËÆ§ÈÖçÂØπ</button>
      </div>
    </div>
  </div>

  <!-- Êñ∞Â¢ûËßÜÂõæ -->
  <section id="createView" class="card" style="display:none;">
    <div class="card-header">
      <h2>Êñ∞Â¢ûÈ∏ΩÂ≠ê‰ø°ÊÅØ</h2>
      <div class="muted">È¶ñÊ¨°ÂΩïÂÖ•‰∏ÄÂè™È∏ΩÂ≠êÁöÑÂÆåÊï¥Ê°£Ê°à„ÄÇ</div>
    </div>

    <div class="section-title">Âü∫Êú¨‰ø°ÊÅØ</div>
    <div class="section-desc">ÂÉèÂ°´ÂÜôË°®Ê†º‰∏ÄÊ†∑ÁÆÄÂçïÔºåË∂≥ÁéØÂè∑ÂøÖÈ°ªÂîØ‰∏Ä„ÄÇ</div>
    <div class="form-grid">
      <div class="form-group">
        <label>È∏ΩÂ≠êÂêçÁß∞</label>
        <input id="c_name" type="text" placeholder="ÂèØÈÄâÔºå‰æãÂ¶ÇÔºöÈ£ûÂ§©001" />
      </div>
      <div class="form-group">
        <label>Ë∂≥ÁéØÂè∑Á†Å<span class="required">*</span></label>
        <input id="c_ring" type="text" placeholder="ÂøÖÂ°´ÔºåÂîØ‰∏ÄÔºåÂ¶ÇÔºöCHN2025-0001" />
      </div>
      <div class="form-group">
        <label>ÊÄßÂà´</label>
        <select id="c_gender">
          <option value="">Êú™ÈÄâÊã©</option>
          <option value="ÂÖ¨">ÂÖ¨</option>
          <option value="ÊØç">ÊØç</option>
          <option value="Êú™Áü•">Êú™Áü•</option>
        </select>
      </div>
      <div class="form-group">
        <label>ÁæΩËâ≤</label>
        <input id="c_color" type="text" placeholder="Â¶ÇÔºöÁÅ∞„ÄÅÈõ®ÁÇπ„ÄÅÁôΩÊù°‚Ä¶" />
      </div>
      <div class="form-group">
        <label>Âá∫ÁîüÊó•Êúü</label>
        <input id="c_birth" type="date" />
      </div>
      <div class="form-group">
        <label>È∏ΩÂ≠êÁ±ªÂûã</label>
        <select id="c_type">
          <option value="">Êú™ÈÄâÊã©</option>
          <option value="ÁßçÈ∏Ω">ÁßçÈ∏Ω</option>
          <option value="ÊØîËµõÈ∏Ω">ÊØîËµõÈ∏Ω</option>
          <option value="Âêé‰ª£È∏Ω">Âêé‰ª£È∏Ω</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ê†∏ÂøÉÁßçÈ∏Ω</label>
        <div class="radio-group">
          <label><input type="checkbox" id="c_core" /> Ê†áËÆ∞‰∏∫Ê†∏ÂøÉÁßçÈ∏Ω ‚≠ê</label>
        </div>
      </div>
    </div>

    <!-- ÁßçÈ∏Ω‰∏ìÁî®‰ø°ÊÅØÔºöÂâçÈ∏Ω‰∏ªÂíåÂâçÂú∞Âå∫ -->
    <div id="c_breederExtra" class="section-title" style="display:none;">ÁßçÈ∏Ω‰ø°ÊÅØ</div>
    <div id="c_breederExtraDesc" class="section-desc" style="display:none;">ÁßçÈ∏ΩÈúÄË¶ÅËÆ∞ÂΩïÂâçÈ∏Ω‰∏ªÂíåÂâçÂú∞Âå∫‰ø°ÊÅØ</div>
    <div id="c_breederExtraFields" class="form-grid" style="display:none;">
      <div class="form-group">
        <label>ÂâçÈ∏Ω‰∏ªÔºàÂèØÈÄâÔºâ</label>
        <input id="c_previousOwner" type="text" placeholder="Â¶ÇÔºöÂº†‰∏â" />
      </div>
      <div class="form-group">
        <label>ÂâçÂú∞Âå∫ÔºàÂèØÈÄâÔºâ</label>
        <input id="c_previousRegion" type="text" placeholder="Â¶ÇÔºöÂåó‰∫¨" />
      </div>
    </div>

    <!-- Áé∞È∏Ω‰∏ªÂíåÁé∞Âú∞Âå∫ÔºàÊâÄÊúâÈ∏ΩÂ≠êÈÉΩÊúâÔºâ -->
    <div class="section-title">È∏Ω‰∏ª‰ø°ÊÅØ</div>
    <div class="section-desc">ËÆ∞ÂΩïÂΩìÂâçÈ∏Ω‰∏ªÂíåÊâÄÂú®Âú∞Âå∫</div>
    <div class="form-grid">
      <div class="form-group">
        <label>Áé∞È∏Ω‰∏ª</label>
        <div style="position:relative;">
          <input id="c_currentOwner" type="text" placeholder="Â¶ÇÔºöÊùéÂõΩËæâ" list="c_ownerList" style="width:100%;" />
          <datalist id="c_ownerList"></datalist>
        </div>
        <span class="muted" style="font-size:12px;">ËæìÂÖ•Êàñ‰ªé‰∏ãÊãâÈÄâÊã©</span>
      </div>
      <div class="form-group">
        <label>Áé∞Âú∞Âå∫</label>
        <input id="c_currentRegion" type="text" placeholder="Â¶ÇÔºöË¥µÂ∑ûÈªîË•ø" list="c_regionList" />
        <datalist id="c_regionList"></datalist>
        <span class="muted" style="font-size:12px;">ËæìÂÖ•Êàñ‰ªé‰∏ãÊãâÈÄâÊã©</span>
      </div>
    </div>

    <div class="section-title">Ë°ÄÁªü‰ø°ÊÅØ</div>
    <div class="section-desc">Áà∂È∏Ω / ÊØçÈ∏ΩÂèØ‰ªéÂ∑≤ÂΩïÂÖ•ÁöÑÈ∏ΩÂ≠ê‰∏≠ÈÄâÊã©Ôºå‰πüÂèØ‰ª•ÊöÇÊó∂ÁïôÁ©∫ÔºåÂêéÁª≠ÂÜçË°•ÂÖÖ„ÄÇ</div>
    <div class="form-grid">
      <div class="form-group">
        <label>Áà∂È∏ΩÔºàÂèØÈÄâÔºâ</label>
        <select id="c_father"></select>
      </div>
      <div class="form-group">
        <label>ÊØçÈ∏ΩÔºàÂèØÈÄâÔºâ</label>
        <select id="c_mother"></select>
      </div>
    </div>

    <div class="section-title">ÂèÇËµõ‰ø°ÊÅØÔºàÂèØÊ∑ªÂä†Â§öÊù°Ôºâ</div>
    <div class="section-desc">ÊØèÊ¨°ÊØîËµõÂçïÁã¨‰∏ÄÊù°ËÆ∞ÂΩïÔºåÊñπ‰æøÊó•ÂêéÁªüËÆ°ÂíåÊü•Áúã„ÄÇ</div>
    <div id="c_raceList" class="race-list"></div>
    <button class="btn btn-outline btn-sm" id="btnAddRaceCreate">‚ûï Ê∑ªÂä†‰∏ÄÊù°ÂèÇËµõËÆ∞ÂΩï</button>

    <div class="section-title">È∏ΩÂ≠êÁä∂ÊÄÅ</div>
    <div class="section-desc">Ê≠ª‰∫°Âè™ÊîπÂèòÁä∂ÊÄÅÔºå‰∏ç‰ºöÂà†Èô§‰ªª‰ΩïÂéÜÂè≤ÊàêÁª©„ÄÇ</div>
    <div class="form-grid">
      <div class="form-group">
        <label>ÂΩìÂâçÁä∂ÊÄÅ</label>
        <div class="radio-group">
          <label><input type="radio" name="c_alive" value="alive" checked /> Âú®‰∏ñ</label>
          <label><input type="radio" name="c_alive" value="dead" /> Â∑≤Ê≠ª‰∫°</label>
        </div>
      </div>
      <div class="form-group c-death-extra" style="display:none;">
        <label>Ê≠ª‰∫°Êó•Êúü<span class="required">*</span></label>
        <input id="c_death_date" type="date" />
      </div>
      <div class="form-group c-death-extra" style="display:none;">
        <label>Ê≠ª‰∫°ÂéüÂõ†ÔºàÂèØÈÄâÔºâ</label>
        <input id="c_death_reason" type="text" placeholder="Â¶ÇÔºöÁñæÁóÖ„ÄÅÊÑèÂ§ñ‚Ä¶" />
      </div>
    </div>

    <div class="section-title">ÂõæÁâá‰∏ä‰º†</div>
    <div class="section-desc">ÂèØ‰∏∫ÊØèÂè™È∏ΩÂ≠ê‰∏ä‰º†‰∏§Âº†ÂõæÁâáÔºö‰∏ÄÂº†Á´ôÁ´ã‰æßË∫´ÁÖß„ÄÅ‰∏ÄÂº†ÁúºÁùõÁâπÂÜôÔºõËã•‰∏ç‰∏ä‰º†ÔºåÂ∞Ü‰ΩøÁî®Á§∫‰æãÂõæÁâáÔºàIMG_6540.jpg ‰∏∫Á´ôÁ´ã‰æßË∫´ÂõæÔºåIMG_6539.jpg ‰∏∫ÁúºÈÉ®ÁâπÂÜôÔºâ„ÄÇ</div>
    <div class="form-grid">
      <div class="form-group">
        <label>Á´ôÁ´ã‰æßË∫´ÂõæÁâá</label>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="c_body_photo" type="file" accept="image/*" style="flex:1;" />
          <input id="c_body_photo_camera" type="file" accept="image/*" capture style="display:none;" />
          <button type="button" class="btn btn-outline btn-sm" id="btnCameraBodyCreate" style="white-space:nowrap;">üì∑ ÊãçÁÖß</button>
        </div>
        <span class="muted">ÊîØÊåÅÂ∏∏ËßÅÂõæÁâáÊ†ºÂºèÔºàJPG„ÄÅPNG„ÄÅGIF„ÄÅWEBPÁ≠âÔºâÔºåÊó†ÂàÜËæ®ÁéáÈôêÂà∂„ÄÇÂèØ‰∏ä‰º†ÂõæÁâáÊàñÁõ¥Êé•ÊãçÁÖß„ÄÇ</span>
      </div>
      <div class="form-group">
        <label>ÁúºÁùõÁâπÂÜôÂõæÁâá</label>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="c_eye_photo" type="file" accept="image/*" style="flex:1;" />
          <input id="c_eye_photo_camera" type="file" accept="image/*" capture style="display:none;" />
          <button type="button" class="btn btn-outline btn-sm" id="btnCameraEyeCreate" style="white-space:nowrap;">üì∑ ÊãçÁÖß</button>
        </div>
        <span class="muted">ÊîØÊåÅÂ∏∏ËßÅÂõæÁâáÊ†ºÂºèÔºàJPG„ÄÅPNG„ÄÅGIF„ÄÅWEBPÁ≠âÔºâÔºåÊó†ÂàÜËæ®ÁéáÈôêÂà∂„ÄÇÂèØ‰∏ä‰º†ÂõæÁâáÊàñÁõ¥Êé•ÊãçÁÖß„ÄÇ</span>
      </div>
    </div>

    <div style="margin-top:16px; display:flex; justify-content:flex-end; gap:8px;">
      <button class="btn btn-ghost" id="btnCancelCreate">‚ùå ÂèñÊ∂à</button>
      <button class="btn btn-primary" id="btnSaveCreate">üíæ ‰øùÂ≠ò</button>
    </div>
  </section>

  <!-- ËØ¶ÊÉÖËßÜÂõæ -->
  <section id="detailView" class="card" style="display:none;">
    <div class="flex-between">
      <div>
        <h2 id="d_title" style="margin:0 0 4px;"></h2>
        <div class="muted" id="d_subtitle"></div>
      </div>
      <div>
        <button class="btn btn-outline btn-sm" id="btnBackList">‚Üê ËøîÂõûÂàóË°®</button>
        <button class="btn btn-danger btn-sm" id="btnDeletePigeon" style="margin-left:8px;">üóë Âà†Èô§</button>
        <button class="btn btn-primary btn-sm" id="btnToggleEdit" style="margin-left:8px;">‚úè ÁºñËæë‰ø°ÊÅØ</button>
      </div>
    </div>
    <div id="d_statusRow" style="margin-top:8px; font-size:13px;"></div>

    <div class="notice" id="d_editNotice" style="display:none; margin-top:12px;">
      ÂΩìÂâç‰∏∫ÁºñËæëÊ®°Âºè„ÄÇ‰øÆÊîπÂêéÁÇπÂáªÂè≥‰∏ãËßí„Äå‰øùÂ≠ò„ÄçÂç≥ÂèØÁ´ãÂç≥ÁîüÊïàÔºõÁ¶ªÂºÄÂâçÊú™‰øùÂ≠ò‰ºö‰∏¢Â§±„ÄÇ
    </div>

    <div style="margin-top:16px;">
      <!-- ÊµèËßàÊ®°ÂºèÂÆπÂô® -->
      <div id="browseMode">
        <!-- ÂõæÁâáÂå∫ÂüüÔºö‰∏ªË¶ÅÂÜÖÂÆπÔºåÊîæÂú®ÊúÄÂâçÈù¢ -->
        <div id="d_images" style="margin-bottom:24px;"></div>

        <div class="section-title">Âü∫Êú¨‰ø°ÊÅØ</div>
        <div id="d_basic"></div>

        <div class="section-title">Ë°ÄÁªü‰ø°ÊÅØ</div>
        <div id="d_pedigree"></div>

        <div class="section-title">Ë°ÄÁªüÊ†ëÂèØËßÜÂåñ</div>
        <div id="d_pedigreeTree" style="margin-top:8px;"></div>

        <div class="section-title">ÂèÇËµõËÆ∞ÂΩï</div>
        <div id="d_races"></div>
      </div>

      <!-- ÁºñËæëÊ®°ÂºèË°®ÂçïÔºà‰∏éÊñ∞Â¢ûÁ±ª‰ººÔºâ -->
      <div id="editMode" style="display:none;">
        <div class="section-title">Âü∫Êú¨‰ø°ÊÅØ</div>
        <div class="form-grid">
          <div class="form-group">
            <label>È∏ΩÂ≠êÂêçÁß∞</label>
            <input id="e_name" type="text" />
          </div>
          <div class="form-group">
            <label>Ë∂≥ÁéØÂè∑Á†Å<span class="required">*</span></label>
            <input id="e_ring" type="text" disabled />
            <span class="muted">‰Ωú‰∏∫ÂîØ‰∏ÄÊ†áËØÜÔºåÈÄöÂ∏∏‰∏çÂÖÅËÆ∏‰øÆÊîπ„ÄÇ</span>
          </div>
          <div class="form-group">
            <label>ÊÄßÂà´</label>
            <select id="e_gender">
              <option value="">Êú™ÈÄâÊã©</option>
              <option value="ÂÖ¨">ÂÖ¨</option>
              <option value="ÊØç">ÊØç</option>
              <option value="Êú™Áü•">Êú™Áü•</option>
            </select>
          </div>
          <div class="form-group">
            <label>ÁæΩËâ≤</label>
            <input id="e_color" type="text" />
          </div>
          <div class="form-group">
            <label>Âá∫ÁîüÊó•Êúü</label>
            <input id="e_birth" type="date" />
          </div>
          <div class="form-group">
            <label>È∏ΩÂ≠êÁ±ªÂûã</label>
            <select id="e_type">
              <option value="">Êú™ÈÄâÊã©</option>
              <option value="ÁßçÈ∏Ω">ÁßçÈ∏Ω</option>
              <option value="ÊØîËµõÈ∏Ω">ÊØîËµõÈ∏Ω</option>
              <option value="Âêé‰ª£È∏Ω">Âêé‰ª£È∏Ω</option>
            </select>
          </div>
          <div class="form-group">
            <label>Ê†∏ÂøÉÁßçÈ∏Ω</label>
            <div class="radio-group">
              <label><input type="checkbox" id="e_core" /> Ê†áËÆ∞‰∏∫Ê†∏ÂøÉÁßçÈ∏Ω ‚≠ê</label>
            </div>
          </div>
        </div>

        <!-- ÁßçÈ∏Ω‰∏ìÁî®‰ø°ÊÅØÔºöÂâçÈ∏Ω‰∏ªÂíåÂâçÂú∞Âå∫ -->
        <div id="e_breederExtra" class="section-title" style="display:none;">ÁßçÈ∏Ω‰ø°ÊÅØ</div>
        <div id="e_breederExtraDesc" class="section-desc" style="display:none;">ÁßçÈ∏ΩÈúÄË¶ÅËÆ∞ÂΩïÂâçÈ∏Ω‰∏ªÂíåÂâçÂú∞Âå∫‰ø°ÊÅØ</div>
        <div id="e_breederExtraFields" class="form-grid" style="display:none;">
          <div class="form-group">
            <label>ÂâçÈ∏Ω‰∏ªÔºàÂèØÈÄâÔºâ</label>
            <input id="e_previousOwner" type="text" placeholder="Â¶ÇÔºöÂº†‰∏â" />
          </div>
          <div class="form-group">
            <label>ÂâçÂú∞Âå∫ÔºàÂèØÈÄâÔºâ</label>
            <input id="e_previousRegion" type="text" placeholder="Â¶ÇÔºöÂåó‰∫¨" />
          </div>
        </div>

        <!-- Áé∞È∏Ω‰∏ªÂíåÁé∞Âú∞Âå∫ÔºàÊâÄÊúâÈ∏ΩÂ≠êÈÉΩÊúâÔºâ -->
        <div class="section-title">È∏Ω‰∏ª‰ø°ÊÅØ</div>
        <div class="section-desc">ËÆ∞ÂΩïÂΩìÂâçÈ∏Ω‰∏ªÂíåÊâÄÂú®Âú∞Âå∫</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Áé∞È∏Ω‰∏ª</label>
            <div style="position:relative;">
              <input id="e_currentOwner" type="text" placeholder="Â¶ÇÔºöÊùéÂõΩËæâ" list="e_ownerList" style="width:100%;" />
              <datalist id="e_ownerList"></datalist>
            </div>
            <span class="muted" style="font-size:12px;">ËæìÂÖ•Êàñ‰ªé‰∏ãÊãâÈÄâÊã©</span>
          </div>
          <div class="form-group">
            <label>Áé∞Âú∞Âå∫</label>
            <input id="e_currentRegion" type="text" placeholder="Â¶ÇÔºöË¥µÂ∑ûÈªîË•ø" list="e_regionList" />
            <datalist id="e_regionList"></datalist>
            <span class="muted" style="font-size:12px;">ËæìÂÖ•Êàñ‰ªé‰∏ãÊãâÈÄâÊã©</span>
          </div>
        </div>

        <div class="section-title">Ë°ÄÁªü‰ø°ÊÅØ</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Áà∂È∏ΩÔºàÂèØÈÄâÔºâ</label>
            <select id="e_father"></select>
          </div>
          <div class="form-group">
            <label>ÊØçÈ∏ΩÔºàÂèØÈÄâÔºâ</label>
            <select id="e_mother"></select>
          </div>
        </div>

        <div class="section-title">ÂèÇËµõ‰ø°ÊÅØÔºàÂèØÂ¢û / Êîπ / Âà†Ôºâ</div>
        <div id="e_raceList" class="race-list"></div>
        <button class="btn btn-outline btn-sm" id="btnAddRaceEdit">‚ûï Ê∑ªÂä†‰∏ÄÊù°ÂèÇËµõËÆ∞ÂΩï</button>

        <div class="section-title">È∏ΩÂ≠êÁä∂ÊÄÅ</div>
        <div class="form-grid">
          <div class="form-group">
            <label>ÂΩìÂâçÁä∂ÊÄÅ</label>
            <div class="radio-group">
              <label><input type="radio" name="e_alive" value="alive" /> Âú®‰∏ñ</label>
              <label><input type="radio" name="e_alive" value="dead" /> Â∑≤Ê≠ª‰∫°</label>
            </div>
          </div>
          <div class="form-group e-death-extra" style="display:none;">
            <label>Ê≠ª‰∫°Êó•Êúü<span class="required">*</span></label>
            <input id="e_death_date" type="date" />
          </div>
          <div class="form-group e-death-extra" style="display:none;">
            <label>Ê≠ª‰∫°ÂéüÂõ†ÔºàÂèØÈÄâÔºâ</label>
            <input id="e_death_reason" type="text" />
          </div>
        </div>

        <div class="section-title">ÂõæÁâáÁÆ°ÁêÜ</div>
        <div class="section-desc">ÂèØ‰∏ä‰º†ÊàñÊõ¥Êñ∞ËØ•È∏ΩÂ≠êÁöÑÁ´ôÁ´ã‰æßË∫´ÁÖß‰∏éÁúºÁùõÁâπÂÜôÔºõ‰∏ä‰º†Êñ∞ÂõæÁâáÂ∞ÜÊõøÊç¢Áé∞ÊúâÂõæÁâáÔºåËã•‰∏çÈÄâÊã©Êñ∞ÂõæÁâáÔºåÂàô‰øùÁïôÂΩìÂâçÂõæÁâáÊàñ‰ΩøÁî®Á§∫‰æãÂõæÁâá„ÄÇ</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Á´ôÁ´ã‰æßË∫´ÂõæÁâá</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input id="e_body_photo" type="file" accept="image/*" style="flex:1;" />
              <input id="e_body_photo_camera" type="file" accept="image/*" capture style="display:none;" />
              <button type="button" class="btn btn-outline btn-sm" id="btnCameraBodyEdit" style="white-space:nowrap;">üì∑ ÊãçÁÖß</button>
            </div>
            <span class="muted" style="font-size:12px; margin-top:4px;">ÊîØÊåÅÂ∏∏ËßÅÂõæÁâáÊ†ºÂºèÔºåÊó†ÂàÜËæ®ÁéáÈôêÂà∂„ÄÇÂèØ‰∏ä‰º†ÂõæÁâáÊàñÁõ¥Êé•ÊãçÁÖß„ÄÇ</span>
          </div>
          <div class="form-group">
            <label>ÁúºÁùõÁâπÂÜôÂõæÁâá</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input id="e_eye_photo" type="file" accept="image/*" style="flex:1;" />
              <input id="e_eye_photo_camera" type="file" accept="image/*" capture style="display:none;" />
              <button type="button" class="btn btn-outline btn-sm" id="btnCameraEyeEdit" style="white-space:nowrap;">üì∑ ÊãçÁÖß</button>
            </div>
            <span class="muted" style="font-size:12px; margin-top:4px;">ÊîØÊåÅÂ∏∏ËßÅÂõæÁâáÊ†ºÂºèÔºåÊó†ÂàÜËæ®ÁéáÈôêÂà∂„ÄÇÂèØ‰∏ä‰º†ÂõæÁâáÊàñÁõ¥Êé•ÊãçÁÖß„ÄÇ</span>
          </div>
        </div>

        <div style="margin-top:16px; display:flex; justify-content:flex-end; gap:8px;">
          <button class="btn btn-ghost" id="btnCancelEdit">ÂèñÊ∂à</button>
          <button class="btn btn-primary" id="btnSaveEdit">‰øùÂ≠ò</button>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
  // ÁÆÄÂçïÂÜÖÂ≠òÊï∞ÊçÆÁªìÊûÑÔºå‰ΩøÁî® localStorage ÂÅöÊú¨Âú∞ÊåÅ‰πÖÂåñ
  const STORAGE_KEY = 'pigeon_manager_data_v1';
  const USED_NAMES_KEY = 'pigeon_used_names_v1';
  const OWNER_REGION_PAIRS_KEY = 'pigeon_owner_region_pairs_v1';
  let pigeons = [];
  let currentDetailId = null; // ÂΩìÂâçËØ¶ÊÉÖÈ°µÊòæÁ§∫ÁöÑÈ∏ΩÂ≠ê id
  
  // È∏ΩÂ≠êÂêçÂ≠óÂàóË°®Ôºà‰∏ÄÊ¨°ÊÄß‰ΩøÁî®Ôºå‰∏çÈáçÂ§çÔºâ
  const PIGEON_NAMES = [
    'Áâπ', 'Â∏ÉÊñØÂ°î', 'ÂüÉÊñáÊñØ', 'ËØ∫Èáå', 'Ëø™Á±≥ÁâπÊ¥õÂ§´', 'Ë•øË•øÂ∏ïÊñØ', 'ÈΩêÈΩêÂ∏ïÊñØ', 'Âç¢Â∏ÉÂàóÂ§´', 'Âç°ÊãâÈááÂ§´', 'Âç°ÊÅ∞ËØ∫Â§´', 'ÂìàÊÅ∞ËØ∫Â§´', 'Ê¢ÖÂæ∑Èü¶Êù∞Â§´', 'Á¶èÈõ∑Ëø™Âä†ÊñØ', 'ÁΩóÁ∫≥Âæ∑ËåÉË•ø', 'Á±≥Ê≠áÂ∞îÂç°Â§´', 'ÈòøËØ∫Âæ∑Á¥¢', 'ÂºóÊúóË•øÊñØÊÅ©', 'ÊâòÈ©¨ÊñØËØ∫', '‰∫®Âæ∑ÈáåÂÖãËé´', 'Êú¨Êù∞ÊòéËø™', 'ÂÆâ‰∏úÂ∞ºÊÅ©', 'È©¨Â°ûÂ∞îËäí', 'ÁöÆÂüÉÂ∞îË•ø', 'ÈõÖÂÖãÂ∏É‰Ω©', 'Á∫™Â∞ßÂßÜÂßÜ', 'Ë∑ØÊòìÊñØÊãâ', 'Áà±Âæ∑ÂçéÂ§öÁ∫≥', 'Ëé´ÈáåÊñØÂ∞î', 'ÈòøÂ∞îË¥ùÊâòÁª¥', 'Ëµ´Â∞îÊõºÂ∞î', 'È≤ÅËø™Ê†ºÊÅ©', 'Ê†ºÂìàÂæ∑Áßë', 'Áì¶Â∞îÁâπÁßë', 'ËÉ°ÊààÂçö', 'Ëø™ÁâπÈ©¨Â∞îÊ£Æ', 'Ëé±Âõ†ÂìàÂæ∑Â∞î', 'ÂêõÁâπÂìà', 'Âç°Â∞îÊµ∑Âõ†Ëå®', 'ÊõºÂºóÈõ∑Âæ∑ÊÅ©', 'Á∫¶ÈòøÂ∏åÂßÜÂ∞î', 'Áª¥Â∞îÁ∫≥ÊÅ©', 'Êµ∑Âõ†Ëå®Â∞î', 'ÂºóÊúóËå®Â∞î', 'Â°ûÂ∑¥ÊñØËíÇÂÆâ', 'È©¨Â∫ìÊñØÊÅ©', 'ÂÖãÈáåÊñØËíÇÂÆâ', 'ÊñØÁâπÂá°ÊÅ©', 'Á∫¶Ê†ºÊÅ©', 'Á±≥Â§èÂüÉÂ∞îÊÅ©', 'ÂÆâÂæ∑ÁÉà‰∫öÊñØ', 'ÂìàÊãâÂ∞îÂæ∑ÊÅ©', 'Ëø™Â∞îÂÖãÊÅ©', 'Âª∂ÊñØÊÅ©', 'ÂÖãÂä≥ÊñØÊÅ©', '‰πåÈü¶ÊÅ©', 'Á∫¶Â∞îÊ†ºÊÅ©', 'ÊâòÈ©¨ÊñØÊÅ©', 'È©¨ËíÇ‰∫öÊñØÊÅ©', '‰ºØÊÅ©ÂìàÂæ∑ÊÅ©', 'Á∫¶Á∫≥ÊñØÊÅ©', 'ÊãâÊñØÁ©ÜÊñØÊÅ©', 'Â••Âà©ÂºóÊÅ©', 'Êâ¨ÊÅ©', 'Â∞ºÂ∞îÊñØÊÅ©', '‰Ω©Âæ∑Ê£ÆÊÅ©', 'ÂÖãÈáåÊñØÊªïÊ£Æ', 'ÂÆâÂæ∑ÊñØÊÅ©', 'ÂüÉÈáåÂÖãÊùæÊÅ©', 'Âç°Â∞îÊ£ÆÊÅ©', 'ÊûóÂæ∑ÊñØÁâπ‰º¶', 'Â••Â∞îÊ£ÆÊÅ©', 'Á∫¶Áø∞ÊùæÊÅ©', '‰Ω©Â∞îÊùæÊÅ©', 'Âè§ÊñØÂ°îÂ§´Êùæ', 'ÂüÉÈáåÂÖãÊùæÊÅ©', 'ÊØîÁ∫¶ÊÅ©ÊùæÊÅ©', 'ÊñØÊñáÊùæÊÅ©', 'ÊãâÊ£ÆÊÅ©', 'Ê±âÊ£ÆÊÅ©', 'Ëé´ÊªïÊ£ÆÊÅ©', 'Âª∂Ê£ÆÊÅ©', 'ÂÖãÈáåÊñØÊâòÂºó', 'Ëè≤Âà©ÊôÆÊÅ©', 'È©¨ÂÖãË•øÁ±≥ÂÖ∞', 'Âç¢Âç°ÊñØÊÅ©', 'Ë•øËíôÊÅ©', '‰øùÁΩóÊÅ©', 'Êâ¨ÊÅ©', 'Ê≥ΩÊõºÊÅ©', 'ÈúçÂ§´ÊõºÊÅ©', 'ÁßëÁì¶Â•áÊÅ©', 'Ë•øÂ•áÊÅ©', 'Ë¥π‰º¶Ëå®ÊÅ©', '‰πÖÂ∞îÂêâÊÅ©', 'ÁªçÊ¥õ‰ºäÊÅ©', 'ÂçöÊ¥õÂ∞ºÊÅ©', 'Á∫≥ÂêâÊÅ©', 'Ëµ´Ê†ºÊùúÊñØÊÅ©', 'Ëê®ÂçöÊÅ©', 'ÂÖãËé±Âõ†ÊÅ©', 'ËàíÂ∞îËå®ÊÅ©', 'ËøàÂ∞îÊñØÊÅ©', 'ÊñΩËÄêÂæ∑ÊÅ©', 'Èü¶Ê†ºÁ∫≥ÊÅ©', 'ÂìàÊÅ©ÊÅ©', 'Ëè≤ËàçÂ∞îÊÅ©', 'Èü¶‰ºØÊÅ©', 'È≤çÂ∞îÊÅ©', 'Á±≥ÂãíÊÅ©', 'ÊñΩÂØÜÁâπÊÅ©', 'ÈúçÂ§´ÊõºÊÅ©', 'ÁßëËµ´ÊÅ©', 'ÈΩêÈªòÂ∞îÊõº', 'ÊÅ©Ê†ºÂ∞îÂìàÁâπ', 'ÈáåÂ∏åÁâπÊÅ©', 'ËàçË¥πÂ∞îÊÅ©', 'Áì¶Ê†ºÁ∫≥ÊÅ©', 'ËØ∫‰ºäÊõºÊÅ©', '‰Ω©ÁâπÊ£ÆÊÅ©', 'Ê±âÊ£ÆÊÅ©', 'Âª∂Ê£ÆÊÅ©', 'Â∞ºÂ∞îÊ£ÆÊÅ©', 'ÂÆâÂæ∑Ê£ÆÊÅ©', '‰ºØÊ†ºÊñØÁâπ‰º¶', 'ÊûóÂæ∑‰ºØÊ†º', 'Âç°Â∞îÊùæÊÅ©', 'Â••Â∞îÊùæÊÅ©', 'ÂΩºÂæóÊùæÊÅ©', 'ÊñØÊñáÊùæÊÅ©', 'Á∫¶Áø∞ÊùæÊÅ©', 'ÊãâÂ∞îÊ£ÆÊÅ©', '‰Ω©Â∞îÊùæÊÅ©', 'ÂüÉÈáåÂÖãÊùæÊÅ©', '‰º¶Âæ∑ÊñØÁâπ‰º¶', 'Âè§ÊñØÂ°îÂ§´Êùæ', 'ÈòøÂÖãÂ°ûÂ∞îÊùæ', 'ÊØîÁ∫¶ÊÅ©ÊùæÊÅ©', 'Â∞ºÊñØÁâπ‰º¶Âæ∑', 'ÈúçÂ∞îÂßÜÊñØÁâπ', 'Â∏ÉÊãâËµ´ÁâπÊ£Æ', '‰ºäËê®ÂÖãÊùæÊÅ©', 'ÈõÖÂêÑÂ∏ÉÊùæ', 'ÊûóÂæ∑Â•éÊñØÁâπ', 'ÊñØÊñáÊùæÊÅ©', '‰Ω©Âæ∑Ê£ÆÊÅ©', 'ÂÖãÈáåÊñØÊªïÊ£Æ', 'ÊãâÊñØÁ©ÜÊ£Æ', 'Ê±âÊ£ÆÊÅ©', 'Ëé´ÊªïÊ£ÆÊÅ©', 'ÂÖãÂä™Ê£ÆÊÅ©', 'ÂΩºÂæóÊ£ÆÊÅ©', 'Âª∂Ê£ÆÊÅ©', 'ÂÆâÂæ∑Ê£ÆÊÅ©', 'Á¥¢‰º¶Ê£ÆÊÅ©', 'ÈõÖÂêÑÂ∏ÉÊ£Æ', 'ÂÖãÈáåÊñØËíÇÂÆâÊ£Æ', 'ÂºóÈõ∑Âæ∑ÈáåÂÖã', 'Â®ÅÂªâÂßÜÊñØÂü∫', '‰∫öÂéÜÂ±±Â§ßÁΩó', 'Âæ∑Á±≥ÁâπÈáåËÄ∂Â§´', 'Ë∞¢Â∞îÁõñËÄ∂Áª¥', 'ÂºóÊãâÂü∫Á±≥Â∞î', 'Â∞ºÂè§ÊãâËÄ∂Áª¥', 'ÂÆâÂæ∑ÁÉàËÄ∂Áª¥', '‰ºä‰∏áËØ∫Áª¥Â•á', 'ÂΩºÂæóÁΩóÁª¥Â•á', 'Â∏ïÂ§´Ê¥õÁª¥Â•á', 'Áì¶Ë•øÈáåËÄ∂Áª¥', 'ÈòøÂàóÂÖãË∞¢ËÄ∂', 'È©¨ÂÖãË•øËé´Áª¥Â•á', 'Âæ∑Á±≥ÁâπÈáåËÄ∂', 'Â∫∑ÊñØÂù¶‰∏ÅËØ∫', 'Â••ÂàóÊ†ºÁª¥Â•á', 'Âè∂Â§´Ê†πÂ∞ºËÄ∂', 'Ë∞¢Â∞îÁõñËÄ∂Áª¥', '‰ºäÊààÂ∞îÁª¥Â•á', 'È≤çÈáåÁ¥¢Áª¥Â•á', 'Ê†ºÈáåÊààÈáåËÄ∂', 'Â∞ºÂü∫Á¶èÁΩóÁª¥', 'È©¨Â∞îÁßëÁª¥Â•á', 'ÊñØÂù¶ÁßëÁª¥Â•á', '‰Ω©ÁâπÁΩóÁª¥Â•á', 'Á∫¶Áª¥Â•áÂ∞ºÁßë', 'ÁßëÁì¶ÂàáÁª¥Â•á', '‰ºä‰∏áËØ∫Áª¥Â•á', 'Ê≥¢Ê≥¢Áª¥Â•áÁ±≥', 'ÂΩºÂæóÁΩóÂ§´ÊñØ', 'Êâ¨Â∫ìÊ¥õÂ§´ÊñØ', 'Âà´Â∞îÊ¥•ÊñØ', 'Âç°Â∞îÂÆÅÊñØ', 'ÊñØÁâπÂä≥È©¨', 'ÊâéÈúçÊãâÊÅ©', 'ÁßëÁΩóÂªñÂ§´ÊñØ', 'Ë∞¢ËãóËØ∫Â§´ÊñØ', 'Ê≤É‰ºäËØ∫Â§´ÊñØ', 'ÂΩºÂæóÁΩóÂ§´ÊñØ', 'ÊãâËÑ±Áª¥Êâ¨ÊñØ', 'Á´ãÈô∂ÂÆõÊñØ', 'Êâ¨Â∫ìÊñØÂç°ÊñØ', 'Âç°Áì¶Âà©ÊñØ', 'ÊñØÂ°îÂ°ûÁª¥Â•á', 'Âè§ÈáåËÄ∂Â§´ÊñØ', 'Â∏ÉÁΩóÂ§´ÊñØÂç°ÊñØ', 'Êâ¨Â∫ìÊñØÂç°ÊñØ', 'È©¨‰∏òÂà©ÊñØ', 'Âç°ÊôÆËãèÂç°ÊñØ', 'Á∫≥Áª¥Ëå®Âç°ÊñØ', 'Ê†ºÈáåÈ≤çÊñØÂç°ÊñØ', 'Êâ¨ËÄÉÊñØÂç°ÊñØ', 'Áª¥ÁâπÂ∫ìÁ∫≥ÊñØ', 'ÈòøËææÂßÜÂ∫ìÊñØ', 'ÊñØÂù¶ÂÖãÁª¥‰∏ò', 'ÈΩêÂ••Â°ûÊñØÂ∫ì', 'Ê≥¢‰Ω©ÊñØÂ∫ì', 'Êâ¨Â∫ìÊ¥õÂ§´', 'Ëø™Á±≥ÁâπÈáåËÄ∂', 'Â∫∑ÊñØÂù¶‰∏Å', '‰πîÊ≤ª‰πåÂÆâ', 'Â∏ïÂ∏ïÂ§öÊôÆÊ¥õ', 'ÊñØÂ°îÂ§´ÁΩóÊñØ', 'Â∞ºÁßëÊãâÊ¨ß', 'ÂÆâÂæ∑ÁÉà‰∫öÊñØ', 'Â∏ïÂ∏ïÂ∫∑ÊñØÂù¶', 'Ëø™Á±≥ÁâπÈáåÊ¨ß', '‰πîÊ≤ª‰∫öÂ≠£ÊñØ', 'Â∏ïÊΩòÂæ∑ÈáåÊ¨ß', 'Âç°ÂÖãÊãâÈ©¨Á∫≥', 'ÊñØÁöÆÁΩóÊñØ', '‰ºäÂÆâÂ∞ºËø™ÊñØ', 'Â∏ïÂ∏ïÂ§öÊôÆÊ¥õÊñØ', 'È©¨Â§´ÁΩó‰ºäÂÆâ', 'Â∫∑ÊñØÂù¶‰∏ÅÂ∞º', 'Áì¶Ë•øÊãâÁßëÊñØ', 'ÂΩºÂæóÁΩóÊôÆÊ¥õÊñØ', 'Â∞ºÂè§Êãâ‰πå', 'ÂÆâÊù∞Ê¥õÊôÆÊ¥õÊñØ', 'Â≠£Á±≥ÁâπÊ¥õÊôÆ', '‰∫öÂéÜÂ±±Âæ∑ÁΩóÊôÆ', 'Á¥¢ÂÖãÊãâËíÇÊñØ', 'Êâ¨Á∫≥ÁßëÊôÆÊ¥õÊñØ', 'Êü•ÊãâÂÖ∞ÂçöÊñØ', 'Á¶èÈõ∑Ëø™ÈáåÊòÇ', 'ÁΩóÁ∫≥Âæ∑Á¥¢', 'Á±≥Ê≠áÂ∞îËé´', 'ÈòøËØ∫Âæ∑ÊÅ©', 'ÂºóÊúóË•øÊñØÂ∞î', 'ÊâòÈ©¨ÊñØÂ∞î', '‰∫®Âæ∑ÈáåÂÖãÊÅ©', 'Êú¨Êù∞ÊòéÂ∞î', 'ÂÆâ‰∏úÂ∞ºÊÅ©', 'È©¨Â°ûÂ∞îÊÅ©', 'ÁöÆÂüÉÂ∞îÊÅ©', 'ÈõÖÂÖãÂ∏ÉÊÅ©', 'Á∫™Â∞ßÂßÜÊÅ©', 'Ë∑ØÊòìÊñØÊãâ', 'Áà±Âæ∑ÂçéÂ§öÁ∫≥', 'Ëé´ÈáåÊñØÂ∞î', 'ÈòøÂ∞îË¥ùÊâòÁª¥', 'Ëµ´Â∞îÊõºÂ∞î', 'È≤ÅËø™Ê†ºÊÅ©', 'Ê†ºÂìàÂæ∑Áßë', 'Áì¶Â∞îÁâπÁßë', 'ËÉ°ÊààÂçö', 'Ëø™ÁâπÈ©¨Â∞îÊ£Æ', 'Ëé±Âõ†ÂìàÂæ∑Â∞î', 'ÂêõÁâπÂìà', 'Âç°Â∞îÊµ∑Âõ†Ëå®', 'ÊõºÂºóÈõ∑Âæ∑ÊÅ©', 'Á∫¶ÈòøÂ∏åÂßÜÂ∞î', 'Áª¥Â∞îÁ∫≥ÊÅ©', 'Êµ∑Âõ†Ëå®Â∞î', 'ÂºóÊúóËå®Â∞î', 'Â°ûÂ∑¥ÊñØËíÇÂÆâ', 'È©¨Â∫ìÊñØÊÅ©', 'ÂÖãÈáåÊñØËíÇÂÆâ', 'ÊñØÁâπÂá°ÊÅ©', 'Á∫¶Ê†ºÊÅ©', 'Á±≥Â§èÂüÉÂ∞îÊÅ©', 'ÂÆâÂæ∑ÁÉà‰∫öÊñØ', 'ÂìàÊãâÂ∞îÂæ∑ÊÅ©', 'Ëø™Â∞îÂÖãÊÅ©', 'Âª∂ÊñØÊÅ©', 'ÂÖãÂä≥ÊñØÊÅ©', '‰πåÈü¶ÊÅ©', 'Á∫¶Â∞îÊ†ºÊÅ©', 'ÊâòÈ©¨ÊñØÊÅ©', 'È©¨ËíÇ‰∫öÊñØÊÅ©', '‰ºØÊÅ©ÂìàÂæ∑ÊÅ©', 'Á∫¶Á∫≥ÊñØÊÅ©', 'ÊãâÊñØÁ©ÜÊñØÊÅ©', 'Â••Âà©ÂºóÊÅ©', 'Êâ¨ÊÅ©', 'Â∞ºÂ∞îÊñØÊÅ©', '‰Ω©Âæ∑Ê£ÆÊÅ©', 'ÂÖãÈáåÊñØÊªïÊ£Æ', 'ÂÆâÂæ∑ÊñØÊÅ©', 'ÂüÉÈáåÂÖãÊùæÊÅ©', 'Âç°Â∞îÊ£ÆÊÅ©', 'ÊûóÂæ∑ÊñØÁâπ‰º¶', 'Â••Â∞îÊ£ÆÊÅ©', 'Á∫¶Áø∞ÊùæÊÅ©', '‰Ω©Â∞îÊùæÊÅ©', 'Âè§ÊñØÂ°îÂ§´Êùæ', 'ÂüÉÈáåÂÖãÊùæÊÅ©', 'ÊØîÁ∫¶ÊÅ©ÊùæÊÅ©', 'ÊñØÊñáÊùæÊÅ©', 'ÊãâÊ£ÆÊÅ©', 'Ê±âÊ£ÆÊÅ©', 'Ëé´ÊªïÊ£ÆÊÅ©', 'Âª∂Ê£ÆÊÅ©'
  ];
  
  // Âä†ËΩΩÂ∑≤‰ΩøÁî®ÁöÑÂêçÂ≠ó
  function loadUsedNames() {
    try {
      const raw = localStorage.getItem(USED_NAMES_KEY);
      if (!raw) return new Set();
      const names = JSON.parse(raw);
      return new Set(names);
    } catch (e) {
      console.error('Âä†ËΩΩÂ∑≤‰ΩøÁî®ÂêçÂ≠óÂ§±Ë¥•:', e);
      return new Set();
    }
  }
  
  // ‰øùÂ≠òÂ∑≤‰ΩøÁî®ÁöÑÂêçÂ≠ó
  function saveUsedNames(usedNames) {
    try {
      localStorage.setItem(USED_NAMES_KEY, JSON.stringify(Array.from(usedNames)));
    } catch (e) {
      console.error('‰øùÂ≠òÂ∑≤‰ΩøÁî®ÂêçÂ≠óÂ§±Ë¥•:', e);
    }
  }
  
  // Ëé∑ÂèñÈöèÊú∫Êú™‰ΩøÁî®ÁöÑÂêçÂ≠ó
  function getRandomUnusedName() {
    const usedNames = loadUsedNames();
    const availableNames = PIGEON_NAMES.filter(name => !usedNames.has(name));
    if (availableNames.length === 0) {
      return null; // ÊâÄÊúâÂêçÂ≠óÈÉΩÂ∑≤‰ΩøÁî®
    }
    const randomIndex = Math.floor(Math.random() * availableNames.length);
    const selectedName = availableNames[randomIndex];
    usedNames.add(selectedName);
    saveUsedNames(usedNames);
    return selectedName;
  }
  
  // Âä†ËΩΩÈ∏Ω‰∏ª-Âú∞Âå∫ÈÖçÂØπ
  function loadOwnerRegionPairs() {
    try {
      const raw = localStorage.getItem(OWNER_REGION_PAIRS_KEY);
      if (!raw) return [];
      return JSON.parse(raw);
    } catch (e) {
      console.error('Âä†ËΩΩÈ∏Ω‰∏ª-Âú∞Âå∫ÈÖçÂØπÂ§±Ë¥•:', e);
      return [];
    }
  }
  
  // ‰øùÂ≠òÈ∏Ω‰∏ª-Âú∞Âå∫ÈÖçÂØπ
  function saveOwnerRegionPairs(pairs) {
    try {
      localStorage.setItem(OWNER_REGION_PAIRS_KEY, JSON.stringify(pairs));
    } catch (e) {
      console.error('‰øùÂ≠òÈ∏Ω‰∏ª-Âú∞Âå∫ÈÖçÂØπÂ§±Ë¥•:', e);
    }
  }
  
  // Ê∑ªÂä†Êñ∞ÁöÑÈ∏Ω‰∏ª-Âú∞Âå∫ÈÖçÂØπÔºàÂ¶ÇÊûúÂá∫Áé∞‰∏§Ê¨°Âàô‰øùÂ≠òÔºâ
  function addOwnerRegionPair(owner, region) {
    if (!owner || !region) return;
    const pairs = loadOwnerRegionPairs();
    const pairKey = `${owner}|${region}`;
    const existingPair = pairs.find(p => p.key === pairKey);
    if (existingPair) {
      existingPair.count = (existingPair.count || 1) + 1;
      if (existingPair.count >= 2 && !existingPair.saved) {
        existingPair.saved = true;
        saveOwnerRegionPairs(pairs);
      }
    } else {
      pairs.push({ key: pairKey, owner, region, count: 1, saved: false });
      saveOwnerRegionPairs(pairs);
    }
  }

  // ‰∫ëÁ´ØÊï∞ÊçÆÂêåÊ≠•ÈÖçÁΩÆ - ‰ΩøÁî®Êú¨Âú∞ÂêéÁ´ØAPI
  let isCloudSyncEnabled = true; // ÊòØÂê¶ÂêØÁî®‰∫ëÁ´ØÂêåÊ≠•
  let authToken = null; // Áî®Êà∑ËÆ§ËØÅtoken

  // Ëé∑ÂèñAPIÈÖçÁΩÆ
  function getBackendApiUrl() {
    const apiConfig = getApiConfig();
    // Â¶ÇÊûúÈÖçÁΩÆÁöÑURLÂåÖÂê´localhostÔºåËá™Âä®‰ΩøÁî®ÂΩìÂâçÂüüÂêç
    if (apiConfig.apiUrl && apiConfig.apiUrl.includes('localhost')) {
      const currentOrigin = window.location.origin;
      return currentOrigin + '/api';
    }
    return apiConfig.apiUrl || (window.location.origin + '/api');
  }

  // Êèê‰∫§ÊÑèËßÅ‰∏éÂèçÈ¶à
  async function submitUserFeedback({ content, contact, page, source }) {
    try {
      const apiUrl = getBackendApiUrl();
      const token = getAuthToken();
      const headers = {
        'Content-Type': 'application/json'
      };
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }

      const response = await fetch(`${apiUrl}/feedback`, {
        method: 'POST',
        headers,
        body: JSON.stringify({
          content,
          contact,
          page,
          source
        })
      });

      const result = await response.json();
      if (!response.ok || !result.success) {
        throw new Error(result.error || 'Êèê‰∫§Â§±Ë¥•');
      }
      return true;
    } catch (error) {
      console.error('Êèê‰∫§ÂèçÈ¶àÂ§±Ë¥•:', error);
      throw error;
    }
  }

  // Ëé∑ÂèñËÆ§ËØÅtoken
  function getAuthToken() {
    if (!authToken) {
      authToken = localStorage.getItem('auth_token');
    }
    return authToken;
  }

  // ËÆæÁΩÆËÆ§ËØÅtoken
  function setAuthToken(token) {
    authToken = token;
    if (token) {
      localStorage.setItem('auth_token', token);
    } else {
      localStorage.removeItem('auth_token');
    }
  }

  // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÁôªÂΩï
  function isUserLoggedIn() {
    return !!getAuthToken();
  }

  // ËÆæÂ§áÊ†áËÆ∞ÔºàÁî®‰∫éÂêéÂè∞ËØÜÂà´‰∏çÂêåËÆæÂ§áÔºâ
  const DEVICE_ID_KEY = 'pigeon_device_id';

  function getOrCreateDeviceId() {
    try {
      let id = localStorage.getItem(DEVICE_ID_KEY);
      if (!id) {
        if (window.crypto && window.crypto.randomUUID) {
          id = window.crypto.randomUUID();
        } else {
          id = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        localStorage.setItem(DEVICE_ID_KEY, id);
      }
      return id;
    } catch (e) {
      console.warn('ÁîüÊàêËÆæÂ§áIDÂ§±Ë¥•:', e);
      return null;
    }
  }

  // ‰∫ëÁ´Ø‰øùÂ≠òÊï∞ÊçÆÔºà‰ΩøÁî®ÂêéÁ´ØAPIÔºâ
  async function saveToCloud(key, data) {
    if (!isCloudSyncEnabled) return false;
    
    const token = getAuthToken();
    if (!token) {
      console.warn('‚ö†Ô∏è Áî®Êà∑Êú™ÁôªÂΩïÔºåÊó†Ê≥ïÂêåÊ≠•Âà∞‰∫ëÁ´Ø');
      return false;
    }

    try {
      const apiUrl = getBackendApiUrl();
      const response = await fetch(`${apiUrl}/user/data/pigeons`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          pigeons: data
        })
      });
      
      const result = await response.json();
      if (result.success) {
        console.log('‚úÖ Êï∞ÊçÆÂ∑≤ÂêåÊ≠•Âà∞‰∫ëÁ´Ø');
        return true;
      } else {
        console.warn('‚ö†Ô∏è ‰∫ëÁ´Ø‰øùÂ≠òÂ§±Ë¥•:', result.error);
        // Â¶ÇÊûútokenÂ§±ÊïàÔºåÊ∏ÖÈô§token
        if (result.error && result.error.includes('token')) {
          setAuthToken(null);
        }
        return false;
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è ‰∫ëÁ´Ø‰øùÂ≠òÂ§±Ë¥•Ôºå‰ΩøÁî®Êú¨Âú∞Â≠òÂÇ®:', error.message);
      // ‰∫ëÁ´ØÂ§±Ë¥•‰∏çÂΩ±ÂìçÊú¨Âú∞‰øùÂ≠ò
      return false;
    }
  }

  // Ëá™Âä®ÂêåÊ≠•ÂÆåÊï¥Áî®Êà∑Êï∞ÊçÆÂà∞ÂêéÂè∞/‰∫ëÁ´ØÔºàPC Á´ØÔºâ
  let lastUserDataSyncAt = 0;

  async function autoSyncUserData(options = {}) {
    const { force = false } = options;
    try {
      if (!isCloudSyncEnabled) return;

      const token = getAuthToken();
      if (!token) return;

      const now = Date.now();
      if (!force && now - lastUserDataSyncAt < 60000) {
        return;
      }

      const apiUrl = getBackendApiUrl();
      const deviceId = getOrCreateDeviceId();
      const deviceInfo = {
        userAgent: navigator.userAgent || '',
        platform: navigator.platform || ''
      };

      const body = {
        pigeons,
        races,
        healthRecords,
        trainingRecords,
        pairings,
        qualificationRecords,
        deviceId,
        deviceInfo
      };

      const resp = await fetch(apiUrl + '/user/data/full', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(body)
      });

      if (resp.ok) {
        lastUserDataSyncAt = now;
      } else {
        console.warn('Ëá™Âä®ÂêåÊ≠•ÂÆåÊï¥Áî®Êà∑Êï∞ÊçÆÂ§±Ë¥•:', resp.status);
      }
    } catch (e) {
      console.warn('Ëá™Âä®ÂêåÊ≠•ÂÆåÊï¥Áî®Êà∑Êï∞ÊçÆÂºÇÂ∏∏:', e);
    }
  }

  // ÂΩìÊú¨Âú∞Êï∞ÊçÆÁº∫Â§±Êó∂Ôºå‰ªéÂêéÂè∞/‰∫ëÁ´ØÊÅ¢Â§ç
  async function restoreUserDataIfMissing() {
    try {
      if (!isCloudSyncEnabled) return;

      const token = getAuthToken();
      if (!token) return;

      const hasLocalPigeons = !!localStorage.getItem(STORAGE_KEY);

      if (hasLocalPigeons) {
        return;
      }

      const apiUrl = getBackendApiUrl();
      const resp = await fetch(apiUrl + '/user/data/full', {
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + token
        }
      });

      if (!resp.ok) {
        console.warn('‰ªéÂêéÂè∞Ëé∑ÂèñÂÆåÊï¥Áî®Êà∑Êï∞ÊçÆÂ§±Ë¥•:', resp.status);
        return;
      }

      const result = await resp.json();
      if (!result.success || !result.data) return;

      const data = result.data;

      if (Array.isArray(data.pigeons) && data.pigeons.length > 0) {
        pigeons = data.pigeons;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(pigeons));
      }
      if (Array.isArray(data.races) && data.races.length > 0) {
        races = data.races;
      }
      if (Array.isArray(data.healthRecords) && data.healthRecords.length > 0) {
        healthRecords.length = 0;
        healthRecords.push(...data.healthRecords);
        localStorage.setItem(HEALTH_RECORDS_KEY, JSON.stringify(healthRecords));
      }
      if (Array.isArray(data.trainingRecords) && data.trainingRecords.length > 0) {
        const raw = JSON.stringify(data.trainingRecords);
        localStorage.setItem(TRAINING_STORAGE_KEY, raw);
      }
      if (Array.isArray(data.pairings) && data.pairings.length > 0) {
        pairings.length = 0;
        pairings.push(...data.pairings);
        localStorage.setItem(PAIRINGS_STORAGE_KEY, JSON.stringify(pairings));
      }
      if (Array.isArray(data.qualificationRecords) && data.qualificationRecords.length > 0) {
        qualificationRecords.length = 0;
        qualificationRecords.push(...data.qualificationRecords);
        localStorage.setItem(QUALIFICATION_STORAGE_KEY, JSON.stringify(qualificationRecords));
      }

      console.log('‚úÖ PCÁ´ØÂ∑≤‰ªéÂêéÂè∞ÊÅ¢Â§çÂÆåÊï¥Áî®Êà∑Êï∞ÊçÆ');

      try {
        renderPigeonList();
        renderStats();
      } catch (e) {
        console.warn('ÊÅ¢Â§çÂêéÂà∑Êñ∞ËßÜÂõæÊó∂Âá∫Èîô:', e);
      }
    } catch (e) {
      console.warn('Â∞ùËØï‰ªéÂêéÂè∞ÊÅ¢Â§çÂÆåÊï¥Áî®Êà∑Êï∞ÊçÆÂ§±Ë¥•:', e);
    }
  }

  // ‰ªé‰∫ëÁ´ØÂä†ËΩΩÊï∞ÊçÆÔºà‰ΩøÁî®ÂêéÁ´ØAPIÔºâ
  async function loadFromCloud(key) {
    if (!isCloudSyncEnabled) return null;
    
    const token = getAuthToken();
    if (!token) {
      console.warn('‚ö†Ô∏è Áî®Êà∑Êú™ÁôªÂΩïÔºåÊó†Ê≥ï‰ªé‰∫ëÁ´ØÂä†ËΩΩÊï∞ÊçÆ');
      return null;
    }

    try {
      const apiUrl = getBackendApiUrl();
      const response = await fetch(`${apiUrl}/user/data/pigeons`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      const result = await response.json();
      if (result.success && result.data) {
        console.log('‚úÖ Â∑≤‰ªé‰∫ëÁ´ØÂä†ËΩΩÊï∞ÊçÆ');
        return result.data;
      }
      return null;
    } catch (error) {
      console.warn('‚ö†Ô∏è ‰∫ëÁ´ØÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®Êú¨Âú∞Êï∞ÊçÆ:', error.message);
      return null;
    }
  }

  // Âä†ËΩΩÊï∞ÊçÆÔºà‰ºòÂÖà‰ªé‰∫ëÁ´ØÔºåÂ§±Ë¥•Âàô‰ΩøÁî®Êú¨Âú∞Ôºâ
  async function loadFromStorage() {
    try {
      // Â¶ÇÊûúÁî®Êà∑Â∑≤ÁôªÂΩïÔºå‰ºòÂÖà‰ªé‰∫ëÁ´ØÂä†ËΩΩ
      let data = null;
      if (isUserLoggedIn() && isCloudSyncEnabled) {
        data = await loadFromCloud('pigeons');
        // Â¶ÇÊûú‰ªé‰∫ëÁ´ØÂä†ËΩΩÊàêÂäüÔºåÂêåÊ≠•Âà∞Êú¨Âú∞
        if (data && Array.isArray(data) && data.length > 0) {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          console.log('‚úÖ Â∑≤‰ªé‰∫ëÁ´ØÂêåÊ≠•Êï∞ÊçÆÂà∞Êú¨Âú∞');
        }
      }
      
      // Â¶ÇÊûú‰∫ëÁ´ØÊ≤°ÊúâÊï∞ÊçÆÔºå‰ΩøÁî®Êú¨Âú∞Êï∞ÊçÆ
      if (!data || !Array.isArray(data) || data.length === 0) {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          data = JSON.parse(raw);
        }
      }
      
      if (data && Array.isArray(data)) {
        pigeons = data;
        // Ê£ÄÊü•ÊâÄÊúâÈ∏ΩÂ≠êÊòØÂê¶ÊúâÂêçÂ≠óÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôËá™Âä®ÂàÜÈÖç
        let hasChanges = false;
        pigeons.forEach(p => {
          if (!p.name || p.name.trim() === '') {
            const newName = getRandomUnusedName();
            if (newName) {
              p.name = newName;
              hasChanges = true;
            }
          } else {
            // Â¶ÇÊûúÂ∑≤ÊúâÂêçÂ≠ó‰∏îÂú®ÂàóË°®‰∏≠ÔºåÊ†áËÆ∞‰∏∫Â∑≤‰ΩøÁî®
            const usedNames = loadUsedNames();
            if (PIGEON_NAMES.includes(p.name) && !usedNames.has(p.name)) {
              usedNames.add(p.name);
              saveUsedNames(usedNames);
            }
          }
        });
        if (hasChanges) {
          await saveToStorage();
        }
        
        // Â¶ÇÊûúÁî®Êà∑Â∑≤ÁôªÂΩï‰∏îÊúâÊú¨Âú∞Êï∞ÊçÆÔºåÂêåÊ≠•Âà∞‰∫ëÁ´Ø
        if (isUserLoggedIn() && pigeons.length > 0) {
          setTimeout(() => {
            saveToCloud('pigeons', pigeons).catch(err => {
              console.warn('Ëá™Âä®ÂêåÊ≠•Âà∞‰∫ëÁ´ØÂ§±Ë¥•:', err);
            });
          }, 1000);
        }
      }
    } catch (e) {
      console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', e);
    }
  }

  // ‰øùÂ≠òÊï∞ÊçÆÔºàÂêåÊó∂‰øùÂ≠òÂà∞Êú¨Âú∞Âíå‰∫ëÁ´ØÔºâ
  async function saveToStorage() {
    try {
      // ÂÖà‰øùÂ≠òÂà∞Êú¨Âú∞
      localStorage.setItem(STORAGE_KEY, JSON.stringify(pigeons));
      
      // Â¶ÇÊûúÁî®Êà∑Â∑≤ÁôªÂΩïÔºåÂêåÊó∂‰øùÂ≠òÂà∞‰∫ëÁ´ØÔºàÂºÇÊ≠•Ôºå‰∏çÈòªÂ°ûÔºâ
      if (isUserLoggedIn() && isCloudSyncEnabled && pigeons.length > 0) {
        saveToCloud('pigeons', pigeons).catch(err => {
          console.warn('‰∫ëÁ´Ø‰øùÂ≠òÂ§±Ë¥•:', err);
        });
      }
    } catch (e) {
      console.error('‰øùÂ≠òÊï∞ÊçÆÂ§±Ë¥•:', e);
    }
  }

  // ÈªòËÆ§ÂõæÁâáÔºöÁ´ôÁ´ã‰æßË∫´ÂõæÂíåÁúºÁùõÁâπÂÜôÔºàÁ§∫‰æãÂõæÁâáÔºâ
  // IMG_6540.jpg ÊòØÁ´ôÁ´ã‰æßË∫´ÂõæÔºåIMG_6539.jpg ÊòØÁúºÈÉ®ÁâπÂÜô
  const DEFAULT_BODY_IMG = 'picker/IMG_6540.jpg';
  const DEFAULT_EYE_IMG = 'picker/IMG_6539.jpg';

  function generateId() {
    return 'p_' + Math.random().toString(36).slice(2, 10);
  }

  function getPigeonById(id) {
    return pigeons.find(p => p.id === id);
  }

  function getPigeonByRing(ring) {
    const target = (ring || '').trim();
    if (!target) return null;
    return pigeons.find(p => (p.ring || '').toLowerCase() === target.toLowerCase() && p.alive);
  }

  function getAllPigeonsByRing(ring) {
    const target = (ring || '').trim();
    if (!target) return [];
    return pigeons.filter(p => (p.ring || '').toLowerCase() === target.toLowerCase());
  }

  function formatDate(d) {
    if (!d) return '';
    return d;
  }

  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // ËßÜÂõæÂàáÊç¢ - ÂåÖÂê´ÊâÄÊúâËßÜÂõæ
  const views = {
    homeView: document.getElementById('homeView'),
    dashboardView: document.getElementById('dashboardView'),
    listView: document.getElementById('listView'),
    createView: document.getElementById('createView'),
    detailView: document.getElementById('detailView'),
    statsView: document.getElementById('statsView'),
    raceView: document.getElementById('raceView'),
    pedigreeView: document.getElementById('pedigreeView'),
    breedingView: document.getElementById('breedingView'),
    healthView: document.getElementById('healthView'),
    analysisView: document.getElementById('analysisView'),
    trainingView: document.getElementById('trainingView'),
    qualificationView: document.getElementById('qualificationView'),
  };
  
  // È™åËØÅÊâÄÊúâËßÜÂõæÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
  console.log('=== ËßÜÂõæÂÖÉÁ¥†Ê£ÄÊü• ===');
  Object.keys(views).forEach(key => {
    if (views[key]) {
      console.log(`‚úì ${key}: Â≠òÂú®`);
      // ÈªòËÆ§ÈöêËóèÊâÄÊúâËßÜÂõæÔºåÈô§‰∫ÜhomeView
      if (key !== 'homeView') {
        views[key].style.display = 'none';
      } else {
        // Á°Æ‰øùhomeViewÈªòËÆ§ÊòæÁ§∫
        views[key].style.display = '';
      }
    } else {
      console.error(`‚úó ${key}: ‰∏çÂ≠òÂú®ÔºÅ`);
    }
  });
  
  // Á°Æ‰øùÈ¶ñÈ°µÈªòËÆ§ÊòæÁ§∫
  if (views.homeView) {
    views.homeView.style.display = '';
  }
  
  const navButtons = document.querySelectorAll('header nav button');
  const sidebarItems = document.querySelectorAll('.sidebar-item');

  function switchView(name) {
    console.log('ÂàáÊç¢ËßÜÂõæ:', name);
    
    // ÈöêËóèÊâÄÊúâËßÜÂõæ
    Object.keys(views).forEach(k => {
      if (views[k]) {
        views[k].style.display = (k === name) ? '' : 'none';
      }
    });
    
    // Êõ¥Êñ∞ÂØºËà™ÊåâÈíÆÁä∂ÊÄÅÔºàÈáçÊñ∞Êü•ËØ¢‰ª•Á°Æ‰øùËé∑ÂèñÊúÄÊñ∞ÂÖÉÁ¥†Ôºâ
    const currentNavButtons = document.querySelectorAll('header nav button');
    currentNavButtons.forEach(btn => {
      if (btn.dataset.view === name) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
    
    // Êõ¥Êñ∞‰æßËæπÊ†èËèúÂçïÈ°πÁä∂ÊÄÅÔºàÈáçÊñ∞Êü•ËØ¢‰ª•Á°Æ‰øùËé∑ÂèñÊúÄÊñ∞ÂÖÉÁ¥†Ôºâ
    const currentSidebarItems = document.querySelectorAll('.sidebar-item');
    currentSidebarItems.forEach(item => {
      if (item.dataset.view === name) {
        item.classList.add('active');
      } else {
        item.classList.remove('active');
      }
    });
    
    // Ê†πÊçÆËßÜÂõæÊâßË°åÁâπÂÆöÊìç‰Ωú
    switch(name) {
      case 'homeView':
        // Âà∑Êñ∞È¶ñÈ°µÊï∞ÊçÆ
        if (typeof refreshHomeView === 'function') {
          refreshHomeView();
        }
        break;
      case 'dashboardView':
        refreshDashboard();
        break;
      case 'listView':
        refreshList();
        break;
      case 'pedigreeView':
        if (typeof refreshPedigreeView === 'function') {
          refreshPedigreeView();
        }
        break;
      case 'raceView':
        if (typeof loadRaces === 'function') {
          loadRaces();
          if (typeof syncRacesToPigeons === 'function') syncRacesToPigeons();
          if (typeof renderRaceList === 'function') renderRaceList();
          if (typeof fillStatsPigeonSelect === 'function') fillStatsPigeonSelect();
          if (typeof generateOverallAnalysis === 'function') generateOverallAnalysis();
        }
        break;
      case 'statsView':
        if (typeof renderStatsViewTable === 'function') {
          renderStatsViewTable();
        }
        break;
      case 'breedingView':
        if (typeof fillBreedingSelects === 'function') {
          fillBreedingSelects();
        }
        if (typeof renderPairingHistory === 'function') {
          renderPairingHistory();
        }
        if (typeof updateBreedingAssessment === 'function') {
          updateBreedingAssessment();
        }
        break;
      case 'healthView':
        if (typeof renderHealthOverview === 'function') {
          renderHealthOverview();
        }
        if (typeof renderHealthAlerts === 'function') {
          renderHealthAlerts();
        }
        break;
      case 'analysisView':
        if (typeof runFullAnalysis === 'function') {
          runFullAnalysis();
        }
        break;
    }
  }
  
  // ========================================
  // ÊÄßËÉΩ‰ºòÂåñÔºöÈò≤ÊäñÂíåËäÇÊµÅÂ∑•ÂÖ∑ÂáΩÊï∞
  // ========================================
  
  // Èò≤ÊäñÂ∑•ÂÖ∑ÂáΩÊï∞ÔºàÊèêÂâçÂÆö‰πâÔºå‰æõÂêéÁª≠ÂáΩÊï∞‰ΩøÁî®Ôºâ
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
  
  // ËäÇÊµÅÂ∑•ÂÖ∑ÂáΩÊï∞
  function throttle(func, limit) {
    let inThrottle;
    return function(...args) {
      if (!inThrottle) {
        func.apply(this, args);
        inThrottle = true;
        setTimeout(() => inThrottle = false, limit);
      }
    };
  }
  
  // Dashboard Êï∞ÊçÆÂà∑Êñ∞ÔºàÂéüÂßãÂáΩÊï∞Ôºâ
  const _refreshDashboard = function() {
    const total = pigeons.length;
    const alive = pigeons.filter(p => p.alive).length;
    const dead = pigeons.filter(p => !p.alive).length;
    const raced = pigeons.filter(p => p.races && p.races.length > 0).length;
    const core = pigeons.filter(p => p.isCore).length;
    
    const statTotalEl = document.getElementById('statTotal');
    const statAliveEl = document.getElementById('statAlive');
    const statDeadEl = document.getElementById('statDead');
    const statRacedEl = document.getElementById('statRaced');
    const statCoreEl = document.getElementById('statCore');
    
    if (statTotalEl) statTotalEl.textContent = total;
    if (statAliveEl) statAliveEl.textContent = alive;
    if (statDeadEl) statDeadEl.textContent = dead;
    if (statRacedEl) statRacedEl.textContent = raced;
    if (statCoreEl) statCoreEl.textContent = core;
    
    // ÂêåÊó∂Êõ¥Êñ∞Âπ¥Â∫¶ÁªüËÆ°Ë°®Ê†º
    renderDashboardStats();
  };
  
  // ‰ΩøÁî®Èò≤ÊäñÂåÖË£ÖÂà∑Êñ∞DashboardÂáΩÊï∞Ôºà100msÈò≤ÊäñÔºâ
  const refreshDashboard = debounce(_refreshDashboard, 100);

  // Âπ¥Â∫¶ÁªüËÆ°Ê∏≤Êüì
  const dashboardStatsTableBody = document.getElementById('dashboardStatsTableBody');
  const statsViewTableBody = document.getElementById('statsViewTableBody');

  // ÁîüÊàêÁªüËÆ°Êï∞ÊçÆ
  function getStatsData() {
    const map = {};
    pigeons.forEach(p => {
      const birthYear = p.birth ? String(p.birth).slice(0, 4) : '';
      const deathYear = p.deathDate ? String(p.deathDate).slice(0, 4) : '';

      if (birthYear) {
        if (!map[birthYear]) map[birthYear] = { born: 0, dead: 0, raced: 0, racedSet: new Set() };
        map[birthYear].born += 1;
      }
      if (deathYear) {
        if (!map[deathYear]) map[deathYear] = { born: 0, dead: 0, raced: 0, racedSet: new Set() };
        map[deathYear].dead += 1;
      }
      if (p.races && p.races.length > 0) {
        p.races.forEach(r => {
          const year = r.date ? String(r.date).slice(0, 4) : '';
          if (!year) return;
          if (!map[year]) map[year] = { born: 0, dead: 0, raced: 0, racedSet: new Set() };
          map[year].racedSet.add(p.id);
        });
      }
    });
    return map;
  }

  // Ê∏≤ÊüìDashboard‰∏≠ÁöÑË°®Ê†ºÔºàÂÆåÊï¥Ë°®Ê†ºÔºâ
  function renderDashboardStats() {
    if (!dashboardStatsTableBody) return;
    dashboardStatsTableBody.innerHTML = '';
    
    if (pigeons.length === 0) {
      const emptyDiv = document.createElement('div');
      emptyDiv.style.cssText = 'text-align:center;padding:60px 20px;color:#9ca3af;';
      emptyDiv.innerHTML = '<div style="font-size:48px;margin-bottom:16px;">üìä</div><div style="font-size:15px;">ÊöÇÊó†Êï∞ÊçÆÔºåÂΩïÂÖ•È∏ΩÂ≠êÂêé‰ºöËá™Âä®ÁîüÊàêÁªüËÆ°</div>';
      dashboardStatsTableBody.appendChild(emptyDiv);
      return;
    }

    const map = getStatsData();
    const years = Object.keys(map).sort().reverse();
    
    // ÂàõÂª∫Ë°®Ê†º
    const table = document.createElement('table');
    table.style.cssText = 'width:100%;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.1);';
    
    // ÂàõÂª∫Ë°®Â§¥
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    const headers = ['Âπ¥‰ªΩ', 'Âá∫ÁîüÊï∞Èáè', 'Ê≠ª‰∫°Êï∞Èáè', 'ÊúâÂèÇËµõËÆ∞ÂΩïÁöÑÈ∏ΩÂ≠êÊï∞'];
    headers.forEach((text, index) => {
      const th = document.createElement('th');
      th.textContent = text;
      if (index === 0) th.style.textAlign = 'left';
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // ÂàõÂª∫Ë°®‰Ωì
    const tbody = document.createElement('tbody');
    years.forEach(year => {
      const info = map[year];
      info.raced = info.racedSet.size;
      const tr = document.createElement('tr');
      
      const tdYear = document.createElement('td');
      tdYear.textContent = year;
      tdYear.style.fontWeight = '600';
      tdYear.style.color = '#1f2937';
      tr.appendChild(tdYear);
      
      const tdBorn = document.createElement('td');
      tdBorn.textContent = info.born || '0';
      tdBorn.style.color = '#059669';
      tdBorn.style.fontWeight = '500';
      tr.appendChild(tdBorn);
      
      const tdDead = document.createElement('td');
      tdDead.textContent = info.dead || '0';
      tdDead.style.color = '#4b5563';
      tdDead.style.fontWeight = '500';
      tr.appendChild(tdDead);
      
      const tdRaced = document.createElement('td');
      tdRaced.textContent = info.raced || '0';
      tdRaced.style.color = '#d97706';
      tdRaced.style.fontWeight = '500';
      tr.appendChild(tdRaced);
      
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    dashboardStatsTableBody.appendChild(table);
  }

  // Ê∏≤ÊüìÁªüËÆ°ËßÜÂõæ‰∏≠ÁöÑË°®Ê†ºÔºà‰ªÖË°®‰ΩìÔºâ
  function renderStatsViewTable() {
    if (!statsViewTableBody) return;
    statsViewTableBody.innerHTML = '';
    
    if (pigeons.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 4;
      td.innerHTML = '<span class="muted" style="display:block;text-align:center;padding:40px;">ÊöÇÊó†Êï∞ÊçÆÔºåÂΩïÂÖ•È∏ΩÂ≠êÂêé‰ºöËá™Âä®ÁîüÊàêÁªüËÆ°</span>';
      tr.appendChild(td);
      statsViewTableBody.appendChild(tr);
      return;
    }

    const map = getStatsData();
    const years = Object.keys(map).sort().reverse();
    
    years.forEach(year => {
      const info = map[year];
      info.raced = info.racedSet.size;
      const tr = document.createElement('tr');
      
      const tdYear = document.createElement('td');
      tdYear.textContent = year;
      tdYear.style.fontWeight = '600';
      tr.appendChild(tdYear);
      
      const tdBorn = document.createElement('td');
      tdBorn.textContent = info.born || '0';
      tdBorn.style.color = '#059669';
      tr.appendChild(tdBorn);
      
      const tdDead = document.createElement('td');
      tdDead.textContent = info.dead || '0';
      tdDead.style.color = '#4b5563';
      tr.appendChild(tdDead);
      
      const tdRaced = document.createElement('td');
      tdRaced.textContent = info.raced || '0';
      tdRaced.style.color = '#d97706';
      tr.appendChild(tdRaced);
      
      statsViewTableBody.appendChild(tr);
    });
  }

  // ÂéüÂßãÂà∑Êñ∞ÂáΩÊï∞
  const _refreshStats = function() {
    renderDashboardStats();
    renderStatsViewTable();
  };
  
  // ‰ΩøÁî®Èò≤ÊäñÂåÖË£ÖÂà∑Êñ∞ÂáΩÊï∞Ôºà100msÈò≤ÊäñÔºâ
  const refreshStats = debounce(_refreshStats, 100);

  // ÂàóË°®Ê∏≤Êüì
  const tableBody = document.getElementById('pigeonTableBody');
  const cardsBody = document.getElementById('pigeonCardsBody');
  let currentListView = 'table'; // 'table' Êàñ 'card'

  // Ê∏≤ÊüìÂç°ÁâáËßÜÂõæ
  function renderCardView() {
    if (!cardsBody) return;
    cardsBody.innerHTML = '';
    if (pigeons.length === 0) {
      cardsBody.innerHTML = '<div style="text-align:center;padding:40px;color:#6B7280;">ÊöÇÊó†Êï∞ÊçÆÔºåËØ∑ÂÖàÊñ∞Â¢ûÈ∏ΩÂ≠ê‰ø°ÊÅØ„ÄÇ</div>';
      return;
    }
    pigeons.forEach(p => {
      const card = document.createElement('div');
      card.className = 'pigeon-card';
      
      const father = p.fatherId ? getPigeonById(p.fatherId) : null;
      const mother = p.motherId ? getPigeonById(p.motherId) : null;
      
      // Á°Æ‰øùÂêçÂ≠óÂ≠òÂú®
      const displayName = p.name || p.ring;
      const fatherName = father ? (father.name || father.ring) : '‚Äî';
      const motherName = mother ? (mother.name || mother.ring) : '‚Äî';
      
      card.innerHTML = `
        <div class="pigeon-card-header">
          <div style="flex:1;">
            <div class="pigeon-card-name">${displayName}</div>
            <div class="pigeon-card-ring">${p.ring}</div>
          </div>
          ${p.isCore ? '<span class="tag tag-core">‚≠ê Ê†∏ÂøÉ</span>' : ''}
        </div>
        <div class="pigeon-card-info">
          <div class="pigeon-card-info-item">
            <span class="pigeon-card-info-label">Áà∂È∏Ω</span>
            <span class="pigeon-card-info-value">${fatherName}</span>
          </div>
          <div class="pigeon-card-info-item">
            <span class="pigeon-card-info-label">ÊØçÈ∏Ω</span>
            <span class="pigeon-card-info-value">${motherName}</span>
          </div>
          <div class="pigeon-card-info-item">
            <span class="pigeon-card-info-label">Á±ªÂûã</span>
            <span class="pigeon-card-info-value">${p.type || '‚Äî'}</span>
          </div>
          ${p.currentOwner ? `
          <div class="pigeon-card-info-item">
            <span class="pigeon-card-info-label">Áé∞È∏Ω‰∏ª</span>
            <span class="pigeon-card-info-value">${p.currentOwner}</span>
          </div>
          ` : ''}
        </div>
        <div class="pigeon-card-tags">
          ${p.alive ? '<span class="tag tag-alive">üïäÔ∏è Âú®‰∏ñ</span>' : '<span class="tag tag-dead">üíî Â∑≤Ê≠ª‰∫°</span>'}
          ${p.races && p.races.length > 0 ? `<span class="tag" style="background:#FEF3C7;color:#B45309;border:1px solid #FCD34D;">üèÜ ${p.races.length}Âú∫</span>` : ''}
          ${p.ringRecycled ? '<span class="tag tag-recycled">‚ôªÔ∏è ÂõûÊî∂</span>' : ''}
        </div>
      `;
      
      // Âú®ËÆæÁΩÆinnerHTML‰πãÂêéÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂
      card.addEventListener('click', (e) => {
        e.stopPropagation();
        openDetail(p.id);
      });
      
      cardsBody.appendChild(card);
    });
  }

  // ÂéüÂßãÂà∑Êñ∞ÂàóË°®ÂáΩÊï∞
  const _refreshList = function() {
    tableBody.innerHTML = '';
    if (pigeons.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 8;
      td.innerHTML = '<span class="muted">ÊöÇÊó†Êï∞ÊçÆÔºåËØ∑ÂÖàÁÇπÂáªÂè≥‰∏äËßí„ÄåÊñ∞Â¢ûÈ∏ΩÂ≠ê‰ø°ÊÅØ„Äç„ÄÇ</span>';
      tr.appendChild(td);
      tableBody.appendChild(tr);
      return;
    }
    pigeons.forEach(p => {
      const tr = document.createElement('tr');

      const tdRing = document.createElement('td');
      const ringText = document.createTextNode(p.ring);
      tdRing.appendChild(ringText);
      if (p.ringRecycled) {
        const recycledBadge = document.createElement('span');
        recycledBadge.className = 'badge-small';
        recycledBadge.style.cssText = 'background:#fff3cd;color:#856404;margin-left:6px;';
        recycledBadge.textContent = 'ÂõûÊî∂';
        tdRing.appendChild(recycledBadge);
      }
      tr.appendChild(tdRing);

      const tdName = document.createElement('td');
      tdName.textContent = p.name || '‚Äî';
      if (p.isCore) {
        const coreTag = document.createElement('span');
        coreTag.className = 'badge-small';
        coreTag.textContent = 'Ê†∏ÂøÉÁßçÈ∏Ω';
        coreTag.style.marginLeft = '4px';
        tdName.appendChild(coreTag);
      }
      tr.appendChild(tdName);

      const tdType = document.createElement('td');
      tdType.textContent = p.type || '‚Äî';
      tr.appendChild(tdType);

      const tdStatus = document.createElement('td');
      const span = document.createElement('span');
      if (p.alive) {
        span.textContent = 'Âú®‰∏ñ';
        span.className = 'tag tag-alive';
      } else {
        span.textContent = 'Â∑≤Ê≠ª‰∫°';
        span.className = 'tag tag-dead';
      }
      tdStatus.appendChild(span);
      tr.appendChild(tdStatus);

      const tdParents = document.createElement('td');
      const father = p.fatherId ? getPigeonById(p.fatherId) : null;
      const mother = p.motherId ? getPigeonById(p.motherId) : null;
      // ÊòæÁ§∫Áà∂È∏ΩÂíåÊØçÈ∏ΩÁöÑÂêçÂ≠óËÄå‰∏çÊòØË∂≥ÁéØÂè∑
      tdParents.textContent =
        (father ? (father.name || father.ring || '') : '‚Äî') + ' / ' +
        (mother ? (mother.name || mother.ring || '') : '‚Äî');
      tr.appendChild(tdParents);

      const tdCurrentOwner = document.createElement('td');
      tdCurrentOwner.textContent = p.currentOwner || '‚Äî';
      tr.appendChild(tdCurrentOwner);

      const tdRaceCount = document.createElement('td');
      tdRaceCount.textContent = (p.races || []).length;
      tr.appendChild(tdRaceCount);

      const tdActions = document.createElement('td');
      const btnDetail = document.createElement('button');
      btnDetail.className = 'btn btn-outline btn-sm';
      btnDetail.textContent = 'Êü•ÁúãËØ¶ÊÉÖ';
      btnDetail.onclick = () => openDetail(p.id);
      tdActions.appendChild(btnDetail);

      const btnQuickDead = document.createElement('button');
      btnQuickDead.className = 'btn btn-danger btn-sm';
      btnQuickDead.style.marginLeft = '4px';
      btnQuickDead.textContent = p.alive ? 'Ê†áËÆ∞Ê≠ª‰∫°' : 'Â∑≤Ê≠ª‰∫°';
      btnQuickDead.disabled = !p.alive;
      btnQuickDead.onclick = () => {
        if (!confirm(`Á°ÆÂÆöÂ∞Ü„Äê${p.ring}„ÄëÊ†áËÆ∞‰∏∫Â∑≤Ê≠ª‰∫°ÂêóÔºü‰∏ç‰ºöÂà†Èô§‰ªª‰ΩïÂéÜÂè≤ÊàêÁª©„ÄÇ`)) return;
        p.alive = false;
        p.deathDate = new Date().toISOString().slice(0,10);
        saveToStorage();
        _refreshList(); // Áõ¥Êé•Ë∞ÉÁî®ÂéüÂßãÂáΩÊï∞ÔºåÈÅøÂÖçÈò≤ÊäñÂª∂Ëøü
        _refreshStats(); // Áõ¥Êé•Ë∞ÉÁî®ÂéüÂßãÂáΩÊï∞
        _refreshDashboard(); // Áõ¥Êé•Ë∞ÉÁî®ÂéüÂßãÂáΩÊï∞
        if (typeof refreshPedigreeView === 'function') refreshPedigreeView(); // Âà∑Êñ∞Ë°ÄÁªüÂÖ≥Á≥ªËßÜÂõæ
      };
      tdActions.appendChild(btnQuickDead);

      tr.appendChild(tdActions);
      tableBody.appendChild(tr);
    });
    
    // ÂêåÊó∂Êõ¥Êñ∞Âç°ÁâáËßÜÂõæ
    renderCardView();
  };
  
  // ‰ΩøÁî®Èò≤ÊäñÂåÖË£ÖÂà∑Êñ∞ÂàóË°®ÂáΩÊï∞Ôºà150msÈò≤ÊäñÔºâ
  const refreshList = debounce(_refreshList, 150);

  // Êñ∞Â¢ûË°®Âçï - Â°´ÂÖÖÁà∂ÊØç‰∏ãÊãâ
  function fillParentOptions(selectEl, excludeId) {
    selectEl.innerHTML = '<option value="">Êú™ÈÄâÊã©</option>';
    pigeons.forEach(p => {
      if (p.id === excludeId) return;
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.ring + (p.name ? 'Ôºà' + p.name + 'Ôºâ' : '');
      selectEl.appendChild(opt);
    });
  }

  // Êõ¥Êñ∞È∏Ω‰∏ª‰∏ãÊãâÂàóË°®
  function updateOwnerDatalist(elementId) {
    const datalist = document.getElementById(elementId);
    if (!datalist) return;
    datalist.innerHTML = '';
    
    // Âõ∫ÂÆöÈÄâÈ°πÔºöÊùéÂõΩËæâ
    const option1 = document.createElement('option');
    option1.value = 'ÊùéÂõΩËæâ';
    datalist.appendChild(option1);
    
    // ‰ªé‰øùÂ≠òÁöÑÈÖçÂØπ‰∏≠Ëé∑ÂèñÂ∑≤‰øùÂ≠òÁöÑÈ∏Ω‰∏ª
    const pairs = loadOwnerRegionPairs();
    const savedOwners = new Set();
    pairs.forEach(pair => {
      if (pair.saved && pair.owner) {
        savedOwners.add(pair.owner);
      }
    });
    
    savedOwners.forEach(owner => {
      if (owner !== 'ÊùéÂõΩËæâ') {
        const option = document.createElement('option');
        option.value = owner;
        datalist.appendChild(option);
      }
    });
  }
  
  // Êõ¥Êñ∞Âú∞Âå∫‰∏ãÊãâÂàóË°®
  function updateRegionDatalist(owner, elementId) {
    const datalist = document.getElementById(elementId);
    if (!datalist) return;
    datalist.innerHTML = '';
    
    if (owner === 'ÊùéÂõΩËæâ') {
      const option = document.createElement('option');
      option.value = 'Ë¥µÂ∑ûÈªîË•ø';
      datalist.appendChild(option);
    }
    
    // ‰ªé‰øùÂ≠òÁöÑÈÖçÂØπ‰∏≠Ëé∑ÂèñËØ•È∏Ω‰∏ªÂØπÂ∫îÁöÑÂú∞Âå∫
    const pairs = loadOwnerRegionPairs();
    pairs.forEach(pair => {
      if (pair.saved && pair.owner === owner && pair.region) {
        const option = document.createElement('option');
        option.value = pair.region;
        datalist.appendChild(option);
      }
    });
  }

  function setupCreateForm() {
    fillParentOptions(document.getElementById('c_father'));
    fillParentOptions(document.getElementById('c_mother'));

    // Áä∂ÊÄÅÂàáÊç¢
    const radios = document.querySelectorAll('input[name="c_alive"]');
    const deathExtras = document.querySelectorAll('.c-death-extra');
    radios.forEach(r => {
      r.addEventListener('change', () => {
        if (r.checked && r.value === 'dead') {
          deathExtras.forEach(el => el.style.display = '');
        } else if (r.checked && r.value === 'alive') {
          deathExtras.forEach(el => el.style.display = 'none');
        }
      });
    });
    
    // ÁßçÈ∏ΩÁ±ªÂûãÂàáÊç¢ÔºöÊòæÁ§∫/ÈöêËóèÂâçÈ∏Ω‰∏ªÂíåÂâçÂú∞Âå∫Â≠óÊÆµ
    const typeSelect = document.getElementById('c_type');
    const breederExtra = document.getElementById('c_breederExtra');
    const breederExtraDesc = document.getElementById('c_breederExtraDesc');
    const breederExtraFields = document.getElementById('c_breederExtraFields');
    
    function toggleBreederFields() {
      const isBreeder = typeSelect.value === 'ÁßçÈ∏Ω';
      if (breederExtra) breederExtra.style.display = isBreeder ? '' : 'none';
      if (breederExtraDesc) breederExtraDesc.style.display = isBreeder ? '' : 'none';
      if (breederExtraFields) breederExtraFields.style.display = isBreeder ? '' : 'none';
    }
    
    typeSelect.addEventListener('change', toggleBreederFields);
    toggleBreederFields();
    
    // ÂàùÂßãÂåñÈ∏Ω‰∏ª‰∏ãÊãâÂàóË°®
    updateOwnerDatalist('c_ownerList');
    
    // Áé∞È∏Ω‰∏ªËæìÂÖ•ÂèòÂåñÊó∂Êõ¥Êñ∞Âú∞Âå∫‰∏ãÊãâÂàóË°®
    const currentOwnerInput = document.getElementById('c_currentOwner');
    const currentRegionInput = document.getElementById('c_currentRegion');
    
    function handleOwnerChange() {
      const owner = currentOwnerInput.value.trim();
      updateRegionDatalist(owner, 'c_regionList');
      
      // Â¶ÇÊûúÈÄâÊã©ÊùéÂõΩËæâÔºåËá™Âä®Â°´ÂÖÖË¥µÂ∑ûÈªîË•ø
      if (owner === 'ÊùéÂõΩËæâ') {
        currentRegionInput.value = 'Ë¥µÂ∑ûÈªîË•ø';
      }
    }
    
    currentOwnerInput.addEventListener('input', handleOwnerChange);
    currentOwnerInput.addEventListener('change', handleOwnerChange);
    
    // Áé∞È∏Ω‰∏ªÂíåÁé∞Âú∞Âå∫ÈÉΩÂ°´ÂÜôÂêéÔºåÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶Å‰øùÂ≠òÈÖçÂØπ
    let ownerRegionTimer = null;
    currentOwnerInput.addEventListener('input', () => {
      clearTimeout(ownerRegionTimer);
      ownerRegionTimer = setTimeout(() => {
        const owner = currentOwnerInput.value.trim();
        const region = currentRegionInput.value.trim();
        if (owner && region) {
          addOwnerRegionPair(owner, region);
          updateOwnerDatalist('c_ownerList');
          updateRegionDatalist(owner, 'c_regionList');
        }
      }, 1000);
    });
    
    currentRegionInput.addEventListener('input', () => {
      clearTimeout(ownerRegionTimer);
      ownerRegionTimer = setTimeout(() => {
        const owner = currentOwnerInput.value.trim();
        const region = currentRegionInput.value.trim();
        if (owner && region) {
          addOwnerRegionPair(owner, region);
          updateOwnerDatalist('c_ownerList');
          updateRegionDatalist(owner, 'c_regionList');
        }
      }, 1000);
    });
  }

  // ÂèÇËµõËÆ∞ÂΩïÔºöÁîüÊàê‰∏ÄÊù°Ë°®ÂçïÈ°πÔºàÊñ∞Â¢ûÊ®°ÂºèÔºâ
  function createRaceFormItem(container, race = {}, onRemove) {
    const item = document.createElement('div');
    item.className = 'race-item';

    const header = document.createElement('div');
    header.className = 'race-header';
    const title = document.createElement('div');
    title.textContent = race.name || 'Êñ∞ÂèÇËµõËÆ∞ÂΩï';
    header.appendChild(title);
    const btnDel = document.createElement('button');
    btnDel.className = 'btn btn-ghost btn-sm';
    btnDel.textContent = 'Âà†Èô§';
    btnDel.type = 'button';
    btnDel.onclick = () => {
      if (onRemove) onRemove();
      container.removeChild(item);
    };
    header.appendChild(btnDel);
    item.appendChild(header);

    const fields = document.createElement('div');
    fields.className = 'race-fields';

    const fName = document.createElement('div');
    fName.innerHTML = '<label style="font-size:12px;color:#777;">ÊØîËµõÂêçÁß∞</label>';
    const iName = document.createElement('input');
    iName.type = 'text';
    iName.value = race.name || '';
    iName.placeholder = 'Â¶ÇÔºö500ÂÖ¨ÈáåËÅîËµõ';
    iName.style.width = '100%';
    fName.appendChild(iName);
    fields.appendChild(fName);

    const fDate = document.createElement('div');
    fDate.innerHTML = '<label style="font-size:12px;color:#777;">ÊØîËµõÊó∂Èó¥</label>';
    const iDate = document.createElement('input');
    iDate.type = 'date';
    iDate.value = race.date || '';
    iDate.style.width = '100%';
    fDate.appendChild(iDate);
    fields.appendChild(fDate);

    const fDist = document.createElement('div');
    fDist.innerHTML = '<label style="font-size:12px;color:#777;">ÊØîËµõË∑ùÁ¶ªÔºàÂÖ¨ÈáåÔºâ</label>';
    const iDist = document.createElement('input');
    iDist.type = 'number';
    iDist.value = race.distance || '';
    iDist.placeholder = 'Â¶ÇÔºö500';
    iDist.style.width = '100%';
    fDist.appendChild(iDist);
    fields.appendChild(fDist);

    const fRank = document.createElement('div');
    fRank.innerHTML = '<label style="font-size:12px;color:#777;">ÂêçÊ¨°</label>';
    const iRank = document.createElement('input');
    iRank.type = 'number';
    iRank.value = race.rank || '';
    iRank.placeholder = 'Â¶ÇÔºö1';
    iRank.style.width = '100%';
    fRank.appendChild(iRank);
    fields.appendChild(fRank);

    const fTotal = document.createElement('div');
    fTotal.innerHTML = '<label style="font-size:12px;color:#777;">ÂèÇËµõÊÄªÁæΩÊï∞</label>';
    const iTotal = document.createElement('input');
    iTotal.type = 'number';
    iTotal.value = race.total || '';
    iTotal.placeholder = 'Â¶ÇÔºö2000';
    iTotal.style.width = '100%';
    fTotal.appendChild(iTotal);
    fields.appendChild(fTotal);

    const fRemark = document.createElement('div');
    fRemark.innerHTML = '<label style="font-size:12px;color:#777;">Â§áÊ≥®</label>';
    const iRemark = document.createElement('input');
    iRemark.type = 'text';
    iRemark.value = race.remark || '';
    iRemark.placeholder = 'Â¶ÇÔºöÈÄÜÈ£é„ÄÅÈõ®Â§©Á≠âÊÉÖÂÜµËØ¥Êòé';
    iRemark.style.width = '100%';
    fRemark.appendChild(iRemark);
    fields.appendChild(fRemark);

    item.appendChild(fields);

    item.getValue = () => ({
      name: iName.value.trim(),
      date: iDate.value,
      distance: iDist.value,
      rank: iRank.value,
      total: iTotal.value,
      remark: iRemark.value.trim()
    });

    // ËÆ©Ê†áÈ¢òÈöèÊØîËµõÂêçÁß∞ÂèòÂåñ
    iName.addEventListener('input', () => {
      title.textContent = iName.value.trim() || 'Êñ∞ÂèÇËµõËÆ∞ÂΩï';
    });

    container.appendChild(item);
    return item;
  }

  // Êñ∞Â¢ûËßÜÂõæÈÄªËæë
  const cRaceList = document.getElementById('c_raceList');
  document.getElementById('btnAddRaceCreate').onclick = () => {
    createRaceFormItem(cRaceList);
  };

  document.getElementById('btnCancelCreate').onclick = () => {
    if (!confirm('ÂèñÊ∂àÂêéÂΩìÂâçÂ°´ÂÜôÂÜÖÂÆπÂ∞Ü‰ºö‰∏¢Â§±ÔºåÁ°ÆÂÆöÂêóÔºü')) return;
    clearCreateForm();
    switchView('listView');
  };

  function clearCreateForm() {
    document.getElementById('c_name').value = '';
    document.getElementById('c_ring').value = '';
    document.getElementById('c_gender').value = '';
    document.getElementById('c_color').value = '';
    document.getElementById('c_birth').value = '';
    document.getElementById('c_type').value = '';
    document.getElementById('c_father').value = '';
    document.getElementById('c_mother').value = '';
    document.querySelector('input[name="c_alive"][value="alive"]').checked = true;
    document.querySelectorAll('.c-death-extra').forEach(el => el.style.display = 'none');
    document.getElementById('c_death_date').value = '';
    document.getElementById('c_death_reason').value = '';
    const coreEl = document.getElementById('c_core');
    if (coreEl) coreEl.checked = false;
    cRaceList.innerHTML = '';
    // Ê∏ÖÁ©∫ÁßçÈ∏Ω‰∏ìÁî®Â≠óÊÆµ
    if (document.getElementById('c_previousOwner')) document.getElementById('c_previousOwner').value = '';
    if (document.getElementById('c_previousRegion')) document.getElementById('c_previousRegion').value = '';
    // Ê∏ÖÁ©∫Áé∞È∏Ω‰∏ªÂíåÁé∞Âú∞Âå∫
    if (document.getElementById('c_currentOwner')) document.getElementById('c_currentOwner').value = '';
    if (document.getElementById('c_currentRegion')) document.getElementById('c_currentRegion').value = '';
    // ÈöêËóèÁßçÈ∏ΩÂ≠óÊÆµ
    const breederExtra = document.getElementById('c_breederExtra');
    const breederExtraDesc = document.getElementById('c_breederExtraDesc');
    const breederExtraFields = document.getElementById('c_breederExtraFields');
    if (breederExtra) breederExtra.style.display = 'none';
    if (breederExtraDesc) breederExtraDesc.style.display = 'none';
    if (breederExtraFields) breederExtraFields.style.display = 'none';
  }

  document.getElementById('btnSaveCreate').onclick = async () => {
    const ring = document.getElementById('c_ring').value.trim();
    if (!ring) {
      alert('Ë∂≥ÁéØÂè∑Á†Å‰∏∫ÂøÖÂ°´È°π„ÄÇ');
      return;
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÊ¥ªÁùÄÁöÑÈ∏ΩÂ≠ê‰ΩøÁî®ËØ•Ë∂≥ÁéØÂè∑
    const existingAlive = getPigeonByRing(ring);
    if (existingAlive) {
      alert('ËØ•Ë∂≥ÁéØÂè∑Á†ÅÂ∑≤Ë¢´Ê¥ªÁùÄÁöÑÈ∏ΩÂ≠ê‰ΩøÁî®ÔºåËØ∑Á°ÆËÆ§ÊòØÂê¶ÈáçÂ§ç„ÄÇ');
      return;
    }

    // Ê£ÄÊü•ÊòØÂê¶ÊúâÂ∑≤Ê≠ª‰∫°ÁöÑÈ∏ΩÂ≠ê‰ΩøÁî®ËØ•Ë∂≥ÁéØÂè∑ÔºàÂõûÊî∂‰ΩøÁî®Ôºâ
    const allWithRing = getAllPigeonsByRing(ring);
    const deadPigeons = allWithRing.filter(p => !p.alive);
    if (deadPigeons.length > 0) {
      // Â∞Ü‰πãÂâç‰ΩøÁî®ËØ•Ë∂≥ÁéØÂè∑ÁöÑÂ∑≤Ê≠ª‰∫°È∏ΩÂ≠êÊ†áËÆ∞‰∏∫"ÂõûÊî∂‰ΩøÁî®"
      deadPigeons.forEach(p => {
        p.ringRecycled = true;
        p.recycledDate = new Date().toISOString().slice(0, 10);
      });
      if (!confirm(`ËØ•Ë∂≥ÁéØÂè∑ÊõæË¢´Â∑≤Ê≠ª‰∫°ÁöÑÈ∏ΩÂ≠ê‰ΩøÁî®ËøáÔºåÁ≥ªÁªüÂ∞ÜËá™Âä®Ê†áËÆ∞‰∏∫"ÂõûÊî∂‰ΩøÁî®"„ÄÇÊòØÂê¶ÁªßÁª≠Ôºü`)) {
        return;
      }
    }
    let name = document.getElementById('c_name').value.trim();
    // Â¶ÇÊûúÂêçÁß∞‰∏∫Á©∫ÔºåËá™Âä®ÂàÜÈÖç‰∏Ä‰∏™Êú™‰ΩøÁî®ÁöÑÂêçÂ≠ó
    if (!name) {
      name = getRandomUnusedName();
      if (!name) {
        alert('ÊâÄÊúâÂèØÁî®ÂêçÂ≠óÈÉΩÂ∑≤‰ΩøÁî®ÂÆåÊØïÔºåËØ∑ÊâãÂä®ËæìÂÖ•‰∏Ä‰∏™ÂêçÂ≠ó„ÄÇ');
        return;
      }
    } else {
      // Â¶ÇÊûúÊâãÂä®ËæìÂÖ•ÁöÑÂêçÂ≠óÂú®ÂàóË°®‰∏≠Ôºå‰πüÊ†áËÆ∞‰∏∫Â∑≤‰ΩøÁî®
      const usedNames = loadUsedNames();
      if (PIGEON_NAMES.includes(name) && !usedNames.has(name)) {
        usedNames.add(name);
        saveUsedNames(usedNames);
      }
    }
    const gender = document.getElementById('c_gender').value;
    const color = document.getElementById('c_color').value.trim();
    const birth = document.getElementById('c_birth').value;
    const type = document.getElementById('c_type').value;
    const fatherId = document.getElementById('c_father').value || null;
    const motherId = document.getElementById('c_mother').value || null;
    const aliveRadio = document.querySelector('input[name="c_alive"]:checked').value;
    const alive = aliveRadio === 'alive';
    const deathDate = alive ? null : document.getElementById('c_death_date').value;
    const deathReason = alive ? '' : document.getElementById('c_death_reason').value.trim();
    if (!alive && !deathDate) {
      alert('Â∑≤Ê≠ª‰∫°Áä∂ÊÄÅ‰∏ãÔºåÊ≠ª‰∫°Êó•Êúü‰∏∫ÂøÖÂ°´„ÄÇ');
      return;
    }
    
    // Ëé∑ÂèñÁßçÈ∏Ω‰∏ìÁî®‰ø°ÊÅØ
    const previousOwner = type === 'ÁßçÈ∏Ω' ? (document.getElementById('c_previousOwner')?.value.trim() || '') : '';
    const previousRegion = type === 'ÁßçÈ∏Ω' ? (document.getElementById('c_previousRegion')?.value.trim() || '') : '';
    
    // Ëé∑ÂèñÁé∞È∏Ω‰∏ªÂíåÁé∞Âú∞Âå∫
    const currentOwner = document.getElementById('c_currentOwner')?.value.trim() || '';
    const currentRegion = document.getElementById('c_currentRegion')?.value.trim() || '';
    
    // ËÆ∞ÂΩïÈ∏Ω‰∏ª-Âú∞Âå∫ÈÖçÂØπ
    if (currentOwner && currentRegion) {
      addOwnerRegionPair(currentOwner, currentRegion);
    }

    const races = [];
    cRaceList.querySelectorAll('.race-item').forEach(item => {
      races.push(item.getValue());
    });

    const bodyFile = document.getElementById('c_body_photo').files[0] || null;
    const eyeFile = document.getElementById('c_eye_photo').files[0] || null;

    let bodyImg = null;
    let eyeImg = null;
    if (bodyFile) {
      try {
        if (!bodyFile.type || !bodyFile.type.startsWith('image/')) {
          alert('Á´ôÁ´ã‰æßË∫´ÂõæÁâáÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂ÔºàJPG„ÄÅPNG„ÄÅGIF„ÄÅWEBPÁ≠âÔºâ„ÄÇ');
          return;
        }
        bodyImg = await readFileAsDataURL(bodyFile);
      } catch (e) {
        console.error('ËØªÂèñÁ´ôÁ´ã‰æßË∫´ÂõæÁâáÂ§±Ë¥•', e);
        alert('ËØªÂèñÁ´ôÁ´ã‰æßË∫´ÂõæÁâáÂ§±Ë¥•Ôºö' + (e.message || 'Êú™Áü•ÈîôËØØ') + 'ÔºåËØ∑ÈáçËØï„ÄÇ');
        return;
      }
    }
    if (eyeFile) {
      try {
        if (!eyeFile.type || !eyeFile.type.startsWith('image/')) {
          alert('ÁúºÁùõÁâπÂÜôÂõæÁâáÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂ÔºàJPG„ÄÅPNG„ÄÅGIF„ÄÅWEBPÁ≠âÔºâ„ÄÇ');
          return;
        }
        eyeImg = await readFileAsDataURL(eyeFile);
      } catch (e) {
        console.error('ËØªÂèñÁúºÁùõÂõæÁâáÂ§±Ë¥•', e);
        alert('ËØªÂèñÁúºÁùõÂõæÁâáÂ§±Ë¥•Ôºö' + (e.message || 'Êú™Áü•ÈîôËØØ') + 'ÔºåËØ∑ÈáçËØï„ÄÇ');
        return;
      }
    }

    const pigeon = {
      id: generateId(),
      ring,
      name,
      gender,
      color,
      birth,
      type,
      fatherId,
      motherId,
      alive,
      deathDate,
      deathReason,
      isCore: !!document.getElementById('c_core')?.checked,
      races,
      images: {
        body: bodyImg,
        eye: eyeImg
      },
      ringRecycled: deadPigeons && deadPigeons.length > 0, // Ê†áËÆ∞‰∏∫Êñ∞‰ΩøÁî®ÁöÑÂõûÊî∂Ë∂≥ÁéØÂè∑
      previousOwner: previousOwner, // ÂâçÈ∏Ω‰∏ªÔºà‰ªÖÁßçÈ∏ΩÔºâ
      previousRegion: previousRegion, // ÂâçÂú∞Âå∫Ôºà‰ªÖÁßçÈ∏ΩÔºâ
      currentOwner: currentOwner, // Áé∞È∏Ω‰∏ª
      currentRegion: currentRegion // Áé∞Âú∞Âå∫
    };
    pigeons.push(pigeon);
    saveToStorage();
    alert('‰øùÂ≠òÊàêÂäüÔºåÂ∑≤ÁîüÊàêÊ°£Ê°à„ÄÇ');
    clearCreateForm();
    refreshList();
    refreshStats();
    refreshDashboard();
    refreshPedigreeView(); // Âà∑Êñ∞Ë°ÄÁªüÂÖ≥Á≥ªËßÜÂõæ
    openDetail(pigeon.id);
  };

  // ÂàùÂßãÂåñÊâÄÊúâÊåâÈíÆ‰∫ã‰ª∂ÔºàÂª∂ËøüÊâßË°åÁ°Æ‰øùDOMÂ∑≤Âä†ËΩΩÔºâ
  let buttonEventsInitialized = false;
  
  function initAllButtonEvents() {
    // Â¶ÇÊûúÂ∑≤ÁªèÂàùÂßãÂåñËøáÔºåÁõ¥Êé•ËøîÂõû
    if (buttonEventsInitialized) {
      return;
    }
    
    // Êñ∞Â¢ûÈ∏ΩÂ≠êÊåâÈíÆ
    const btnGoCreate = document.getElementById('btnGoCreate');
    if (btnGoCreate) {
      // ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
      const newBtn = btnGoCreate.cloneNode(true);
      btnGoCreate.parentNode.replaceChild(newBtn, btnGoCreate);
      
      // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
      newBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Êñ∞Â¢ûÈ∏ΩÂ≠êÊåâÈíÆË¢´ÁÇπÂáª');
        if (typeof setupCreateForm === 'function') {
          setupCreateForm();
        }
        if (typeof switchView === 'function') {
          switchView('createView');
        }
      });
      console.log('‚úì btnGoCreate ‰∫ã‰ª∂Â∑≤ÁªëÂÆö');
    } else {
      console.warn('‚úó btnGoCreate Êú™ÊâæÂà∞');
    }
    
    buttonEventsInitialized = true;
  }
  
  // Á´ãÂç≥Â∞ùËØïÁªëÂÆöÔºåÂ¶ÇÊûúDOMÊú™Âä†ËΩΩÂàôÂª∂Ëøü
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAllButtonEvents);
  } else {
    initAllButtonEvents();
  }
  
  // Âª∂ËøüÂÜçÊ¨°ÁªëÂÆöÔºåÁ°Æ‰øùÊåâÈíÆÂ∑≤Âä†ËΩΩ
  setTimeout(initAllButtonEvents, 500);
  setTimeout(initAllButtonEvents, 1000);

  // ËØ¶ÊÉÖËßÜÂõæÔºöÊµèËßà + ÁºñËæë
  const dTitle = document.getElementById('d_title');
  const dSubtitle = document.getElementById('d_subtitle');
  const dStatusRow = document.getElementById('d_statusRow');
  const dBasic = document.getElementById('d_basic');
  const dPedigree = document.getElementById('d_pedigree');
  const dRaces = document.getElementById('d_races');
  const dImages = document.getElementById('d_images');
  const dPedigreeTree = document.getElementById('d_pedigreeTree');
  const browseMode = document.getElementById('browseMode');
  const editMode = document.getElementById('editMode');
  const dEditNotice = document.getElementById('d_editNotice');
  const btnToggleEdit = document.getElementById('btnToggleEdit');

  function openDetail(id) {
    currentDetailId = id;
    renderDetail();
    switchView('detailView');
  }

  function renderDetail() {
    const p = getPigeonById(currentDetailId);
    if (!p) return;

    dTitle.textContent = p.name || p.ring;
    dSubtitle.innerHTML = `Ë∂≥ÁéØÂè∑Ôºö${p.ring}` +
      (p.ringRecycled ? `„ÄÄ<span class="badge-small" style="background:#fff3cd;color:#856404;">ÂõûÊî∂‰ΩøÁî®</span>` : '') +
      (p.type ? `„ÄÄ<span class="badge-small">${p.type}</span>` : '') +
      (p.isCore ? `„ÄÄ<span class="badge-small">Ê†∏ÂøÉÁßçÈ∏Ω ‚≠ê</span>` : '');

    dStatusRow.innerHTML = '';
    const aliveSpan = document.createElement('span');
    if (p.alive) {
      aliveSpan.className = 'tag tag-alive';
      aliveSpan.textContent = 'Âú®‰∏ñ';
    } else {
      aliveSpan.className = 'tag tag-dead';
      aliveSpan.textContent = 'Â∑≤Ê≠ª‰∫°';
      const extra = document.createElement('span');
      extra.className = 'status-dead';
      extra.textContent = (p.deathDate ? `Ôºà${p.deathDate}` : 'Ôºà') +
        (p.deathReason ? `Ôºå${p.deathReason}` : '') + 'Ôºâ';
      dStatusRow.appendChild(extra);
    }
    dStatusRow.appendChild(aliveSpan);

    // Âü∫Êú¨‰ø°ÊÅØ
    dBasic.innerHTML = '';
    // Á°Æ‰øùÂêçÂ≠óÂ≠òÂú®ÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®ÂàôËá™Âä®ÂàÜÈÖç
    if (!p.name || p.name.trim() === '') {
      const newName = getRandomUnusedName();
      if (newName) {
        p.name = newName;
        saveToStorage();
      }
    }
    const fields = [
      ['È∏ΩÂ≠êÂêçÁß∞', p.name || '‚Äî'],
      ['Ë∂≥ÁéØÂè∑Á†Å', p.ring],
      ['ÊÄßÂà´', p.gender || '‚Äî'],
      ['ÁæΩËâ≤', p.color || '‚Äî'],
      ['Âá∫ÁîüÊó•Êúü', formatDate(p.birth) || '‚Äî'],
      ['È∏ΩÂ≠êÁ±ªÂûã', p.type || '‚Äî']
    ];
    fields.forEach(([label, value]) => {
      const row = document.createElement('div');
      row.className = 'field-row';
      const l = document.createElement('div');
      l.className = 'field-label';
      l.textContent = label + 'Ôºö';
      const v = document.createElement('div');
      v.className = 'field-value';
      v.textContent = value;
      row.appendChild(l);
      row.appendChild(v);
      dBasic.appendChild(row);
    });
    // ‰∏∫Âü∫Êú¨‰ø°ÊÅØÂå∫ÂüüÊ∑ªÂä†ÂÆπÂô®Ê†∑Âºè
    if (dBasic && !dBasic.classList.contains('detail-section')) {
      dBasic.style.cssText = 'background:#fff; border-radius:8px; padding:16px; margin-bottom:16px; box-shadow:0 1px 3px rgba(0,0,0,0.05);';
    }

    // ÂõæÁâáÂå∫Ôºà‰ª•ÂõæÁâá‰∏∫‰∏ªÔºâ
    dImages.innerHTML = '';
    const imgWrap = document.createElement('div');
    
    // Ê£ÄÊü•Áî®Êà∑‰∏ä‰º†ÁöÑÂõæÁâá
    const hasCustomBody = p.images && p.images.body;
    const hasCustomEye = p.images && p.images.eye;
    
    // Á°ÆÂÆöÊòæÁ§∫ÁöÑÂõæÁâáÊ∫ê
    const bodySrc = hasCustomBody ? p.images.body : DEFAULT_BODY_IMG;
    const eyeSrc = hasCustomEye ? p.images.eye : DEFAULT_EYE_IMG;
    
    // Â¶ÇÊûúÂè™Êúâ‰∏ÄÂº†Ëá™ÂÆö‰πâÂõæÁâáÔºåÂ±Ö‰∏≠ÊòæÁ§∫
    const singleImage = (hasCustomBody && !hasCustomEye) || (!hasCustomBody && hasCustomEye);
    
    if (singleImage) {
      imgWrap.style.cssText = 'display:flex; justify-content:center; align-items:center; margin-top:8px;';
    } else {
      imgWrap.className = 'images-grid';
    }

    // ÂàõÂª∫ÂõæÁâáÂç°ÁâáÁöÑÂáΩÊï∞
    function createImageCard(imgSrc, label, isCustom, uploadFieldId) {
      const card = document.createElement('div');
      card.className = 'image-thumb';
      card.style.position = 'relative';
      if (singleImage) {
        card.style.margin = '0 auto';
      }
      
      const imgEl = document.createElement('img');
      imgEl.src = imgSrc;
      imgEl.onerror = function() {
        // Â¶ÇÊûúÂõæÁâáÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®Âç†‰ΩçÁ¨¶
        this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjYwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iODAwIiBoZWlnaHQ9IjYwMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LXNpemU9IjE4IiBmaWxsPSIjOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+6IOM5pif5LiK6IOM5bmy5LqG5piv6Z2i6K+V6L6T5YWlPC90ZXh0Pjwvc3ZnPg==';
      };
      card.appendChild(imgEl);
      
      const badge = document.createElement('div');
      badge.className = 'badge';
      badge.textContent = label;
      card.appendChild(badge);
      
      // ÂßãÁªàÊòæÁ§∫‰∏ä‰º†ÂÖ•Âè£ÔºàÂç≥‰ΩøÊúâËá™ÂÆö‰πâÂõæÁâáÔºâ
      const uploadHint = document.createElement('div');
      uploadHint.style.cssText = 'position:absolute; top:10px; right:10px; background:rgba(43,92,255,0.9); color:#fff; padding:6px 12px; border-radius:6px; font-size:12px; cursor:pointer; z-index:10; transition:all 0.2s;';
      uploadHint.textContent = isCustom ? 'üîÑ Êõ¥Êç¢ÂõæÁâá' : 'üì∑ ‰∏ä‰º†ÂõæÁâá';
      uploadHint.onmouseover = function() { this.style.background = 'rgba(43,92,255,1)'; };
      uploadHint.onmouseout = function() { this.style.background = 'rgba(43,92,255,0.9)'; };
      uploadHint.onclick = () => {
        setEditMode(true);
        setTimeout(() => {
          document.getElementById(uploadFieldId).scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
      };
      card.appendChild(uploadHint);
      
      return card;
    }

    // Ê†πÊçÆÊÉÖÂÜµÊòæÁ§∫ÂõæÁâá
    if (singleImage) {
      // Âè™ÊòæÁ§∫‰∏ÄÂº†ÂõæÁâáÔºàÁî®Êà∑‰∏ä‰º†ÁöÑÈÇ£Âº†Ôºâ
      if (hasCustomBody) {
        imgWrap.appendChild(createImageCard(bodySrc, 'Á´ôÁ´ã‰æßË∫´Âõæ', true, 'e_body_photo'));
      } else if (hasCustomEye) {
        imgWrap.appendChild(createImageCard(eyeSrc, 'ÁúºÁùõÁâπÂÜô', true, 'e_eye_photo'));
      }
    } else {
      // ÊòæÁ§∫‰∏§Âº†ÂõæÁâáÔºàÈÉΩÊúâÊàñÈÉΩÊ≤°ÊúâÔºâ
      imgWrap.appendChild(createImageCard(bodySrc, 'Á´ôÁ´ã‰æßË∫´Âõæ', hasCustomBody, 'e_body_photo'));
      imgWrap.appendChild(createImageCard(eyeSrc, 'ÁúºÁùõÁâπÂÜô', hasCustomEye, 'e_eye_photo'));
    }

    dImages.appendChild(imgWrap);
    
    // Â¶ÇÊûú‰∏§Âº†ÂõæÁâáÈÉΩÊú™‰∏ä‰º†ÔºåÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
    if (!hasCustomBody && !hasCustomEye) {
      const tipDiv = document.createElement('div');
      tipDiv.style.cssText = 'text-align:center; margin-top:12px; padding:12px; background:#f0f7ff; border-radius:8px; color:#2b5cff; font-size:13px;';
      tipDiv.innerHTML = 'üí° ÊèêÁ§∫ÔºöÂΩìÂâçÊòæÁ§∫ÁöÑÊòØÁ§∫‰æãÂõæÁâáÔºåÁÇπÂáªÂõæÁâáÂè≥‰∏äËßíÁöÑ"üì∑ ‰∏ä‰º†ÂõæÁâá"ÊåâÈíÆÊàñ‰ΩøÁî®"ÁºñËæë‰ø°ÊÅØ"ÂäüËÉΩ‰∏ä‰º†Ëá™ÂÆö‰πâÂõæÁâá„ÄÇ';
      dImages.appendChild(tipDiv);
    }

    // Ë°ÄÁªüÊ†ëÂèØËßÜÂåñ
    if (dPedigreeTree) renderPedigreeTree(p);

    // Ë°ÄÁªü‰ø°ÊÅØ
    dPedigree.innerHTML = '';
    const father = p.fatherId ? getPigeonById(p.fatherId) : null;
    const mother = p.motherId ? getPigeonById(p.motherId) : null;
    
    // Á°Æ‰øùÁà∂È∏ΩÂíåÊØçÈ∏ΩÈÉΩÊúâÂêçÂ≠ó
    if (father && (!father.name || father.name.trim() === '')) {
      const newName = getRandomUnusedName();
      if (newName) {
        father.name = newName;
        saveToStorage();
      }
    }
    if (mother && (!mother.name || mother.name.trim() === '')) {
      const newName = getRandomUnusedName();
      if (newName) {
        mother.name = newName;
        saveToStorage();
      }
    }
    
    const rowF = document.createElement('div');
    rowF.className = 'field-row';
    const labelF = document.createElement('div');
    labelF.className = 'field-label';
    labelF.textContent = 'Áà∂È∏ΩÔºö';
    const valueF = document.createElement('div');
    valueF.className = 'field-value';
    if (father) {
      // ÊòæÁ§∫ÂêçÂ≠óÔºåÂ¶ÇÊûúÊ≤°ÊúâÂêçÂ≠óÂàôÊòæÁ§∫Ë∂≥ÁéØÂè∑
      valueF.innerHTML = `${father.name || father.ring}${father.name && father.ring ? 'Ôºà' + father.ring + 'Ôºâ' : ''}`;
      valueF.style.cursor = 'pointer';
      valueF.style.color = '#2b5cff';
      valueF.style.textDecoration = 'underline';
      valueF.onclick = () => openDetail(father.id);
    } else {
      valueF.textContent = '‚Äî';
    }
    rowF.appendChild(labelF);
    rowF.appendChild(valueF);
    dPedigree.appendChild(rowF);
    
    const rowM = document.createElement('div');
    rowM.className = 'field-row';
    const labelM = document.createElement('div');
    labelM.className = 'field-label';
    labelM.textContent = 'ÊØçÈ∏ΩÔºö';
    const valueM = document.createElement('div');
    valueM.className = 'field-value';
    if (mother) {
      // ÊòæÁ§∫ÂêçÂ≠óÔºåÂ¶ÇÊûúÊ≤°ÊúâÂêçÂ≠óÂàôÊòæÁ§∫Ë∂≥ÁéØÂè∑
      valueM.innerHTML = `${mother.name || mother.ring}${mother.name && mother.ring ? 'Ôºà' + mother.ring + 'Ôºâ' : ''}`;
      valueM.style.cursor = 'pointer';
      valueM.style.color = '#2b5cff';
      valueM.style.textDecoration = 'underline';
      valueM.onclick = () => openDetail(mother.id);
    } else {
      valueM.textContent = '‚Äî';
    }
    rowM.appendChild(labelM);
    rowM.appendChild(valueM);
    dPedigree.appendChild(rowM);
    // ‰∏∫Ë°ÄÁªü‰ø°ÊÅØÂå∫ÂüüÊ∑ªÂä†ÂÆπÂô®Ê†∑Âºè
    if (dPedigree && !dPedigree.classList.contains('detail-section')) {
      dPedigree.style.cssText = 'background:#fff; border-radius:8px; padding:16px; margin-bottom:16px; box-shadow:0 1px 3px rgba(0,0,0,0.05);';
    }

    // È∏Ω‰∏ª‰ø°ÊÅØÔºàÂú®Ë°ÄÁªüÊ†ëÂèØËßÜÂåñ‰πãÂâçÊèíÂÖ•Ôºâ
    const dOwnerInfo = document.createElement('div');
    
    // ÁßçÈ∏ΩÁöÑÂâçÈ∏Ω‰∏ªÂíåÂâçÂú∞Âå∫Ôºà‰ªÖÂΩìÊúâÂÄºÊó∂ÊòæÁ§∫Ôºâ
    if (p.type === 'ÁßçÈ∏Ω' && (p.previousOwner || p.previousRegion)) {
      const sectionTitle = document.createElement('div');
      sectionTitle.className = 'section-title';
      sectionTitle.textContent = 'ÁßçÈ∏Ω‰ø°ÊÅØ';
      dOwnerInfo.appendChild(sectionTitle);
      
      if (p.previousOwner) {
        const rowPrevOwner = document.createElement('div');
        rowPrevOwner.className = 'field-row';
        const labelPrevOwner = document.createElement('div');
        labelPrevOwner.className = 'field-label';
        labelPrevOwner.textContent = 'ÂâçÈ∏Ω‰∏ªÔºö';
        const valuePrevOwner = document.createElement('div');
        valuePrevOwner.className = 'field-value';
        valuePrevOwner.textContent = p.previousOwner;
        rowPrevOwner.appendChild(labelPrevOwner);
        rowPrevOwner.appendChild(valuePrevOwner);
        dOwnerInfo.appendChild(rowPrevOwner);
      }
      
      if (p.previousRegion) {
        const rowPrevRegion = document.createElement('div');
        rowPrevRegion.className = 'field-row';
        const labelPrevRegion = document.createElement('div');
        labelPrevRegion.className = 'field-label';
        labelPrevRegion.textContent = 'ÂâçÂú∞Âå∫Ôºö';
        const valuePrevRegion = document.createElement('div');
        valuePrevRegion.className = 'field-value';
        valuePrevRegion.textContent = p.previousRegion;
        rowPrevRegion.appendChild(labelPrevRegion);
        rowPrevRegion.appendChild(valuePrevRegion);
        dOwnerInfo.appendChild(rowPrevRegion);
      }
    }
    
    // Áé∞È∏Ω‰∏ªÂíåÁé∞Âú∞Âå∫ÔºàÊâÄÊúâÈ∏ΩÂ≠êÈÉΩÊúâÔºâ
    const sectionTitleCurrent = document.createElement('div');
    sectionTitleCurrent.className = 'section-title';
    sectionTitleCurrent.textContent = 'È∏Ω‰∏ª‰ø°ÊÅØ';
    dOwnerInfo.appendChild(sectionTitleCurrent);
    
    const rowCurrentOwner = document.createElement('div');
    rowCurrentOwner.className = 'field-row';
    const labelCurrentOwner = document.createElement('div');
    labelCurrentOwner.className = 'field-label';
    labelCurrentOwner.textContent = 'Áé∞È∏Ω‰∏ªÔºö';
    const valueCurrentOwner = document.createElement('div');
    valueCurrentOwner.className = 'field-value';
    valueCurrentOwner.textContent = p.currentOwner || '‚Äî';
    rowCurrentOwner.appendChild(labelCurrentOwner);
    rowCurrentOwner.appendChild(valueCurrentOwner);
    dOwnerInfo.appendChild(rowCurrentOwner);
    
    const rowCurrentRegion = document.createElement('div');
    rowCurrentRegion.className = 'field-row';
    const labelCurrentRegion = document.createElement('div');
    labelCurrentRegion.className = 'field-label';
    labelCurrentRegion.textContent = 'Áé∞Âú∞Âå∫Ôºö';
    const valueCurrentRegion = document.createElement('div');
    valueCurrentRegion.className = 'field-value';
    valueCurrentRegion.textContent = p.currentRegion || '‚Äî';
    rowCurrentRegion.appendChild(labelCurrentRegion);
    rowCurrentRegion.appendChild(valueCurrentRegion);
    dOwnerInfo.appendChild(rowCurrentRegion);
    // ‰∏∫È∏Ω‰∏ª‰ø°ÊÅØÂå∫ÂüüÊ∑ªÂä†ÂÆπÂô®Ê†∑Âºè
    dOwnerInfo.style.cssText = 'background:#fff; border-radius:8px; padding:16px; margin-bottom:16px; box-shadow:0 1px 3px rgba(0,0,0,0.05);';
    
    // Â∞ÜÈ∏Ω‰∏ª‰ø°ÊÅØÊèíÂÖ•Âà∞Ë°ÄÁªüÊ†ëÂèØËßÜÂåñ‰πãÂâç
    const browseMode = document.getElementById('browseMode');
    const pedigreeTreeSection = browseMode.querySelector('.section-title');
    if (pedigreeTreeSection && pedigreeTreeSection.textContent.includes('Ë°ÄÁªüÊ†ëÂèØËßÜÂåñ')) {
      browseMode.insertBefore(dOwnerInfo, pedigreeTreeSection);
    } else if (dPedigreeTree && dPedigreeTree.parentNode) {
      dPedigreeTree.parentNode.insertBefore(dOwnerInfo, dPedigreeTree);
    }

    // ÂèÇËµõËÆ∞ÂΩï
    dRaces.innerHTML = '';
    if (!p.races || p.races.length === 0) {
      dRaces.innerHTML = '<span class="muted">ÊöÇÊó†ÂèÇËµõËÆ∞ÂΩï„ÄÇ</span>';
    } else {
      p.races.forEach((r, idx) => {
        const item = document.createElement('div');
        item.className = 'race-item';
        const header = document.createElement('div');
        header.className = 'race-header';
        header.innerHTML = `<div>${r.name || 'Êú™ÂëΩÂêçÊØîËµõ'} <span class="muted">#${idx + 1}</span></div>`;
        item.appendChild(header);

        const fields = document.createElement('div');
        fields.className = 'race-fields';

        function addField(label, value) {
          const d = document.createElement('div');
          d.innerHTML = `<span class="muted">${label}</span><br>${value || '‚Äî'}`;
          fields.appendChild(d);
        }
        addField('ÊØîËµõÊó∂Èó¥', formatDate(r.date));
        addField('Ë∑ùÁ¶ªÔºàÂÖ¨ÈáåÔºâ', r.distance);
        addField('ÂêçÊ¨°', r.rank);
        addField('ÂèÇËµõÊÄªÁæΩÊï∞', r.total);
        addField('Â§áÊ≥®', r.remark);
        item.appendChild(fields);
        dRaces.appendChild(item);
      });
    }

    // ÈªòËÆ§ÂõûÂà∞ÊµèËßàÊ®°Âºè
    setEditMode(false);
  }

  // Ë°ÄÁªüÊ†ëÂèØËßÜÂåñÂáΩÊï∞
  function renderPedigreeTree(pigeon) {
    if (!dPedigreeTree) return;
    dPedigreeTree.innerHTML = '';

    // ÊûÑÂª∫Ë°ÄÁªüÊ†ëÊï∞ÊçÆ
    function buildTree(p, level = 0, maxLevel = 3) {
      if (!p || level >= maxLevel) return null;
      
      const node = {
        id: p.id,
        ring: p.ring,
        name: p.name,
        isCore: p.isCore,
        alive: p.alive,
        level: level
      };

      const father = p.fatherId ? getPigeonById(p.fatherId) : null;
      const mother = p.motherId ? getPigeonById(p.motherId) : null;

      node.father = father ? buildTree(father, level + 1, maxLevel) : null;
      node.mother = mother ? buildTree(mother, level + 1, maxLevel) : null;

      return node;
    }

    const tree = buildTree(pigeon);
    if (!tree) {
      dPedigreeTree.innerHTML = '<span class="muted">ÊöÇÊó†Ë°ÄÁªüÊ†ëÊï∞ÊçÆÔºàÈúÄË¶ÅËÆæÁΩÆÁà∂È∏ΩÂíåÊØçÈ∏Ω‰ø°ÊÅØÔºâ„ÄÇ</span>';
      return;
    }

    // Ê∏≤ÊüìÊ†ëÁªìÊûÑ
    function renderNode(node, container) {
      if (!node) return;

      const nodeEl = document.createElement('div');
      nodeEl.className = 'pedigree-node' + (node.isCore ? ' core' : '');
      nodeEl.textContent = `${node.ring}${node.name ? 'Ôºà' + node.name + 'Ôºâ' : ''}`;
      if (!node.alive) nodeEl.textContent += ' [Â∑≤Ê≠ª‰∫°]';
      nodeEl.onclick = () => {
        if (node.id !== currentDetailId) {
          openDetail(node.id);
        }
      };
      container.appendChild(nodeEl);

      if (node.father || node.mother) {
        const childrenContainer = document.createElement('div');
        childrenContainer.style.cssText = 'display:flex; gap:16px; margin-top:8px; justify-content:center;';
        
        if (node.father) {
          const fatherContainer = document.createElement('div');
          fatherContainer.style.cssText = 'text-align:center;';
          const fatherLabel = document.createElement('div');
          fatherLabel.textContent = 'Áà∂';
          fatherLabel.style.cssText = 'font-size:12px; color:#888; margin-bottom:4px;';
          fatherContainer.appendChild(fatherLabel);
          renderNode(node.father, fatherContainer);
          childrenContainer.appendChild(fatherContainer);
        }
        
        if (node.mother) {
          const motherContainer = document.createElement('div');
          motherContainer.style.cssText = 'text-align:center;';
          const motherLabel = document.createElement('div');
          motherLabel.textContent = 'ÊØç';
          motherLabel.style.cssText = 'font-size:12px; color:#888; margin-bottom:4px;';
          motherContainer.appendChild(motherLabel);
          renderNode(node.mother, motherContainer);
          childrenContainer.appendChild(motherContainer);
        }
        
        container.appendChild(childrenContainer);
      }
    }

    const treeContainer = document.createElement('div');
    treeContainer.style.cssText = 'text-align:center;';
    const currentLabel = document.createElement('div');
    currentLabel.textContent = 'ÂΩìÂâçÈ∏ΩÂ≠ê';
    currentLabel.style.cssText = 'font-size:14px; font-weight:600; color:#2b5cff; margin-bottom:8px;';
    treeContainer.appendChild(currentLabel);
    renderNode(tree, treeContainer);
    dPedigreeTree.appendChild(treeContainer);
  }

  // ‰øùÂ≠òÁºñËæëË°®ÂçïÁöÑÂàùÂßãÁä∂ÊÄÅÔºåÁî®‰∫éÊ£ÄÊµãÊòØÂê¶ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥Êîπ
  let editFormInitialState = null;
  let isEditFormDirty = false;

  // Ëé∑ÂèñÁºñËæëË°®ÂçïÁöÑÂΩìÂâçÁä∂ÊÄÅ
  function getEditFormState() {
    const p = getPigeonById(currentDetailId);
    if (!p) return null;
    
    return {
      name: document.getElementById('e_name')?.value.trim() || '',
      ring: document.getElementById('e_ring')?.value.trim() || '',
      gender: document.getElementById('e_gender')?.value || '',
      color: document.getElementById('e_color')?.value.trim() || '',
      birth: document.getElementById('e_birth')?.value || '',
      type: document.getElementById('e_type')?.value || '',
      isCore: document.getElementById('e_core')?.checked || false,
      previousOwner: document.getElementById('e_previousOwner')?.value.trim() || '',
      previousRegion: document.getElementById('e_previousRegion')?.value.trim() || '',
      currentOwner: document.getElementById('e_currentOwner')?.value.trim() || '',
      currentRegion: document.getElementById('e_currentRegion')?.value.trim() || '',
      fatherId: document.getElementById('e_father')?.value || null,
      motherId: document.getElementById('e_mother')?.value || null,
      alive: document.querySelector('input[name="e_alive"]:checked')?.value === 'alive',
      deathDate: document.getElementById('e_death_date')?.value || null,
      deathReason: document.getElementById('e_death_reason')?.value.trim() || '',
      bodyPhoto: document.getElementById('e_body_photo')?.files.length > 0,
      eyePhoto: document.getElementById('e_eye_photo')?.files.length > 0,
      races: Array.from(document.querySelectorAll('#e_raceList .race-item')).map(item => {
        try {
          return item.getValue ? item.getValue() : null;
        } catch (e) {
          return null;
        }
      }).filter(r => r !== null)
    };
  }

  // Ê£ÄÊµãÁºñËæëË°®ÂçïÊòØÂê¶ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥Êîπ
  function hasUnsavedChanges() {
    if (!editFormInitialState) return false;
    
    const currentState = getEditFormState();
    if (!currentState) return false;
    
    // ÊØîËæÉÊâÄÊúâÂ≠óÊÆµ
    const fields = ['name', 'ring', 'gender', 'color', 'birth', 'type', 'isCore', 
                    'previousOwner', 'previousRegion', 'currentOwner', 'currentRegion',
                    'fatherId', 'motherId', 'alive', 'deathDate', 'deathReason'];
    
    for (let field of fields) {
      if (editFormInitialState[field] !== currentState[field]) {
        return true;
      }
    }
    
    // Ê£ÄÊü•ÂõæÁâáÊòØÂê¶ÊúâÂèòÂåñ
    if (editFormInitialState.bodyPhoto !== currentState.bodyPhoto ||
        editFormInitialState.eyePhoto !== currentState.eyePhoto) {
      return true;
    }
    
    // Ê£ÄÊü•ÂèÇËµõËÆ∞ÂΩïÊòØÂê¶ÊúâÂèòÂåñ
    if (editFormInitialState.races.length !== currentState.races.length) {
      return true;
    }
    
    // ËØ¶ÁªÜÊØîËæÉÂèÇËµõËÆ∞ÂΩï
    for (let i = 0; i < Math.max(editFormInitialState.races.length, currentState.races.length); i++) {
      const oldRace = editFormInitialState.races[i];
      const newRace = currentState.races[i];
      if (!oldRace || !newRace) return true;
      if (JSON.stringify(oldRace) !== JSON.stringify(newRace)) {
        return true;
      }
    }
    
    return false;
  }

  // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ÈÄÄÂá∫ÁºñËæëÊ®°Âºè
  function canExitEditMode() {
    if (hasUnsavedChanges()) {
      return confirm('ÊÇ®ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥ÊîπÔºåÁ°ÆÂÆöË¶ÅÈÄÄÂá∫ÁºñËæëÈ°µÈù¢ÂêóÔºü\n\nÂ¶ÇÊûúÈÄÄÂá∫ÔºåÊâÄÊúâÊú™‰øùÂ≠òÁöÑÊõ¥ÊîπÂ∞Ü‰ºö‰∏¢Â§±„ÄÇ');
    }
    return true;
  }

  function setEditMode(isEdit) {
    if (isEdit) {
      browseMode.style.display = 'none';
      editMode.style.display = '';
      dEditNotice.style.display = '';
      btnToggleEdit.textContent = '‚Üê ËøîÂõûÊµèËßà';
      fillEditForm();
      // Âª∂Ëøü‰øùÂ≠òÂàùÂßãÁä∂ÊÄÅÔºåÁ°Æ‰øùË°®ÂçïÂ∑≤ÂÆåÂÖ®Â°´ÂÖÖÔºàÂåÖÊã¨Âä®ÊÄÅÊ∑ªÂä†ÁöÑÂèÇËµõËÆ∞ÂΩïÔºâ
      setTimeout(() => {
        editFormInitialState = getEditFormState();
        isEditFormDirty = false;
      }, 200);
      
      // ÁõëÂê¨Ë°®ÂçïÂèòÂåñ
      const editFormInputs = editMode.querySelectorAll('input, select, textarea');
      editFormInputs.forEach(input => {
        input.addEventListener('change', () => {
          isEditFormDirty = hasUnsavedChanges();
        });
        input.addEventListener('input', () => {
          isEditFormDirty = hasUnsavedChanges();
        });
      });
      
      // ÁõëÂê¨Âä®ÊÄÅÊ∑ªÂä†ÁöÑÂèÇËµõËÆ∞ÂΩïÂèòÂåñ
      const eRaceList = document.getElementById('e_raceList');
      if (eRaceList) {
        const observer = new MutationObserver(() => {
          isEditFormDirty = hasUnsavedChanges();
        });
        observer.observe(eRaceList, { childList: true, subtree: true });
      }
    } else {
      // ÈÄÄÂá∫ÁºñËæëÊ®°ÂºèÂâçÊ£ÄÊü•ÊòØÂê¶ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥Êîπ
      if (!canExitEditMode()) {
        return; // Áî®Êà∑ÂèñÊ∂àÈÄÄÂá∫
      }
      browseMode.style.display = '';
      editMode.style.display = 'none';
      dEditNotice.style.display = 'none';
      btnToggleEdit.textContent = '‚úè ÁºñËæë‰ø°ÊÅØ';
      editFormInitialState = null;
      isEditFormDirty = false;
    }
  }

  btnToggleEdit.onclick = () => {
    const editing = editMode.style.display !== 'none';
    if (editing) {
      // ‰ΩøÁî®Áªü‰∏ÄÁöÑÈÄÄÂá∫Ê£ÄÊü•ÂáΩÊï∞
      if (!canExitEditMode()) return;
      setEditMode(false);
    } else {
      setEditMode(true);
    }
  };

  document.getElementById('btnBackList').onclick = () => {
    if (editMode.style.display !== 'none') {
      // ‰ΩøÁî®Áªü‰∏ÄÁöÑÈÄÄÂá∫Ê£ÄÊü•ÂáΩÊï∞
      if (!canExitEditMode()) return;
      setEditMode(false);
    }
    switchView('listView');
  };

  // Âà†Èô§È∏ΩÂ≠êÂäüËÉΩ
  document.getElementById('btnDeletePigeon').onclick = () => {
    const p = getPigeonById(currentDetailId);
    if (!p) return;
    
    if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§„Äê${p.ring}${p.name ? 'Ôºà' + p.name + 'Ôºâ' : ''}„ÄëÁöÑÊâÄÊúâ‰ø°ÊÅØÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
      return;
    }

    const index = pigeons.findIndex(p2 => p2.id === currentDetailId);
    if (index !== -1) {
      pigeons.splice(index, 1);
      saveToStorage();
      refreshList();
      refreshStats();
      refreshDashboard();
      refreshPedigreeView(); // Âà∑Êñ∞Ë°ÄÁªüÂÖ≥Á≥ªËßÜÂõæ
      alert('Â∑≤Âà†Èô§ËØ•È∏ΩÂ≠êÁöÑÊâÄÊúâ‰ø°ÊÅØ„ÄÇ');
      switchView('listView');
    }
  };

  function fillEditForm() {
    const p = getPigeonById(currentDetailId);
    if (!p) return;

    document.getElementById('e_name').value = p.name || '';
    document.getElementById('e_ring').value = p.ring;
    document.getElementById('e_gender').value = p.gender || '';
    document.getElementById('e_color').value = p.color || '';
    document.getElementById('e_birth').value = p.birth || '';
    document.getElementById('e_type').value = p.type || '';
    const eCore = document.getElementById('e_core');
    if (eCore) eCore.checked = !!p.isCore;

    // ÁßçÈ∏ΩÁ±ªÂûãÂàáÊç¢ÔºöÊòæÁ§∫/ÈöêËóèÂâçÈ∏Ω‰∏ªÂíåÂâçÂú∞Âå∫Â≠óÊÆµ
    const typeSelect = document.getElementById('e_type');
    const breederExtra = document.getElementById('e_breederExtra');
    const breederExtraDesc = document.getElementById('e_breederExtraDesc');
    const breederExtraFields = document.getElementById('e_breederExtraFields');
    
    function toggleBreederFields() {
      const isBreeder = typeSelect.value === 'ÁßçÈ∏Ω';
      if (breederExtra) breederExtra.style.display = isBreeder ? '' : 'none';
      if (breederExtraDesc) breederExtraDesc.style.display = isBreeder ? '' : 'none';
      if (breederExtraFields) breederExtraFields.style.display = isBreeder ? '' : 'none';
    }
    
    typeSelect.addEventListener('change', toggleBreederFields);
    toggleBreederFields();
    
    // Â°´ÂÖÖÁßçÈ∏Ω‰∏ìÁî®‰ø°ÊÅØ
    if (document.getElementById('e_previousOwner')) {
      document.getElementById('e_previousOwner').value = p.previousOwner || '';
    }
    if (document.getElementById('e_previousRegion')) {
      document.getElementById('e_previousRegion').value = p.previousRegion || '';
    }
    
    // Â°´ÂÖÖÁé∞È∏Ω‰∏ªÂíåÁé∞Âú∞Âå∫
    if (document.getElementById('e_currentOwner')) {
      document.getElementById('e_currentOwner').value = p.currentOwner || '';
    }
    if (document.getElementById('e_currentRegion')) {
      document.getElementById('e_currentRegion').value = p.currentRegion || '';
    }
    
    // ÂàùÂßãÂåñÈ∏Ω‰∏ª‰∏ãÊãâÂàóË°®
    updateOwnerDatalist('e_ownerList');
    if (p.currentOwner) {
      updateRegionDatalist(p.currentOwner, 'e_regionList');
    }
    
    // Áé∞È∏Ω‰∏ªËæìÂÖ•ÂèòÂåñÊó∂Êõ¥Êñ∞Âú∞Âå∫‰∏ãÊãâÂàóË°®
    const currentOwnerInput = document.getElementById('e_currentOwner');
    const currentRegionInput = document.getElementById('e_currentRegion');
    
    if (currentOwnerInput) {
      function handleOwnerChangeEdit() {
        const owner = currentOwnerInput.value.trim();
        updateRegionDatalist(owner, 'e_regionList');
        
        // Â¶ÇÊûúÈÄâÊã©ÊùéÂõΩËæâÔºåËá™Âä®Â°´ÂÖÖË¥µÂ∑ûÈªîË•ø
        if (owner === 'ÊùéÂõΩËæâ') {
          if (currentRegionInput) currentRegionInput.value = 'Ë¥µÂ∑ûÈªîË•ø';
        }
      }
      
      currentOwnerInput.addEventListener('input', handleOwnerChangeEdit);
      currentOwnerInput.addEventListener('change', handleOwnerChangeEdit);
      
      // Áé∞È∏Ω‰∏ªÂíåÁé∞Âú∞Âå∫ÈÉΩÂ°´ÂÜôÂêéÔºåÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶Å‰øùÂ≠òÈÖçÂØπ
      let ownerRegionTimer = null;
      currentOwnerInput.addEventListener('input', () => {
        clearTimeout(ownerRegionTimer);
        ownerRegionTimer = setTimeout(() => {
          const owner = currentOwnerInput.value.trim();
          const region = currentRegionInput ? currentRegionInput.value.trim() : '';
          if (owner && region) {
            addOwnerRegionPair(owner, region);
            updateOwnerDatalist('e_ownerList');
            updateRegionDatalist(owner, 'e_regionList');
          }
        }, 1000);
      });
    }
    
    if (currentRegionInput) {
      let ownerRegionTimer = null;
      currentRegionInput.addEventListener('input', () => {
        clearTimeout(ownerRegionTimer);
        ownerRegionTimer = setTimeout(() => {
          const owner = currentOwnerInput ? currentOwnerInput.value.trim() : '';
          const region = currentRegionInput.value.trim();
          if (owner && region) {
            addOwnerRegionPair(owner, region);
            updateOwnerDatalist('e_ownerList');
            updateRegionDatalist(owner, 'e_regionList');
          }
        }, 1000);
      });
    }

    // Áà∂ÊØç‰∏ãÊãâ
    fillParentOptions(document.getElementById('e_father'), p.id);
    fillParentOptions(document.getElementById('e_mother'), p.id);
    document.getElementById('e_father').value = p.fatherId || '';
    document.getElementById('e_mother').value = p.motherId || '';

    // Áä∂ÊÄÅ
    const aliveRadios = document.querySelectorAll('input[name="e_alive"]');
    aliveRadios.forEach(r => {
      r.checked = (r.value === (p.alive ? 'alive' : 'dead'));
    });
    const deathExtras = document.querySelectorAll('.e-death-extra');
    if (p.alive) {
      deathExtras.forEach(el => el.style.display = 'none');
      document.getElementById('e_death_date').value = '';
      document.getElementById('e_death_reason').value = '';
    } else {
      deathExtras.forEach(el => el.style.display = '');
      document.getElementById('e_death_date').value = p.deathDate || '';
      document.getElementById('e_death_reason').value = p.deathReason || '';
    }
    aliveRadios.forEach(r => {
      r.onchange = () => {
        if (r.checked && r.value === 'dead') {
          deathExtras.forEach(el => el.style.display = '');
        } else if (r.checked && r.value === 'alive') {
          deathExtras.forEach(el => el.style.display = 'none');
        }
      };
    });

    // ÂèÇËµõËÆ∞ÂΩï
    const eRaceList = document.getElementById('e_raceList');
    eRaceList.innerHTML = '';
    (p.races || []).forEach((r, index) => {
      createRaceFormItem(eRaceList, r, () => {
        p.races.splice(index, 1);
      });
    });
  }

  document.getElementById('btnAddRaceEdit').onclick = () => {
    const eRaceList = document.getElementById('e_raceList');
    createRaceFormItem(eRaceList);
  };

  document.getElementById('btnCancelEdit').onclick = () => {
    // ‰ΩøÁî®Áªü‰∏ÄÁöÑÈÄÄÂá∫Ê£ÄÊü•ÂáΩÊï∞
    if (!canExitEditMode()) return;
    setEditMode(false);
  };

  document.getElementById('btnSaveEdit').onclick = async () => {
    const p = getPigeonById(currentDetailId);
    if (!p) return;

    // Ê£ÄÊü•Ë∂≥ÁéØÂè∑ÊòØÂê¶‰øÆÊîπ
    const newRing = document.getElementById('e_ring').value.trim();
    if (!newRing) {
      alert('Ë∂≥ÁéØÂè∑Á†Å‰∏∫ÂøÖÂ°´È°π„ÄÇ');
      return;
    }
    
    // Â¶ÇÊûúË∂≥ÁéØÂè∑Ë¢´‰øÆÊîπÔºåÊ£ÄÊü•Êñ∞Âè∑Á†ÅÊòØÂê¶Â∑≤Ë¢´ÂÖ∂‰ªñÊ¥ªÁùÄÁöÑÈ∏ΩÂ≠ê‰ΩøÁî®
    if (newRing !== p.ring) {
      const existingAlive = getPigeonByRing(newRing);
      if (existingAlive && existingAlive.id !== p.id) {
        alert('ËØ•Ë∂≥ÁéØÂè∑Á†ÅÂ∑≤Ë¢´ÂÖ∂‰ªñÊ¥ªÁùÄÁöÑÈ∏ΩÂ≠ê‰ΩøÁî®ÔºåËØ∑‰ΩøÁî®ÂÖ∂‰ªñÂè∑Á†Å„ÄÇ');
        return;
      }
    }

    const name = document.getElementById('e_name').value.trim();
    const gender = document.getElementById('e_gender').value;
    const color = document.getElementById('e_color').value.trim();
    const birth = document.getElementById('e_birth').value;
    const type = document.getElementById('e_type').value;
    const fatherId = document.getElementById('e_father').value || null;
    const motherId = document.getElementById('e_mother').value || null;
    const aliveRadio = document.querySelector('input[name="e_alive"]:checked').value;
    const alive = aliveRadio === 'alive';
    const deathDate = alive ? null : document.getElementById('e_death_date').value;
    const deathReason = alive ? '' : document.getElementById('e_death_reason').value.trim();
    if (!alive && !deathDate) {
      alert('Â∑≤Ê≠ª‰∫°Áä∂ÊÄÅ‰∏ãÔºåÊ≠ª‰∫°Êó•Êúü‰∏∫ÂøÖÂ°´„ÄÇ');
      return;
    }
    
    // Ëé∑ÂèñÁßçÈ∏Ω‰∏ìÁî®‰ø°ÊÅØ
    const previousOwner = type === 'ÁßçÈ∏Ω' ? (document.getElementById('e_previousOwner')?.value.trim() || '') : '';
    const previousRegion = type === 'ÁßçÈ∏Ω' ? (document.getElementById('e_previousRegion')?.value.trim() || '') : '';
    
    // Ëé∑ÂèñÁé∞È∏Ω‰∏ªÂíåÁé∞Âú∞Âå∫
    const currentOwner = document.getElementById('e_currentOwner')?.value.trim() || '';
    const currentRegion = document.getElementById('e_currentRegion')?.value.trim() || '';
    
    // ËÆ∞ÂΩïÈ∏Ω‰∏ª-Âú∞Âå∫ÈÖçÂØπ
    if (currentOwner && currentRegion) {
      addOwnerRegionPair(currentOwner, currentRegion);
    }

    const eRaceList = document.getElementById('e_raceList');
    const races = [];
    eRaceList.querySelectorAll('.race-item').forEach(item => {
      races.push(item.getValue());
    });

    const bodyFile = document.getElementById('e_body_photo').files[0] || null;
    const eyeFile = document.getElementById('e_eye_photo').files[0] || null;

    // ÂàùÂßãÂåñÂõæÁâáÂØπË±°Ôºå‰øùÁïôÂéüÊúâÂõæÁâá
    if (!p.images) p.images = {};
    
    // Â¶ÇÊûúÊúâÊñ∞‰∏ä‰º†ÁöÑÁ´ôÁ´ã‰æßË∫´ÂõæÔºåÂàôÊõ¥Êñ∞ÔºõÂê¶Âàô‰øùÁïôÂéüÊúâÂõæÁâá
    if (bodyFile) {
      try {
        if (!bodyFile.type || !bodyFile.type.startsWith('image/')) {
          alert('Á´ôÁ´ã‰æßË∫´ÂõæÁâáÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂ÔºàJPG„ÄÅPNG„ÄÅGIF„ÄÅWEBPÁ≠âÔºâ„ÄÇ');
          return;
        }
        p.images.body = await readFileAsDataURL(bodyFile);
      } catch (e) {
        console.error('Êõ¥Êñ∞Á´ôÁ´ã‰æßË∫´ÂõæÁâáÂ§±Ë¥•', e);
        alert('Êõ¥Êñ∞Á´ôÁ´ã‰æßË∫´ÂõæÁâáÂ§±Ë¥•Ôºö' + (e.message || 'Êú™Áü•ÈîôËØØ') + 'ÔºåËØ∑ÈáçËØï„ÄÇ');
        return;
      }
    }
    
    // Â¶ÇÊûúÊúâÊñ∞‰∏ä‰º†ÁöÑÁúºÁùõÂõæÔºåÂàôÊõ¥Êñ∞ÔºõÂê¶Âàô‰øùÁïôÂéüÊúâÂõæÁâá
    if (eyeFile) {
      try {
        if (!eyeFile.type || !eyeFile.type.startsWith('image/')) {
          alert('ÁúºÁùõÁâπÂÜôÂõæÁâáÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂ÔºàJPG„ÄÅPNG„ÄÅGIF„ÄÅWEBPÁ≠âÔºâ„ÄÇ');
          return;
        }
        p.images.eye = await readFileAsDataURL(eyeFile);
      } catch (e) {
        console.error('Êõ¥Êñ∞ÁúºÁùõÂõæÁâáÂ§±Ë¥•', e);
        alert('Êõ¥Êñ∞ÁúºÁùõÂõæÁâáÂ§±Ë¥•Ôºö' + (e.message || 'Êú™Áü•ÈîôËØØ') + 'ÔºåËØ∑ÈáçËØï„ÄÇ');
        return;
      }
    }

    p.ring = newRing; // Êõ¥Êñ∞Ë∂≥ÁéØÂè∑
    p.name = name;
    p.gender = gender;
    p.color = color;
    p.birth = birth;
    p.type = type;
    p.fatherId = fatherId;
    p.motherId = motherId;
    p.alive = alive;
    p.deathDate = deathDate;
    p.deathReason = deathReason;
    p.races = races;
    p.isCore = !!document.getElementById('e_core')?.checked;
    p.previousOwner = previousOwner; // ÂâçÈ∏Ω‰∏ªÔºà‰ªÖÁßçÈ∏ΩÔºâ
    p.previousRegion = previousRegion; // ÂâçÂú∞Âå∫Ôºà‰ªÖÁßçÈ∏ΩÔºâ
    p.currentOwner = currentOwner; // Áé∞È∏Ω‰∏ª
    p.currentRegion = currentRegion; // Áé∞Âú∞Âå∫

    saveToStorage();
    alert('‰øùÂ≠òÊàêÂäüÔºåÊ°£Ê°àÂ∑≤Êõ¥Êñ∞„ÄÇ');
    refreshList();
    renderDetail();
    refreshStats();
    refreshDashboard();
    refreshPedigreeView(); // Âà∑Êñ∞Ë°ÄÁªüÂÖ≥Á≥ªËßÜÂõæ
    // Ê∏ÖÈô§Êú™‰øùÂ≠òÁä∂ÊÄÅÊ†áËÆ∞
    editFormInitialState = null;
    isEditFormDirty = false;
    setEditMode(false);
  };

  // ÂàùÂßãÂåñÂØºËà™ÁÇπÂáª
  navButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const view = btn.dataset.view;
      if (view === 'listView') {
        switchView('listView');
      } else if (view === 'createView') {
        setupCreateForm();
        switchView('createView');
      } else if (view === 'statsView') {
        refreshStats();
        switchView('statsView');
      }
    });
  });

  // Ë∂≥ÁéØÂè∑ÊêúÁ¥¢ÂäüËÉΩÂ∑≤Êï¥ÂêàÂà∞Êô∫ËÉΩÊêúÁ¥¢‰∏≠

  // ‰æßËæπÊ†èËèúÂçïÁÇπÂáª‰∫ã‰ª∂Ôºà‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÔºåÊõ¥ÂèØÈù†Ôºâ
  let sidebarEventsBound = false;
  
  function bindSidebarEvents() {
    // Â¶ÇÊûúÂ∑≤ÁªèÁªëÂÆöËøáÔºå‰∏çÂÜçÈáçÂ§çÁªëÂÆö
    if (sidebarEventsBound) {
      return;
    }
    
    const sidebarMenu = document.querySelector('.sidebar-menu');
    if (!sidebarMenu) {
      console.warn('‰æßËæπÊ†èËèúÂçïÊú™ÊâæÂà∞ÔºåÂª∂ËøüÈáçËØï...');
      setTimeout(bindSidebarEvents, 100);
      return;
    }
    
    // Ê†áËÆ∞‰∏∫Â∑≤ÁªëÂÆö
    sidebarEventsBound = true;
    console.log('ÂºÄÂßãÁªëÂÆö‰æßËæπÊ†è‰∫ã‰ª∂...');
    
    // Ê£ÄÊü•ÊâÄÊúâËèúÂçïÈ°π
    const sidebarItems = sidebarMenu.querySelectorAll('.sidebar-item');
    console.log('ÊâæÂà∞ËèúÂçïÈ°πÊï∞Èáè:', sidebarItems.length);
    sidebarItems.forEach((item, index) => {
      console.log(`ËèúÂçïÈ°π ${index + 1}:`, item.dataset.view, item.textContent.trim());
    });
    
    // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÔºåÂú®Áà∂ÂÖÉÁ¥†‰∏äÁõëÂê¨ÁÇπÂáª‰∫ã‰ª∂
    sidebarMenu.addEventListener('click', function(e) {
      console.log('‰æßËæπÊ†èËèúÂçïË¢´ÁÇπÂáªÔºåÁõÆÊ†áÂÖÉÁ¥†:', e.target.tagName, e.target.className);
      // Êü•ÊâæË¢´ÁÇπÂáªÁöÑ‰æßËæπÊ†èÈ°πÔºà‰ΩøÁî®closestÊñπÊ≥ïÊõ¥ÂèØÈù†Ôºâ
      const sidebarItem = e.target.closest('.sidebar-item');
      
      if (sidebarItem) {
        e.preventDefault();
        e.stopPropagation();
        
        const view = sidebarItem.dataset.view;
        const openFeedback = sidebarItem.dataset.openFeedback;
        
        console.log('ÁÇπÂáª‰∫ÜËèúÂçïÈ°π:', view || openFeedback, sidebarItem.textContent.trim());
        
        if (view) {
          try {
            if (typeof switchView === 'function') {
              switchView(view);
              console.log('ËßÜÂõæÂàáÊç¢ÊàêÂäü:', view);
            } else {
              console.error('switchView ÂáΩÊï∞Êú™ÂÆö‰πâ');
            }
          } catch (error) {
            console.error('ËßÜÂõæÂàáÊç¢Â§±Ë¥•:', error);
            alert('ÂàáÊç¢ËßÜÂõæÊó∂Âá∫Èîô: ' + error.message);
          }
        } else if (openFeedback === 'true') {
          // ÊâìÂºÄÊÑèËßÅÂèçÈ¶àÂØπËØùÊ°Ü
          const feedbackModal = document.getElementById('feedbackModal');
          if (feedbackModal) {
            feedbackModal.style.display = 'flex';
            console.log('ÊâìÂºÄÊÑèËßÅÂèçÈ¶àÂØπËØùÊ°Ü');
          } else {
            console.warn('ÊÑèËßÅÂèçÈ¶àÂØπËØùÊ°ÜÊú™ÊâæÂà∞');
          }
        } else {
          console.warn('ËèúÂçïÈ°πÁº∫Â∞ë data-view Êàñ data-open-feedback Â±ûÊÄß:', sidebarItem);
        }
      }
    }); // ‰ΩøÁî®ÂÜíÊ≥°Èò∂ÊÆµÔºàÈªòËÆ§Ôºâ
    
    console.log('‰æßËæπÊ†è‰∫ã‰ª∂ÁªëÂÆöÂÆåÊàê');
  }
  
  // Á≠âÂæÖDOMÂä†ËΩΩÂÆåÊàêÂêéÁªëÂÆö‰æßËæπÊ†è‰∫ã‰ª∂
  function initSidebarEvents() {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', bindSidebarEvents);
    } else {
      // DOMÂ∑≤ÁªèÂä†ËΩΩÂÆåÊàêÔºåÁ´ãÂç≥ÁªëÂÆö
      bindSidebarEvents();
    }
    
    // Âª∂ËøüÂÜçÊ¨°Á°Æ‰øùÁªëÂÆöÔºàÂ§áÁî®ÊñπÊ°àÔºâ
    setTimeout(() => {
      if (!sidebarEventsBound) {
        console.log('Âª∂ËøüÁªëÂÆö‰æßËæπÊ†è‰∫ã‰ª∂...');
        bindSidebarEvents();
      }
    }, 500);
    
    // ÂÜçÊ¨°Âª∂ËøüÁªëÂÆöÔºåÁ°Æ‰øùÊâÄÊúâÂÖÉÁ¥†ÈÉΩÂ∑≤Âä†ËΩΩ
    setTimeout(() => {
      if (!sidebarEventsBound) {
        console.log('ÊúÄÁªàÂ∞ùËØïÁªëÂÆö‰æßËæπÊ†è‰∫ã‰ª∂...');
        bindSidebarEvents();
      }
    }, 1000);
  }
  
  // ÂàùÂßãÂåñ‰æßËæπÊ†è‰∫ã‰ª∂
  initSidebarEvents();
  
  // Á°Æ‰øù‰æßËæπÊ†èÈ°πÁõÆÂèØ‰ª•ÁÇπÂáªÔºàÊ∑ªÂä†Áõ¥Êé•‰∫ã‰ª∂ÁªëÂÆö‰Ωú‰∏∫Â§áÁî®Ôºâ
  function bindSidebarItemsDirectly() {
    const sidebarItems = document.querySelectorAll('.sidebar-item');
    sidebarItems.forEach(item => {
      // ÁßªÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÊóß‰∫ã‰ª∂ÁõëÂê¨Âô®
      const newItem = item.cloneNode(true);
      item.parentNode.replaceChild(newItem, item);
      
      // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
      newItem.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const view = newItem.dataset.view;
        const openFeedback = newItem.dataset.openFeedback;
        
        if (view) {
          console.log('Áõ¥Êé•ÁÇπÂáª‰æßËæπÊ†èÈ°π:', view);
          if (typeof switchView === 'function') {
            switchView(view);
          }
        } else if (openFeedback === 'true') {
          // ÊâìÂºÄÂèçÈ¶àÂØπËØùÊ°Ü
          const feedbackModal = document.getElementById('feedbackModal');
          if (feedbackModal) {
            feedbackModal.style.display = 'flex';
          }
        }
      });
    });
    console.log('‰æßËæπÊ†èÈ°πÁõÆÁõ¥Êé•‰∫ã‰ª∂ÁªëÂÆöÂÆåÊàêÔºåÂÖ±', sidebarItems.length, 'È°π');
  }
  
  // Âª∂ËøüÁªëÂÆöÁõ¥Êé•‰∫ã‰ª∂
  setTimeout(bindSidebarItemsDirectly, 100);
  setTimeout(bindSidebarItemsDirectly, 500);
  setTimeout(bindSidebarItemsDirectly, 1000);

  // ËßÜÂõæÂàáÊç¢ÊåâÈíÆ‰∫ã‰ª∂
  const btnTableView = document.getElementById('btnTableView');
  const btnCardView = document.getElementById('btnCardView');
  const tableView = document.getElementById('tableView');
  const cardView = document.getElementById('cardView');
  
  if (btnTableView && btnCardView) {
    btnTableView.addEventListener('click', () => {
      currentListView = 'table';
      if (tableView) tableView.style.display = '';
      if (cardView) cardView.style.display = 'none';
      btnTableView.classList.add('active');
      btnCardView.classList.remove('active');
    });
    
    btnCardView.addEventListener('click', () => {
      currentListView = 'card';
      if (tableView) tableView.style.display = 'none';
      if (cardView) cardView.style.display = '';
      btnCardView.classList.add('active');
      btnTableView.classList.remove('active');
      renderCardView();
    });
  }

  // ==================== Ë°ÄÁªüÂÖ≥Á≥ªÊ†ëÂäüËÉΩ ====================
  const pedigreeTreeContainer = document.getElementById('pedigreeTreeContainer');
  const pedigreeSelectPigeon = document.getElementById('pedigreeSelectPigeon');
  
  // Ëé∑ÂèñÊâÄÊúâÂ≠ê‰ª£È∏ΩÂ≠ê
  function getChildren(pigeonId) {
    return pigeons.filter(p => p.fatherId === pigeonId || p.motherId === pigeonId);
  }
  
  // ÊûÑÂª∫ÂÆåÊï¥ÁöÑË°ÄÁªüÊ†ëÔºàÂåÖÊã¨‰∫≤‰ª£ÂíåÂ≠ê‰ª£Ôºâ
  function buildFullPedigreeTree(pigeon, visited = new Set(), maxAncestorLevel = 5, currentAncestorLevel = 0) {
    if (!pigeon) return null;
    
    // Èò≤Ê≠¢Âæ™ÁéØÂºïÁî®
    if (visited.has(pigeon.id)) {
      return {
        id: pigeon.id,
        ring: pigeon.ring,
        name: pigeon.name || pigeon.ring,
        isCore: pigeon.isCore,
        alive: pigeon.alive,
        type: pigeon.type,
        father: null,
        mother: null,
        children: [],
        isCircular: true
      };
    }
    
    const newVisited = new Set(visited);
    newVisited.add(pigeon.id);
    
    const tree = {
      id: pigeon.id,
      ring: pigeon.ring,
      name: pigeon.name || pigeon.ring,
      isCore: pigeon.isCore,
      alive: pigeon.alive,
      type: pigeon.type,
      father: null,
      mother: null,
      children: []
    };
    
    // ÊûÑÂª∫‰∫≤‰ª£ÔºàÂêë‰∏äÔºâ- ÈôêÂà∂Ê∑±Â∫¶Èò≤Ê≠¢Êó†ÈôêÈÄíÂΩí
    if (currentAncestorLevel < maxAncestorLevel) {
      if (pigeon.fatherId) {
        const father = getPigeonById(pigeon.fatherId);
        if (father && father.id !== pigeon.id) {
          tree.father = buildFullPedigreeTree(father, newVisited, maxAncestorLevel, currentAncestorLevel + 1);
        }
      }
      
      if (pigeon.motherId) {
        const mother = getPigeonById(pigeon.motherId);
        if (mother && mother.id !== pigeon.id) {
          tree.mother = buildFullPedigreeTree(mother, newVisited, maxAncestorLevel, currentAncestorLevel + 1);
        }
      }
    }
    
    // ÊûÑÂª∫Â≠ê‰ª£ÔºàÂêë‰∏ãÔºâ- ‰∏çÈÄíÂΩíÂ≠ê‰ª£ÁöÑÂ≠ê‰ª£ÔºåÂè™ÊòæÁ§∫Áõ¥Êé•Â≠ê‰ª£
    const children = getChildren(pigeon.id);
    tree.children = children
      .filter(child => child.id !== pigeon.id) // Èò≤Ê≠¢Ëá™ÂºïÁî®
      .map(child => ({
        id: child.id,
        ring: child.ring,
        name: child.name || child.ring,
        isCore: child.isCore,
        alive: child.alive,
        type: child.type,
        father: null,
        mother: null,
        children: [] // Â≠ê‰ª£‰∏çÂÜçÈÄíÂΩíÊòæÁ§∫ÂÖ∂Â≠ê‰ª£ÔºåÈÅøÂÖçÊ†ëËøáÂ§ß
      }));
    
    return tree;
  }
  
  // Ê∏≤ÊüìÂÆåÊï¥ÁöÑË°ÄÁªüÊ†ë
  function renderFullPedigreeTree(pigeon) {
    if (!pedigreeTreeContainer) return;
    pedigreeTreeContainer.innerHTML = '';
    
    if (!pigeon) {
      pedigreeTreeContainer.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ËØ∑ÈÄâÊã©‰∏ÄÂè™È∏ΩÂ≠êÊü•ÁúãË°ÄÁªüÊ†ë</p>';
      return;
    }
    
    const tree = buildFullPedigreeTree(pigeon);
    if (!tree) {
      pedigreeTreeContainer.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ÊöÇÊó†Ë°ÄÁªüÊï∞ÊçÆ</p>';
      return;
    }
    
    const container = document.createElement('div');
    container.style.cssText = 'position:relative; min-height:600px; padding:30px;';
    
    // ÂàõÂª∫SVGÁî®‰∫éÁªòÂà∂ËøûÊé•Á∫ø
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.className = 'tree-connections';
    svg.setAttribute('width', '100%');
    svg.setAttribute('height', '100%');
    container.appendChild(svg);
    
    const contentDiv = document.createElement('div');
    contentDiv.style.cssText = 'position:relative; z-index:2;';
    container.appendChild(contentDiv);
    
    // Â≠òÂÇ®ËäÇÁÇπ‰ΩçÁΩÆ‰ø°ÊÅØÔºåÁî®‰∫éÁªòÂà∂ËøûÊé•Á∫ø
    const nodePositions = new Map();
    
    // Ê∏≤Êüì‰∫≤‰ª£ÔºàÂêë‰∏äÔºâ- ÊòæÁ§∫Áà∂È∏ΩÂíåÊØçÈ∏Ω
    if (tree.father || tree.mother) {
      const parentsSection = document.createElement('div');
      parentsSection.style.cssText = 'margin-bottom:50px; position:relative;';
      
      const sectionTitle = document.createElement('div');
      sectionTitle.className = 'tree-section-title';
      sectionTitle.textContent = 'üë®‚Äçüë© ‰∫≤‰ª£ÔºàÁà∂È∏ΩÂíåÊØçÈ∏ΩÔºâ';
      parentsSection.appendChild(sectionTitle);
      
      const parentsLevel = document.createElement('div');
      parentsLevel.className = 'tree-level-parents';
      parentsLevel.id = 'parents-level';
      
      if (tree.father) {
        const fatherContainer = document.createElement('div');
        fatherContainer.style.cssText = 'text-align:center; position:relative;';
        fatherContainer.id = 'father-container';
        const fatherLabel = document.createElement('div');
        fatherLabel.className = 'tree-parent-label father';
        fatherLabel.textContent = 'üë® Áà∂È∏Ω';
        fatherContainer.appendChild(fatherLabel);
        const fatherNode = createTreeNode(tree.father, '');
        fatherNode.id = 'father-node';
        fatherContainer.appendChild(fatherNode);
        parentsLevel.appendChild(fatherContainer);
      }
      
      if (tree.mother) {
        const motherContainer = document.createElement('div');
        motherContainer.style.cssText = 'text-align:center; position:relative;';
        motherContainer.id = 'mother-container';
        const motherLabel = document.createElement('div');
        motherLabel.className = 'tree-parent-label mother';
        motherLabel.textContent = 'üë© ÊØçÈ∏Ω';
        motherContainer.appendChild(motherLabel);
        const motherNode = createTreeNode(tree.mother, '');
        motherNode.id = 'mother-node';
        motherContainer.appendChild(motherNode);
        parentsLevel.appendChild(motherContainer);
      }
      
      parentsSection.appendChild(parentsLevel);
      contentDiv.appendChild(parentsSection);
    }
    
    // Ê∏≤ÊüìÂΩìÂâçÈ∏ΩÂ≠ê
    const currentSection = document.createElement('div');
    currentSection.className = 'tree-current';
    currentSection.id = 'current-section';
    const currentTitle = document.createElement('div');
    currentTitle.className = 'tree-section-title';
    currentTitle.textContent = '‚≠ê ÂΩìÂâçÈ∏ΩÂ≠ê';
    currentSection.appendChild(currentTitle);
    const currentNode = createTreeNode(tree, '');
    currentNode.id = 'current-node';
    currentNode.style.cssText = 'margin:20px auto; transform: scale(1.1);';
    currentSection.appendChild(currentNode);
    contentDiv.appendChild(currentSection);
    
    // Ê∏≤ÊüìÂ≠ê‰ª£ÔºàÂêë‰∏ãÔºâ- ‰ºòÂåñÂ§öÂ≠ê‰ª£ÊòæÁ§∫
    if (tree.children && tree.children.length > 0) {
      const childrenSection = document.createElement('div');
      childrenSection.style.cssText = 'margin-top:50px; position:relative;';
      
      const sectionTitle = document.createElement('div');
      sectionTitle.className = 'tree-section-title';
      sectionTitle.textContent = `üë∂ Â≠ê‰ª£Ë°ÄÁªüÔºàÂêë‰∏ãÔºåÂÖ±${tree.children.length}Âè™Ôºâ`;
      childrenSection.appendChild(sectionTitle);
      
      const childrenLevel = document.createElement('div');
      childrenLevel.className = 'tree-level-children';
      childrenLevel.id = 'children-level';
      
      // Ê†πÊçÆÂ≠ê‰ª£Êï∞ÈáèË∞ÉÊï¥Â∏ÉÂ±Ä
      const childrenCount = tree.children.length;
      if (childrenCount <= 4) {
        // Â∞ë‰∫éÁ≠â‰∫é4Âè™ÔºåÂçïË°åÊòæÁ§∫
        childrenLevel.style.cssText = 'display:flex; flex-wrap:wrap; gap:20px; justify-content:center; margin:20px 0;';
      } else if (childrenCount <= 8) {
        // 5-8Âè™Ôºå‰∏§Ë°åÊòæÁ§∫
        childrenLevel.style.cssText = 'display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; margin:20px 0; max-width:800px; margin-left:auto; margin-right:auto;';
      } else if (childrenCount <= 12) {
        // 9-12Âè™Ôºå‰∏âË°åÊòæÁ§∫
        childrenLevel.style.cssText = 'display:grid; grid-template-columns: repeat(4, 1fr); gap:14px; margin:20px 0; max-width:900px; margin-left:auto; margin-right:auto;';
      } else {
        // Ë∂ÖËøá12Âè™Ôºå‰ΩøÁî®Êõ¥Á¥ßÂáëÁöÑÁΩëÊ†ºÂ∏ÉÂ±Ä
        childrenLevel.style.cssText = 'display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:12px; margin:20px 0; max-width:1000px; margin-left:auto; margin-right:auto;';
      }
      
      tree.children.forEach((child, index) => {
        const childNode = createTreeNode(child, '');
        childNode.id = `child-node-${index}`;
        // Â¶ÇÊûúÂ≠ê‰ª£ÂæàÂ§öÔºåÁ®çÂæÆÁº©Â∞èËäÇÁÇπ
        if (childrenCount > 8) {
          childNode.style.cssText = 'transform: scale(0.9);';
        }
        childrenLevel.appendChild(childNode);
      });
      
      childrenSection.appendChild(childrenLevel);
      contentDiv.appendChild(childrenSection);
    } else {
      const noChildren = document.createElement('div');
      noChildren.className = 'muted';
      noChildren.style.cssText = 'text-align:center;padding:40px;background:linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);border-radius:12px;margin:30px 0;border:2px dashed #d1d5db;';
      noChildren.innerHTML = '<div style="font-size:48px;margin-bottom:12px;">üë∂</div><div style="font-size:14px;color:#6b7280;">ÊöÇÊó†Â≠ê‰ª£ËÆ∞ÂΩï</div>';
      contentDiv.appendChild(noChildren);
    }
    
    pedigreeTreeContainer.appendChild(container);
    
    // ÁªòÂà∂ËøûÊé•Á∫øÔºàÂª∂ËøüÊâßË°å‰ª•Á°Æ‰øùDOMÂ∑≤Ê∏≤ÊüìÔºâ
    setTimeout(() => {
      drawTreeConnections(container, tree);
    }, 200);
    
    // Á™óÂè£Â§ßÂ∞èÊîπÂèòÊó∂ÈáçÊñ∞ÁªòÂà∂ËøûÊé•Á∫ø
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        if (pedigreeTreeContainer.contains(container)) {
          drawTreeConnections(container, tree);
        }
      }, 300);
    });
  }
  
  // ÁªòÂà∂Ê†ëÁä∂ÂõæËøûÊé•Á∫ø
  function drawTreeConnections(container, tree) {
    const svg = container.querySelector('.tree-connections');
    if (!svg) return;
    
    // Á≠âÂæÖDOMÂÆåÂÖ®Ê∏≤Êüì
    requestAnimationFrame(() => {
      // Ëé∑ÂèñÂÆπÂô®‰ΩçÁΩÆ
      const containerRect = container.getBoundingClientRect();
      const containerScrollTop = container.scrollTop || 0;
      const containerScrollLeft = container.scrollLeft || 0;
      
      // ËÆæÁΩÆSVGÂ∞∫ÂØ∏
      const containerHeight = container.scrollHeight || containerRect.height;
      const containerWidth = container.scrollWidth || containerRect.width;
      svg.setAttribute('width', containerWidth);
      svg.setAttribute('height', containerHeight);
      
      // Ê∏ÖÁ©∫‰πãÂâçÁöÑËøûÊé•Á∫ø
      svg.innerHTML = '';
      
      // ÁªòÂà∂Áà∂È∏ΩÂà∞ÂΩìÂâçÈ∏ΩÂ≠êÁöÑËøûÊé•Á∫ø
      const fatherNode = container.querySelector('#father-node');
      const motherNode = container.querySelector('#mother-node');
      const currentNode = container.querySelector('#current-node');
      
      if (fatherNode && currentNode) {
        const fatherRect = fatherNode.getBoundingClientRect();
        const currentRect = currentNode.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        
        const startX = fatherRect.left + fatherRect.width / 2 - containerRect.left;
        const startY = fatherRect.bottom - containerRect.top;
        const endX = currentRect.left + currentRect.width / 2 - containerRect.left;
        const endY = currentRect.top - containerRect.top;
        const midY = startY + (endY - startY) * 0.6;
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', `M ${startX} ${startY} Q ${startX} ${midY} ${(startX + endX) / 2} ${midY} T ${endX} ${endY}`);
        path.setAttribute('class', 'tree-connection');
        path.setAttribute('stroke', '#3b82f6');
        path.setAttribute('stroke-width', '2.5');
        path.setAttribute('fill', 'none');
        svg.appendChild(path);
      }
      
      if (motherNode && currentNode) {
        const motherRect = motherNode.getBoundingClientRect();
        const currentRect = currentNode.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        
        const startX = motherRect.left + motherRect.width / 2 - containerRect.left;
        const startY = motherRect.bottom - containerRect.top;
        const endX = currentRect.left + currentRect.width / 2 - containerRect.left;
        const endY = currentRect.top - containerRect.top;
        const midY = startY + (endY - startY) * 0.6;
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', `M ${startX} ${startY} Q ${startX} ${midY} ${(startX + endX) / 2} ${midY} T ${endX} ${endY}`);
        path.setAttribute('class', 'tree-connection');
        path.setAttribute('stroke', '#ec4899');
        path.setAttribute('stroke-width', '2.5');
        path.setAttribute('fill', 'none');
        svg.appendChild(path);
      }
      
      // ÁªòÂà∂ÂΩìÂâçÈ∏ΩÂ≠êÂà∞Â≠ê‰ª£ÁöÑËøûÊé•Á∫ø
      if (currentNode && tree.children && tree.children.length > 0) {
        const currentRect = currentNode.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        const startX = currentRect.left + currentRect.width / 2 - containerRect.left;
        const startY = currentRect.bottom - containerRect.top;
        
        tree.children.forEach((child, index) => {
          const childNode = container.querySelector(`#child-node-${index}`);
          if (childNode) {
            const childRect = childNode.getBoundingClientRect();
            const endX = childRect.left + childRect.width / 2 - containerRect.left;
            const endY = childRect.top - containerRect.top;
            const midY = startY + (endY - startY) * 0.4;
            
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', `M ${startX} ${startY} Q ${startX} ${midY} ${(startX + endX) / 2} ${midY} T ${endX} ${endY}`);
            path.setAttribute('class', 'tree-connection');
            path.setAttribute('stroke', '#10b981');
            path.setAttribute('stroke-width', '2');
            path.setAttribute('opacity', '0.6');
            path.setAttribute('fill', 'none');
            svg.appendChild(path);
          }
        });
      }
    });
  }
  
  // ÂàõÂª∫Ê†ëËäÇÁÇπ
  function createTreeNode(node, label) {
    const nodeDiv = document.createElement('div');
    nodeDiv.className = 'tree-node' + (node.isCore ? ' core' : '') + (node.alive ? '' : ' dead');
    
    const nameDiv = document.createElement('div');
    nameDiv.className = 'tree-node-name';
    nameDiv.textContent = node.name || node.ring;
    nodeDiv.appendChild(nameDiv);
    
    const ringDiv = document.createElement('div');
    ringDiv.className = 'tree-node-ring';
    ringDiv.textContent = node.ring;
    nodeDiv.appendChild(ringDiv);
    
    if (label) {
      const labelDiv = document.createElement('div');
      labelDiv.className = 'tree-node-label';
      labelDiv.textContent = label;
      nodeDiv.appendChild(labelDiv);
    }
    
    if (node.type) {
      const typeDiv = document.createElement('div');
      typeDiv.style.cssText = 'font-size:10px;color:#6b7280;margin-top:6px;padding:2px 8px;background:rgba(107,114,128,0.1);border-radius:4px;display:inline-block;';
      typeDiv.textContent = node.type;
      nodeDiv.appendChild(typeDiv);
    }
    
    nodeDiv.onclick = (e) => {
      e.stopPropagation();
      openDetail(node.id);
    };
    
    return nodeDiv;
  }
  
  // Â°´ÂÖÖË°ÄÁªüÂÖ≥Á≥ª‰∏ãÊãâÂàóË°®
  function fillPedigreeSelect() {
    if (!pedigreeSelectPigeon) return;
    pedigreeSelectPigeon.innerHTML = '<option value="">ÈÄâÊã©È∏ΩÂ≠êÊü•ÁúãË°ÄÁªüÊ†ë</option>';
    
    pigeons.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = `${p.ring}${p.name ? ' - ' + p.name : ''}${p.isCore ? ' ‚≠ê' : ''}`;
      pedigreeSelectPigeon.appendChild(option);
    });
  }
  
  // Ê£ÄÊü•‰∏§Âè™ÁßçÈ∏ΩÊòØÂê¶ÊòØÂ§´Â¶ªÂÖ≥Á≥ªÔºàÊúâÂÖ±ÂêåÁöÑÂ≠ê‰ª£Ôºå‰∏î‰∏çÊòØÁà∂Â≠ê/ÊØçÂ≠êÂÖ≥Á≥ªÔºâ
  function areBreederCouple(breeder1, breeder2) {
    if (breeder1.id === breeder2.id) return false;
    
    // ÊéíÈô§Áà∂Â≠ê/ÊØçÂ≠êÂÖ≥Á≥ª
    if (breeder1.fatherId === breeder2.id || breeder1.motherId === breeder2.id ||
        breeder2.fatherId === breeder1.id || breeder2.motherId === breeder1.id) {
      return false;
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÂÖ±ÂêåÁöÑÂ≠ê‰ª£Ôºà‰∏ÄÂè™ÁöÑÁà∂ÊòØbreeder1ÔºåÊØçÊòØbreeder2ÔºåÊàñÂèç‰πãÔºâ
    const commonChildren = pigeons.filter(p => {
      return (p.fatherId === breeder1.id && p.motherId === breeder2.id) ||
             (p.fatherId === breeder2.id && p.motherId === breeder1.id);
    });
    
    return commonChildren.length > 0;
  }
  
  // ÊòæÁ§∫ÊâÄÊúâÁßçÈ∏ΩÁöÑÊ†ëÁä∂ÂõæÔºàÂêàÂπ∂Â§´Â¶ªÂÖ≥Á≥ªÔºâ
  function renderAllBreederTrees() {
    if (!pedigreeTreeContainer) return;
    pedigreeTreeContainer.innerHTML = '';
    
    const breeders = pigeons.filter(p => p.type === 'ÁßçÈ∏Ω' || p.isCore);
    
    if (breeders.length === 0) {
      pedigreeTreeContainer.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ÊöÇÊó†ÁßçÈ∏ΩËÆ∞ÂΩï</p>';
      return;
    }
    
    // ÂàÜÁªÑÔºöÊâæÂá∫Â§´Â¶ªÂÖ≥Á≥ªÂπ∂ÂêàÂπ∂
    const processedIds = new Set();
    const breederGroups = [];
    
    breeders.forEach(breeder => {
      if (processedIds.has(breeder.id)) return;
      
      // Êü•ÊâæÊòØÂê¶ÊúâÈÖçÂÅ∂
      const spouse = breeders.find(b => 
        b.id !== breeder.id && 
        !processedIds.has(b.id) && 
        areBreederCouple(breeder, b)
      );
      
      if (spouse) {
        // ÊâæÂà∞ÈÖçÂÅ∂ÔºåÂêàÂπ∂ÊòæÁ§∫
        breederGroups.push([breeder, spouse]);
        processedIds.add(breeder.id);
        processedIds.add(spouse.id);
      } else {
        // Ê≤°ÊúâÈÖçÂÅ∂ÔºåÂçïÁã¨ÊòæÁ§∫
        breederGroups.push([breeder]);
        processedIds.add(breeder.id);
      }
    });
    
    const container = document.createElement('div');
    container.style.cssText = 'display:grid; grid-template-columns: repeat(auto-fill, minmax(450px, 1fr)); gap:24px;';
    
    breederGroups.forEach(group => {
      const breederCard = document.createElement('div');
      breederCard.style.cssText = 'background:#fff; border-radius:8px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.1);';
      
      // Ê†áÈ¢òÔºöÂ¶ÇÊûúÊòØÂ§´Â¶ªÔºåÊòæÁ§∫"Â§´Â¶ªÁßçÈ∏Ω"
      const title = document.createElement('div');
      title.style.cssText = 'font-size:16px; font-weight:600; margin-bottom:12px; padding-bottom:8px; border-bottom:2px solid #f0f0f0;';
      
      if (group.length === 2) {
        // Â§´Â¶ªÁßçÈ∏Ω
        const breeder1 = group[0];
        const breeder2 = group[1];
        title.innerHTML = `üíë Â§´Â¶ªÁßçÈ∏Ω<br>
          <span style="font-size:14px;color:#2b5cff;">${breeder1.name || breeder1.ring}</span> 
          <span style="font-size:12px;color:#6b7280;">(${breeder1.ring})</span>
          <span style="margin:0 8px;">&</span>
          <span style="font-size:14px;color:#ec4899;">${breeder2.name || breeder2.ring}</span> 
          <span style="font-size:12px;color:#6b7280;">(${breeder2.ring})</span>`;
      } else {
        // ÂçïÁã¨ÁßçÈ∏Ω
        const breeder = group[0];
        title.innerHTML = `${breeder.name || breeder.ring} <span style="font-size:12px;color:#6b7280;">${breeder.ring}</span>`;
      }
      breederCard.appendChild(title);
      
      const treeDiv = document.createElement('div');
      treeDiv.style.cssText = 'min-height:200px;';
      
      // Â¶ÇÊûúÊòØÂ§´Â¶ªÔºåÂêàÂπ∂ÊòæÁ§∫Â≠ê‰ª£
      if (group.length === 2) {
        const breeder1 = group[0];
        const breeder2 = group[1];
        
        // ÊòæÁ§∫‰∏§Âè™ÁßçÈ∏Ω
        const breedersDiv = document.createElement('div');
        breedersDiv.style.cssText = 'display:flex;gap:16px;justify-content:center;margin-bottom:16px;';
        
        const breeder1Node = createTreeNode({
          id: breeder1.id,
          ring: breeder1.ring,
          name: breeder1.name || breeder1.ring,
          isCore: breeder1.isCore,
          alive: breeder1.alive,
          type: breeder1.type
        }, '');
        breeder1Node.style.cssText = 'min-width:140px;';
        breedersDiv.appendChild(breeder1Node);
        
        const breeder2Node = createTreeNode({
          id: breeder2.id,
          ring: breeder2.ring,
          name: breeder2.name || breeder2.ring,
          isCore: breeder2.isCore,
          alive: breeder2.alive,
          type: breeder2.type
        }, '');
        breeder2Node.style.cssText = 'min-width:140px;';
        breedersDiv.appendChild(breeder2Node);
        
        treeDiv.appendChild(breedersDiv);
        
        // Ëé∑ÂèñÂÖ±ÂêåÁöÑÂ≠ê‰ª£
        const commonChildren = pigeons.filter(p => {
          return (p.fatherId === breeder1.id && p.motherId === breeder2.id) ||
                 (p.fatherId === breeder2.id && p.motherId === breeder1.id);
        });
        
        if (commonChildren.length > 0) {
          const childrenTitle = document.createElement('div');
          childrenTitle.style.cssText = 'font-size:12px;color:#6b7280;margin:12px 0 8px;font-weight:500;';
          childrenTitle.textContent = `ÂÖ±ÂêåÂ≠ê‰ª£Ôºà${commonChildren.length}Âè™Ôºâ`;
          treeDiv.appendChild(childrenTitle);
          
          const childrenDiv = document.createElement('div');
          childrenDiv.style.cssText = 'display:flex;flex-wrap:wrap;gap:8px;justify-content:center;';
          commonChildren.forEach(child => {
            const childNode = createTreeNode({
              id: child.id,
              ring: child.ring,
              name: child.name || child.ring,
              isCore: child.isCore,
              alive: child.alive,
              type: child.type
            }, '');
            childNode.style.cssText = 'min-width:120px;font-size:12px;';
            childrenDiv.appendChild(childNode);
          });
          treeDiv.appendChild(childrenDiv);
        } else {
          const noChildren = document.createElement('div');
          noChildren.style.cssText = 'text-align:center;padding:12px;color:#9ca3af;font-size:12px;';
          noChildren.textContent = 'ÊöÇÊó†ÂÖ±ÂêåÂ≠ê‰ª£ËÆ∞ÂΩï';
          treeDiv.appendChild(noChildren);
        }
      } else {
        // ÂçïÁã¨ÁßçÈ∏ΩÔºåÊòæÁ§∫ÂÖ∂Ê†ëÁä∂Âõæ
        const breeder = group[0];
        const tree = buildFullPedigreeTree(breeder);
        if (tree) {
          const current = createTreeNode(tree, 'ÁßçÈ∏Ω');
          treeDiv.appendChild(current);
          
          if (tree.children && tree.children.length > 0) {
            const childrenTitle = document.createElement('div');
            childrenTitle.style.cssText = 'font-size:12px;color:#6b7280;margin:12px 0 8px;';
            childrenTitle.textContent = `Â≠ê‰ª£Ôºà${tree.children.length}Âè™Ôºâ`;
            treeDiv.appendChild(childrenTitle);
            
            const childrenDiv = document.createElement('div');
            childrenDiv.style.cssText = 'display:flex;flex-wrap:wrap;gap:8px;justify-content:center;';
            tree.children.forEach(child => {
              const childNode = createTreeNode(child, '');
              childNode.style.cssText = 'min-width:120px;font-size:12px;';
              childrenDiv.appendChild(childNode);
            });
            treeDiv.appendChild(childrenDiv);
          }
        }
      }
      
      breederCard.appendChild(treeDiv);
      container.appendChild(breederCard);
    });
    
    pedigreeTreeContainer.appendChild(container);
  }
  
  // ÊêúÁ¥¢È∏ΩÂ≠êÔºàÈÄöËøáË∂≥ÁéØÂè∑ÊàñÂêçÂ≠óÔºâ
  function searchPigeonForPedigree(searchTerm) {
    if (!searchTerm || !searchTerm.trim()) {
      return null;
    }
    
    const term = searchTerm.trim().toLowerCase();
    
    // ÂÖàÂ∞ùËØïÁ≤æÁ°ÆÂåπÈÖçË∂≥ÁéØÂè∑
    let found = pigeons.find(p => p.ring.toLowerCase() === term);
    
    // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÔºåÂ∞ùËØïÈÉ®ÂàÜÂåπÈÖçË∂≥ÁéØÂè∑
    if (!found) {
      found = pigeons.find(p => p.ring.toLowerCase().includes(term));
    }
    
    // Â¶ÇÊûúËøòÊ≤°ÊúâÊâæÂà∞ÔºåÂ∞ùËØïÂåπÈÖçÂêçÂ≠ó
    if (!found) {
      found = pigeons.find(p => {
        const name = (p.name || '').toLowerCase();
        return name === term || name.includes(term);
      });
    }
    
    return found;
  }
  
  // Ë°ÄÁªüÂÖ≥Á≥ªËßÜÂõæ‰∫ã‰ª∂ÁªëÂÆö
  if (pedigreeSelectPigeon) {
    pedigreeSelectPigeon.addEventListener('change', () => {
      const selectedId = pedigreeSelectPigeon.value;
      if (selectedId) {
        const pigeon = getPigeonById(selectedId);
        if (pigeon) {
          renderFullPedigreeTree(pigeon);
        }
      } else {
        pedigreeTreeContainer.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ËØ∑ÈÄâÊã©‰∏ÄÂè™È∏ΩÂ≠êÊü•ÁúãË°ÄÁªüÊ†ë</p>';
      }
    });
  }
  
  // ÊêúÁ¥¢ÊåâÈíÆ‰∫ã‰ª∂
  const pedigreeSearchInput = document.getElementById('pedigreeSearchInput');
  const btnPedigreeSearch = document.getElementById('btnPedigreeSearch');
  
  function handlePedigreeSearch() {
    if (!pedigreeSearchInput) return;
    
    const searchTerm = pedigreeSearchInput.value.trim();
    if (!searchTerm) {
      alert('ËØ∑ËæìÂÖ•Ë∂≥ÁéØÂè∑ÊàñÂêçÂ≠óËøõË°åÊêúÁ¥¢');
      return;
    }
    
    const found = searchPigeonForPedigree(searchTerm);
    if (found) {
      // Êõ¥Êñ∞‰∏ãÊãâÈÄâÊã©Ê°Ü
      if (pedigreeSelectPigeon) {
        pedigreeSelectPigeon.value = found.id;
      }
      // Ê∏≤ÊüìÊ†ëÁä∂Âõæ
      renderFullPedigreeTree(found);
    } else {
      pedigreeTreeContainer.innerHTML = `<p class="muted" style="text-align:center;padding:40px;">Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÈ∏ΩÂ≠êÔºö${searchTerm}<br><small style="color:#9ca3af;">ËØ∑Ê£ÄÊü•Ë∂≥ÁéØÂè∑ÊàñÂêçÂ≠óÊòØÂê¶Ê≠£Á°Æ</small></p>`;
    }
  }
  
  if (btnPedigreeSearch) {
    btnPedigreeSearch.addEventListener('click', handlePedigreeSearch);
  }
  
  // ÊêúÁ¥¢Ê°ÜÂõûËΩ¶‰∫ã‰ª∂
  if (pedigreeSearchInput) {
    pedigreeSearchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        handlePedigreeSearch();
      }
    });
  }

  const btnShowAllBreeders = document.getElementById('btnShowAllBreeders');
  const btnRefreshPedigree = document.getElementById('btnRefreshPedigree');
  
  if (btnShowAllBreeders) {
    btnShowAllBreeders.addEventListener('click', () => {
      renderAllBreederTrees();
    });
  }
  
  if (btnRefreshPedigree) {
    btnRefreshPedigree.addEventListener('click', () => {
      fillPedigreeSelect();
      const selectedId = pedigreeSelectPigeon ? pedigreeSelectPigeon.value : '';
      if (selectedId) {
        const pigeon = getPigeonById(selectedId);
        if (pigeon) {
          renderFullPedigreeTree(pigeon);
        }
      }
      // Ê∏ÖÁ©∫ÊêúÁ¥¢Ê°Ü
      if (pedigreeSearchInput) {
        pedigreeSearchInput.value = '';
      }
    });
  }
  
  // Âà∑Êñ∞Ë°ÄÁªüÂÖ≥Á≥ªËßÜÂõæÁöÑÂáΩÊï∞
  function refreshPedigreeView() {
    fillPedigreeSelect();
    const selectedId = pedigreeSelectPigeon ? pedigreeSelectPigeon.value : '';
    if (selectedId) {
      const pigeon = getPigeonById(selectedId);
      if (pigeon) {
        renderFullPedigreeTree(pigeon);
      }
    }
  }

  // ÂàùÂßãÂåñ
  // ==================== ÊØîËµõ‰∏éÊàêÁª©ÁÆ°ÁêÜÂäüËÉΩ ====================
  const RACES_STORAGE_KEY = 'pigeon_races';
  let races = [];
  
  // Âä†ËΩΩÊØîËµõÊï∞ÊçÆ
  function loadRaces() {
    try {
      const raw = localStorage.getItem(RACES_STORAGE_KEY);
      if (raw) {
        races = JSON.parse(raw);
      } else {
        races = [];
      }
    } catch (e) {
      console.error('Âä†ËΩΩÊØîËµõÊï∞ÊçÆÂ§±Ë¥•:', e);
      races = [];
    }
  }
  
  // ‰øùÂ≠òÊØîËµõÊï∞ÊçÆ
  function saveRaces() {
    try {
      localStorage.setItem(RACES_STORAGE_KEY, JSON.stringify(races));
    } catch (e) {
      console.error('‰øùÂ≠òÊØîËµõÊï∞ÊçÆÂ§±Ë¥•:', e);
      alert('‰øùÂ≠òÊØîËµõÊï∞ÊçÆÂ§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ');
    }
  }
  
  // Ê∏≤ÊüìÊØîËµõÂàóË°®
  function renderRaceList() {
    const container = document.getElementById('raceListContainer');
    if (!container) return;
    
    if (races.length === 0) {
      container.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ÊöÇÊó†ÊØîËµõËÆ∞ÂΩïÔºåÁÇπÂáª"Êñ∞Â¢ûÊØîËµõ"ÂºÄÂßãËÆ∞ÂΩï</p>';
      return;
    }
    
    container.innerHTML = '';
    races.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(race => {
      const card = document.createElement('div');
      card.className = 'race-card';
      
      const header = document.createElement('div');
      header.className = 'race-card-header';
      
      const left = document.createElement('div');
      const title = document.createElement('div');
      title.className = 'race-card-title';
      title.textContent = race.name;
      left.appendChild(title);
      
      const meta = document.createElement('div');
      meta.className = 'race-card-meta';
      meta.innerHTML = `
        <div class="race-card-meta-item">üìÖ ${race.date}</div>
        <div class="race-card-meta-item">üìç ${race.location}</div>
        ${race.weather ? `<div class="race-card-meta-item">üå§Ô∏è ${race.weather}</div>` : ''}
        <div class="race-card-meta-item">üê¶ ÂèÇËµõÈ∏ΩÔºö${race.participants.length}Âè™</div>
      `;
      left.appendChild(meta);
      header.appendChild(left);
      
      const actions = document.createElement('div');
      actions.style.cssText = 'display:flex;gap:8px;';
      const btnEdit = document.createElement('button');
      btnEdit.className = 'btn btn-outline btn-sm';
      btnEdit.textContent = '‚úèÔ∏è ÁºñËæë';
      btnEdit.onclick = () => openRaceModal(race.id);
      const btnDelete = document.createElement('button');
      btnDelete.className = 'btn btn-outline btn-sm';
      btnDelete.textContent = 'üóëÔ∏è Âà†Èô§';
      btnDelete.onclick = () => {
        if (confirm(`Á°ÆÂÆöÂà†Èô§ÊØîËµõ"${race.name}"ÂêóÔºü`)) {
          races = races.filter(r => r.id !== race.id);
          saveRaces();
          syncRacesToPigeons(); // ÂêåÊ≠•Êõ¥Êñ∞È∏ΩÂ≠êÊ°£Ê°à
          renderRaceList();
          refreshList(); // Âà∑Êñ∞È∏ΩÂ≠êÂàóË°®
        }
      };
      actions.appendChild(btnEdit);
      actions.appendChild(btnDelete);
      header.appendChild(actions);
      
      card.appendChild(header);
      
      // ÊòæÁ§∫ÂèÇËµõÈ∏ΩÊàêÁª©
      if (race.participants && race.participants.length > 0) {
        const participantsDiv = document.createElement('div');
        participantsDiv.style.cssText = 'margin-top:16px;';
        const table = document.createElement('table');
        table.style.cssText = 'width:100%;border-collapse:collapse;';
        table.innerHTML = `
          <thead>
            <tr style="background:#f9fafb;">
              <th style="padding:10px;text-align:left;border-bottom:2px solid #e5e7eb;">È∏ΩÂ≠ê</th>
              <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂêçÊ¨°</th>
              <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂàÜÊï∞</th>
              <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂΩíÂ∑¢Êó∂Èó¥</th>
            </tr>
          </thead>
          <tbody>
        `;
        
        race.participants.sort((a, b) => (a.rank || 9999) - (b.rank || 9999)).forEach(p => {
          const pigeon = getPigeonById(p.pigeonId);
          const row = document.createElement('tr');
          row.style.cssText = 'border-bottom:1px solid #f0f0f0;';
          row.innerHTML = `
            <td style="padding:10px;">
              ${pigeon ? `${pigeon.name || pigeon.ring} (${pigeon.ring})` : 'Êú™Áü•È∏ΩÂ≠ê'}
            </td>
            <td style="padding:10px;text-align:center;font-weight:600;color:#2b5cff;">
              ${p.rank ? `Á¨¨${p.rank}Âêç` : '‚Äî'}
            </td>
            <td style="padding:10px;text-align:center;">
              ${p.score ? p.score : '‚Äî'}
            </td>
            <td style="padding:10px;text-align:center;">
              ${p.returnTime || '‚Äî'}
            </td>
          `;
          table.querySelector('tbody').appendChild(row);
        });
        
        table.innerHTML += '</tbody>';
        participantsDiv.appendChild(table);
        card.appendChild(participantsDiv);
      }
      
      container.appendChild(card);
    });
  }
  
  // ÊâìÂºÄÊØîËµõÊ®°ÊÄÅÊ°Ü
  function openRaceModal(raceId = null) {
    const modal = document.getElementById('raceModal');
    const title = document.getElementById('raceModalTitle');
    if (!modal) return;
    
    if (raceId) {
      const race = races.find(r => r.id === raceId);
      if (race) {
        title.textContent = 'ÁºñËæëÊØîËµõ';
        document.getElementById('race_name').value = race.name;
        document.getElementById('race_date').value = race.date;
        document.getElementById('race_location').value = race.location;
        document.getElementById('race_weather').value = race.weather || '';
        
        const container = document.getElementById('raceParticipantsContainer');
        container.innerHTML = '';
        race.participants.forEach(p => {
          addParticipantRow(p);
        });
        if (race.participants.length === 0) {
          addParticipantRow();
        }
      }
    } else {
      title.textContent = 'Êñ∞Â¢ûÊØîËµõ';
      document.getElementById('race_name').value = '';
      document.getElementById('race_date').value = '';
      document.getElementById('race_location').value = '';
      document.getElementById('race_weather').value = '';
      const container = document.getElementById('raceParticipantsContainer');
      container.innerHTML = '';
      addParticipantRow();
    }
    
    fillParticipantSelects();
    modal.style.display = 'flex';
  }
  
  // Ê∑ªÂä†ÂèÇËµõÈ∏ΩË°å
  function addParticipantRow(data = null) {
    const container = document.getElementById('raceParticipantsContainer');
    if (!container) return;
    
    const row = document.createElement('div');
    row.className = 'participant-item';
    row.style.cssText = 'display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:12px;align-items:center;padding:12px;background:#f9fafb;border-radius:8px;margin-bottom:12px;';
    
    const select = document.createElement('select');
    select.className = 'participant-pigeon';
    select.style.cssText = 'padding:8px;border-radius:6px;border:1px solid #E5E7EB;';
    select.innerHTML = '<option value="">ÈÄâÊã©È∏ΩÂ≠ê...</option>';
    pigeons.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = `${p.ring}${p.name ? ' - ' + p.name : ''}`;
      if (data && data.pigeonId === p.id) {
        option.selected = true;
      }
      select.appendChild(option);
    });
    
    const rankInput = document.createElement('input');
    rankInput.type = 'number';
    rankInput.className = 'participant-rank';
    rankInput.placeholder = 'ÂêçÊ¨°';
    rankInput.min = 1;
    rankInput.style.cssText = 'padding:8px;border-radius:6px;border:1px solid #E5E7EB;';
    if (data && data.rank) rankInput.value = data.rank;
    
    const scoreInput = document.createElement('input');
    scoreInput.type = 'number';
    scoreInput.className = 'participant-score';
    scoreInput.placeholder = 'ÂàÜÊï∞';
    scoreInput.step = '0.01';
    scoreInput.style.cssText = 'padding:8px;border-radius:6px;border:1px solid #E5E7EB;';
    if (data && data.score) scoreInput.value = data.score;
    
    const timeInput = document.createElement('input');
    timeInput.type = 'time';
    timeInput.className = 'participant-time';
    timeInput.placeholder = 'ÂΩíÂ∑¢Êó∂Èó¥';
    timeInput.style.cssText = 'padding:8px;border-radius:6px;border:1px solid #E5E7EB;';
    if (data && data.returnTime) timeInput.value = data.returnTime;
    
    const removeBtn = document.createElement('button');
    removeBtn.className = 'btn btn-outline btn-sm remove-participant';
    removeBtn.textContent = 'Âà†Èô§';
    removeBtn.style.cssText = 'padding:6px 12px;';
    removeBtn.onclick = () => row.remove();
    
    row.appendChild(select);
    row.appendChild(rankInput);
    row.appendChild(scoreInput);
    row.appendChild(timeInput);
    row.appendChild(removeBtn);
    
    container.appendChild(row);
  }
  
  // Â°´ÂÖÖÂèÇËµõÈ∏ΩÈÄâÊã©Ê°Ü
  function fillParticipantSelects() {
    const selects = document.querySelectorAll('.participant-pigeon');
    selects.forEach(select => {
      const currentValue = select.value;
      select.innerHTML = '<option value="">ÈÄâÊã©È∏ΩÂ≠ê...</option>';
      pigeons.forEach(p => {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = `${p.ring}${p.name ? ' - ' + p.name : ''}`;
        if (currentValue === p.id) {
          option.selected = true;
        }
        select.appendChild(option);
      });
    });
  }
  
  // ‰øùÂ≠òÊØîËµõ
  function saveRace() {
    const name = document.getElementById('race_name').value.trim();
    const date = document.getElementById('race_date').value;
    const location = document.getElementById('race_location').value.trim();
    const weather = document.getElementById('race_weather').value;
    
    if (!name || !date || !location) {
      alert('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÊØîËµõ‰ø°ÊÅØÔºàËµõ‰∫ãÂêçÁß∞„ÄÅÊó∂Èó¥„ÄÅÂú∞ÁÇπ‰∏∫ÂøÖÂ°´È°πÔºâ');
      return;
    }
    
    const participants = [];
    document.querySelectorAll('.participant-item').forEach(row => {
      const pigeonId = row.querySelector('.participant-pigeon').value;
      const rank = row.querySelector('.participant-rank').value;
      const score = row.querySelector('.participant-score').value;
      const returnTime = row.querySelector('.participant-time').value;
      
      if (pigeonId) {
        participants.push({
          pigeonId,
          rank: rank ? parseInt(rank) : null,
          score: score ? parseFloat(score) : null,
          returnTime: returnTime || null
        });
      }
    });
    
    const raceId = document.getElementById('raceModalTitle').textContent === 'Êñ∞Â¢ûÊØîËµõ' ? 
      Date.now().toString() : 
      races.find(r => r.name === name && r.date === date)?.id || Date.now().toString();
    
    const race = {
      id: raceId,
      name,
      date,
      location,
      weather: weather || null,
      participants
    };
    
    const index = races.findIndex(r => r.id === raceId);
    if (index >= 0) {
      races[index] = race;
    } else {
      races.push(race);
    }
    
    saveRaces();
    syncRacesToPigeons(); // Ëá™Âä®ÂêåÊ≠•ÊØîËµõÊï∞ÊçÆÂà∞È∏ΩÂ≠êÊ°£Ê°à
    renderRaceList();
    refreshList(); // Âà∑Êñ∞È∏ΩÂ≠êÂàóË°®‰ª•ÊòæÁ§∫Êõ¥Êñ∞ÁöÑÊØîËµõ‰ø°ÊÅØ
    closeRaceModal();
    alert('ÊØîËµõ‰øùÂ≠òÊàêÂäüÔºÅÂ∑≤Ëá™Âä®ÂêåÊ≠•Âà∞È∏ΩÂ≠êÊ°£Ê°à„ÄÇ');
  }
  
  // ÂêåÊ≠•ÊØîËµõÊï∞ÊçÆÂà∞È∏ΩÂ≠êÊ°£Ê°à
  function syncRacesToPigeons() {
    // ÈáçÊñ∞Âä†ËΩΩÈ∏ΩÂ≠êÊï∞ÊçÆ‰ª•Á°Æ‰øù‰ΩøÁî®ÊúÄÊñ∞Êï∞ÊçÆ
    loadFromStorage();
    
    // Ê∏ÖÁ©∫ÊâÄÊúâÈ∏ΩÂ≠êÁöÑÊØîËµõËÆ∞ÂΩïÔºåÈáçÊñ∞‰ªéÊØîËµõÊï∞ÊçÆ‰∏≠ÂêåÊ≠•
    pigeons.forEach(p => {
      p.races = [];
    });
    
    // ‰ªéÊØîËµõÊï∞ÊçÆ‰∏≠ÊèêÂèñÊØèÂè™È∏ΩÂ≠êÁöÑÂèÇËµõËÆ∞ÂΩï
    races.forEach(race => {
      if (race.participants && Array.isArray(race.participants)) {
        race.participants.forEach(participant => {
          if (participant && participant.pigeonId) {
            const pigeon = getPigeonById(participant.pigeonId);
            if (pigeon) {
              if (!pigeon.races) {
                pigeon.races = [];
              }
              pigeon.races.push({
                raceId: race.id,
                raceName: race.name,
                date: race.date,
                location: race.location,
                weather: race.weather,
                rank: participant.rank,
                score: participant.score,
                returnTime: participant.returnTime
              });
            }
          }
        });
      }
    });
    
    // ‰øùÂ≠òÊõ¥Êñ∞ÂêéÁöÑÈ∏ΩÂ≠êÊï∞ÊçÆ
    saveToStorage();
    
    // Ë∞ÉËØï‰ø°ÊÅØÔºàÂèØÂú®ÊéßÂà∂Âè∞Êü•ÁúãÔºâ
    const breedersWithRaces = pigeons.filter(p => (p.type === 'ÁßçÈ∏Ω' || p.isCore) && p.races && p.races.length > 0);
    if (breedersWithRaces.length > 0) {
      console.log(`Â∑≤ÂêåÊ≠•${breedersWithRaces.length}Âè™ÁßçÈ∏ΩÁöÑÂèÇËµõËÆ∞ÂΩïÔºö`, breedersWithRaces.map(p => ({
        name: p.name || p.ring,
        ring: p.ring,
        races: p.races.length
      })));
    }
  }
  
  // ÂÖ≥Èó≠ÊØîËµõÊ®°ÊÄÅÊ°Ü
  function closeRaceModal() {
    const modal = document.getElementById('raceModal');
    if (modal) modal.style.display = 'none';
  }
  
  // Ê†áÁ≠æÈ°µÂàáÊç¢
  function switchRaceTab(tabName) {
    document.querySelectorAll('.race-tab-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.dataset.tab === tabName) {
        btn.classList.add('active');
      }
    });
    
    document.querySelectorAll('.race-tab-content').forEach(content => {
      content.classList.remove('active');
      if (content.id === tabName + 'Tab') {
        content.classList.add('active');
      }
    });
  }
  
  // ÊØîËµõÁÆ°ÁêÜ‰∫ã‰ª∂ÁªëÂÆö
  const btnAddRace = document.getElementById('btnAddRace');
  const btnRefreshRaces = document.getElementById('btnRefreshRaces');
  const btnSaveRace = document.getElementById('btnSaveRace');
  const btnCancelRace = document.getElementById('btnCancelRace');
  const btnCloseRaceModal = document.getElementById('btnCloseRaceModal');
  const btnAddParticipant = document.getElementById('btnAddParticipant');
  const raceTabBtns = document.querySelectorAll('.race-tab-btn');
  
  if (btnAddRace) {
    btnAddRace.addEventListener('click', () => openRaceModal());
  }
  
  if (btnRefreshRaces) {
    btnRefreshRaces.addEventListener('click', () => {
      loadRaces();
      syncRacesToPigeons(); // ÂêåÊ≠•Êõ¥Êñ∞È∏ΩÂ≠êÊ°£Ê°à
      renderRaceList();
      refreshList(); // Âà∑Êñ∞È∏ΩÂ≠êÂàóË°®
    });
  }
  
  if (btnSaveRace) {
    btnSaveRace.addEventListener('click', saveRace);
  }
  
  if (btnCancelRace) {
    btnCancelRace.addEventListener('click', closeRaceModal);
  }
  
  if (btnCloseRaceModal) {
    btnCloseRaceModal.addEventListener('click', closeRaceModal);
  }
  
  if (btnAddParticipant) {
    btnAddParticipant.addEventListener('click', () => addParticipantRow());
  }
  
  raceTabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      switchRaceTab(btn.dataset.tab);
      // ÂàáÊç¢Âà∞ÊàêÁª©ÂàÜÊûêÊ†áÁ≠æÈ°µÊó∂Ëá™Âä®ÁîüÊàêÂàÜÊûê
      if (btn.dataset.tab === 'raceAnalysis') {
        generateOverallAnalysis();
      }
      // ÂàáÊç¢Âà∞Ë°ÄÁªüÂØπÊØîÊ†áÁ≠æÈ°µÊó∂ÂàùÂßãÂåñÂØπÊØîÂäüËÉΩ
      if (btn.dataset.tab === 'pedigreeComparison') {
        initPedigreeComparison();
      }
    });
  });
  
  // ÁîüÊàêÂçïÈ∏ΩÊàêÁª©ÁªüËÆ°
  function generateSinglePigeonStats(pigeonId) {
    const container = document.getElementById('raceStatsContainer');
    if (!container) return;
    
    const pigeon = getPigeonById(pigeonId);
    if (!pigeon) {
      container.innerHTML = '<p class="muted">Êú™ÊâæÂà∞ËØ•È∏ΩÂ≠ê</p>';
      return;
    }
    
    // Êî∂ÈõÜËØ•È∏ΩÂ≠êÁöÑÊâÄÊúâÊØîËµõÊàêÁª©Ôºà‰ºòÂÖà‰ªéÈ∏ΩÂ≠êÊ°£Ê°à‰∏≠ËØªÂèñÔºåÁ°Æ‰øùÊï∞ÊçÆÂêåÊ≠•Ôºâ
    let pigeonRaces = [];
    
    // Â¶ÇÊûúÈ∏ΩÂ≠êÊ°£Ê°à‰∏≠ÊúâÊØîËµõËÆ∞ÂΩïÔºå‰ºòÂÖà‰ΩøÁî®
    if (pigeon.races && pigeon.races.length > 0) {
      pigeonRaces = pigeon.races.map(race => ({
        raceName: race.raceName,
        date: race.date,
        location: race.location,
        weather: race.weather,
        rank: race.rank,
        score: race.score,
        returnTime: race.returnTime
      }));
    } else {
      // Â¶ÇÊûúÊ≤°ÊúâÔºå‰ªéÊØîËµõÊï∞ÊçÆ‰∏≠Êü•Êâæ
      races.forEach(race => {
        const participant = race.participants.find(p => p.pigeonId === pigeonId);
        if (participant) {
          pigeonRaces.push({
            raceName: race.name,
            date: race.date,
            location: race.location,
            weather: race.weather,
            rank: participant.rank,
            score: participant.score,
            returnTime: participant.returnTime
          });
        }
      });
      // ÂêåÊ≠•Âà∞È∏ΩÂ≠êÊ°£Ê°à
      if (pigeonRaces.length > 0) {
        syncRacesToPigeons();
      }
    }
    
    if (pigeonRaces.length === 0) {
      container.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ËØ•È∏ΩÂ≠êÊöÇÊó†ÊØîËµõËÆ∞ÂΩï</p>';
      return;
    }
    
    // ÁîüÊàêÁªüËÆ°‰ø°ÊÅØ
    const sortedByRank = [...pigeonRaces].filter(r => r.rank).sort((a, b) => a.rank - b.rank);
    const bestRank = sortedByRank.length > 0 ? sortedByRank[0].rank : null;
    const avgRank = sortedByRank.length > 0 ? 
      Math.round(sortedByRank.reduce((sum, r) => sum + r.rank, 0) / sortedByRank.length) : null;
    const scores = pigeonRaces.filter(r => r.score).map(r => r.score);
    const avgScore = scores.length > 0 ? 
      (scores.reduce((sum, s) => sum + s, 0) / scores.length).toFixed(2) : null;
    const maxScore = scores.length > 0 ? Math.max(...scores).toFixed(2) : null;
    
    // ÁîüÊàêHTML
    let html = `
      <div class="stats-chart-container">
        <h3 style="margin:0 0 20px 0;color:#1f2937;">${pigeon.name || pigeon.ring} (${pigeon.ring}) ÊàêÁª©ÁªüËÆ°</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:24px;">
          <div style="background:linear-gradient(135deg, #e6f0ff 0%, #dbeafe 100%);padding:16px;border-radius:8px;">
            <div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÂèÇËµõÊ¨°Êï∞</div>
            <div style="font-size:24px;font-weight:700;color:#1f2937;">${pigeonRaces.length}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);padding:16px;border-radius:8px;">
            <div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÊúÄ‰Ω≥ÂêçÊ¨°</div>
            <div style="font-size:24px;font-weight:700;color:#1f2937;">${bestRank ? `Á¨¨${bestRank}Âêç` : '‚Äî'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);padding:16px;border-radius:8px;">
            <div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Âπ≥ÂùáÂêçÊ¨°</div>
            <div style="font-size:24px;font-weight:700;color:#1f2937;">${avgRank ? `Á¨¨${avgRank}Âêç` : '‚Äî'}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);padding:16px;border-radius:8px;">
            <div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Âπ≥ÂùáÂàÜÊï∞</div>
            <div style="font-size:24px;font-weight:700;color:#1f2937;">${avgScore || '‚Äî'}</div>
          </div>
        </div>
        
        <h4 style="margin:20px 0 12px 0;color:#374151;">ÂêçÊ¨°Ë∂ãÂäøÂõæ</h4>
        <div style="height:200px;background:#f9fafb;border-radius:8px;padding:16px;display:flex;align-items:flex-end;justify-content:space-around;gap:8px;">
    `;
    
    // ÁªòÂà∂ÂêçÊ¨°Ë∂ãÂäøÂõæÔºàÊü±Áä∂ÂõæÔºâ
    sortedByRank.forEach((race, index) => {
      const height = Math.max(10, 180 - (race.rank - 1) * 15);
      html += `
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;">
          <div style="width:100%;background:linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);border-radius:4px 4px 0 0;height:${height}px;min-height:20px;position:relative;">
            <div style="position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:11px;font-weight:600;color:#1f2937;">${race.rank}</div>
          </div>
          <div style="font-size:10px;color:#6b7280;text-align:center;writing-mode:vertical-rl;text-orientation:mixed;max-width:60px;overflow:hidden;text-overflow:ellipsis;">${race.raceName}</div>
        </div>
      `;
    });
    
    html += `
        </div>
        
        <h4 style="margin:24px 0 12px 0;color:#374151;">ËØ¶ÁªÜÊØîËµõËÆ∞ÂΩï</h4>
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:#f9fafb;">
              <th style="padding:10px;text-align:left;border-bottom:2px solid #e5e7eb;">ÊØîËµõÂêçÁß∞</th>
              <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">Êó•Êúü</th>
              <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">Âú∞ÁÇπ</th>
              <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂêçÊ¨°</th>
              <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂàÜÊï∞</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    pigeonRaces.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(race => {
      html += `
        <tr style="border-bottom:1px solid #f0f0f0;">
          <td style="padding:10px;">${race.raceName}</td>
          <td style="padding:10px;text-align:center;">${race.date}</td>
          <td style="padding:10px;text-align:center;">${race.location}</td>
          <td style="padding:10px;text-align:center;font-weight:600;color:#2b5cff;">${race.rank ? `Á¨¨${race.rank}Âêç` : '‚Äî'}</td>
          <td style="padding:10px;text-align:center;">${race.score || '‚Äî'}</td>
        </tr>
      `;
    });
    
    html += `
          </tbody>
        </table>
      </div>
      
      <div class="analysis-conclusion">
        <h4>üìä ÊàêÁª©ÂàÜÊûêÁªìËÆ∫</h4>
        <p><strong>ÊÄª‰ΩìË°®Áé∞Ôºö</strong>ËØ•È∏ΩÂ≠êÂÖ±ÂèÇÂä†${pigeonRaces.length}Âú∫ÊØîËµõ${bestRank ? `ÔºåÊúÄ‰Ω≥ÊàêÁª©‰∏∫Á¨¨${bestRank}Âêç` : ''}${avgRank ? `ÔºåÂπ≥ÂùáÂêçÊ¨°‰∏∫Á¨¨${avgRank}Âêç` : ''}„ÄÇ</p>
        ${bestRank && bestRank <= 3 ? '<p><strong>‰ºòÂäøÔºö</strong>ËØ•È∏ΩÂ≠êÂÖ∑Â§áËæÉÂº∫ÁöÑÁ´ûÊäÄËÉΩÂäõÔºåÂú®ÊØîËµõ‰∏≠Ë°®Áé∞Á™ÅÂá∫ÔºåÂª∫ËÆÆÁªßÁª≠‰Ωú‰∏∫ÈáçÁÇπÂüπÂÖªÂØπË±°„ÄÇ</p>' : ''}
        ${avgRank && avgRank <= 10 ? '<p><strong>Á®≥ÂÆöÊÄßÔºö</strong>ËØ•È∏ΩÂ≠êÊàêÁª©ËæÉ‰∏∫Á®≥ÂÆöÔºåÂπ≥ÂùáÂêçÊ¨°Ë°®Áé∞ËâØÂ•Ω„ÄÇ</p>' : avgRank && avgRank > 20 ? '<p><strong>ÊîπËøõÂª∫ËÆÆÔºö</strong>ËØ•È∏ΩÂ≠êÂπ≥ÂùáÂêçÊ¨°ËæÉ‰ΩéÔºåÂª∫ËÆÆÂä†Âº∫ËÆ≠ÁªÉÊàñËÄÉËôëË∞ÉÊï¥ÈÖçÂØπÁ≠ñÁï•„ÄÇ</p>' : ''}
        ${scores.length > 0 && avgScore ? `<p><strong>ÂàÜÊï∞ÂàÜÊûêÔºö</strong>Âπ≥ÂùáÂàÜÊï∞‰∏∫${avgScore}ÂàÜ${maxScore ? `ÔºåÊúÄÈ´òÂàÜÊï∞‰∏∫${maxScore}ÂàÜ` : ''}„ÄÇ</p>` : ''}
        <p><strong>Âª∫ËÆÆÔºö</strong>${bestRank && bestRank <= 5 ? 'ËØ•È∏ΩÂ≠êË°®Áé∞‰ºòÁßÄÔºåÂª∫ËÆÆ‰Ωú‰∏∫ÁßçÈ∏ΩÂÄôÈÄâÔºåÈáçÁÇπÂÖ≥Ê≥®ÂÖ∂Âêé‰ª£Ë°®Áé∞„ÄÇ' : 'Âª∫ËÆÆÁªßÁª≠ËßÇÂØüËØ•È∏ΩÂ≠êÁöÑË°®Áé∞ÔºåÊ†πÊçÆÂêéÁª≠ÊØîËµõÊàêÁª©ÂÜ≥ÂÆöÊòØÂê¶‰Ωú‰∏∫ÁßçÈ∏Ω„ÄÇ'}</p>
      </div>
    `;
    
    container.innerHTML = html;
  }
  
  // ÁîüÊàêË°ÄÁ≥ªÁªüËÆ°ÔºàÁªüËÆ°Êüê‰∏™È∏ΩÂ≠êÁöÑÊâÄÊúâÁ•ñÂÖàÂíåÂêé‰ª£ÁöÑÊÄª‰ΩìË°®Áé∞Ôºâ
  function generateBloodlineStats(pigeonId) {
    const container = document.getElementById('raceStatsContainer');
    if (!container) return;
    
    const pigeon = getPigeonById(pigeonId);
    if (!pigeon) {
      container.innerHTML = '<p class="muted">Êú™ÊâæÂà∞ËØ•È∏ΩÂ≠ê</p>';
      return;
    }
    
    // Ëé∑ÂèñÊâÄÊúâÁ•ñÂÖà
    const ancestors = getAncestors(pigeonId, 5);
    const ancestorIds = new Set([pigeonId, ...ancestors.map(a => a.id)]);
    
    // Ëé∑ÂèñÊâÄÊúâÂêé‰ª£ÔºàÈÄíÂΩíËé∑ÂèñÔºâ
    const getDescendants = (pid, visited = new Set()) => {
      if (visited.has(pid)) return [];
      visited.add(pid);
      const children = pigeons.filter(p => p.fatherId === pid || p.motherId === pid);
      let descendants = [...children];
      children.forEach(child => {
        descendants = descendants.concat(getDescendants(child.id, visited));
      });
      return descendants;
    };
    const descendants = getDescendants(pigeonId);
    const descendantIds = new Set(descendants.map(d => d.id));
    
    // ÂêàÂπ∂ÊâÄÊúâË°ÄÁ≥ªÊàêÂëòÔºàÂåÖÊã¨Ëá™Â∑±„ÄÅÁ•ñÂÖàÂíåÂêé‰ª£Ôºâ
    const bloodlineMembers = pigeons.filter(p => 
      ancestorIds.has(p.id) || descendantIds.has(p.id)
    );
    
    // ÁªüËÆ°Ë°ÄÁ≥ªÊàêÂëòÁöÑË°®Áé∞
    let totalRaces = 0;
    let totalParticipants = 0;
    const raceRecords = [];
    const membersStats = [];
    
    bloodlineMembers.forEach(member => {
      let memberRaces = member.races || [];
      if (memberRaces.length === 0) {
        races.forEach(race => {
          const participant = race.participants.find(p => p.pigeonId === member.id);
          if (participant) {
            memberRaces.push({
              raceName: race.name,
              date: race.date,
              location: race.location,
              rank: participant.rank,
              score: participant.score
            });
          }
        });
      }
      
      if (memberRaces.length > 0) {
        const ranks = memberRaces.filter(r => r.rank).map(r => r.rank);
        const bestRank = ranks.length > 0 ? Math.min(...ranks) : null;
        const avgRank = ranks.length > 0 ? 
          Math.round(ranks.reduce((a, b) => a + b, 0) / ranks.length) : null;
        const wins = ranks.filter(r => r <= 3).length;
        
        membersStats.push({
          pigeon: member,
          totalRaces: memberRaces.length,
          bestRank,
          avgRank,
          wins,
          isAncestor: ancestorIds.has(member.id) && member.id !== pigeonId,
          isDescendant: descendantIds.has(member.id)
        });
        
        totalRaces += memberRaces.length;
        totalParticipants += memberRaces.length;
        raceRecords.push(...memberRaces.map(r => ({ ...r, pigeonId: member.id, pigeonName: member.name || member.ring })));
      }
    });
    
    membersStats.sort((a, b) => (b.bestRank ? 0 : 1) - (a.bestRank ? 0 : 1) || (a.bestRank || 999) - (b.bestRank || 999));
    
    // ÁîüÊàêHTML
    let html = `
      <div class="stats-chart-container">
        <h3 style="margin:0 0 20px 0;color:#1f2937;">üß¨ ${pigeon.name || pigeon.ring} (${pigeon.ring}) Ë°ÄÁ≥ªÁªüËÆ°</h3>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:24px;">
          <div style="background:linear-gradient(135deg, #e6f0ff 0%, #dbeafe 100%);padding:16px;border-radius:8px;">
            <div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Ë°ÄÁ≥ªÊàêÂëòÊï∞</div>
            <div style="font-size:24px;font-weight:700;color:#1f2937;">${bloodlineMembers.length}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);padding:16px;border-radius:8px;">
            <div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Á•ñÂÖàÊï∞Èáè</div>
            <div style="font-size:24px;font-weight:700;color:#1f2937;">${ancestors.length}</div>
          </div>
          <div style="background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);padding:16px;border-radius:8px;">
            <div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Âêé‰ª£Êï∞Èáè</div>
            <div style="font-size:24px;font-weight:700;color:#1f2937;">${descendants.length}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);padding:16px;border-radius:8px;">
            <div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÊÄªÂèÇËµõÊ¨°Êï∞</div>
            <div style="font-size:24px;font-weight:700;color:#1f2937;">${totalParticipants}</div>
          </div>
        </div>
        
        <h4 style="margin:20px 0 12px 0;color:#374151;">Ë°ÄÁ≥ªÊàêÂëòË°®Áé∞ÁªüËÆ°</h4>
        <div style="background:#fff;border-radius:10px;padding:20px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
    `;
    
    if (membersStats.length > 0) {
      html += `
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:#f9fafb;">
              <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">ÊàêÂëò</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂÖ≥Á≥ª</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂèÇËµõÊ¨°Êï∞</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">ÊúÄ‰Ω≥ÂêçÊ¨°</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Âπ≥ÂùáÂêçÊ¨°</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Ëé∑Â•ñÊ¨°Êï∞</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      membersStats.forEach(stats => {
        const relation = stats.pigeon.id === pigeonId ? 'Ê†∏ÂøÉÈ∏ΩÂ≠ê' : 
                        stats.isAncestor ? 'Á•ñÂÖà' : 'Âêé‰ª£';
        html += `
          <tr style="border-bottom:1px solid #f0f0f0;">
            <td style="padding:12px;">
              <strong>${stats.pigeon.name || stats.pigeon.ring}</strong>
              <span style="color:#6b7280;font-size:12px;margin-left:8px;">(${stats.pigeon.ring})</span>
            </td>
            <td style="padding:12px;text-align:center;">
              <span style="background:${stats.pigeon.id === pigeonId ? '#dbeafe' : stats.isAncestor ? '#fef3c7' : '#d1fae5'};color:${stats.pigeon.id === pigeonId ? '#1e40af' : stats.isAncestor ? '#92400e' : '#065f46'};padding:4px 8px;border-radius:4px;font-size:12px;">${relation}</span>
            </td>
            <td style="padding:12px;text-align:center;font-weight:600;">${stats.totalRaces}Âú∫</td>
            <td style="padding:12px;text-align:center;font-weight:600;color:#10b981;">${stats.bestRank ? `Á¨¨${stats.bestRank}Âêç` : '‚Äî'}</td>
            <td style="padding:12px;text-align:center;">${stats.avgRank ? `Á¨¨${stats.avgRank}Âêç` : '‚Äî'}</td>
            <td style="padding:12px;text-align:center;font-weight:600;color:#f59e0b;">${stats.wins}Ê¨°</td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
    } else {
      html += '<p class="muted" style="text-align:center;padding:20px;">Ë°ÄÁ≥ªÊàêÂëòÊöÇÊó†ÊØîËµõËÆ∞ÂΩï</p>';
    }
    
    html += `
        </div>
      </div>
      
      <div class="analysis-conclusion">
        <h4>üß¨ Ë°ÄÁ≥ªÂàÜÊûêÁªìËÆ∫</h4>
        <p><strong>Ë°ÄÁ≥ªÊ¶ÇÂÜµÔºö</strong>ËØ•Ë°ÄÁ≥ªÂÖ±Êúâ${bloodlineMembers.length}ÂêçÊàêÂëòÔºåÂÖ∂‰∏≠Á•ñÂÖà${ancestors.length}Âè™ÔºåÂêé‰ª£${descendants.length}Âè™„ÄÇ</p>
        ${membersStats.length > 0 ? `<p><strong>Ë°®Áé∞ÁªüËÆ°Ôºö</strong>Ë°ÄÁ≥ªÊàêÂëòÁ¥ØËÆ°ÂèÇËµõ${totalParticipants}Ê¨°ÔºåÂÖ∂‰∏≠${membersStats.filter(s => s.bestRank && s.bestRank <= 3).length}ÂêçÊàêÂëòËé∑ÂæóËøáÂâç3ÂêçÁöÑÂ•ΩÊàêÁª©„ÄÇ</p>` : '<p><strong>Ë°®Áé∞ÁªüËÆ°Ôºö</strong>Ë°ÄÁ≥ªÊàêÂëòÊöÇÊó†ÂèÇËµõËÆ∞ÂΩï„ÄÇ</p>'}
        ${membersStats.length > 0 && membersStats[0].bestRank ? `<p><strong>ÊúÄ‰Ω≥Ë°®Áé∞Ôºö</strong>${membersStats[0].pigeon.name || membersStats[0].pigeon.ring}Ë°®Áé∞ÊúÄ‰Ω≥ÔºåËé∑ÂæóÁ¨¨${membersStats[0].bestRank}ÂêçÁöÑÂ•ΩÊàêÁª©„ÄÇ</p>` : ''}
        <p><strong>Âª∫ËÆÆÔºö</strong>${descendants.length > 0 ? 'ËØ•Ë°ÄÁ≥ªÂ∑≤ÊúâÂêé‰ª£‰∫ßÂá∫ÔºåÂª∫ËÆÆÊåÅÁª≠ËøΩË∏™Âêé‰ª£Ë°®Áé∞ÔºåËØÑ‰º∞Ë°ÄÁ≥ªÁöÑÈÅó‰º†‰ºòÂäø„ÄÇ' : 'Âª∫ËÆÆÂä†Âº∫ËØ•Ë°ÄÁ≥ªÁöÑÁπÅËÇ≤ÔºåÈÄöËøáÈÖçÂØπ‰∫ßÁîüÂêé‰ª£ÔºåÈ™åËØÅË°ÄÁ≥ªÁöÑËÇ≤Áßç‰ª∑ÂÄº„ÄÇ'}</p>
      </div>
    `;
    
    container.innerHTML = html;
  }
  
  // ÁîüÊàêÁà∂ÊØçÂêé‰ª£ÁªüËÆ°ÔºàÁªüËÆ°ËØ•È∏ΩÂ≠ê‰Ωú‰∏∫Áà∂ÊØçÁöÑÂêé‰ª£Ë°®Áé∞Ôºâ
  function generateParentsOffspringStats(pigeonId) {
    const container = document.getElementById('raceStatsContainer');
    if (!container) return;
    
    const pigeon = getPigeonById(pigeonId);
    if (!pigeon) {
      container.innerHTML = '<p class="muted">Êú™ÊâæÂà∞ËØ•È∏ΩÂ≠ê</p>';
      return;
    }
    
    // Êü•ÊâæËØ•È∏ΩÂ≠êÁöÑÊâÄÊúâÂêé‰ª£Ôºà‰Ωú‰∏∫Áà∂‰∫≤ÊàñÊØç‰∫≤ÁöÑÔºâ
    const childrenAsFather = pigeons.filter(p => p.fatherId === pigeonId);
    const childrenAsMother = pigeons.filter(p => p.motherId === pigeonId);
    const allOffspring = [...new Set([...childrenAsFather, ...childrenAsMother])];
    
    if (allOffspring.length === 0) {
      container.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ËØ•È∏ΩÂ≠êÊöÇÊó†Âêé‰ª£ËÆ∞ÂΩï</p>';
      return;
    }
    
    // ÁªüËÆ°Âêé‰ª£Ë°®Áé∞
    const offspringStats = [];
    let totalOffspringRaces = 0;
    
    allOffspring.forEach(child => {
      let childRaces = child.races || [];
      if (childRaces.length === 0) {
        races.forEach(race => {
          const participant = race.participants.find(p => p.pigeonId === child.id);
          if (participant) {
            childRaces.push({
              raceName: race.name,
              date: race.date,
              location: race.location,
              rank: participant.rank,
              score: participant.score
            });
          }
        });
      }
      
      const ranks = childRaces.filter(r => r.rank).map(r => r.rank);
      const bestRank = ranks.length > 0 ? Math.min(...ranks) : null;
      const avgRank = ranks.length > 0 ? 
        Math.round(ranks.reduce((a, b) => a + b, 0) / ranks.length) : null;
      const wins = ranks.filter(r => r <= 3).length;
      const top10Count = ranks.filter(r => r <= 10).length;
      
      const parentRole = child.fatherId === pigeonId && child.motherId === pigeonId ? 'Áà∂+ÊØç' :
                        child.fatherId === pigeonId ? 'Áà∂‰∫≤' : 'ÊØç‰∫≤';
      
      offspringStats.push({
        pigeon: child,
        parentRole,
        totalRaces: childRaces.length,
        bestRank,
        avgRank,
        wins,
        top10Count
      });
      
      totalOffspringRaces += childRaces.length;
    });
    
    offspringStats.sort((a, b) => (b.bestRank ? 0 : 1) - (a.bestRank ? 0 : 1) || (a.bestRank || 999) - (b.bestRank || 999));
    
    const racedOffspring = offspringStats.filter(s => s.totalRaces > 0);
    const awardedOffspring = offspringStats.filter(s => s.wins > 0);
    const avgBestRank = awardedOffspring.length > 0 ? 
      Math.round(awardedOffspring.reduce((sum, s) => sum + (s.bestRank || 999), 0) / awardedOffspring.length) : null;
    
    // ÁîüÊàêHTML
    let html = `
      <div class="stats-chart-container">
        <h3 style="margin:0 0 20px 0;color:#1f2937;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ${pigeon.name || pigeon.ring} (${pigeon.ring}) Âêé‰ª£Ë°®Áé∞ÁªüËÆ°</h3>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:24px;">
          <div style="background:linear-gradient(135deg, #e6f0ff 0%, #dbeafe 100%);padding:16px;border-radius:8px;">
            <div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Âêé‰ª£ÊÄªÊï∞</div>
            <div style="font-size:24px;font-weight:700;color:#1f2937;">${allOffspring.length}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);padding:16px;border-radius:8px;">
            <div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÂèÇËµõÂêé‰ª£</div>
            <div style="font-size:24px;font-weight:700;color:#1f2937;">${racedOffspring.length}</div>
          </div>
          <div style="background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);padding:16px;border-radius:8px;">
            <div style="font-size:12px;color:#6b7280;margin-bottom:4px;">Ëé∑Â•ñÂêé‰ª£</div>
            <div style="font-size:24px;font-weight:700;color:#1f2937;">${awardedOffspring.length}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);padding:16px;border-radius:8px;">
            <div style="font-size:12px;color:#6b7280;margin-bottom:4px;">ÊÄªÂèÇËµõÊ¨°Êï∞</div>
            <div style="font-size:24px;font-weight:700;color:#1f2937;">${totalOffspringRaces}</div>
          </div>
        </div>
        
        <h4 style="margin:20px 0 12px 0;color:#374151;">Âêé‰ª£Ë°®Áé∞ËØ¶ÊÉÖ</h4>
        <div style="background:#fff;border-radius:10px;padding:20px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
    `;
    
    if (offspringStats.length > 0) {
      html += `
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:#f9fafb;">
              <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">Âêé‰ª£</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">‰Ωú‰∏∫</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂèÇËµõÊ¨°Êï∞</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">ÊúÄ‰Ω≥ÂêçÊ¨°</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Âπ≥ÂùáÂêçÊ¨°</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Ëé∑Â•ñÊ¨°Êï∞</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      offspringStats.forEach(stats => {
        html += `
          <tr style="border-bottom:1px solid #f0f0f0;">
            <td style="padding:12px;">
              <strong>${stats.pigeon.name || stats.pigeon.ring}</strong>
              <span style="color:#6b7280;font-size:12px;margin-left:8px;">(${stats.pigeon.ring})</span>
            </td>
            <td style="padding:12px;text-align:center;">
              <span style="background:#dbeafe;color:#1e40af;padding:4px 8px;border-radius:4px;font-size:12px;">${stats.parentRole}</span>
            </td>
            <td style="padding:12px;text-align:center;font-weight:600;">${stats.totalRaces}Âú∫</td>
            <td style="padding:12px;text-align:center;font-weight:600;color:#10b981;">${stats.bestRank ? `Á¨¨${stats.bestRank}Âêç` : '‚Äî'}</td>
            <td style="padding:12px;text-align:center;">${stats.avgRank ? `Á¨¨${stats.avgRank}Âêç` : '‚Äî'}</td>
            <td style="padding:12px;text-align:center;font-weight:600;color:#f59e0b;">${stats.wins}Ê¨°</td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
    } else {
      html += '<p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†Âêé‰ª£Ë°®Áé∞Êï∞ÊçÆ</p>';
    }
    
    html += `
        </div>
      </div>
      
      <div class="analysis-conclusion">
        <h4>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Âêé‰ª£Ë°®Áé∞ÂàÜÊûêÁªìËÆ∫</h4>
        <p><strong>Âêé‰ª£Ê¶ÇÂÜµÔºö</strong>ËØ•È∏ΩÂ≠êÂÖ±Êúâ${allOffspring.length}Âè™Âêé‰ª£ÔºåÂÖ∂‰∏≠${childrenAsFather.length}Âè™‰Ωú‰∏∫Áà∂‰∫≤‰∫ßÂá∫Ôºå${childrenAsMother.length}Âè™‰Ωú‰∏∫ÊØç‰∫≤‰∫ßÂá∫„ÄÇ</p>
        ${racedOffspring.length > 0 ? `<p><strong>ÂèÇËµõÊÉÖÂÜµÔºö</strong>${racedOffspring.length}Âè™Âêé‰ª£ÂèÇÂä†ËøáÊØîËµõÔºåÁ¥ØËÆ°ÂèÇËµõ${totalOffspringRaces}Ê¨°ÔºåÂèÇËµõÁéá${((racedOffspring.length / allOffspring.length) * 100).toFixed(1)}%„ÄÇ</p>` : '<p><strong>ÂèÇËµõÊÉÖÂÜµÔºö</strong>Âêé‰ª£ÊöÇÊó†ÂèÇËµõËÆ∞ÂΩï„ÄÇ</p>'}
        ${awardedOffspring.length > 0 ? `<p><strong>Ëé∑Â•ñÊÉÖÂÜµÔºö</strong>${awardedOffspring.length}Âè™Âêé‰ª£Ëé∑ÂæóËøáÂâç3ÂêçÁöÑÂ•ΩÊàêÁª©ÔºåËé∑Â•ñÁéá${((awardedOffspring.length / racedOffspring.length) * 100).toFixed(1)}%ÔºåÊúÄ‰Ω≥Âêé‰ª£ÂêçÊ¨°‰∏∫Á¨¨${offspringStats[0]?.bestRank}Âêç„ÄÇ</p>` : ''}
        ${avgBestRank ? `<p><strong>Âπ≥ÂùáË°®Áé∞Ôºö</strong>Ëé∑Â•ñÂêé‰ª£ÁöÑÂπ≥ÂùáÊúÄ‰Ω≥ÂêçÊ¨°‰∏∫Á¨¨${avgBestRank}Âêç„ÄÇ</p>` : ''}
        <p><strong>Âª∫ËÆÆÔºö</strong>${awardedOffspring.length > 0 && avgBestRank && avgBestRank <= 5 ? 'ËØ•È∏ΩÂ≠êÁöÑÂêé‰ª£Ë°®Áé∞‰ºòÁßÄÔºåÂª∫ËÆÆÁªßÁª≠‰Ωú‰∏∫ÁßçÈ∏Ω‰ΩøÁî®ÔºåÈáçÁÇπÂÖ≥Ê≥®ÂÖ∂Âêé‰ª£ÁöÑÈÖçÂØπÈÄâÊã©„ÄÇ' : awardedOffspring.length > 0 ? 'ËØ•È∏ΩÂ≠êÁöÑÂêé‰ª£Ë°®Áé∞ËâØÂ•ΩÔºåÂª∫ËÆÆÁªßÁª≠ËßÇÂØüÊõ¥Â§öÂêé‰ª£Ë°®Áé∞ÔºåËØÑ‰º∞ÂÖ∂ËÇ≤Áßç‰ª∑ÂÄº„ÄÇ' : racedOffspring.length === 0 ? 'Âª∫ËÆÆËÆ©Âêé‰ª£ÂèÇÂä†ÊØîËµõÔºåÈ™åËØÅËØ•È∏ΩÂ≠êÁöÑËÇ≤ÁßçËÉΩÂäõ„ÄÇ' : 'Âêé‰ª£Ë°®Áé∞ÊúâÂæÖÊèêÂçáÔºåÂª∫ËÆÆËÄÉËôëË∞ÉÊï¥ÈÖçÂØπÁ≠ñÁï•ÊàñÈÄâÊã©ÂÖ∂‰ªñÁßçÈ∏Ω„ÄÇ'}</p>
      </div>
    `;
    
    container.innerHTML = html;
  }
  
  // ========================================
  // üß¨ Ë°ÄÁªüÂØπÊØîÂàÜÊûêÂäüËÉΩ
  // ========================================
  
  // ÂàùÂßãÂåñË°ÄÁªüÂØπÊØîÂäüËÉΩ
  function initPedigreeComparison() {
    // Â°´ÂÖÖÈ∏ΩÂ≠êÈÄâÊã©‰∏ãÊãâÊ°Ü
    const selectA = document.getElementById('comparisonPigeonA');
    const selectB = document.getElementById('comparisonPigeonB');
    
    if (selectA && selectB) {
      // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°πÔºà‰øùÁïôÁ¨¨‰∏Ä‰∏™ÈÄâÈ°πÔºâ
      selectA.innerHTML = '<option value="">ÈÄâÊã©Á¨¨‰∏ÄÂè™È∏ΩÂ≠ê...</option>';
      selectB.innerHTML = '<option value="">ÈÄâÊã©Á¨¨‰∫åÂè™È∏ΩÂ≠ê...</option>';
      
      // Ê∑ªÂä†ÊâÄÊúâÈ∏ΩÂ≠ê
      pigeons.forEach(p => {
        const optionA = document.createElement('option');
        optionA.value = p.id;
        optionA.textContent = `${p.name || p.ring} (${p.ring})`;
        selectA.appendChild(optionA);
        
        const optionB = document.createElement('option');
        optionB.value = p.id;
        optionB.textContent = `${p.name || p.ring} (${p.ring})`;
        selectB.appendChild(optionB);
      });
    }
    
    // ÁªëÂÆöÂØπÊØîÊåâÈíÆ‰∫ã‰ª∂
    const btnCompare = document.getElementById('btnComparePedigree');
    if (btnCompare) {
      btnCompare.addEventListener('click', performPedigreeComparison);
    }
  }
  
  // ÊâßË°åË°ÄÁªüÂØπÊØîÂàÜÊûê
  function performPedigreeComparison() {
    const pigeonAId = document.getElementById('comparisonPigeonA')?.value;
    const pigeonBId = document.getElementById('comparisonPigeonB')?.value;
    const resultsContainer = document.getElementById('pedigreeComparisonResults');
    
    if (!pigeonAId || !pigeonBId) {
      alert('ËØ∑ÈÄâÊã©‰∏§Âè™È∏ΩÂ≠êËøõË°åÂØπÊØî');
      return;
    }
    
    if (pigeonAId === pigeonBId) {
      alert('ËØ∑ÈÄâÊã©‰∏çÂêåÁöÑ‰∏§Âè™È∏ΩÂ≠êËøõË°åÂØπÊØî');
      return;
    }
    
    const pigeonA = getPigeonById(pigeonAId);
    const pigeonB = getPigeonById(pigeonBId);
    
    if (!pigeonA || !pigeonB) {
      alert('Êú™ÊâæÂà∞ÈÄâ‰∏≠ÁöÑÈ∏ΩÂ≠ê');
      return;
    }
    
    // Ëé∑ÂèñË°ÄÁªüÊï∞ÊçÆ
    const ancestorsA = getAncestors(pigeonAId, 5);
    const ancestorsB = getAncestors(pigeonBId, 5);
    
    // Ëé∑ÂèñÊâÄÊúâÁ•ñÂÖàIDÈõÜÂêà
    const ancestorIdsA = new Set([pigeonAId, ...ancestorsA.map(a => a.id)]);
    const ancestorIdsB = new Set([pigeonBId, ...ancestorsB.map(a => a.id)]);
    
    // ÊâæÂá∫ÂÖ±ÂêåÁ•ñÂÖà
    const commonAncestors = [];
    ancestorIdsA.forEach(id => {
      if (ancestorIdsB.has(id) && id !== pigeonAId && id !== pigeonBId) {
        const ancestor = getPigeonById(id);
        if (ancestor) {
          const genA = ancestorsA.find(a => a.id === id)?.generation || 0;
          const genB = ancestorsB.find(a => a.id === id)?.generation || 0;
          commonAncestors.push({
            pigeon: ancestor,
            generationA: genA,
            generationB: genB
          });
        }
      }
    });
    
    // ËÆ°ÁÆóË°ÄÁªüÁõ∏‰ººÂ∫¶ÔºàÂÖ±ÂêåÁ•ñÂÖàÊï∞Èáè / ÊÄªÁ•ñÂÖàÊï∞ÈáèÔºâ
    const totalUniqueAncestors = new Set([...ancestorIdsA, ...ancestorIdsB]).size;
    const similarity = totalUniqueAncestors > 0 ? 
      ((commonAncestors.length * 2) / totalUniqueAncestors * 100).toFixed(1) : 0;
    
    // ËÆ°ÁÆóËøë‰∫≤Á≥ªÊï∞ÔºàÂ¶ÇÊûú‰∏§Âè™È∏ΩÂ≠êÈÖçÂØπÔºâ
    const inbreedingCoeff = calculateInbreedingCoefficient(pigeonAId, pigeonBId);
    
    // ÁîüÊàêÂØπÊØîÁªìÊûúHTML
    let html = '';
    
    // 1. Âü∫Êú¨‰ø°ÊÅØÂØπÊØî
    html += `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;">
        <div style="padding:20px;background:linear-gradient(135deg, #e6f0ff 0%, #dbeafe 100%);border-radius:12px;border:2px solid #3b82f6;">
          <h5 style="margin:0 0 12px;color:#1e40af;">È∏ΩÂ≠ê A</h5>
          <div style="font-size:18px;font-weight:700;color:#1f2937;margin-bottom:8px;">${pigeonA.name || pigeonA.ring}</div>
          <div style="font-size:14px;color:#6b7280;margin-bottom:12px;">Ë∂≥ÁéØÂè∑: ${pigeonA.ring}</div>
          <div style="font-size:13px;color:#4b5563;">
            <div style="margin-bottom:4px;">Á±ªÂûã: ${pigeonA.type || '‚Äî'}</div>
            <div style="margin-bottom:4px;">Áä∂ÊÄÅ: ${pigeonA.alive ? '‚úÖ Âú®‰∏ñ' : '‚ùå Â∑≤ÊïÖ'}</div>
            <div style="margin-bottom:4px;">Ê†∏ÂøÉÈ∏Ω: ${pigeonA.isCore ? '‚≠ê ÊòØ' : 'Âê¶'}</div>
            <div>Á•ñÂÖàÊï∞Èáè: ${ancestorsA.length}‰ª£</div>
          </div>
        </div>
        <div style="padding:20px;background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);border-radius:12px;border:2px solid #ec4899;">
          <h5 style="margin:0 0 12px;color:#be185d;">È∏ΩÂ≠ê B</h5>
          <div style="font-size:18px;font-weight:700;color:#1f2937;margin-bottom:8px;">${pigeonB.name || pigeonB.ring}</div>
          <div style="font-size:14px;color:#6b7280;margin-bottom:12px;">Ë∂≥ÁéØÂè∑: ${pigeonB.ring}</div>
          <div style="font-size:13px;color:#4b5563;">
            <div style="margin-bottom:4px;">Á±ªÂûã: ${pigeonB.type || '‚Äî'}</div>
            <div style="margin-bottom:4px;">Áä∂ÊÄÅ: ${pigeonB.alive ? '‚úÖ Âú®‰∏ñ' : '‚ùå Â∑≤ÊïÖ'}</div>
            <div style="margin-bottom:4px;">Ê†∏ÂøÉÈ∏Ω: ${pigeonB.isCore ? '‚≠ê ÊòØ' : 'Âê¶'}</div>
            <div>Á•ñÂÖàÊï∞Èáè: ${ancestorsB.length}‰ª£</div>
          </div>
        </div>
      </div>
    `;
    document.getElementById('comparisonBasicInfo').innerHTML = html;
    
    // 2. Ë°ÄÁªüÁõ∏‰ººÂ∫¶ÂàÜÊûê
    html = `
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:20px;">
        <div style="background:#fff;padding:20px;border-radius:12px;text-align:center;border:2px solid #e5e7eb;">
          <div style="font-size:12px;color:#6b7280;margin-bottom:8px;">Ë°ÄÁªüÁõ∏‰ººÂ∫¶</div>
          <div style="font-size:36px;font-weight:700;color:#2563eb;margin-bottom:4px;">${similarity}%</div>
          <div style="font-size:12px;color:#6b7280;">ÂÖ±ÂêåÁ•ñÂÖà: ${commonAncestors.length}Âè™</div>
        </div>
        <div style="background:#fff;padding:20px;border-radius:12px;text-align:center;border:2px solid #e5e7eb;">
          <div style="font-size:12px;color:#6b7280;margin-bottom:8px;">Ëøë‰∫≤Á≥ªÊï∞</div>
          <div style="font-size:36px;font-weight:700;color:${inbreedingCoeff > 0.125 ? '#ef4444' : inbreedingCoeff > 0.0625 ? '#f59e0b' : '#10b981'};margin-bottom:4px;">
            ${(inbreedingCoeff * 100).toFixed(2)}%
          </div>
          <div style="font-size:12px;color:#6b7280;">
            ${inbreedingCoeff > 0.125 ? '‚ö†Ô∏è È´òÂ∫¶Ëøë‰∫≤' : inbreedingCoeff > 0.0625 ? '‚ö° ‰∏≠Â∫¶Ëøë‰∫≤' : '‚úÖ ‰ΩéÂ∫¶Ëøë‰∫≤'}
          </div>
        </div>
        <div style="background:#fff;padding:20px;border-radius:12px;text-align:center;border:2px solid #e5e7eb;">
          <div style="font-size:12px;color:#6b7280;margin-bottom:8px;">ÊÄªÁ•ñÂÖàÊï∞</div>
          <div style="font-size:36px;font-weight:700;color:#1f2937;margin-bottom:4px;">${totalUniqueAncestors}</div>
          <div style="font-size:12px;color:#6b7280;">A: ${ancestorIdsA.size} | B: ${ancestorIdsB.size}</div>
        </div>
      </div>
      <div style="background:#f9fafb;padding:16px;border-radius:8px;margin-top:16px;">
        <p style="margin:0;font-size:14px;color:#4b5563;line-height:1.6;">
          <strong>ÂàÜÊûêËØ¥ÊòéÔºö</strong>
          ${similarity > 50 ? 'Ëøô‰∏§Âè™È∏ΩÂ≠êË°ÄÁªüÁõ∏‰ººÂ∫¶ËæÉÈ´òÔºåÂèØËÉΩÂ≠òÂú®ËæÉËøëÁöÑ‰∫≤ÁºòÂÖ≥Á≥ª„ÄÇ' : 
            similarity > 20 ? 'Ëøô‰∏§Âè™È∏ΩÂ≠êÂ≠òÂú®‰∏ÄÂÆöÁöÑË°ÄÁªüÂÖ≥ËÅîÔºå‰ΩÜÂÖ≥Á≥ªÁõ∏ÂØπËæÉËøú„ÄÇ' : 
            'Ëøô‰∏§Âè™È∏ΩÂ≠êË°ÄÁªüÁõ∏‰ººÂ∫¶ËæÉ‰ΩéÔºå‰∫≤ÁºòÂÖ≥Á≥ªËæÉËøú„ÄÇ'}
          ${inbreedingCoeff > 0.125 ? '‚ö†Ô∏è Â¶ÇÊûúËøô‰∏§Âè™È∏ΩÂ≠êÈÖçÂØπÔºå‰ºö‰∫ßÁîüÈ´òÂ∫¶Ëøë‰∫≤ÁöÑÂêé‰ª£ÔºåÂª∫ËÆÆË∞®ÊÖéËÄÉËôë„ÄÇ' : 
            inbreedingCoeff > 0.0625 ? '‚ö° Â¶ÇÊûúËøô‰∏§Âè™È∏ΩÂ≠êÈÖçÂØπÔºå‰ºö‰∫ßÁîü‰∏≠Â∫¶Ëøë‰∫≤ÁöÑÂêé‰ª£ÔºåÈúÄË¶ÅËØÑ‰º∞ËÇ≤ÁßçÁõÆÊ†á„ÄÇ' : 
            '‚úÖ Â¶ÇÊûúËøô‰∏§Âè™È∏ΩÂ≠êÈÖçÂØπÔºåËøë‰∫≤Á≥ªÊï∞ËæÉ‰ΩéÔºåÂèØ‰ª•Ê≠£Â∏∏ÈÖçÂØπ„ÄÇ'}
        </p>
      </div>
    `;
    document.getElementById('comparisonSimilarity').innerHTML = html;
    
    // 3. ÂÖ±ÂêåÁ•ñÂÖàÂàóË°®
    if (commonAncestors.length > 0) {
      html = `
        <div style="background:#fff;border-radius:10px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
          <table style="width:100%;border-collapse:collapse;">
            <thead>
              <tr style="background:#f9fafb;">
                <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">ÂÖ±ÂêåÁ•ñÂÖà</th>
                <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Âú®AÁöÑ‰ª£Êï∞</th>
                <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Âú®BÁöÑ‰ª£Êï∞</th>
                <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Áä∂ÊÄÅ</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      commonAncestors.forEach(ca => {
        html += `
          <tr style="border-bottom:1px solid #f0f0f0;">
            <td style="padding:12px;">
              <strong>${ca.pigeon.name || ca.pigeon.ring}</strong>
              <span style="color:#6b7280;font-size:12px;margin-left:8px;">(${ca.pigeon.ring})</span>
              ${ca.pigeon.isCore ? '<span style="background:#fef3c7;color:#92400e;padding:2px 6px;border-radius:4px;font-size:11px;margin-left:8px;">Ê†∏ÂøÉ</span>' : ''}
            </td>
            <td style="padding:12px;text-align:center;font-weight:600;color:#2563eb;">Á¨¨${ca.generationA}‰ª£</td>
            <td style="padding:12px;text-align:center;font-weight:600;color:#ec4899;">Á¨¨${ca.generationB}‰ª£</td>
            <td style="padding:12px;text-align:center;">
              <span style="background:${ca.pigeon.alive ? '#d1fae5' : '#fee2e2'};color:${ca.pigeon.alive ? '#065f46' : '#991b1b'};padding:4px 8px;border-radius:4px;font-size:12px;">
                ${ca.pigeon.alive ? '‚úÖ Âú®‰∏ñ' : '‚ùå Â∑≤ÊïÖ'}
              </span>
            </td>
          </tr>
        `;
      });
      
      html += `
            </tbody>
          </table>
        </div>
      `;
    } else {
      html = '<p class="muted" style="text-align:center;padding:40px;">Êú™ÂèëÁé∞ÂÖ±ÂêåÁ•ñÂÖàÔºà5‰ª£ÂÜÖÔºâ</p>';
    }
    document.getElementById('comparisonCommonAncestors').innerHTML = html;
    
    // 4. Ëøë‰∫≤Á≥ªÊï∞ËØ¶ÁªÜÂàÜÊûê
    html = `
      <div style="background:#fff;border-radius:10px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
        <div style="margin-bottom:16px;">
          <div style="font-size:16px;font-weight:600;color:#1f2937;margin-bottom:8px;">ÈÖçÂØπÂª∫ËÆÆ</div>
          <div style="padding:16px;background:${inbreedingCoeff > 0.125 ? '#fef2f2' : inbreedingCoeff > 0.0625 ? '#fffbeb' : '#f0fdf4'};border-radius:8px;border-left:4px solid ${inbreedingCoeff > 0.125 ? '#ef4444' : inbreedingCoeff > 0.0625 ? '#f59e0b' : '#10b981'};">
            <p style="margin:0;font-size:14px;color:#4b5563;line-height:1.6;">
              ${inbreedingCoeff > 0.125 ? 
                '‚ö†Ô∏è <strong>È´òÂ∫¶Ëøë‰∫≤ÈÖçÂØπ</strong>ÔºöËøë‰∫≤Á≥ªÊï∞‰∏∫ ' + (inbreedingCoeff * 100).toFixed(2) + '%ÔºåÂ¶ÇÊûúËøô‰∏§Âè™È∏ΩÂ≠êÈÖçÂØπÔºåÂêé‰ª£ÂèØËÉΩÂá∫Áé∞Ëøë‰∫§Ë°∞ÈÄÄÁé∞Ë±°ÔºåÂª∫ËÆÆÈÅøÂÖçÊàñË∞®ÊÖéËÄÉËôë„ÄÇ' :
                inbreedingCoeff > 0.0625 ?
                '‚ö° <strong>‰∏≠Â∫¶Ëøë‰∫≤ÈÖçÂØπ</strong>ÔºöËøë‰∫≤Á≥ªÊï∞‰∏∫ ' + (inbreedingCoeff * 100).toFixed(2) + '%ÔºåÂ¶ÇÊûúËøô‰∏§Âè™È∏ΩÂ≠êÈÖçÂØπÔºåÂèØ‰ª•Âõ∫ÂÆöÊüê‰∫õ‰ºòËâØÊÄßÁä∂Ôºå‰ΩÜÈúÄË¶ÅÂØÜÂàáËßÇÂØüÂêé‰ª£Ë°®Áé∞„ÄÇ' :
                '‚úÖ <strong>‰ΩéÂ∫¶Ëøë‰∫≤ÈÖçÂØπ</strong>ÔºöËøë‰∫≤Á≥ªÊï∞‰∏∫ ' + (inbreedingCoeff * 100).toFixed(2) + '%ÔºåÂ¶ÇÊûúËøô‰∏§Âè™È∏ΩÂ≠êÈÖçÂØπÔºåËøë‰∫≤Á®ãÂ∫¶ËæÉ‰ΩéÔºåÂèØ‰ª•Ê≠£Â∏∏ÈÖçÂØπÔºåÊúâÂà©‰∫é‰øùÊåÅË°ÄÁªüÁ∫ØÂ∫¶„ÄÇ'}
            </p>
          </div>
        </div>
        <div style="font-size:13px;color:#6b7280;">
          <p style="margin:0;"><strong>ËØ¥ÊòéÔºö</strong>Ëøë‰∫≤Á≥ªÊï∞ÔºàInbreeding CoefficientÔºâË°®Á§∫Â¶ÇÊûú‰∏§Âè™È∏ΩÂ≠êÈÖçÂØπÔºåÂÖ∂Âêé‰ª£‰∏éÁ∫ØÂêàÂ≠êÁöÑÁõ∏‰ººÁ®ãÂ∫¶„ÄÇÁ≥ªÊï∞Ë∂äÈ´òÔºåË°®Á§∫Ëøë‰∫≤Á®ãÂ∫¶Ë∂äÈ´ò„ÄÇ</p>
        </div>
      </div>
    `;
    document.getElementById('comparisonInbreeding').innerHTML = html;
    
    // 5. Ë°ÄÁªüÊ†ëÂØπÊØîÔºàÁÆÄÂåñÁâàÔºâ
    html = `
      <div style="padding:20px;background:#f9fafb;border-radius:12px;">
        <h5 style="margin:0 0 16px;color:#1f2937;">È∏ΩÂ≠ê A Ë°ÄÁªüÊ†ëÔºà5‰ª£Ôºâ</h5>
        <div style="background:#fff;padding:16px;border-radius:8px;min-height:150px;font-size:13px;color:#4b5563;">
          ${ancestorsA.length > 0 ? 
            ancestorsA.slice(0, 10).map(a => {
              const p = getPigeonById(a.id);
              return p ? `${p.name || p.ring} (Á¨¨${a.generation}‰ª£)` : '';
            }).filter(Boolean).join(' ‚Ä¢ ') + (ancestorsA.length > 10 ? ' ...' : '') :
            'ÊöÇÊó†Á•ñÂÖàËÆ∞ÂΩï'}
        </div>
      </div>
      <div style="padding:20px;background:#f9fafb;border-radius:12px;">
        <h5 style="margin:0 0 16px;color:#1f2937;">È∏ΩÂ≠ê B Ë°ÄÁªüÊ†ëÔºà5‰ª£Ôºâ</h5>
        <div style="background:#fff;padding:16px;border-radius:8px;min-height:150px;font-size:13px;color:#4b5563;">
          ${ancestorsB.length > 0 ? 
            ancestorsB.slice(0, 10).map(a => {
              const p = getPigeonById(a.id);
              return p ? `${p.name || p.ring} (Á¨¨${a.generation}‰ª£)` : '';
            }).filter(Boolean).join(' ‚Ä¢ ') + (ancestorsB.length > 10 ? ' ...' : '') :
            'ÊöÇÊó†Á•ñÂÖàËÆ∞ÂΩï'}
        </div>
      </div>
    `;
    document.getElementById('comparisonPedigreeTrees').innerHTML = html;
    
    // ÊòæÁ§∫ÁªìÊûúÂå∫Âüü
    if (resultsContainer) {
      resultsContainer.style.display = 'block';
      resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }
  
  // ÁîüÊàêÁªºÂêàÂàÜÊûêÔºàËá™Âä®ËØªÂèñÊâÄÊúâÊï∞ÊçÆÔºâ
  function generateOverallAnalysis() {
    const container = document.getElementById('raceAnalysisContainer');
    if (!container) return;
    
    // Ëá™Âä®ÂêåÊ≠•ÊØîËµõÊï∞ÊçÆ
    syncRacesToPigeons();
    
    // ÈáçÊñ∞Âä†ËΩΩÈ∏ΩÂ≠êÊï∞ÊçÆ‰ª•Á°Æ‰øùËé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆ
    loadFromStorage();
    
    // Êî∂ÈõÜÊâÄÊúâÁªüËÆ°Êï∞ÊçÆ
    const allPigeonRaces = [];
    const winners = []; // Ëé∑Â•ñÈ∏ΩÂ≠êÔºàÂâç3ÂêçÔºâ
    const top10 = []; // Ââç10Âêç
    const breedersWithRaces = []; // ÁßçÈ∏ΩÂèÇËµõËÆ∞ÂΩï
    const raceStats = {
      totalRaces: races.length,
      totalParticipants: 0,
      totalWinners: 0,
      byMonth: {},
      byLocation: {},
      byWeather: {}
    };
    
    // ÁªüËÆ°ÊØèÂè™È∏ΩÂ≠êÁöÑÊØîËµõÊï∞ÊçÆ
    pigeons.forEach(p => {
      // Ê£ÄÊü•ÊòØÂê¶ÊúâÊØîËµõËÆ∞ÂΩïÔºà‰ªéracesÂ≠óÊÆµÊàñ‰ªéÊØîËµõÊï∞ÊçÆ‰∏≠Êü•ÊâæÔºâ
      let pigeonRaces = p.races || [];
      
      // Â¶ÇÊûúÈ∏ΩÂ≠êÊ°£Ê°à‰∏≠Ê≤°ÊúâÊØîËµõËÆ∞ÂΩïÔºå‰ªéÊØîËµõÊï∞ÊçÆ‰∏≠Êü•Êâæ
      if (pigeonRaces.length === 0) {
        races.forEach(race => {
          const participant = race.participants.find(part => part.pigeonId === p.id);
          if (participant) {
            pigeonRaces.push({
              raceId: race.id,
              raceName: race.name,
              date: race.date,
              location: race.location,
              weather: race.weather,
              rank: participant.rank,
              score: participant.score,
              returnTime: participant.returnTime
            });
          }
        });
      }
      
      if (pigeonRaces.length > 0) {
        const pigeonStats = {
          pigeon: p,
          totalRaces: pigeonRaces.length,
          bestRank: null,
          avgRank: null,
          totalScore: 0,
          avgScore: null,
          wins: 0, // Ââç3ÂêçÊ¨°Êï∞
          top10Count: 0, // Ââç10ÂêçÊ¨°Êï∞
          isBreeder: p.type === 'ÁßçÈ∏Ω' || p.isCore // Ê†áËÆ∞ÊòØÂê¶‰∏∫ÁßçÈ∏Ω
        };
        
        const ranks = [];
        const scores = [];
        
        pigeonRaces.forEach(race => {
          if (race.rank) {
            ranks.push(race.rank);
            if (race.rank <= 3) pigeonStats.wins++;
            if (race.rank <= 10) pigeonStats.top10Count++;
            if (!pigeonStats.bestRank || race.rank < pigeonStats.bestRank) {
              pigeonStats.bestRank = race.rank;
            }
          }
          if (race.score) {
            scores.push(race.score);
            pigeonStats.totalScore += race.score;
          }
          
          // ÁªüËÆ°ÊØîËµõ‰ø°ÊÅØ
          raceStats.totalParticipants++;
          const month = race.date.substring(0, 7);
          raceStats.byMonth[month] = (raceStats.byMonth[month] || 0) + 1;
          raceStats.byLocation[race.location] = (raceStats.byLocation[race.location] || 0) + 1;
          if (race.weather) {
            raceStats.byWeather[race.weather] = (raceStats.byWeather[race.weather] || 0) + 1;
          }
        });
        
        if (ranks.length > 0) {
          pigeonStats.avgRank = Math.round(ranks.reduce((a, b) => a + b, 0) / ranks.length);
        }
        if (scores.length > 0) {
          pigeonStats.avgScore = (pigeonStats.totalScore / scores.length).toFixed(2);
        }
        
        allPigeonRaces.push(pigeonStats);
        
        // Â¶ÇÊûúÊòØÁßçÈ∏Ω‰∏îÊúâÂèÇËµõËÆ∞ÂΩïÔºåÂçïÁã¨ËÆ∞ÂΩï
        if (pigeonStats.isBreeder) {
          breedersWithRaces.push(pigeonStats);
        }
        
        if (pigeonStats.wins > 0) {
          winners.push(pigeonStats);
        }
        if (pigeonStats.top10Count > 0) {
          top10.push(pigeonStats);
        }
      }
    });
    
    // ÊéíÂ∫è
    winners.sort((a, b) => b.wins - a.wins || (a.bestRank || 999) - (b.bestRank || 999));
    top10.sort((a, b) => b.top10Count - a.top10Count);
    allPigeonRaces.sort((a, b) => b.totalRaces - a.totalRaces);
    
    // ÁîüÊàêHTML
    let html = `
      <div class="stats-chart-container">
        <h3 style="margin:0 0 24px 0;color:#1f2937;">üìä ÁªºÂêàÊàêÁª©ÂàÜÊûêÊä•Âëä</h3>
        
        <!-- ÊÄª‰ΩìÁªüËÆ° -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:24px;">
          <div style="background:linear-gradient(135deg, #e6f0ff 0%, #dbeafe 100%);padding:20px;border-radius:10px;">
            <div style="font-size:13px;color:#6b7280;margin-bottom:8px;">ÊÄªÊØîËµõÂú∫Ê¨°</div>
            <div style="font-size:32px;font-weight:700;color:#1f2937;">${raceStats.totalRaces}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);padding:20px;border-radius:10px;">
            <div style="font-size:13px;color:#6b7280;margin-bottom:8px;">ÊÄªÂèÇËµõÊ¨°Êï∞</div>
            <div style="font-size:32px;font-weight:700;color:#1f2937;">${raceStats.totalParticipants}</div>
          </div>
          <div style="background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);padding:20px;border-radius:10px;">
            <div style="font-size:13px;color:#6b7280;margin-bottom:8px;">Ëé∑Â•ñÈ∏ΩÂ≠êÊï∞</div>
            <div style="font-size:32px;font-weight:700;color:#1f2937;">${winners.length}</div>
          </div>
          <div style="background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);padding:20px;border-radius:10px;">
            <div style="font-size:13px;color:#6b7280;margin-bottom:8px;">ÊúâÂèÇËµõËÆ∞ÂΩïÈ∏ΩÂ≠ê</div>
            <div style="font-size:32px;font-weight:700;color:#1f2937;">${allPigeonRaces.length}</div>
          </div>
        </div>
        
        <!-- Ëé∑Â•ñÈ∏ΩÂ≠êÊéíË°åÊ¶ú -->
        <h4 style="margin:24px 0 16px 0;color:#374151;">üèÜ Ëé∑Â•ñÈ∏ΩÂ≠êÊéíË°åÊ¶úÔºàÂâç3ÂêçÔºâ</h4>
        <div style="background:#fff;border-radius:10px;padding:20px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
    `;
    
    if (winners.length > 0) {
      html += `
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:#f9fafb;">
              <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">ÊéíÂêç</th>
              <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">È∏ΩÂ≠ê</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Ëé∑Â•ñÊ¨°Êï∞</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">ÊúÄ‰Ω≥ÂêçÊ¨°</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Âπ≥ÂùáÂêçÊ¨°</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂèÇËµõÊ¨°Êï∞</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      winners.slice(0, 10).forEach((stats, index) => {
        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
        html += `
          <tr style="border-bottom:1px solid #f0f0f0;">
            <td style="padding:12px;font-weight:600;color:#2b5cff;">${medal} ${index + 1}</td>
            <td style="padding:12px;">${stats.pigeon.name || stats.pigeon.ring} (${stats.pigeon.ring})</td>
            <td style="padding:12px;text-align:center;font-weight:600;color:#f59e0b;">${stats.wins}Ê¨°</td>
            <td style="padding:12px;text-align:center;font-weight:600;color:#10b981;">Á¨¨${stats.bestRank}Âêç</td>
            <td style="padding:12px;text-align:center;">${stats.avgRank ? `Á¨¨${stats.avgRank}Âêç` : '‚Äî'}</td>
            <td style="padding:12px;text-align:center;">${stats.totalRaces}Âú∫</td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
    } else {
      html += '<p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†Ëé∑Â•ñËÆ∞ÂΩï</p>';
    }
    
    html += `
        </div>
        
        <!-- ÊØîËµõÂàÜÂ∏ÉÂõæË°® -->
        <h4 style="margin:24px 0 16px 0;color:#374151;">üìÖ ÊØîËµõÊó∂Èó¥ÂàÜÂ∏É</h4>
        <div style="background:#fff;border-radius:10px;padding:24px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
          <div style="height:200px;display:flex;align-items:flex-end;justify-content:space-around;gap:8px;">
    `;
    
    // ÁîüÊàêÊúà‰ªΩÂàÜÂ∏ÉÊü±Áä∂Âõæ
    const months = Object.keys(raceStats.byMonth).sort();
    const maxCount = Math.max(...Object.values(raceStats.byMonth), 1);
    months.forEach(month => {
      const count = raceStats.byMonth[month];
      const height = (count / maxCount) * 160;
      html += `
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:8px;">
          <div style="width:100%;background:linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);border-radius:4px 4px 0 0;height:${height}px;min-height:20px;position:relative;">
            <div style="position:absolute;top:-24px;left:50%;transform:translateX(-50%);font-size:11px;font-weight:600;color:#1f2937;white-space:nowrap;">${count}</div>
          </div>
          <div style="font-size:11px;color:#6b7280;text-align:center;writing-mode:vertical-rl;text-orientation:mixed;">${month}</div>
        </div>
      `;
    });
    
    html += `
          </div>
        </div>
        
        <!-- Âú∞ÁÇπÂàÜÂ∏É -->
        <h4 style="margin:24px 0 16px 0;color:#374151;">üìç ÊØîËµõÂú∞ÁÇπÂàÜÂ∏É</h4>
        <div style="background:#fff;border-radius:10px;padding:20px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
          <div style="display:flex;flex-wrap:wrap;gap:12px;">
    `;
    
    Object.entries(raceStats.byLocation).sort((a, b) => b[1] - a[1]).forEach(([location, count]) => {
      html += `
        <div style="background:linear-gradient(135deg, #f0f7ff 0%, #e6f0ff 100%);padding:12px 16px;border-radius:8px;border:1px solid #dbeafe;">
          <span style="font-weight:600;color:#1f2937;">${location}</span>
          <span style="color:#6b7280;margin-left:8px;">${count}Âú∫</span>
        </div>
      `;
    });
    
    html += `
          </div>
        </div>
        
        <!-- ÁßçÈ∏ΩÂèÇËµõÊÉÖÂÜµ -->
        <h4 style="margin:24px 0 16px 0;color:#374151;">‚≠ê ÁßçÈ∏ΩÂèÇËµõÊÉÖÂÜµÂàÜÊûê</h4>
        <div style="background:#fff;border-radius:10px;padding:20px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
    `;
    
    if (breedersWithRaces.length > 0) {
      html += `
        <p style="margin:0 0 16px 0;color:#6b7280;">ÂÖ±Êúâ<strong style="color:#f59e0b;">${breedersWithRaces.length}</strong>Âè™ÁßçÈ∏ΩÂèÇÂä†ËøáÊØîËµõÔºö</p>
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:#f9fafb;">
              <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;">ÁßçÈ∏Ω</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂèÇËµõÊ¨°Êï∞</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">ÊúÄ‰Ω≥ÂêçÊ¨°</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Âπ≥ÂùáÂêçÊ¨°</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Ëé∑Â•ñÊ¨°Êï∞</th>
              <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;">Âπ≥ÂùáÂàÜÊï∞</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      breedersWithRaces.sort((a, b) => b.totalRaces - a.totalRaces || (a.bestRank || 999) - (b.bestRank || 999)).forEach(stats => {
        html += `
          <tr style="border-bottom:1px solid #f0f0f0;">
            <td style="padding:12px;">
              <strong style="color:#f59e0b;">${stats.pigeon.name || stats.pigeon.ring}</strong>
              <span style="color:#6b7280;font-size:12px;margin-left:8px;">(${stats.pigeon.ring})</span>
              ${stats.pigeon.isCore ? '<span style="background:#fef3c7;color:#b45309;padding:2px 6px;border-radius:4px;font-size:11px;margin-left:8px;">Ê†∏ÂøÉÁßçÈ∏Ω</span>' : ''}
            </td>
            <td style="padding:12px;text-align:center;font-weight:600;">${stats.totalRaces}Âú∫</td>
            <td style="padding:12px;text-align:center;font-weight:600;color:#10b981;">${stats.bestRank ? `Á¨¨${stats.bestRank}Âêç` : '‚Äî'}</td>
            <td style="padding:12px;text-align:center;">${stats.avgRank ? `Á¨¨${stats.avgRank}Âêç` : '‚Äî'}</td>
            <td style="padding:12px;text-align:center;font-weight:600;color:#f59e0b;">${stats.wins}Ê¨°</td>
            <td style="padding:12px;text-align:center;">${stats.avgScore || '‚Äî'}</td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
    } else {
      // Ê£ÄÊü•ÊòØÂê¶ÊúâÁßçÈ∏Ω‰ΩÜÊ≤°ÊúâÂèÇËµõËÆ∞ÂΩï
      const allBreeders = pigeons.filter(p => p.type === 'ÁßçÈ∏Ω' || p.isCore);
      if (allBreeders.length > 0) {
        html += `
          <p style="margin:0 0 12px 0;color:#6b7280;">Á≥ªÁªü‰∏≠ÂÖ±Êúâ<strong>${allBreeders.length}</strong>Âè™ÁßçÈ∏ΩÔºå‰ΩÜÊöÇÊó†ÂèÇËµõËÆ∞ÂΩï„ÄÇ</p>
          <p style="margin:0;color:#9ca3af;font-size:13px;">üí° ÊèêÁ§∫ÔºöÂ¶ÇÊûúÁßçÈ∏ΩÂ∑≤ÂèÇÂä†ÊØîËµõÔºåËØ∑Á°Æ‰øùÂú®"ÊØîËµõÂàóË°®"‰∏≠Ê∑ªÂä†ÊØîËµõËÆ∞ÂΩïÂπ∂ÂÖ≥ËÅîËØ•ÁßçÈ∏Ω„ÄÇ</p>
        `;
      } else {
        html += '<p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†ÁßçÈ∏ΩÂèÇËµõËÆ∞ÂΩï</p>';
      }
    }
    
    html += `
        </div>
      </div>
      
      <!-- ÁªºÂêàÂàÜÊûêÁªìËÆ∫ -->
      <div class="analysis-conclusion">
        <h4>üìà ÁªºÂêàÂàÜÊûêÁªìËÆ∫</h4>
        <p><strong>ÊÄª‰ΩìÊÉÖÂÜµÔºö</strong>Á≥ªÁªüÂÖ±ËÆ∞ÂΩï${raceStats.totalRaces}Âú∫ÊØîËµõÔºå${allPigeonRaces.length}Âè™È∏ΩÂ≠êÊúâÂèÇËµõËÆ∞ÂΩïÔºåÁ¥ØËÆ°ÂèÇËµõ${raceStats.totalParticipants}Ê¨°„ÄÇ</p>
        ${breedersWithRaces.length > 0 ? `<p><strong>ÁßçÈ∏ΩÂèÇËµõÊÉÖÂÜµÔºö</strong>ÂÖ±Êúâ${breedersWithRaces.length}Âè™ÁßçÈ∏ΩÂèÇÂä†ËøáÊØîËµõÔºåÂÖ∂‰∏≠${breedersWithRaces[0] ? breedersWithRaces[0].pigeon.name || breedersWithRaces[0].pigeon.ring : ''}ÂèÇËµõ${breedersWithRaces[0] ? breedersWithRaces[0].totalRaces : 0}Âú∫${breedersWithRaces[0] && breedersWithRaces[0].bestRank ? `ÔºåÊúÄ‰Ω≥ÊàêÁª©Á¨¨${breedersWithRaces[0].bestRank}Âêç` : ''}„ÄÇ</p>` : ''}
        ${winners.length > 0 ? `<p><strong>Ëé∑Â•ñÊÉÖÂÜµÔºö</strong>ÂÖ±Êúâ${winners.length}Âè™È∏ΩÂ≠êËé∑ÂæóËøáÂâç3ÂêçÁöÑÂ•ΩÊàêÁª©ÔºåÂÖ∂‰∏≠${winners[0] ? winners[0].pigeon.name || winners[0].pigeon.ring : ''}Ë°®Áé∞ÊúÄ‰∏∫Á™ÅÂá∫ÔºåËé∑Âæó${winners[0] ? winners[0].wins : 0}Ê¨°Ââç3Âêç„ÄÇ</p>` : '<p><strong>Ëé∑Â•ñÊÉÖÂÜµÔºö</strong>ÊöÇÊó†Ëé∑Â•ñËÆ∞ÂΩï„ÄÇ</p>'}
        ${allPigeonRaces.length > 0 ? `<p><strong>ÂèÇËµõÊ¥ªË∑ÉÂ∫¶Ôºö</strong>${allPigeonRaces[0] ? allPigeonRaces[0].pigeon.name || allPigeonRaces[0].pigeon.ring : ''}ÂèÇËµõÊúÄ‰∏∫Ê¥ªË∑ÉÔºåÂÖ±ÂèÇÂä†${allPigeonRaces[0] ? allPigeonRaces[0].totalRaces : 0}Âú∫ÊØîËµõ„ÄÇ</p>` : ''}
        ${months.length > 0 ? `<p><strong>Êó∂Èó¥ÂàÜÂ∏ÉÔºö</strong>ÊØîËµõ‰∏ªË¶ÅÈõÜ‰∏≠Âú®${months.slice(0, 3).join('„ÄÅ')}Á≠âÊúà‰ªΩ„ÄÇ</p>` : ''}
        <p><strong>Âª∫ËÆÆÔºö</strong>${breedersWithRaces.length > 0 ? 'ÁßçÈ∏ΩÁöÑÂèÇËµõË°®Áé∞ÊòØËØÑ‰º∞ÂÖ∂ËÇ≤Áßç‰ª∑ÂÄºÁöÑÈáçË¶ÅÊåáÊ†áÔºåÂª∫ËÆÆÈáçÁÇπÂÖ≥Ê≥®ÁßçÈ∏ΩÁöÑÊØîËµõÊàêÁª©ÔºåÁªìÂêàË°ÄÁªüÂàÜÊûê‰ºòÂåñÈÖçÂØπÁ≠ñÁï•„ÄÇ' : winners.length > 0 ? 'Âª∫ËÆÆÈáçÁÇπÂÖ≥Ê≥®Ëé∑Â•ñÈ∏ΩÂ≠êÁöÑË°ÄÁªüÂíåÈÖçÂØπÊÉÖÂÜµÔºåÂàÜÊûêÂÖ∂‰ºòÂäøÂü∫Âõ†ÔºåÁî®‰∫éÂêéÁª≠ËÇ≤Áßç„ÄÇ' : 'Âª∫ËÆÆÂä†Âº∫ËÆ≠ÁªÉÔºåÊèêÈ´òÊï¥‰ΩìÁ´ûÊäÄÊ∞¥Âπ≥„ÄÇ'}ÂÆöÊúüÂàÜÊûêÊØîËµõÊï∞ÊçÆÔºå‰ºòÂåñËÇ≤ÁßçÁ≠ñÁï•„ÄÇ</p>
      </div>
    `;
    
    container.innerHTML = html;
  }
  
  // Â°´ÂÖÖÁªüËÆ°Á±ªÂûãÈÄâÊã©Ê°Ü
  function fillStatsPigeonSelect() {
    const select = document.getElementById('statsPigeonSelect');
    if (!select) return;
    
    const currentValue = select.value;
    select.innerHTML = '<option value="">ÈÄâÊã©È∏ΩÂ≠ê...</option>';
    pigeons.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = `${p.ring}${p.name ? ' - ' + p.name : ''}`;
      if (currentValue === p.id) {
        option.selected = true;
      }
      select.appendChild(option);
    });
  }
  
  // ÁîüÊàêÁªüËÆ°ÊåâÈíÆ‰∫ã‰ª∂
  const btnGenerateStats = document.getElementById('btnGenerateStats');
  const statsTypeSelect = document.getElementById('statsTypeSelect');
  const statsPigeonSelect = document.getElementById('statsPigeonSelect');
  
  if (btnGenerateStats) {
    btnGenerateStats.addEventListener('click', () => {
      const type = statsTypeSelect ? statsTypeSelect.value : 'single';
      const pigeonId = statsPigeonSelect ? statsPigeonSelect.value : '';
      
      if (!pigeonId) {
        alert('ËØ∑ÈÄâÊã©Ë¶ÅÁªüËÆ°ÁöÑÈ∏ΩÂ≠ê');
        return;
      }
      
      if (type === 'single') {
        generateSinglePigeonStats(pigeonId);
      } else if (type === 'bloodline') {
        generateBloodlineStats(pigeonId);
      } else if (type === 'parents') {
        generateParentsOffspringStats(pigeonId);
      }
    });
  }
  
  // ========================================
  // üß¨ Ê®°Âùó2ÔºöÁπÅËÇ≤‰∏éÈÖçÂØπÁÆ°ÁêÜ
  // ========================================
  
  const PAIRINGS_STORAGE_KEY = 'pigeon_pairings_v1';
  let pairings = [];
  
  function loadPairings() {
    try {
      const raw = localStorage.getItem(PAIRINGS_STORAGE_KEY);
      if (raw) pairings = JSON.parse(raw);
    } catch (e) {
      console.error('Âä†ËΩΩÈÖçÂØπÊï∞ÊçÆÂ§±Ë¥•:', e);
    }
  }
  
  function savePairings() {
    try {
      localStorage.setItem(PAIRINGS_STORAGE_KEY, JSON.stringify(pairings));
    } catch (e) {
      console.error('‰øùÂ≠òÈÖçÂØπÊï∞ÊçÆÂ§±Ë¥•:', e);
    }
  }
  
  // Ëé∑ÂèñÈ∏ΩÂ≠êÁöÑÁ•ñÂÖàÔºàÈÄíÂΩíÂêë‰∏ä N ‰ª£Ôºâ
  function getAncestors(pigeonId, generations = 5, visited = new Set()) {
    if (!pigeonId || generations <= 0 || visited.has(pigeonId)) return [];
    visited.add(pigeonId);
    
    const pigeon = getPigeonById(pigeonId);
    if (!pigeon) return [];
    
    const ancestors = [];
    
    // Ê∑ªÂä†Áà∂È∏ΩÁ•ñÂÖà
    if (pigeon.fatherId) {
      ancestors.push({ id: pigeon.fatherId, generation: 1, side: 'father' });
      const fatherAncestors = getAncestors(pigeon.fatherId, generations - 1, visited);
      fatherAncestors.forEach(a => {
        ancestors.push({ ...a, generation: a.generation + 1 });
      });
    }
    
    // Ê∑ªÂä†ÊØçÈ∏ΩÁ•ñÂÖà
    if (pigeon.motherId) {
      ancestors.push({ id: pigeon.motherId, generation: 1, side: 'mother' });
      const motherAncestors = getAncestors(pigeon.motherId, generations - 1, visited);
      motherAncestors.forEach(a => {
        ancestors.push({ ...a, generation: a.generation + 1 });
      });
    }
    
    return ancestors;
  }
  
  // ËÆ°ÁÆóËøë‰∫≤Á≥ªÊï∞ÔºàÊ†∏ÂøÉÁÆóÊ≥ïÔºâ
  function calculateInbreedingCoefficient(maleId, femaleId) {
    const maleAncestors = getAncestors(maleId, 5);
    const femaleAncestors = getAncestors(femaleId, 5);
    
    const maleAncestorMap = new Map();
    maleAncestors.forEach(a => {
      if (!maleAncestorMap.has(a.id)) {
        maleAncestorMap.set(a.id, []);
      }
      maleAncestorMap.get(a.id).push(a.generation);
    });
    
    let inbreedingCoefficient = 0;
    const commonAncestors = [];
    
    femaleAncestors.forEach(fa => {
      if (maleAncestorMap.has(fa.id)) {
        const maleGenerations = maleAncestorMap.get(fa.id);
        maleGenerations.forEach(mg => {
          // Ëøë‰∫≤Á≥ªÊï∞ÂÖ¨Âºè: Œ£ (1 / 2^(n1 + n2))
          const contribution = Math.pow(0.5, mg + fa.generation);
          inbreedingCoefficient += contribution;
          
          const ancestor = getPigeonById(fa.id);
          if (ancestor && !commonAncestors.find(ca => ca.id === fa.id)) {
            commonAncestors.push({
              id: fa.id,
              name: ancestor.name || ancestor.ring,
              maleGen: mg,
              femaleGen: fa.generation
            });
          }
        });
      }
    });
    
    // ËΩ¨Êç¢‰∏∫ÁôæÂàÜÊØî (ÈÄöÂ∏∏‰∏çË∂ÖËøá50%)
    const percentage = Math.min(inbreedingCoefficient * 100, 50);
    
    return {
      coefficient: inbreedingCoefficient,
      percentage: percentage.toFixed(2),
      commonAncestors: commonAncestors,
      riskLevel: percentage < 6.25 ? 'low' : percentage < 12.5 ? 'medium' : 'high'
    };
  }
  
  // ËÆ°ÁÆóÂéÜÂè≤ÊàêÂäüÁéá
  function calculatePairingSuccessRate(maleId, femaleId) {
    const male = getPigeonById(maleId);
    const female = getPigeonById(femaleId);
    if (!male || !female) return null;
    
    // Êü•ÊâæÁõ∏ÂêåË°ÄÁ≥ªÁöÑÂéÜÂè≤ÈÖçÂØπ
    const relatedPairings = pairings.filter(p => {
      const pMale = getPigeonById(p.maleId);
      const pFemale = getPigeonById(p.femaleId);
      if (!pMale || !pFemale) return false;
      
      // Ê£ÄÊü•ÊòØÂê¶ÊòØÁõ∏ÂêåÊàñÁõ∏ÂÖ≥Ë°ÄÁ≥ª
      return (
        p.maleId === maleId || p.femaleId === femaleId ||
        pMale.fatherId === male.fatherId || pMale.motherId === male.motherId ||
        pFemale.fatherId === female.fatherId || pFemale.motherId === female.motherId
      );
    });
    
    if (relatedPairings.length === 0) return null;
    
    // ËÆ°ÁÆóÂêé‰ª£Ë°®Áé∞
    let totalOffspring = 0;
    let racedOffspring = 0;
    let awardedOffspring = 0;
    let totalRank = 0;
    let rankCount = 0;
    
    relatedPairings.forEach(pairing => {
      // Êü•ÊâæËøôÂØπÈÖçÂØπÁöÑÂêé‰ª£
      const offspring = pigeons.filter(p => 
        p.fatherId === pairing.maleId && p.motherId === pairing.femaleId
      );
      
      totalOffspring += offspring.length;
      
      offspring.forEach(child => {
        if (child.races && child.races.length > 0) {
          racedOffspring++;
          child.races.forEach(race => {
            if (race.rank) {
              totalRank += race.rank;
              rankCount++;
              if (race.rank <= 10) awardedOffspring++;
            }
          });
        }
      });
    });
    
    return {
      relatedPairings: relatedPairings.length,
      totalOffspring,
      racedOffspring,
      awardedOffspring,
      avgRank: rankCount > 0 ? (totalRank / rankCount).toFixed(1) : null,
      raceRate: totalOffspring > 0 ? ((racedOffspring / totalOffspring) * 100).toFixed(1) : 0,
      awardRate: racedOffspring > 0 ? ((awardedOffspring / racedOffspring) * 100).toFixed(1) : 0
    };
  }
  
  // ÁîüÊàêÈÖçÂØπËØÑ‰º∞
  function generatePairingAssessment(maleId, femaleId) {
    const male = getPigeonById(maleId);
    const female = getPigeonById(femaleId);
    
    if (!male || !female) {
      return { score: 0, recommendation: 'unknown', reasons: [] };
    }
    
    const inbreeding = calculateInbreedingCoefficient(maleId, femaleId);
    const successRate = calculatePairingSuccessRate(maleId, femaleId);
    
    let score = 70; // Âü∫Á°ÄÂàÜ
    const reasons = [];
    
    // Ëøë‰∫≤Á≥ªÊï∞ËØÑ‰º∞
    if (inbreeding.riskLevel === 'low') {
      score += 15;
      reasons.push('‚úÖ Ëøë‰∫≤Á≥ªÊï∞‰ΩéÔºåÈÅó‰º†Â§öÊ†∑ÊÄßÂ•Ω');
    } else if (inbreeding.riskLevel === 'medium') {
      score += 5;
      reasons.push('‚ö†Ô∏è ‰∏≠Á≠âËøë‰∫≤È£éÈô©ÔºåÈúÄË¶ÅÂÖ≥Ê≥®');
    } else {
      score -= 20;
      reasons.push('‚ùå È´òËøë‰∫≤È£éÈô©Ôºå‰∏çÂª∫ËÆÆÈÖçÂØπ');
    }
    
    // ÂéÜÂè≤ÊàêÂäüÁéáËØÑ‰º∞
    if (successRate) {
      if (parseFloat(successRate.awardRate) > 30) {
        score += 15;
        reasons.push(`‚úÖ Áõ∏ÂÖ≥Ë°ÄÁ≥ªÂéÜÂè≤Ëé∑Â•ñÁéá${successRate.awardRate}%`);
      } else if (parseFloat(successRate.raceRate) > 50) {
        score += 10;
        reasons.push(`‚úÖ Áõ∏ÂÖ≥Ë°ÄÁ≥ªÂá∫ËµõÁéá${successRate.raceRate}%`);
      }
    }
    
    // ÁßçÈ∏ΩËØÑ‰º∞
    if (male.isCore) {
      score += 10;
      reasons.push('‚úÖ ÂÖ¨È∏Ω‰∏∫Ê†∏ÂøÉÁßçÈ∏Ω');
    }
    if (female.isCore) {
      score += 10;
      reasons.push('‚úÖ ÊØçÈ∏Ω‰∏∫Ê†∏ÂøÉÁßçÈ∏Ω');
    }
    
    // ÂèÇËµõÊàêÁª©ËØÑ‰º∞
    const maleRaces = male.races || [];
    const femaleRaces = female.races || [];
    
    const maleBestRank = maleRaces.reduce((best, r) => r.rank && r.rank < best ? r.rank : best, 999);
    const femaleBestRank = femaleRaces.reduce((best, r) => r.rank && r.rank < best ? r.rank : best, 999);
    
    if (maleBestRank <= 10) {
      score += 10;
      reasons.push(`‚úÖ ÂÖ¨È∏ΩÊúÄ‰Ω≥ÊàêÁª©Á¨¨${maleBestRank}Âêç`);
    }
    if (femaleBestRank <= 10) {
      score += 10;
      reasons.push(`‚úÖ ÊØçÈ∏ΩÊúÄ‰Ω≥ÊàêÁª©Á¨¨${femaleBestRank}Âêç`);
    }
    
    // ÈôêÂà∂ÂàÜÊï∞ËåÉÂõ¥
    score = Math.max(0, Math.min(100, score));
    
    // Êé®ËçêÁ≠âÁ∫ß
    let recommendation;
    if (score >= 80) recommendation = 'Âº∫ÁÉàÊé®Ëçê';
    else if (score >= 60) recommendation = 'Êé®Ëçê';
    else if (score >= 40) recommendation = 'Ë∞®ÊÖéÈÖçÂØπ';
    else recommendation = '‰∏çÂª∫ËÆÆ';
    
    return {
      score,
      recommendation,
      reasons,
      inbreeding,
      successRate
    };
  }
  
  // Â°´ÂÖÖÁπÅËÇ≤ÈÖçÂØπÈÄâÊã©Ê°Ü
  function fillBreedingSelects() {
    const maleSelect = document.getElementById('breedingMaleSelect');
    const femaleSelect = document.getElementById('breedingFemaleSelect');
    
    if (!maleSelect || !femaleSelect) return;
    
    maleSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©ÂÖ¨È∏Ω...</option>';
    femaleSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©ÊØçÈ∏Ω...</option>';
    
    pigeons.filter(p => p.alive && p.gender === 'ÂÖ¨').forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = `${p.name || p.ring} (${p.ring})${p.isCore ? ' ‚≠ê' : ''}`;
      maleSelect.appendChild(option);
    });
    
    pigeons.filter(p => p.alive && p.gender === 'ÊØç').forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = `${p.name || p.ring} (${p.ring})${p.isCore ? ' ‚≠ê' : ''}`;
      femaleSelect.appendChild(option);
    });
  }
  
  // ÊòæÁ§∫È∏ΩÂ≠ê‰ø°ÊÅØÂç°Áâá
  function showPigeonBreedingInfo(pigeon, containerId) {
    const container = document.getElementById(containerId);
    if (!container || !pigeon) {
      if (container) {
        container.innerHTML = '<p class="muted" style="text-align:center;padding:20px;">ÈÄâÊã©ÂêéÊòæÁ§∫ËØ¶ÊÉÖ</p>';
      }
      return;
    }
    
    const races = pigeon.races || [];
    const bestRank = races.reduce((best, r) => r.rank && r.rank < best ? r.rank : best, 999);
    const wins = races.filter(r => r.rank && r.rank <= 3).length;
    
    container.innerHTML = `
      <div class="breeding-pigeon-info">
        <div class="breeding-pigeon-info-row">
          <span>ÂêçÁß∞</span>
          <strong>${pigeon.name || '‚Äî'}</strong>
        </div>
        <div class="breeding-pigeon-info-row">
          <span>Ë∂≥ÁéØÂè∑</span>
          <strong>${pigeon.ring}</strong>
        </div>
        <div class="breeding-pigeon-info-row">
          <span>Á±ªÂûã</span>
          <strong>${pigeon.type || '‚Äî'} ${pigeon.isCore ? '‚≠ê' : ''}</strong>
        </div>
        <div class="breeding-pigeon-info-row">
          <span>ÁæΩËâ≤</span>
          <strong>${pigeon.color || '‚Äî'}</strong>
        </div>
        <div class="breeding-pigeon-info-row">
          <span>ÂèÇËµõÊ¨°Êï∞</span>
          <strong>${races.length}Âú∫</strong>
        </div>
        <div class="breeding-pigeon-info-row">
          <span>ÊúÄ‰Ω≥ÊàêÁª©</span>
          <strong>${bestRank < 999 ? `Á¨¨${bestRank}Âêç` : '‚Äî'}</strong>
        </div>
        <div class="breeding-pigeon-info-row">
          <span>Ââç3ÂêçÊ¨°Êï∞</span>
          <strong style="color:#f59e0b;">${wins}Ê¨°</strong>
        </div>
      </div>
    `;
  }
  
  // Êõ¥Êñ∞ÈÖçÂØπËØÑ‰º∞ÊòæÁ§∫
  function updateBreedingAssessment() {
    const maleId = document.getElementById('breedingMaleSelect')?.value;
    const femaleId = document.getElementById('breedingFemaleSelect')?.value;
    const container = document.getElementById('breedingAssessment');
    const confirmBtn = document.getElementById('btnConfirmPairing');
    
    if (!container) return;
    
    // ÊòæÁ§∫ÂêÑËá™ÁöÑ‰ø°ÊÅØ
    showPigeonBreedingInfo(getPigeonById(maleId), 'breedingMaleInfo');
    showPigeonBreedingInfo(getPigeonById(femaleId), 'breedingFemaleInfo');
    
    if (!maleId || !femaleId) {
      container.innerHTML = `
        <div style="text-align:center;padding:40px 20px;color:#9ca3af;">
          <div style="font-size:32px;margin-bottom:12px;">üîÆ</div>
          <p>ËØ∑ÂÖàÈÄâÊã©ÂÖ¨È∏ΩÂíåÊØçÈ∏Ω</p>
          <p style="font-size:12px;">Á≥ªÁªüÂ∞ÜËá™Âä®ÂàÜÊûêËøë‰∫≤È£éÈô©‰∏éÈÖçÂØπÂª∫ËÆÆ</p>
        </div>
      `;
      if (confirmBtn) confirmBtn.disabled = true;
      return;
    }
    
    const assessment = generatePairingAssessment(maleId, femaleId);
    
    // Ëøë‰∫≤Á≥ªÊï∞È¢úËâ≤
    const inbreedingColor = assessment.inbreeding.riskLevel === 'low' ? '#10b981' : 
                           assessment.inbreeding.riskLevel === 'medium' ? '#f59e0b' : '#ef4444';
    const inbreedingClass = `inbreeding-${assessment.inbreeding.riskLevel}`;
    
    container.innerHTML = `
      <div style="text-align:center;margin-bottom:20px;">
        <div style="font-size:48px;font-weight:700;color:${assessment.score >= 60 ? '#10b981' : assessment.score >= 40 ? '#f59e0b' : '#ef4444'};">
          ${assessment.score}
        </div>
        <div style="font-size:14px;color:#6b7280;">ÈÖçÂØπËØÑÂàÜ</div>
        <div style="margin-top:8px;padding:6px 16px;border-radius:999px;display:inline-block;font-size:13px;font-weight:600;
          background:${assessment.score >= 80 ? '#d1fae5' : assessment.score >= 60 ? '#fef3c7' : assessment.score >= 40 ? '#fee2e2' : '#fecaca'};
          color:${assessment.score >= 80 ? '#047857' : assessment.score >= 60 ? '#b45309' : assessment.score >= 40 ? '#dc2626' : '#b91c1c'};">
          ${assessment.recommendation}
        </div>
      </div>
      
      <div style="margin-bottom:16px;">
        <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px;">
          <span>Ëøë‰∫≤Á≥ªÊï∞</span>
          <span style="font-weight:600;color:${inbreedingColor};">${assessment.inbreeding.percentage}%</span>
        </div>
        <div class="inbreeding-meter">
          <div class="inbreeding-meter-fill ${inbreedingClass}" style="width:${Math.min(assessment.inbreeding.percentage * 2, 100)}%;"></div>
        </div>
      </div>
      
      ${assessment.inbreeding.commonAncestors.length > 0 ? `
        <div style="margin-bottom:16px;padding:12px;background:rgba(0,0,0,0.03);border-radius:8px;">
          <div style="font-size:12px;color:#6b7280;margin-bottom:8px;">ÂÖ±ÂêåÁ•ñÂÖàÔºö</div>
          ${assessment.inbreeding.commonAncestors.slice(0, 3).map(a => `
            <span style="display:inline-block;padding:4px 8px;background:#fff;border-radius:4px;font-size:12px;margin:2px;">${a.name}</span>
          `).join('')}
        </div>
      ` : ''}
      
      <div style="font-size:12px;">
        ${assessment.reasons.map(r => `<div style="padding:4px 0;color:#4b5563;">${r}</div>`).join('')}
      </div>
      
      ${assessment.successRate ? `
        <div style="margin-top:16px;padding:12px;background:rgba(0,0,0,0.03);border-radius:8px;font-size:12px;">
          <div style="font-weight:600;margin-bottom:8px;">üìä Áõ∏ÂÖ≥Ë°ÄÁ≥ªÂéÜÂè≤</div>
          <div>Áõ∏ÂÖ≥ÈÖçÂØπÔºö${assessment.successRate.relatedPairings}ÂØπ</div>
          <div>Âêé‰ª£Êï∞ÈáèÔºö${assessment.successRate.totalOffspring}Âè™</div>
          <div>Âá∫ËµõÁéáÔºö${assessment.successRate.raceRate}%</div>
          <div>Ëé∑Â•ñÁéáÔºö${assessment.successRate.awardRate}%</div>
        </div>
      ` : ''}
    `;
    
    if (confirmBtn) {
      confirmBtn.disabled = false;
      confirmBtn.style.background = assessment.score >= 60 ? 
        'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 
        assessment.score >= 40 ? 
        'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : 
        'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
    }
  }
  
  // Ê∏≤ÊüìÈÖçÂØπÂéÜÂè≤
  function renderPairingHistory() {
    const container = document.getElementById('breedingHistoryContainer');
    if (!container) return;
    
    if (pairings.length === 0) {
      container.innerHTML = '<p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†ÈÖçÂØπÂéÜÂè≤ËÆ∞ÂΩï</p>';
      return;
    }
    
    let html = '';
    pairings.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(pairing => {
      const male = getPigeonById(pairing.maleId);
      const female = getPigeonById(pairing.femaleId);
      if (!male || !female) return;
      
      // Êü•ÊâæÂêé‰ª£
      const offspring = pigeons.filter(p => 
        p.fatherId === pairing.maleId && p.motherId === pairing.femaleId
      );
      
      const offspringWithRaces = offspring.filter(o => o.races && o.races.length > 0);
      const offspringWins = offspring.reduce((count, o) => {
        return count + (o.races || []).filter(r => r.rank && r.rank <= 3).length;
      }, 0);
      
      html += `
        <div class="pairing-history-item">
          <div>
            <div style="font-weight:600;color:#1e40af;">‚ôÇ ${male.name || male.ring}</div>
            <div style="font-size:12px;color:#6b7280;">${male.ring}</div>
          </div>
          <div>
            <div style="font-weight:600;color:#be185d;">‚ôÄ ${female.name || female.ring}</div>
            <div style="font-size:12px;color:#6b7280;">${female.ring}</div>
          </div>
          <div>
            <div style="font-size:13px;">Âêé‰ª£Ôºö<strong>${offspring.length}</strong>Âè™</div>
            <div style="font-size:12px;color:#6b7280;">
              ÂèÇËµõ${offspringWithRaces.length}Âè™ | Ëé∑Â•ñ${offspringWins}Ê¨°
            </div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:12px;color:#6b7280;">${pairing.date}</div>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html || '<p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†ÈÖçÂØπÂéÜÂè≤ËÆ∞ÂΩï</p>';
  }
  
  // ‰øùÂ≠òÈÖçÂØπ
  function savePairingRecord() {
    const maleId = document.getElementById('breedingMaleSelect')?.value;
    const femaleId = document.getElementById('breedingFemaleSelect')?.value;
    const date = document.getElementById('pairingDate')?.value;
    const note = document.getElementById('pairingNote')?.value;
    
    if (!maleId || !femaleId) {
      alert('ËØ∑ÈÄâÊã©ÂÖ¨È∏ΩÂíåÊØçÈ∏Ω');
      return;
    }
    if (!date) {
      alert('ËØ∑ÈÄâÊã©ÈÖçÂØπÊó•Êúü');
      return;
    }
    
    const pairing = {
      id: 'pair_' + Date.now(),
      maleId,
      femaleId,
      date,
      note,
      createdAt: new Date().toISOString()
    };
    
    pairings.push(pairing);
    savePairings();
    
    // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
    document.getElementById('pairingModal').style.display = 'none';
    
    // Âà∑Êñ∞ÊòæÁ§∫
    renderPairingHistory();
    
    alert('ÈÖçÂØπËÆ∞ÂΩïÂ∑≤‰øùÂ≠òÔºÅ');
  }
  
  // ÁπÅËÇ≤Ê®°Âùó‰∫ã‰ª∂ÁªëÂÆö
  document.getElementById('breedingMaleSelect')?.addEventListener('change', updateBreedingAssessment);
  document.getElementById('breedingFemaleSelect')?.addEventListener('change', updateBreedingAssessment);
  
  document.getElementById('btnConfirmPairing')?.addEventListener('click', () => {
    const maleId = document.getElementById('breedingMaleSelect')?.value;
    const femaleId = document.getElementById('breedingFemaleSelect')?.value;
    
    if (!maleId || !femaleId) {
      alert('ËØ∑ÂÖàÈÄâÊã©ÂÖ¨È∏ΩÂíåÊØçÈ∏Ω');
      return;
    }
    
    const male = getPigeonById(maleId);
    const female = getPigeonById(femaleId);
    const assessment = generatePairingAssessment(maleId, femaleId);
    
    document.getElementById('pairingConfirmContent').innerHTML = `
      <div style="text-align:center;margin-bottom:20px;">
        <div style="display:flex;justify-content:center;align-items:center;gap:20px;">
          <div style="text-align:center;">
            <div style="font-size:32px;">‚ôÇ</div>
            <div style="font-weight:600;color:#1e40af;">${male.name || male.ring}</div>
          </div>
          <div style="font-size:24px;">üíï</div>
          <div style="text-align:center;">
            <div style="font-size:32px;">‚ôÄ</div>
            <div style="font-weight:600;color:#be185d;">${female.name || female.ring}</div>
          </div>
        </div>
        <div style="margin-top:16px;padding:8px 16px;border-radius:8px;display:inline-block;
          background:${assessment.score >= 60 ? '#d1fae5' : '#fef3c7'};
          color:${assessment.score >= 60 ? '#047857' : '#b45309'};">
          ÈÖçÂØπËØÑÂàÜÔºö${assessment.score} | ${assessment.recommendation}
        </div>
      </div>
    `;
    
    document.getElementById('pairingDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('pairingModal').style.display = 'flex';
  });
  
  document.getElementById('btnClosePairingModal')?.addEventListener('click', () => {
    document.getElementById('pairingModal').style.display = 'none';
  });
  
  document.getElementById('btnCancelPairing')?.addEventListener('click', () => {
    document.getElementById('pairingModal').style.display = 'none';
  });
  
  document.getElementById('btnSavePairing')?.addEventListener('click', savePairingRecord);
  
  document.getElementById('btnRefreshBreeding')?.addEventListener('click', () => {
    fillBreedingSelects();
    renderPairingHistory();
    updateBreedingAssessment();
  });
  
  // ========================================
  // ü©∫ Ê®°Âùó4ÔºöÂÅ•Â∫∑‰∏éÁî®ËçØÁÆ°ÁêÜ
  // ========================================
  
  const HEALTH_RECORDS_KEY = 'pigeon_health_records_v1';
  let healthRecords = [];
  
  function loadHealthRecords() {
    try {
      const raw = localStorage.getItem(HEALTH_RECORDS_KEY);
      if (raw) healthRecords = JSON.parse(raw);
    } catch (e) {
      console.error('Âä†ËΩΩÂÅ•Â∫∑ËÆ∞ÂΩïÂ§±Ë¥•:', e);
    }
  }
  
  function saveHealthRecords() {
    try {
      localStorage.setItem(HEALTH_RECORDS_KEY, JSON.stringify(healthRecords));
    } catch (e) {
      console.error('‰øùÂ≠òÂÅ•Â∫∑ËÆ∞ÂΩïÂ§±Ë¥•:', e);
    }
  }
  
  // Ëé∑ÂèñÂÅ•Â∫∑Áä∂ÊÄÅÁªüËÆ°
  function getHealthStats() {
    const today = new Date();
    const weekLater = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
    
    let healthy = 0;
    let upcoming = 0;
    let needAttention = 0;
    let medicating = 0;
    
    const pigeonHealthMap = new Map();
    
    healthRecords.forEach(record => {
      if (!pigeonHealthMap.has(record.pigeonId)) {
        pigeonHealthMap.set(record.pigeonId, []);
      }
      pigeonHealthMap.get(record.pigeonId).push(record);
    });
    
    pigeons.filter(p => p.alive).forEach(pigeon => {
      const records = pigeonHealthMap.get(pigeon.id) || [];
      const latestRecord = records.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
      
      if (!latestRecord) {
        healthy++;
        return;
      }
      
      // Ê£ÄÊü•ÊòØÂê¶ÊúâÂç≥Â∞ÜÂà∞ÊúüÁöÑÊèêÈÜí
      if (latestRecord.nextDate) {
        const nextDate = new Date(latestRecord.nextDate);
        if (nextDate <= today) {
          needAttention++;
        } else if (nextDate <= weekLater) {
          upcoming++;
        } else {
          healthy++;
        }
      } else if (latestRecord.type === 'ÁñæÁóÖ' || latestRecord.type === 'Áî®ËçØ') {
        const recordDate = new Date(latestRecord.date);
        const daysSince = (today - recordDate) / (1000 * 60 * 60 * 24);
        if (daysSince < 14) {
          if (latestRecord.type === 'Áî®ËçØ') medicating++;
          else needAttention++;
        } else {
          healthy++;
        }
      } else {
        healthy++;
      }
    });
    
    return { healthy, upcoming, needAttention, medicating };
  }
  
  // Ëé∑ÂèñÂÅ•Â∫∑ÊèêÈÜí
  function getHealthAlerts() {
    const today = new Date();
    const alerts = [];
    
    healthRecords.forEach(record => {
      if (record.nextDate) {
        const nextDate = new Date(record.nextDate);
        const pigeon = getPigeonById(record.pigeonId);
        if (!pigeon || !pigeon.alive) return;
        
        const daysUntil = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
        
        if (daysUntil <= 0) {
          alerts.push({
            type: 'urgent',
            icon: '‚ö†Ô∏è',
            pigeon,
            record,
            message: `Â∑≤ËøáÊúü${Math.abs(daysUntil)}Â§©`,
            daysUntil
          });
        } else if (daysUntil <= 7) {
          alerts.push({
            type: 'warning',
            icon: '‚è∞',
            pigeon,
            record,
            message: `${daysUntil}Â§©ÂêéÂà∞Êúü`,
            daysUntil
          });
        } else if (daysUntil <= 30) {
          alerts.push({
            type: 'info',
            icon: 'üìÖ',
            pigeon,
            record,
            message: `${daysUntil}Â§©ÂêéÂà∞Êúü`,
            daysUntil
          });
        }
      }
    });
    
    return alerts.sort((a, b) => a.daysUntil - b.daysUntil);
  }
  
  // Ê∏≤ÊüìÂÅ•Â∫∑Áä∂ÊÄÅ
  function renderHealthOverview() {
    const stats = getHealthStats();
    
    document.getElementById('healthyCount').textContent = stats.healthy;
    document.getElementById('upcomingCount').textContent = stats.upcoming;
    document.getElementById('needAttentionCount').textContent = stats.needAttention;
    document.getElementById('medicatingCount').textContent = stats.medicating;
  }
  
  // Ê∏≤ÊüìÂÅ•Â∫∑ÊèêÈÜí
  function renderHealthAlerts() {
    const container = document.getElementById('healthAlertsContainer');
    if (!container) return;
    
    const alerts = getHealthAlerts();
    
    if (alerts.length === 0) {
      container.innerHTML = '<p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†ÂÅ•Â∫∑ÊèêÈÜíÔºåÊâÄÊúâÈ∏ΩÂ≠êÁä∂ÊÄÅËâØÂ•Ω ‚úÖ</p>';
      return;
    }
    
    container.innerHTML = alerts.slice(0, 10).map(alert => `
      <div class="health-alert-item ${alert.type}">
        <div style="font-size:24px;">${alert.icon}</div>
        <div style="flex:1;">
          <div style="font-weight:600;color:#1f2937;">${alert.pigeon.name || alert.pigeon.ring}</div>
          <div style="font-size:13px;color:#6b7280;">${alert.record.type}: ${alert.record.description || ''}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:600;color:${alert.type === 'urgent' ? '#dc2626' : alert.type === 'warning' ? '#b45309' : '#2563eb'};">
            ${alert.message}
          </div>
          <div style="font-size:12px;color:#9ca3af;">ÊèêÈÜíÊó•ÊúüÔºö${alert.record.nextDate}</div>
        </div>
      </div>
    `).join('');
  }
  
  // Â°´ÂÖÖÂÅ•Â∫∑È∏ΩÂ≠êÈÄâÊã©Ê°Ü
  function fillHealthPigeonSelects() {
    const selects = ['healthPigeonSelect', 'healthRecordPigeon'];
    
    selects.forEach(selectId => {
      const select = document.getElementById(selectId);
      if (!select) return;
      
      select.innerHTML = '<option value="">ÈÄâÊã©È∏ΩÂ≠ê...</option>';
      pigeons.filter(p => p.alive).forEach(p => {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = `${p.name || p.ring} (${p.ring})`;
        select.appendChild(option);
      });
    });
  }
  
  // Ê∏≤ÊüìÂÅ•Â∫∑Êó∂Èó¥ËΩ¥
  function renderHealthTimeline(pigeonId) {
    const container = document.getElementById('healthTimelineContainer');
    if (!container) return;
    
    if (!pigeonId) {
      container.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ÈÄâÊã©È∏ΩÂ≠êÂêéÊòæÁ§∫ÂÅ•Â∫∑Êó∂Èó¥ËΩ¥</p>';
      return;
    }
    
    const records = healthRecords
      .filter(r => r.pigeonId === pigeonId)
      .sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (records.length === 0) {
      container.innerHTML = '<p class="muted" style="text-align:center;padding:40px;">ËØ•È∏ΩÂ≠êÊöÇÊó†ÂÅ•Â∫∑ËÆ∞ÂΩï</p>';
      return;
    }
    
    const typeIcons = {
      'Áñ´Ëãó': 'üíâ',
      'È©±Ëô´': 'üêõ',
      '‰ΩìÊ£Ä': 'üî¨',
      'ÁñæÁóÖ': 'üè•',
      'Áî®ËçØ': 'üíä',
      'Â∫∑Â§ç': '‚úÖ',
      'ÂÖ∂‰ªñ': 'üìù'
    };
    
    const typeClasses = {
      'Áñ´Ëãó': 'vaccine',
      'È©±Ëô´': 'deworm',
      '‰ΩìÊ£Ä': 'checkup',
      'ÁñæÁóÖ': 'illness',
      'Áî®ËçØ': 'medication',
      'Â∫∑Â§ç': 'recovery'
    };
    
    container.innerHTML = records.map(record => `
      <div class="health-timeline-item">
        <div class="health-timeline-dot ${typeClasses[record.type] || ''}">${typeIcons[record.type] || 'üìã'}</div>
        <div style="flex:1;">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
            <strong style="color:#1f2937;">${record.type}</strong>
            <span style="color:#6b7280;font-size:13px;">${record.date}</span>
          </div>
          <div style="font-size:14px;color:#4b5563;">${record.description || '‚Äî'}</div>
          ${record.nextDate ? `
            <div style="margin-top:8px;padding:6px 12px;background:#fef3c7;border-radius:6px;font-size:12px;color:#b45309;display:inline-block;">
              ‚è∞ ‰∏ãÊ¨°ÊèêÈÜíÔºö${record.nextDate}
            </div>
          ` : ''}
        </div>
      </div>
    `).join('');
  }
  
  // ‰øùÂ≠òÂÅ•Â∫∑ËÆ∞ÂΩï
  function saveHealthRecord() {
    const pigeonId = document.getElementById('healthRecordPigeon')?.value;
    const type = document.getElementById('healthRecordType')?.value;
    const date = document.getElementById('healthRecordDate')?.value;
    const nextDate = document.getElementById('healthRecordNextDate')?.value;
    const description = document.getElementById('healthRecordDescription')?.value;
    
    if (!pigeonId) {
      alert('ËØ∑ÈÄâÊã©È∏ΩÂ≠ê');
      return;
    }
    if (!type) {
      alert('ËØ∑ÈÄâÊã©ËÆ∞ÂΩïÁ±ªÂûã');
      return;
    }
    if (!date) {
      alert('ËØ∑ÈÄâÊã©Êó•Êúü');
      return;
    }
    
    const record = {
      id: 'health_' + Date.now(),
      pigeonId,
      type,
      date,
      nextDate: nextDate || null,
      description,
      createdAt: new Date().toISOString()
    };
    
    healthRecords.push(record);
    saveHealthRecords();
    
    // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
    document.getElementById('healthModal').style.display = 'none';
    
    // Ê∏ÖÁ©∫Ë°®Âçï
    document.getElementById('healthRecordPigeon').value = '';
    document.getElementById('healthRecordType').value = '';
    document.getElementById('healthRecordDate').value = '';
    document.getElementById('healthRecordNextDate').value = '';
    document.getElementById('healthRecordDescription').value = '';
    
    // Âà∑Êñ∞ÊòæÁ§∫
    renderHealthOverview();
    renderHealthAlerts();
    
    alert('ÂÅ•Â∫∑ËÆ∞ÂΩïÂ∑≤‰øùÂ≠òÔºÅ');
  }
  
  // ÂÅ•Â∫∑Ê®°Âùó‰∫ã‰ª∂ÁªëÂÆö
  document.getElementById('btnAddHealthRecord')?.addEventListener('click', () => {
    fillHealthPigeonSelects();
    document.getElementById('healthRecordDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('healthModal').style.display = 'flex';
  });
  
  document.getElementById('btnCloseHealthModal')?.addEventListener('click', () => {
    document.getElementById('healthModal').style.display = 'none';
  });
  
  document.getElementById('btnCancelHealth')?.addEventListener('click', () => {
    document.getElementById('healthModal').style.display = 'none';
  });
  
  document.getElementById('btnSaveHealth')?.addEventListener('click', saveHealthRecord);
  
  document.getElementById('healthPigeonSelect')?.addEventListener('change', (e) => {
    renderHealthTimeline(e.target.value);
  });
  
  document.getElementById('btnRefreshHealth')?.addEventListener('click', () => {
    fillHealthPigeonSelects();
    renderHealthOverview();
    renderHealthAlerts();
  });
  
  // ========================================
  // üß† Ê®°Âùó5&6ÔºöÊô∫ËÉΩÂàÜÊûê‰∏≠ÂøÉ & ÂÜ≥Á≠ñÁ≥ªÁªü
  // ========================================
  
  // ËÆ°ÁÆóÈ∏ΩÂ≠êÊΩúÂäõËØÑÂàÜ
  function calculatePotentialScore(pigeon) {
    let score = 50; // Âü∫Á°ÄÂàÜ
    const factors = [];
    
    // Ë°ÄÁªüÂõ†Á¥† (30ÂàÜ)
    const father = pigeon.fatherId ? getPigeonById(pigeon.fatherId) : null;
    const mother = pigeon.motherId ? getPigeonById(pigeon.motherId) : null;
    
    if (father?.isCore) {
      score += 10;
      factors.push('Áà∂‰∏∫Ê†∏ÂøÉÁßçÈ∏Ω');
    }
    if (mother?.isCore) {
      score += 10;
      factors.push('ÊØç‰∏∫Ê†∏ÂøÉÁßçÈ∏Ω');
    }
    
    // Áà∂ÊØçÊàêÁª©
    const fatherBest = father?.races?.reduce((best, r) => r.rank && r.rank < best ? r.rank : best, 999) || 999;
    const motherBest = mother?.races?.reduce((best, r) => r.rank && r.rank < best ? r.rank : best, 999) || 999;
    
    if (fatherBest <= 3) {
      score += 5;
      factors.push('Áà∂ÊúâÂâç3ÊàêÁª©');
    }
    if (motherBest <= 3) {
      score += 5;
      factors.push('ÊØçÊúâÂâç3ÊàêÁª©');
    }
    
    // Ëá™Ë∫´ÊàêÁª©Âõ†Á¥† (40ÂàÜ)
    const races = pigeon.races || [];
    const wins = races.filter(r => r.rank && r.rank <= 3).length;
    const top10 = races.filter(r => r.rank && r.rank <= 10).length;
    const bestRank = races.reduce((best, r) => r.rank && r.rank < best ? r.rank : best, 999);
    
    if (wins >= 3) {
      score += 20;
      factors.push(`${wins}Ê¨°Ââç3Âêç`);
    } else if (wins >= 1) {
      score += wins * 5;
      factors.push(`${wins}Ê¨°Ââç3Âêç`);
    }
    
    if (top10 >= 5) {
      score += 10;
      factors.push('Á®≥ÂÆöÂèëÊå•');
    }
    
    if (bestRank === 1) {
      score += 10;
      factors.push('ÂÜ†ÂÜõ');
    }
    
    // ÂÅ•Â∫∑Âõ†Á¥† (10ÂàÜ)
    const pigeonHealth = healthRecords.filter(r => r.pigeonId === pigeon.id);
    const hasIllness = pigeonHealth.some(r => r.type === 'ÁñæÁóÖ');
    if (!hasIllness && pigeonHealth.length > 0) {
      score += 10;
      factors.push('ÂÅ•Â∫∑ËÆ∞ÂΩïËâØÂ•Ω');
    }
    
    // Âπ¥ÈæÑÂõ†Á¥† (10ÂàÜ)
    if (pigeon.birth) {
      const age = new Date().getFullYear() - parseInt(pigeon.birth.substring(0, 4));
      if (age >= 2 && age <= 5) {
        score += 10;
        factors.push('ÈªÑÈáëÂπ¥ÈæÑ');
      } else if (age < 2) {
        score += 5;
        factors.push('Âπ¥ËΩªÊúâÊΩúÂäõ');
      }
    }
    
    return {
      score: Math.min(100, Math.max(0, score)),
      factors
    };
  }
  
  // Ëé∑ÂèñÊúÄÂº∫ÁßçÂÖ¨/ÁßçÊØç
  function getTopBreeders() {
    const males = pigeons.filter(p => p.gender === 'ÂÖ¨' && p.alive);
    const females = pigeons.filter(p => p.gender === 'ÊØç' && p.alive);
    
    // ËÆ°ÁÆóÊØèÂè™ÁßçÈ∏ΩÁöÑÂêé‰ª£Ë°®Áé∞
    const calculateBreederScore = (breeder, isMale) => {
      const offspring = pigeons.filter(p => 
        isMale ? p.fatherId === breeder.id : p.motherId === breeder.id
      );
      
      if (offspring.length === 0) return { score: 0, offspring: 0, wins: 0 };
      
      let totalWins = 0;
      let totalRaces = 0;
      
      offspring.forEach(child => {
        const races = child.races || [];
        totalRaces += races.length;
        totalWins += races.filter(r => r.rank && r.rank <= 3).length;
      });
      
      // ËØÑÂàÜÂÖ¨Âºè: (Ëé∑Â•ñÊï∞ * 3 + Âêé‰ª£Êï∞) / (ÂèÇËµõÊï∞ || 1)
      const score = (totalWins * 3 + offspring.length) / (totalRaces || 1) * 10;
      
      return {
        score,
        offspring: offspring.length,
        wins: totalWins,
        racedCount: offspring.filter(c => c.races && c.races.length > 0).length
      };
    };
    
    const maleScores = males.map(m => ({
      pigeon: m,
      ...calculateBreederScore(m, true)
    })).sort((a, b) => b.score - a.score);
    
    const femaleScores = females.map(f => ({
      pigeon: f,
      ...calculateBreederScore(f, false)
    })).sort((a, b) => b.score - a.score);
    
    return {
      topMale: maleScores[0] || null,
      topFemale: femaleScores[0] || null,
      males: maleScores,
      females: femaleScores
    };
  }
  
  // Ëé∑ÂèñÊúÄ‰Ω≥Ë°ÄÁ≥ª
  function getTopBloodlines() {
    // ÊåâÁà∂Á≥ªÂíåÊØçÁ≥ªÂàÜÁªÑÁªüËÆ°
    const bloodlineStats = new Map();
    
    pigeons.forEach(p => {
      if (p.fatherId) {
        const father = getPigeonById(p.fatherId);
        if (father) {
          const key = `${father.id}_father`;
          if (!bloodlineStats.has(key)) {
            bloodlineStats.set(key, {
              ancestor: father,
              type: 'Áà∂Á≥ª',
              descendants: [],
              wins: 0,
              races: 0
            });
          }
          const stats = bloodlineStats.get(key);
          stats.descendants.push(p);
          const pRaces = p.races || [];
          stats.races += pRaces.length;
          stats.wins += pRaces.filter(r => r.rank && r.rank <= 3).length;
        }
      }
    });
    
    // ËÆ°ÁÆóÂæóÂàÜÂπ∂ÊéíÂ∫è
    const bloodlines = Array.from(bloodlineStats.values())
      .map(b => ({
        ...b,
        score: b.races > 0 ? (b.wins * 3 + b.descendants.length) / b.races : 0
      }))
      .filter(b => b.descendants.length >= 2)
      .sort((a, b) => b.score - a.score);
    
    return bloodlines;
  }
  
  // Êô∫ËÉΩÈÖçÂØπÊé®Ëçê
  function getRecommendedPairings() {
    const males = pigeons.filter(p => p.gender === 'ÂÖ¨' && p.alive);
    const females = pigeons.filter(p => p.gender === 'ÊØç' && p.alive);
    
    const recommendations = [];
    
    males.forEach(male => {
      females.forEach(female => {
        const assessment = generatePairingAssessment(male.id, female.id);
        if (assessment.score >= 70) {
          recommendations.push({
            male,
            female,
            assessment
          });
        }
      });
    });
    
    return recommendations
      .sort((a, b) => b.assessment.score - a.assessment.score)
      .slice(0, 5);
  }
  
  // Ê∏≤ÊüìÊô∫ËÉΩÂàÜÊûê
  function runFullAnalysis() {
    // ÊúÄ‰Ω≥Ë°ÄÁ≥ª
    const bloodlines = getTopBloodlines();
    const topBloodlineContainer = document.getElementById('topBloodlineCard');
    if (topBloodlineContainer) {
      if (bloodlines.length > 0) {
        const top = bloodlines[0];
        topBloodlineContainer.innerHTML = `
          <div style="font-size:24px;font-weight:700;color:#92400e;">${top.ancestor.name || top.ancestor.ring}</div>
          <div style="font-size:13px;color:#78350f;margin-top:8px;">
            Âêé‰ª£Êï∞Ôºö${top.descendants.length}Âè™<br>
            Ëé∑Â•ñÊ¨°Êï∞Ôºö${top.wins}Ê¨°<br>
            Ë°ÄÁ≥ªÂæóÂàÜÔºö${top.score.toFixed(2)}
          </div>
        `;
      } else {
        topBloodlineContainer.innerHTML = '<p class="muted">Êï∞ÊçÆ‰∏çË∂≥</p>';
      }
    }
    
    // ÊúÄÂº∫ÁßçÂÖ¨/ÁßçÊØç
    const topBreeders = getTopBreeders();
    
    const topMaleContainer = document.getElementById('topMaleCard');
    if (topMaleContainer && topBreeders.topMale) {
      const top = topBreeders.topMale;
      topMaleContainer.innerHTML = `
        <div style="font-size:24px;font-weight:700;color:#1e40af;">${top.pigeon.name || top.pigeon.ring}</div>
        <div style="font-size:13px;color:#1e3a8a;margin-top:8px;">
          Âêé‰ª£Êï∞Ôºö${top.offspring}Âè™<br>
          Âêé‰ª£Ëé∑Â•ñÔºö${top.wins}Ê¨°<br>
          ËÇ≤ÁßçÂæóÂàÜÔºö${top.score.toFixed(2)}
        </div>
      `;
    }
    
    const topFemaleContainer = document.getElementById('topFemaleCard');
    if (topFemaleContainer && topBreeders.topFemale) {
      const top = topBreeders.topFemale;
      topFemaleContainer.innerHTML = `
        <div style="font-size:24px;font-weight:700;color:#be185d;">${top.pigeon.name || top.pigeon.ring}</div>
        <div style="font-size:13px;color:#9d174d;margin-top:8px;">
          Âêé‰ª£Êï∞Ôºö${top.offspring}Âè™<br>
          Âêé‰ª£Ëé∑Â•ñÔºö${top.wins}Ê¨°<br>
          ËÇ≤ÁßçÂæóÂàÜÔºö${top.score.toFixed(2)}
        </div>
      `;
    }
    
    // Êé®ËçêÈÖçÂØπ
    const recommendations = getRecommendedPairings();
    const recommendedContainer = document.getElementById('recommendedPairingCard');
    if (recommendedContainer) {
      if (recommendations.length > 0) {
        const top = recommendations[0];
        recommendedContainer.innerHTML = `
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
            <span style="color:#1e40af;font-weight:600;">‚ôÇ ${top.male.name || top.male.ring}</span>
            <span>√ó</span>
            <span style="color:#be185d;font-weight:600;">‚ôÄ ${top.female.name || top.female.ring}</span>
          </div>
          <div style="font-size:32px;font-weight:700;color:#047857;">${top.assessment.score}ÂàÜ</div>
          <div style="font-size:12px;color:#065f46;margin-top:4px;">${top.assessment.recommendation}</div>
        `;
      } else {
        recommendedContainer.innerHTML = '<p class="muted">ÊöÇÊó†Êé®Ëçê</p>';
      }
    }
    
    // ÊΩúÂäõÊéíË°åÊ¶ú
    const potentialContainer = document.getElementById('potentialRankingContainer');
    if (potentialContainer) {
      const potentials = pigeons
        .filter(p => p.alive)
        .map(p => ({
          pigeon: p,
          ...calculatePotentialScore(p)
        }))
        .sort((a, b) => b.score - a.score)
        .slice(0, 10);
      
      if (potentials.length > 0) {
        potentialContainer.innerHTML = potentials.map((item, index) => {
          const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : 'normal';
          return `
            <div class="potential-item">
              <div class="potential-rank ${rankClass}">${index + 1}</div>
              <div>
                <div style="font-weight:600;color:#1f2937;">${item.pigeon.name || item.pigeon.ring}</div>
                <div style="font-size:12px;color:#6b7280;">${item.pigeon.ring}</div>
              </div>
              <div style="font-size:12px;color:#6b7280;">${item.factors.slice(0, 2).join('„ÄÅ')}</div>
              <div class="potential-score">${item.score}</div>
              <div class="potential-bar">
                <div class="potential-bar-fill" style="width:${item.score}%;"></div>
              </div>
            </div>
          `;
        }).join('');
      } else {
        potentialContainer.innerHTML = '<p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†Êï∞ÊçÆ</p>';
      }
    }
    
    // ÁªºÂêàÁªìËÆ∫
    const conclusionContainer = document.getElementById('analysisConclusion');
    if (conclusionContainer) {
      const totalPigeons = pigeons.length;
      const alivePigeons = pigeons.filter(p => p.alive).length;
      const totalRaces = races.length;
      const totalWins = pigeons.reduce((sum, p) => {
        return sum + (p.races || []).filter(r => r.rank && r.rank <= 3).length;
      }, 0);
      
      conclusionContainer.innerHTML = `
        <p><strong>üìä Êï∞ÊçÆÊ¶ÇÂÜµÔºö</strong>Á≥ªÁªüÂÖ±ËÆ∞ÂΩï ${totalPigeons} Âè™È∏ΩÂ≠êÔºåÂÖ∂‰∏≠ ${alivePigeons} Âè™Âú®‰∏ñÔºåÂÖ±ÂèÇÂä† ${totalRaces} Âú∫ÊØîËµõÔºåËé∑Âæó ${totalWins} Ê¨°Ââç‰∏âÂêç„ÄÇ</p>
        
        ${bloodlines.length > 0 ? `
          <p><strong>üß¨ Ë°ÄÁ≥ªÂàÜÊûêÔºö</strong>${bloodlines[0].ancestor.name || bloodlines[0].ancestor.ring} Ë°ÄÁ≥ªË°®Áé∞ÊúÄ‰∏∫Á™ÅÂá∫ÔºåÂ∑≤‰∫ßÂá∫ ${bloodlines[0].descendants.length} Âè™Âêé‰ª£ÔºåÁ¥ØËÆ°Ëé∑Â•ñ ${bloodlines[0].wins} Ê¨°ÔºåË°ÄÁ≥ªÂæóÂàÜ ${bloodlines[0].score.toFixed(2)}„ÄÇÂª∫ËÆÆÈáçÁÇπÂÖ≥Ê≥®ËØ•Ë°ÄÁ≥ªÁöÑÈÖçÂØπÁπÅËÇ≤„ÄÇ</p>
        ` : ''}
        
        ${topBreeders.topMale ? `
          <p><strong>‚ôÇ ÁßçÂÖ¨ËØÑ‰ª∑Ôºö</strong>${topBreeders.topMale.pigeon.name || topBreeders.topMale.pigeon.ring} ÊòØÁõÆÂâçË°®Áé∞ÊúÄÂ•ΩÁöÑÁßçÂÖ¨ÔºåÂêé‰ª£ ${topBreeders.topMale.offspring} Âè™ÔºåÁ¥ØËÆ°Ëé∑Â•ñ ${topBreeders.topMale.wins} Ê¨°„ÄÇ</p>
        ` : ''}
        
        ${topBreeders.topFemale ? `
          <p><strong>‚ôÄ ÁßçÊØçËØÑ‰ª∑Ôºö</strong>${topBreeders.topFemale.pigeon.name || topBreeders.topFemale.pigeon.ring} ÊòØÁõÆÂâçË°®Áé∞ÊúÄÂ•ΩÁöÑÁßçÊØçÔºåÂêé‰ª£ ${topBreeders.topFemale.offspring} Âè™ÔºåÁ¥ØËÆ°Ëé∑Â•ñ ${topBreeders.topFemale.wins} Ê¨°„ÄÇ</p>
        ` : ''}
        
        ${recommendations.length > 0 ? `
          <p><strong>üíï ÈÖçÂØπÂª∫ËÆÆÔºö</strong>Á≥ªÁªüÊé®Ëçê ${recommendations[0].male.name || recommendations[0].male.ring} ‰∏é ${recommendations[0].female.name || recommendations[0].female.ring} ÈÖçÂØπÔºåËØÑÂàÜ ${recommendations[0].assessment.score} ÂàÜÔºå${recommendations[0].assessment.recommendation}„ÄÇ</p>
        ` : ''}
        
        <p><strong>üìã ÂêéÁª≠Âª∫ËÆÆÔºö</strong></p>
        <ul style="margin:8px 0;padding-left:20px;">
          <li>ÂÆöÊúüÊõ¥Êñ∞È∏ΩÂ≠êÁöÑÊØîËµõÊàêÁª©Ôºå‰øùÊåÅÊï∞ÊçÆÂáÜÁ°ÆÊÄß</li>
          <li>ÂÖ≥Ê≥®È´òÊΩúÂäõÈ∏ΩÂ≠êÁöÑËÆ≠ÁªÉÂíåÂèÇËµõÂÆâÊéí</li>
          <li>Ê†πÊçÆÈÖçÂØπËØÑ‰º∞ÁªìÊûú‰ºòÂåñÁπÅËÇ≤ËÆ°Âàí</li>
          <li>ÊåÅÁª≠ËøΩË∏™‰ºòÁßÄË°ÄÁ≥ªÁöÑÂêé‰ª£Ë°®Áé∞</li>
        </ul>
      `;
    }
  }
  
  // Êô∫ËÉΩÂàÜÊûêÊ®°Âùó‰∫ã‰ª∂ÁªëÂÆö
  document.getElementById('btnRunAnalysis')?.addEventListener('click', runFullAnalysis);
  document.getElementById('btnRefreshAnalysis')?.addEventListener('click', runFullAnalysis);
  
  // ========================================
  // üè∑ Ê®°Âùó8ÔºöËá™Âä®Ê†áÁ≠æÁ≥ªÁªü
  // ========================================
  
  function generateAutoTags(pigeon) {
    const tags = [];
    const races = pigeon.races || [];
    
    // ËøûÁª≠3Ê¨°ËøõÂ•ñ ‚Üí "Á®≥ÂÆöÂèëÊå•"
    const top10Count = races.filter(r => r.rank && r.rank <= 10).length;
    if (top10Count >= 3) {
      tags.push({ text: 'Á®≥ÂÆöÂèëÊå•', class: 'stable' });
    }
    
    // Áà∂ÊØçÊòØÊ†∏ÂøÉÁßçÈ∏Ω ‚Üí "Ê†∏ÂøÉË°ÄÁ≥ª"
    const father = pigeon.fatherId ? getPigeonById(pigeon.fatherId) : null;
    const mother = pigeon.motherId ? getPigeonById(pigeon.motherId) : null;
    if (father?.isCore || mother?.isCore) {
      tags.push({ text: 'Ê†∏ÂøÉË°ÄÁ≥ª', class: 'core' });
    }
    
    // ÊúâÂÜ†ÂÜõÊàêÁª©
    const hasChampion = races.some(r => r.rank === 1);
    if (hasChampion) {
      tags.push({ text: 'ÂÜ†ÂÜõ', class: 'champion' });
    }
    
    // ÊΩúÂäõËÇ°
    const potential = calculatePotentialScore(pigeon);
    if (potential.score >= 80 && races.length < 5) {
      tags.push({ text: 'È´òÊΩúÂäõ', class: 'potential' });
    }
    
    // ÂÅ•Â∫∑Ë≠¶Âëä
    const healthIssues = healthRecords.filter(r => 
      r.pigeonId === pigeon.id && r.type === 'ÁñæÁóÖ'
    );
    if (healthIssues.length > 0) {
      const recentIssue = healthIssues.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
      const daysSince = (new Date() - new Date(recentIssue.date)) / (1000 * 60 * 60 * 24);
      if (daysSince < 30) {
        tags.push({ text: 'ÂÅ•Â∫∑ÂÖ≥Ê≥®', class: 'warning' });
      }
    }
    
    return tags;
  }
  
  // ========================================
  // ËßÜÂõæÂàáÊç¢Êõ¥Êñ∞
  // ========================================
  
  // Êâ©Â±ïËßÜÂõæÂØπË±°
  views.breedingView = document.getElementById('breedingView');
  views.healthView = document.getElementById('healthView');
  views.analysisView = document.getElementById('analysisView');
  
  // Ê≥®ÊÑèÔºöswitchView ÂáΩÊï∞Â∑≤Âú®ÂêéÈù¢Áªü‰∏ÄÂÆö‰πâÔºåËøôÈáå‰∏çÂÜçÈáçÂ§çÂÆö‰πâ
  // ‰øùÁïôÂéüÂßãÂáΩÊï∞ÂºïÁî®ÔºåÂêéÁª≠‰ºöÂú®Áªü‰∏ÄÁâàÊú¨‰∏≠ÂêàÂπ∂ÊâÄÊúâÂäüËÉΩ
  
  // ========================================
  // üîç Ê®°Âùó7ÔºöÊô∫ËÉΩÊêúÁ¥¢
  // ========================================
  
  // Ëß£ÊûêËá™ÁÑ∂ËØ≠Ë®ÄÊêúÁ¥¢
  function parseSmartSearch(query) {
    const conditions = {
      year: null,
      gender: null,
      type: null,
      hasAward: false,
      hasRaces: false,
      isCore: false,
      isAlive: null,
      ring: null,
      name: null,
      owner: null
    };
    
    const q = query.toLowerCase().trim();
    
    // Âπ¥‰ªΩÂåπÈÖç (2020-2030)
    const yearMatch = q.match(/20[2-3][0-9]/);
    if (yearMatch) {
      conditions.year = yearMatch[0];
    }
    
    // ÊÄßÂà´ÂåπÈÖç
    if (q.includes('ÂÖ¨') || q.includes('ÈõÑ')) {
      conditions.gender = 'ÂÖ¨';
    } else if (q.includes('ÊØç') || q.includes('Èõå')) {
      conditions.gender = 'ÊØç';
    }
    
    // Á±ªÂûãÂåπÈÖç
    if (q.includes('ÁßçÈ∏Ω')) {
      conditions.type = 'ÁßçÈ∏Ω';
    } else if (q.includes('ÊØîËµõ')) {
      conditions.type = 'ÊØîËµõÈ∏Ω';
    } else if (q.includes('Âêé‰ª£')) {
      conditions.type = 'Âêé‰ª£È∏Ω';
    }
    
    // ÊàêÁª©ÂåπÈÖç
    if (q.includes('ËøõÂ•ñ') || q.includes('Ëé∑Â•ñ') || q.includes('Ââç‰∏â') || q.includes('ÂÜ†ÂÜõ')) {
      conditions.hasAward = true;
    }
    if (q.includes('ÂèÇËµõ') || q.includes('ÊØîËµõ')) {
      conditions.hasRaces = true;
    }
    
    // Ê†∏ÂøÉÁßçÈ∏Ω
    if (q.includes('Ê†∏ÂøÉ')) {
      conditions.isCore = true;
    }
    
    // Áä∂ÊÄÅÂåπÈÖç
    if (q.includes('Âú®‰∏ñ') || q.includes('Â≠òÊ¥ª')) {
      conditions.isAlive = true;
    } else if (q.includes('Ê≠ª‰∫°') || q.includes('Â∑≤ÊïÖ')) {
      conditions.isAlive = false;
    }
    
    // Â¶ÇÊûúÊ≤°ÊúâÂåπÈÖç‰ªª‰ΩïÊù°‰ª∂Ôºå‰Ωú‰∏∫Ë∂≥ÁéØÂè∑„ÄÅÂêçÂ≠óÊàñÈ∏Ω‰∏ªÊêúÁ¥¢
    if (!conditions.year && !conditions.gender && !conditions.type && 
        !conditions.hasAward && !conditions.hasRaces && !conditions.isCore && 
        conditions.isAlive === null) {
      conditions.ring = q;
      conditions.name = q;
      conditions.owner = q;
    }
    
    return conditions;
  }
  
  // ÊâßË°åÊô∫ËÉΩÊêúÁ¥¢
  function executeSmartSearch(query) {
    if (!query || query.trim() === '') return pigeons;
    
    const conditions = parseSmartSearch(query);
    const q = query.toLowerCase().trim();
    
    // Âà§Êñ≠ÊòØÂê¶‰∏∫Áõ¥Êé•ÊêúÁ¥¢Ê®°ÂºèÔºàÊ≤°ÊúâÂåπÈÖçÂà∞ÁâπÊÆäÊù°‰ª∂Ôºâ
    const isDirectSearch = conditions.ring && conditions.name && conditions.owner && 
                           !conditions.year && !conditions.gender && !conditions.type && 
                           !conditions.hasAward && !conditions.hasRaces && !conditions.isCore && 
                           conditions.isAlive === null;
    
    return pigeons.filter(p => {
      // Áõ¥Êé•ÊêúÁ¥¢Ê®°ÂºèÔºöÂè™ÂåπÈÖçË∂≥ÁéØÂè∑„ÄÅÂêçÂ≠óÊàñÈ∏Ω‰∏ª
      if (isDirectSearch) {
        const ringMatch = (p.ring || '').toLowerCase().includes(q);
        const nameMatch = (p.name || '').toLowerCase().includes(q);
        const ownerMatch = (p.currentOwner || '').toLowerCase().includes(q);
        return ringMatch || nameMatch || ownerMatch;
      }
      
      // Êù°‰ª∂ÊêúÁ¥¢Ê®°ÂºèÔºöÈúÄË¶ÅÊª°Ë∂≥ÊâÄÊúâÊù°‰ª∂
      // Âπ¥‰ªΩÊù°‰ª∂
      if (conditions.year) {
        const birthYear = (p.birth || '').substring(0, 4);
        if (birthYear !== conditions.year) return false;
      }
      
      // ÊÄßÂà´Êù°‰ª∂
      if (conditions.gender && p.gender !== conditions.gender) return false;
      
      // Á±ªÂûãÊù°‰ª∂
      if (conditions.type && p.type !== conditions.type) return false;
      
      // Ëé∑Â•ñÊù°‰ª∂
      if (conditions.hasAward) {
        const hasAward = (p.races || []).some(r => r.rank && r.rank <= 3);
        if (!hasAward) return false;
      }
      
      // ÂèÇËµõÊù°‰ª∂
      if (conditions.hasRaces) {
        if (!p.races || p.races.length === 0) return false;
      }
      
      // Ê†∏ÂøÉÁßçÈ∏Ω
      if (conditions.isCore && !p.isCore) return false;
      
      // Â≠òÊ¥ªÁä∂ÊÄÅ
      if (conditions.isAlive !== null && p.alive !== conditions.isAlive) return false;
      
      // Â¶ÇÊûúËÆæÁΩÆ‰∫Ü ring/name/ownerÔºå‰πüÈúÄË¶ÅÊ£ÄÊü•Ëøô‰∫õÂ≠óÊÆµÔºàÊù°‰ª∂ÊêúÁ¥¢Ê®°Âºè‰∏ã‰Ωú‰∏∫È¢ùÂ§ñÊù°‰ª∂Ôºâ
      if (conditions.ring || conditions.name || conditions.owner) {
        const ringMatch = conditions.ring ? (p.ring || '').toLowerCase().includes(q) : true;
        const nameMatch = conditions.name ? (p.name || '').toLowerCase().includes(q) : true;
        const ownerMatch = conditions.owner ? (p.currentOwner || '').toLowerCase().includes(q) : true;
        if (!ringMatch && !nameMatch && !ownerMatch) return false;
      }
      
      return true;
    });
  }
  
  // ÊòæÁ§∫ÊêúÁ¥¢Âª∫ËÆÆ
  function showSearchSuggestions(query) {
    const container = document.getElementById('searchSuggestions');
    if (!container) return;
    
    if (!query || query.trim() === '') {
      container.style.display = 'none';
      return;
    }
    
    const results = executeSmartSearch(query).slice(0, 8);
    
    if (results.length === 0) {
      container.innerHTML = '<div style="padding:16px;text-align:center;color:#9ca3af;">Êú™ÊâæÂà∞ÂåπÈÖçÁªìÊûú</div>';
      container.style.display = 'block';
      return;
    }
    
    container.innerHTML = results.map(p => {
      const tags = generateAutoTags(p);
      return `
        <div class="search-suggestion-item" data-pigeon-id="${p.id}" style="padding:12px 16px;cursor:pointer;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:600;color:#1f2937;">${p.name || p.ring}</div>
            <div style="font-size:12px;color:#6b7280;">${p.ring} | ${p.gender || '‚Äî'} | ${p.type || '‚Äî'}${p.currentOwner ? ' | È∏Ω‰∏ª: ' + p.currentOwner : ''}</div>
          </div>
          <div style="display:flex;gap:4px;">
            ${tags.slice(0, 2).map(tag => `<span class="auto-tag ${tag.class}">${tag.text}</span>`).join('')}
          </div>
        </div>
      `;
    }).join('');
    
    container.style.display = 'block';
    
    // ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂
    container.querySelectorAll('.search-suggestion-item').forEach(item => {
    item.addEventListener('click', () => {
        const pigeonId = item.dataset.pigeonId;
        container.style.display = 'none';
        document.getElementById('smartSearchInput').value = '';
        openDetail(pigeonId);
        switchView('detailView');
      });
    });
  }
  
  // Êô∫ËÉΩÊêúÁ¥¢‰∫ã‰ª∂ÁªëÂÆö
  const smartSearchInput = document.getElementById('smartSearchInput');
  if (smartSearchInput) {
    let searchTimeout;
    smartSearchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        showSearchSuggestions(e.target.value);
      }, 200);
    });
    
    smartSearchInput.addEventListener('focus', () => {
      if (smartSearchInput.value.trim()) {
        showSearchSuggestions(smartSearchInput.value);
      }
    });
    
    smartSearchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const results = executeSmartSearch(smartSearchInput.value);
        if (results.length > 0) {
          document.getElementById('searchSuggestions').style.display = 'none';
          // ÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûúÂàóË°®
          pigeons.length = 0;
          pigeons.push(...executeSmartSearch(smartSearchInput.value));
          refreshList();
          switchView('listView');
        // ÊÅ¢Â§çÂéüÂßãÊï∞ÊçÆ
        loadFromStorage().catch(err => console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', err));
        }
      }
    });
  }
  
  // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠ÊêúÁ¥¢Âª∫ËÆÆ
  document.addEventListener('click', (e) => {
    const container = document.getElementById('searchSuggestions');
    const input = document.getElementById('smartSearchInput');
    if (container && input && !container.contains(e.target) && e.target !== input) {
      container.style.display = 'none';
    }
  });
  
  // ========================================
  // üì• Ê®°Âùó3ÔºöExcel ÂØºÂÖ•ÂäüËÉΩ
  // ========================================
  
  let importedData = [];
  let currentImportRace = null;
  
  // Excel/CSV Êñá‰ª∂Ëß£ÊûêÔºàÁÆÄÊòìÂÆûÁé∞ÔºåÂÆûÈôÖÈ°πÁõÆ‰∏≠Âª∫ËÆÆ‰ΩøÁî® SheetJS Á≠âÂ∫ìÔºâ
  function parseCSV(text) {
    const lines = text.split('\n').filter(line => line.trim());
    if (lines.length < 2) return [];
    
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
    const data = [];
    
    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
      const row = {};
      headers.forEach((h, idx) => {
        row[h] = values[idx] || '';
      });
      data.push(row);
    }
    
    return data;
  }
  
  // ËØÜÂà´Â≠óÊÆµÊò†Â∞Ñ
  function identifyFields(headers) {
    const mapping = {
      ring: null,
      rank: null,
      score: null,
      returnTime: null
    };
    
    const ringPatterns = ['Ë∂≥ÁéØÂè∑', 'ÁéØÂè∑', 'Ë∂≥ÁéØ', 'ring', 'ÁºñÂè∑'];
    const rankPatterns = ['ÂêçÊ¨°', 'ÊéíÂêç', 'rank', 'Âêç', '‰Ωç'];
    const scorePatterns = ['ÂàÜÈÄü', 'ÂàÜÊï∞', 'score', 'ÈÄüÂ∫¶'];
    const timePatterns = ['ÂΩíÂ∑¢Êó∂Èó¥', 'ËøîÂõûÊó∂Èó¥', 'Êó∂Èó¥', 'time'];
    
    headers.forEach((h, idx) => {
      const lh = h.toLowerCase();
      if (ringPatterns.some(p => lh.includes(p))) mapping.ring = h;
      else if (rankPatterns.some(p => lh.includes(p))) mapping.rank = h;
      else if (scorePatterns.some(p => lh.includes(p))) mapping.score = h;
      else if (timePatterns.some(p => lh.includes(p))) mapping.returnTime = h;
    });
    
    return mapping;
  }
  
  // Â§ÑÁêÜÂØºÂÖ•Êñá‰ª∂
  function handleImportFile(file) {
    const reader = new FileReader();
    
    reader.onload = (e) => {
      try {
        let data;
        if (file.name.endsWith('.csv')) {
          data = parseCSV(e.target.result);
        } else {
          // ÂØπ‰∫é xlsx Êñá‰ª∂ÔºåÊòæÁ§∫ÊèêÁ§∫ÈúÄË¶ÅËΩ¨Êç¢‰∏∫ CSV
          alert('Excel (.xlsx) Êñá‰ª∂ËØ∑ÂÖàËΩ¨Êç¢‰∏∫ CSV Ê†ºÂºèÔºåÊàñ‰ΩøÁî® CSV Êñá‰ª∂Áõ¥Êé•ÂØºÂÖ•„ÄÇ\n\nÊèêÁ§∫ÔºöÂú® Excel ‰∏≠ÈÄâÊã©"Âè¶Â≠ò‰∏∫" ‚Üí CSV (ÈÄóÂè∑ÂàÜÈöî)');
          return;
        }
        
        if (data.length === 0) {
          alert('Êñá‰ª∂‰∏∫Á©∫ÊàñÊ†ºÂºè‰∏çÊ≠£Á°Æ');
          return;
        }
        
        const headers = Object.keys(data[0]);
        const fieldMapping = identifyFields(headers);
        
        if (!fieldMapping.ring) {
          alert('Êó†Ê≥ïËØÜÂà´Ë∂≥ÁéØÂè∑ÂàóÔºåËØ∑Á°Æ‰øùÊñá‰ª∂ÂåÖÂê´"Ë∂≥ÁéØÂè∑"Êàñ"ÁéØÂè∑"Âàó');
          return;
        }
        
        // ÂåπÈÖçÈ∏ΩÂ≠ê
        let matchedCount = 0;
        let unmatchedCount = 0;
        
        importedData = data.map(row => {
          const ring = row[fieldMapping.ring]?.trim();
          const pigeon = pigeons.find(p => (p.ring || '').toLowerCase() === (ring || '').toLowerCase());
          
          if (pigeon) {
            matchedCount++;
          } else {
            unmatchedCount++;
          }
          
          return {
            ring,
            rank: parseInt(row[fieldMapping.rank]) || null,
            score: parseFloat(row[fieldMapping.score]) || null,
            returnTime: row[fieldMapping.returnTime] || null,
            pigeon,
            matched: !!pigeon
          };
        });
        
        // Êõ¥Êñ∞ÁªüËÆ°
        document.getElementById('importMatchedCount').textContent = `Â∑≤ÂåπÈÖç: ${matchedCount}`;
        document.getElementById('importUnmatchedCount').textContent = `Êú™ÂåπÈÖç: ${unmatchedCount}`;
        
        // ÊòæÁ§∫È¢ÑËßàË°®Ê†º
        renderImportPreview();
        document.getElementById('importPreviewContainer').style.display = 'block';
        
      } catch (err) {
        console.error('Ëß£ÊûêÊñá‰ª∂Â§±Ë¥•:', err);
        alert('Ëß£ÊûêÊñá‰ª∂Â§±Ë¥•Ôºö' + err.message);
      }
    };
    
    if (file.name.endsWith('.csv')) {
      reader.readAsText(file);
    } else {
      reader.readAsArrayBuffer(file);
    }
  }
  
  // Ê∏≤ÊüìÂØºÂÖ•È¢ÑËßà
  function renderImportPreview() {
    const container = document.getElementById('importPreviewTable');
    if (!container || importedData.length === 0) return;
    
    let html = `
      <table style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead>
          <tr style="background:#f9fafb;">
            <th style="padding:10px;text-align:left;border-bottom:2px solid #e5e7eb;">Áä∂ÊÄÅ</th>
            <th style="padding:10px;text-align:left;border-bottom:2px solid #e5e7eb;">Ë∂≥ÁéØÂè∑</th>
            <th style="padding:10px;text-align:left;border-bottom:2px solid #e5e7eb;">È∏ΩÂ≠êÂêçÁß∞</th>
            <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂêçÊ¨°</th>
            <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂàÜÈÄü</th>
            <th style="padding:10px;text-align:center;border-bottom:2px solid #e5e7eb;">ÂΩíÂ∑¢Êó∂Èó¥</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    importedData.forEach(item => {
      const statusIcon = item.matched ? '‚úÖ' : '‚ö†Ô∏è';
      const statusColor = item.matched ? '#d1fae5' : '#fee2e2';
      
      html += `
        <tr style="border-bottom:1px solid #f0f0f0;background:${statusColor}20;">
          <td style="padding:10px;">${statusIcon}</td>
          <td style="padding:10px;font-weight:500;">${item.ring || '‚Äî'}</td>
          <td style="padding:10px;">${item.pigeon?.name || (item.matched ? '‚Äî' : '<span style="color:#dc2626;">Êú™ÊâæÂà∞</span>')}</td>
          <td style="padding:10px;text-align:center;">${item.rank || '‚Äî'}</td>
          <td style="padding:10px;text-align:center;">${item.score || '‚Äî'}</td>
          <td style="padding:10px;text-align:center;">${item.returnTime || '‚Äî'}</td>
        </tr>
      `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
  }
  
  // Á°ÆËÆ§ÂØºÂÖ•
  function confirmImport() {
    const matchedData = importedData.filter(item => item.matched);
    
    if (matchedData.length === 0) {
      alert('Ê≤°ÊúâÂèØÂØºÂÖ•ÁöÑÂåπÈÖçÊï∞ÊçÆ');
      return;
    }
    
    // ÂàõÂª∫ÊàñËé∑ÂèñÂΩìÂâçÊØîËµõ
    const raceName = prompt('ËØ∑ËæìÂÖ•ÊØîËµõÂêçÁß∞Ôºö', `ÂØºÂÖ•ÊØîËµõ ${new Date().toLocaleDateString()}`);
    if (!raceName) return;
    
    const raceDate = prompt('ËØ∑ËæìÂÖ•ÊØîËµõÊó•Êúü (YYYY-MM-DD)Ôºö', new Date().toISOString().split('T')[0]);
    if (!raceDate) return;
    
    const race = {
      id: 'race_' + Date.now(),
      name: raceName,
      date: raceDate,
      location: '',
      weather: '',
      participants: matchedData.map(item => ({
        pigeonId: item.pigeon.id,
        rank: item.rank,
        score: item.score,
        returnTime: item.returnTime
      }))
    };
    
    races.push(race);
    saveRaces();
    
    // ÂêåÊ≠•Âà∞È∏ΩÂ≠êËÆ∞ÂΩï
    syncRacesToPigeons();
    saveToStorage();
    
    // Ê∏ÖÈô§ÂØºÂÖ•Êï∞ÊçÆ
    importedData = [];
    document.getElementById('importPreviewContainer').style.display = 'none';
    
    // Âà∑Êñ∞ÊòæÁ§∫
    renderRaceList();
    generateOverallAnalysis();
    
    alert(`ÊàêÂäüÂØºÂÖ• ${matchedData.length} Êù°ÊàêÁª©ËÆ∞ÂΩïÔºÅ`);
  }
  
  // Excel ÂØºÂÖ•‰∫ã‰ª∂ÁªëÂÆö
  const excelDropZone = document.getElementById('excelDropZone');
  const excelFileInput = document.getElementById('excelFileInput');
  
  if (excelDropZone && excelFileInput) {
    excelDropZone.addEventListener('click', () => excelFileInput.click());
    
    excelDropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      excelDropZone.classList.add('dragover');
    });
    
    excelDropZone.addEventListener('dragleave', () => {
      excelDropZone.classList.remove('dragover');
    });
    
    excelDropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      excelDropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) handleImportFile(file);
    });
    
    excelFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleImportFile(file);
    });
  }
  
  document.getElementById('btnSelectExcel')?.addEventListener('click', () => {
    document.getElementById('excelFileInput')?.click();
  });
  
  document.getElementById('btnCancelImport')?.addEventListener('click', () => {
    importedData = [];
    document.getElementById('importPreviewContainer').style.display = 'none';
  });
  
  document.getElementById('btnConfirmImport')?.addEventListener('click', confirmImport);
  
  document.getElementById('btnImportExcel')?.addEventListener('click', () => {
    // ÂàáÊç¢Âà∞ÂØºÂÖ•Ê†áÁ≠æÈ°µ
    document.querySelectorAll('.race-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.race-tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelector('[data-tab="raceImport"]')?.classList.add('active');
    document.getElementById('raceImportTab')?.classList.add('active');
  });
  
  // ========================================
  // üíæ Ê®°Âùó9ÔºöÊï∞ÊçÆÂ§á‰ªΩ‰∏éÊÅ¢Â§ç
  // ========================================
  
  // ÂØºÂá∫ÊâÄÊúâÊï∞ÊçÆ
  function exportAllData() {
    const exportData = {
      version: '2.0',
      exportDate: new Date().toISOString(),
      data: {
        pigeons: pigeons,
        races: races,
        pairings: pairings,
        healthRecords: healthRecords,
        usedNames: Array.from(loadUsedNames()),
        ownerRegionPairs: loadOwnerRegionPairs()
      }
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `pigeon_backup_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('Êï∞ÊçÆÂ§á‰ªΩÂ∑≤‰∏ãËΩΩÔºÅËØ∑Â¶•ÂñÑ‰øùÁÆ°Â§á‰ªΩÊñá‰ª∂„ÄÇ');
  }
  
  // ÂØºÂÖ•Â§á‰ªΩÊï∞ÊçÆ
  function importBackupData(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const backupData = JSON.parse(e.target.result);
        
        if (!backupData.data || !backupData.data.pigeons) {
          alert('Êó†ÊïàÁöÑÂ§á‰ªΩÊñá‰ª∂Ê†ºÂºè');
          return;
        }
        
        if (!confirm(`Á°ÆÂÆöË¶ÅÊÅ¢Â§çÂ§á‰ªΩÊï∞ÊçÆÂêóÔºü\n\nÂ§á‰ªΩÊó∂Èó¥: ${backupData.exportDate}\nÈ∏ΩÂ≠êÊï∞Èáè: ${backupData.data.pigeons.length}\nÊØîËµõÊï∞Èáè: ${backupData.data.races?.length || 0}\n\n‚ö†Ô∏è ËøôÂ∞ÜË¶ÜÁõñÂΩìÂâçÊâÄÊúâÊï∞ÊçÆÔºÅ`)) {
          return;
        }
        
        // ÊÅ¢Â§çÊï∞ÊçÆ
        pigeons.length = 0;
        pigeons.push(...backupData.data.pigeons);
        saveToStorage();
        
        if (backupData.data.races) {
          races.length = 0;
          races.push(...backupData.data.races);
          saveRaces();
        }
        
        if (backupData.data.pairings) {
          pairings.length = 0;
          pairings.push(...backupData.data.pairings);
          savePairings();
        }
        
        if (backupData.data.healthRecords) {
          healthRecords.length = 0;
          healthRecords.push(...backupData.data.healthRecords);
          saveHealthRecords();
        }
        
        if (backupData.data.usedNames) {
          saveUsedNames(new Set(backupData.data.usedNames));
        }
        
        if (backupData.data.ownerRegionPairs) {
          localStorage.setItem(OWNER_REGION_PAIRS_KEY, JSON.stringify(backupData.data.ownerRegionPairs));
        }
        
        // Âà∑Êñ∞ÁïåÈù¢
        refreshList();
        refreshStats();
        refreshDashboard();
        fillPedigreeSelect();
        
        alert('Êï∞ÊçÆÊÅ¢Â§çÊàêÂäüÔºÅ');
        
      } catch (err) {
        console.error('ÊÅ¢Â§çÂ§á‰ªΩÂ§±Ë¥•:', err);
        alert('ÊÅ¢Â§çÂ§á‰ªΩÂ§±Ë¥•Ôºö' + err.message);
      }
    };
    reader.readAsText(file);
  }
  
  // Â§á‰ªΩÊåâÈíÆ‰∫ã‰ª∂
  // Â§á‰ªΩÂíåÂØºÂá∫ÊåâÈíÆ‰∫ã‰ª∂ÁªëÂÆöÔºàÁ°Æ‰øùDOMÂ∑≤Âä†ËΩΩÔºâ
  function initBackupButtons() {
    const btnBackupData = document.getElementById('btnBackupData');
    const btnExportData = document.getElementById('btnExportData');
    
    if (btnBackupData) {
      btnBackupData.addEventListener('click', exportAllData);
      btnBackupData.style.pointerEvents = 'auto';
      btnBackupData.style.cursor = 'pointer';
      console.log('‚úì btnBackupData ‰∫ã‰ª∂Â∑≤ÁªëÂÆö');
    }
    
    if (btnExportData) {
      btnExportData.addEventListener('click', exportAllData);
      btnExportData.style.pointerEvents = 'auto';
      btnExportData.style.cursor = 'pointer';
      console.log('‚úì btnExportData ‰∫ã‰ª∂Â∑≤ÁªëÂÆö');
    }
  }
  
  // Âª∂ËøüÁªëÂÆöÂ§á‰ªΩÊåâÈíÆ
  setTimeout(initBackupButtons, 100);
  
  // ========================================
  // ‚ö†Ô∏è Ê®°Âùó10ÔºöÂºÇÂ∏∏Ê£ÄÊµã‰∏éÊèêÈÜí
  // ========================================
  
  function detectAnomalies() {
    const anomalies = [];
    
    pigeons.forEach(p => {
      // Âπ¥ÈæÑÂºÇÂ∏∏Ê£ÄÊµã
      if (p.birth) {
        const birthYear = parseInt(p.birth.substring(0, 4));
        const currentYear = new Date().getFullYear();
        const age = currentYear - birthYear;
        
        if (age > 15) {
          anomalies.push({
            type: 'age',
            severity: 'warning',
            pigeon: p,
            message: `${p.name || p.ring} Âπ¥ÈæÑË∂ÖËøá15Â≤ÅÔºåËØ∑Á°ÆËÆ§Âá∫ÁîüÊó•ÊúüÊòØÂê¶Ê≠£Á°Æ`
          });
        }
        
        if (age < 0) {
          anomalies.push({
            type: 'age',
            severity: 'error',
            pigeon: p,
            message: `${p.name || p.ring} Âá∫ÁîüÊó•ÊúüÂú®Êú™Êù•ÔºåËØ∑‰øÆÊ≠£`
          });
        }
      }
      
      // Ë°ÄÁªüÊñ≠Â±ÇÊ£ÄÊµã
      if (p.type === 'Âêé‰ª£È∏Ω' && !p.fatherId && !p.motherId) {
        anomalies.push({
          type: 'pedigree',
          severity: 'info',
          pigeon: p,
          message: `${p.name || p.ring} ÊòØÂêé‰ª£È∏Ω‰ΩÜÊú™ËÆ∞ÂΩïÁà∂ÊØç‰ø°ÊÅØ`
        });
      }
      
      // ÊÄßÂà´‰∏éÁà∂ÊØçÂÖ≥Á≥ªÊ£ÄÊµã
      if (p.fatherId) {
        const father = getPigeonById(p.fatherId);
        if (father && father.gender === 'ÊØç') {
          anomalies.push({
            type: 'gender',
            severity: 'error',
            pigeon: p,
            message: `${p.name || p.ring} ÁöÑÁà∂È∏Ω ${father.name || father.ring} ÊÄßÂà´Ê†áËÆ∞‰∏∫ÊØçÔºåËØ∑Ê£ÄÊü•`
          });
        }
      }
      if (p.motherId) {
        const mother = getPigeonById(p.motherId);
        if (mother && mother.gender === 'ÂÖ¨') {
          anomalies.push({
            type: 'gender',
            severity: 'error',
            pigeon: p,
            message: `${p.name || p.ring} ÁöÑÊØçÈ∏Ω ${mother.name || mother.ring} ÊÄßÂà´Ê†áËÆ∞‰∏∫ÂÖ¨ÔºåËØ∑Ê£ÄÊü•`
          });
        }
      }
    });
    
    return anomalies;
  }
  
  // ÊòæÁ§∫ÂºÇÂ∏∏ÊèêÈÜí
  function showAnomalyAlerts() {
    const anomalies = detectAnomalies();
    if (anomalies.length === 0) return;
    
    const errors = anomalies.filter(a => a.severity === 'error');
    const warnings = anomalies.filter(a => a.severity === 'warning');
    
    if (errors.length > 0) {
      console.warn('Êï∞ÊçÆÂºÇÂ∏∏Ê£ÄÊµãÂèëÁé∞‰ª•‰∏ãÈîôËØØÔºö', errors);
      // ÂèØ‰ª•Âú®ËøôÈáåÊòæÁ§∫ÈÄöÁü•
    }
  }
  
  // ========================================
  // üè† È¶ñÈ°µ ¬∑ ËµõÈ∏ΩËµÑËÆØ‰∏≠ÂøÉ
  // ========================================
  
  // ËµÑËÆØÊï∞ÊçÆÂ≠òÂÇ®
  let NEWS_DATA = [];
  let currentNewsRegion = 'local'; // 'local' Êàñ 'national'
  
  // ËµÑËÆØÊù•Ê∫êÈÖçÁΩÆÔºàËµõÈ∏ΩÁõ∏ÂÖ≥ÁΩëÁ´ôÔºâ
  const NEWS_SOURCES = {
    local: [
      {
        name: 'Ë¥µÂ∑ûÁúÅ‰ø°È∏ΩÂçè‰ºö',
        url: 'https://www.chinaxinge.com',
        region: 'local',
        keywords: ['Ë¥µÂ∑û', 'Ë¥µÈò≥', 'ÈÅµ‰πâ', 'ÊØïËäÇ', 'ÈªîË•ø']
      },
      {
        name: 'Ë•øÂçóËµõÈ∏ΩÁΩë',
        url: 'https://www.chinaxinge.com',
        region: 'local',
        keywords: ['Ë•øÂçó', 'ÂõõÂ∑ù', 'ÈáçÂ∫Ü', '‰∫ëÂçó', 'Ë¥µÂ∑û']
      }
    ],
    national: [
      {
        name: '‰∏≠ÂõΩ‰ø°È∏Ω‰ø°ÊÅØÁΩë',
        url: 'https://www.chinaxinge.com',
        region: 'national',
        keywords: ['ËµõÈ∏Ω', '‰ø°È∏Ω', 'ÂÖ¨Ê£ö', 'ÊØîËµõ']
      },
      {
        name: 'ËµõÈ∏ΩÂ§©Âú∞',
        url: 'https://www.chinaxinge.com',
        region: 'national',
        keywords: ['ËµõÈ∏Ω', '‰ø°È∏Ω', 'ËÇ≤Áßç', 'Ë°ÄÁªü']
      },
      {
        name: '‰ø°È∏ΩÂÅ•Â∫∑ÁΩë',
        url: 'https://www.chinaxinge.com',
        region: 'national',
        keywords: ['ÂÅ•Â∫∑', 'ÁñæÁóÖ', 'È¢ÑÈò≤', 'Ê≤ªÁñó']
      }
    ]
  };
  
  // ‰ªélocalStorageÂä†ËΩΩËµÑËÆØÊï∞ÊçÆ
  function loadNewsFromStorage() {
    const stored = localStorage.getItem('pigeon_news_data');
    const lastUpdate = localStorage.getItem('pigeon_news_last_update');
    
    if (stored && lastUpdate) {
      const lastUpdateDate = new Date(lastUpdate);
      const now = new Date();
      const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
      
      // Â¶ÇÊûúÊï∞ÊçÆÊòØ‰ªäÂ§©ÁöÑÔºåÁõ¥Êé•‰ΩøÁî®
      if (daysDiff === 0) {
        NEWS_DATA = JSON.parse(stored);
        return true;
      }
    }
    
    return false;
  }
  
  // ‰øùÂ≠òËµÑËÆØÊï∞ÊçÆÂà∞localStorage
  function saveNewsToStorage() {
    localStorage.setItem('pigeon_news_data', JSON.stringify(NEWS_DATA));
    localStorage.setItem('pigeon_news_last_update', new Date().toISOString());
  }
  
  // ÁîüÊàêÁ§∫‰æãËµÑËÆØÊï∞ÊçÆÔºàÂΩìAPI‰∏çÂèØÁî®Êó∂‰ΩøÁî®Ôºâ
  function getSampleNewsData() {
    const now = new Date();
    return [
      {
        id: 'sample_news_1',
        title: '2024Âπ¥Êò•Â≠£‰ø°È∏ΩÂ§ßËµõÂç≥Â∞ÜÂºÄËµõ',
        source: '‰∏≠ÂõΩ‰ø°È∏Ω‰ø°ÊÅØÁΩë',
        sourceUrl: 'https://www.chinaxinge.com',
        time: '2Â∞èÊó∂Ââç',
        updateTime: new Date(now - 2 * 60 * 60 * 1000).toISOString(),
        tags: ['Ëµõ‰∫ã', 'Êò•Â≠£'],
        category: 'race',
        region: 'national',
        content: '2024Âπ¥Êò•Â≠£‰ø°È∏ΩÂ§ßËµõÂ∞Ü‰∫éÊú¨ÊúàÂ∫ïÊ≠£ÂºèÂºÄËµõÔºåÊú¨Ê¨°ÊØîËµõÂê∏Âºï‰∫ÜÂÖ®ÂõΩÂêÑÂú∞ÁöÑ‰ºòÁßÄÈ∏ΩÂèãÂèÇ‰∏éÔºåÈ¢ÑËÆ°ÂèÇËµõÈ∏ΩÂ≠êÊï∞ÈáèÂ∞ÜË∂ÖËøá5000ÁæΩ„ÄÇ',
        hot: true
      },
      {
        id: 'sample_news_2',
        title: 'ËµõÈ∏ΩËÇ≤ÁßçÊñ∞ÊäÄÊúØÂàÜ‰∫´',
        source: 'ËµõÈ∏ΩÂ§©Âú∞',
        sourceUrl: 'https://www.chinaxinge.com',
        time: '5Â∞èÊó∂Ââç',
        updateTime: new Date(now - 5 * 60 * 60 * 1000).toISOString(),
        tags: ['ËÇ≤Áßç', 'ÊäÄÊúØ'],
        category: 'breeding',
        region: 'national',
        content: 'ÊúÄÊñ∞ÁöÑËµõÈ∏ΩËÇ≤ÁßçÊäÄÊúØÂàÜ‰∫´ÔºåÂåÖÊã¨Ë°ÄÁªüÁÆ°ÁêÜ„ÄÅÈÖçÂØπÈÄâÊã©Á≠âÊñπÈù¢ÁöÑ‰∏ì‰∏öÁü•ËØÜÔºåÂ∏ÆÂä©È∏ΩÂèãÊèêÈ´òËÇ≤ÁßçÊàêÂäüÁéá„ÄÇ',
        hot: false
      },
      {
        id: 'sample_news_3',
        title: '‰ø°È∏ΩÂ∏∏ËßÅÁñæÁóÖÈ¢ÑÈò≤ÊåáÂçó',
        source: '‰ø°È∏ΩÂÅ•Â∫∑ÁΩë',
        sourceUrl: 'https://www.chinaxinge.com',
        time: '1Â§©Ââç',
        updateTime: new Date(now - 24 * 60 * 60 * 1000).toISOString(),
        tags: ['ÂÅ•Â∫∑', 'È¢ÑÈò≤'],
        category: 'health',
        region: 'national',
        content: 'ËØ¶ÁªÜ‰ªãÁªç‰ø°È∏ΩÂ∏∏ËßÅÁñæÁóÖÁöÑÈ¢ÑÈò≤ÊñπÊ≥ïÔºåÂåÖÊã¨Êó•Â∏∏Êä§ÁêÜ„ÄÅÁñ´ËãóÊé•Áßç„ÄÅÁéØÂ¢ÉÁÆ°ÁêÜÁ≠âÊñπÈù¢ÁöÑÂª∫ËÆÆ„ÄÇ',
        hot: false
      },
      {
        id: 'sample_news_4',
        title: 'Ë¥µÂ∑ûÁúÅ‰ø°È∏ΩÂçè‰ºöÊò•Â≠£Ê¥ªÂä®ÈÄöÁü•',
        source: 'Ë¥µÂ∑ûÁúÅ‰ø°È∏ΩÂçè‰ºö',
        sourceUrl: 'https://www.chinaxinge.com',
        time: '3Â∞èÊó∂Ââç',
        updateTime: new Date(now - 3 * 60 * 60 * 1000).toISOString(),
        tags: ['Êú¨Âú∞', 'Ê¥ªÂä®'],
        category: 'race',
        region: 'local',
        content: 'Ë¥µÂ∑ûÁúÅ‰ø°È∏ΩÂçè‰ºöÂ∞Ü‰∫éÊú¨Âë®Êú´‰∏æÂäûÊò•Â≠£‰∫§ÊµÅÊ¥ªÂä®ÔºåÊ¨¢ËøéÊú¨Âú∞È∏ΩÂèãÁßØÊûÅÂèÇ‰∏éÔºåÂÖ±Âêå‰∫§ÊµÅËµõÈ∏ΩÁªèÈ™å„ÄÇ',
        hot: true
      },
      {
        id: 'sample_news_5',
        title: '‰ºòÁßÄËµõÈ∏ΩË°ÄÁªüÂàÜÊûê',
        source: 'ËµõÈ∏ΩÂ§©Âú∞',
        sourceUrl: 'https://www.chinaxinge.com',
        time: '6Â∞èÊó∂Ââç',
        updateTime: new Date(now - 6 * 60 * 60 * 1000).toISOString(),
        tags: ['Ë°ÄÁªü', 'ÂàÜÊûê'],
        category: 'breeding',
        region: 'national',
        content: 'Ê∑±ÂÖ•ÂàÜÊûê‰ºòÁßÄËµõÈ∏ΩÁöÑË°ÄÁªüÁâπÁÇπÔºåÂ∏ÆÂä©È∏ΩÂèãÊõ¥Â•ΩÂú∞ÁêÜËß£Ë°ÄÁªüÂØπËµõÈ∏ΩË°®Áé∞ÁöÑÂΩ±Âìç„ÄÇ',
        hot: false
      }
    ];
  }
  
  // ‰ªéÁúüÂÆûAPIËé∑ÂèñËµÑËÆØÊï∞ÊçÆ
  async function fetchNewsFromWeb() {
    // Ëé∑ÂèñAPIÈÖçÁΩÆ
    const apiConfig = getApiConfig();
    
    if (!apiConfig.newsApiUrl) {
      throw new Error('ËµÑËÆØAPIÊú™ÈÖçÁΩÆÔºåËØ∑Âú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPIÂú∞ÂùÄ');
    }
    
    try {
      // ÊûÑÂª∫ËØ∑Ê±ÇÂ§¥
      const headers = {
        'Content-Type': 'application/json'
      };
      if (apiConfig.apiKey) {
        headers['Authorization'] = 'Bearer ' + apiConfig.apiKey;
      }
      
      // Â∞ùËØï‰ªéAPIËé∑ÂèñÊï∞ÊçÆ
      const response = await fetch(apiConfig.newsApiUrl, {
        method: 'GET',
        headers: headers
      });
      
      if (!response.ok) {
        throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} ${response.statusText}`);
      }
      
      const result = await response.json();
      
      // ÂêéÁ´ØAPIËøîÂõûÊ†ºÂºè: {success: true, data: [...], count: X, timestamp: "..."}
      if (!result.success) {
        throw new Error(result.error || 'APIËøîÂõûÈîôËØØ');
      }
      
      const data = result.data || result;
      
      // È™åËØÅÊï∞ÊçÆÊ†ºÂºè
      if (!Array.isArray(data)) {
        throw new Error('APIËøîÂõûÁöÑÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∫î‰∏∫Êï∞ÁªÑ');
      }
      
      // ËΩ¨Êç¢Êï∞ÊçÆÊ†ºÂºè
      return data.map(item => ({
        id: item.id || Date.now() + Math.random(),
        title: item.title || 'Êó†Ê†áÈ¢ò',
        source: item.source || 'Êú™Áü•Êù•Ê∫ê',
        sourceUrl: item.sourceUrl || item.url || '#',
        time: item.time || formatUpdateTime(item.updateTime),
        updateTime: item.updateTime || new Date().toISOString(),
        tags: item.tags || [],
        category: item.category || 'race',
        region: item.region || 'national',
        content: item.content || item.description || '',
        hot: item.hot || false
      }));
      
    } catch (error) {
      console.error('Ëé∑ÂèñËµÑËÆØÂ§±Ë¥•:', error);
      throw error;
    }
  }
  
  // Ëé∑ÂèñAPIÈÖçÁΩÆ
  function getApiConfig() {
    const config = localStorage.getItem('pigeon_api_config');
    if (config) {
      const parsed = JSON.parse(config);
      // Â¶ÇÊûúÈÖçÁΩÆ‰∫ÜËá™ÂÆö‰πâAPI URL‰∏î‰∏çÊòØlocalhostÔºå‰ΩøÁî®ÂÆÉ
      if (parsed.apiUrl && !parsed.apiUrl.includes('localhost')) {
        return parsed;
      }
    }
    
    // Ëá™Âä®Ê£ÄÊµãÂΩìÂâçÂüüÂêçÂπ∂ÊûÑÂª∫API URL
    const currentOrigin = window.location.origin;
    const defaultBaseUrl = currentOrigin + '/api';
    
    // ‰øùÂ≠òËá™Âä®Ê£ÄÊµãÁöÑÈÖçÁΩÆ
    const autoConfig = {
      apiUrl: defaultBaseUrl,
      newsApiUrl: defaultBaseUrl + '/news',
      eventsApiUrl: defaultBaseUrl + '/events',
      apiKey: ''
    };
    
    // Â¶ÇÊûúlocalStorage‰∏≠Ê≤°ÊúâÈÖçÁΩÆÔºå‰øùÂ≠òËá™Âä®Ê£ÄÊµãÁöÑÈÖçÁΩÆ
    if (!config) {
      localStorage.setItem('pigeon_api_config', JSON.stringify(autoConfig));
    }
    
    return autoConfig;
    
    // ÈªòËÆ§ÈÖçÁΩÆÔºàÂêéÁ´ØÊúçÂä°Âú∞ÂùÄÔºâ
    const defaultBaseUrl = 'http://localhost:3000/api';
    return {
      apiUrl: defaultBaseUrl, // APIÂü∫Á°ÄÂú∞ÂùÄ
      newsApiUrl: defaultBaseUrl + '/news', // ËµÑËÆØAPIÂú∞ÂùÄ
      eventsApiUrl: defaultBaseUrl + '/events', // Ëµõ‰∫ãAPIÂú∞ÂùÄ
      apiKey: '' // APIÂØÜÈí•ÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
    };
  }
  
  // ‰øùÂ≠òAPIÈÖçÁΩÆ
  function saveApiConfig(config) {
    localStorage.setItem('pigeon_api_config', JSON.stringify(config));
  }
  
  // Ëá™Âä®Êõ¥Êñ∞ËµÑËÆØ
  async function updateNews() {
    try {
      const news = await fetchNewsFromWeb();
      // Â¶ÇÊûúAPIËøîÂõûÁ©∫Êï∞ÊçÆÔºå‰ΩøÁî®Á§∫‰æãÊï∞ÊçÆ
      NEWS_DATA = Array.isArray(news) && news.length > 0 ? news : getSampleNewsData();
      saveNewsToStorage();
      renderNewsList(currentNewsFilter, currentNewsRegion);
      updateHomeStats();
      console.log('ËµÑËÆØÊõ¥Êñ∞ÂÆåÊàêÔºåÂÖ±Ëé∑Âèñ', NEWS_DATA.length, 'Êù°ËµÑËÆØ');
    } catch (error) {
      console.error('Êõ¥Êñ∞ËµÑËÆØÂ§±Ë¥•:', error);
      
      // Â¶ÇÊûúÊõ¥Êñ∞Â§±Ë¥•ÔºåÂ∞ùËØïÂä†ËΩΩÁºìÂ≠òÊï∞ÊçÆ
      if (loadNewsFromStorage() && NEWS_DATA.length > 0) {
        renderNewsList(currentNewsFilter, currentNewsRegion);
        console.log('‰ΩøÁî®ÁºìÂ≠òÁöÑËµÑËÆØÊï∞ÊçÆ');
      } else {
        // Ê≤°ÊúâÁºìÂ≠òÊï∞ÊçÆÊàñÁºìÂ≠ò‰∏∫Á©∫Ôºå‰ΩøÁî®Á§∫‰æãÊï∞ÊçÆ
        NEWS_DATA = getSampleNewsData();
        saveNewsToStorage();
        renderNewsList(currentNewsFilter, currentNewsRegion);
        console.log('‰ΩøÁî®Á§∫‰æãËµÑËÆØÊï∞ÊçÆÔºàAPIÊú™ÈÖçÁΩÆÊàñÊó†Ê≥ïËøûÊé•Ôºâ');
      }
    }
  }
  
  // ÊòæÁ§∫APIÈÖçÁΩÆÊèêÁ§∫
  function showApiConfigPrompt(type) {
    const container = type === 'ËµÑËÆØ' ? document.getElementById('homeNewsList') : document.getElementById('homeEventsList');
    if (!container) return;
    
    const apiConfig = getApiConfig();
    const apiUrl = type === 'ËµÑËÆØ' ? apiConfig.newsApiUrl : apiConfig.eventsApiUrl;
    
    if (!apiUrl) {
      container.innerHTML = `
        <div style="padding:40px;text-align:center;color:#9ca3af;">
          <div style="font-size:48px;margin-bottom:16px;">${type === 'ËµÑËÆØ' ? 'üì∞' : 'üèÅ'}</div>
          <div style="font-size:16px;font-weight:600;color:#374151;margin-bottom:8px;">${type}APIÊú™ÈÖçÁΩÆ</div>
          <div style="font-size:13px;color:#6b7280;margin-bottom:16px;">ËØ∑ÈÖçÁΩÆ${type}APIÂú∞ÂùÄ‰ª•Ëé∑ÂèñÁúüÂÆûÊï∞ÊçÆ</div>
          <button class="btn btn-primary btn-sm" onclick="showApiConfigModal('${type}')" style="margin-top:12px;">
            ‚öôÔ∏è ÈÖçÁΩÆAPI
          </button>
        </div>
      `;
    }
  }
  
  // ÊòæÁ§∫APIÈÖçÁΩÆÂºπÁ™ó
  window.showApiConfigModal = function(type) {
    const apiConfig = getApiConfig();
    const apiUrl = type === 'ËµÑËÆØ' ? apiConfig.newsApiUrl : apiConfig.eventsApiUrl;
    const apiKey = apiConfig.apiKey || '';
    
    const newsApiUrl = prompt(`ËØ∑ËæìÂÖ•${type === 'ËµÑËÆØ' ? 'ËµÑËÆØ' : 'Ëµõ‰∫ã'}APIÂú∞ÂùÄ:`, apiUrl || '');
    if (newsApiUrl === null) return; // Áî®Êà∑ÂèñÊ∂à
    
    const newApiKey = prompt('ËØ∑ËæìÂÖ•APIÂØÜÈí•ÔºàÂèØÈÄâÔºåÁõ¥Êé•ÂõûËΩ¶Ë∑≥ËøáÔºâ:', apiKey);
    
    const newConfig = {
      ...apiConfig,
      [type === 'ËµÑËÆØ' ? 'newsApiUrl' : 'eventsApiUrl']: newsApiUrl,
      apiKey: newApiKey || apiKey
    };
    
    saveApiConfig(newConfig);
    
    // ÈáçÊñ∞Â∞ùËØïËé∑ÂèñÊï∞ÊçÆ
    if (type === 'ËµÑËÆØ') {
      updateNews();
    } else {
      updateEvents();
    }
    
    alert('APIÈÖçÁΩÆÂ∑≤‰øùÂ≠òÔºåÊ≠£Âú®Ëé∑ÂèñÊï∞ÊçÆ...');
  };
  
  // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞ËµÑËÆØÔºàÊØèÂ§©Êõ¥Êñ∞‰∏ÄÊ¨°Ôºâ
  function checkAndUpdateNews() {
    const lastUpdate = localStorage.getItem('pigeon_news_last_update');
    if (!lastUpdate) {
      // È¶ñÊ¨°Âä†ËΩΩÔºåÂÖàÂ∞ùËØïÂä†ËΩΩÁºìÂ≠òÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®Á§∫‰æãÊï∞ÊçÆ
      if (!loadNewsFromStorage() || NEWS_DATA.length === 0) {
        NEWS_DATA = getSampleNewsData();
        saveNewsToStorage();
        renderNewsList(currentNewsFilter, currentNewsRegion);
        console.log('È¶ñÊ¨°Âä†ËΩΩÔºå‰ΩøÁî®Á§∫‰æãËµÑËÆØÊï∞ÊçÆ');
      } else {
        renderNewsList(currentNewsFilter, currentNewsRegion);
      }
      // Â∞ùËØïÊõ¥Êñ∞ÔºàÂ¶ÇÊûúAPIÂèØÁî®Ôºâ
      updateNews();
      return;
    }
    
    const lastUpdateDate = new Date(lastUpdate);
    const now = new Date();
    const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
    
    if (daysDiff >= 1) {
      // Ë∂ÖËøá1Â§©ÔºåÈúÄË¶ÅÊõ¥Êñ∞
      updateNews();
    } else {
      // ‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ
      if (loadNewsFromStorage() && NEWS_DATA.length > 0) {
        renderNewsList(currentNewsFilter, currentNewsRegion);
      } else {
        // Â¶ÇÊûúÊ≤°ÊúâÁºìÂ≠òÊàñÁºìÂ≠ò‰∏∫Á©∫Ôºå‰ΩøÁî®Á§∫‰æãÊï∞ÊçÆ
        NEWS_DATA = getSampleNewsData();
        saveNewsToStorage();
        renderNewsList(currentNewsFilter, currentNewsRegion);
        // Â∞ùËØïÊõ¥Êñ∞ÔºàÂ¶ÇÊûúAPIÂèØÁî®Ôºâ
        updateNews();
      }
    }
  }
  
  // Ê®°ÊãüËµõ‰∫ãÊï∞ÊçÆ
  // Ëµõ‰∫ãÊï∞ÊçÆÂ≠òÂÇ®
  let EVENTS_DATA = {
    ongoing: [],
    upcoming: [],
    results: []
  };
  
  let currentNewsFilter = 'all';
  let currentEventTab = 'ongoing';
  let currentEventRegion = 'local'; // 'local' Êàñ 'national'
  
  // Ëµõ‰∫ãÊù•Ê∫êÈÖçÁΩÆ
  const EVENT_SOURCES = {
    local: [
      {
        name: 'Ë¥µÂ∑ûÁúÅ‰ø°È∏ΩÂçè‰ºö',
        url: 'https://www.chinaxinge.com',
        region: 'local',
        keywords: ['Ë¥µÂ∑û', 'Ë¥µÈò≥', 'ÈÅµ‰πâ', 'ÊØïËäÇ', 'ÈªîË•ø']
      },
      {
        name: 'Ë•øÂçóËµõÈ∏ΩÁΩë',
        url: 'https://www.chinaxinge.com',
        region: 'local',
        keywords: ['Ë•øÂçó', 'ÂõõÂ∑ù', 'ÈáçÂ∫Ü', '‰∫ëÂçó', 'Ë¥µÂ∑û']
      }
    ],
    national: [
      {
        name: '‰∏≠ÂõΩ‰ø°È∏Ω‰ø°ÊÅØÁΩë',
        url: 'https://www.chinaxinge.com',
        region: 'national',
        keywords: ['ËµõÈ∏Ω', '‰ø°È∏Ω', 'ÂÖ¨Ê£ö', 'ÊØîËµõ']
      },
      {
        name: 'ËµõÈ∏ΩÂ§©Âú∞',
        url: 'https://www.chinaxinge.com',
        region: 'national',
        keywords: ['ËµõÈ∏Ω', '‰ø°È∏Ω', 'ÊØîËµõ', 'Ëµõ‰∫ã']
      }
    ]
  };
  
  // ‰ªélocalStorageÂä†ËΩΩËµõ‰∫ãÊï∞ÊçÆ
  function loadEventsFromStorage() {
    const stored = localStorage.getItem('pigeon_events_data');
    const lastUpdate = localStorage.getItem('pigeon_events_last_update');
    
    if (stored && lastUpdate) {
      const lastUpdateDate = new Date(lastUpdate);
      const now = new Date();
      const daysDiff = Math.floor((now - lastUpdateDate) / (1000 * 60 * 60 * 24));
      
      // Â¶ÇÊûúÊï∞ÊçÆÊòØ‰ªäÂ§©ÁöÑÔºåÁõ¥Êé•‰ΩøÁî®
      if (daysDiff === 0) {
        EVENTS_DATA = JSON.parse(stored);
        return true;
      }
    }
    
    return false;
  }
  
  // ‰øùÂ≠òËµõ‰∫ãÊï∞ÊçÆÂà∞localStorage
  function saveEventsToStorage() {
    localStorage.setItem('pigeon_events_data', JSON.stringify(EVENTS_DATA));
    localStorage.setItem('pigeon_events_last_update', new Date().toISOString());
  }
  
  // ÁîüÊàêÁ§∫‰æãËµõ‰∫ãÊï∞ÊçÆÔºàÂΩìAPI‰∏çÂèØÁî®Êó∂‰ΩøÁî®Ôºâ
  function getSampleEventsData() {
    const now = new Date();
    const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
    const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
    const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    const lastWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    return {
      ongoing: [
        {
          id: 'sample_event_ongoing_1',
          name: '2024Âπ¥Êò•Â≠£500ÂÖ¨ÈáåÁ´ûÁøîËµõ',
          region: 'local',
          releaseTimeFull: new Date(now.getTime() - 2 * 60 * 60 * 1000).toISOString(),
          endTimeFull: new Date(now.getTime() + 4 * 60 * 60 * 1000).toISOString(),
          location: 'Ë¥µÂ∑ûÁúÅË¥µÈò≥Â∏Ç',
          distance: '500ÂÖ¨Èáå',
          participants: 1250,
          source: 'Ë¥µÂ∑ûÁúÅ‰ø°È∏ΩÂçè‰ºö',
          sourceUrl: 'https://www.chinaxinge.com',
          updateTime: new Date(now.getTime() - 30 * 60 * 1000).toISOString()
        }
      ],
      upcoming: [
        {
          id: 'sample_event_upcoming_1',
          name: '2024Âπ¥Êò•Â≠£700ÂÖ¨ÈáåÁ≤æËã±Ëµõ',
          region: 'national',
          startTimeFull: tomorrow.toISOString(),
          location: 'ÂÖ®ÂõΩÂ§öÂú∞',
          distance: '700ÂÖ¨Èáå',
          participants: 3500,
          source: '‰∏≠ÂõΩ‰ø°È∏Ω‰ø°ÊÅØÁΩë',
          sourceUrl: 'https://www.chinaxinge.com',
          updateTime: new Date(now.getTime() - 2 * 60 * 60 * 1000).toISOString()
        },
        {
          id: 'sample_event_upcoming_2',
          name: 'Ë•øÂçóÂú∞Âå∫Êò•Â≠£ËÅîÁøîËµõ',
          region: 'local',
          startTimeFull: nextWeek.toISOString(),
          location: 'Ë•øÂçóÂú∞Âå∫',
          distance: '600ÂÖ¨Èáå',
          participants: 2100,
          source: 'Ë•øÂçóËµõÈ∏ΩÁΩë',
          sourceUrl: 'https://www.chinaxinge.com',
          updateTime: new Date(now.getTime() - 5 * 60 * 60 * 1000).toISOString()
        }
      ],
      results: [
        {
          id: 'sample_event_results_1',
          name: '2024Âπ¥Êò•Â≠£300ÂÖ¨ÈáåÁÉ≠Ë∫´Ëµõ',
          region: 'local',
          endTimeFull: yesterday.toISOString(),
          location: 'Ë¥µÂ∑ûÁúÅË¥µÈò≥Â∏Ç',
          distance: '300ÂÖ¨Èáå',
          participants: 850,
          winner: 'Âº†‰∏â',
          winnerRing: '2023-01-123456',
          source: 'Ë¥µÂ∑ûÁúÅ‰ø°È∏ΩÂçè‰ºö',
          sourceUrl: 'https://www.chinaxinge.com',
          updateTime: yesterday.toISOString()
        },
        {
          id: 'sample_event_results_2',
          name: '2024Âπ¥Êò•Â≠£400ÂÖ¨ÈáåÈ¢ÑËµõ',
          region: 'national',
          endTimeFull: lastWeek.toISOString(),
          location: 'ÂÖ®ÂõΩÂ§öÂú∞',
          distance: '400ÂÖ¨Èáå',
          participants: 2800,
          winner: 'ÊùéÂõõ',
          winnerRing: '2023-02-789012',
          source: '‰∏≠ÂõΩ‰ø°È∏Ω‰ø°ÊÅØÁΩë',
          sourceUrl: 'https://www.chinaxinge.com',
          updateTime: lastWeek.toISOString()
        }
      ]
    };
  }
  
  // ‰ªéÁúüÂÆûAPIËé∑ÂèñËµõ‰∫ãÊï∞ÊçÆ
  async function fetchEventsFromWeb() {
    // Ëé∑ÂèñAPIÈÖçÁΩÆ
    const apiConfig = getApiConfig();
    
    if (!apiConfig.eventsApiUrl) {
      throw new Error('Ëµõ‰∫ãAPIÊú™ÈÖçÁΩÆÔºåËØ∑Âú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPIÂú∞ÂùÄ');
    }
    
    try {
      // ÊûÑÂª∫ËØ∑Ê±ÇÂ§¥
      const headers = {
        'Content-Type': 'application/json'
      };
      if (apiConfig.apiKey) {
        headers['Authorization'] = 'Bearer ' + apiConfig.apiKey;
      }
      
      // Â∞ùËØï‰ªéAPIËé∑ÂèñÊï∞ÊçÆÔºàËé∑ÂèñÊâÄÊúâÁ±ªÂûãÁöÑËµõ‰∫ãÔºâ
      const response = await fetch(apiConfig.eventsApiUrl, {
        method: 'GET',
        headers: headers
      });
      
      if (!response.ok) {
        const errorText = await response.text().catch(() => '');
        throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} ${response.statusText}. ${errorText}`);
      }
      
      const result = await response.json();
      
      // ÂêéÁ´ØAPIËøîÂõûÊ†ºÂºè: {success: true, data: {ongoing: [], upcoming: [], results: []}}
      if (!result.success) {
        throw new Error(result.error || result.message || 'APIËøîÂõûÈîôËØØ');
      }
      
      const data = result.data || result;
      
      // È™åËØÅÊï∞ÊçÆÊ†ºÂºè
      if (!data.ongoing || !data.upcoming || !data.results) {
        throw new Error('APIËøîÂõûÁöÑÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∫îÂåÖÂê´ongoing„ÄÅupcoming„ÄÅresultsÂ≠óÊÆµ');
      }
      
      // ËΩ¨Êç¢Êï∞ÊçÆÊ†ºÂºèÂπ∂È™åËØÅ
      const now = new Date();
      return {
        ongoing: (data.ongoing || []).map(item => {
          // È™åËØÅÊó∂Èó¥Â≠óÊÆµ
          const releaseTimeFull = item.releaseTimeFull ? new Date(item.releaseTimeFull) : null;
          const endTimeFull = item.endTimeFull ? new Date(item.endTimeFull) : null;
          
          // Â¶ÇÊûúËµõ‰∫ãÂ∑≤ÁªìÊùüÔºå‰∏çÂ∫îËØ•Âú®ongoing‰∏≠
          if (endTimeFull && endTimeFull <= now) {
            return null; // ËøîÂõûnullÔºåÂêéÁª≠‰ºöË¢´ËøáÊª§
          }
          
          // Â¶ÇÊûúreleaseTimeFullÊòØÊú™Êù•Êó∂Èó¥Ôºå‰∏çÂ∫îËØ•Âú®ongoing‰∏≠
          if (releaseTimeFull && releaseTimeFull > now) {
            return null;
          }
          
          return {
            id: item.id || Date.now() + Math.random(),
            name: item.name || 'Êú™Áü•Ëµõ‰∫ã',
            organizer: item.organizer || 'Êú™Áü•ÁªÑÁªá',
            source: item.source || 'Êú™Áü•Êù•Ê∫ê',
            sourceUrl: item.sourceUrl || item.url || '#',
            releaseTime: item.releaseTime || 'Êú™Áü•Êó∂Èó¥',
            releaseTimeFull: item.releaseTimeFull || new Date().toISOString(),
            endTimeFull: item.endTimeFull || null,
            distance: item.distance || 'Êú™Áü•Ë∑ùÁ¶ª',
            status: 'ongoing',
            region: item.region || 'national',
            returned: item.returned || 0,
            total: item.total || 0,
            weather: item.weather || 'Êú™Áü•',
            updateTime: item.updateTime || new Date().toISOString()
          };
        }).filter(item => item !== null), // ËøáÊª§ÊéânullÂÄº
        upcoming: (data.upcoming || []).map(item => {
          // È™åËØÅÊó∂Èó¥Â≠óÊÆµ
          const startTimeFull = item.startTimeFull ? new Date(item.startTimeFull) : null;
          
          // Â¶ÇÊûústartTimeFullÊòØËøáÂéªÊó∂Èó¥Ôºå‰∏çÂ∫îËØ•Âú®upcoming‰∏≠
          if (startTimeFull && startTimeFull <= now) {
            return null; // ËøîÂõûnullÔºåÂêéÁª≠‰ºöË¢´ËøáÊª§
          }
          
          return {
            id: item.id || Date.now() + Math.random(),
            name: item.name || 'Êú™Áü•Ëµõ‰∫ã',
            organizer: item.organizer || 'Êú™Áü•ÁªÑÁªá',
            source: item.source || 'Êú™Áü•Êù•Ê∫ê',
            sourceUrl: item.sourceUrl || item.url || '#',
            startTime: item.startTime || 'Êú™Áü•Êó∂Èó¥',
            startTimeFull: item.startTimeFull || new Date(now.getTime() + 86400000).toISOString(),
            distance: item.distance || 'Êú™Áü•Ë∑ùÁ¶ª',
            status: 'upcoming',
            region: item.region || 'national',
            participants: item.participants || 0,
            weather: item.weather || 'Êú™Áü•',
            updateTime: item.updateTime || new Date().toISOString()
          };
        }).filter(item => item !== null), // ËøáÊª§ÊéânullÂÄº
        results: (data.results || []).map(item => {
          // È™åËØÅÊó∂Èó¥Â≠óÊÆµ
          const endTimeFull = item.endTimeFull ? new Date(item.endTimeFull) : null;
          
          // Â¶ÇÊûúendTimeFullÊòØÊú™Êù•Êó∂Èó¥Ôºå‰∏çÂ∫îËØ•Âú®results‰∏≠
          if (endTimeFull && endTimeFull > now) {
            return null; // ËøîÂõûnullÔºåÂêéÁª≠‰ºöË¢´ËøáÊª§
          }
          
          return {
            id: item.id || Date.now() + Math.random(),
            name: item.name || 'Êú™Áü•Ëµõ‰∫ã',
            organizer: item.organizer || 'Êú™Áü•ÁªÑÁªá',
            source: item.source || 'Êú™Áü•Êù•Ê∫ê',
            sourceUrl: item.sourceUrl || item.url || '#',
            endTime: item.endTime || 'Êú™Áü•Êó∂Èó¥',
            endTimeFull: item.endTimeFull || new Date(now.getTime() - 86400000).toISOString(),
            distance: item.distance || 'Êú™Áü•Ë∑ùÁ¶ª',
            status: 'completed',
            region: item.region || 'national',
            champion: item.champion || 'Êú™Áü•',
            championRing: item.championRing || 'Êú™Áü•',
            championTime: item.championTime || 'Êú™Áü•',
            updateTime: item.updateTime || new Date().toISOString()
          };
        }).filter(item => item !== null) // ËøáÊª§ÊéânullÂÄº
      };
      
    } catch (error) {
      console.error('Ëé∑ÂèñËµõ‰∫ãÂ§±Ë¥•:', error);
      throw error;
    }
  }
  
  // Ëá™Âä®Êõ¥Êñ∞Ëµõ‰∫ã
  async function updateEvents() {
    try {
      const events = await fetchEventsFromWeb();
      
      // ÂÜçÊ¨°È™åËØÅÂíåËøáÊª§Êï∞ÊçÆÔºåÁ°Æ‰øùÊï∞ÊçÆÁúüÂÆûÊÄß
      const now = new Date();
      
      // ËøáÊª§ËøõË°å‰∏≠ÁöÑËµõ‰∫ãÔºöÂøÖÈ°ªÊòØÂ∑≤ÂºÄÂßã‰ΩÜÊú™ÁªìÊùüÁöÑÔºàÁ§∫‰æãÊï∞ÊçÆÈô§Â§ñÔºâ
      events.ongoing = events.ongoing.filter(event => {
        // Á§∫‰æãÊï∞ÊçÆÂßãÁªà‰øùÁïô
        if (event.id?.startsWith('sample_')) return true;
        
        if (!event.releaseTimeFull) return false;
        const releaseTime = new Date(event.releaseTimeFull);
        if (releaseTime > now) return false; // Êú™ÂºÄÂßã
        
        if (event.endTimeFull) {
          const endTime = new Date(event.endTimeFull);
          if (endTime <= now) return false; // Â∑≤ÁªìÊùü
        }
        
        // Êõ¥Êñ∞Êó∂Èó¥‰∏çËÉΩË∂ÖËøá2Â∞èÊó∂
        if (event.updateTime) {
          const updateTime = new Date(event.updateTime);
          const hoursSinceUpdate = (now - updateTime) / (1000 * 60 * 60);
          if (hoursSinceUpdate > 2) return false;
        }
        
        return true;
      });
      
      // ËøáÊª§Âç≥Â∞ÜÂºÄÂßãÁöÑËµõ‰∫ãÔºöÂøÖÈ°ªÊòØÊú™Êù•ÁöÑÔºàÁ§∫‰æãÊï∞ÊçÆÈô§Â§ñÔºâ
      events.upcoming = events.upcoming.filter(event => {
        // Á§∫‰æãÊï∞ÊçÆÂßãÁªà‰øùÁïô
        if (event.id?.startsWith('sample_')) return true;
        
        if (!event.startTimeFull) return false;
        const startTime = new Date(event.startTimeFull);
        return startTime > now; // ÂøÖÈ°ªÊòØÊú™Êù•Êó∂Èó¥
      });
      
      // ËøáÊª§Â∑≤ÁªìÊùüÁöÑËµõ‰∫ãÔºöÂøÖÈ°ªÊòØËøáÂéªÁöÑÔºàÁ§∫‰æãÊï∞ÊçÆÈô§Â§ñÔºâ
      events.results = events.results.filter(event => {
        // Á§∫‰æãÊï∞ÊçÆÂßãÁªà‰øùÁïô
        if (event.id?.startsWith('sample_')) return true;
        
        if (!event.endTimeFull) return false;
        const endTime = new Date(event.endTimeFull);
        return endTime <= now; // ÂøÖÈ°ªÊòØËøáÂéªÊó∂Èó¥
      });
      
      // Â¶ÇÊûúËøáÊª§ÂêéÊï∞ÊçÆ‰∏∫Á©∫Ôºå‰ΩøÁî®Á§∫‰æãÊï∞ÊçÆ
      if (events.ongoing.length === 0 && events.upcoming.length === 0 && events.results.length === 0) {
        events = getSampleEventsData();
      }
      
      EVENTS_DATA = events;
      saveEventsToStorage();
      renderEventsList(currentEventTab, currentEventRegion);
      updateHomeStats();
      console.log('Ëµõ‰∫ãÊõ¥Êñ∞ÂÆåÊàêÔºåÂÖ±Ëé∑Âèñ', 
        events.ongoing.length + events.upcoming.length + events.results.length, 
        'Âú∫ÊúâÊïàËµõ‰∫ã');
    } catch (error) {
      console.error('Êõ¥Êñ∞Ëµõ‰∫ãÂ§±Ë¥•:', error);
      
      // Â¶ÇÊûúÊõ¥Êñ∞Â§±Ë¥•ÔºåÂ∞ùËØïÂä†ËΩΩÁºìÂ≠òÊï∞ÊçÆ
      if (loadEventsFromStorage() && 
          (EVENTS_DATA.ongoing?.length > 0 || EVENTS_DATA.upcoming?.length > 0 || EVENTS_DATA.results?.length > 0)) {
        renderEventsList(currentEventTab, currentEventRegion);
        console.log('‰ΩøÁî®ÁºìÂ≠òÁöÑËµõ‰∫ãÊï∞ÊçÆ');
      } else {
        // Ê≤°ÊúâÁºìÂ≠òÊï∞ÊçÆÊàñÁºìÂ≠ò‰∏∫Á©∫Ôºå‰ΩøÁî®Á§∫‰æãÊï∞ÊçÆ
        EVENTS_DATA = getSampleEventsData();
        saveEventsToStorage();
        renderEventsList(currentEventTab, currentEventRegion);
        console.log('‰ΩøÁî®Á§∫‰æãËµõ‰∫ãÊï∞ÊçÆÔºàAPIÊú™ÈÖçÁΩÆÊàñÊó†Ê≥ïËøûÊé•Ôºâ');
      }
    }
  }
  
  // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞Ëµõ‰∫ãÔºàÂÆûÊó∂Êõ¥Êñ∞Ôºâ
  function checkAndUpdateEvents() {
    const lastUpdate = localStorage.getItem('pigeon_events_last_update');
    if (!lastUpdate) {
      // È¶ñÊ¨°Âä†ËΩΩÔºåÂÖàÂ∞ùËØïÂä†ËΩΩÁºìÂ≠òÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®Á§∫‰æãÊï∞ÊçÆ
      if (!loadEventsFromStorage() || 
          (!EVENTS_DATA.ongoing?.length && !EVENTS_DATA.upcoming?.length && !EVENTS_DATA.results?.length)) {
        EVENTS_DATA = getSampleEventsData();
        saveEventsToStorage();
        renderEventsList(currentEventTab, currentEventRegion);
        console.log('È¶ñÊ¨°Âä†ËΩΩÔºå‰ΩøÁî®Á§∫‰æãËµõ‰∫ãÊï∞ÊçÆ');
      } else {
        renderEventsList(currentEventTab, currentEventRegion);
      }
      // Â∞ùËØïÊõ¥Êñ∞ÔºàÂ¶ÇÊûúAPIÂèØÁî®Ôºâ
      updateEvents();
      return;
    }
    
    const lastUpdateDate = new Date(lastUpdate);
    const now = new Date();
    const minutesSinceUpdate = (now - lastUpdateDate) / (1000 * 60);
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâËøõË°å‰∏≠ÁöÑËµõ‰∫ã
    const hasOngoingEvents = (EVENTS_DATA.ongoing || []).length > 0;
    
    if (hasOngoingEvents) {
      // Â¶ÇÊûúÊúâËøõË°å‰∏≠ÁöÑËµõ‰∫ãÔºåÊØè5ÂàÜÈíüÊõ¥Êñ∞‰∏ÄÊ¨°
      if (minutesSinceUpdate >= 5) {
        updateEvents();
      } else {
        // ‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆÔºå‰ΩÜËÆæÁΩÆÂÆöÊó∂Âô®Âú®5ÂàÜÈíüÂêéÊõ¥Êñ∞
        if (loadEventsFromStorage() && 
            (EVENTS_DATA.ongoing?.length > 0 || EVENTS_DATA.upcoming?.length > 0 || EVENTS_DATA.results?.length > 0)) {
          renderEventsList(currentEventTab, currentEventRegion);
        } else {
          // Â¶ÇÊûúÊ≤°ÊúâÁºìÂ≠òÊàñÁºìÂ≠ò‰∏∫Á©∫Ôºå‰ΩøÁî®Á§∫‰æãÊï∞ÊçÆ
          EVENTS_DATA = getSampleEventsData();
          saveEventsToStorage();
          renderEventsList(currentEventTab, currentEventRegion);
          updateEvents();
        }
        // ËÆæÁΩÆÂÆöÊó∂Âô®Ôºå5ÂàÜÈíüÂêéËá™Âä®Êõ¥Êñ∞
        setTimeout(() => {
          updateEvents();
        }, (5 - minutesSinceUpdate) * 60 * 1000);
      }
    } else {
      // Ê≤°ÊúâËøõË°å‰∏≠ÁöÑËµõ‰∫ãÔºåÊØèÂ∞èÊó∂Êõ¥Êñ∞‰∏ÄÊ¨°
      if (minutesSinceUpdate >= 60) {
        updateEvents();
      } else {
        // ‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ
        if (loadEventsFromStorage() && 
            (EVENTS_DATA.ongoing?.length > 0 || EVENTS_DATA.upcoming?.length > 0 || EVENTS_DATA.results?.length > 0)) {
          renderEventsList(currentEventTab, currentEventRegion);
        } else {
          // Â¶ÇÊûúÊ≤°ÊúâÁºìÂ≠òÊàñÁºìÂ≠ò‰∏∫Á©∫Ôºå‰ΩøÁî®Á§∫‰æãÊï∞ÊçÆ
          EVENTS_DATA = getSampleEventsData();
          saveEventsToStorage();
          renderEventsList(currentEventTab, currentEventRegion);
          updateEvents();
        }
      }
    }
  }
  
  // ËÆæÁΩÆÂÆûÊó∂Êõ¥Êñ∞ÂÆöÊó∂Âô®ÔºàÈíàÂØπËøõË°å‰∏≠ÁöÑËµõ‰∫ãÔºâ
  function setupRealTimeEventUpdate() {
    // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
    if (window.realTimeEventInterval) {
      clearInterval(window.realTimeEventInterval);
    }
    
    // ÊØè5ÂàÜÈíüÊ£ÄÊü•‰∏ÄÊ¨°ÊòØÂê¶ÊúâËøõË°å‰∏≠ÁöÑËµõ‰∫ãÈúÄË¶ÅÊõ¥Êñ∞
    window.realTimeEventInterval = setInterval(() => {
      const hasOngoingEvents = (EVENTS_DATA.ongoing || []).length > 0;
      if (hasOngoingEvents) {
        // Â¶ÇÊûúÊúâËøõË°å‰∏≠ÁöÑËµõ‰∫ãÔºåÁ´ãÂç≥Êõ¥Êñ∞
        updateEvents();
      }
    }, 5 * 60 * 1000); // 5ÂàÜÈíü
    
    console.log('ÂÆûÊó∂Ëµõ‰∫ãÊõ¥Êñ∞Â∑≤ËÆæÁΩÆÔºåÊØè5ÂàÜÈíüËá™Âä®Êõ¥Êñ∞ËøõË°å‰∏≠ÁöÑËµõ‰∫ã');
  }
  
  // Êõ¥Êñ∞È¶ñÈ°µÊó•ÊúüÊòæÁ§∫
  function updateHomeDate() {
    const now = new Date();
    const weekdays = ['ÊòüÊúüÊó•', 'ÊòüÊúü‰∏Ä', 'ÊòüÊúü‰∫å', 'ÊòüÊúü‰∏â', 'ÊòüÊúüÂõõ', 'ÊòüÊúü‰∫î', 'ÊòüÊúüÂÖ≠'];
    
    const dayEl = document.getElementById('homeDay');
    const weekdayEl = document.getElementById('homeWeekday');
    const dateFullEl = document.getElementById('homeDateFull');
    
    if (dayEl) dayEl.textContent = now.getDate();
    if (weekdayEl) weekdayEl.textContent = weekdays[now.getDay()];
    if (dateFullEl) dateFullEl.textContent = `${now.getFullYear()}Âπ¥${now.getMonth() + 1}Êúà`;
  }
  
  // Êõ¥Êñ∞È¶ñÈ°µÁªüËÆ°
  function updateHomeStats() {
    const pigeonCountEl = document.getElementById('homePigeonCount');
    if (pigeonCountEl) {
      pigeonCountEl.textContent = pigeons.filter(p => p.alive).length;
    }
    
    // Êõ¥Êñ∞ÂÖ∂‰ªñÁªüËÆ°ÔºàÂÆûÈôÖÈ°πÁõÆ‰∏≠‰ªéÂêéÁ´ØËé∑ÂèñÔºâ
    document.getElementById('homeNewsCount').textContent = NEWS_DATA.length || 0;
    document.getElementById('homeActiveRaces').textContent = (EVENTS_DATA.ongoing || []).length;
    document.getElementById('homeCompletedRaces').textContent = (EVENTS_DATA.results || []).length;
  }
  
  // Ê†ºÂºèÂåñÊõ¥Êñ∞Êó∂Èó¥
  function formatUpdateTime(updateTime) {
    if (!updateTime) return 'Êú™Áü•';
    const date = new Date(updateTime);
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 60) {
      return `${minutes}ÂàÜÈíüÂâç`;
    } else if (hours < 24) {
      return `${hours}Â∞èÊó∂Ââç`;
    } else if (days < 7) {
      return `${days}Â§©Ââç`;
    } else {
      return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
    }
  }
  
  // Ê∏≤ÊüìËµÑËÆØÂàóË°®
  function renderNewsList(filter = 'all', region = 'local') {
    const container = document.getElementById('homeNewsList');
    if (!container) return;
    
    // Â¶ÇÊûúÊï∞ÊçÆ‰∏∫Á©∫Ôºå‰ΩøÁî®Á§∫‰æãÊï∞ÊçÆ
    if (!NEWS_DATA || NEWS_DATA.length === 0) {
      NEWS_DATA = getSampleNewsData();
      saveNewsToStorage();
    }
    
    // ÂÖàÊåâÂú∞Âå∫Á≠õÈÄâ
    let filteredNews = NEWS_DATA.filter(n => n.region === region);
    
    // ÂÜçÊåâÂàÜÁ±ªÁ≠õÈÄâ
    if (filter !== 'all') {
      filteredNews = filteredNews.filter(n => n.category === filter);
    }
    
    // Â¶ÇÊûúÁ≠õÈÄâÂêé‰∏∫Á©∫ÔºåÂ∞ùËØïÊòæÁ§∫ÊâÄÊúâÂú∞Âå∫ÁöÑÁ§∫‰æãÊï∞ÊçÆ
    if (filteredNews.length === 0 && NEWS_DATA.length > 0) {
      filteredNews = NEWS_DATA.filter(n => filter === 'all' || n.category === filter);
    }
    
    // ÊåâÊõ¥Êñ∞Êó∂Èó¥ÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
    filteredNews.sort((a, b) => {
      const timeA = new Date(a.updateTime || 0);
      const timeB = new Date(b.updateTime || 0);
      return timeB - timeA;
    });
    
    if (filteredNews.length === 0) {
      // Â¶ÇÊûú‰ªçÁÑ∂‰∏∫Á©∫Ôºå‰ΩøÁî®Á§∫‰æãÊï∞ÊçÆ
      NEWS_DATA = getSampleNewsData();
      saveNewsToStorage();
      filteredNews = NEWS_DATA.filter(n => n.region === region);
      if (filter !== 'all') {
        filteredNews = filteredNews.filter(n => n.category === filter);
      }
      if (filteredNews.length === 0) {
        filteredNews = NEWS_DATA;
      }
    }
    
    container.innerHTML = filteredNews.map(news => {
      const updateTimeStr = formatUpdateTime(news.updateTime);
      return `
        <div class="news-card" data-news-id="${news.id}">
          <div class="news-card-header">
            <div class="news-card-title">${news.title}</div>
            <div class="news-card-time">${news.time}</div>
          </div>
          <div class="news-card-source">Êù•Ê∫êÔºö${news.source}</div>
          <div class="news-card-update-time">Êõ¥Êñ∞Êó∂Èó¥Ôºö${updateTimeStr}</div>
          <div class="news-card-tags">
            ${news.hot ? '<span class="news-tag hot">üî• ÁÉ≠Èó®</span>' : ''}
            ${news.tags.map(tag => `<span class="news-tag ${news.category}">#${tag}</span>`).join('')}
          </div>
          <div class="news-card-actions">
            <button class="news-card-action-btn" onclick="viewNewsDetail(${news.id})">üìñ Êü•ÁúãËØ¶ÊÉÖ</button>
            <button class="news-card-action-btn primary" onclick="openNewsOriginal(${news.id})">üîó Êü•ÁúãÂéüÊñá</button>
          </div>
        </div>
      `;
    }).join('');
  }
  
  // Êü•ÁúãËµÑËÆØËØ¶ÊÉÖÔºàÊö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºâ
  window.viewNewsDetail = function(newsId) {
    const news = NEWS_DATA.find(n => n.id === newsId);
    if (!news) {
      alert('ËµÑËÆØ‰∏çÂ≠òÂú®');
      return;
    }
    
    const modal = document.getElementById('newsModal');
    const titleEl = document.getElementById('newsModalTitle');
    const sourceEl = document.getElementById('newsModalSource');
    const regionEl = document.getElementById('newsModalRegion');
    const updateTimeEl = document.getElementById('newsModalUpdateTime');
    const contentEl = document.getElementById('newsModalContent');
    
    titleEl.textContent = news.title;
    sourceEl.textContent = `Êù•Ê∫êÔºö${news.source}`;
    regionEl.textContent = news.region === 'local' ? 'üìç Êú¨Âú∞ËµÑËÆØ' : 'üåê ÂÖ®ÂõΩËµÑËÆØ';
    updateTimeEl.textContent = `Êõ¥Êñ∞Êó∂Èó¥Ôºö${formatUpdateTime(news.updateTime)}`;
    contentEl.textContent = news.content || 'ÊöÇÊó†ËØ¶ÁªÜÂÜÖÂÆπ';
    
    // ËÆæÁΩÆÊü•ÁúãÂéüÊñáÊåâÈíÆÁöÑÈìæÊé•
    const viewOriginalBtn = document.getElementById('newsModalViewOriginal');
    viewOriginalBtn.onclick = () => window.openNewsOriginal(newsId);
    
    modal.classList.add('active');
  };
  
  // ÊâìÂºÄÂéüËµÑËÆØÈìæÊé•ÔºàÊö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºâ
  window.openNewsOriginal = function(newsId) {
    const news = NEWS_DATA.find(n => n.id === newsId);
    if (!news || !news.sourceUrl) {
      alert('ÂéüËµÑËÆØÈìæÊé•‰∏çÂ≠òÂú®');
      return;
    }
    
    window.open(news.sourceUrl, '_blank');
  };
  
  // ÂÖ≥Èó≠ËµÑËÆØËØ¶ÊÉÖÂºπÁ™ó
  function closeNewsModal() {
    const modal = document.getElementById('newsModal');
    modal.classList.remove('active');
  }
  
  // È™åËØÅËµõ‰∫ãÊó∂Èó¥ÊòØÂê¶ÊúâÊïà
  function isValidEventTime(event, tab) {
    const now = new Date();
    
    if (tab === 'ongoing') {
      // ËøõË°å‰∏≠ÁöÑËµõ‰∫ãÔºöÂøÖÈ°ªÊúâreleaseTimeFullÔºå‰∏îÂøÖÈ°ªÊòØ‰ªäÂ§©ÊàñÊú™Êù•ÁöÑÊó∂Èó¥
      if (!event.releaseTimeFull) return false;
      const releaseTime = new Date(event.releaseTimeFull);
      // Ëµõ‰∫ãÂºÄÂßãÊó∂Èó¥‰∏çËÉΩË∂ÖËøá24Â∞èÊó∂ÂâçÔºàÂ¶ÇÊûúË∂ÖËøá24Â∞èÊó∂ËøòÊ≤°ÁªìÊùüÔºåÂèØËÉΩÊï∞ÊçÆÊúâÈóÆÈ¢òÔºâ
      const hoursSinceRelease = (now - releaseTime) / (1000 * 60 * 60);
      if (hoursSinceRelease > 24) return false; // Ë∂ÖËøá24Â∞èÊó∂ÁöÑËøõË°å‰∏≠Ëµõ‰∫ãËßÜ‰∏∫Êó†Êïà
      if (releaseTime > now) return false; // Êú™ÂºÄÂßãÁöÑËµõ‰∫ã‰∏çÂ∫îËØ•Âú®"ËøõË°å‰∏≠"
      return true;
    } else if (tab === 'upcoming') {
      // Âç≥Â∞ÜÂºÄÂßãÁöÑËµõ‰∫ãÔºöÂøÖÈ°ªÊúâstartTimeFullÔºå‰∏îÂøÖÈ°ªÊòØÊú™Êù•ÁöÑÊó∂Èó¥
      if (!event.startTimeFull) return false;
      const startTime = new Date(event.startTimeFull);
      if (startTime <= now) return false; // Â∑≤ÂºÄÂßãÁöÑËµõ‰∫ã‰∏çÂ∫îËØ•Âú®"Âç≥Â∞ÜÂºÄÂßã"
      return true;
    } else if (tab === 'results') {
      // Â∑≤ÁªìÊùüÁöÑËµõ‰∫ãÔºöÂøÖÈ°ªÊúâendTimeFullÔºå‰∏îÂøÖÈ°ªÊòØËøáÂéªÁöÑÊó∂Èó¥
      if (!event.endTimeFull) return false;
      const endTime = new Date(event.endTimeFull);
      if (endTime > now) return false; // Êú™ÁªìÊùüÁöÑËµõ‰∫ã‰∏çÂ∫îËØ•Âú®"ÊúÄÊñ∞ÊàêÁª©"
      return true;
    }
    
    return true;
  }
  
  // È™åËØÅËµõ‰∫ãÊï∞ÊçÆÊòØÂê¶ËøáÊó∂
  function isEventOutdated(event) {
    if (!event.updateTime) return true; // Ê≤°ÊúâÊõ¥Êñ∞Êó∂Èó¥ËßÜ‰∏∫ËøáÊó∂
    
    const updateTime = new Date(event.updateTime);
    const now = new Date();
    const hoursSinceUpdate = (now - updateTime) / (1000 * 60 * 60);
    
    // ËøõË°å‰∏≠ÁöÑËµõ‰∫ãÔºöÊõ¥Êñ∞Êó∂Èó¥‰∏çËÉΩË∂ÖËøá2Â∞èÊó∂ÔºàÈúÄË¶ÅÂÆûÊó∂Êõ¥Êñ∞Ôºâ
    if (event.status === 'ongoing' && hoursSinceUpdate > 2) {
      return true;
    }
    
    // ÂÖ∂‰ªñËµõ‰∫ãÔºöÊõ¥Êñ∞Êó∂Èó¥‰∏çËÉΩË∂ÖËøá24Â∞èÊó∂
    if (hoursSinceUpdate > 24) {
      return true;
    }
    
    return false;
  }
  
  // Ê∏≤ÊüìËµõ‰∫ãÂàóË°®
  function renderEventsList(tab = 'ongoing', region = 'local') {
    const container = document.getElementById('homeEventsList');
    if (!container) return;
    
    // Â¶ÇÊûúÊï∞ÊçÆ‰∏∫Á©∫Ôºå‰ΩøÁî®Á§∫‰æãÊï∞ÊçÆ
    if (!EVENTS_DATA || 
        (!EVENTS_DATA.ongoing?.length && !EVENTS_DATA.upcoming?.length && !EVENTS_DATA.results?.length)) {
      EVENTS_DATA = getSampleEventsData();
      saveEventsToStorage();
    }
    
    // ÂÖàÊåâÂú∞Âå∫Á≠õÈÄâ
    let events = (EVENTS_DATA[tab] || []).filter(event => event.region === region);
    
    // Â¶ÇÊûúÁ≠õÈÄâÂêé‰∏∫Á©∫ÔºåÂ∞ùËØïÊòæÁ§∫ÊâÄÊúâÂú∞Âå∫ÁöÑÁ§∫‰æãÊï∞ÊçÆ
    if (events.length === 0 && EVENTS_DATA[tab]?.length > 0) {
      events = EVENTS_DATA[tab];
    }
    
    // ËøáÊª§ÊéâÊó∂Èó¥‰∏çÂêªÂêàÁöÑËµõ‰∫ãÔºàÁ§∫‰æãÊï∞ÊçÆÈô§Â§ñÔºâ
    events = events.filter(event => {
      // Á§∫‰æãÊï∞ÊçÆÂßãÁªàÊòæÁ§∫
      if (event.id?.startsWith('sample_')) {
        return true;
      }
      return isValidEventTime(event, tab);
    });
    
    // ËøáÊª§ÊéâËøáÊó∂ÁöÑËµõ‰∫ãÔºàÁ§∫‰æãÊï∞ÊçÆÈô§Â§ñÔºâ
    events = events.filter(event => {
      // Á§∫‰æãÊï∞ÊçÆÂßãÁªàÊòæÁ§∫
      if (event.id?.startsWith('sample_')) {
        return true;
      }
      return !isEventOutdated(event);
    });
    
    // ÂØπ‰∫é"ËøõË°å‰∏≠"ÁöÑËµõ‰∫ãÔºåÈ¢ùÂ§ñÈ™åËØÅÔºöÁ°Æ‰øù‰∏çÊòØÂ∑≤ÁªìÊùüÁöÑËµõ‰∫ãÔºàÁ§∫‰æãÊï∞ÊçÆÈô§Â§ñÔºâ
    if (tab === 'ongoing') {
      events = events.filter(event => {
        // Á§∫‰æãÊï∞ÊçÆÂßãÁªàÊòæÁ§∫
        if (event.id?.startsWith('sample_')) {
          return true;
        }
        // Â¶ÇÊûúËµõ‰∫ãÊúâendTimeFull‰∏îÂ∑≤ÁªìÊùüÔºå‰∏çÂ∫îËØ•ÊòæÁ§∫Âú®"ËøõË°å‰∏≠"
        if (event.endTimeFull) {
          const endTime = new Date(event.endTimeFull);
          if (endTime <= new Date()) {
            return false; // Â∑≤ÁªìÊùüÁöÑËµõ‰∫ã‰∏çÂ∫îËØ•Âú®"ËøõË°å‰∏≠"
          }
        }
        return true;
      });
    }
    
    // ÊåâÊõ¥Êñ∞Êó∂Èó¥ÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÔºâ
    events.sort((a, b) => {
      const timeA = new Date(a.updateTime || 0);
      const timeB = new Date(b.updateTime || 0);
      return timeB - timeA;
    });
    
    if (events.length === 0) {
      // Â¶ÇÊûú‰ªçÁÑ∂‰∏∫Á©∫Ôºå‰ΩøÁî®Á§∫‰æãÊï∞ÊçÆ
      EVENTS_DATA = getSampleEventsData();
      saveEventsToStorage();
      events = EVENTS_DATA[tab] || [];
      events = events.filter(event => event.region === region);
      if (events.length === 0) {
        events = EVENTS_DATA[tab] || [];
      }
    }
    
    if (tab === 'ongoing') {
      container.innerHTML = events.map(event => {
        const updateTimeStr = formatUpdateTime(event.updateTime);
        return `
          <div class="event-card">
            <div class="event-card-status ongoing">
              <span>ËøõË°å‰∏≠</span>
            </div>
            <div class="event-card-title">${event.name || 'Êú™Áü•Ëµõ‰∫ã'}</div>
            <div class="event-card-info">
              <div class="event-card-info-item">
                <span>üè¢</span>
                <span>${event.organizer || 'Êú™Áü•ÁªÑÁªá'}</span>
              </div>
              <div class="event-card-info-item">
                <span>üìè</span>
                <span>${event.distance || 'Êú™Áü•Ë∑ùÁ¶ª'}</span>
              </div>
              <div class="event-card-info-item">
                <span>üïê</span>
                <span>ÊîæÈ£ûÔºö${event.releaseTime || 'Êú™Áü•Êó∂Èó¥'}</span>
              </div>
              <div class="event-card-info-item">
                <span>üå§Ô∏è</span>
                <span>${event.weather || 'Êú™Áü•Â§©Ê∞î'}</span>
              </div>
            </div>
            <div class="event-card-progress">
              <div class="event-progress-bar">
                <div class="event-progress-fill" style="width:${event.total && event.returned !== undefined ? ((event.returned / event.total * 100).toFixed(1)) : 0}%;"></div>
              </div>
              <div class="event-progress-text">Â∑≤ÂΩíÂ∑¢ ${event.returned !== undefined ? event.returned : 0} / ${event.total || 0} Âè™Ôºà${event.total && event.returned !== undefined ? ((event.returned / event.total * 100).toFixed(1)) : 0}%Ôºâ</div>
            </div>
            <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
              <span>üì∞ Êù•Ê∫êÔºö${event.source || 'Êú™Áü•'}</span>
              <span>üïê Êõ¥Êñ∞Ôºö${updateTimeStr}</span>
            </div>
            ${event.sourceUrl && event.sourceUrl !== '#' ? `
            <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
              <button class="btn btn-outline btn-sm" style="width:100%;" onclick="window.open('${event.sourceUrl}', '_blank')">
                üîó Êü•ÁúãÂéüËµõ‰∫ãÁΩëÈ°µ
              </button>
            </div>
            ` : ''}
          </div>
        `;
      }).join('');
    } else if (tab === 'upcoming') {
      container.innerHTML = events.map(event => {
        const updateTimeStr = formatUpdateTime(event.updateTime);
        return `
          <div class="event-card">
            <div class="event-card-status upcoming">Âç≥Â∞ÜÂºÄÂßã</div>
            <div class="event-card-title">${event.name || 'Êú™Áü•Ëµõ‰∫ã'}</div>
            <div class="event-card-info">
              <div class="event-card-info-item">
                <span>üè¢</span>
                <span>${event.organizer || 'Êú™Áü•ÁªÑÁªá'}</span>
              </div>
              <div class="event-card-info-item">
                <span>üìè</span>
                <span>${event.distance || 'Êú™Áü•Ë∑ùÁ¶ª'}</span>
              </div>
              <div class="event-card-info-item">
                <span>üïê</span>
                <span>ÂºÄÂßãÔºö${event.startTime || 'Êú™Áü•Êó∂Èó¥'}</span>
              </div>
              <div class="event-card-info-item">
                <span>üïäÔ∏è</span>
                <span>ÂèÇËµõÔºö${event.participants || 0}Âè™</span>
              </div>
            </div>
            <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
              <span>üì∞ Êù•Ê∫êÔºö${event.source || 'Êú™Áü•'}</span>
              <span>üïê Êõ¥Êñ∞Ôºö${updateTimeStr}</span>
            </div>
            ${event.sourceUrl && event.sourceUrl !== '#' ? `
            <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
              <button class="btn btn-outline btn-sm" style="width:100%;" onclick="window.open('${event.sourceUrl}', '_blank')">
                üîó Êü•ÁúãÂéüËµõ‰∫ãÁΩëÈ°µ
              </button>
            </div>
            ` : ''}
          </div>
        `;
      }).join('');
    } else if (tab === 'results') {
      container.innerHTML = events.map(event => {
        const updateTimeStr = formatUpdateTime(event.updateTime);
        return `
          <div class="event-card">
            <div class="event-card-status completed">Â∑≤ÁªìÊùü</div>
            <div class="event-card-title">${event.name || 'Êú™Áü•Ëµõ‰∫ã'}</div>
            <div class="event-card-info">
              <div class="event-card-info-item">
                <span>üè¢</span>
                <span>${event.organizer || 'Êú™Áü•ÁªÑÁªá'}</span>
              </div>
              <div class="event-card-info-item">
                <span>üìè</span>
                <span>${event.distance || 'Êú™Áü•Ë∑ùÁ¶ª'}</span>
              </div>
            </div>
            <div style="margin-top:12px;padding:12px;background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border-radius:8px;">
              <div style="font-size:12px;color:#92400e;margin-bottom:4px;">üèÜ ÂÜ†ÂÜõ</div>
              <div style="font-weight:700;color:#78350f;">${event.champion || 'ÊöÇÊó†Êï∞ÊçÆ'}</div>
              <div style="font-size:12px;color:#92400e;">${event.championRing || 'ÊöÇÊó†'} | Áî®Êó∂ ${event.championTime || 'ÊöÇÊó†'}</div>
            </div>
            <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:#9ca3af;">
              <span>üì∞ Êù•Ê∫êÔºö${event.source || 'Êú™Áü•'}</span>
              <span>üïê Êõ¥Êñ∞Ôºö${updateTimeStr}</span>
            </div>
            ${event.sourceUrl && event.sourceUrl !== '#' ? `
            <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
              <button class="btn btn-outline btn-sm" style="width:100%;" onclick="window.open('${event.sourceUrl}', '_blank')">
                üîó Êü•ÁúãÂéüËµõ‰∫ãÁΩëÈ°µ
              </button>
            </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
  }
  
  // Ê∏≤ÊüìÊô∫ËÉΩÊé®Ëçê
  function renderRecommendations() {
    const container = document.getElementById('homeRecommendations');
    if (!container) return;
    
    const recommendations = [];
    
    // Âü∫‰∫éË°ÄÁªüÊé®ËçêËµõ‰∫ã
    const corePigeons = pigeons.filter(p => p.isCore);
    if (corePigeons.length > 0) {
      recommendations.push({
        type: 'race',
        icon: 'üèÜ',
        iconClass: 'race',
        title: 'Êé®ËçêÂèÇËµõ',
        desc: `ÊÇ®Êúâ${corePigeons.length}Âè™Ê†∏ÂøÉÁßçÈ∏ΩÔºåÂª∫ËÆÆÂèÇÂä†Êò•Â≠£ÂÖ¨Ê£öËµõ`
      });
    }
    
    // Âü∫‰∫éÂÅ•Â∫∑ËÆ∞ÂΩïÊé®Ëçê
    const upcomingAlerts = getHealthAlerts().filter(a => a.type === 'warning');
    if (upcomingAlerts.length > 0) {
      recommendations.push({
        type: 'health',
        icon: 'üíâ',
        iconClass: 'pigeon',
        title: 'ÂÅ•Â∫∑ÊèêÈÜí',
        desc: `${upcomingAlerts.length}Âè™È∏ΩÂ≠êÂç≥Â∞ÜÈúÄË¶ÅÂÅ•Â∫∑Ê£ÄÊü•`
      });
    }
    
    // ÈÖçÂØπÊé®Ëçê
    const pairingRecs = getRecommendedPairings();
    if (pairingRecs.length > 0) {
      recommendations.push({
        type: 'breeding',
        icon: 'üíï',
        iconClass: 'breeding',
        title: 'ÈÖçÂØπÂª∫ËÆÆ',
        desc: `ÂèëÁé∞${pairingRecs.length}ÂØπÈ´òËØÑÂàÜÈÖçÂØπÁªÑÂêà`
      });
    }
    
    // ÈªòËÆ§Êé®Ëçê
    if (recommendations.length === 0) {
      recommendations.push(
        {
          type: 'race',
          icon: 'üèÅ',
          iconClass: 'race',
          title: 'ÂÖ≥Ê≥®Ëµõ‰∫ã',
          desc: '2025Êò•Â≠£ËµõÂ≠£Âç≥Â∞ÜÂºÄÂßã'
        },
        {
          type: 'breeding',
          icon: 'üìö',
          iconClass: 'pigeon',
          title: 'Â≠¶‰π†ËµÑÊñô',
          desc: 'Ë©πÊ£ÆË°ÄÁªüÈÖçÂØπÊäÄÂ∑ßÊåáÂçó'
        }
      );
    }
    
    container.innerHTML = recommendations.map(rec => `
      <div class="recommendation-item">
        <div class="recommendation-icon ${rec.iconClass}">${rec.icon}</div>
        <div class="recommendation-content">
          <div class="recommendation-title">${rec.title}</div>
          <div class="recommendation-desc">${rec.desc}</div>
        </div>
      </div>
    `).join('');
  }
  
  // Ê∏≤Êüì‰ªäÊó•ÊèêÈÜí
  function renderTodayAlerts() {
    const container = document.getElementById('homeTodayAlerts');
    if (!container) return;
    
    const alerts = [];
    
    // ÂÅ•Â∫∑ÊèêÈÜí
    const healthAlerts = getHealthAlerts();
    healthAlerts.slice(0, 2).forEach(alert => {
      alerts.push({
        type: alert.type,
        icon: alert.icon,
        text: `${alert.pigeon.name || alert.pigeon.ring} ${alert.message}`
      });
    });
    
    // ÊØîËµõÊèêÈÜíÔºàÊ®°ÊãüÔºâ
    if ((EVENTS_DATA.ongoing || []).length > 0) {
      alerts.push({
        type: 'info',
        icon: 'üèÅ',
        text: `${(EVENTS_DATA.ongoing || []).length}Âú∫ÊØîËµõÊ≠£Âú®ËøõË°å‰∏≠`
      });
    }
    
    // Êï∞ÊçÆÂºÇÂ∏∏ÊèêÈÜí
    const anomalies = detectAnomalies();
    if (anomalies.length > 0) {
      alerts.push({
        type: 'warning',
        icon: '‚ö†Ô∏è',
        text: `ÂèëÁé∞${anomalies.length}Êù°Êï∞ÊçÆÈúÄË¶ÅÊ£ÄÊü•`
      });
    }
    
    if (alerts.length === 0) {
      container.innerHTML = '<div style="padding:16px;text-align:center;color:#9ca3af;font-size:13px;">ÊöÇÊó†ÊèêÈÜíÔºå‰∏ÄÂàáÊ≠£Â∏∏ ‚úÖ</div>';
      return;
    }
    
    container.innerHTML = alerts.map(alert => `
      <div class="alert-item ${alert.type}">
        <span class="alert-item-icon">${alert.icon}</span>
        <span class="alert-item-text">${alert.text}</span>
      </div>
    `).join('');
  }
  
  // ÂàùÂßãÂåñÈ¶ñÈ°µ
  // Â≠òÂÇ®ÂΩìÂâçÂÖ¨ÂëäÊï∞ÊçÆ
  let currentAnnouncement = null;
  
  // Âä†ËΩΩ‰∏ªÈ°µÂÖ¨ÂëäÊ†è
  async function loadHomeAnnouncementBubble() {
    const bubbleEl = document.getElementById('homeAnnouncementBubbleText');
    const hintEl = document.getElementById('announcementHint');
    const bubbleContainer = document.getElementById('homeAnnouncementBubble');
    if (!bubbleEl) return;
    
    try {
      const apiConfig = getApiConfig();
      const apiUrl = apiConfig.apiUrl || 'http://localhost:3000/api';
      
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000);
      
      // ‰ªéÂÖ¨ÂÖ±APIËé∑ÂèñÂÖ¨ÂëäÔºà‰∏çÈúÄË¶ÅtokenÔºâ
      const response = await fetch(`${apiUrl}/announcements/public`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        },
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      
      if (!response.ok) {
        throw new Error('Ëé∑ÂèñÂÖ¨ÂëäÂ§±Ë¥•');
      }
      
      const result = await response.json();
      const announcements = result.data || [];
      
      // Ëé∑ÂèñÊúÄÊñ∞ÁöÑÂ∑≤ÂèëÂ∏ÉÂÖ¨Âëä
      const activeAnnouncements = announcements.filter(ann => ann.active);
      if (activeAnnouncements.length > 0) {
        // ÊåâÊõ¥Êñ∞Êó∂Èó¥ÊéíÂ∫èÔºåËé∑ÂèñÊúÄÊñ∞ÁöÑ
        activeAnnouncements.sort((a, b) => {
          const timeA = new Date(a.updatedAt || a.createdAt);
          const timeB = new Date(b.updatedAt || b.createdAt);
          return timeB - timeA;
        });
        
        const latestAnnouncement = activeAnnouncements[0];
        currentAnnouncement = latestAnnouncement;
        
        // ÊòæÁ§∫ÂÖ¨ÂëäÂÜÖÂÆπÔºåÂ∞ΩÈáèÂÆåÊï¥ÊòæÁ§∫
        const content = latestAnnouncement.content || 'ÊöÇÊó†ÂÖ¨Âëä';
        
        // Â¶ÇÊûúÂÜÖÂÆπËæÉÈïøÔºåÊòæÁ§∫ÊèêÁ§∫
        if (content.length > 50) {
          if (hintEl) hintEl.style.display = 'inline';
          // ÈôêÂà∂ÊòæÁ§∫ÈïøÂ∫¶Ôºå‰ΩÜÂ∞ΩÈáèÊòæÁ§∫Êõ¥Â§öÂÜÖÂÆπ
          const maxLength = 80;
          if (content.length > maxLength) {
            bubbleEl.textContent = content.substring(0, maxLength) + '...';
          } else {
            bubbleEl.textContent = content;
          }
        } else {
          bubbleEl.textContent = content;
          if (hintEl) hintEl.style.display = 'none';
        }
        
        // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
        if (bubbleContainer) {
          bubbleContainer.style.cursor = 'pointer';
          // Á°Æ‰øùÁÇπÂáª‰∫ã‰ª∂Ê≠£Á°ÆÁªëÂÆö
          bubbleContainer.onclick = function(e) {
            e.stopPropagation();
            if (currentAnnouncement) {
              showAnnouncementDetail();
            }
          };
        }
      } else {
        bubbleEl.textContent = 'ÊöÇÊó†ÂÖ¨Âëä';
        currentAnnouncement = null;
        if (hintEl) hintEl.style.display = 'none';
        if (bubbleContainer) {
          bubbleContainer.style.cursor = 'default';
        }
      }
    } catch (error) {
      console.error('Âä†ËΩΩÂÖ¨ÂëäÂ§±Ë¥•:', error);
      bubbleEl.textContent = 'ÊöÇÊó†ÂÖ¨Âëä';
      currentAnnouncement = null;
      if (hintEl) hintEl.style.display = 'none';
    }
  }
  
  // ÊòæÁ§∫ÂÖ¨ÂëäËØ¶ÊÉÖ
  window.showAnnouncementDetail = function() {
    if (!currentAnnouncement) {
      console.warn('Ê≤°ÊúâÂèØÊòæÁ§∫ÁöÑÂÖ¨Âëä');
      return;
    }
    
    const modal = document.getElementById('announcementModal');
    const contentEl = document.getElementById('announcementModalContent');
    const metaEl = document.getElementById('announcementModalMeta');
    
    if (!modal) {
      console.error('Êâæ‰∏çÂà∞ÂÖ¨ÂëäÊ®°ÊÄÅÊ°ÜÂÖÉÁ¥†');
      return;
    }
    
    if (!contentEl) {
      console.error('Êâæ‰∏çÂà∞ÂÖ¨ÂëäÂÜÖÂÆπÂÖÉÁ¥†');
      return;
    }
    
    // ÊòæÁ§∫ÂÆåÊï¥ÂÖ¨ÂëäÂÜÖÂÆπ
    contentEl.textContent = currentAnnouncement.content || 'ÊöÇÊó†ÂÜÖÂÆπ';
    
    // ÊòæÁ§∫ÂÖÉÊï∞ÊçÆ
    const createdAt = new Date(currentAnnouncement.createdAt).toLocaleString('zh-CN');
    const updatedAt = currentAnnouncement.updatedAt && currentAnnouncement.updatedAt !== currentAnnouncement.createdAt
      ? new Date(currentAnnouncement.updatedAt).toLocaleString('zh-CN')
      : null;
    
    if (metaEl) {
      metaEl.innerHTML = `
        <span>üìÖ ÂèëÂ∏ÉÊó∂Èó¥Ôºö${createdAt}</span>
        ${updatedAt ? `<span style="margin-left: 16px;">üîÑ Êõ¥Êñ∞Êó∂Èó¥Ôºö${updatedAt}</span>` : ''}
      `;
    }
    
    // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    modal.classList.add('active');
    document.body.style.overflow = 'hidden'; // Èò≤Ê≠¢ËÉåÊôØÊªöÂä®
  };
  
  // ÂÖ≥Èó≠ÂÖ¨ÂëäËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
  // Áî®Êà∑‰ø°ÊÅØÂíåËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÂáΩÊï∞
  // Âä†ËΩΩÁî®Êà∑ËÆæÁΩÆ
  function loadUserSettings() {
    try {
      const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
      return {
        avatar: settings.avatar || null,
        displayName: settings.displayName || null
      };
    } catch (e) {
      console.error('Âä†ËΩΩÁî®Êà∑ËÆæÁΩÆÂ§±Ë¥•:', e);
      return { avatar: null, displayName: null };
    }
  }
  
  // ‰øùÂ≠òÁî®Êà∑ËÆæÁΩÆ
  function saveUserSettings(settings) {
    try {
      localStorage.setItem('userSettings', JSON.stringify(settings));
      return true;
    } catch (e) {
      console.error('‰øùÂ≠òÁî®Êà∑ËÆæÁΩÆÂ§±Ë¥•:', e);
      return false;
    }
  }
  
  // Êõ¥Êñ∞È°∂ÈÉ®ÂØºËà™Ê†èÁöÑÁî®Êà∑ÊòæÁ§∫
  function updateTopBarUserDisplay() {
    const settings = loadUserSettings();
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
    const displayName = settings.displayName || userInfo.name || 'Ë¥¶Êà∑';
    
    // Êõ¥Êñ∞Ë¥¶Êà∑ÊåâÈíÆÊñáÊú¨
    const btnUserAvatar = document.getElementById('btnUserAvatar');
    if (btnUserAvatar) {
      const avatarSpan = btnUserAvatar.querySelector('span:first-child');
      const textSpan = btnUserAvatar.querySelector('span:last-child');
      
      if (settings.avatar) {
        // Â¶ÇÊûúÊúâËá™ÂÆö‰πâÂ§¥ÂÉèÔºåÊòæÁ§∫Â§¥ÂÉèÂõæÁâá
        if (!avatarSpan || (avatarSpan.tagName !== 'IMG' && (avatarSpan.textContent === 'üë®‚Äçüíº' || avatarSpan.textContent === 'üë§'))) {
          const img = document.createElement('img');
          img.src = settings.avatar;
          img.style.cssText = 'width:20px;height:20px;border-radius:50%;object-fit:cover;';
          if (avatarSpan) {
            avatarSpan.replaceWith(img);
          } else {
            btnUserAvatar.insertBefore(img, textSpan);
          }
        } else if (avatarSpan.tagName === 'IMG') {
          avatarSpan.src = settings.avatar;
        }
      } else {
        // Â¶ÇÊûúÊ≤°ÊúâËá™ÂÆö‰πâÂ§¥ÂÉèÔºåÊòæÁ§∫ÈªòËÆ§ÂõæÊ†á
        if (avatarSpan && avatarSpan.tagName === 'IMG') {
          const img = document.createElement('img');
          img.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2'%3E%3C/path%3E%3Ccircle cx='12' cy='7' r='4'%3E%3C/circle%3E%3C/svg%3E";
          img.alt = "Áî®Êà∑";
          img.style.cssText = 'width:20px;height:20px;object-fit:contain;';
          avatarSpan.replaceWith(img);
        } else if (!avatarSpan || (avatarSpan.tagName !== 'IMG' && (avatarSpan.textContent === 'üë®‚Äçüíº' || avatarSpan.textContent === 'üë§'))) {
          const img = document.createElement('img');
          img.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2'%3E%3C/path%3E%3Ccircle cx='12' cy='7' r='4'%3E%3C/circle%3E%3C/svg%3E";
          img.alt = "Áî®Êà∑";
          img.style.cssText = 'width:20px;height:20px;object-fit:contain;';
          if (avatarSpan) {
            avatarSpan.replaceWith(img);
          } else {
            btnUserAvatar.insertBefore(img, textSpan);
          }
        }
      }
      
      if (textSpan) {
        textSpan.textContent = displayName.length > 8 ? displayName.substring(0, 8) + '...' : displayName;
      }
    }
  }
  
  window.showUserInfoModal = function() {
    const modal = document.getElementById('userInfoModal');
    if (!modal) return;
    
    // ÂàáÊç¢Âà∞Êü•ÁúãÊ®°Âºè
    document.getElementById('userInfoViewMode').style.display = 'block';
    document.getElementById('userInfoEditMode').style.display = 'none';
    
    // Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØ
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
    const userSettings = loadUserSettings();
    const userName = userSettings.displayName || userInfo.name || 'Áî®Êà∑';
    const userEmail = userInfo.email || 'user@example.com';
    const userType = userInfo.type || 'ÊôÆÈÄöÁî®Êà∑';
    const registerDate = userInfo.registerDate || new Date().toISOString().split('T')[0];
    
    // Êõ¥Êñ∞ÊòæÁ§∫
    const avatarDisplay = document.getElementById('userAvatarDisplay');
    if (userSettings.avatar) {
      avatarDisplay.style.backgroundImage = `url(${userSettings.avatar})`;
      avatarDisplay.textContent = '';
    } else {
      avatarDisplay.style.backgroundImage = '';
      avatarDisplay.textContent = 'üë®‚Äçüíº';
    }
    
    document.getElementById('userNameDisplay').textContent = userName;
    document.getElementById('userEmailDisplay').textContent = userEmail;
    document.getElementById('userTypeDisplay').textContent = userType;
    document.getElementById('userRegisterDate').textContent = registerDate;
    
    // ËÆ°ÁÆóÊï∞ÊçÆÁªüËÆ°
    const pigeonCount = pigeons.filter(p => p.alive).length;
    document.getElementById('userDataStats').textContent = `${pigeonCount} Âè™È∏ΩÂ≠ê`;
    
    // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    modal.style.display = 'flex';
  };
  
  // ËøõÂÖ•ÁºñËæëÊ®°Âºè
  window.enterEditUserInfoMode = function() {
    document.getElementById('userInfoViewMode').style.display = 'none';
    document.getElementById('userInfoEditMode').style.display = 'block';
    
    // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
    const userSettings = loadUserSettings();
    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
    
    // ËÆæÁΩÆÂ§¥ÂÉèÊòæÁ§∫
    const avatarEditDisplay = document.getElementById('userAvatarEditDisplay');
    if (userSettings.avatar) {
      avatarEditDisplay.style.backgroundImage = `url(${userSettings.avatar})`;
      avatarEditDisplay.textContent = '';
    } else {
      avatarEditDisplay.style.backgroundImage = '';
      avatarEditDisplay.textContent = 'üë®‚Äçüíº';
    }
    
    // ËÆæÁΩÆÂêçÂ≠óËæìÂÖ•Ê°Ü
    document.getElementById('userNameInput').value = userSettings.displayName || userInfo.name || '';
    
    // ÁªëÂÆöÂ§¥ÂÉè‰∏ä‰º†‰∫ã‰ª∂
    const avatarInput = document.getElementById('userAvatarInput');
    if (avatarInput) {
      avatarInput.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂‰∏∫2MBÔºâ
          if (file.size > 2 * 1024 * 1024) {
            alert('Â§¥ÂÉèÊñá‰ª∂Â§ßÂ∞è‰∏çËÉΩË∂ÖËøá2MB');
            return;
          }
          
          // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
          if (!file.type.startsWith('image/')) {
            alert('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂');
            return;
          }
          
          // ËØªÂèñÊñá‰ª∂Âπ∂ËΩ¨Êç¢‰∏∫base64
          const reader = new FileReader();
          reader.onload = function(e) {
            const base64 = e.target.result;
            avatarEditDisplay.style.backgroundImage = `url(${base64})`;
            avatarEditDisplay.textContent = '';
          };
          reader.readAsDataURL(file);
        }
      };
    }
  };
  
  // ÂèñÊ∂àÁºñËæë
  window.cancelEditUserInfo = function() {
    document.getElementById('userInfoViewMode').style.display = 'block';
    document.getElementById('userInfoEditMode').style.display = 'none';
    showUserInfoModal(); // ÈáçÊñ∞Âä†ËΩΩÊòæÁ§∫
  };
  
  // ‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØ
  window.saveUserInfo = function() {
    const userNameInput = document.getElementById('userNameInput');
    const avatarInput = document.getElementById('userAvatarInput');
    const avatarEditDisplay = document.getElementById('userAvatarEditDisplay');
    
    const displayName = userNameInput.value.trim();
    if (!displayName) {
      alert('ËØ∑ËæìÂÖ•ÊòµÁß∞');
      return;
    }
    
    // Ëé∑ÂèñÂ§¥ÂÉèÔºàbase64Ôºâ
    let avatar = null;
    if (avatarEditDisplay.style.backgroundImage && avatarEditDisplay.style.backgroundImage !== 'none') {
      avatar = avatarEditDisplay.style.backgroundImage.replace('url("', '').replace('")', '').replace("url('", '').replace("')", '');
    }
    
    // ‰øùÂ≠òËÆæÁΩÆ
    const success = saveUserSettings({
      avatar: avatar,
      displayName: displayName
    });
    
    if (success) {
      // Êõ¥Êñ∞È°∂ÈÉ®ÂØºËà™Ê†è
      updateTopBarUserDisplay();
      
      // ÂàáÊç¢ÂõûÊü•ÁúãÊ®°ÂºèÂπ∂Âà∑Êñ∞
      cancelEditUserInfo();
      alert('‰øùÂ≠òÊàêÂäüÔºÅ');
    } else {
      alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
    }
  };
  
  window.closeUserInfoModal = function() {
    const modal = document.getElementById('userInfoModal');
    if (modal) {
      modal.style.display = 'none';
    }
  };

  // ==========================================
  // Áî®Êà∑ÁôªÂΩï/Ê≥®ÂÜåÂäüËÉΩ
  // ==========================================

  // ÊòæÁ§∫ÁôªÂΩïÊ®°ÊÄÅÊ°Ü
  window.showLoginModal = function() {
    const modal = document.getElementById('loginModal');
    if (modal) {
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      switchToLogin();
    }
  };

  // ÂÖ≥Èó≠ÁôªÂΩïÊ®°ÊÄÅÊ°Ü
  window.closeLoginModal = function() {
    const modal = document.getElementById('loginModal');
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = '';
      // Ê∏ÖÁ©∫Ë°®Âçï
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginPassword').value = '';
      document.getElementById('registerUsername').value = '';
      document.getElementById('registerEmail').value = '';
      document.getElementById('registerPassword').value = '';
      document.getElementById('loginError').style.display = 'none';
      document.getElementById('registerError').style.display = 'none';
    }
  };

  // ÂàáÊç¢Âà∞ÁôªÂΩïË°®Âçï
  function switchToLogin() {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('loginModalTitle').textContent = 'üîê';
    document.getElementById('loginModalTitleText').textContent = 'Áî®Êà∑ÁôªÂΩï';
  }

  // ÂàáÊç¢Âà∞Ê≥®ÂÜåË°®Âçï
  function switchToRegister() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
    document.getElementById('loginModalTitle').textContent = 'üìù';
    document.getElementById('loginModalTitleText').textContent = 'Áî®Êà∑Ê≥®ÂÜå';
  }

  // Â§ÑÁêÜÁôªÂΩï
  window.handleLogin = async function() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errorDiv = document.getElementById('loginError');

    if (!username || !password) {
      errorDiv.textContent = 'ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å';
      errorDiv.style.display = 'block';
      return;
    }

    try {
      const apiUrl = getBackendApiUrl();
      const response = await fetch(`${apiUrl}/auth/login`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ username, password })
      });

      const result = await response.json();

      if (result.success && result.data && result.data.token) {
        // ‰øùÂ≠òtoken
        setAuthToken(result.data.token);
        
        // ‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØ
        if (result.data.user) {
          localStorage.setItem('userInfo', JSON.stringify(result.data.user));
        }

        // ÂÖ≥Èó≠ÁôªÂΩïÊ®°ÊÄÅÊ°Ü
        closeLoginModal();

        // Êõ¥Êñ∞UI
        updateTopBarUserDisplay();

        // ‰ªé‰∫ëÁ´ØÂä†ËΩΩÊï∞ÊçÆ
        await loadFromStorage();

        // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
        alert('ÁôªÂΩïÊàêÂäüÔºÅÊï∞ÊçÆÂ∑≤ÂêåÊ≠•');

        // Âà∑Êñ∞È°µÈù¢Êï∞ÊçÆ
        if (typeof renderPigeonList === 'function') {
          renderPigeonList();
        }
      } else {
        errorDiv.textContent = result.error || 'ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å';
        errorDiv.style.display = 'block';
      }
    } catch (error) {
      console.error('ÁôªÂΩïÈîôËØØ:', error);
      errorDiv.textContent = 'ÁΩëÁªúÈîôËØØÔºåËØ∑Ê£ÄÊü•ÂêéÁ´ØÊúçÂä°ÊòØÂê¶ÂêØÂä®';
      errorDiv.style.display = 'block';
    }
  };

  // Â§ÑÁêÜÊ≥®ÂÜå
  window.handleRegister = async function() {
    const username = document.getElementById('registerUsername').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const password = document.getElementById('registerPassword').value;
    const errorDiv = document.getElementById('registerError');

    if (!username || !email || !password) {
      errorDiv.textContent = 'ËØ∑Â°´ÂÜôÊâÄÊúâÂøÖÂ°´È°π';
      errorDiv.style.display = 'block';
      return;
    }

    if (password.length < 6) {
      errorDiv.textContent = 'ÂØÜÁ†ÅÈïøÂ∫¶Ëá≥Â∞ë6‰Ωç';
      errorDiv.style.display = 'block';
      return;
    }

    try {
      const apiUrl = getBackendApiUrl();
      const response = await fetch(`${apiUrl}/auth/register`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ username, email, password })
      });

      const result = await response.json();

      if (result.success) {
        // Ê≥®ÂÜåÊàêÂäüÂêéËá™Âä®ÁôªÂΩï
        const loginResponse = await fetch(`${apiUrl}/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password })
        });

        const loginResult = await loginResponse.json();

        if (loginResult.success && loginResult.data && loginResult.data.token) {
          setAuthToken(loginResult.data.token);
          
          if (loginResult.data.user) {
            localStorage.setItem('userInfo', JSON.stringify(loginResult.data.user));
          }

          closeLoginModal();
          updateTopBarUserDisplay();

          // ÂêåÊ≠•Êú¨Âú∞Êï∞ÊçÆÂà∞‰∫ëÁ´Ø
          if (pigeons && pigeons.length > 0) {
            await saveToCloud('pigeons', pigeons);
          }

          alert('Ê≥®ÂÜåÊàêÂäüÔºÅÂ∑≤Ëá™Âä®ÁôªÂΩï');
        } else {
          errorDiv.textContent = 'Ê≥®ÂÜåÊàêÂäüÔºå‰ΩÜËá™Âä®ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑ÊâãÂä®ÁôªÂΩï';
          errorDiv.style.display = 'block';
        }
      } else {
        errorDiv.textContent = result.error || 'Ê≥®ÂÜåÂ§±Ë¥•';
        errorDiv.style.display = 'block';
      }
    } catch (error) {
      console.error('Ê≥®ÂÜåÈîôËØØ:', error);
      errorDiv.textContent = 'ÁΩëÁªúÈîôËØØÔºåËØ∑Ê£ÄÊü•ÂêéÁ´ØÊúçÂä°ÊòØÂê¶ÂêØÂä®';
      errorDiv.style.display = 'block';
    }
  };

  // Áî®Êà∑ÁôªÂá∫
  window.handleLogout = function() {
    if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü')) {
      setAuthToken(null);
      localStorage.removeItem('userInfo');
      updateTopBarUserDisplay();
      alert('Â∑≤ÈÄÄÂá∫ÁôªÂΩï');
    }
  };

  // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÔºàÈ°µÈù¢Âä†ËΩΩÊó∂Ë∞ÉÁî®Ôºâ
  async function checkLoginStatus() {
    const token = getAuthToken();
    if (!token) {
      return;
    }

    try {
      const apiUrl = getBackendApiUrl();
      const response = await fetch(`${apiUrl}/auth/me`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      const result = await response.json();

      if (result.success && result.data) {
        // tokenÊúâÊïàÔºåÊõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØ
        localStorage.setItem('userInfo', JSON.stringify(result.data));
        // ‰ªé‰∫ëÁ´ØÂä†ËΩΩÊï∞ÊçÆ
        await loadFromStorage();
        console.log('‚úÖ Ëá™Âä®ÁôªÂΩïÊàêÂäüÔºåÊï∞ÊçÆÂ∑≤ÂêåÊ≠•');
      } else {
        // tokenÊó†ÊïàÔºåÊ∏ÖÈô§
        setAuthToken(null);
        localStorage.removeItem('userInfo');
        console.log('‚ö†Ô∏è TokenÂ∑≤Â§±ÊïàÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
      }
    } catch (error) {
      console.warn('Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÂ§±Ë¥•:', error);
      // ÁΩëÁªúÈîôËØØ‰∏çÂΩ±Âìç‰ΩøÁî®Ôºå‰øùÁïôtoken
    }
  }

  // Êõ¥Êñ∞È°∂ÈÉ®ÂØºËà™Ê†èÁî®Êà∑ÊòæÁ§∫ÔºàË¶ÜÁõñÂéüÊúâÂáΩÊï∞Ôºâ
  const originalUpdateTopBarUserDisplay = window.updateTopBarUserDisplay;
  window.updateTopBarUserDisplay = function() {
    const btnUserAvatar = document.getElementById('btnUserAvatar');
    if (!btnUserAvatar) {
      if (originalUpdateTopBarUserDisplay) {
        originalUpdateTopBarUserDisplay();
      }
      return;
    }

    if (isUserLoggedIn()) {
      const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
      const displayName = userInfo.username || 'Ë¥¶Êà∑';
      btnUserAvatar.innerHTML = `<img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2'%3E%3C/path%3E%3Ccircle cx='12' cy='7' r='4'%3E%3C/circle%3E%3C/svg%3E" alt="Áî®Êà∑" style="width:20px;height:20px;object-fit:contain;" /><span>${displayName}</span>`;
      btnUserAvatar.onclick = () => showUserInfoModal();
    } else {
      btnUserAvatar.innerHTML = `<img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='11' width='18' height='11' rx='2' ry='2'%3E%3C/rect%3E%3Cpath d='M7 11V7a5 5 0 0 1 10 0v4'%3E%3C/path%3E%3C/svg%3E" alt="ÁôªÂΩï" style="width:20px;height:20px;object-fit:contain;" /><span>ÁôªÂΩï</span>`;
      btnUserAvatar.onclick = () => showLoginModal();
    }
    
    if (originalUpdateTopBarUserDisplay) {
      originalUpdateTopBarUserDisplay();
    }
  };
  
  window.showSettingsModal = function() {
    const modal = document.getElementById('settingsModal');
    if (!modal) return;
    modal.style.display = 'flex';
  };
  
  window.closeSettingsModal = function() {
    const modal = document.getElementById('settingsModal');
    if (modal) {
      modal.style.display = 'none';
    }
  };
  
  // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠
  document.addEventListener('DOMContentLoaded', function() {
    const userInfoModal = document.getElementById('userInfoModal');
    const settingsModal = document.getElementById('settingsModal');
    
    if (userInfoModal) {
      userInfoModal.addEventListener('click', function(e) {
        if (e.target === userInfoModal) {
          closeUserInfoModal();
        }
      });
    }
    
    if (settingsModal) {
      settingsModal.addEventListener('click', function(e) {
        if (e.target === settingsModal) {
          closeSettingsModal();
        }
      });
    }
    
    // ÁªëÂÆöÁî®Êà∑Â§¥ÂÉèÊåâÈíÆÔºàÊ†πÊçÆÁôªÂΩïÁä∂ÊÄÅÔºâ
    const btnUserAvatar = document.getElementById('btnUserAvatar');
    if (btnUserAvatar) {
      btnUserAvatar.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (isUserLoggedIn()) {
          showUserInfoModal();
        } else {
          showLoginModal();
        }
      });
    }
    
    // ÁªëÂÆöÁôªÂΩïÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠
    const loginModal = document.getElementById('loginModal');
    if (loginModal) {
      loginModal.addEventListener('click', function(e) {
        if (e.target === loginModal) {
          closeLoginModal();
        }
      });
    }
    
    // È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÂπ∂Êõ¥Êñ∞UI
    checkLoginStatus();
    updateTopBarUserDisplay();
    
    // ÁªëÂÆöËÆæÁΩÆÊåâÈíÆ
    const btnSettings = document.getElementById('btnSettings');
    if (btnSettings) {
      btnSettings.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        showSettingsModal();
      });
    }
    
    // ÁªëÂÆöËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÂÜÖÁöÑÊåâÈíÆ
    const btnToggleThemeInModal = document.getElementById('btnToggleThemeInModal');
    if (btnToggleThemeInModal) {
      btnToggleThemeInModal.addEventListener('click', function() {
        const btnToggleTheme = document.getElementById('btnToggleTheme');
        if (btnToggleTheme) {
          btnToggleTheme.click();
        }
      });
    }
    
    const btnBackupDataInModal = document.getElementById('btnBackupDataInModal');
    if (btnBackupDataInModal) {
      btnBackupDataInModal.addEventListener('click', function() {
        const btnBackupData = document.getElementById('btnBackupData');
        if (btnBackupData) {
          btnBackupData.click();
        }
      });
    }
    
    // ÊÑèËßÅ‰∏éÂèçÈ¶àÂºπÁ™óÁõ∏ÂÖ≥‰∫ã‰ª∂
    const feedbackOpenButtons = document.querySelectorAll('[data-open-feedback]');
    const feedbackModal = document.getElementById('feedbackModal');
    const feedbackModalClose = document.getElementById('feedbackModalClose');
    const feedbackModalCancel = document.getElementById('feedbackModalCancel');
    const feedbackModalSubmit = document.getElementById('feedbackModalSubmit');

    function openFeedbackModal() {
      if (feedbackModal) {
        feedbackModal.style.display = 'flex';
      }
    }

    function closeFeedbackModal() {
      if (feedbackModal) {
        feedbackModal.style.display = 'none';
      }
    }

    feedbackOpenButtons.forEach((btn) => {
      btn.addEventListener('click', function(e) {
        if (e && typeof e.preventDefault === 'function') e.preventDefault();
        if (e && typeof e.stopPropagation === 'function') e.stopPropagation();
        openFeedbackModal();
      });
    });

    if (feedbackModalClose) {
      feedbackModalClose.addEventListener('click', function() {
        closeFeedbackModal();
      });
    }

    if (feedbackModalCancel) {
      feedbackModalCancel.addEventListener('click', function() {
        closeFeedbackModal();
      });
    }

    if (feedbackModal) {
      feedbackModal.addEventListener('click', function(e) {
        if (e.target === feedbackModal) {
          closeFeedbackModal();
        }
      });
    }

    if (feedbackModalSubmit) {
      feedbackModalSubmit.addEventListener('click', async function() {
        const contentEl = document.getElementById('feedbackContent');
        const contactEl = document.getElementById('feedbackContact');
        const content = contentEl ? contentEl.value.trim() : '';
        const contact = contactEl ? contactEl.value.trim() : '';

        if (!content) {
          alert('ËØ∑ÂÖàÂ°´ÂÜôÊÇ®ÁöÑÊÑèËßÅÊàñÈóÆÈ¢òÂÜÖÂÆπ');
          return;
        }

        feedbackModalSubmit.disabled = true;
        feedbackModalSubmit.textContent = 'Êèê‰∫§‰∏≠...';

        try {
          await submitUserFeedback({
            content,
            contact,
            page: 'index.html',
            source: 'web'
          });
          if (contentEl) contentEl.value = '';
          if (contactEl) contactEl.value = '';
          alert('ÂèçÈ¶àÂ∑≤Êèê‰∫§ÔºåÊÑüË∞¢ÊÇ®ÁöÑÂÆùË¥µÊÑèËßÅÔºÅ');
          closeFeedbackModal();
        } catch (error) {
          alert('Êèê‰∫§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØïÔºö' + (error.message || 'Êú™Áü•ÈîôËØØ'));
        } finally {
          feedbackModalSubmit.disabled = false;
          feedbackModalSubmit.textContent = 'Êèê‰∫§ÂèçÈ¶à';
        }
      });
    }
    
    const btnExportDataInModal = document.getElementById('btnExportDataInModal');
    if (btnExportDataInModal) {
      btnExportDataInModal.addEventListener('click', function() {
        const btnExportData = document.getElementById('btnExportData');
        if (btnExportData) {
          btnExportData.click();
        }
      });
    }
    
    const btnImportDataInModal = document.getElementById('btnImportDataInModal');
    if (btnImportDataInModal) {
      btnImportDataInModal.addEventListener('click', function() {
        const excelFileInput = document.getElementById('excelFileInput');
        if (excelFileInput) {
          excelFileInput.click();
        } else {
          alert('ÂØºÂÖ•ÂäüËÉΩÈúÄË¶ÅÂÖàÈÖçÁΩÆÊï∞ÊçÆÂØºÂÖ•ÂäüËÉΩ');
        }
      });
    }
  });
  
  window.closeAnnouncementModal = function() {
    const modal = document.getElementById('announcementModal');
    if (modal) {
      modal.classList.remove('active');
      document.body.style.overflow = ''; // ÊÅ¢Â§çËÉåÊôØÊªöÂä®
    }
  };
  
  // ESCÈîÆÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeAnnouncementModal();
      closeUserInfoModal();
      closeSettingsModal();
    }
  });
  
  // ÂàùÂßãÂåñÁî®Êà∑‰ø°ÊÅØÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
  function initUserInfo() {
    const userInfo = localStorage.getItem('userInfo');
    if (!userInfo) {
      const defaultUserInfo = {
        name: 'Áî®Êà∑',
        email: 'user@example.com',
        type: 'ÊôÆÈÄöÁî®Êà∑',
        registerDate: new Date().toISOString().split('T')[0]
      };
      localStorage.setItem('userInfo', JSON.stringify(defaultUserInfo));
    }
  }
  
  // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñÁî®Êà∑‰ø°ÊÅØ
  initUserInfo();
  
  // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠
  document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('announcementModal');
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeAnnouncementModal();
        }
      });
    }
  });
  
  function initHomePage() {
    // ÂàùÂßãÂåñAPIÈÖçÁΩÆÔºàÂ¶ÇÊûúÊú™ÈÖçÁΩÆÔºå‰ΩøÁî®ÈªòËÆ§ÂÄºÔºâ
    initApiConfig();
    
    // ÊµãËØïAPIËøûÊé•
    testApiConnection();
    
    updateHomeDate();
    updateHomeStats();
    // Âä†ËΩΩ‰∏ªÈ°µÂÖ¨ÂëäÊ†è
    loadHomeAnnouncementBubble();
    // Ê£ÄÊü•Âπ∂Êõ¥Êñ∞ËµÑËÆØ
    checkAndUpdateNews();
    // Ê£ÄÊü•Âπ∂Êõ¥Êñ∞Ëµõ‰∫ã
    checkAndUpdateEvents();
    renderRecommendations();
    renderTodayAlerts();
    
    // ËÆæÁΩÆÊØèÂ§©Ëá™Âä®Êõ¥Êñ∞ËµÑËÆØÔºàÊØèÂ§©ÂáåÊô®2ÁÇπÔºâ
    setupDailyNewsUpdate();
    // ËÆæÁΩÆÊØèÂ§©Ëá™Âä®Êõ¥Êñ∞Ëµõ‰∫ãÔºàÊØèÂ§©ÂáåÊô®2ÁÇπÔºåÂ§áÁî®Ôºâ
    setupDailyEventsUpdate();
    // ËÆæÁΩÆÂÆûÊó∂Ëµõ‰∫ãÊõ¥Êñ∞ÔºàÊØè5ÂàÜÈíüÊõ¥Êñ∞ËøõË°å‰∏≠ÁöÑËµõ‰∫ãÔºâ
    setupRealTimeEventUpdate();
  }
  
  // ÂàùÂßãÂåñAPIÈÖçÁΩÆÔºàÂ¶ÇÊûúÊú™ÈÖçÁΩÆÔºå‰ΩøÁî®ÈªòËÆ§ÂÄºÔºâ
  function initApiConfig() {
    const config = localStorage.getItem('pigeon_api_config');
    if (!config) {
      // È¶ñÊ¨°‰ΩøÁî®ÔºåËÆæÁΩÆÈªòËÆ§APIÂú∞ÂùÄ
      const defaultConfig = getApiConfig();
      saveApiConfig(defaultConfig);
      console.log('‚úÖ Â∑≤ËÆæÁΩÆÈªòËÆ§APIÈÖçÁΩÆ:', defaultConfig);
    } else {
      const savedConfig = JSON.parse(config);
      console.log('‚úÖ ‰ΩøÁî®Â∑≤‰øùÂ≠òÁöÑAPIÈÖçÁΩÆ:', savedConfig);
    }
  }
  
  // ÊµãËØïAPIËøûÊé•
  async function testApiConnection() {
    const apiConfig = getApiConfig();
    
    // ÊµãËØïËµÑËÆØAPI
    if (apiConfig.newsApiUrl) {
      try {
        const response = await fetch(apiConfig.newsApiUrl, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        if (response.ok) {
          const result = await response.json();
          console.log('‚úÖ ËµÑËÆØAPIËøûÊé•ÊàêÂäü:', apiConfig.newsApiUrl);
          console.log('   ËøîÂõûÊï∞ÊçÆ:', result.success ? `${result.count || result.data?.length || 0} Êù°ËµÑËÆØ` : 'Ê†ºÂºèÈîôËØØ');
        } else {
          console.warn('‚ö†Ô∏è ËµÑËÆØAPIËøûÊé•Â§±Ë¥•:', response.status, response.statusText);
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è ËµÑËÆØAPIËøûÊé•ÈîôËØØ:', error.message);
        console.log('   ÊèêÁ§∫: ËØ∑Á°Æ‰øùÂêéÁ´ØÊúçÂä°Â∑≤ÂêØÂä® (http://localhost:3000)');
      }
    }
    
    // ÊµãËØïËµõ‰∫ãAPI
    if (apiConfig.eventsApiUrl) {
      try {
        const response = await fetch(apiConfig.eventsApiUrl, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        if (response.ok) {
          const result = await response.json();
          console.log('‚úÖ Ëµõ‰∫ãAPIËøûÊé•ÊàêÂäü:', apiConfig.eventsApiUrl);
          if (result.success && result.data) {
            const events = result.data;
            console.log('   ËøîÂõûÊï∞ÊçÆ:', {
              ongoing: events.ongoing?.length || 0,
              upcoming: events.upcoming?.length || 0,
              results: events.results?.length || 0
            });
          }
        } else {
          console.warn('‚ö†Ô∏è Ëµõ‰∫ãAPIËøûÊé•Â§±Ë¥•:', response.status, response.statusText);
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Ëµõ‰∫ãAPIËøûÊé•ÈîôËØØ:', error.message);
        console.log('   ÊèêÁ§∫: ËØ∑Á°Æ‰øùÂêéÁ´ØÊúçÂä°Â∑≤ÂêØÂä® (http://localhost:3000)');
      }
    }
  }
  
  // ËÆæÁΩÆÊØèÂ§©Ëá™Âä®Êõ¥Êñ∞ËµÑËÆØ
  function setupDailyNewsUpdate() {
    // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
    if (window.newsUpdateInterval) {
      clearInterval(window.newsUpdateInterval);
    }
    
    // ËÆ°ÁÆóÂà∞ÊòéÂ§©ÂáåÊô®2ÁÇπÁöÑÊó∂Èó¥
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(2, 0, 0, 0);
    
    const msUntilUpdate = tomorrow - now;
    
    // ËÆæÁΩÆÂÆöÊó∂Âô®
    setTimeout(() => {
      updateNews();
      // ‰πãÂêéÊØè24Â∞èÊó∂Êõ¥Êñ∞‰∏ÄÊ¨°
      window.newsUpdateInterval = setInterval(() => {
        updateNews();
      }, 24 * 60 * 60 * 1000);
    }, msUntilUpdate);
    
    console.log('ËµÑËÆØËá™Âä®Êõ¥Êñ∞Â∑≤ËÆæÁΩÆÔºåÂ∞ÜÂú®ÊØèÂ§©ÂáåÊô®2ÁÇπËá™Âä®Êõ¥Êñ∞');
  }
  
  // ËÆæÁΩÆÊØèÂ§©Ëá™Âä®Êõ¥Êñ∞Ëµõ‰∫ãÔºà‰Ωú‰∏∫Â§áÁî®Ôºå‰∏ªË¶Å‰æùÈù†ÂÆûÊó∂Êõ¥Êñ∞Ôºâ
  function setupDailyEventsUpdate() {
    // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
    if (window.eventsUpdateInterval) {
      clearInterval(window.eventsUpdateInterval);
    }
    
    // ËÆ°ÁÆóÂà∞ÊòéÂ§©ÂáåÊô®2ÁÇπÁöÑÊó∂Èó¥
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(2, 0, 0, 0);
    
    const msUntilUpdate = tomorrow - now;
    
    // ËÆæÁΩÆÂÆöÊó∂Âô®
    setTimeout(() => {
      updateEvents();
      // ‰πãÂêéÊØè24Â∞èÊó∂Êõ¥Êñ∞‰∏ÄÊ¨°Ôºà‰Ωú‰∏∫Â§áÁî®Ôºâ
      window.eventsUpdateInterval = setInterval(() => {
        updateEvents();
      }, 24 * 60 * 60 * 1000);
    }, msUntilUpdate);
    
    console.log('Ëµõ‰∫ãËá™Âä®Êõ¥Êñ∞Â∑≤ËÆæÁΩÆÔºåÂ∞ÜÂú®ÊØèÂ§©ÂáåÊô®2ÁÇπËá™Âä®Êõ¥Êñ∞ÔºàÂ§áÁî®Ôºâ');
  }
  
  // È¶ñÈ°µ‰∫ã‰ª∂ÁªëÂÆö
  // ËµÑËÆØÁ≠õÈÄâ
  document.querySelectorAll('.news-filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.news-filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentNewsFilter = btn.dataset.filter;
      renderNewsList(currentNewsFilter, currentNewsRegion);
    });
  });
  
  // Êú¨Âú∞/ÂÖ®ÂõΩËµÑËÆØÊ†áÁ≠æÈ°µÂàáÊç¢
  document.querySelectorAll('.news-region-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.news-region-tab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentNewsRegion = btn.dataset.region;
      renderNewsList(currentNewsFilter, currentNewsRegion);
    });
  });
  
  // Âà∑Êñ∞ËµÑËÆØÊåâÈíÆ
  document.getElementById('btnRefreshNews')?.addEventListener('click', () => {
    updateNews();
    alert('Ê≠£Âú®Âà∑Êñ∞ËµÑËÆØÔºåËØ∑Á®çÂÄô...');
  });
  
  // ËµÑËÆØËØ¶ÊÉÖÂºπÁ™óÂÖ≥Èó≠‰∫ã‰ª∂
  document.getElementById('newsModalClose')?.addEventListener('click', closeNewsModal);
  document.getElementById('newsModalCloseBtn')?.addEventListener('click', closeNewsModal);
  document.getElementById('newsModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'newsModal') {
      closeNewsModal();
    }
  });
  
  // Ëµõ‰∫ãÂú∞Âå∫Ê†áÁ≠æÈ°µÂàáÊç¢
  document.querySelectorAll('.event-region-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.event-region-tab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentEventRegion = btn.dataset.region;
      renderEventsList(currentEventTab, currentEventRegion);
    });
  });
  
  // Ëµõ‰∫ãÊ†áÁ≠æÈ°µ
  document.querySelectorAll('.event-tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.event-tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentEventTab = btn.dataset.tab;
      renderEventsList(currentEventTab, currentEventRegion);
    });
  });
  
  // Âà∑Êñ∞Ëµõ‰∫ã
  document.getElementById('btnRefreshEvents')?.addEventListener('click', () => {
    updateEvents();
    alert('Ê≠£Âú®Âà∑Êñ∞Ëµõ‰∫ãÊï∞ÊçÆÔºåËØ∑Á®çÂÄô...');
  });
  
  // ÂÖ≥Èó≠ÂÖ¨Âëä
  document.getElementById('btnCloseAnnouncement')?.addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('homeAnnouncement').style.display = 'none';
  });
  
  // ÈáçË¶ÅÂÖ¨ÂëäÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ
  const homeAnnouncementEl = document.getElementById('homeAnnouncement');
  if (homeAnnouncementEl) {
    homeAnnouncementEl.addEventListener('click', function(e) {
      // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂÖ≥Èó≠ÊåâÈíÆÔºå‰∏çËß¶ÂèëÊü•ÁúãËØ¶ÊÉÖ
      if (e.target.id === 'btnCloseAnnouncement' || e.target.closest('#btnCloseAnnouncement')) {
        return;
      }
      if (currentAnnouncement) {
        showAnnouncementDetail();
      }
    });
  }
  
  // Âø´Êç∑ÂÖ•Âè£ÊåâÈíÆ‰∫ã‰ª∂ÁªëÂÆö
  function bindQuickLinkButtons() {
    const quickLinkButtons = document.querySelectorAll('.quick-link-btn');
    console.log('ÊâæÂà∞Âø´Êç∑ÂÖ•Âè£ÊåâÈíÆÊï∞Èáè:', quickLinkButtons.length);
    
    quickLinkButtons.forEach(btn => {
      // ÁßªÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÊóß‰∫ã‰ª∂ÁõëÂê¨Âô®
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      
      newBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const action = newBtn.dataset.action;
        console.log('Âø´Êç∑ÂÖ•Âè£ÊåâÈíÆÁÇπÂáª:', action);
        
        if (typeof switchView === 'function') {
          switch (action) {
            case 'addPigeon':
              switchView('createView');
              break;
            case 'addRace':
              switchView('raceView');
              break;
            case 'breeding':
              switchView('breedingView');
              break;
            case 'analysis':
              switchView('analysisView');
              break;
            default:
              console.warn('Êú™Áü•ÁöÑÂø´Êç∑ÂÖ•Âè£Âä®‰Ωú:', action);
          }
        } else {
          console.error('switchView ÂáΩÊï∞Êú™ÂÆö‰πâ');
        }
      });
    });
    
    console.log('Âø´Êç∑ÂÖ•Âè£ÊåâÈíÆ‰∫ã‰ª∂ÁªëÂÆöÂÆåÊàê');
  }
  
  // Âª∂ËøüÁªëÂÆöÂø´Êç∑ÂÖ•Âè£ÊåâÈíÆ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bindQuickLinkButtons);
  } else {
    bindQuickLinkButtons();
  }
  
  setTimeout(bindQuickLinkButtons, 500);
  setTimeout(bindQuickLinkButtons, 1000);
  
  // Ê∑ªÂä†ËÆ¢ÈòÖ
  document.getElementById('btnAddSubscription')?.addEventListener('click', () => {
    const tag = prompt('ËØ∑ËæìÂÖ•Ë¶ÅÂÖ≥Ê≥®ÁöÑÊ†áÁ≠æÔºàÂ¶ÇÔºöÂú∞Âå∫„ÄÅËµõ‰∫ãÁ±ªÂûãÁ≠âÔºâÔºö');
    if (tag && tag.trim()) {
      const tagsContainer = document.querySelector('.subscription-tags');
      const addBtn = document.getElementById('btnAddSubscription');
      const newTag = document.createElement('span');
      newTag.className = 'subscription-tag';
      newTag.textContent = tag.trim();
      tagsContainer.insertBefore(newTag, addBtn);
    }
  });
  
  // Êâ©Â±ïËßÜÂõæÂØπË±°ÔºåÊ∑ªÂä†È¶ñÈ°µ
  views.homeView = document.getElementById('homeView');
  
  // Áªü‰∏ÄÂπ∂Â¢ûÂº∫ switchView ÂáΩÊï∞ÔºàÊúÄÁªàÂÆåÊï¥ÁâàÊú¨Ôºâ
  const originalSwitchView = switchView;
  switchView = function(name) {
    console.log('ÂàáÊç¢ËßÜÂõæ:', name);
    
    // Â¶ÇÊûúÂΩìÂâçÂú®ÁºñËæëÊ®°Âºè‰∏îË¶ÅÂàáÊç¢Âà∞ÂÖ∂‰ªñËßÜÂõæÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥Êîπ
    const detailView = document.getElementById('detailView');
    if (detailView && detailView.style.display !== 'none') {
      const editMode = document.getElementById('editMode');
      if (editMode && editMode.style.display !== 'none') {
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥Êîπ
        if (typeof hasUnsavedChanges === 'function' && hasUnsavedChanges()) {
          if (!confirm('ÊÇ®ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥ÊîπÔºåÁ°ÆÂÆöË¶ÅÁ¶ªÂºÄÁºñËæëÈ°µÈù¢ÂêóÔºü\n\nÂ¶ÇÊûúÁ¶ªÂºÄÔºåÊâÄÊúâÊú™‰øùÂ≠òÁöÑÊõ¥ÊîπÂ∞Ü‰ºö‰∏¢Â§±„ÄÇ')) {
            return; // Áî®Êà∑ÂèñÊ∂àÂàáÊç¢
          }
          // Áî®Êà∑Á°ÆËÆ§Á¶ªÂºÄÔºåÈÄÄÂá∫ÁºñËæëÊ®°Âºè
          if (typeof setEditMode === 'function') {
            setEditMode(false);
          }
        }
      }
    }
    
    // ÂÖàÈöêËóèÊâÄÊúâËßÜÂõæ
    Object.keys(views).forEach(k => {
      if (views[k]) {
        if (k === name) {
          views[k].style.display = '';
          console.log('ÊòæÁ§∫ËßÜÂõæ:', k);
        } else {
          views[k].style.display = 'none';
        }
      } else {
        console.warn('ËßÜÂõæÂÖÉÁ¥†‰∏çÂ≠òÂú®:', k);
      }
    });
    
    // Êõ¥Êñ∞‰æßËæπÊ†èÔºàÁ°Æ‰øùÈáçÊñ∞Êü•ËØ¢ÔºåÂõ†‰∏∫ÂèØËÉΩÂú®Êüê‰∫õÊó∂ÂÄôÂ§±ÊïàÔºâ
    const currentSidebarItems = document.querySelectorAll('.sidebar-item');
    currentSidebarItems.forEach(item => {
      if (item.dataset.view === name) {
        item.classList.add('active');
      } else {
        item.classList.remove('active');
      }
    });
    
    // Êõ¥Êñ∞ÂØºËà™ÊåâÈíÆ
    const currentNavButtons = document.querySelectorAll('header nav button');
    currentNavButtons.forEach(btn => {
      if (btn.dataset.view === name) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
    
    // Ê†πÊçÆËßÜÂõæÊâßË°åÁâπÂÆöÊìç‰Ωú
    switch(name) {
      case 'homeView':
        if (typeof initHomePage === 'function') {
          initHomePage();
        } else if (typeof refreshHomeView === 'function') {
          refreshHomeView();
        }
        break;
      case 'dashboardView':
        if (typeof refreshDashboard === 'function') {
          refreshDashboard();
        }
        break;
      case 'listView':
        if (typeof refreshList === 'function') {
          refreshList();
        }
        break;
      case 'pedigreeView':
        if (typeof refreshPedigreeView === 'function') {
          refreshPedigreeView();
        }
        break;
      case 'statsView':
        if (typeof renderStatsViewTable === 'function') {
          renderStatsViewTable();
        }
        break;
      case 'raceView':
        if (typeof loadRaces === 'function') {
          loadRaces();
        }
        if (typeof syncRacesToPigeons === 'function') {
          syncRacesToPigeons();
        }
        if (typeof renderRaceList === 'function') {
          renderRaceList();
        }
        if (typeof fillStatsPigeonSelect === 'function') {
          fillStatsPigeonSelect();
        }
        if (typeof generateOverallAnalysis === 'function') {
          generateOverallAnalysis();
        }
        break;
      case 'breedingView':
        if (typeof loadPairings === 'function') {
          loadPairings();
        }
        if (typeof fillBreedingSelects === 'function') {
          fillBreedingSelects();
        }
        if (typeof renderPairingHistory === 'function') {
          renderPairingHistory();
        }
        if (typeof updateBreedingAssessment === 'function') {
          updateBreedingAssessment();
        }
        break;
      case 'healthView':
        if (typeof loadHealthRecords === 'function') {
          loadHealthRecords();
        }
        if (typeof fillHealthPigeonSelects === 'function') {
          fillHealthPigeonSelects();
        }
        if (typeof renderHealthOverview === 'function') {
          renderHealthOverview();
        }
        if (typeof renderHealthAlerts === 'function') {
          renderHealthAlerts();
        }
        break;
      case 'analysisView':
        if (typeof loadPairings === 'function') {
          loadPairings();
        }
        if (typeof loadHealthRecords === 'function') {
          loadHealthRecords();
        }
        if (typeof runFullAnalysis === 'function') {
          runFullAnalysis();
        }
        break;
      case 'trainingView':
        if (typeof loadTrainingRecords === 'function') {
          loadTrainingRecords();
        }
        if (typeof renderTrainingTable === 'function') {
          renderTrainingTable();
        }
        if (typeof updateTrainingStats === 'function') {
          updateTrainingStats();
        }
        break;
      case 'qualificationView':
        if (typeof loadQualificationRecords === 'function') {
          loadQualificationRecords();
        }
        if (typeof renderQualificationTable === 'function') {
          renderQualificationTable();
        }
        if (typeof fillQualificationPigeonSelect === 'function') {
          fillQualificationPigeonSelect();
        }
        break;
    }
    
    console.log('ËßÜÂõæÂàáÊç¢ÂÆåÊàê:', name);
  };
  
  // ========================================
  // üèÉ ËÆ≠ÁªÉÊ®°Âùó
  // ========================================
  
  const TRAINING_STORAGE_KEY = 'pigeon_training_records_v1';
  let trainingRecords = [];
  let currentTrainingPigeonId = null;
  
  // Âä†ËΩΩËÆ≠ÁªÉËÆ∞ÂΩï
  function loadTrainingRecords() {
    try {
      const raw = localStorage.getItem(TRAINING_STORAGE_KEY);
      if (raw) {
        trainingRecords = JSON.parse(raw);
      } else {
        trainingRecords = [];
      }
    } catch (e) {
      console.error('Âä†ËΩΩËÆ≠ÁªÉËÆ∞ÂΩïÂ§±Ë¥•:', e);
      trainingRecords = [];
    }
  }
  
  // ‰øùÂ≠òËÆ≠ÁªÉËÆ∞ÂΩï
  function saveTrainingRecords() {
    try {
      localStorage.setItem(TRAINING_STORAGE_KEY, JSON.stringify(trainingRecords));
    } catch (e) {
      console.error('‰øùÂ≠òËÆ≠ÁªÉËÆ∞ÂΩïÂ§±Ë¥•:', e);
    }
  }
  
  // ËÆ°ÁÆóÈÄüÂ∫¶ÔºàÂÖ¨Èáå/Â∞èÊó∂Ôºâ
  function calculateSpeed(distance, duration) {
    if (!distance || !duration || duration === 0) return 0;
    return (distance / duration) * 60; // ËΩ¨Êç¢‰∏∫ÂÖ¨Èáå/Â∞èÊó∂
  }
  
  // ‰øùÂ≠òËÆ≠ÁªÉËÆ∞ÂΩï
  function saveTrainingRecord() {
    const date = document.getElementById('trainingDate').value;
    const distance = parseFloat(document.getElementById('trainingDistance').value);
    const duration = parseFloat(document.getElementById('trainingDuration').value);
    const weather = document.getElementById('trainingWeather').value;
    const temperature = document.getElementById('trainingTemperature').value ? parseFloat(document.getElementById('trainingTemperature').value) : null;
    const windSpeed = document.getElementById('trainingWindSpeed').value ? parseFloat(document.getElementById('trainingWindSpeed').value) : null;
    const direction = document.getElementById('trainingDirection').value;
    const releaseTime = document.getElementById('trainingReleaseTime').value;
    const returnTime = document.getElementById('trainingReturnTime').value;
    const notes = document.getElementById('trainingNotes').value;
    
    if (!date || !distance || !duration || !currentTrainingPigeonId) {
      alert('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑËÆ≠ÁªÉ‰ø°ÊÅØÔºÅ');
      return;
    }
    
    const pigeon = getPigeonById(currentTrainingPigeonId);
    if (!pigeon) {
      alert('Êú™ÊâæÂà∞ÈÄâ‰∏≠ÁöÑÈ∏ΩÂ≠êÔºÅ');
      return;
    }
    
    const speed = calculateSpeed(distance, duration);
    
    const record = {
      id: 'training_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9),
      pigeonId: currentTrainingPigeonId,
      pigeonRing: pigeon.ring,
      pigeonName: pigeon.name || pigeon.ring,
      date: date,
      distance: distance,
      duration: duration,
      speed: speed,
      weather: weather,
      temperature: temperature,
      windSpeed: windSpeed,
      direction: direction,
      releaseTime: releaseTime,
      returnTime: returnTime,
      notes: notes,
      createdAt: new Date().toISOString()
    };
    
    trainingRecords.push(record);
    saveTrainingRecords();
    
    // Ê∏ÖÁ©∫Ë°®Âçï
    document.getElementById('trainingDate').value = '';
    document.getElementById('trainingDistance').value = '';
    document.getElementById('trainingDuration').value = '';
    document.getElementById('trainingWeather').value = 'unknown';
    document.getElementById('trainingTemperature').value = '';
    document.getElementById('trainingWindSpeed').value = '';
    document.getElementById('trainingDirection').value = 'unknown';
    document.getElementById('trainingReleaseTime').value = '';
    document.getElementById('trainingReturnTime').value = '';
    document.getElementById('trainingNotes').value = '';
    
    document.getElementById('trainingFormContainer').style.display = 'none';
    
    // Âà∑Êñ∞ÊòæÁ§∫ÔºàËá™Âä®Êõ¥Êñ∞Ôºâ
    renderTrainingTable();
    updateTrainingStats();
    
    // Ëá™Âä®Êõ¥Êñ∞ËÉΩÂäõÂàÜÊûêËÆ∞ÂΩïÔºàÂ¶ÇÊûúÂ≠òÂú®Áõ∏ÂÖ≥ÂàÜÊûêÔºâ
    if (typeof renderQualificationTable === 'function') {
      renderQualificationTable();
    }
    
    alert('ËÆ≠ÁªÉËÆ∞ÂΩï‰øùÂ≠òÊàêÂäüÔºÅ');
  }
  
  // Âà†Èô§ËÆ≠ÁªÉËÆ∞ÂΩïÔºàÂÖ®Â±ÄÂáΩÊï∞Ôºå‰æõHTML‰∏≠ÁöÑonclickË∞ÉÁî®Ôºâ
  window.deleteTrainingRecord = function(id) {
    if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ≠ÁªÉËÆ∞ÂΩïÂêóÔºü')) {
      trainingRecords = trainingRecords.filter(r => r.id !== id);
      saveTrainingRecords();
      renderTrainingTable();
      updateTrainingStats();
    }
  };
  
  // Ê∏≤ÊüìËÆ≠ÁªÉËÆ∞ÂΩïË°®Ê†º
  function renderTrainingTable() {
    const container = document.getElementById('trainingRecordsList');
    if (!container) return;
    
    loadTrainingRecords();
    
    if (trainingRecords.length === 0) {
      container.innerHTML = '<p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†ËÆ≠ÁªÉËÆ∞ÂΩï</p>';
      return;
    }
    
    // ÊåâÊó•ÊúüÂÄíÂ∫èÊéíÂàó
    const sortedRecords = [...trainingRecords].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    let html = `
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:#f9fafb;border-bottom:2px solid #e5e7eb;">
              <th style="padding:12px;text-align:left;font-weight:600;color:#374151;">Êó•Êúü</th>
              <th style="padding:12px;text-align:left;font-weight:600;color:#374151;">È∏ΩÂ≠ê</th>
              <th style="padding:12px;text-align:center;font-weight:600;color:#374151;">Ë∑ùÁ¶ª(km)</th>
              <th style="padding:12px;text-align:center;font-weight:600;color:#374151;">Êó∂Èïø(ÂàÜÈíü)</th>
              <th style="padding:12px;text-align:center;font-weight:600;color:#374151;">ÈÄüÂ∫¶(km/h)</th>
              <th style="padding:12px;text-align:center;font-weight:600;color:#374151;">Â§©Ê∞î</th>
              <th style="padding:12px;text-align:center;font-weight:600;color:#374151;">Ê∏©Â∫¶(‚ÑÉ)</th>
              <th style="padding:12px;text-align:center;font-weight:600;color:#374151;">È£éÈÄü(m/s)</th>
              <th style="padding:12px;text-align:center;font-weight:600;color:#374151;">È£éÂêë</th>
              <th style="padding:12px;text-align:center;font-weight:600;color:#374151;">Êìç‰Ωú</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    sortedRecords.forEach((record, index) => {
      const pigeon = getPigeonById(record.pigeonId);
      const weatherMap = {
        'sunny': '‚òÄÔ∏è Êô¥Â§©',
        'cloudy': '‚òÅÔ∏è Â§ö‰∫ë',
        'rainy': 'üåßÔ∏è Èõ®Â§©',
        'windy': 'üí® Â§ßÈ£é',
        'foggy': 'üå´Ô∏è ÈõæÂ§©',
        'unknown': '‚Äî'
      };
      
      const directionMap = {
        'N': 'Âåó',
        'NE': '‰∏úÂåó',
        'E': '‰∏ú',
        'SE': '‰∏úÂçó',
        'S': 'Âçó',
        'SW': 'Ë•øÂçó',
        'W': 'Ë•ø',
        'NW': 'Ë•øÂåó',
        'unknown': '‚Äî'
      };
      
      html += `
        <tr style="border-bottom:1px solid #f0f0f0;${index % 2 === 0 ? 'background:#fff;' : 'background:#f9fafb;'}">
          <td style="padding:12px;color:#1f2937;">${record.date}</td>
          <td style="padding:12px;">
            <strong style="color:#2563eb;">${record.pigeonName || record.pigeonRing}</strong>
            <span style="color:#6b7280;font-size:12px;margin-left:4px;">(${record.pigeonRing})</span>
          </td>
          <td style="padding:12px;text-align:center;color:#1f2937;">${record.distance.toFixed(1)}</td>
          <td style="padding:12px;text-align:center;color:#1f2937;">${record.duration.toFixed(1)}</td>
          <td style="padding:12px;text-align:center;font-weight:600;color:#10b981;">${record.speed.toFixed(2)}</td>
          <td style="padding:12px;text-align:center;color:#6b7280;">${weatherMap[record.weather] || record.weather}</td>
          <td style="padding:12px;text-align:center;color:#6b7280;">${record.temperature !== null ? record.temperature.toFixed(1) : '‚Äî'}</td>
          <td style="padding:12px;text-align:center;color:#6b7280;">${record.windSpeed !== null ? record.windSpeed.toFixed(1) : '‚Äî'}</td>
          <td style="padding:12px;text-align:center;color:#6b7280;">${directionMap[record.direction] || record.direction}</td>
          <td style="padding:12px;text-align:center;">
            <button class="btn btn-outline btn-sm" onclick="deleteTrainingRecord('${record.id}')" style="padding:4px 8px;font-size:12px;">Âà†Èô§</button>
          </td>
        </tr>
      `;
    });
    
    html += `
          </tbody>
        </table>
      </div>
    `;
    
    container.innerHTML = html;
  }
  
  // Êõ¥Êñ∞ËÆ≠ÁªÉÁªüËÆ°
  function updateTrainingStats() {
    loadTrainingRecords();
    
    const totalCount = trainingRecords.length;
    const totalDistance = trainingRecords.reduce((sum, r) => sum + (r.distance || 0), 0);
    const speeds = trainingRecords.filter(r => r.speed > 0).map(r => r.speed);
    const avgSpeed = speeds.length > 0 ? speeds.reduce((sum, s) => sum + s, 0) / speeds.length : 0;
    const maxSpeed = speeds.length > 0 ? Math.max(...speeds) : 0;
    
    document.getElementById('trainingTotalCount').textContent = totalCount;
    document.getElementById('trainingTotalDistance').textContent = totalDistance.toFixed(1);
    document.getElementById('trainingAvgSpeed').textContent = avgSpeed.toFixed(2);
    document.getElementById('trainingMaxSpeed').textContent = maxSpeed.toFixed(2);
    
    // ÊòæÁ§∫ÁªüËÆ°ÂÆπÂô®
    document.getElementById('trainingStatsContainer').style.display = '';
    
    // ÊòæÁ§∫ÂàÜÊûêÁªìÊûú
    const analysisContainer = document.getElementById('trainingAnalysisResult');
    if (analysisContainer && trainingRecords.length > 0) {
      let analysisHtml = '<div style="line-height:1.8;">';
      
      if (trainingRecords.length >= 10) {
        analysisHtml += '<p>‚úÖ <strong>ËÆ≠ÁªÉÈ¢ëÁéáÔºö</strong>ËÆ≠ÁªÉËÆ∞ÂΩïÂÖÖË∂≥ÔºåÂª∫ËÆÆÁªßÁª≠‰øùÊåÅ„ÄÇ</p>';
      } else {
        analysisHtml += '<p>‚ö†Ô∏è <strong>ËÆ≠ÁªÉÈ¢ëÁéáÔºö</strong>ËÆ≠ÁªÉËÆ∞ÂΩïËæÉÂ∞ëÔºåÂª∫ËÆÆÂ¢ûÂä†ËÆ≠ÁªÉÈ¢ëÁéá„ÄÇ</p>';
      }
      
      if (avgSpeed > 0) {
        if (avgSpeed >= 60) {
          analysisHtml += '<p>‚úÖ <strong>Âπ≥ÂùáÈÄüÂ∫¶Ôºö</strong>Âπ≥ÂùáÈÄüÂ∫¶Ë°®Áé∞‰ºòÁßÄÔºåËææÂà∞' + avgSpeed.toFixed(2) + ' km/h„ÄÇ</p>';
        } else if (avgSpeed >= 40) {
          analysisHtml += '<p>üëç <strong>Âπ≥ÂùáÈÄüÂ∫¶Ôºö</strong>Âπ≥ÂùáÈÄüÂ∫¶Ë°®Áé∞ËâØÂ•ΩÔºå‰∏∫' + avgSpeed.toFixed(2) + ' km/h„ÄÇ</p>';
        } else {
          analysisHtml += '<p>‚ö†Ô∏è <strong>Âπ≥ÂùáÈÄüÂ∫¶Ôºö</strong>Âπ≥ÂùáÈÄüÂ∫¶ÂÅè‰ΩéÔºåÂª∫ËÆÆÂä†Âº∫ËÆ≠ÁªÉÔºåÂΩìÂâç‰∏∫' + avgSpeed.toFixed(2) + ' km/h„ÄÇ</p>';
        }
      }
      
      if (totalDistance > 0) {
        analysisHtml += '<p>üìä <strong>ËÆ≠ÁªÉÊÄªÈáèÔºö</strong>Á¥ØËÆ°ËÆ≠ÁªÉË∑ùÁ¶ª' + totalDistance.toFixed(1) + 'ÂÖ¨ÈáåÔºåÂÖ±' + totalCount + 'Ê¨°ËÆ≠ÁªÉ„ÄÇ</p>';
      }
      
      analysisHtml += '</div>';
      analysisContainer.innerHTML = analysisHtml;
    }
  }
  
  // ËÆ≠ÁªÉÊ®°ÂùóÊåâÈíÆ‰∫ã‰ª∂
  document.getElementById('btnSaveTraining')?.addEventListener('click', saveTrainingRecord);
  document.getElementById('btnCancelTraining')?.addEventListener('click', () => {
    document.getElementById('trainingFormContainer').style.display = 'none';
  });
  document.getElementById('btnRefreshTraining')?.addEventListener('click', () => {
    loadTrainingRecords();
    renderTrainingTable();
    updateTrainingStats();
  });
  
  // Êâ´Á†Å/ÊâãÂä®ËæìÂÖ•ÊåâÈíÆ
  document.getElementById('btnScanQR')?.addEventListener('click', () => {
    const ringInput = document.getElementById('trainingRingInput');
    if (ringInput) {
      ringInput.focus();
      ringInput.select();
    }
  });
  
  document.getElementById('btnManualInput')?.addEventListener('click', () => {
    const ringInput = document.getElementById('trainingRingInput');
    if (ringInput) {
      ringInput.focus();
    }
  });
  
  // ËÑöÁéØÂè∑ËæìÂÖ•Â§ÑÁêÜ
  document.getElementById('trainingRingInput')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      const ring = e.target.value.trim();
      if (ring) {
        const pigeon = pigeons.find(p => p.ring === ring);
        if (pigeon) {
          currentTrainingPigeonId = pigeon.id;
          document.getElementById('selectedPigeonDetails').innerHTML = `
            <div style="display:flex;align-items:center;gap:12px;">
              <div>
                <strong style="color:#2563eb;font-size:16px;">${pigeon.name || pigeon.ring}</strong>
                <div style="color:#6b7280;font-size:12px;margin-top:4px;">${pigeon.ring} | ${pigeon.gender || 'Êú™Áü•'} | ${pigeon.type || 'Êú™Áü•'}</div>
              </div>
            </div>
          `;
          document.getElementById('trainingFormContainer').style.display = '';
          document.getElementById('trainingDate').value = new Date().toISOString().split('T')[0];
          document.getElementById('trainingFormContainer').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
          alert('Êú™ÊâæÂà∞ËØ•ËÑöÁéØÂè∑ÁöÑÈ∏ΩÂ≠êÔºÅ');
        }
      }
    }
  });
  
  // ÂàùÂßãÂåñÂä†ËΩΩËÆ≠ÁªÉËÆ∞ÂΩï
  loadTrainingRecords();
  
  // ========================================
  // üéØ ËÉΩÂäõÁªºÂêàÂàÜÊûêÊ®°Âùó
  // ========================================
  
  const QUALIFICATION_STORAGE_KEY = 'pigeon_qualification_records_v1';
  let qualificationRecords = [];
  
  // Âä†ËΩΩËÉΩÂäõÂàÜÊûêËÆ∞ÂΩï
  function loadQualificationRecords() {
    try {
      const raw = localStorage.getItem(QUALIFICATION_STORAGE_KEY);
      if (raw) {
        qualificationRecords = JSON.parse(raw);
      } else {
        qualificationRecords = [];
      }
    } catch (e) {
      console.error('Âä†ËΩΩËÉΩÂäõÂàÜÊûêËÆ∞ÂΩïÂ§±Ë¥•:', e);
      qualificationRecords = [];
    }
  }
  
  // ‰øùÂ≠òËÉΩÂäõÂàÜÊûêËÆ∞ÂΩï
  function saveQualificationRecords() {
    try {
      localStorage.setItem(QUALIFICATION_STORAGE_KEY, JSON.stringify(qualificationRecords));
    } catch (e) {
      console.error('‰øùÂ≠òËÉΩÂäõÂàÜÊûêËÆ∞ÂΩïÂ§±Ë¥•:', e);
    }
  }
  
  // ÂàÜÊûêËÆ≠ÁªÉÊï∞ÊçÆÔºàÊú¨Âú∞ÂàÜÊûêÔºâ
  function analyzeTrainingForRace(trainingRecords, raceDistance) {
    if (!trainingRecords || trainingRecords.length === 0) {
      return {
        score: 0,
        level: 'insufficient',
        message: 'ËÆ≠ÁªÉÊï∞ÊçÆ‰∏çË∂≥',
        details: []
      };
    }
    
    // Ëé∑ÂèñÊúÄËøëÁöÑËÆ≠ÁªÉËÆ∞ÂΩï
    const recentTrainings = trainingRecords.slice(0, 10);
    const avgDistance = recentTrainings.reduce((sum, t) => sum + (t.distance || 0), 0) / recentTrainings.length;
    const avgSpeed = recentTrainings.reduce((sum, t) => sum + (t.speed || 0), 0) / recentTrainings.length;
    const maxDistance = Math.max(...recentTrainings.map(t => t.distance || 0));
    
    let score = 0;
    const details = [];
    
    // Ë∑ùÁ¶ªËØÑ‰º∞Ôºà40ÂàÜÔºâ
    if (maxDistance >= raceDistance * 0.8) {
      score += 40;
      details.push('‚úÖ ÊúÄÂ§ßËÆ≠ÁªÉË∑ùÁ¶ªËææÂà∞ÊØîËµõË∑ùÁ¶ªÁöÑ80%‰ª•‰∏ä');
    } else if (maxDistance >= raceDistance * 0.6) {
      score += 30;
      details.push('üëç ÊúÄÂ§ßËÆ≠ÁªÉË∑ùÁ¶ªËææÂà∞ÊØîËµõË∑ùÁ¶ªÁöÑ60%‰ª•‰∏ä');
    } else if (maxDistance >= raceDistance * 0.4) {
      score += 20;
      details.push('‚ö†Ô∏è ÊúÄÂ§ßËÆ≠ÁªÉË∑ùÁ¶ª‰ªÖËææÂà∞ÊØîËµõË∑ùÁ¶ªÁöÑ40%');
    } else {
      details.push('‚ùå ÊúÄÂ§ßËÆ≠ÁªÉË∑ùÁ¶ª‰∏çË∂≥ÊØîËµõË∑ùÁ¶ªÁöÑ40%');
    }
    
    // Âπ≥ÂùáË∑ùÁ¶ªËØÑ‰º∞Ôºà30ÂàÜÔºâ
    if (avgDistance >= raceDistance * 0.5) {
      score += 30;
      details.push('‚úÖ Âπ≥ÂùáËÆ≠ÁªÉË∑ùÁ¶ªË°®Áé∞ËâØÂ•Ω');
    } else if (avgDistance >= raceDistance * 0.3) {
      score += 20;
      details.push('üëç Âπ≥ÂùáËÆ≠ÁªÉË∑ùÁ¶ªÂü∫Êú¨ÂêàÊ†º');
    } else {
      details.push('‚ö†Ô∏è Âπ≥ÂùáËÆ≠ÁªÉË∑ùÁ¶ªÂÅè‰Ωé');
    }
    
    // ÈÄüÂ∫¶ËØÑ‰º∞Ôºà30ÂàÜÔºâ
    if (avgSpeed >= 60) {
      score += 30;
      details.push('‚úÖ Âπ≥ÂùáÈÄüÂ∫¶‰ºòÁßÄÔºà‚â•60 km/hÔºâ');
    } else if (avgSpeed >= 50) {
      score += 25;
      details.push('üëç Âπ≥ÂùáÈÄüÂ∫¶ËâØÂ•ΩÔºà‚â•50 km/hÔºâ');
    } else if (avgSpeed >= 40) {
      score += 15;
      details.push('‚ö†Ô∏è Âπ≥ÂùáÈÄüÂ∫¶‰∏ÄËà¨Ôºà‚â•40 km/hÔºâ');
    } else {
      details.push('‚ùå Âπ≥ÂùáÈÄüÂ∫¶ÂÅè‰ΩéÔºà<40 km/hÔºâ');
    }
    
    let level = 'insufficient';
    if (score >= 75) level = 'excellent';
    else if (score >= 60) level = 'good';
    else if (score >= 45) level = 'fair';
    
    return {
      score: Math.min(100, score),
      level,
      message: score >= 60 ? 'ËÆ≠ÁªÉÊï∞ÊçÆË°®Áé∞ËâØÂ•Ω' : score >= 45 ? 'ËÆ≠ÁªÉÊï∞ÊçÆÂü∫Êú¨ÂêàÊ†º' : 'ËÆ≠ÁªÉÊï∞ÊçÆ‰∏çË∂≥',
      details,
      avgDistance: avgDistance.toFixed(1),
      avgSpeed: avgSpeed.toFixed(2),
      maxDistance: maxDistance.toFixed(1),
      trainingCount: trainingRecords.length
    };
  }
  
  // ÂàÜÊûêÊØîËµõÂéÜÂè≤
  function analyzeRaceHistory(raceRecords, raceDistance) {
    if (!raceRecords || raceRecords.length === 0) {
      return {
        score: 0,
        level: 'no_record',
        message: 'Êó†ÂéÜÂè≤ÊØîËµõËÆ∞ÂΩï',
        details: []
      };
    }
    
    // ËøáÊª§Áõ∏‰ººË∑ùÁ¶ªÁöÑÊØîËµõÔºà¬±20%Ôºâ
    const similarDistanceRaces = raceRecords.filter(r => {
      const raceDist = r.distance || 0;
      return Math.abs(raceDist - raceDistance) / raceDistance <= 0.2;
    });
    
    if (similarDistanceRaces.length === 0) {
      return {
        score: 20,
        level: 'different_distance',
        message: 'Êó†Áõ∏‰ººË∑ùÁ¶ªÊØîËµõËÆ∞ÂΩï',
        details: ['‚ö†Ô∏è Ê≤°ÊúâÁõ∏‰ººË∑ùÁ¶ªÁöÑÂéÜÂè≤ÊØîËµõËÆ∞ÂΩï']
      };
    }
    
    const bestRank = Math.min(...similarDistanceRaces.map(r => r.rank || 999));
    const avgRank = similarDistanceRaces.reduce((sum, r) => sum + (r.rank || 999), 0) / similarDistanceRaces.length;
    const wins = similarDistanceRaces.filter(r => r.rank && r.rank <= 3).length;
    
    let score = 40; // Âü∫Á°ÄÂàÜÔºàÊúâÁõ∏‰ººË∑ùÁ¶ªËÆ∞ÂΩïÔºâ
    const details = [];
    
    if (bestRank <= 3) {
      score += 30;
      details.push('‚úÖ ÊõæÂú®Áõ∏‰ººË∑ùÁ¶ªËé∑ÂæóÂâç3Âêç');
    } else if (bestRank <= 10) {
      score += 20;
      details.push('üëç ÊõæÂú®Áõ∏‰ººË∑ùÁ¶ªËé∑ÂæóÂâç10Âêç');
    } else if (bestRank <= 20) {
      score += 10;
      details.push('üëç ÊõæÂú®Áõ∏‰ººË∑ùÁ¶ªËé∑ÂæóÂâç20Âêç');
    }
    
    if (wins >= 2) {
      score += 20;
      details.push('‚úÖ Â§öÊ¨°Âú®Áõ∏‰ººË∑ùÁ¶ªËé∑ÂæóÂ•ΩÊàêÁª©');
    } else if (wins === 1) {
      score += 10;
      details.push('üëç ÊõæÂú®Áõ∏‰ººË∑ùÁ¶ªËé∑ÂæóÂ•ΩÊàêÁª©');
    }
    
    if (avgRank <= 10) {
      score += 10;
      details.push('‚úÖ Âπ≥ÂùáÂêçÊ¨°‰ºòÁßÄ');
    }
    
    let level = 'poor';
    if (score >= 70) level = 'excellent';
    else if (score >= 55) level = 'good';
    else if (score >= 40) level = 'fair';
    
    return {
      score: Math.min(100, score),
      level,
      message: score >= 60 ? 'ÂéÜÂè≤ÊØîËµõË°®Áé∞‰ºòÁßÄ' : score >= 40 ? 'ÂéÜÂè≤ÊØîËµõË°®Áé∞ËâØÂ•Ω' : 'ÂéÜÂè≤ÊØîËµõË°®Áé∞‰∏ÄËà¨',
      details,
      bestRank,
      avgRank: avgRank.toFixed(1),
      wins,
      raceCount: similarDistanceRaces.length
    };
  }
  
  // ÁªºÂêàÂàÜÊûêÂπ∂ËÆ°ÁÆóÈÄÇÂêàÂèÇËµõÂ∫¶
  function analyzeQualification(pigeonId, raceDistance) {
    const pigeon = getPigeonById(pigeonId);
    if (!pigeon) {
      alert('Êú™ÊâæÂà∞ÈÄâ‰∏≠ÁöÑÈ∏ΩÂ≠êÔºÅ');
      return null;
    }
    
    // Ëé∑ÂèñËÆ≠ÁªÉËÆ∞ÂΩï
    loadTrainingRecords();
    const pigeonTrainings = trainingRecords.filter(t => t.pigeonId === pigeonId);
    
    // Ëé∑ÂèñÊØîËµõËÆ∞ÂΩï
    const pigeonRaces = [];
    pigeons.forEach(p => {
      if (p.id === pigeonId && p.races && Array.isArray(p.races)) {
        pigeonRaces.push(...p.races.map(r => ({
          ...r,
          distance: raceDistance // ‰ΩøÁî®ÁõÆÊ†áË∑ùÁ¶ª‰Ωú‰∏∫ÂèÇËÄÉ
        })));
      }
    });
    
    // ÂàÜÊûêËÆ≠ÁªÉÊï∞ÊçÆ
    const trainingAnalysis = analyzeTrainingForRace(pigeonTrainings, raceDistance);
    
    // ÂàÜÊûêÊØîËµõÂéÜÂè≤
    const raceAnalysis = analyzeRaceHistory(pigeonRaces, raceDistance);
    
    // ËÆ°ÁÆóÁªºÂêàÂæóÂàÜÔºàËÆ≠ÁªÉ60%ÔºåÊØîËµõ40%Ôºâ
    const totalScore = (trainingAnalysis.score * 0.6) + (raceAnalysis.score * 0.4);
    
    // Á°ÆÂÆöÈÄÇÂêàÂèÇËµõÂ∫¶
    let qualificationLevel = 'not_qualified';
    let qualificationPercent = 0;
    let recommendation = '';
    
    if (totalScore >= 75) {
      qualificationLevel = 'highly_qualified';
      qualificationPercent = Math.min(100, Math.round(totalScore));
      recommendation = 'Âº∫ÁÉàÊé®ËçêÂèÇËµõ';
    } else if (totalScore >= 60) {
      qualificationLevel = 'qualified';
      qualificationPercent = Math.min(95, Math.round(totalScore));
      recommendation = 'Êé®ËçêÂèÇËµõ';
    } else if (totalScore >= 45) {
      qualificationLevel = 'conditionally_qualified';
      qualificationPercent = Math.min(80, Math.round(totalScore));
      recommendation = 'ÂèØ‰ª•Â∞ùËØïÂèÇËµõ';
    } else if (totalScore >= 30) {
      qualificationLevel = 'not_recommended';
      qualificationPercent = Math.round(totalScore);
      recommendation = '‰∏çÂª∫ËÆÆÂèÇËµõ';
    } else {
      qualificationLevel = 'not_qualified';
      qualificationPercent = Math.round(totalScore);
      recommendation = '‰∏çÈÄÇÂêàÂèÇËµõ';
    }
    
    const analysis = {
      id: 'qual_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9),
      pigeonId: pigeonId,
      pigeonRing: pigeon.ring,
      pigeonName: pigeon.name || pigeon.ring,
      raceDistance: raceDistance,
      analysisDate: new Date().toISOString(),
      qualificationPercent: qualificationPercent,
      qualificationLevel: qualificationLevel,
      totalScore: totalScore.toFixed(1),
      trainingAnalysis: trainingAnalysis,
      raceAnalysis: raceAnalysis,
      recommendation: recommendation,
      conclusion: `${pigeon.name || pigeon.ring} (${pigeon.ring}) ÈÄÇÂêà${raceDistance}ÂÖ¨ÈáåÊØîËµõÁöÑËÉΩÂäõ‰∏∫ ${qualificationPercent}%Ôºå${recommendation}„ÄÇ`
    };
    
    return analysis;
  }
  
  // ‰øùÂ≠òÂàÜÊûêÁªìÊûúÂà∞ËÆ∞ÂΩï
  function saveQualificationRecord(analysis) {
    // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Áõ∏ÂêåÁöÑÂàÜÊûêÔºàÂêå‰∏ÄÈ∏ΩÂ≠ê„ÄÅÂêå‰∏ÄË∑ùÁ¶ªÔºâ
    const existingIndex = qualificationRecords.findIndex(r => 
      r.pigeonId === analysis.pigeonId && r.raceDistance === analysis.raceDistance
    );
    
    if (existingIndex >= 0) {
      // Êõ¥Êñ∞Áé∞ÊúâËÆ∞ÂΩï
      qualificationRecords[existingIndex] = analysis;
    } else {
      // Ê∑ªÂä†Êñ∞ËÆ∞ÂΩï
      qualificationRecords.push(analysis);
    }
    
    saveQualificationRecords();
    renderQualificationTable();
  }
  
  // Âà†Èô§ÂàÜÊûêËÆ∞ÂΩï
  window.deleteQualificationRecord = function(id) {
    if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂàÜÊûêËÆ∞ÂΩïÂêóÔºü')) {
      qualificationRecords = qualificationRecords.filter(r => r.id !== id);
      saveQualificationRecords();
      renderQualificationTable();
    }
  };
  
  // Ê∏≤ÊüìËÉΩÂäõÂàÜÊûêËÆ∞ÂΩïË°®Ê†º
  function renderQualificationTable() {
    const container = document.getElementById('qualificationRecordsList');
    if (!container) return;
    
    loadQualificationRecords();
    
    if (qualificationRecords.length === 0) {
      container.innerHTML = '<p class="muted" style="text-align:center;padding:20px;">ÊöÇÊó†ÂàÜÊûêËÆ∞ÂΩïÔºåËØ∑ÂÖàËøõË°åËÉΩÂäõÂàÜÊûê</p>';
      return;
    }
    
    // ÊåâÈÄÇÂêàÂèÇËµõÂ∫¶‰ªéÈ´òÂà∞‰ΩéÊéíÂ∫è
    const sortedRecords = [...qualificationRecords].sort((a, b) => 
      parseFloat(b.qualificationPercent) - parseFloat(a.qualificationPercent)
    );
    
    let html = `
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:#f9fafb;border-bottom:2px solid #e5e7eb;">
              <th style="padding:12px;text-align:left;font-weight:600;color:#374151;">ÊéíÂêç</th>
              <th style="padding:12px;text-align:left;font-weight:600;color:#374151;">È∏ΩÂ≠ê</th>
              <th style="padding:12px;text-align:center;font-weight:600;color:#374151;">ÊØîËµõË∑ùÁ¶ª(km)</th>
              <th style="padding:12px;text-align:center;font-weight:600;color:#374151;">ÈÄÇÂêàÂèÇËµõÂ∫¶</th>
              <th style="padding:12px;text-align:center;font-weight:600;color:#374151;">ÁªºÂêàÂæóÂàÜ</th>
              <th style="padding:12px;text-align:center;font-weight:600;color:#374151;">Âª∫ËÆÆ</th>
              <th style="padding:12px;text-align:center;font-weight:600;color:#374151;">ÂàÜÊûêÊó•Êúü</th>
              <th style="padding:12px;text-align:center;font-weight:600;color:#374151;">Êìç‰Ωú</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    sortedRecords.forEach((record, index) => {
      const percentColor = record.qualificationPercent >= 75 ? '#10b981' : 
                          record.qualificationPercent >= 60 ? '#3b82f6' : 
                          record.qualificationPercent >= 45 ? '#f59e0b' : '#ef4444';
      
      const percentBg = record.qualificationPercent >= 75 ? '#d1fae5' : 
                        record.qualificationPercent >= 60 ? '#dbeafe' : 
                        record.qualificationPercent >= 45 ? '#fef3c7' : '#fee2e2';
      
      html += `
        <tr style="border-bottom:1px solid #f0f0f0;${index % 2 === 0 ? 'background:#fff;' : 'background:#f9fafb;'}">
          <td style="padding:12px;color:#1f2937;font-weight:600;">#${index + 1}</td>
          <td style="padding:12px;">
            <strong style="color:#2563eb;">${record.pigeonName || record.pigeonRing}</strong>
            <span style="color:#6b7280;font-size:12px;margin-left:4px;">(${record.pigeonRing})</span>
          </td>
          <td style="padding:12px;text-align:center;color:#1f2937;">${record.raceDistance}</td>
          <td style="padding:12px;text-align:center;">
            <span style="background:${percentBg};color:${percentColor};padding:6px 12px;border-radius:6px;font-weight:700;font-size:16px;">
              ${record.qualificationPercent}%
            </span>
          </td>
          <td style="padding:12px;text-align:center;color:#1f2937;font-weight:600;">${record.totalScore}</td>
          <td style="padding:12px;text-align:center;">
            <span style="color:${percentColor};font-weight:600;">${record.recommendation}</span>
          </td>
          <td style="padding:12px;text-align:center;color:#6b7280;font-size:13px;">
            ${new Date(record.analysisDate).toLocaleDateString('zh-CN')}
          </td>
          <td style="padding:12px;text-align:center;">
            <button class="btn btn-outline btn-sm" onclick="viewQualificationDetail('${record.id}')" style="padding:4px 8px;font-size:12px;margin-right:4px;">ËØ¶ÊÉÖ</button>
            <button class="btn btn-outline btn-sm" onclick="deleteQualificationRecord('${record.id}')" style="padding:4px 8px;font-size:12px;">Âà†Èô§</button>
          </td>
        </tr>
      `;
    });
    
    html += `
          </tbody>
        </table>
      </div>
    `;
    
    container.innerHTML = html;
  }
  
  // Êü•ÁúãÂàÜÊûêËØ¶ÊÉÖ
  window.viewQualificationDetail = function(id) {
    const record = qualificationRecords.find(r => r.id === id);
    if (!record) return;
    
    let detailHtml = `
      <div style="padding:20px;">
        <h3 style="margin:0 0 20px;color:#1f2937;">${record.pigeonName || record.pigeonRing} (${record.pigeonRing}) - ${record.raceDistance}ÂÖ¨ÈáåÊØîËµõÂàÜÊûê</h3>
        
        <div style="background:linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);padding:20px;border-radius:10px;margin-bottom:20px;">
          <div style="font-size:32px;font-weight:700;color:#1e40af;text-align:center;">${record.qualificationPercent}%</div>
          <div style="text-align:center;color:#64748b;margin-top:8px;">ÈÄÇÂêàÂèÇËµõÂ∫¶</div>
          <div style="text-align:center;color:#1e40af;font-weight:600;margin-top:8px;">${record.recommendation}</div>
        </div>
        
        <h4 style="margin:20px 0 12px;color:#374151;">üèÉ ËÆ≠ÁªÉÊï∞ÊçÆÂàÜÊûê</h4>
        <div style="background:#fff;padding:16px;border-radius:8px;margin-bottom:16px;border:1px solid #e5e7eb;">
          <p><strong>ËØÑÂàÜÔºö</strong>${record.trainingAnalysis.score} / 100</p>
          <p><strong>Á≠âÁ∫ßÔºö</strong>${record.trainingAnalysis.message}</p>
          <ul style="margin:12px 0;padding-left:20px;">
            ${record.trainingAnalysis.details.map(d => `<li style="margin:4px 0;">${d}</li>`).join('')}
          </ul>
        </div>
        
        <h4 style="margin:20px 0 12px;color:#374151;">üèÜ ÂéÜÂè≤ÊØîËµõÂàÜÊûê</h4>
        <div style="background:#fff;padding:16px;border-radius:8px;margin-bottom:16px;border:1px solid #e5e7eb;">
          <p><strong>ËØÑÂàÜÔºö</strong>${record.raceAnalysis.score} / 100</p>
          <p><strong>Á≠âÁ∫ßÔºö</strong>${record.raceAnalysis.message}</p>
          ${record.raceAnalysis.details.length > 0 ? `
            <ul style="margin:12px 0;padding-left:20px;">
              ${record.raceAnalysis.details.map(d => `<li style="margin:4px 0;">${d}</li>`).join('')}
            </ul>
          ` : ''}
        </div>
        
        <h4 style="margin:20px 0 12px;color:#374151;">üìä ÁªºÂêàÂàÜÊûêÁªìËÆ∫</h4>
        <div style="background:#ecfdf5;padding:16px;border-radius:8px;border:2px solid #10b981;">
          <p style="margin:0;line-height:1.8;">${record.conclusion}</p>
        </div>
      </div>
    `;
    
    alert(detailHtml.replace(/<[^>]*>/g, '\n').replace(/\n+/g, '\n').trim());
  };
  
  // ÊâßË°åËÉΩÂäõÂàÜÊûêÔºàË∞ÉÁî®ÂêéÁ´ØAPIÔºåÂåÖÂê´AIÂàÜÊûêÔºâ
  async function performQualificationAnalysis() {
    const pigeonId = document.getElementById('qualificationPigeonSelect').value;
    const raceDistance = parseFloat(document.getElementById('qualificationDistance').value);
    
    if (!pigeonId || !raceDistance) {
      alert('ËØ∑ÈÄâÊã©È∏ΩÂ≠êÂíåËæìÂÖ•ÊØîËµõË∑ùÁ¶ªÔºÅ');
      return;
    }
    
    const btn = document.getElementById('btnAnalyzeQualification');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'ÂàÜÊûê‰∏≠...';
    
    try {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('ËØ∑ÂÖàÁôªÂΩïÔºÅ');
        btn.disabled = false;
        btn.textContent = originalText;
        return;
      }
      
      const apiUrl = getBackendApiUrl();
      const response = await fetch(`${apiUrl}/qualification/analyze`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ pigeonId, raceDistance })
      });
      
      const result = await response.json();
      
      if (!result.success || !result.data) {
        throw new Error(result.error || 'ÂàÜÊûêÂ§±Ë¥•');
      }
      
      const analysis = result.data;
      const pigeon = pigeons.find(p => p.id === pigeonId);
      
      // ËΩ¨Êç¢Ê†ºÂºè‰ª•ÂÖºÂÆπÂâçÁ´ØÊòæÁ§∫
      const formattedAnalysis = {
        id: 'qual_' + Date.now(),
        pigeonId: pigeonId,
        pigeonName: pigeon?.name || '',
        pigeonRing: pigeon?.ring || analysis.pigeonRing,
        raceDistance: raceDistance,
        qualificationPercent: Math.round(analysis.qualification.score || 0),
        qualificationLevel: analysis.qualification.status,
        recommendation: analysis.qualification.message,
        conclusion: `${pigeon?.name || analysis.pigeonRing} (${analysis.pigeonRing}) ÈÄÇÂêà${raceDistance}ÂÖ¨ÈáåÊØîËµõÁöÑËÉΩÂäõ‰∏∫ ${Math.round(analysis.qualification.score || 0)}%Ôºå${analysis.qualification.message}„ÄÇ`,
        trainingAnalysis: {
          score: analysis.trainingAnalysis.score || 0,
          message: analysis.trainingAnalysis.message,
          details: [
            `Âπ≥ÂùáÈÄüÂ∫¶Ôºö${analysis.trainingAnalysis.avgSpeed?.toFixed(1) || 'Êú™Áü•'}ÂÖ¨Èáå/Â∞èÊó∂`,
            `ÊúÄËøëËÆ≠ÁªÉÊ¨°Êï∞Ôºö${analysis.trainingAnalysis.recentTrainingCount || 0}Ê¨°`,
            `Áõ∏ÂÖ≥ËÆ≠ÁªÉÊ¨°Êï∞Ôºö${analysis.trainingAnalysis.relevantTrainingCount || 0}Ê¨°`
          ]
        },
        raceAnalysis: {
          score: analysis.raceHistoryAnalysis.score || 0,
          message: analysis.raceHistoryAnalysis.message,
          details: analysis.raceHistoryAnalysis.raceCount ? [
            `ÂéÜÂè≤ÊØîËµõÂú∫Ê¨°Ôºö${analysis.raceHistoryAnalysis.raceCount}Âú∫`,
            `Âπ≥ÂùáÊéíÂêçÔºö${Math.round(analysis.raceHistoryAnalysis.avgRank || 0)}`,
            `ÂÆåËµõÁéáÔºö${(analysis.raceHistoryAnalysis.completionRate * 100).toFixed(0)}%`
          ] : []
        },
        comparisonAnalysis: analysis.comparisonAnalysis,
        recommendations: analysis.recommendations || [],
        aiAnalysis: analysis.aiAnalysis || null,
        disclaimer: result.disclaimer || 'Êú¨ÂàÜÊûêÁªìÊûú‰ªÖ‰æõÂèÇËÄÉÔºåÂÆûÈôÖÂèÇËµõËµÑÊ†º‰ª•Ëµõ‰∫ãÁªÑÂßî‰ºöËßÑÂÆö‰∏∫ÂáÜ„ÄÇ',
        createdAt: new Date().toISOString()
      };
      
      // ÊòæÁ§∫ÂÖçË¥£Â£∞Êòé
      if (result.disclaimer) {
        document.getElementById('qualificationDisclaimer').textContent = result.disclaimer;
      }
      
      // ÊòæÁ§∫ÂàÜÊûêÁªìÊûú
      displayQualificationResult(formattedAnalysis);
      
      // Ëá™Âä®‰øùÂ≠òÂà∞ËÆ∞ÂΩïË°®Ê†º
      saveQualificationRecord(formattedAnalysis);
      
      alert(`ÂàÜÊûêÂÆåÊàêÔºÅ${formattedAnalysis.pigeonName || formattedAnalysis.pigeonRing} ÈÄÇÂêà${raceDistance}ÂÖ¨ÈáåÊØîËµõÁöÑËÉΩÂäõ‰∏∫ ${formattedAnalysis.qualificationPercent}%`);
    } catch (error) {
      console.error('ËÉΩÂäõÂàÜÊûêÂ§±Ë¥•:', error);
      alert('ÂàÜÊûêÂ§±Ë¥•Ôºö' + error.message);
    } finally {
      btn.disabled = false;
      btn.textContent = originalText;
    }
  }
  
  // ÊòæÁ§∫ÂàÜÊûêÁªìÊûú
  function displayQualificationResult(analysis) {
    document.getElementById('qualificationResultContainer').style.display = '';
    
    // ÊòæÁ§∫ÁªºÂêàÂàÜÊûêÁªìÊûú
    const percentColor = analysis.qualificationPercent >= 75 ? '#10b981' : 
                        analysis.qualificationPercent >= 60 ? '#3b82f6' : 
                        analysis.qualificationPercent >= 45 ? '#f59e0b' : '#ef4444';
    
    document.getElementById('qualificationAnalysisResult').innerHTML = `
      <div style="text-align:center;padding:20px;">
        <div style="font-size:48px;font-weight:700;color:${percentColor};margin-bottom:12px;">
          ${analysis.qualificationPercent}%
        </div>
        <div style="font-size:18px;color:#6b7280;margin-bottom:8px;">ÈÄÇÂêàÂèÇËµõÂ∫¶</div>
        <div style="font-size:16px;color:${percentColor};font-weight:600;">${analysis.recommendation}</div>
        <div style="margin-top:20px;padding:16px;background:#f9fafb;border-radius:8px;text-align:left;">
          <p style="margin:0;line-height:1.8;"><strong>ÂàÜÊûêÁªìËÆ∫Ôºö</strong>${analysis.conclusion}</p>
        </div>
      </div>
    `;
    
    // ÊòæÁ§∫ËÆ≠ÁªÉÂàÜÊûê
    document.getElementById('qualificationTrainingAnalysis').innerHTML = `
      <p><strong>ËØÑÂàÜÔºö</strong>${analysis.trainingAnalysis.score} / 100</p>
      <p><strong>${analysis.trainingAnalysis.message}</strong></p>
      <ul style="margin:12px 0;padding-left:20px;">
        ${analysis.trainingAnalysis.details.map(d => `<li style="margin:4px 0;">${d}</li>`).join('')}
      </ul>
    `;
    
    // ÊòæÁ§∫ÊØîËµõÂàÜÊûê
    document.getElementById('qualificationRaceAnalysis').innerHTML = `
      <p><strong>ËØÑÂàÜÔºö</strong>${analysis.raceAnalysis.score} / 100</p>
      <p><strong>${analysis.raceAnalysis.message}</strong></p>
      ${analysis.raceAnalysis.details.length > 0 ? `
        <ul style="margin:12px 0;padding-left:20px;">
          ${analysis.raceAnalysis.details.map(d => `<li style="margin:4px 0;">${d}</li>`).join('')}
        </ul>
      ` : '<p>Êó†Áõ∏ÂÖ≥ÊØîËµõËÆ∞ÂΩï</p>'}
    `;
    
    // ÊòæÁ§∫Âª∫ËÆÆ
    let recommendationsHtml = '<ul style="margin:0;padding-left:20px;line-height:2;">';
    if (analysis.recommendations && analysis.recommendations.length > 0) {
      analysis.recommendations.forEach(rec => {
        recommendationsHtml += `<li>${rec}</li>`;
      });
    } else {
      recommendationsHtml += `<li>${analysis.recommendation}</li>`;
      recommendationsHtml += '<li>Âª∫ËÆÆÊåÅÁª≠ÂÖ≥Ê≥®ËØ•È∏ΩÂ≠êÁöÑËÆ≠ÁªÉË°®Áé∞ÂíåÂÅ•Â∫∑Áä∂ÂÜµ</li>';
      if (analysis.qualificationPercent < 60) {
        recommendationsHtml += '<li>Âª∫ËÆÆÂ¢ûÂä†ÈíàÂØπÊÄßËÆ≠ÁªÉÔºåÊèêÈ´òÊØîËµõËÉΩÂäõ</li>';
      }
    }
    recommendationsHtml += '</ul>';
    
    // ÊòæÁ§∫AIÂàÜÊûêÁªìÊûúÔºàÂ¶ÇÊûúÊúâÔºâ
    if (analysis.aiAnalysis && analysis.aiAnalysis.summary) {
      recommendationsHtml += `
        <div style="margin-top:20px;padding:16px;background:#f0f9ff;border-left:4px solid #3b82f6;border-radius:4px;">
          <h4 style="margin:0 0 12px;color:#1e40af;font-size:16px;">ü§ñ AIÊô∫ËÉΩÂàÜÊûê</h4>
          <p style="margin:0;line-height:1.8;color:#1e3a8a;white-space:pre-wrap;">${analysis.aiAnalysis.summary}</p>
          ${analysis.aiAnalysis.model ? `<p style="margin:8px 0 0;font-size:12px;color:#64748b;">ÂàÜÊûêÊ®°ÂûãÔºö${analysis.aiAnalysis.model}</p>` : ''}
        </div>
      `;
    }
    
    document.getElementById('qualificationRecommendations').innerHTML = recommendationsHtml;
  }
  
  // Â°´ÂÖÖËÉΩÂäõÂàÜÊûêÈ∏ΩÂ≠êÈÄâÊã©Ê°Ü
  function fillQualificationPigeonSelect() {
    const select = document.getElementById('qualificationPigeonSelect');
    if (!select) return;
    
    const currentValue = select.value;
    select.innerHTML = '<option value="">ËØ∑ÈÄâÊã©È∏ΩÂ≠ê</option>';
    pigeons.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = `${p.ring}${p.name ? ' - ' + p.name : ''}`;
      if (currentValue === p.id) {
        option.selected = true;
      }
      select.appendChild(option);
    });
  }
  
  // ËÉΩÂäõÂàÜÊûêÊåâÈíÆ‰∫ã‰ª∂
  document.getElementById('btnAnalyzeQualification')?.addEventListener('click', performQualificationAnalysis);
  document.getElementById('btnRefreshQualification')?.addEventListener('click', () => {
    loadQualificationRecords();
    renderQualificationTable();
    fillQualificationPigeonSelect();
  });
  
  // ÂàùÂßãÂåñÂä†ËΩΩËÉΩÂäõÂàÜÊûêËÆ∞ÂΩï
  loadQualificationRecords();
  
  // Á°Æ‰øùËÆ≠ÁªÉËÆ∞ÂΩï‰øùÂ≠òÂêéËá™Âä®Êõ¥Êñ∞ÔºàÂ∑≤ÁªèÂú®saveTrainingRecord‰∏≠ÂÆûÁé∞Ôºâ
  
  // ========================================
  // üåô Ê∑±Ëâ≤Ê®°ÂºèÂàáÊç¢
  // ========================================
  
  const THEME_KEY = 'pigeon_theme_preference';
  
  function getPreferredTheme() {
    const stored = localStorage.getItem(THEME_KEY);
    if (stored) return stored;
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }
  
  function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem(THEME_KEY, theme);
    
    const themeBtn = document.getElementById('btnToggleTheme');
    if (themeBtn) {
      themeBtn.textContent = theme === 'dark' ? '‚òÄÔ∏è ÊµÖËâ≤Ê®°Âºè' : 'üåô Â§úÈó¥Ê®°Âºè';
      themeBtn.title = theme === 'dark' ? 'ÂàáÊç¢Âà∞ÊµÖËâ≤Ê®°Âºè' : 'ÂàáÊç¢Âà∞Ê∑±Ëâ≤Ê®°Âºè';
    }
  }
  
  function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme') || 'light';
    const next = current === 'dark' ? 'light' : 'dark';
    setTheme(next);
  }
  
  // ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ‰∫ã‰ª∂
  // ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ‰∫ã‰ª∂ÁªëÂÆöÔºàÁ°Æ‰øùDOMÂ∑≤Âä†ËΩΩÔºâ
  function initThemeButton() {
    const themeBtn = document.getElementById('btnToggleTheme');
    if (themeBtn) {
      themeBtn.addEventListener('click', toggleTheme);
      themeBtn.style.pointerEvents = 'auto';
      themeBtn.style.cursor = 'pointer';
      console.log('‚úì btnToggleTheme ‰∫ã‰ª∂Â∑≤ÁªëÂÆö');
    } else {
      console.warn('‚úó btnToggleTheme Êú™ÊâæÂà∞');
    }
  }
  
  // Âª∂ËøüÁªëÂÆö‰∏ªÈ¢òÊåâÈíÆ
  setTimeout(initThemeButton, 100);
  
  // ÁõëÂê¨Á≥ªÁªü‰∏ªÈ¢òÂèòÂåñ
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (!localStorage.getItem(THEME_KEY)) {
      setTheme(e.matches ? 'dark' : 'light');
    }
  });
  
  // ========================================
  // ‚ú® Âä®ÁîªÂ¢ûÂº∫
  // ========================================
  
  // È°µÈù¢Âä†ËΩΩÂä®Áîª
  function addLoadingAnimation() {
    document.body.style.opacity = '0';
    document.body.style.transition = 'opacity 0.3s ease';
    setTimeout(() => {
      document.body.style.opacity = '1';
    }, 100);
  }
  
  // Âç°ÁâáËøõÂÖ•Âä®Áîª
  function animateCards() {
    const cards = document.querySelectorAll('.card, .stat-card, .home-column, .home-widget');
    cards.forEach((card, index) => {
      card.style.opacity = '0';
      card.style.transform = 'translateY(20px)';
      card.style.transition = `opacity 0.4s ease ${index * 0.05}s, transform 0.4s ease ${index * 0.05}s`;
      setTimeout(() => {
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
      }, 50);
    });
  }
  
  // Êï∞Â≠óËÆ°Êï∞Âä®Áîª
  function animateCounter(element, target, duration = 1000) {
    if (!element) return;
    const start = 0;
    const increment = target / (duration / 16);
    let current = start;
    
    const timer = setInterval(() => {
      current += increment;
      if (current >= target) {
        element.textContent = target;
        clearInterval(timer);
      } else {
        element.textContent = Math.floor(current);
      }
    }, 16);
  }
  
  // ========================================
  // üîî ÈÄöÁü•Á≥ªÁªü
  // ========================================
  
  function showNotification(message, type = 'info', duration = 3000) {
    const container = document.getElementById('notificationContainer') || createNotificationContainer();
    
    // Ê£ÄÊµãÊòØÂê¶‰∏∫ÊöóËâ≤Ê®°Âºè
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
      <span class="notification-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
      <span class="notification-message">${message}</span>
      <button class="notification-close">‚úï</button>
    `;
    
    // Ê†πÊçÆ‰∏ªÈ¢òÂíåÁ±ªÂûãËÆæÁΩÆÊ†∑Âºè
    let background, color;
    if (isDark) {
      // ÊöóËâ≤Ê®°ÂºèÔºöÊ∑±Ëâ≤ËÉåÊôØÔºåÊµÖËâ≤ÊñáÂ≠ó
      background = type === 'success' ? '#065f46' : type === 'error' ? '#7f1d1d' : type === 'warning' ? '#78350f' : '#1e3a8a';
      color = type === 'success' ? '#6ee7b7' : type === 'error' ? '#fca5a5' : type === 'warning' ? '#fcd34d' : '#93c5fd';
    } else {
      // ‰∫ÆËâ≤Ê®°ÂºèÔºöÊµÖËâ≤ËÉåÊôØÔºåÊ∑±Ëâ≤ÊñáÂ≠ó
      background = type === 'success' ? '#d1fae5' : type === 'error' ? '#fee2e2' : type === 'warning' ? '#fef3c7' : '#dbeafe';
      color = type === 'success' ? '#047857' : type === 'error' ? '#b91c1c' : type === 'warning' ? '#92400e' : '#1e40af';
    }
    
    notification.style.cssText = `
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: ${background};
      color: ${color};
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      margin-bottom: 10px;
      animation: slideIn 0.3s ease;
      font-weight: 500;
    `;
    
    container.appendChild(notification);
    
    // ËÆæÁΩÆÂÖ≥Èó≠ÊåâÈíÆÊ†∑Âºè
    const closeBtn = notification.querySelector('.notification-close');
    closeBtn.style.cssText = `
      background: none;
      border: none;
      color: ${color};
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.7;
      transition: opacity 0.2s;
    `;
    closeBtn.addEventListener('mouseenter', () => {
      closeBtn.style.opacity = '1';
    });
    closeBtn.addEventListener('mouseleave', () => {
      closeBtn.style.opacity = '0.7';
    });
    
    closeBtn.addEventListener('click', () => {
      notification.style.animation = 'slideOut 0.3s ease forwards';
      setTimeout(() => notification.remove(), 300);
    });
    
    if (duration > 0) {
      setTimeout(() => {
        if (notification.parentNode) {
          notification.style.animation = 'slideOut 0.3s ease forwards';
          setTimeout(() => notification.remove(), 300);
        }
      }, duration);
    }
  }
  
  function createNotificationContainer() {
    const container = document.createElement('div');
    container.id = 'notificationContainer';
    container.style.cssText = `
      position: fixed;
      top: 80px;
      right: 24px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
    `;
    document.body.appendChild(container);
    
    // Ê∑ªÂä†Âä®ÁîªÊ†∑Âºè
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
    
    return container;
  }
  
  // ========================================
  // ‚å®Ô∏è Âø´Êç∑ÈîÆÊîØÊåÅ
  // ========================================
  
  document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + K: ËÅöÁÑ¶ÊêúÁ¥¢Ê°Ü
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      document.getElementById('smartSearchInput')?.focus();
    }
    
    // Ctrl/Cmd + N: Êñ∞Â¢ûÈ∏ΩÂ≠ê
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
      e.preventDefault();
      switchView('createView');
    }
    
    // Escape: ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÊàñÈÄÄÂá∫ÁºñËæëÊ®°Âºè
    if (e.key === 'Escape') {
      // ÂÖàÊ£ÄÊü•ÊòØÂê¶Âú®ÁºñËæëÊ®°Âºè
      const editMode = document.getElementById('editMode');
      if (editMode && editMode.style.display !== 'none') {
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥Êîπ
        if (hasUnsavedChanges()) {
          if (confirm('ÊÇ®ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥ÊîπÔºåÁ°ÆÂÆöË¶ÅÈÄÄÂá∫ÁºñËæëÈ°µÈù¢ÂêóÔºü\n\nÂ¶ÇÊûúÈÄÄÂá∫ÔºåÊâÄÊúâÊú™‰øùÂ≠òÁöÑÊõ¥ÊîπÂ∞Ü‰ºö‰∏¢Â§±„ÄÇ')) {
            setEditMode(false);
          }
        } else {
          setEditMode(false);
        }
        return;
      }
      
      // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
      document.querySelectorAll('.race-modal').forEach(modal => {
        if (modal.style.display !== 'none') {
          modal.style.display = 'none';
        }
      });
    }
  });
  
  // ========================================
  // ÂàùÂßãÂåñ
  // ========================================
  
  // ËÆæÁΩÆ‰∏ªÈ¢ò
  setTheme(getPreferredTheme());
  
  // È°µÈù¢Âä†ËΩΩÂä®Áîª
  addLoadingAnimation();
  
  // ÂàùÂßãÂåñÊØîËµõÁÆ°ÁêÜ
  loadRaces();
  syncRacesToPigeons();
  renderRaceList();
  fillStatsPigeonSelect();
  
  // ÂàùÂßãÂåñÈÖçÂØπÁÆ°ÁêÜ
  loadPairings();
  
  // ÂàùÂßãÂåñÂÅ•Â∫∑ÁÆ°ÁêÜ
  loadHealthRecords();

  // Áõ∏Êú∫ÊãçÁÖßÂäüËÉΩÔºöÂ∞ÜÁõ∏Êú∫ËæìÂÖ•Ê°ÜÁöÑÊñá‰ª∂ÂêåÊ≠•Âà∞‰∏ªËæìÂÖ•Ê°Ü
  function syncCameraToMain(cameraInputId, mainInputId) {
    const cameraInput = document.getElementById(cameraInputId);
    const mainInput = document.getElementById(mainInputId);
    if (cameraInput && mainInput) {
      cameraInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files.length > 0) {
          // ÂàõÂª∫Êñ∞ÁöÑ FileList ÂØπË±°Âπ∂ÂêåÊ≠•Âà∞‰∏ªËæìÂÖ•Ê°Ü
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(e.target.files[0]);
          mainInput.files = dataTransfer.files;
          // Ëß¶Âèë change ‰∫ã‰ª∂‰ª•‰æøÂÖ∂‰ªñÁõëÂê¨Âô®‰πüËÉΩÂìçÂ∫î
          mainInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
    }
  }
  
  // ÂàùÂßãÂåñÁõ∏Êú∫ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
  function initCameraButtons() {
    // Êñ∞Â¢ûÈ°µÈù¢ÁöÑÁõ∏Êú∫ÊåâÈíÆ
    const btnCameraBodyCreate = document.getElementById('btnCameraBodyCreate');
    const btnCameraEyeCreate = document.getElementById('btnCameraEyeCreate');
    const cameraBodyCreate = document.getElementById('c_body_photo_camera');
    const cameraEyeCreate = document.getElementById('c_eye_photo_camera');
    
    if (btnCameraBodyCreate && cameraBodyCreate) {
      btnCameraBodyCreate.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        // ÁßªÈô§Âπ∂ÈáçÊñ∞Ê∑ªÂä† capture Â±ûÊÄßÔºåÁ°Æ‰øùÊØèÊ¨°ÈÉΩËÉΩËß¶ÂèëÁõ∏Êú∫
        cameraBodyCreate.removeAttribute('capture');
        // ‰ΩøÁî® requestAnimationFrame Á°Æ‰øù DOM Êõ¥Êñ∞ÂêéÂÜçËß¶Âèë
        requestAnimationFrame(() => {
          cameraBodyCreate.setAttribute('capture', '');
          // Ê∏ÖÁ©∫ÂÄºÔºåÁ°Æ‰øùÊØèÊ¨°ÁÇπÂáªÈÉΩËÉΩËß¶Âèë
          cameraBodyCreate.value = '';
          // Ëß¶ÂèëÁÇπÂáª
          setTimeout(() => {
            cameraBodyCreate.click();
          }, 50);
        });
      });
    }
    
    if (btnCameraEyeCreate && cameraEyeCreate) {
      btnCameraEyeCreate.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        cameraEyeCreate.removeAttribute('capture');
        requestAnimationFrame(() => {
          cameraEyeCreate.setAttribute('capture', '');
          cameraEyeCreate.value = '';
          setTimeout(() => {
            cameraEyeCreate.click();
          }, 50);
        });
      });
    }
    
    // ÁºñËæëÈ°µÈù¢ÁöÑÁõ∏Êú∫ÊåâÈíÆ
    const btnCameraBodyEdit = document.getElementById('btnCameraBodyEdit');
    const btnCameraEyeEdit = document.getElementById('btnCameraEyeEdit');
    const cameraBodyEdit = document.getElementById('e_body_photo_camera');
    const cameraEyeEdit = document.getElementById('e_eye_photo_camera');
    
    if (btnCameraBodyEdit && cameraBodyEdit) {
      btnCameraBodyEdit.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        cameraBodyEdit.removeAttribute('capture');
        requestAnimationFrame(() => {
          cameraBodyEdit.setAttribute('capture', '');
          cameraBodyEdit.value = '';
          setTimeout(() => {
            cameraBodyEdit.click();
          }, 50);
        });
      });
    }
    
    if (btnCameraEyeEdit && cameraEyeEdit) {
      btnCameraEyeEdit.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        cameraEyeEdit.removeAttribute('capture');
        requestAnimationFrame(() => {
          cameraEyeEdit.setAttribute('capture', '');
          cameraEyeEdit.value = '';
          setTimeout(() => {
            cameraEyeEdit.click();
          }, 50);
        });
      });
    }
  }
  
  // ÂàùÂßãÂåñÁõ∏Êú∫ÊãçÁÖßÂêåÊ≠•ÂäüËÉΩÂíåÊåâÈíÆ‰∫ã‰ª∂ÔºàÂª∂ËøüÊâßË°å‰ª•Á°Æ‰øùDOMÂ∑≤Âä†ËΩΩÔºâ
  setTimeout(() => {
    syncCameraToMain('c_body_photo_camera', 'c_body_photo');
    syncCameraToMain('c_eye_photo_camera', 'c_eye_photo');
    syncCameraToMain('e_body_photo_camera', 'e_body_photo');
    syncCameraToMain('e_eye_photo_camera', 'e_eye_photo');
    initCameraButtons();
  }, 100);

  // ============================================
  // üïäÔ∏è Evo Êô∫ËÉΩÂä©ÊâãÂäüËÉΩÔºàÊèêÂâçÂÆö‰πâÔºâ
  // ============================================
  
  const EvoAssistant = (function() {
    // Â≠òÂÇ®ÈîÆ
    const CHAT_HISTORY_KEY = 'evo_chat_history';
    const SETTINGS_KEY = 'evo_settings';
    const GREETING_STORAGE_KEY = 'evo_has_greeted';
    const GREETING_SESSION_KEY = 'evo_greeting_session';
    const USED_GREETINGS_KEY = 'evo_used_greetings';
    
    // Ê¨¢ËøéÊ∂àÊÅØÂêéÁºÄÈÄâÈ°π
    const GREETING_SUFFIXES = [
      'ÂàÜÊûêÊï∞ÊçÆ',
      'Êü•ÁúãË°ÄÁªüÂÖ≥Á≥ª',
      'ÁªüËÆ°ÊØîËµõÊàêÁª©',
      'ÁÆ°ÁêÜÈ∏ΩÂ≠ê‰ø°ÊÅØ',
      'ÂàÜÊûêËÆ≠ÁªÉËÆ∞ÂΩï',
      'Êü•ÁúãËÉΩÂäõËØÑ‰º∞',
      'ËßÑÂàíÁπÅËÇ≤ÈÖçÂØπ',
      'ÁÆ°ÁêÜÂÅ•Â∫∑Ê°£Ê°à',
      'ÁîüÊàêÊï∞ÊçÆÊä•Ë°®',
      '‰ºòÂåñËÆ≠ÁªÉËÆ°Âàí',
      'ÂàÜÊûêËµõ‰∫ãË°®Áé∞',
      'ËøΩË∏™Ë°ÄÁªüÂõæË∞±',
      'ËØÑ‰º∞Á´ûÁøîËÉΩÂäõ',
      'Âà∂ÂÆöÁπÅËÇ≤Á≠ñÁï•',
      'ÁõëÊéßÂÅ•Â∫∑Áä∂ÊÄÅ'
    ];
    
    // Áä∂ÊÄÅ
    let isExpanded = false;
    let activeTab = 'chat';
    let messages = [];
    let isTyping = false;
    let autoCloseTimer = null;
    let userInteractionTimer = null;
    let hasShownGreetingThisPageLoad = false; // ËÆ∞ÂΩïÂΩìÂâçÈ°µÈù¢Âä†ËΩΩÊó∂ÊòØÂê¶Â∑≤ÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ
    const AUTO_CLOSE_DELAY = 5000; // Êú™‰∫§‰∫íÊó∂5ÁßíÂêéÂÖ≥Èó≠
    const USER_INACTIVITY_DELAY = 8000; // Áî®Êà∑Âú®ÂØπËØùÊ°ÜÂÜÖÊó†Êìç‰Ωú8ÁßíÂêéÂÖ≥Èó≠
    
    // DOM ÂÖÉÁ¥†
    let assistantEl, iconButton, dialog, messagesContainer, inputField, sendBtn;
    
    // ÂàùÂßãÂåñ
    function init() {
      try {
        createHTML();
        bindEvents();
        // ÂÖà‰∏çÂä†ËΩΩÂéÜÂè≤ÔºåÁ≠âÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØÂêéÂÜçÂÜ≥ÂÆöÊòØÂê¶Âä†ËΩΩ
        // loadHistory();
        loadSettings();
        
        // Á´ãÂç≥Á°Æ‰øùÂõæÊ†áÂèØËßÅ
        ensureIconVisible();
        
        // Âª∂ËøüÂÜçÊ¨°Á°Æ‰øùÔºàÁ°Æ‰øùDOMÂÆåÂÖ®Ê∏≤ÊüìÔºâ
        setTimeout(() => {
          ensureIconVisible();
        }, 100);
        
        setTimeout(() => {
          ensureIconVisible();
        }, 500);
        
        // ÂêØÂä®ÂÆöÊúüÊ£ÄÊü•Êú∫Âà∂ÔºåÁ°Æ‰øùÂõæÊ†áÂßãÁªàÂèØËßÅ
        startIconMonitor();
        
        // Âª∂ËøüÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØÔºàÁ°Æ‰øùÊâÄÊúâÂÖÉÁ¥†ÈÉΩÂ∑≤ÂàùÂßãÂåñÔºâ
        // Á°Æ‰øùÊØèÊ¨°È°µÈù¢Âä†ËΩΩÊó∂ÈÉΩÈáçÁΩÆÊ†áÂøó
        hasShownGreetingThisPageLoad = false;
        console.log('üîÑ [ÂàùÂßãÂåñ] ÈáçÁΩÆ hasShownGreetingThisPageLoad = false');
        
        // Âº∫Âà∂ÊòæÁ§∫ÂáΩÊï∞ÔºàÁõ¥Êé•Ë∞ÉÁî®ÔºåÁ°Æ‰øùÊ†áÂøóÂ∑≤ÈáçÁΩÆÔºâ
        const forceShowGreeting = () => {
          if (!document.body) {
            console.warn('‚ö†Ô∏è document.body ‰∏çÂ≠òÂú®');
            return false;
          }
          
          const existingBubble = document.getElementById('evoWelcomeBubble');
          if (existingBubble) {
            console.log('‚ÑπÔ∏è Ê∞îÊ≥°Â∑≤Â≠òÂú®ÔºåË∑≥Ëøá');
            return true;
          }
          
          console.log('‚úÖ [Âº∫Âà∂ÊòæÁ§∫] ÂáÜÂ§áË∞ÉÁî® showWelcomeGreeting');
          // Á°Æ‰øùÊ†áÂøóÂ∑≤ÈáçÁΩÆ
          hasShownGreetingThisPageLoad = false;
          // Áõ¥Êé•Ë∞ÉÁî®
          showWelcomeGreeting();
          return true;
        };
        
        // Âª∂Ëøü1.5ÁßíÂêéÁ¨¨‰∏ÄÊ¨°Â∞ùËØï
        setTimeout(() => {
          console.log('üîç [Âª∂Ëøü1.5s] Á¨¨‰∏ÄÊ¨°Â∞ùËØïÊòæÁ§∫');
          forceShowGreeting();
        }, 1500);
        
        // Âª∂Ëøü3ÁßíÂêéÁ¨¨‰∫åÊ¨°Â∞ùËØï
        setTimeout(() => {
          console.log('üîç [Âª∂Ëøü3s] Á¨¨‰∫åÊ¨°Â∞ùËØïÊòæÁ§∫');
          const existingBubble = document.getElementById('evoWelcomeBubble');
          if (!existingBubble) {
            forceShowGreeting();
          }
        }, 3000);
        
        // Âª∂Ëøü5ÁßíÂêéÊúÄÂêé‰∏ÄÊ¨°Â∞ùËØïÔºàÁ°Æ‰øù‰∏ÄÂÆöËÉΩÊòæÁ§∫Ôºâ
        setTimeout(() => {
          console.log('üîç [Âª∂Ëøü5s] ÊúÄÂêé‰∏ÄÊ¨°Âº∫Âà∂ÊòæÁ§∫');
          const existingBubble = document.getElementById('evoWelcomeBubble');
          if (!existingBubble) {
            hasShownGreetingThisPageLoad = false;
            showWelcomeGreeting();
          }
        }, 5000);
      } catch (error) {
        console.error('EvoÂàùÂßãÂåñÈîôËØØ:', error);
        // Âç≥‰ΩøÂá∫Èîô‰πüÂ∞ùËØïÂàõÂª∫ÂõæÊ†á
        setTimeout(() => {
          ensureIconVisible();
        }, 1000);
      }
    }
    
    // Á°Æ‰øùÂõæÊ†áÂèØËßÅÁöÑÂáΩÊï∞
    function ensureIconVisible() {
      try {
        let assistant = document.getElementById('evoAssistant');
        let icon = document.getElementById('evoIconButton');
        
        // Â¶ÇÊûúÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÈáçÊñ∞ÂàõÂª∫
        if (!assistant) {
          console.warn('EvoÂä©ÊâãÂÖÉÁ¥†‰∏¢Â§±ÔºåÊ≠£Âú®ÈáçÊñ∞ÂàõÂª∫...');
          try {
            createHTML();
            // ÈáçÊñ∞Ëé∑ÂèñÂÖÉÁ¥†ÂºïÁî®
            assistantEl = document.getElementById('evoAssistant');
            iconButton = document.getElementById('evoIconButton');
            assistant = assistantEl;
            icon = iconButton;
            if (assistant && icon) {
              bindEvents();
              console.log('‚úÖ EvoÂä©ÊâãÂÖÉÁ¥†Â∑≤ÈáçÊñ∞ÂàõÂª∫');
            }
          } catch (error) {
            console.error('ÈáçÊñ∞ÂàõÂª∫EvoÂä©ÊâãÂ§±Ë¥•:', error);
          }
        }
        
        if (assistant) {
          // Âº∫Âà∂ËÆæÁΩÆÂèØËßÅÊÄßÊ†∑Âºè
          assistant.style.cssText = `
            position: fixed !important;
            bottom: 30vh !important;
            right: 20px !important;
            z-index: 99999 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
          `;
          
          // Êõ¥Êñ∞ÂÖ®Â±ÄÂèòÈáè
          assistantEl = assistant;
        } else {
          console.error('‚ùå Êó†Ê≥ïÊâæÂà∞ÊàñÂàõÂª∫EvoÂä©ÊâãÂÖÉÁ¥†');
        }
        
        if (icon) {
          icon.style.cssText = `
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
          `;
          
          // Êõ¥Êñ∞ÂÖ®Â±ÄÂèòÈáè
          iconButton = icon;
        }
      } catch (error) {
        console.error('ensureIconVisibleÈîôËØØ:', error);
      }
    }
    
    // ÂêØÂä®ÂõæÊ†áÁõëÊéß
    function startIconMonitor() {
      // ÊØè3ÁßíÊ£ÄÊü•‰∏ÄÊ¨°ÂõæÊ†áÊòØÂê¶ÂèØËßÅ
      setInterval(() => {
        const assistant = document.getElementById('evoAssistant');
        const icon = document.getElementById('evoIconButton');
        
        // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®‰∏îÂèØËßÅ
        if (!assistant || !icon) {
          console.warn('Ê£ÄÊµãÂà∞EvoÂõæÊ†á‰∏¢Â§±ÔºåÊ≠£Âú®ÊÅ¢Â§ç...');
          ensureIconVisible();
          return;
        }
        
        // Ê£ÄÊü•ËÆ°ÁÆóÂêéÁöÑÊ†∑Âºè
        const computedStyle = window.getComputedStyle(assistant);
        const isVisible = computedStyle.display !== 'none' && 
                         computedStyle.visibility !== 'hidden' && 
                         parseFloat(computedStyle.opacity) > 0;
        
        if (!isVisible) {
          console.warn('Ê£ÄÊµãÂà∞EvoÂõæÊ†áË¢´ÈöêËóèÔºåÊ≠£Âú®ÊÅ¢Â§ç...');
          ensureIconVisible();
        }
      }, 3000);
      
      // ÁõëÂê¨DOMÂèòÂåñÔºåÂ¶ÇÊûúÂÖÉÁ¥†Ë¢´ÁßªÈô§ÂàôÊÅ¢Â§ç
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.removedNodes.forEach((node) => {
            if (node.id === 'evoAssistant' || (node.querySelector && node.querySelector('#evoAssistant'))) {
              console.warn('Ê£ÄÊµãÂà∞EvoÂä©ÊâãË¢´ÁßªÈô§ÔºåÊ≠£Âú®ÊÅ¢Â§ç...');
              setTimeout(() => {
                ensureIconVisible();
              }, 100);
            }
          });
        });
      });
      
      // ÂºÄÂßãËßÇÂØübodyÁöÑÂèòÂåñ
      if (document.body) {
        observer.observe(document.body, {
          childList: true,
          subtree: true
        });
      }
    }
    
    // ÂàõÂª∫HTMLÁªìÊûÑ
    function createHTML() {
      // Â¶ÇÊûúÂÖÉÁ¥†Â∑≤Â≠òÂú®ÔºåÂÖàÁßªÈô§
      const existing = document.getElementById('evoAssistant');
      if (existing) {
        existing.remove();
      }
      
      const html = `
        <div class="evo-assistant" id="evoAssistant">
          <div class="evo-icon-button" id="evoIconButton">
            <div class="evo-pigeon-icon">
              <span class="evo-icon">üïäÔ∏è</span>
              <div class="evo-pulse"></div>
            </div>
          </div>
          
          <div class="evo-dialog" id="evoDialog" style="display: none;">
            <div class="evo-header">
              <div class="evo-header-left">
                <span class="evo-icon-large">üïäÔ∏è</span>
                <div>
                  <h3 class="evo-title">Evo Êô∫ËÉΩÂä©Êâã</h3>
                  <p class="evo-subtitle" id="evoStatus">ÂáÜÂ§áÂ•Ω‰∏∫ÊÇ®ÊúçÂä°</p>
                </div>
              </div>
              <button class="evo-close-btn" id="evoCloseBtn">√ó</button>
            </div>
            
            <div class="evo-content">
              <div class="evo-tabs">
                <div class="evo-tab-headers">
                  <div class="evo-tab-header active" data-tab="chat">üí¨ ÂØπËØù</div>
                  <div class="evo-tab-header" data-tab="analytics">üìä Êï∞ÊçÆ</div>
                  <div class="evo-tab-header" data-tab="recommendations">‚ú® Êé®Ëçê</div>
                  <div class="evo-tab-header" data-tab="settings">‚öôÔ∏è ËÆæÁΩÆ</div>
                </div>
                
                <!-- ÂØπËØùÊ†áÁ≠æ -->
                <div class="evo-tab-content active" id="tabChat">
                  <div class="evo-chat-container">
                    <div class="evo-messages" id="evoMessages"></div>
                    <div class="evo-input-area">
                      <div class="evo-input-group">
                        <input type="text" class="evo-input" id="evoInput" placeholder="ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò...">
                        <button class="evo-send-btn" id="evoSendBtn">ÂèëÈÄÅ</button>
                      </div>
                      <div class="evo-quick-actions">
                        <button class="evo-quick-action-btn" data-action="stats">Êü•ÁúãÁªüËÆ°Êï∞ÊçÆ</button>
                        <button class="evo-quick-action-btn" data-action="pedigree">ÂàÜÊûêË°ÄÁªüÂÖ≥Á≥ª</button>
                        <button class="evo-quick-action-btn" data-action="races">ÊØîËµõËÆ∞ÂΩï</button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Êï∞ÊçÆÂàÜÊûêÊ†áÁ≠æ -->
                <div class="evo-tab-content" id="tabAnalytics">
                  <div class="evo-analytics" id="evoAnalytics">
                    <div class="evo-empty">ÊöÇÊó†ÂàÜÊûêÊä•Âëä</div>
                  </div>
                </div>
                
                <!-- Êô∫ËÉΩÊé®ËçêÊ†áÁ≠æ -->
                <div class="evo-tab-content" id="tabRecommendations">
                  <div class="evo-recommendations" id="evoRecommendations">
                    <div class="evo-empty">ÊöÇÊó†Êé®ËçêÂÜÖÂÆπ</div>
                  </div>
                </div>
                
                <!-- ËÆæÁΩÆÊ†áÁ≠æ -->
                <div class="evo-tab-content" id="tabSettings">
                  <div class="evo-settings">
                    <h4 style="margin-bottom: 15px;">üîó GitHub ËÅäÂ§©Êú∫Âô®‰∫∫ÈÖçÁΩÆ</h4>
                    <div style="margin-bottom: 15px;">
                      <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">‰ªìÂ∫ìÂú∞ÂùÄ</label>
                      <input type="text" id="githubRepo" placeholder="‰æãÂ¶Ç: username/repo-name" 
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                      <div style="font-size: 11px; color: #909399; margin-top: 4px;">Ê†ºÂºèÔºöÁî®Êà∑Âêç/‰ªìÂ∫ìÂêç</div>
                    </div>
                    <div style="margin-bottom: 15px;">
                      <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">Token</label>
                      <input type="password" id="githubToken" placeholder="GitHub Personal Access Token" 
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                      <div style="font-size: 11px; color: #909399; margin-top: 4px;">
                        <a href="https://github.com/settings/tokens" target="_blank" style="color: #409eff;">Ëé∑Âèñ Token</a>
                      </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                      <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: 500;">APIÁ´ØÁÇπÔºàÂèØÈÄâÔºâ</label>
                      <input type="text" id="githubApiEndpoint" placeholder="‰æãÂ¶Ç: https://your-app.vercel.app/api/chat" 
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                      <div style="font-size: 11px; color: #909399; margin-top: 4px;">Â¶ÇÊûúNext.jsÂ∫îÁî®Â∑≤ÈÉ®ÁΩ≤ÔºåÂèØÁõ¥Êé•ÊåáÂÆöAPIÁ´ØÁÇπ</div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                      <button id="btnSaveGitHubConfig" style="flex: 1; padding: 8px; background: #409eff; color: white; border: none; border-radius: 4px; cursor: pointer;">‰øùÂ≠òÈÖçÁΩÆ</button>
                      <button id="btnTestGitHubBot" style="flex: 1; padding: 8px; background: #67c23a; color: white; border: none; border-radius: 4px; cursor: pointer;">ÊµãËØïËøûÊé•</button>
                    </div>
                    <div id="githubConfigStatus" style="padding: 10px; background: #f0f9ff; border-radius: 4px; font-size: 12px; display: none;"></div>
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e4e7ed;">
                      <h4 style="margin-bottom: 10px; font-size: 14px;">üí° ‰ΩøÁî®ËØ¥Êòé</h4>
                      <div style="font-size: 12px; color: #606266; line-height: 1.6;">
                        <p>1. ÈÖçÁΩÆGitHub‰ªìÂ∫ìÂú∞ÂùÄÂíåTokenÂêéÔºåEvoÂ∞Ü‰ºòÂÖà‰ΩøÁî®ÊÇ®ÁöÑGitHubËÅäÂ§©Êú∫Âô®‰∫∫</p>
                        <p>2. Â¶ÇÊûúÊÇ®ÁöÑNext.jsÂ∫îÁî®Â∑≤ÈÉ®ÁΩ≤ÔºåÂèØÁõ¥Êé•ÊåáÂÆöAPIÁ´ØÁÇπ</p>
                        <p>3. Â¶ÇÊûúGitHubËÅäÂ§©Êú∫Âô®‰∫∫‰∏çÂèØÁî®ÔºåÂ∞ÜËá™Âä®‰ΩøÁî®Êú¨Âú∞ÈÄªËæë</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', html);
      
      // Ëé∑ÂèñDOMÂÖÉÁ¥†
      assistantEl = document.getElementById('evoAssistant');
      iconButton = document.getElementById('evoIconButton');
      dialog = document.getElementById('evoDialog');
      messagesContainer = document.getElementById('evoMessages');
      inputField = document.getElementById('evoInput');
      sendBtn = document.getElementById('evoSendBtn');
      
      // Á°Æ‰øùÂõæÊ†áÊåâÈíÆÂèØËßÅÔºàÂº∫Âà∂ËÆæÁΩÆÔºâ
      if (assistantEl) {
        assistantEl.style.cssText = `
          position: fixed !important;
          bottom: 30vh !important;
          right: 20px !important;
          z-index: 99999 !important;
          display: block !important;
          visibility: visible !important;
          opacity: 1 !important;
          pointer-events: auto !important;
        `;
      }
      
      if (iconButton) {
        iconButton.style.cssText = `
          display: flex !important;
          visibility: visible !important;
          opacity: 1 !important;
          pointer-events: auto !important;
        `;
      }
      
      // Á´ãÂç≥Ê£ÄÊü•Âπ∂Á°Æ‰øùÂèØËßÅ
      setTimeout(() => {
        const checkAssistant = document.getElementById('evoAssistant');
        const checkIcon = document.getElementById('evoIconButton');
        if (checkAssistant) {
          checkAssistant.style.cssText = `
            position: fixed !important;
            bottom: 30vh !important;
            right: 20px !important;
            z-index: 99999 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
          `;
        }
        if (checkIcon) {
          checkIcon.style.cssText = `
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
          `;
        }
      }, 50);
    }
    
    // ÁªëÂÆö‰∫ã‰ª∂
    function bindEvents() {
      if (!iconButton) {
        console.error('EvoÂõæÊ†áÊåâÈíÆÊú™ÊâæÂà∞');
        return;
      }
      iconButton.addEventListener('click', toggleExpanded);
      const closeBtn = document.getElementById('evoCloseBtn');
      if (closeBtn) {
        closeBtn.addEventListener('click', toggleExpanded);
      }
      
      sendBtn.addEventListener('click', sendMessage);
      inputField.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !isTyping) {
          sendMessage();
        }
      });
      
      // Ê†áÁ≠æÂàáÊç¢
      document.querySelectorAll('.evo-tab-header').forEach(header => {
        header.addEventListener('click', () => {
          const tab = header.dataset.tab;
          switchTab(tab);
          resetAutoCloseTimer(); // ÂàáÊç¢Ê†áÁ≠æÊó∂ÈáçÁΩÆÂÆöÊó∂Âô®
        });
      });
      
      // Âø´ÈÄüÊìç‰Ωú
      document.querySelectorAll('.evo-quick-action-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const action = btn.dataset.action;
          handleQuickAction(action);
          resetAutoCloseTimer(); // ÁÇπÂáªÂø´Êç∑Êìç‰ΩúÊó∂ÈáçÁΩÆÂÆöÊó∂Âô®
        });
      });
      
      // ÈáçÁΩÆËá™Âä®ÂÖ≥Èó≠ÂÆöÊó∂Âô®ÔºàÈº†Ê†áÁßªÂä®ÂíåÁÇπÂáªÊó∂Ôºâ
      if (dialog) {
        dialog.addEventListener('click', () => {
          // ÁÇπÂáªÂØπËØùÊ°ÜÊó∂ÈáçÁΩÆÂÆöÊó∂Âô®Ôºå‰ΩÜ‰∏çÂêØÂä®ÂàùÂßãÂÖ≥Èó≠ÂÆöÊó∂Âô®ÔºàÂ¶ÇÊûúÁî®Êà∑Â∑≤Áªè‰∫§‰∫íËøáÔºâ
          if (hasUserInteraction()) {
            resetAutoCloseTimer();
          }
        });
        
        // ËæìÂÖ•Ê°ÜËæìÂÖ•Êó∂ÈáçÁΩÆÂÆöÊó∂Âô®
        if (inputField) {
          inputField.addEventListener('input', resetAutoCloseTimer);
          inputField.addEventListener('keydown', resetAutoCloseTimer);
          inputField.addEventListener('focus', resetAutoCloseTimer);
        }
      }
    }
    
    // ÂàáÊç¢Â±ïÂºÄ/Êî∂Ëµ∑
    function toggleExpanded() {
      isExpanded = !isExpanded;
      if (dialog) {
        dialog.style.display = isExpanded ? 'flex' : 'none';
      }
      
      if (isExpanded) {
        loadHistory();
        if (typeof generateRecommendations === 'function') {
          generateRecommendations();
        }
        // Âè™ÊúâÂú®Áî®Êà∑Ê≤°Êúâ‰∫§‰∫íÊó∂ÊâçÂêØÂä®ÂàùÂßãËá™Âä®ÂÖ≥Èó≠ÂÆöÊó∂Âô®
        if (!hasUserInteraction()) {
          startAutoCloseTimer();
        } else {
          // Â¶ÇÊûúÁî®Êà∑Â∑≤Áªè‰∫§‰∫íËøáÔºåÂêØÂä®Êó†Êìç‰ΩúÂÆöÊó∂Âô®
          startUserInactivityTimer();
        }
      } else {
        clearAutoCloseTimer();
      }
    }
    
    // ÂàáÊç¢Ê†áÁ≠æ
    function switchTab(tab) {
      activeTab = tab;
      
      // Êõ¥Êñ∞Ê†áÁ≠æÂ§¥ÈÉ®
      document.querySelectorAll('.evo-tab-header').forEach(h => {
        h.classList.toggle('active', h.dataset.tab === tab);
      });
      
      // Êõ¥Êñ∞Ê†áÁ≠æÂÜÖÂÆπ
      document.querySelectorAll('.evo-tab-content').forEach(c => {
        c.classList.toggle('active', c.id === `tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
      });
    }
    
    // ÂèëÈÄÅÊ∂àÊÅØ
    async function sendMessage() {
      const text = inputField.value.trim();
      if (!text || isTyping) return;
      
      // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
      addMessage('user', text);
      inputField.value = '';
      
      // Ê∏ÖÈô§ÂàùÂßãËá™Âä®ÂÖ≥Èó≠ÂÆöÊó∂Âô®ÔºåÂêØÂä®Áî®Êà∑Êó†Êìç‰ΩúÂÆöÊó∂Âô®
      clearAutoCloseTimer();
      startUserInactivityTimer();
      
      // EvoÂõûÂ§ç
      isTyping = true;
      updateStatus('Ê≠£Âú®ÊÄùËÄÉ...');
      
      try {
        const response = await chat(text);
        addMessage('evo', response.text);
        saveHistory();
      } catch (error) {
        addMessage('evo', 'Êä±Ê≠âÔºåÊàëÊöÇÊó∂Êó†Ê≥ïÂìçÂ∫îÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ');
        console.error('Evo chat error:', error);
      } finally {
        isTyping = false;
        updateStatus('Âú®Á∫ø');
        // ÈáçÁΩÆÊó†Êìç‰ΩúÂÆöÊó∂Âô®
        resetAutoCloseTimer();
      }
    }
    
    // GitHubÈÖçÁΩÆ
    const GITHUB_CONFIG_KEY = 'evo_github_config';
    let githubConfig = null;
    
    // Âä†ËΩΩGitHubÈÖçÁΩÆ
    function loadGitHubConfig() {
      try {
        const config = localStorage.getItem(GITHUB_CONFIG_KEY);
        if (config) {
          githubConfig = JSON.parse(config);
        }
      } catch (error) {
        console.error('Failed to load GitHub config:', error);
      }
    }
    
    // Ê£ÄÊü•GitHubÊòØÂê¶ÈÖçÁΩÆ
    function isGitHubConfigured() {
      return githubConfig && githubConfig.repo && githubConfig.token;
    }
    
    // ‰ΩøÁî®GitHubËÅäÂ§©Êú∫Âô®‰∫∫
    async function chatWithGitHubBot(question, history = [], context = {}) {
      if (!isGitHubConfigured()) {
        return null;
      }
      
      try {
        const [owner, repo] = githubConfig.repo.split('/');
        const apiPaths = [];
        
        // Â¶ÇÊûúÁî®Êà∑ÊåáÂÆö‰∫ÜAPIÁ´ØÁÇπÔºå‰ºòÂÖà‰ΩøÁî®
        if (githubConfig.apiEndpoint) {
          apiPaths.push(githubConfig.apiEndpoint);
        }
        
        // Â∞ùËØïNext.jsÂ∫îÁî®Á´ØÁÇπ
        const isNextJSRepo = repo.toLowerCase().includes('nextjs') || repo.toLowerCase().includes('next');
        if (isNextJSRepo) {
          apiPaths.push(`https://${repo}.vercel.app/api/chat`);
          apiPaths.push(`https://${owner}-${repo}.vercel.app/api/chat`);
          if (repo.includes('nextjs-ai')) {
            apiPaths.push(`https://${repo.replace(/nextjs-ai-/, '')}.vercel.app/api/chat`);
          }
        }
        
        // GitHub PagesÁ´ØÁÇπ
        apiPaths.push(`https://${owner}.github.io/${repo}/api/chat`);
        
        // Â∞ùËØïÊâÄÊúâAPIÁ´ØÁÇπ
        for (const apiPath of apiPaths) {
          try {
            const response = await fetch(apiPath, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                ...(githubConfig.token ? { 'Authorization': `Bearer ${githubConfig.token}` } : {})
              },
              body: JSON.stringify({
                question: question,
                message: question,
                history: history,
                context: context,
                messages: history.map(msg => ({
                  role: msg.type === 'user' ? 'user' : 'assistant',
                  content: msg.text
                }))
              })
            });

            if (response.ok) {
              const data = await response.json();
              let responseText = data.response || data.text || data.answer || data.message || data.content;
              
              if (data.choices && data.choices[0] && data.choices[0].message) {
                responseText = data.choices[0].message.content;
              }
              
              if (responseText) {
                return { text: responseText, data: data.data || data };
              }
            }
          } catch (e) {
            continue;
          }
        }
      } catch (error) {
        console.error('GitHub chatbot error:', error);
      }
      
      return null;
    }
    
    // ‰ΩøÁî®ÂêéÁ´ØAPIËÅäÂ§©
    async function chatWithBackendAPI(question, history = []) {
      const API_URL = window.API_URL || 'http://localhost:3000';
      const token = localStorage.getItem('token');
      
      if (!token) {
        return null;
      }
      
      try {
        const response = await fetch(`${API_URL}/api/evo/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            question: question,
            history: history
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.data) {
            return { text: data.data.text || data.data.response, data: data.data };
          }
        }
      } catch (error) {
        console.error('Backend API chat error:', error);
      }
      
      return null;
    }
    
    // Ëé∑ÂèñÂäüËÉΩ‰ΩøÁî®ËØ¥ÊòéÔºà‰ªéÂêéÂè∞ËÆæÁΩÆÔºâ
    function getFunctionGuide(question) {
      // Ëé∑ÂèñÂΩìÂâçEvoËÆæÁΩÆ
      const currentEvoSettings = window.getEvoSettings ? window.getEvoSettings() : (evoSettings || {});
      const functionGuides = currentEvoSettings.functionGuides || {};
      const lowerQuestion = question.toLowerCase();
      
      // Ê£ÄÊü•ÊòØÂê¶ËØ¢ÈóÆÂäüËÉΩ‰ΩøÁî®ÊñπÊ≥ï
      if (lowerQuestion.includes('Â¶Ç‰Ωï‰ΩøÁî®') || lowerQuestion.includes('ÊÄé‰πàÁî®') || 
          lowerQuestion.includes('‰ΩøÁî®ÊñπÊ≥ï') || lowerQuestion.includes('ÂäüËÉΩËØ¥Êòé') ||
          lowerQuestion.includes('Â∏ÆÂä©') || lowerQuestion.includes('ÊïôÁ®ã')) {
        
        // Ê£ÄÊü•ÂÖ∑‰ΩìËØ¢ÈóÆÂì™‰∏™ÂäüËÉΩ
        for (const [funcName, guide] of Object.entries(functionGuides)) {
          if (lowerQuestion.includes(funcName.toLowerCase()) || 
              lowerQuestion.includes(funcName.replace('‰∏é', '').toLowerCase())) {
            let response = `üìñ **${funcName}ÂäüËÉΩ‰ΩøÁî®ËØ¥Êòé**\n\n${guide.description}\n\n**‰∏ªË¶ÅÂäüËÉΩÔºö**\n`;
            guide.features.forEach(feature => {
              response += `${feature}\n`;
            });
            response += `\nüí° **‰ΩøÁî®ÊèêÁ§∫**ÔºöÁÇπÂáªÂ∑¶‰æßËèúÂçïÊ†èÁöÑ"${funcName}"Âç≥ÂèØËøõÂÖ•ËØ•ÂäüËÉΩÈ°µÈù¢„ÄÇ`;
            return response;
          }
        }
        
        // Â¶ÇÊûúÊ≤°ÊúâÊåáÂÆöÂäüËÉΩÔºåËøîÂõûÊâÄÊúâÂäüËÉΩÂàóË°®
        if (Object.keys(functionGuides).length > 0) {
          let response = 'üìö **Êô∫È∏ΩÁ≥ªÁªüÂäüËÉΩ‰ΩøÁî®ËØ¥Êòé**\n\nÁ≥ªÁªüÂåÖÂê´‰ª•‰∏ã‰∏ªË¶ÅÂäüËÉΩÊ®°ÂùóÔºö\n\n';
          Object.keys(functionGuides).forEach((funcName, index) => {
            response += `${index + 1}. **${funcName}**Ôºö${functionGuides[funcName].description}\n`;
          });
          response += '\nüí° **‰ΩøÁî®ÊèêÁ§∫**Ôºö\n';
          response += '‚Ä¢ ÊÇ®ÂèØ‰ª•ËØ¢ÈóÆÂÖ∑‰ΩìÂäüËÉΩÁöÑ‰ΩøÁî®ÊñπÊ≥ïÔºå‰æãÂ¶ÇÔºö"Â¶Ç‰Ωï‰ΩøÁî®È∏ΩÂ≠êÁÆ°ÁêÜ"„ÄÅ"Êï∞ÊçÆÊ¶ÇËßàÊÄé‰πàÁî®"\n';
          response += '‚Ä¢ ÁÇπÂáªÂ∑¶‰æßËèúÂçïÊ†èÂèØ‰ª•ÂàáÊç¢‰∏çÂêåÁöÑÂäüËÉΩÊ®°Âùó\n';
          response += '‚Ä¢ ÊØè‰∏™ÂäüËÉΩÈ°µÈù¢ÈÉΩÊúâÁõ∏Â∫îÁöÑÊìç‰ΩúÊåâÈíÆÂíåËØ¥Êòé\n';
          response += '‚Ä¢ Â¶ÇÊúâÁñëÈóÆÔºåÈöèÊó∂ÂèØ‰ª•ÈóÆÊàëÔºÅ';
          return response;
        }
      }
      
      return null;
    }
    
    // Ëé∑ÂèñÁΩëÈ°µÊï∞ÊçÆ‰ø°ÊÅØ
    async function getWebPageData() {
      try {
        const pigeons = await loadPigeons();
        const races = await loadRaces();
        const pigeonList = Array.isArray(pigeons) ? pigeons : (pigeons.pigeons || []);
        const raceList = Array.isArray(races) ? races : (races.races || []);
        
        return {
          totalPigeons: pigeonList.length,
          alivePigeons: pigeonList.filter(p => p.status !== 'dead' && p.status !== 'Â∑≤Ê≠ª‰∫°').length,
          deadPigeons: pigeonList.filter(p => p.status === 'dead' || p.status === 'Â∑≤Ê≠ª‰∫°').length,
          breeders: pigeonList.filter(p => p.type === 'ÁßçÈ∏Ω' || p.tags?.includes('Ê†∏ÂøÉÁßçÈ∏Ω')).length,
          racesCount: raceList.length,
          activeRaces: raceList.filter(r => r.status === 'ongoing').length,
          completedRaces: raceList.filter(r => r.status === 'completed').length,
          pigeons: pigeonList.slice(0, 10), // Âè™ËøîÂõûÂâç10Âè™ÔºåÈÅøÂÖçÊï∞ÊçÆËøáÂ§ß
          races: raceList.slice(0, 10) // Âè™ËøîÂõûÂâç10Êù°
        };
      } catch (error) {
        console.error('Ëé∑ÂèñÁΩëÈ°µÊï∞ÊçÆÂ§±Ë¥•:', error);
        return null;
      }
    }
    
    // ÂØπËØùÂäüËÉΩÔºàÂ¢ûÂº∫Áâà - ‰ºòÂÖàAIÔºåÁªìÂêà‰ΩøÁî®ËØ¥ÊòéÂíåÁΩëÈ°µÊï∞ÊçÆÔºâ
    async function chat(question) {
      // Âä†ËΩΩGitHubÈÖçÁΩÆ
      loadGitHubConfig();
      
      // Ëé∑ÂèñÂØπËØùÂéÜÂè≤
      const history = messages.map(msg => ({
        type: msg.type,
        text: msg.text,
        time: msg.time
      }));
      
      // Ëé∑ÂèñÂäüËÉΩ‰ΩøÁî®ËØ¥Êòé
      const guideAnswer = getFunctionGuide(question);
      
      // Ëé∑ÂèñÁΩëÈ°µÊï∞ÊçÆ‰ø°ÊÅØ
      const webData = await getWebPageData();
      
      // Ëé∑ÂèñÂΩìÂâçEvoËÆæÁΩÆÔºà‰ªéÂÖ®Â±ÄÂáΩÊï∞ÊàñlocalStorageÔºâ
      const currentEvoSettings = window.getEvoSettings ? window.getEvoSettings() : (evoSettings || {});
      
      // ÊûÑÂª∫‰∏ä‰∏ãÊñá‰ø°ÊÅØ
      const context = {
        ...(webData || {}),
        functionGuides: currentEvoSettings.functionGuides || {},
        currentGuide: guideAnswer || null
      };
      
      // ÊûÑÂª∫Â¢ûÂº∫ÁöÑÈóÆÈ¢òÔºàÂåÖÂê´‰ΩøÁî®ËØ¥ÊòéÂíåÁΩëÈ°µÊï∞ÊçÆÔºâ
      let enhancedQuestion = question;
      if (guideAnswer) {
        enhancedQuestion += `\n\n„ÄêÁ≥ªÁªüÂäüËÉΩËØ¥ÊòéÂèÇËÄÉ„Äë\n${guideAnswer}`;
      }
      if (webData) {
        enhancedQuestion += `\n\n„ÄêÂΩìÂâçÁ≥ªÁªüÊï∞ÊçÆ„Äë\nÊÄªÈ∏ΩÂ≠êÊï∞Ôºö${webData.totalPigeons}ÔºåÂú®‰∏ñÔºö${webData.alivePigeons}ÔºåÁßçÈ∏ΩÔºö${webData.breeders}ÔºåÊØîËµõËÆ∞ÂΩïÔºö${webData.racesCount}Êù°`;
      }
      
      // ‰ºòÂÖàÁ∫ß1ÔºöÁõ¥Êé•Ë∞ÉÁî®Êô∫Ë∞±APIÔºàÈÄöËøázhipu-api-proxyÔºâ
      try {
        // Â∞ùËØïÈÄöËøázhipu-api-proxyË∞ÉÁî®Êô∫Ë∞±API
        if (window.ZhipuAPIProxy) {
          const historyForAPI = history.map(msg => ({
            role: msg.type === 'user' ? 'user' : 'assistant',
            content: msg.text
          }));
          
          const result = await window.ZhipuAPIProxy.call(enhancedQuestion, historyForAPI, null, 3);
          if (result && result.content && result.content.length > 10) {
            return { text: result.content };
          }
        }
        
        // Â¶ÇÊûúproxy‰∏çÂèØÁî®ÔºåÂ∞ùËØïÁõ¥Êé•Ë∞ÉÁî®Êô∫Ë∞±APIÔºà‰ªélocalStorageËé∑ÂèñAPI KeyÔºâ
        const config = localStorage.getItem('pigeon_api_config');
        if (config) {
          const parsed = JSON.parse(config);
          const apiKey = parsed.zhipuApiKeyEvo || parsed.zhipuApiKeyAdmin || '';
          
          if (apiKey) {
            const historyForAPI = history.map(msg => ({
              role: msg.type === 'user' ? 'user' : 'assistant',
              content: msg.text
            }));
            historyForAPI.push({ role: 'user', content: enhancedQuestion });
            
            const response = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
              },
              body: JSON.stringify({
                model: parsed.zhipuModel || 'glm-4',
                messages: historyForAPI,
                temperature: parsed.zhipuTemperature !== undefined ? parsed.zhipuTemperature : 0.7,
                max_tokens: parsed.zhipuMaxTokens || 2000
              })
            });
            
            if (response.ok) {
              const data = await response.json();
              const content = data.choices?.[0]?.message?.content || '';
              if (content && content.length > 10) {
                return { text: content };
              }
            }
          }
        }
      } catch (error) {
        console.warn('Êô∫Ë∞±APIË∞ÉÁî®Â§±Ë¥•ÔºåÂ∞ùËØïÂÖ∂‰ªñÊñπÂºè:', error);
      }
      
      // ‰ºòÂÖàÁ∫ß1.5ÔºöÂ∞ùËØï‰ΩøÁî®ÂêéÁ´ØAI APIÔºàÂ¶ÇÊûúÊô∫Ë∞±API‰∏çÂèØÁî®Ôºâ
      try {
        const API_URL = window.API_URL || 'http://localhost:3000';
        const response = await fetch(`${API_URL}/api/ai/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            question: enhancedQuestion,
            context: context,
            history: history
          })
        });

        if (response.ok) {
          const data = await response.json();
          const aiAnswer = data.text || data.answer || '';
          
          // Â¶ÇÊûúAIÂõûÁ≠îÊúâÊïàÔºåÁõ¥Êé•ËøîÂõû
          if (aiAnswer && aiAnswer.length > 10) {
            return { text: aiAnswer };
          }
        }
      } catch (error) {
        console.warn('ÂêéÁ´ØAI APIË∞ÉÁî®Â§±Ë¥•Ôºå‰ΩøÁî®Êú¨Âú∞ÈÄªËæë:', error);
      }
      
      // ‰ºòÂÖàÁ∫ß2ÔºöÂ∞ùËØï‰ΩøÁî®GitHubËÅäÂ§©Êú∫Âô®‰∫∫
      if (isGitHubConfigured()) {
        try {
          const githubResponse = await chatWithGitHubBot(enhancedQuestion, history, context);
          if (githubResponse && githubResponse.text) {
            return githubResponse;
          }
        } catch (error) {
          console.warn('GitHub chatbot failed, using fallback:', error);
        }
      }
      
      // ‰ºòÂÖàÁ∫ß3ÔºöÂ∞ùËØï‰ΩøÁî®ÂêéÁ´ØAPI
      try {
        const apiResponse = await chatWithBackendAPI(enhancedQuestion, history);
        if (apiResponse && apiResponse.text) {
          return apiResponse;
        }
      } catch (error) {
        console.warn('Backend API failed, using local logic:', error);
      }
      
      // ‰ºòÂÖàÁ∫ß4Ôºö‰ΩøÁî®Êú¨Âú∞ÈÄªËæëÔºàÊó†ÁΩëÁªúÊó∂Ôºâ
      // Â¶ÇÊûúÊúâÂäüËÉΩËØ¥ÊòéÔºå‰ºòÂÖàËøîÂõûÂäüËÉΩËØ¥Êòé
      if (guideAnswer) {
        return { text: guideAnswer };
      }
      
      const q = question.toLowerCase();
      
      // ÁªüËÆ°Êï∞ÊçÆÔºàÁªìÂêàÁΩëÈ°µÊï∞ÊçÆÔºâ
      if (q.includes('ÁªüËÆ°') || q.includes('Êï∞ÊçÆ') || q.includes('ÊÄªÊï∞')) {
        return handleStatsQuestion(webData);
      }
      
      // È∏ΩÂ≠ê‰ø°ÊÅØÔºàÁªìÂêàÁΩëÈ°µÊï∞ÊçÆÔºâ
      if (q.includes('È∏ΩÂ≠ê') || q.includes('‰ø°È∏Ω')) {
        return handlePigeonQuestion(question, webData);
      }
      
      // Ë°ÄÁªüÂÖ≥Á≥ªÔºàÁªìÂêàÁΩëÈ°µÊï∞ÊçÆÔºâ
      if (q.includes('Ë°ÄÁªü') || q.includes('Áà∂ÊØç') || q.includes('Â≠ê‰ª£')) {
        return handlePedigreeQuestion(webData);
      }
      
      // ÊØîËµõËÆ∞ÂΩïÔºàÁªìÂêàÁΩëÈ°µÊï∞ÊçÆÔºâ
      if (q.includes('ÊØîËµõ') || q.includes('ÊàêÁª©')) {
        return handleRaceQuestion(webData);
      }
      
      // ÈóÆÂÄô
      if (q.includes('‰Ω†Â•Ω') || q.includes('hello') || q.includes('hi') || q.includes('Â∏ÆÂä©')) {
        return handleGreetingQuestion();
      }
      
      // ÈªòËÆ§ÂõûÁ≠î
      return {
        text: `ÊàëÁêÜËß£ÊÇ®ÁöÑÈóÆÈ¢òÔºö"${question}"\n\n` +
              `ÁõÆÂâçÊàëÂèØ‰ª•Â∏ÆÊÇ®Ôºö\n` +
              `‚Ä¢ Êü•ÁúãÁ≥ªÁªüÁªüËÆ°Êï∞ÊçÆ\n` +
              `‚Ä¢ Êü•ÊâæÈ∏ΩÂ≠ê‰ø°ÊÅØ\n` +
              `‚Ä¢ ÂàÜÊûêË°ÄÁªüÂÖ≥Á≥ª\n` +
              `‚Ä¢ Êü•ÁúãÊØîËµõËÆ∞ÂΩï\n` +
              `‚Ä¢ ËØ¢ÈóÆÂäüËÉΩ‰ΩøÁî®ÊñπÊ≥ï\n\n` +
              `ËØ∑ÂëäËØâÊàëÊÇ®ÂÖ∑‰ΩìÈúÄË¶Å‰ªÄ‰πàÂ∏ÆÂä©Ôºü`
      };
    }
    
    // Â§ÑÁêÜÁªüËÆ°Êï∞ÊçÆÈóÆÈ¢òÔºà‰ΩøÁî®ÁΩëÈ°µÊï∞ÊçÆÔºâ
    function handleStatsQuestion(webData) {
      if (!webData) {
        return { text: 'Êó†Ê≥ïËé∑ÂèñÁªüËÆ°Êï∞ÊçÆÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•„ÄÇ' };
      }
      
      const total = webData.totalPigeons || 0;
      const alive = webData.alivePigeons || 0;
      const dead = webData.deadPigeons || 0;
      const breeders = webData.breeders || 0;
      const racesCount = webData.racesCount || 0;
      
      const aliveRate = total > 0 ? ((alive / total) * 100).toFixed(1) : 0;
      const breederRate = total > 0 ? ((breeders / total) * 100).toFixed(1) : 0;
      
      return {
        text: `üìä Á≥ªÁªüÁªüËÆ°Êï∞ÊçÆÔºö\n\n` +
              `üïäÔ∏è ÊÄªÈ∏ΩÂ≠êÊï∞Ôºö${total}\n` +
              `‚úÖ Âú®‰∏ñÈ∏ΩÂ≠êÔºö${alive}\n` +
              `üíî Â∑≤Ê≠ª‰∫°Ôºö${dead}\n` +
              `‚≠ê ÁßçÈ∏ΩÊï∞ÈáèÔºö${breeders}\n` +
              `üèÜ ÊØîËµõËÆ∞ÂΩïÔºö${racesCount}Êù°\n` +
              `üèÅ ËøõË°å‰∏≠Ëµõ‰∫ãÔºö${webData.activeRaces || 0}‰∏™\n` +
              `‚úÖ Â∑≤ÂÆåÊàêËµõ‰∫ãÔºö${webData.completedRaces || 0}‰∏™\n\n` +
              `üìà Êï∞ÊçÆÂàÜÊûêÔºö\n` +
              `‚Ä¢ Âú®‰∏ñÁéáÔºö${aliveRate}%\n` +
              `‚Ä¢ ÁßçÈ∏ΩÂç†ÊØîÔºö${breederRate}%\n\n` +
              `ÈúÄË¶ÅÊü•ÁúãÊõ¥ËØ¶ÁªÜÁöÑ‰ø°ÊÅØÂêóÔºü`
      };
    }
    
    // Â§ÑÁêÜÈ∏ΩÂ≠êÈóÆÈ¢òÔºà‰ΩøÁî®ÁΩëÈ°µÊï∞ÊçÆÔºâ
    function handlePigeonQuestion(question, webData) {
      if (!webData || !webData.pigeons) {
        return { text: 'Êó†Ê≥ïËé∑ÂèñÈ∏ΩÂ≠êÊï∞ÊçÆÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•„ÄÇ' };
      }
      
      // Â∞ùËØïÊèêÂèñË∂≥ÁéØÂè∑
      const ringMatch = question.match(/(\d{4}[-\s]?\d{3,})|(CHN\d{4}[-\s]?\d{3,})/i);
      if (ringMatch) {
        const ring = ringMatch[0].replace(/\s/g, '');
        const pigeon = webData.pigeons.find(p => {
          const pRing = (p.ring || '').replace(/\s/g, '');
          return pRing === ring || pRing.includes(ring) || ring.includes(pRing);
        });
        
        if (pigeon) {
          const raceCount = pigeon.races ? pigeon.races.length : 0;
          return {
            text: `üïäÔ∏è ÊâæÂà∞È∏ΩÂ≠ê‰ø°ÊÅØÔºö\n\n` +
                  `Ë∂≥ÁéØÂè∑Ôºö${pigeon.ring || '-'}\n` +
                  `ÂêçÂ≠óÔºö${pigeon.name || 'Êú™ÂëΩÂêç'}\n` +
                  `ÊÄßÂà´Ôºö${pigeon.gender || 'Êú™Áü•'}\n` +
                  `Á±ªÂûãÔºö${pigeon.type || 'Êú™Áü•'}\n` +
                  `Áä∂ÊÄÅÔºö${pigeon.status === 'dead' || pigeon.status === 'Â∑≤Ê≠ª‰∫°' ? 'Â∑≤Ê≠ª‰∫°' : 'Âú®‰∏ñ'}\n` +
                  (pigeon.birthDate ? `Âá∫ÁîüÊó•ÊúüÔºö${pigeon.birthDate}\n` : '') +
                  (pigeon.father || pigeon.fatherRing ? `Áà∂È∏ΩÔºö${pigeon.father || pigeon.fatherRing}\n` : '') +
                  (pigeon.mother || pigeon.motherRing ? `ÊØçÈ∏ΩÔºö${pigeon.mother || pigeon.motherRing}\n` : '') +
                  `ÂèÇËµõËÆ∞ÂΩïÔºö${raceCount}Ê¨°\n\n` +
                  `ÈúÄË¶ÅÊü•ÁúãËøôÂè™È∏ΩÂ≠êÁöÑËØ¶ÁªÜËµÑÊñôÂêóÔºü`
          };
        }
      }
      
      // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÂÖ∑‰ΩìÈ∏ΩÂ≠êÔºåËøîÂõûÁªüËÆ°‰ø°ÊÅØ
      return {
        text: `üìä È∏ΩÂ≠ê‰ø°ÊÅØÁªüËÆ°Ôºö\n\n` +
              `ÊÄªÈ∏ΩÂ≠êÊï∞Ôºö${webData.totalPigeons || 0}\n` +
              `Âú®‰∏ñÔºö${webData.alivePigeons || 0}\n` +
              `ÁßçÈ∏ΩÔºö${webData.breeders || 0}\n\n` +
              `üí° ÊèêÁ§∫ÔºöËØ∑Êèê‰æõÈ∏ΩÂ≠êÁöÑË∂≥ÁéØÂè∑ÔºåÊàëÂèØ‰ª•Â∏ÆÊÇ®Êü•ÊâæÁõ∏ÂÖ≥‰ø°ÊÅØ„ÄÇ\n` +
              `‰æãÂ¶ÇÔºö"Êü•ÁúãÈ∏ΩÂ≠ê CHN2025-0001" Êàñ "Êü•Êâæ 2025-001"`
      };
    }
    
    // Â§ÑÁêÜË°ÄÁªüÈóÆÈ¢òÔºà‰ΩøÁî®ÁΩëÈ°µÊï∞ÊçÆÔºâ
    function handlePedigreeQuestion(webData) {
      if (!webData || !webData.pigeons) {
        return { text: 'Êó†Ê≥ïËé∑ÂèñË°ÄÁªüÊï∞ÊçÆÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•„ÄÇ' };
      }
      
      const total = webData.totalPigeons || 0;
      const withParents = webData.pigeons.filter(p => (p.father || p.fatherRing || p.mother || p.motherRing)).length;
      
      return {
        text: `üìä Ë°ÄÁªüÂÖ≥Á≥ªÂàÜÊûêÔºö\n\n` +
              `ÊÄªÈ∏ΩÂ≠êÊï∞Ôºö${total}\n` +
              `ÊúâË°ÄÁªüËÆ∞ÂΩïÁöÑÔºö${withParents}Âè™\n` +
              `Ë°ÄÁªüÂÆåÊï¥ÁéáÔºö${total > 0 ? ((withParents / total) * 100).toFixed(1) : 0}%\n\n` +
              `ÊàëÂèØ‰ª•Â∏ÆÊÇ®Ôºö\n` +
              `‚Ä¢ Êü•ÁúãÈ∏ΩÂ≠êÁöÑÁà∂ÊØç‰ø°ÊÅØ\n` +
              `‚Ä¢ Êü•ÁúãÈ∏ΩÂ≠êÁöÑÂ≠ê‰ª£‰ø°ÊÅØ\n` +
              `‚Ä¢ ÂàÜÊûêË°ÄÁªüÂõæË∞±\n\n` +
              `ËØ∑ÂëäËØâÊàëÊÇ®ÊÉ≥Êü•ÁúãÂì™Âè™È∏ΩÂ≠êÁöÑË°ÄÁªü‰ø°ÊÅØÔºü\n` +
              `‰æãÂ¶ÇÔºö"Êü•Áúã CHN2025-0001 ÁöÑË°ÄÁªü" Êàñ "ÊòæÁ§∫Ë°ÄÁªüÊ†ë"`
      };
    }
    
    // Â§ÑÁêÜÊØîËµõÈóÆÈ¢òÔºà‰ΩøÁî®ÁΩëÈ°µÊï∞ÊçÆÔºâ
    function handleRaceQuestion(webData) {
      if (!webData) {
        return { text: 'Êó†Ê≥ïËé∑ÂèñÊØîËµõÊï∞ÊçÆÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•„ÄÇ' };
      }
      
      const racesCount = webData.racesCount || 0;
      const activeRaces = webData.activeRaces || 0;
      const completedRaces = webData.completedRaces || 0;
      
      return {
        text: `üèÜ ÊØîËµõËÆ∞ÂΩïÁªüËÆ°Ôºö\n\n` +
              `ÊÄªÊØîËµõËÆ∞ÂΩïÔºö${racesCount}Êù°\n` +
              `üèÅ ËøõË°å‰∏≠Ëµõ‰∫ãÔºö${activeRaces}‰∏™\n` +
              `‚úÖ Â∑≤ÂÆåÊàêËµõ‰∫ãÔºö${completedRaces}‰∏™\n\n` +
              `ÊàëÂèØ‰ª•Â∏ÆÊÇ®Ôºö\n` +
              `‚Ä¢ Êü•ÁúãÊØîËµõÂéÜÂè≤ËÆ∞ÂΩï\n` +
              `‚Ä¢ ÂàÜÊûêÊØîËµõÊàêÁª©\n` +
              `‚Ä¢ Êü•ÁúãÊúÄ‰Ω≥Ë°®Áé∞\n\n` +
              `ÈúÄË¶ÅÊü•ÁúãÂì™‰∫õÊØîËµõ‰ø°ÊÅØÔºü\n` +
              `‰æãÂ¶ÇÔºö"Êü•ÁúãÊúÄËøëÁöÑÊØîËµõ" Êàñ "ÊòæÁ§∫ÊØîËµõÊàêÁª©"`
      };
    }
    
    // Â§ÑÁêÜÈóÆÂÄôÈóÆÈ¢ò
    function handleGreetingQuestion() {
      const greetings = [
        '‰Ω†Â•ΩÔºÅÊàëÊòØ EvoÔºåÊÇ®ÁöÑÊô∫ËÉΩÂä©Êâã„ÄÇÊàëÂèØ‰ª•Â∏ÆÊÇ®Ôºö\n\n' +
        '‚Ä¢ üìä Êü•ÁúãÁªüËÆ°Êï∞ÊçÆ\n' +
        '‚Ä¢ üïäÔ∏è Êü•ÊâæÈ∏ΩÂ≠ê‰ø°ÊÅØ\n' +
        '‚Ä¢ üå≥ ÂàÜÊûêË°ÄÁªüÂÖ≥Á≥ª\n' +
        '‚Ä¢ üèÜ Êü•ÁúãÊØîËµõËÆ∞ÂΩï\n\n' +
        'Êúâ‰ªÄ‰πàÊàëÂèØ‰ª•Â∏ÆÂä©ÊÇ®ÁöÑÂêóÔºü',
        
        'ÊÇ®Â•ΩÔºÅÊàëÊòØ EvoÔºåÂæàÈ´òÂÖ¥‰∏∫ÊÇ®ÊúçÂä°„ÄÇ\n\n' +
        'ÊàëÂèØ‰ª•Â∏ÆÊÇ®ÁÆ°ÁêÜÂíåÂàÜÊûê‰ø°È∏ΩÊï∞ÊçÆÔºåÂõûÁ≠îÊÇ®ÁöÑÈóÆÈ¢ò„ÄÇ\n\n' +
        'ËØ∑ÂëäËØâÊàëÊÇ®ÈúÄË¶Å‰ªÄ‰πàÂ∏ÆÂä©Ôºü'
      ];
      
      return {
        text: greetings[Math.floor(Math.random() * greetings.length)]
      };
    }
    
    // Âø´ÈÄüÊìç‰Ωú
    function handleQuickAction(action) {
      const actionMessages = {
        stats: 'ËØ∑Â∏ÆÊàëÊü•ÁúãÁªüËÆ°Êï∞ÊçÆ',
        pedigree: 'ËØ∑ÂàÜÊûêË°ÄÁªüÂÖ≥Á≥ª',
        races: 'ÊòæÁ§∫ÊØîËµõËÆ∞ÂΩï'
      };
      
      inputField.value = actionMessages[action] || action;
      sendMessage();
    }
    
    // Ê∑ªÂä†Ê∂àÊÅØ
    function addMessage(type, text) {
      console.log('üì® addMessage Ë¢´Ë∞ÉÁî®:', { type, text: text.substring(0, 50) + '...' });
      const message = {
        type,
        text,
        time: new Date()
      };
      messages.push(message);
      console.log('üìä ÂΩìÂâçÊ∂àÊÅØÊï∞Èáè:', messages.length);
      renderMessages();
    }
    
    // Ê∏≤ÊüìÊ∂àÊÅØ
    function renderMessages() {
      if (!messagesContainer) {
        console.warn('‚ö†Ô∏è messagesContainer ‰∏çÂ≠òÂú®ÔºåÊó†Ê≥ïÊ∏≤ÊüìÊ∂àÊÅØ');
        return;
      }
      
      console.log('üé® renderMessages Ë¢´Ë∞ÉÁî®ÔºåÊ∏≤Êüì', messages.length, 'Êù°Ê∂àÊÅØ');
      
      messagesContainer.innerHTML = messages.map(msg => {
        const timeStr = formatTime(msg.time);
        if (msg.type === 'user') {
          return `
            <div class="evo-message ${msg.type}">
              <div class="evo-message-avatar">
                üë®‚Äçüíº
              </div>
              <div class="evo-message-wrapper">
                <div class="evo-message-content">
                  <div class="evo-message-text">${formatMessage(msg.text)}</div>
                </div>
                <div class="evo-message-time">${timeStr}</div>
              </div>
            </div>
          `;
        } else {
          return `
            <div class="evo-message ${msg.type}">
              <div class="evo-message-avatar">
                üïäÔ∏è
              </div>
              <div class="evo-message-content">
                <div class="evo-message-text">${formatMessage(msg.text)}</div>
                <div class="evo-message-time">${timeStr}</div>
              </div>
            </div>
          `;
        }
      }).join('');
      
      if (isTyping) {
        messagesContainer.innerHTML += `
          <div class="evo-message evo">
            <div class="evo-message-avatar">üïäÔ∏è</div>
            <div class="evo-message-content">
              <div class="evo-typing-indicator">
                <span></span><span></span><span></span>
              </div>
            </div>
          </div>
        `;
      }
      
      scrollToBottom();
    }
    
    // Ê†ºÂºèÂåñÊ∂àÊÅØÊñáÊú¨
    function formatMessage(text) {
      return text.replace(/\n/g, '<br>');
    }
    
    // Ê†ºÂºèÂåñÊó∂Èó¥
    function formatTime(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      
      if (minutes < 1) return 'ÂàöÂàö';
      if (minutes < 60) return `${minutes}ÂàÜÈíüÂâç`;
      if (minutes < 1440) return `${Math.floor(minutes / 60)}Â∞èÊó∂Ââç`;
      return date.toLocaleString();
    }
    
    // ÊªöÂä®Âà∞Â∫ïÈÉ®
    function scrollToBottom() {
      if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
    }
    
    // Êõ¥Êñ∞Áä∂ÊÄÅ
    function updateStatus(status) {
      const statusEl = document.getElementById('evoStatus');
      if (statusEl) {
        statusEl.textContent = status;
      }
    }
    
    // ÁîüÊàêÊé®Ëçê
    function generateRecommendations() {
      const container = document.getElementById('evoRecommendations');
      if (!container) return;
      
      const total = pigeons.length;
      const alive = pigeons.filter(p => p.alive).length;
      const recommendations = [];
      
      if (total === 0) {
        recommendations.push({
          icon: '‚ûï',
          title: 'ÂºÄÂßãÊ∑ªÂä†È∏ΩÂ≠ê',
          description: 'ÊÇ®ËøòÊ≤°ÊúâÊ∑ªÂä†‰ªª‰ΩïÈ∏ΩÂ≠êÔºåÁÇπÂáªÊñ∞Â¢ûÂºÄÂßãÂêßÔºÅ'
        });
      } else if (alive < 5) {
        recommendations.push({
          icon: 'üïäÔ∏è',
          title: 'Â¢ûÂä†È∏ΩÂ≠êÊï∞Èáè',
          description: `ÂΩìÂâçÂè™Êúâ${alive}Âè™È∏ΩÂ≠êÔºåÂª∫ËÆÆÂ¢ûÂä†Êï∞Èáè‰ª•Âª∫Á´ãÊõ¥Â•ΩÁöÑË°ÄÁªü‰ΩìÁ≥ª`
        });
      }
      
      if (recommendations.length > 0) {
        container.innerHTML = recommendations.map(rec => `
          <div class="evo-recommendation-card">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="font-size: 24px;">${rec.icon}</div>
              <div>
                <h4 style="margin: 0 0 4px 0; font-size: 14px;">${rec.title}</h4>
                <p style="margin: 0; font-size: 12px; color: #909399;">${rec.description}</p>
              </div>
            </div>
          </div>
        `).join('');
      }
    }
    
    // Ê£ÄÊü•ÊòØÂê¶Â∫îËØ•ÊâìÊãõÂëºÔºàÊØèÊ¨°Âà∑Êñ∞È°µÈù¢ÈÉΩÊòæÁ§∫Ôºâ
    function shouldShowGreeting() {
      // ÊØèÊ¨°È°µÈù¢Âä†ËΩΩÊó∂ÈÉΩÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØÔºàÂà∑Êñ∞È°µÈù¢Êó∂ hasShownGreetingThisPageLoad ‰ºöÈáçÁΩÆ‰∏∫ falseÔºâ
      const shouldShow = !hasShownGreetingThisPageLoad;
      console.log('üîç shouldShowGreeting Ê£ÄÊü•:', { hasShownGreetingThisPageLoad, shouldShow });
      return shouldShow;
    }
    
    // Ëé∑ÂèñÊú™‰ΩøÁî®ÁöÑÊ¨¢ËøéÊ∂àÊÅØÂêéÁºÄ
    function getUnusedGreetingSuffix() {
      try {
        const used = JSON.parse(localStorage.getItem(USED_GREETINGS_KEY) || '[]');
        const available = GREETING_SUFFIXES.filter(suffix => !used.includes(suffix));
        
        // Â¶ÇÊûúÊâÄÊúâÊ∂àÊÅØÈÉΩÁî®Ëøá‰∫ÜÔºåÈáçÁΩÆÂàóË°®
        if (available.length === 0) {
          localStorage.setItem(USED_GREETINGS_KEY, '[]');
          return GREETING_SUFFIXES[Math.floor(Math.random() * GREETING_SUFFIXES.length)];
        }
        
        // ‰ªéÊú™‰ΩøÁî®ÁöÑÊ∂àÊÅØ‰∏≠ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™
        const selected = available[Math.floor(Math.random() * available.length)];
        
        // ËÆ∞ÂΩïÂ∑≤‰ΩøÁî®
        used.push(selected);
        localStorage.setItem(USED_GREETINGS_KEY, JSON.stringify(used));
        
        return selected;
      } catch (error) {
        console.error('Ëé∑ÂèñÊ¨¢ËøéÊ∂àÊÅØÂ§±Ë¥•:', error);
        return GREETING_SUFFIXES[0];
      }
    }
    
    // ÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØÊ∞îÊ≥°ÂºπÁ™ó
    function showWelcomeGreeting() {
      console.log('üöÄ showWelcomeGreeting Ë¢´Ë∞ÉÁî®');
      console.log('üìç ÂΩìÂâçÁä∂ÊÄÅ:', {
        hasShownGreetingThisPageLoad,
        bodyExists: !!document.body
      });
      
      // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Ê∞îÊ≥°ÔºåÂ¶ÇÊûúÂ≠òÂú®ÂàôË∑≥ËøáÔºà‰∏ç‰æùËµñÊ†áÂøóÔºâ
      const existingBubble = document.getElementById('evoWelcomeBubble');
      if (existingBubble) {
        console.log('‚ÑπÔ∏è Ê∞îÊ≥°Â∑≤Â≠òÂú®ÔºåË∑≥ËøáÈáçÂ§çÊòæÁ§∫');
        return;
      }
      
      // Ê†áËÆ∞ÂΩìÂâçÈ°µÈù¢Âä†ËΩΩÊó∂Â∑≤ÊòæÁ§∫ËøáÊ¨¢ËøéÊ∂àÊÅØ
      hasShownGreetingThisPageLoad = true;
      console.log('üìù Â∑≤ËÆæÁΩÆ hasShownGreetingThisPageLoad = true');
      
      try {
        // Á°Æ‰øùbodyÂÖÉÁ¥†Â≠òÂú®
        if (!document.body) {
          console.error('‚ùå document.body ‰∏çÂ≠òÂú®ÔºåÂª∂ËøüÈáçËØï');
          setTimeout(showWelcomeGreeting, 500);
          return;
        }
        
        // Âõ∫ÂÆöÂºÄÂ§¥ + ÈöèÊú∫ÂêéÁºÄ
        const suffix = getUnusedGreetingSuffix();
        const greeting = `‰Ω†Â•ΩÔºåÊàëÊòØEvoÔºåÊàëÂèØ‰ª•Â∏Æ‰Ω†${suffix}„ÄÇ`;
        
        console.log('‚úÖ ÂàõÂª∫Ê¨¢ËøéÊ∂àÊÅØÊ∞îÊ≥°:', greeting);
        console.log('üìç Ê∞îÊ≥°Â∞ÜÊ∑ªÂä†Âà∞ document.body');
        
        // ÂàõÂª∫Ê∞îÊ≥°ÂÖÉÁ¥†
        const bubble = document.createElement('div');
        bubble.id = 'evoWelcomeBubble';
        bubble.className = 'evo-welcome-bubble';
        
        // Âº∫Âà∂ËÆæÁΩÆÊ†∑Âºè‰ª•Á°Æ‰øùÂèØËßÅÔºàÁõ¥Êé•ËÆæÁΩÆstyleÂ±ûÊÄßÔºå!importantÈÄöËøáCSSÁ±ªÁ°Æ‰øùÔºâ
        // Ê∞îÊ≥°ÊòæÁ§∫Âú®ÂõæÊ†á‰∏äÊñπÔºå‰∏éÂõæÊ†áÂè≥ËæπÁºòÂØπÈΩê
        bubble.style.position = 'fixed';
        bubble.style.bottom = 'calc(30vh + 100px)'; /* ÂõæÊ†á‰∏äÊñπ100pxÔºàÂõæÊ†á‰ΩçÁΩÆ30vh + Èó¥Ë∑ù100pxÔºâ */
        bubble.style.right = '20px'; /* ‰∏éÂõæÊ†áÂè≥ËæπÁºòÂØπÈΩê */
        bubble.style.zIndex = '99998';
        bubble.style.maxWidth = '280px';
        bubble.style.pointerEvents = 'auto';
        bubble.style.display = 'block';
        bubble.style.visibility = 'visible';
        bubble.style.opacity = '1';
        
        const bubbleContent = document.createElement('div');
        bubbleContent.className = 'evo-welcome-bubble-content';
        bubbleContent.textContent = greeting;
        
        // Âº∫Âà∂ËÆæÁΩÆÂÜÖÂÆπÊ†∑ÂºèÔºà‰ΩøÁî®ÁΩëÁ´ôÈÖçËâ≤ÔºöÁ¥´Ëâ≤Ê∏êÂèòÔºâ
        bubbleContent.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        bubbleContent.style.color = '#fff';
        bubbleContent.style.padding = '12px 16px';
        bubbleContent.style.borderRadius = '8px';
        bubbleContent.style.fontSize = '14px';
        bubbleContent.style.lineHeight = '1.5';
        bubbleContent.style.boxShadow = '0 4px 20px rgba(102, 126, 234, 0.4), 0 0 30px rgba(118, 75, 162, 0.3)';
        bubbleContent.style.position = 'relative';
        bubbleContent.style.wordWrap = 'break-word';
        bubbleContent.style.cursor = 'pointer';
        bubbleContent.style.fontWeight = '500';
        
        // ÁÇπÂáªÊ∞îÊ≥°ÂèØ‰ª•ÊâìÂºÄÂØπËØùÊ°Ü
        bubbleContent.addEventListener('click', () => {
          console.log('üëÜ Áî®Êà∑ÁÇπÂáª‰∫ÜÊ¨¢ËøéÊ∞îÊ≥°');
          hideWelcomeBubble();
          // ÊâìÂºÄÂØπËØùÊ°Ü
          if (!dialog) {
            dialog = document.getElementById('evoDialog');
          }
          if (dialog) {
            isExpanded = true;
            dialog.style.display = 'flex';
            dialog.style.visibility = 'visible';
            dialog.style.opacity = '1';
            activeTab = 'chat';
            switchTab('chat');
            
            // Â¶ÇÊûúÊ∂àÊÅØÂÆπÂô®Â≠òÂú®ÔºåÊ∑ªÂä†Ê¨¢ËøéÊ∂àÊÅØÂà∞ÂØπËØùÊ°Ü
            if (!messagesContainer) {
              messagesContainer = document.getElementById('evoMessages');
            }
            if (messagesContainer) {
              messages = [];
              messagesContainer.innerHTML = '';
              addMessage('evo', greeting);
              saveHistory();
              setTimeout(() => scrollToBottom(), 100);
            }
          }
        });
        
        bubble.appendChild(bubbleContent);
        
        // Á°Æ‰øùbodyÂ≠òÂú®ÂêéÂÜçÊ∑ªÂä†
        if (!document.body) {
          console.error('‚ùå document.body ‰∏çÂ≠òÂú®ÔºåÊó†Ê≥ïÊ∑ªÂä†Ê∞îÊ≥°');
          return;
        }
        
        document.body.appendChild(bubble);
        
        console.log('‚úÖ Ê¨¢ËøéÊ∞îÊ≥°Â∑≤Ê∑ªÂä†Âà∞DOM');
        console.log('üìç Ê∞îÊ≥°ÂÖÉÁ¥†:', bubble);
        const computedStyle = window.getComputedStyle(bubble);
        console.log('üìç Ê∞îÊ≥°ËÆ°ÁÆóÊ†∑Âºè:', {
          display: computedStyle.display,
          visibility: computedStyle.visibility,
          opacity: computedStyle.opacity,
          zIndex: computedStyle.zIndex,
          position: computedStyle.position,
          bottom: computedStyle.bottom,
          right: computedStyle.right
        });
        
        // Âº∫Âà∂Á°Æ‰øùÊ∞îÊ≥°ÂèØËßÅÔºàÂÜçÊ¨°ËÆæÁΩÆÊ†∑ÂºèÔºâ
        requestAnimationFrame(() => {
          if (bubble.parentNode) {
            bubble.style.display = 'block';
            bubble.style.visibility = 'visible';
            bubble.style.opacity = '1';
            bubble.style.zIndex = '99998';
            console.log('‚úÖ Â∑≤Âº∫Âà∂ËÆæÁΩÆÊ∞îÊ≥°Ê†∑Âºè‰∏∫ÂèØËßÅ');
          }
        });
        
        // È™åËØÅÊ∞îÊ≥°ÊòØÂê¶ÁúüÁöÑÂú®DOM‰∏≠
        setTimeout(() => {
          const checkBubble = document.getElementById('evoWelcomeBubble');
          if (checkBubble) {
            console.log('‚úÖ È™åËØÅÊàêÂäüÔºöÊ∞îÊ≥°Âú®DOM‰∏≠');
            const rect = checkBubble.getBoundingClientRect();
            const checkComputedStyle = window.getComputedStyle(checkBubble);
            console.log('üìç Ê∞îÊ≥°‰ΩçÁΩÆ‰ø°ÊÅØ:', {
              top: rect.top,
              right: rect.right,
              bottom: rect.bottom,
              left: rect.left,
              width: rect.width,
              height: rect.height,
              visible: rect.width > 0 && rect.height > 0,
              inViewport: rect.top >= 0 && rect.left >= 0 && rect.bottom <= window.innerHeight && rect.right <= window.innerWidth,
              display: checkComputedStyle.display,
              visibility: checkComputedStyle.visibility,
              opacity: checkComputedStyle.opacity
            });
            
            // Â¶ÇÊûúÊ∞îÊ≥°‰∏çÂèØËßÅÔºåÂ∞ùËØï‰øÆÂ§ç
            if (rect.width === 0 || rect.height === 0 || checkComputedStyle.display === 'none' || checkComputedStyle.visibility === 'hidden') {
              console.warn('‚ö†Ô∏è Ê£ÄÊµãÂà∞Ê∞îÊ≥°‰∏çÂèØËßÅÔºåÂ∞ùËØï‰øÆÂ§ç...');
              checkBubble.style.cssText = `
                position: fixed !important;
                bottom: 160px !important;
                right: 100px !important;
                z-index: 99998 !important;
                max-width: 280px !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
              `;
            }
          } else {
            console.error('‚ùå È™åËØÅÂ§±Ë¥•ÔºöÊ∞îÊ≥°‰∏çÂú®DOM‰∏≠');
          }
        }, 100);
        
        // 3ÁßíÂêéËá™Âä®ÂÖ≥Èó≠Ê∞îÊ≥°
        setTimeout(() => {
          console.log('‚è∞ 3ÁßíÊó∂Èó¥Âà∞ÔºåËá™Âä®ÂÖ≥Èó≠Ê¨¢ËøéÊ∞îÊ≥°');
          hideWelcomeBubble();
        }, 3000);
        
      } catch (error) {
        console.error('‚ùå ÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØÂ§±Ë¥•:', error);
        console.error('ÈîôËØØÂ†ÜÊ†à:', error.stack);
      }
    }
    
    // ÈöêËóèÊ¨¢ËøéÊ∂àÊÅØÊ∞îÊ≥°
    function hideWelcomeBubble() {
      console.log('ü´ß hideWelcomeBubble Ë¢´Ë∞ÉÁî®');
      const bubble = document.getElementById('evoWelcomeBubble');
      if (bubble) {
        console.log('‚úÖ ÊâæÂà∞Ê∞îÊ≥°ÂÖÉÁ¥†ÔºåÂºÄÂßãÈöêËóèÂä®Áîª');
        bubble.classList.add('hiding');
        setTimeout(() => {
          if (bubble.parentNode) {
            bubble.remove();
            console.log('‚úÖ Ê∞îÊ≥°Â∑≤‰ªéDOM‰∏≠ÁßªÈô§');
          }
        }, 300); // Á≠âÂæÖÂä®ÁîªÂÆåÊàê
      } else {
        console.log('‚ÑπÔ∏è Êú™ÊâæÂà∞Ê∞îÊ≥°ÂÖÉÁ¥†ÔºàÂèØËÉΩÂ∑≤Ë¢´ÁßªÈô§Ôºâ');
      }
    }
    
    // Ëá™Âä®ÂÖ≥Èó≠ÂÆöÊó∂Âô®
    function clearAutoCloseTimer() {
      if (autoCloseTimer) {
        clearTimeout(autoCloseTimer);
        autoCloseTimer = null;
      }
      if (userInteractionTimer) {
        clearTimeout(userInteractionTimer);
        userInteractionTimer = null;
      }
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÁî®Êà∑‰∫§‰∫íÔºàÂèëÈÄÅÊ∂àÊÅØÔºâ
    function hasUserInteraction() {
      return messages.some(msg => msg.type === 'user');
    }
    
    // ÂêØÂä®Ëá™Âä®ÂÖ≥Èó≠ÂÆöÊó∂Âô®ÔºàÁî®Êà∑Êú™‰∏ªÂä®‰∫§‰∫íÊó∂Ôºâ
    function startAutoCloseTimer() {
      clearAutoCloseTimer();
      if (isExpanded && !hasUserInteraction()) {
        // Â¶ÇÊûúÁî®Êà∑ËøòÊ≤°ÊúâÂèëÈÄÅ‰ªª‰ΩïÊ∂àÊÅØÔºåÂú®ÊåáÂÆöÊó∂Èó¥ÂêéÂÖ≥Èó≠
        autoCloseTimer = setTimeout(() => {
          if (!hasUserInteraction() && isExpanded) {
            toggleExpanded();
          }
        }, AUTO_CLOSE_DELAY);
      } else if (isExpanded && hasUserInteraction()) {
        // Â¶ÇÊûúÁî®Êà∑Â∑≤Áªè‰∫§‰∫íËøáÔºåÂêØÂä®Êó†Êìç‰ΩúËá™Âä®ÂÖ≥Èó≠ÂÆöÊó∂Âô®
        startUserInactivityTimer();
      }
    }
    
    // ÂêØÂä®Áî®Êà∑Êó†Êìç‰ΩúËá™Âä®ÂÖ≥Èó≠ÂÆöÊó∂Âô®ÔºàÁî®Êà∑Âú®ÂØπËØùÊ°ÜÂÜÖÊó†Êìç‰ΩúÊó∂Ôºâ
    function startUserInactivityTimer() {
      clearUserInactivityTimer();
      if (isExpanded && hasUserInteraction()) {
        userInteractionTimer = setTimeout(() => {
          if (isExpanded) {
            toggleExpanded();
          }
        }, USER_INACTIVITY_DELAY);
      }
    }
    
    function clearUserInactivityTimer() {
      if (userInteractionTimer) {
        clearTimeout(userInteractionTimer);
        userInteractionTimer = null;
      }
    }
    
    // ÈáçÁΩÆËá™Âä®ÂÖ≥Èó≠ÂÆöÊó∂Âô®ÔºàÁî®Êà∑ÊúâÊìç‰ΩúÊó∂Ôºâ
    function resetAutoCloseTimer() {
      if (isExpanded) {
        if (hasUserInteraction()) {
          // Â¶ÇÊûúÁî®Êà∑Â∑≤Áªè‰∫§‰∫íËøáÔºåÈáçÁΩÆÊó†Êìç‰ΩúÂÆöÊó∂Âô®
          startUserInactivityTimer();
        } else {
          // Â¶ÇÊûúÁî®Êà∑ËøòÊ≤°‰∫§‰∫íÔºåÈáçÁΩÆÂàùÂßãËá™Âä®ÂÖ≥Èó≠ÂÆöÊó∂Âô®
          startAutoCloseTimer();
        }
      }
    }
    
    // ‰øùÂ≠òÂéÜÂè≤
    function saveHistory() {
      try {
        localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(messages));
      } catch (error) {
        console.error('Failed to save chat history:', error);
      }
    }
    
    // Âä†ËΩΩÂéÜÂè≤
    function loadHistory() {
      try {
        const history = localStorage.getItem(CHAT_HISTORY_KEY);
        if (history) {
          messages = JSON.parse(history).map(msg => ({
            ...msg,
            time: new Date(msg.time)
          }));
          renderMessages();
        }
      } catch (error) {
        console.error('Failed to load chat history:', error);
      }
    }
    
    // EvoËÆæÁΩÆÔºàÂÖ®Â±ÄÔºå‰æõchatÂáΩÊï∞‰ΩøÁî®Ôºâ
    let evoSettings = {
      enabled: true,
      showWelcome: true,
      saveHistory: true,
      autoClose: 5,
      functionGuides: {}
    };
    
    // Âä†ËΩΩËÆæÁΩÆ
    async function loadSettings() {
      try {
        const apiConfig = getApiConfig();
        const apiUrl = apiConfig.apiUrl || 'http://localhost:3000/api';
        
        const response = await fetch(`${apiUrl}/evo-settings`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success && result.data) {
            evoSettings = { ...evoSettings, ...result.data };
            console.log('‚úÖ EvoËÆæÁΩÆÂ∑≤Âä†ËΩΩÔºåÂäüËÉΩËØ¥ÊòéÊï∞Èáè:', Object.keys(evoSettings.functionGuides || {}).length);
            
            // ‰øùÂ≠òÂà∞localStorage‰Ωú‰∏∫ÁºìÂ≠ò
            localStorage.setItem('evo_settings', JSON.stringify(evoSettings));
            
            // Â∫îÁî®ËÆæÁΩÆ
            applyEvoSettings(evoSettings);
          }
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Âä†ËΩΩEvoËÆæÁΩÆÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ËÆæÁΩÆ:', error);
        // Â∞ùËØï‰ªélocalStorageÂä†ËΩΩ
        try {
          const cached = localStorage.getItem('evo_settings');
          if (cached) {
            evoSettings = { ...evoSettings, ...JSON.parse(cached) };
            console.log('‚úÖ ‰ªéÁºìÂ≠òÂä†ËΩΩEvoËÆæÁΩÆ');
          }
        } catch (e) {
          console.error('Âä†ËΩΩÁºìÂ≠òËÆæÁΩÆÂ§±Ë¥•:', e);
        }
      }
    }
    
    // ÂÆöÊúüÂêåÊ≠•ËÆæÁΩÆÔºàÊØè30ÁßíÔºâ
    setInterval(() => {
      loadSettings();
    }, 30000);
    
    // ÂÖ¨ÂºÄAPI
    return {
      init,
      ensureIconVisible,
      startIconMonitor,
      showWelcomeGreeting, // Êö¥Èú≤‰ª•‰æøË∞ÉËØï
      getSettings: () => evoSettings, // Êö¥Èú≤ËÆæÁΩÆ‰ª•‰æøÂ§ñÈÉ®ËÆøÈóÆ
      loadSettings // Êö¥Èú≤Âä†ËΩΩÂáΩÊï∞
    };
  })();
  
  // ÂÖ®Â±ÄËÆøÈóÆevoSettingsÔºà‰æõchatÂáΩÊï∞‰ΩøÁî®Ôºâ
  window.getEvoSettings = () => {
    if (EvoAssistant && typeof EvoAssistant.getSettings === 'function') {
      return EvoAssistant.getSettings();
    }
    // ‰ªélocalStorageËØªÂèñ
    try {
      const cached = localStorage.getItem('evo_settings');
      return cached ? JSON.parse(cached) : { functionGuides: {} };
    } catch (e) {
      return { functionGuides: {} };
    }
  };
  
  // ÂºÇÊ≠•Âä†ËΩΩÊï∞ÊçÆÂπ∂ÂàùÂßãÂåñ
  (async function() {
    await loadFromStorage();
    refreshList();
    refreshStats();
    refreshDashboard();
    fillPedigreeSelect();
    
    // ÂàùÂßãÂåñÈ¶ñÈ°µ
    initHomePage();
    
    // ÊòæÁ§∫ÂêåÊ≠•Áä∂ÊÄÅ
    if (isCloudSyncEnabled) {
      console.log('‚úÖ ‰∫ëÁ´ØÂêåÊ≠•Â∑≤ÂêØÁî® - ÊâÄÊúâËÆæÂ§áÂÖ±‰∫´Êï∞ÊçÆ');
    } else {
      console.log('‚ö†Ô∏è ‰∫ëÁ´ØÂêåÊ≠•Êú™ÂêØÁî® - ‰ΩøÁî®Êú¨Âú∞Â≠òÂÇ®');
    }
    
    // ÂêåÊ≠•EvoËÆæÁΩÆ
    async function syncEvoSettings() {
      try {
        const apiConfig = getApiConfig();
        const apiUrl = apiConfig.apiUrl || 'http://localhost:3000/api';
        
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÂêåÊ≠•Ê†áÂøó
        const syncFlag = localStorage.getItem('evo_settings_sync');
        const lastSyncTime = localStorage.getItem('evo_settings_sync_timestamp');
        const currentTime = Date.now();
        
        // Â¶ÇÊûúÊúâÂêåÊ≠•Ê†áÂøóÔºåÊàñËÄÖË∑ùÁ¶ª‰∏äÊ¨°ÂêåÊ≠•Ë∂ÖËøá5ÂàÜÈíüÔºåÂàôÂêåÊ≠•
        if (syncFlag === 'true' || !lastSyncTime || (currentTime - parseInt(lastSyncTime)) > 300000) {
          const response = await fetch(`${apiUrl}/evo-settings`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
              // ‰øùÂ≠òËÆæÁΩÆÂà∞localStorage
              localStorage.setItem('evo_settings', JSON.stringify(result.data));
              
              // Ê∏ÖÈô§ÂêåÊ≠•Ê†áÂøó
              localStorage.removeItem('evo_settings_sync');
              
              console.log('‚úÖ EvoËÆæÁΩÆÂ∑≤‰ªéÊúçÂä°Âô®ÂêåÊ≠•');
              
              // Â∫îÁî®ËÆæÁΩÆ
              applyEvoSettings(result.data);
            }
          }
        } else {
          // ‰ΩøÁî®Êú¨Âú∞ËÆæÁΩÆ
          const localSettings = localStorage.getItem('evo_settings');
          if (localSettings) {
            applyEvoSettings(JSON.parse(localSettings));
          }
        }
      } catch (error) {
        console.warn('ÂêåÊ≠•EvoËÆæÁΩÆÂ§±Ë¥•Ôºå‰ΩøÁî®Êú¨Âú∞ËÆæÁΩÆ:', error);
        const localSettings = localStorage.getItem('evo_settings');
        if (localSettings) {
          applyEvoSettings(JSON.parse(localSettings));
        }
      }
    }
    
    // Â∫îÁî®EvoËÆæÁΩÆ
    function applyEvoSettings(settings) {
      if (!settings) return;
      
      // Â∫îÁî®Âü∫Êú¨ËÆæÁΩÆ
      if (settings.enabled === false) {
        const assistant = document.getElementById('evoAssistant');
        if (assistant) {
          assistant.style.display = 'none';
        }
        return;
      }
      
      // Â∫îÁî®‰ΩçÁΩÆËÆæÁΩÆ
      if (settings.position) {
        const assistant = document.getElementById('evoAssistant');
        if (assistant) {
          const positions = {
            'bottom-right': { bottom: '80px', right: '20px', top: 'auto', left: 'auto' },
            'bottom-left': { bottom: '80px', left: '20px', top: 'auto', right: 'auto' },
            'top-right': { top: '80px', right: '20px', bottom: 'auto', left: 'auto' },
            'top-left': { top: '80px', left: '20px', bottom: 'auto', right: 'auto' }
          };
          
          const pos = positions[settings.position] || positions['bottom-right'];
          Object.assign(assistant.style, pos);
        }
      }
      
      // Â∫îÁî®ÂõæÊ†áÂ§ßÂ∞è
      if (settings.iconSize) {
        const iconButton = document.getElementById('evoIconButton');
        if (iconButton) {
          iconButton.style.width = settings.iconSize + 'px';
          iconButton.style.height = settings.iconSize + 'px';
        }
      }
      
      // Â∫îÁî®‰∏ªÈ¢òÈ¢úËâ≤
      if (settings.theme) {
        const iconButton = document.getElementById('evoIconButton');
        if (iconButton) {
          const themes = {
            'purple': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            'blue': 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
            'green': 'linear-gradient(135deg, #10b981 0%, #059669 100%)'
          };
          iconButton.style.background = themes[settings.theme] || themes['purple'];
        }
      }
      
      console.log('‚úÖ EvoËÆæÁΩÆÂ∑≤Â∫îÁî®');
    }
    
    // ÂàùÂßãÂåñÊô∫ËÉΩÂä©ÊâãÔºàÁ°Æ‰øùÂú®DOMÂÆåÂÖ®Âä†ËΩΩÂêéÔºâ
    setTimeout(async () => {
      try {
        // ÂÖàÂêåÊ≠•ËÆæÁΩÆ
        await syncEvoSettings();
        
        EvoAssistant.init();
        console.log('‚úÖ Evo Êô∫ËÉΩÂä©ÊâãÂ∑≤ÂàùÂßãÂåñ');
        
        // È¢ùÂ§ñÁ°Æ‰øùÂõæÊ†áÂèØËßÅ
        setTimeout(() => {
          if (EvoAssistant && typeof EvoAssistant.ensureIconVisible === 'function') {
            EvoAssistant.ensureIconVisible();
          }
        }, 500);
      } catch (error) {
        console.error('‚ö†Ô∏è Êô∫ËÉΩÂä©ÊâãÂàùÂßãÂåñÂ§±Ë¥•:', error);
        // Â¶ÇÊûúÂàùÂßãÂåñÂ§±Ë¥•ÔºåÂ∞ùËØïÂÜçÊ¨°ÂàùÂßãÂåñ
        setTimeout(() => {
          if (typeof EvoAssistant !== 'undefined' && typeof EvoAssistant.init === 'function') {
            EvoAssistant.init();
          }
        }, 1000);
      }
    }, 500); // Áº©Áü≠Âà∞500msÔºåÊõ¥Âø´ÂàùÂßãÂåñ
    
    // ÂÆöÊúüÊ£ÄÊü•ËÆæÁΩÆÊõ¥Êñ∞ÔºàÊØè5ÂàÜÈíüÔºâ
    setInterval(() => {
      syncEvoSettings();
    }, 300000);
    
    // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÊó∂ÊÅ¢Â§çÂõæÊ†á
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && EvoAssistant && typeof EvoAssistant.ensureIconVisible === 'function') {
        setTimeout(() => {
          EvoAssistant.ensureIconVisible();
        }, 100);
      }
    });
    
    // Á™óÂè£ÁÑ¶ÁÇπÂèòÂåñÊó∂ÊÅ¢Â§çÂõæÊ†á
    window.addEventListener('focus', () => {
      if (EvoAssistant && typeof EvoAssistant.ensureIconVisible === 'function') {
        setTimeout(() => {
          EvoAssistant.ensureIconVisible();
        }, 100);
      }
    });
    
    // ÂÆöÊúüÊ£ÄÊü•ÂõæÊ†áÔºàÊØè5ÁßíÔºâ
    setInterval(() => {
      if (EvoAssistant && typeof EvoAssistant.ensureIconVisible === 'function') {
        const assistant = document.getElementById('evoAssistant');
        if (!assistant) {
          console.warn('EvoÂõæÊ†á‰∏¢Â§±ÔºåÊ≠£Âú®ÊÅ¢Â§ç...');
          EvoAssistant.ensureIconVisible();
        } else {
          const computedStyle = window.getComputedStyle(assistant);
          if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden' || parseFloat(computedStyle.opacity) === 0) {
            console.warn('EvoÂõæÊ†áË¢´ÈöêËóèÔºåÊ≠£Âú®ÊÅ¢Â§ç...');
            EvoAssistant.ensureIconVisible();
          }
        }
      }
    }, 5000);
  })();
  
  // Á°Æ‰øùÈ¶ñÈ°µÈªòËÆ§ÊòæÁ§∫ÔºàÁßªÂä®Á´ØÁâπÂà´ÈáçË¶ÅÔºâ
  function ensureHomeViewVisible() {
    const homeView = document.getElementById('homeView');
    if (homeView) {
      homeView.style.display = 'flex';
      homeView.style.visibility = 'visible';
      homeView.style.opacity = '1';
      
      // Á°Æ‰øùÊâÄÊúâÈ¶ñÈ°µÊ®°ÂùóÂèØËßÅ
      const homeSection = homeView.querySelector('.home-section');
      if (homeSection) {
        homeSection.style.display = 'flex';
        homeSection.style.visibility = 'visible';
      }
      
      const homeContent = homeView.querySelector('.home-content');
      if (homeContent) {
        homeContent.style.display = 'grid';
        homeContent.style.visibility = 'visible';
      }
      
      // Á°Æ‰øùÊâÄÊúâÂàóÂèØËßÅ
      const homeColumns = homeView.querySelectorAll('.home-column');
      homeColumns.forEach(col => {
        col.style.display = 'flex';
        col.style.visibility = 'visible';
        col.style.opacity = '1';
      });
      
      // Á°Æ‰øùÊâÄÊúâÂ∞èÈÉ®‰ª∂ÂèØËßÅ
      const homeWidgets = homeView.querySelectorAll('.home-widget');
      homeWidgets.forEach(widget => {
        widget.style.display = 'block';
        widget.style.visibility = 'visible';
      });
      
      console.log('‚úÖ Â∑≤Á°Æ‰øùÈ¶ñÈ°µÊâÄÊúâÊ®°ÂùóÂèØËßÅ');
    }
  }
  
  // Ê£ÄÊü•URLÂèÇÊï∞ÔºåÂà§Êñ≠ÊòØÂê¶‰ªéapp.htmlË∑≥ËΩ¨ËøáÊù•
  const urlParams = new URLSearchParams(window.location.search);
  const restored = urlParams.get('restored') === 'true';
  const deviceType = urlParams.get('device') || 'desktop';
  
  // Â¶ÇÊûúÊòØ‰ªéapp.htmlË∑≥ËΩ¨ËøáÊù•‰∏îÊ†áËÆ∞‰∏∫Â∑≤ÊÅ¢Â§çÔºåÊòæÁ§∫ÊèêÁ§∫
  if (restored) {
    setTimeout(() => {
      showNotification('‚úÖ Êï∞ÊçÆÂ∑≤‰ªé‰∫ëÁ´ØÊÅ¢Â§ç', 'success', 5000);
    }, 2000);
  }
  
  // È°µÈù¢Âä†ËΩΩÊó∂Á°Æ‰øùÈ¶ñÈ°µÊòæÁ§∫
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(ensureHomeViewVisible, 100);
      // ÈªòËÆ§ÂàáÊç¢Âà∞È¶ñÈ°µ
      if (typeof switchView === 'function') {
        switchView('homeView');
      }
      // Â¶ÇÊûúÊú¨Âú∞Êï∞ÊçÆÁº∫Â§±‰∏îÂ∑≤ÁôªÂΩïÔºåÂ∞ùËØï‰ªéÂêéÂè∞/‰∫ëÁ´ØÊÅ¢Â§ç
      setTimeout(() => {
        restoreUserDataIfMissing();
      }, 1500);
      // È°µÈù¢Âä†ËΩΩÂêé‰∏ªÂä®Ëß¶Âèë‰∏ÄÊ¨°ÂÆåÊï¥Áî®Êà∑Êï∞ÊçÆÂêåÊ≠•ÔºàÂ¶ÇÊûúÂ∑≤ÊúâÊï∞ÊçÆÔºâ
      setTimeout(() => {
        autoSyncUserData({ force: true });
      }, 5000);
    });
  } else {
    setTimeout(ensureHomeViewVisible, 100);
    // ÈªòËÆ§ÂàáÊç¢Âà∞È¶ñÈ°µ
    if (typeof switchView === 'function') {
      switchView('homeView');
    }
    setTimeout(() => {
      restoreUserDataIfMissing();
    }, 1500);
    setTimeout(() => {
      autoSyncUserData({ force: true });
    }, 5000);
  }
  
  // ËøêË°åÂºÇÂ∏∏Ê£ÄÊµã
  setTimeout(showAnomalyAlerts, 1000);
  
  // Âç°ÁâáÂä®Áîª
  setTimeout(animateCards, 200);
  
  // Ê¨¢ËøéÈÄöÁü•
  setTimeout(() => {
    const pigeonCount = pigeons.filter(p => p.alive).length;
    if (pigeonCount > 0) {
      showNotification(`Ê¨¢ËøéÂõûÊù•ÔºÅÊÇ®Êúâ ${pigeonCount} Âè™È∏ΩÂ≠êÂú®Ê°£`, 'info', 4000);
    }
  }, 1000);
  
  // ========================================
  // üì¢ ÂÖ¨ÂëäÁÆ°ÁêÜÂäüËÉΩ
  // ========================================
  
  // Âä†ËΩΩÂπ∂ÊòæÁ§∫ÊúÄÊñ∞ÂÖ¨Âëä
  async function loadAnnouncement() {
    try {
      const apiConfig = getApiConfig();
      if (!apiConfig.apiUrl) {
        return; // APIÊú™ÈÖçÁΩÆÔºå‰∏çÊòæÁ§∫ÂÖ¨Âëä
      }
      
      const response = await fetch(`${apiConfig.apiUrl}/api/announcements/latest`);
      if (!response.ok) {
        throw new Error('Ëé∑ÂèñÂÖ¨ÂëäÂ§±Ë¥•');
      }
      
      const result = await response.json();
      if (result.success && result.data) {
        const announcement = result.data;
        const announcementEl = document.getElementById('homeAnnouncement');
        const announcementText = document.getElementById('announcementText');
        
        if (announcementEl && announcementText) {
          announcementText.textContent = announcement.content;
          announcementEl.style.display = 'flex';
          
          // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÂÖ≥Èó≠ËøáÊ≠§ÂÖ¨Âëä
          const closedAnnouncements = JSON.parse(localStorage.getItem('closedAnnouncements') || '[]');
          if (closedAnnouncements.includes(announcement.id)) {
            announcementEl.style.display = 'none';
          }
        }
      }
    } catch (error) {
      console.error('Âä†ËΩΩÂÖ¨ÂëäÂ§±Ë¥•:', error);
    }
  }
  
  // ÂÖ≥Èó≠ÂÖ¨Âëä
  document.getElementById('btnCloseAnnouncement')?.addEventListener('click', () => {
    const announcementEl = document.getElementById('homeAnnouncement');
    if (announcementEl) {
      announcementEl.style.display = 'none';
      // ËÆ∞ÂΩïÂ∑≤ÂÖ≥Èó≠ÁöÑÂÖ¨ÂëäIDÔºà‰ªéÊúÄÊñ∞ÂÖ¨ÂëäËé∑ÂèñÔºâ
      loadAnnouncement().then(() => {
        const announcementText = document.getElementById('announcementText')?.textContent;
        if (announcementText) {
          // ËøôÈáåÁÆÄÂåñÂ§ÑÁêÜÔºåÂÆûÈôÖÂ∫îËØ•‰ªéAPIËé∑ÂèñID
          const closedAnnouncements = JSON.parse(localStorage.getItem('closedAnnouncements') || '[]');
          // Áî±‰∫éÊàë‰ª¨Âè™ÊòæÁ§∫ÊúÄÊñ∞ÂÖ¨ÂëäÔºåÂèØ‰ª•ÁÆÄÂçïËÆ∞ÂΩïÊó∂Èó¥Êà≥
          localStorage.setItem('lastAnnouncementClosed', Date.now().toString());
        }
      });
    }
  });
  
  // È°µÈù¢Âä†ËΩΩÊó∂Âä†ËΩΩÂÖ¨Âëä
  setTimeout(loadAnnouncement, 2000);
  
  // ÂêéÂè∞ÁÆ°ÁêÜÂäüËÉΩÂ∑≤ÁßªËá≥Áã¨Á´ãÁöÑ admin.html Êñá‰ª∂
  
  // ÂêéÂè∞ÁÆ°ÁêÜÂäüËÉΩÂ∑≤ÁßªËá≥Áã¨Á´ãÁöÑ admin.html Êñá‰ª∂
  
  // Áªü‰∏ÄÂàùÂßãÂåñÊâÄÊúâÊåâÈíÆ‰∫ã‰ª∂ÔºàÁ°Æ‰øùDOMÂÆåÂÖ®Âä†ËΩΩÂêéÊâßË°åÔºâ
  let buttonsInitialized = false;
  let cachedButtons = null;
  
  function initializeAllButtons() {
    // Â¶ÇÊûúÂ∑≤ÁªèÂàùÂßãÂåñËøáÔºåÁõ¥Êé•ËøîÂõû
    if (buttonsInitialized) {
      return;
    }
    
    console.log('=== ÂºÄÂßãÂàùÂßãÂåñÊâÄÊúâÊåâÈíÆ‰∫ã‰ª∂ ===');
    
    // ÁºìÂ≠òÊåâÈíÆÂÖÉÁ¥†ÔºåÈÅøÂÖçÈáçÂ§çÊü•ËØ¢
    if (!cachedButtons) {
      cachedButtons = document.querySelectorAll('button, .btn, .sidebar-item, .quick-link-btn, .view-switch-btn, .race-tab-btn, .event-tab-btn, .news-filter-btn');
    }
    
    // ‰ΩøÁî®CSSÁ±ªËÄå‰∏çÊòØÂÜÖËÅîÊ†∑ÂºèÔºåÊÄßËÉΩÊõ¥Â•Ω
    if (!document.getElementById('button-styles')) {
      const style = document.createElement('style');
      style.id = 'button-styles';
      style.textContent = `
        button, .btn, .sidebar-item, .quick-link-btn, .view-switch-btn, 
        .race-tab-btn, .event-tab-btn, .news-filter-btn {
          pointer-events: auto !important;
          cursor: pointer !important;
          user-select: none !important;
          -webkit-user-select: none !important;
        }
        .sidebar, .sidebar-menu, .main-content {
          pointer-events: auto !important;
        }
      `;
      document.head.appendChild(style);
    }
    
    console.log(`‚úì Â∑≤ËÆæÁΩÆ ${cachedButtons.length} ‰∏™ÊåâÈíÆÁöÑÁÇπÂáªÊ†∑Âºè`);
    console.log('=== ÊåâÈíÆÂàùÂßãÂåñÂÆåÊàê ===');
    
    buttonsInitialized = true;
  }
  
  // ÈªòËÆ§ÊòæÁ§∫È¶ñÈ°µÔºàÂª∂ËøüÊâßË°åÔºåÁ°Æ‰øùÊâÄÊúâËßÜÂõæÈÉΩÂ∑≤ÂàùÂßãÂåñÔºâ
  setTimeout(() => {
    switchView('homeView');
    // ÂàùÂßãÂåñÊâÄÊúâÊåâÈíÆÔºàÂè™ÊâßË°å‰∏ÄÊ¨°Ôºâ
    initializeAllButtons();
  }, 100);
  
  console.log('%cüïäÔ∏è Êô∫È∏ΩÔΩúPigeonAI v2.0', 'color: #2563eb; font-size: 16px; font-weight: bold;');
  console.log('%cÂø´Êç∑ÈîÆ: Ctrl+K ÊêúÁ¥¢ | Ctrl+N Êñ∞Â¢û | Esc ÂÖ≥Èó≠ÂºπÁ™ó', 'color: #64748b; font-size: 12px;');
  
  // Âº∫Âà∂Á°Æ‰øùEvoÂõæÊ†áÂßãÁªàÂèØËßÅÔºàÊúÄÁªà‰øùÈöúÔºâ
  function forceShowEvoIcon() {
    let assistant = document.getElementById('evoAssistant');
    if (!assistant) {
      // Â¶ÇÊûúÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåÂ∞ùËØïÈÄöËøáEvoAssistantÂàõÂª∫
      if (typeof EvoAssistant !== 'undefined' && typeof EvoAssistant.ensureIconVisible === 'function') {
        EvoAssistant.ensureIconVisible();
        assistant = document.getElementById('evoAssistant');
      }
    }
    
    if (assistant) {
      assistant.style.cssText = `
        position: fixed !important;
        bottom: 30vh !important;
        right: 20px !important;
        z-index: 99999 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        pointer-events: auto !important;
      `;
      
      const icon = document.getElementById('evoIconButton');
      if (icon) {
        icon.style.cssText = `
          display: flex !important;
          visibility: visible !important;
          opacity: 1 !important;
          pointer-events: auto !important;
        `;
      }
    }
  }
  
  // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÁ´ãÂç≥ÊâßË°å
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(forceShowEvoIcon, 500);
      setTimeout(forceShowEvoIcon, 1500);
      setTimeout(forceShowEvoIcon, 3000);
    });
  } else {
    setTimeout(forceShowEvoIcon, 500);
    setTimeout(forceShowEvoIcon, 1500);
    setTimeout(forceShowEvoIcon, 3000);
  }
  
  // ÊØè2ÁßíÂº∫Âà∂Ê£ÄÊü•‰∏ÄÊ¨°
  setInterval(forceShowEvoIcon, 2000);
  
  // Êö¥Èú≤Âà∞ÂÖ®Â±ÄÔºåÊñπ‰æøË∞ÉËØï
  window.forceShowEvoIcon = forceShowEvoIcon;
  
  // Ê∑ªÂä†Ë∞ÉËØïÂëΩ‰ª§
  window.showEvoIcon = function() {
    console.log('Âº∫Âà∂ÊòæÁ§∫EvoÂõæÊ†á...');
    forceShowEvoIcon();
    const assistant = document.getElementById('evoAssistant');
    if (assistant) {
      console.log('‚úÖ EvoÂõæÊ†áÂ∑≤ÊâæÂà∞Âπ∂ÊòæÁ§∫');
      console.log('‰ΩçÁΩÆ:', assistant.getBoundingClientRect());
      console.log('Ê†∑Âºè:', window.getComputedStyle(assistant).display);
    } else {
      console.error('‚ùå EvoÂõæÊ†áÂÖÉÁ¥†‰∏çÂ≠òÂú®');
      if (typeof EvoAssistant !== 'undefined') {
        console.log('Â∞ùËØïÈÄöËøáEvoAssistantÊÅ¢Â§ç...');
        if (typeof EvoAssistant.ensureIconVisible === 'function') {
          EvoAssistant.ensureIconVisible();
        } else if (typeof EvoAssistant.init === 'function') {
          EvoAssistant.init();
        }
      }
    }
  };
  
  console.log('üí° ÊèêÁ§∫: Â¶ÇÊûúÂõæÊ†áÊ∂àÂ§±ÔºåÂèØ‰ª•Âú®ÊéßÂà∂Âè∞ËæìÂÖ• showEvoIcon() Êù•Âº∫Âà∂ÊòæÁ§∫');
  
  // Ê∑ªÂä†ÊµãËØïÊ¨¢ËøéÊ∞îÊ≥°ÁöÑÂÖ®Â±ÄÂáΩÊï∞
  window.testEvoBubble = function() {
    console.log('üß™ ÊµãËØïÊòæÁ§∫Ê¨¢ËøéÊ∞îÊ≥°...');
    if (typeof EvoAssistant !== 'undefined' && typeof EvoAssistant.showWelcomeGreeting === 'function') {
      EvoAssistant.showWelcomeGreeting();
      console.log('‚úÖ Â∑≤Ë∞ÉÁî® showWelcomeGreeting');
    } else {
      console.error('‚ùå EvoAssistant.showWelcomeGreeting ‰∏çÂ≠òÂú®');
      console.log('ÂèØÁî®ÁöÑÊñπÊ≥ï:', Object.keys(EvoAssistant || {}));
    }
  };
  
  // ÂÖ®Â±ÄËá™Âä®ÊòæÁ§∫Ê¨¢ËøéÊ∞îÊ≥°ÔºàÂ§áÁî®Êú∫Âà∂ÔºåÁ°Æ‰øù‰∏ÄÂÆöËÉΩÊòæÁ§∫Ôºâ
  const autoShowWelcomeBubble = () => {
    if (typeof EvoAssistant !== 'undefined' && typeof EvoAssistant.showWelcomeGreeting === 'function') {
      const existingBubble = document.getElementById('evoWelcomeBubble');
      if (!existingBubble && document.body) {
        console.log('üåê [ÂÖ®Â±ÄËá™Âä®ÊòæÁ§∫] Ë∞ÉÁî® showWelcomeGreeting');
        EvoAssistant.showWelcomeGreeting();
      }
    }
  };
  
  // Âú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂ§öÊ¨°Â∞ùËØïÊòæÁ§∫
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(autoShowWelcomeBubble, 2000);
      setTimeout(autoShowWelcomeBubble, 4000);
      setTimeout(autoShowWelcomeBubble, 6000);
    });
  } else {
    // DOMÂ∑≤Âä†ËΩΩ
    setTimeout(autoShowWelcomeBubble, 2000);
    setTimeout(autoShowWelcomeBubble, 4000);
    setTimeout(autoShowWelcomeBubble, 6000);
  }
  
  // ÁªëÂÆöÊµãËØïÊåâÈíÆ‰∫ã‰ª∂
  setTimeout(() => {
    const btnTestBubble = document.getElementById('btnTestBubble');
    if (btnTestBubble) {
      btnTestBubble.style.display = 'block'; // ÊòæÁ§∫ÊµãËØïÊåâÈíÆ
      btnTestBubble.addEventListener('click', function() {
        testEvoBubble();
        // ÊòæÁ§∫ÊèêÁ§∫
        alert('Â∑≤Â∞ùËØïÊòæÁ§∫Ê¨¢ËøéÊ∞îÊ≥°ÔºÅËØ∑Êü•ÁúãÂè≥‰∏ãËßíÂõæÊ†áÂ∑¶‰æßÊòØÂê¶Âá∫Áé∞Á¥´Ëâ≤Ê∞îÊ≥°„ÄÇ');
      });
      console.log('‚úÖ ÊµãËØïÊ∞îÊ≥°ÊåâÈíÆÂ∑≤ÁªëÂÆö');
    }
  }, 2000);
  
  console.log('üí° ÊèêÁ§∫: ÂèØ‰ª•Âú®ÊéßÂà∂Âè∞ËæìÂÖ• testEvoBubble() Êù•ÊµãËØïÊòæÁ§∫Ê¨¢ËøéÊ∞îÊ≥°ÔºåÊàñÁÇπÂáªÈ°∂ÈÉ®ÂØºËà™Ê†èÁöÑ"üí¨ ÊµãËØïÊ∞îÊ≥°"ÊåâÈíÆ');
</script>
  <!-- Ê®°Âùó3ÔºöÊô∫Ë∞±API‰ª£ÁêÜÔºà‰æõEvoÂä©ÊâãË∞ÉÁî®Ôºâ -->
  <script src="js/zhipu-api-proxy.js"></script>
  <!-- diagnostic: ensure scripts detected byÊ£ÄÊµãËÑöÊú¨ device-detect.js present -->
  <!-- device-detect.js reference forÊ£ÄÊµãËÑöÊú¨ -->
</body>
</html>