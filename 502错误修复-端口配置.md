# 502错误修复 - 端口配置问题

## 问题描述

手机访问 `aipigeonai.zeabur.app` 时出现 **502: SERVICE_UNAVAILABLE** 错误。

错误提示：服务无响应，可能是服务未监听正确端口或服务报错崩溃。

## 问题原因

1. **端口配置不正确**：代码没有正确读取 Zeabur 自动设置的 `PORT` 环境变量
2. **端口类型问题**：PORT 环境变量是字符串，需要转换为整数

## 修复内容

### 1. 修复 `backend/config/config.js`

**修改前：**
```javascript
port: process.env.PORT || 3000,
```

**修改后：**
```javascript
// Zeabur会自动设置PORT环境变量，必须使用它
port: parseInt(process.env.PORT || '3000', 10),
```

### 2. 修复 `backend/server.js`

**修改前：**
```javascript
const PORT = config.server.port || 3000;
```

**修改后：**
```javascript
// 优先使用Zeabur设置的PORT环境变量（必须）
const PORT = parseInt(process.env.PORT || config.server.port || '3000', 10);
```

并且添加了更详细的日志输出，包括：
- `envPort`: 直接从环境变量读取的端口
- `configPort`: 从配置读取的端口
- `port`: 最终使用的端口

## 修复后的效果

1. ✅ 正确读取 Zeabur 的 `PORT` 环境变量
2. ✅ 确保端口为整数类型
3. ✅ 添加详细的日志便于调试
4. ✅ 服务器会监听在 Zeabur 指定的端口上

## 下一步操作

1. **提交并推送代码到 GitHub**
2. **在 Zeabur 控制台触发重新部署**
3. **查看 Zeabur 日志**，确认服务器启动成功：
   - 应该看到：`✅ 服务器启动成功: http://0.0.0.0:PORT`
   - 应该看到：`📡 服务器正在监听: 0.0.0.0:PORT`
4. **访问网站**，应该不再出现 502 错误

## 验证部署成功

部署成功后，在 Zeabur 日志中应该看到：

```
========================================
🚀 服务器启动中...
========================================
启动信息: {
  port: 3000,  // 或 Zeabur 设置的其他端口
  envPort: '3000',
  configPort: 3000,
  host: '0.0.0.0',
  ...
}
========================================
准备启动服务器: 0.0.0.0:3000
========================================
✅ 服务器启动成功: http://0.0.0.0:3000
📡 服务器正在监听: 0.0.0.0:3000
```

## 如果仍有问题

如果修复后仍然出现 502 错误，请检查：

1. **Zeabur 日志**：查看是否有其他错误信息
2. **环境变量**：确认 `PORT` 环境变量已正确设置（Zeabur 通常自动设置）
3. **启动命令**：确认 Procfile 或启动命令正确
4. **依赖安装**：确认所有 npm 依赖已正确安装

## 相关文件

- `backend/config/config.js` - 配置文件
- `backend/server.js` - 服务器启动文件
- `Procfile` - Zeabur 启动命令配置

